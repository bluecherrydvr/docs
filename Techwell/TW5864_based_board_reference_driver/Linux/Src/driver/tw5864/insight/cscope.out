cscope 15 $HOME/project/tw_driver/tw5864_new_device_layer/tw5864/insight -q 0000009930 0001810823
	@../../tw5864/device_layer/audio_de_driver.c

1 
	~<tw5864/tc_commÚ.h
>

7 
	$tw_audio_de_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

9 
»t
;

10 
bus_id
,
ch_id
,
lg_id
;

11 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

12 
tw_audio_driv”_t
 *
ad
;

14 
bus_id
 = 
	`g‘_busid_äom_•obj
(&
tcd
->
•obj
);

15 
ch_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

16 
lg_id
 = 
TW_AUDIO_OUT_SPEAKER_ID
;

18 
ad
 = 
ch
->
audio_chª_driv”
;

19 
ad
 +ğ
TW_AUDIO_OUT_SPEAKER_ID
;

21 
	`´štk
("ad[0x%8p] iÀ%s---> \n",
ad
, 
__FUNCTION__
);

22 
»t
 = 
	`š™_tw5864_audio_decode_chª
(
ad
,&
ch
->
ch_audio
,
bus_id
,
ch_id
,
lg_id
);

23 if(
»t
){

24 
	`dbg
("audio decoder driv init failed!\n");

25  
»t
;

27 
tsd
->
³d
 = &
ad
->
audio_ed
;

28  
»t
;

29 
	}
}

32 
	$tw_audio_de_driv”_»move
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

34 
tw_audio_driv”_t
 *
ad
;

36 
tc_Œaû
;

37 if(!
tsd
->
³d
){

38 
	`dbg
("tsd has‚oƒd!\n");

41 
ad
 = 
	`cÚš”_of
(
tsd
->
³d
,
tw_audio_driv”_t
,
audio_ed
);

42 
	`»move_tw5864_audio_’code_chª
(
ad
);

43 
	}
}

47 
tw_dev_id
 
	gtw_audio_de_dev_id
 =

49 .
•obj
 = {

50 .
v’dÜ_id
 = 
TWELL
,

51 .
	gbus_id
 = 1,

52 .
	gch_id
 = 
TW5864
,

53 .
	gfunc_id
 = (
STREAM_TYPE_AUDIO
 << 16è| 
CODEC_AUDIO_ADPCM
,

54 .
	gty³
 = 
TW_DECODER
,

56 .
	gv”siÚ
 = 1,

60 
tsd_driv”_İ”©iÚs
 
	gtw_audio_de_İs
 =

62 .
š™
 = 
tw_audio_de_driv”_š™
,

63 .
	g»move
 = 
tw_audio_de_driv”_»move
,

66 
tw_£rviû_driv”
 
	gtw_audio_decod”_driv
 =

68 .
driv”
 = {

69 .
Çme
 = "tw5864_audio_dedriv",

71 .
	gdeviû_id
 = {

72 .
tid
 = &
tw_audio_de_dev_id
,

73 .
	gİs
 = &
tw_audio_de_İs
,

79 
	$tw5864_audio_de_driv”_š™
(* 
·¿
)

81 
tw_audio_decod”_driv
.
deviû_id
.
·¿
 =…ara;

82  
	`»gi¡”_tc_driv”
(&
tw_audio_decod”_driv
);

83 
	}
}

86 
	$tw5864_audio_de_driv”_»move
()

88 
	`uÄegi¡”_tc_driv”
(&
tw_audio_decod”_driv
);

89 
	}
}

	@../../tw5864/device_layer/audio_en_driver.c

1 
	~<tw5864/tc_commÚ.h
>

7 
	$tw_audio_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

9 
»t
;

10 
bus_id
,
ch_id
,
lg_id
;

11 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

12 
tw_audio_driv”_t
 *
ad
;

14 
bus_id
 = 
	`g‘_busid_äom_•obj
(&
tcd
->
•obj
);

15 
ch_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

16 
lg_id
 = 
¬g
->
chªÃl_idx
;

18 
ad
 = 
ch
->
audio_chª_driv”
;

19 
ad
 +ğ
lg_id
;

21 
»t
 = 
	`š™_tw5864_audio_’code_chª
(
ad
,&
ch
->
ch_audio
,
bus_id
,
ch_id
,
lg_id
);

22 if(
»t
){

23 
	`dbg
("audioƒncoder driv init failed!\n");

24  
»t
;

26 
tsd
->
³d
 = &
ad
->
audio_ed
;

27  
»t
;

28 
	}
}

31 
	$tw_audio_driv”_»move
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

33 
tw_audio_driv”_t
 *
ad
;

35 
tc_Œaû
;

36 if(!
tsd
->
³d
){

37 
	`dbg
("tsd has‚oƒd!\n");

40 
ad
 = 
	`cÚš”_of
(
tsd
->
³d
,
tw_audio_driv”_t
,
audio_ed
);

41 
	`»move_tw5864_audio_’code_chª
(
ad
);

42 
	}
}

45 
tw_dev_id
 
	gtw_audio_’_dev_id
 =

47 .
•obj
 = {

48 .
v’dÜ_id
 = 
TWELL
,

49 .
	gbus_id
 = 1,

50 .
	gch_id
 = 
TW5864
,

51 .
	gfunc_id
 = (
STREAM_TYPE_AUDIO
<<16è| 
CODEC_AUDIO_ADPCM
,

52 .
	gty³
 = 
TW_ENCODER
,

54 .
	gv”siÚ
 = 1,

58 
tsd_driv”_İ”©iÚs
 
	gtw_audio_İs
 =

60 .
š™
 = 
tw_audio_driv”_š™
,

61 .
	g»move
 = 
tw_audio_driv”_»move
,

64 
tw_£rviû_driv”
 
	gtw_audio_’cod”_driv
 =

66 .
driv”
 = {

67 .
Çme
 = "tw5864_audio_endriv",

69 .
	gdeviû_id
 = {

70 .
tid
 = &
tw_audio_’_dev_id
,

71 .
	gİs
 = &
tw_audio_İs
,

77 
	$tw5864_audio_’_driv”_š™
(* 
·¿
)

79 
tw_audio_’cod”_driv
.
deviû_id
.
·¿
 =…ara;

80  
	`»gi¡”_tc_driv”
(&
tw_audio_’cod”_driv
);

81 
	}
}

84 
	$tw5864_audio_’_driv”_»move
()

86 
	`uÄegi¡”_tc_driv”
(&
tw_audio_’cod”_driv
);

87 
	}
}

	@../../tw5864/device_layer/jpeg_en_driver.c

1 
	~<tw5864/tc_commÚ.h
>

7 
	$tw_j³g_driv”_š™
(
tw_ch_deviû
 *
tcd
, 
tw_£rviû_deviû
 *
tsd
, * 
·¿
,
cmd_¬g
 *
¬g
)

9 
»t
;

10 
bus_id
,
ch_id
,
lg_id
;

11 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

12 
tw_j³g_logic_’code_chª_t
 *
jed
;

14 
bus_id
 = 
	`g‘_busid_äom_•obj
(&
tcd
->
•obj
);

15 
ch_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

16 
lg_id
 = 
¬g
->
chªÃl_idx
;

18 
jed
 = 
ch
->
j³g_’code_chª
;

19 
jed
 +ğ
lg_id
;

21 
	`´štk
("jed[0x%8p] iÀ%s---> \n",
jed
, 
__FUNCTION__
);

22 
»t
 = 
	`š™_tw5864_j³g_’code_chª
(
jed
, 
ch
->
bus_id
, ch->
ch_id
, 
lg_id
, chip);

23 if(
»t
){

24 
	`dbg
("jpeg driv init failed!\n");

25  
»t
;

27 
tsd
->
³d
 = &
jed
->
İ’ed_logic_chª_ed
;

28  
»t
;

29 
	}
}

32 
	$tw_j³g_driv”_»move
(
tw_ch_deviû
 *
tcd
, 
tw_£rviû_deviû
 *
tsd
, * 
·¿
,
cmd_¬g
 *
¬g
)

34 
tw_j³g_logic_’code_chª_t
 *
vj
;

36 
tc_Œaû
;

37 if(!
tsd
->
³d
){

38 
	`dbg
("tsd has‚oƒd!\n");

41 
vj
 = 
	`cÚš”_of
(
tsd
->
³d
,
tw_j³g_logic_’code_chª_t
,
İ’ed_logic_chª_ed
);

42 
	`»move_tw5864_j³g_’code_chª
(
vj
);

43 
	}
}

46 
tw_dev_id
 
	gtw_j³g_’_dev_id
 =

48 .
•obj
 = {

49 .
v’dÜ_id
 = 
TWELL
,

50 .
	gbus_id
 = 1,

51 .
	gch_id
 = 
TW5864
,

52 .
	gfunc_id
 = (
STREAM_TYPE_MAJOR
 << 16è| 
CODEC_VIDEO_MJPG
,

53 .
	gty³
 = 
TW_ENCODER
,

55 .
	gv”siÚ
 = 1,

59 
tsd_driv”_İ”©iÚs
 
	gtw_j³g_’_İs
 =

61 .
š™
 = 
tw_j³g_driv”_š™
,

62 .
	g»move
 = 
tw_j³g_driv”_»move
,

65 
tw_£rviû_driv”
 
	gtw_j³g_’cod”_driv
 =

67 .
driv”
 = {

68 .
Çme
 = "tw5864_jpeg_driv",

70 .
	gdeviû_id
 = {

71 .
tid
 = &
tw_j³g_’_dev_id
,

72 .
	gİs
 = &
tw_j³g_’_İs
,

78 
	$tw5864_j³g_’_driv”_š™
(* 
·¿
)

80 
tw_j³g_’cod”_driv
.
deviû_id
.
·¿
 =…ara;

81  
	`»gi¡”_tc_driv”
(&
tw_j³g_’cod”_driv
);

82 
	}
}

85 
	$tw5864_j³g_’_driv”_»move
()

87 
	`uÄegi¡”_tc_driv”
(&
tw_j³g_’cod”_driv
);

88 
	}
}

	@../../tw5864/device_layer/tc.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/k”Ãl.h
>

3 
	~<lšux/”ºo.h
>

4 
	~<lšux/¦ab.h
>

5 
	~<lšux/i2c.h
>

6 
	~<lšux/fs.h
>

7 
	~<lšux/cdev.h
>

8 
	~<lšux/š™.h
>

9 
	~<lšux/idr.h
>

10 
	~<lšux/£q_fe.h
>

11 
	~<lšux/¶©fÜm_deviû.h
>

12 
	~<lšux/mu‹x.h
>

13 
	~<lšux/com¶‘iÚ.h
>

14 
	~<asm/uacûss.h
>

15 
	~<lšux/kth»ad.h
>

16 
	~<lšux/uni¡d.h
>

17 
	~<asm/uni¡d.h
>

18 
	~<lšux/uni¡d.h
>

19 
	~<lšux/fú.h
>

20 
	~<lšux/Çmei.h
>

21 
	~<lšux/¿dix-Œ“.h
>

22 
	~<lšux/sysfs.h
>

23 
	~<asm/cu¼’t.h
>

24 
	~<tw5864/tc_commÚ.h
>

27 
MODULE_LICENSE
("GPL");

30 
	gg_g_æag
 = 0;

33 
k´obe
 
	gkp
 =

35 .
symbŞ_Çme
 = "schedule",

39 
k´obe
 
	gk·
 =

41 .
symbŞ_Çme
 = "__wait_event",

45 
	$hªdËr_´e
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

47 *
Ï¡_n
 = 
NULL
, *
cur_n
= NULL;

48 *
Ï¡_u¡ack
 = 
NULL
, * 
cur_u¡ack
 = NULL;

49 *
Ï¡_»t
 = 
NULL
, *
cur_»t
 = NULL;

51 if((
g_g_æag
 && !
	`¡rcmp
(
cu¼’t
->
comm
,"test")) ){

52 
cur_n
 = 
	`š¡ruùiÚ_poš‹r
(
»gs
);

53 
cur_u¡ack
 = 
	`u£r_¡ack_poš‹r
(
»gs
);

54 
cur_»t
 = 
	`»gs_»tuº_v®ue
(
»gs
);

57 
	`dump_¡ack
();

60 
Ï¡_n
 = 
cur_n
;

61 
Ï¡_u¡ack
 = 
cur_u¡ack
;

62 
Ï¡_»t
 = 
cur_»t
;

66 
	}
}

69 
	$hªdËr_a_´e
(
k´obe
 *
p
, 
±_»gs
 *
»gs
)

71 *
Ï¡_n
 = 
NULL
, *
cur_n
= NULL;

72 *
Ï¡_u¡ack
 = 
NULL
, * 
cur_u¡ack
 = NULL;

73 *
Ï¡_»t
 = 
NULL
, *
cur_»t
 = NULL;

75 if((
g_g_æag
 && !
	`¡rcmp
(
cu¼’t
->
comm
,"test")) || (g_g_flag && !strcmp(current->comm,"tw_agend"))){

76 
cur_n
 = 
	`š¡ruùiÚ_poš‹r
(
»gs
);

77 
cur_u¡ack
 = 
	`u£r_¡ack_poš‹r
(
»gs
);

78 
cur_»t
 = 
	`»gs_»tuº_v®ue
(
»gs
);

81 
	`dump_¡ack
();

84 
Ï¡_n
 = 
cur_n
;

85 
Ï¡_u¡ack
 = 
cur_u¡ack
;

86 
Ï¡_»t
 = 
cur_»t
;

90 
	}
}

95 
	$hªdËr_po¡
(
k´obe
 *
p
, 
±_»gs
 *
»gs
,
æags
)

98 
	`´štk
("po¡_hªdËr:…->add¸ğ0x%p, m¤ = 0x%lx\n",
p
->
addr
, 
»gs
->
m¤
);

101 
	}
}

111 
	$hªdËr_çuÉ
(
k´obe
 *
p
, 
±_»gs
 *
»gs
, 
Œ­Ä
)

113 
	`´štk
("çuÉ_hªdËr:…->add¸ğ0x%p,¿°#%dn\n",
p
->
addr
, 
Œ­Ä
);

116 
	}
}

120 
	$k´obe_š™
()

122 
»t
;

123 
kp
.
´e_hªdËr
 = 
hªdËr_´e
;

127 
k·
.
´e_hªdËr
 = 
hªdËr_a_´e
;

130 
»t
 = 
	`»gi¡”_k´obe
(&
kp
);

131 ià(
»t
 < 0) {

132 
	`´štk
(
KERN_INFO
 "»gi¡”_k´obçed,„‘uºed %d\n", 
»t
);

133  
»t
;

136 
»t
 = 
	`»gi¡”_k´obe
(&
k·
);

137 if(
»t
){

138 
	`´štk
("register kpa falied!\n");

139  
»t
;

141 
	`´štk
(
KERN_INFO
 "PÏÁed k´ob© %p", 
kp
.
addr
);

144 
	}
}

148 
	$k´obe_ex™
()

150 
	`uÄegi¡”_k´obe
(&
kp
);

151 
	`´štk
(
KERN_INFO
 "k´ob© %°uÄegi¡”ed", 
kp
.
addr
);

152 
	}
}

159 
kobjeù
 * 
	gkroÙ
 = 
NULL
;

160 
LIST_HEAD
(
tw_chdev
);

161 
DEFINE_MUTEX
(
mu‹x_chdev
);

163 
LIST_HEAD
(
tw_chdrv
);

164 
DEFINE_MUTEX
(
mu‹x_chdrv
);

166 
LIST_HEAD
(
tw_tc_dev
);

167 
DEFINE_MUTEX
(
mu‹x_tc_dev
);

169 
LIST_HEAD
(
tw_tc_drv
);

170 
DEFINE_MUTEX
(
mu‹x_tc_drv
);

178 
š™_nfm_b™m­
();

179 
ä“_nfm_b™m­
();

180 
g‘_ä“_mšÜ
(
cmd_¬g
 *
¬g
);

181 
put_ä“_mšÜ
(
mšÜ
,
ty³
);

182 
make_£rviû_key
(
•key_t
 *
key
,
tw_ch_deviû
 * 
tcd
, 
cmd_¬g
 * 
¬g
);

184 
kobjeù
 * 
tw_ü—‹_dœ
(* 
Çme
, kobjeù *
·»Á
);

185 
tw_»move_dœ
(
kobjeù
 * 
kobj
);

186 
bšd_ch_driv”
(
tw_ch_deviû
 * 
tcd
);

187 
unbšd_ch_driv”
(
tw_ch_deviû
 * 
tcd
);

195 
kobjeù
 * 
g‘_dœ
(
tw_ch_deviû
 *
tcd
, 
ty³
);

197 
»que¡_devno_»sourû
();

198 
ä“_devno_»sourû
();

203 
tc_hb_poŞ
 *
	gthb_poŞ
 = 
NULL
;

204 *
	g®gÜ™hm
[] = {

208 *
	g¡»am
[] ={"major","minor","pic","mv","audio",};

209 *
	gtc_dev_Çme
[] = {"tw_chip","tw_encoder","tw_decoder","tw_video_in","tw_video_out","tw_audio_in","tw_audio_out",};

215 
LIST_HEAD
(
ş_h—d
);

219 *
	gnfm_b™m­
[
MAX_SERVICE_NR
];

222 
	$lock_chdev
()

224 
	`mu‹x_lock
(&
mu‹x_chdev
);

225 
	}
}

228 
	$uÆock_chdev
()

230 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

231 
	}
}

234 
li¡_h—d
 * 
	$g‘_chdev_li¡h—d
()

236  &
tw_chdev
;

237 
	}
}

247 
	$š™_nfm_b™m­
()

249 
idx
;

250 
Ën
 = 
	`round_up
(
MAX_MINOR_NR
,8);

253 
idx
=0; idx<
MAX_SERVICE_NR
; idx++)

255 
nfm_b™m­
[
idx
] = 
	`kz®loc
(
Ën
,
GFP_KERNEL
);

256 if(!
nfm_b™m­
[
idx
]è
ş—n
;

259 
ş—n
:

260 
	`dbg
("š % çedØg‘ b™m­ s·û!\n",
__FUNCTION__
);

261 ;
idx
 > 0; idx--)

262 
	`kä“
(
nfm_b™m­
[
idx
-1]);

264 
	}
}

266 
	$ä“_nfm_b™m­
()

268 
i
;

270 
i
=0; i<
MAX_SERVICE_NR
; i++)

271 
	`kä“
(
nfm_b™m­
[
i
]);

273 
	}
}

277 
	$g‘_ä“_mšÜ
(
cmd_¬g
 *
¬g
)

279 
»t
 = 
MAX_MINOR_NR
;

280 
idx
 = 
¬g
->
ty³
;

282 
»t
 = 
	`fšd_fœ¡_z”o_b™
(
nfm_b™m­
[
idx
],
MAX_MINOR_NR
);

283 if(
»t
 >ğ
MAX_MINOR_NR
){

284 
	`dbg
("there is‚o free minor!\n");

287 
	`£t_b™
(
»t
,
nfm_b™m­
[
idx
]);

288  
»t
;

289 
	}
}

292 
	$put_ä“_mšÜ
(
mšÜ
,
ty³
)

294 
	`ş—r_b™
(
mšÜ
,
nfm_b™m­
[
ty³
]);

295 
	}
}

299 
	$make_£rviû_key
(
•key_t
 *
key
 ,
tw_ch_deviû
 * 
tcd
, 
cmd_¬g
 * 
¬g
)

301 
bus_id
 = 
	`g‘_bus_id
(
tcd
->
•obj
.
key
);

302 
ch_id
 = 
tcd
->
mšÜ
;

303 
pid
 = 0;

304 
lid
 = 
¬g
->
chªÃl_idx
;

306 
	`make_key
(
key
,
¬g
->
¡»am
,¬g->
®gÜ™hm
,
bus_id
,
ch_id
, 
pid
, 
lid
);

307 
	}
}

309 #ià
LINUX_VERSION_CODE
 < 
KERNEL_VERSION
(2, 6, 25)

310 
	$tw_dœ_»Ëa£
(
kobjeù
 * 
kobj
)

312 
	`kä“
(
kobj
);

313 
	}
}

315 
kobj_ty³
 
	gtw_dœ
 = {

316 .
»Ëa£
 = 
tw_dœ_»Ëa£
,

317 .
	gsysfs_İs
 = 
NULL
,

318 .
	gdeçuÉ_©Œs
 = 
NULL
,

325 
kobjeù
 * 
	$tw_ü—‹_dœ
(* 
Çme
, 
kobjeù
 *
·»Á
)

327 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

328 
»t
;

329 
kobjeù
* 
kobj
 = 
	`kz®loc
((kobjeù),
GFP_ATOMIC
);

331 if(!
kobj
)

332  
NULL
;

334 
kobj
->
·»Á
 =…arent;

335 
kobj
->
kty³
 = &
tw_dœ
;

336 
	`kobjeù_š™
(
kobj
);

337 
	`kobjeù_£t_Çme
(
kobj
, "%s", 
Çme
);

338 
»t
 = 
	`kobjeù_»gi¡”
(
kobj
);

339 if(
»t
){

340 
	`kobjeù_d–
(
kobj
);

341  
NULL
;

345  
kobj
;

349  
	`kobjeù_ü—‹_ªd_add
(
Çme
,
·»Á
);

351 
	}
}

354 
	$tw_»move_dœ
(
kobjeù
 * 
kobj
)

356 if(!
kobj
)

359 
tc_Œaû
;

360 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 25)

361 
	`kobjeù_uÄegi¡”
(
kobj
);

363 
	`kobjeù_put
(
kobj
);

365 
	}
}

369 
	$tw_deviû_m©ch
(
deviû
 *
dev
, 
deviû_driv”
 *
drv
)

375 
	}
}

378 
ssize_t
 
	$show_ch_Çme
(
deviû
 *
dev
, 
deviû_©Œibu‹
 *
©Œ
, *
buf
)

383 
	}
}

386 
deviû_©Œibu‹
 
	gtw_dev_©Œs
[] = {

387 
__ATTR
(
Çme
, 
S_IRUGO
, 
show_ch_Çme
, 
NULL
),

392 
bus_ty³
 
	gtw_vœtu®_bus
 = {

393 .
Çme
 = "tw_virtual_bus",

394 .
	gdev_©Œs
 = 
tw_dev_©Œs
,

395 .
	gm©ch
 = 
tw_deviû_m©ch
,

425 
tw_ch_deviû
 * 
	$fšd_ch_dev
(
mšÜ
)

427 
li¡_h—d
 * 
p
 = &
tw_chdev
;

428 
tw_ch_deviû
 *
tcd
 = 
NULL
;

430 if((
p
->
Ãxt
 =ğp->
´ev
è&& (p->Ãxˆ=ğ&
tw_chdev
))

432 
	`dbg
("ouˆäom h”e?‡nd mšÜ=%d\n",
mšÜ
);

433  
NULL
;

435 
	`mu‹x_lock
(&
mu‹x_chdev
);

436 
p
 =…->
Ãxt
;

437 ; 
p
 !ğ&
tw_chdev
;… =…->
Ãxt
)

439 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

440 if(
tcd
->
mšÜ
 == minor){

441 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

442  
tcd
;

446 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

447  
NULL
;

448 
	}
}

451 
	$twc_İ’
(
šode
 *šode, 
fe
 *file)

453 
mšÜ
 = 
	`imšÜ
(
šode
);

454 
»t
 = 0;

455 
tw_ch_deviû
 *
tcd
;

457 
tc_Œaû
;

458 if(
mšÜ
 >= 256)

459  -
ENODEV
;

461 
tcd
 = 
	`fšd_ch_dev
(
mšÜ
);

462 if(
tcd
 =ğ
NULL
)

463  -
ENODEV
;

470 if(
tcd
->
tcd_fİs
 &&cd->tcd_fİs->
İ’
)

471 
»t
 = 
tcd
->
tcd_fİs
->
	`İ’
Ñcd,
fe
);

473 
	`dbg
("İ’ed‡nd„‘ = %d\n",
»t
);

477  
»t
;

478 
	}
}

481 
	$twc_»Ëa£
(
šode
 *šode, 
fe
 *
fp
)

483 
mšÜ
 = 
	`imšÜ
(
šode
);

484 
»t
 = 0;

485 
tw_ch_deviû
 *
tcd
;

488 if(
mšÜ
 >= 256)

489  -
ENODEV
;

492 
tcd
 = 
	`fšd_ch_dev
(
mšÜ
);

493 if(!
tcd
)

494  -
ENODEV
;

501 if(
tcd
->
tcd_fİs
 &&cd->tcd_fİs->
»Ëa£
)

502 
tcd
->
tcd_fİs
->
	`»Ëa£
Ñcd,
fp
);

505  
»t
;

507 
	}
}

509 
ssize_t
 
	$twc_»ad
(
fe
 *
fp
, *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

511 
ssize_t
 
»t
;

512 
tw_ch_deviû
 * 
tcd
;

514 
tcd
 = 
	`fšd_ch_dev
(
	`imšÜ
(
fp
->
f_·th
.
d’Œy
->
d_šode
));

515 if(!
tcd
)

516  -
ENODEV
;

519 if(!
tcd
->
tcd_fİs
->
»ad
)

520  -
EINVAL
;

522 
»t
 = 
tcd
->
tcd_fİs
->
	`»ad
(
fp
,
buff
,
couÁ
,
ofå
);

527   
»t
;

528 
	}
}

531 
ssize_t
 
	$twc_wr™e
(
fe
 *
fp
, cÚ¡ *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

533 
ssize_t
 
»t
;

534 
tw_ch_deviû
 * 
tcd
;

536 
tcd
 = 
	`fšd_ch_dev
(
	`imšÜ
(
fp
->
f_·th
.
d’Œy
->
d_šode
));

537 if(!
tcd
)

538  -
ENODEV
;

542 if(!
tcd
->
tcd_fİs
->
wr™e
)

543  -
EINVAL
;

545 
»t
 = 
tcd
->
tcd_fİs
->
	`wr™e
(
fp
,
buff
,
couÁ
,
ofå
);

550   
»t
;

551 
	}
}

554 
	$twc_ioùl
(
šode
 * inode,
fe
 * 
fp
,
cmd
, 
¬g
)

556 
»t
 = 0;

557 
tw_ch_deviû
 *
tcd
;

559 
tcd
 = 
	`fšd_ch_dev
(
	`imšÜ
(
fp
->
f_·th
.
d’Œy
->
d_šode
));

560 if(!
tcd
)

561  -
ENODEV
;

569 if(!
tcd
->
tcd_fİs
 || !tcd->tcd_fİs->
ioùl
){

570 
	`dbg
("you have‚ot ioctl func„egistered!\n");

571  -
EINVAL
;

579 
cmd
)

581 
TW_CHIP_CREATE_CHAN
:

582 
»t
 = 
	`ü—‹_£rviû_deviû
(
tcd
,
¬g
);

584 
TW_CHIP_RELEASE_CHAN
:

585 
	`»Ëa£_£rviû_deviû
(
tcd
,(*)
¬g
);

588 
	`dbg
("other cmd\n");

589 
»t
 = 
tcd
->
tcd_fİs
->
	`ioùl
(
fp
,
cmd
,
¬g
);

593  
»t
;

594 
	}
}

596 
fe_İ”©iÚs
 
	gtw_fİs
 = {

597 .
owÃr
 = 
THIS_MODULE
,

598 .
	gİ’
 = 
twc_İ’
,

599 .
	g»Ëa£
 = 
twc_»Ëa£
,

600 .
	g»ad
 = 
twc_»ad
,

601 .
	gwr™e
 = 
twc_wr™e
,

602 .
	gioùl
 = 
twc_ioùl
,

612 
tw_£rviû_deviû
 * 
	$fšd_£rviû_dev
(
majÜ
,
mšÜ
)

614 
li¡_h—d
 *
p
 = &
tw_chdev
;

615 
li¡_h—d
 *
q
 = 
NULL
;

616 
ty³
 = 
majÜ
-
TW_SERVICE_BASE_MAJOR
;

617 
tw_ch_deviû
 * 
tcd
 = 
NULL
;

618 
tw_£rviû_deviû
 *
tsd
 = 
NULL
;

621 if((
p
->
Ãxt
 =ğp->
´ev
è&& (p->Ãxˆ=ğ&
tw_chdev
))

623 
	`dbg
("nothing in device†ist!\n");

624  
NULL
;

627 
	`mu‹x_lock
(&
mu‹x_chdev
);

628 
p
 =…->
Ãxt
;

629 ; 
p
 !ğ&
tw_chdev
;… =…->
Ãxt
){

630 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

631 if((
q
 = &
tcd
->
tsd_li¡
[
ty³
]è=ğ
NULL
)

632 
”rÜ
;

634 
q
 = q->
Ãxt
;

635 ; 
q
 !ğ&
tcd
->
tsd_li¡
[
ty³
]; q = q->
Ãxt
){

636 
tsd
 = 
	`cÚš”_of
(
q
,
tw_£rviû_deviû
,
li¡
);

637 if(
tsd
->
mšÜ
 == minor)

638 
fšd
;

642 
fšd
:

643 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

644  
tsd
;

645 
”rÜ
:

646 
	`dbg
("BUG!he†isthead of givenype is NULL!\n");

647 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

648  
NULL
;

650 
	}
}

653 
	$tws_İ’
(
šode
 *šode, 
fe
 *file)

655 
majÜ
 = 
	`imajÜ
(
šode
);

656 
mšÜ
 = 
	`imšÜ
(
šode
);

657 
»t
 = 0;

658 
tw_£rviû_deviû
 *
tsd
 = 
NULL
;

661 
tc_Œaû
;

662 
tsd
 = 
	`fšd_£rviû_dev
(
majÜ
,
mšÜ
);

663 if(
tsd
 =ğ
NULL
)

664  -
ENODEV
;

671 if(!(
tsd
->
tsd_fİs
)){

672 
	`dbg
("you have‚osd_fops„egistered!\n");

673  -
EINVAL
;

675 if(!
tsd
->
tsd_fİs
->
İ’
){

676 
	`dbg
("BUG: have‚o open function");

677  -
EINVAL
;

684 
»t
 = 
tsd
->
tsd_fİs
->
	`İ’
Ñsd,
fe
);

690  
»t
;

691 
	}
}

694 
	$tws_»Ëa£
(
šode
 *šode, 
fe
 *
fp
)

696 
»t
 = 0;

697 
majÜ
 = 
	`imajÜ
(
šode
);

698 
mšÜ
 = 
	`imšÜ
(
šode
);

699 
tw_£rviû_deviû
 *
tsd
 = 
NULL
;

701 
tc_Œaû
;

702 
tsd
 = 
	`fšd_£rviû_dev
(
majÜ
,
mšÜ
);

703 if(!
tsd
)

704  -
ENODEV
;

706 
	`dbg
("majÜ = %d; mšÜ = %d\n",
majÜ
,
mšÜ
);

713 if(!
tsd
->
tsd_fİs
 || !tsd->tsd_fİs->
»Ëa£
){

714 
	`dbg
("nosd_fops or„elease\n");

717 
»t
 = 
tsd
->
tsd_fİs
->
	`»Ëa£
(
fp
);

718 
	`dbg
("şo£ fšished!„‘uº v® =%d\n",
»t
);

720  
»t
;

721 
	}
}

723 
ssize_t
 
	$tws_»ad
(
fe
 *
fp
, *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

725 
»t
 = 0;

726 
tw_£rviû_deviû
 * 
tsd
 = (tw_£rviû_deviû *)
fp
->
´iv©e_d©a
;

728 if(
fp
->
´iv©e_d©a
 =ğ
NULL
){

729 
	`dbg
("”rÜ: you g‘ c®È% w™houˆİ’ed!\n",
__FUNCTION__
);

730  -
EINVAL
;

733 if(
NULL
 =ğ
tsd
->
tsd_fİs
){

734 
	`dbg
("nosd fop„egistered!\n");

735  -
EINVAL
;

738 if(
tsd
->
tsd_fİs
->
»ad
)

739 
»t
 = 
tsd
->
tsd_fİs
->
	`»ad
(
fp
,
buff
,
couÁ
,
ofå
);

740  
»t
;

741 
	}
}

743 
ssize_t
 
	$tws_wr™e
(
fe
 *
fp
, cÚ¡ *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
ofå
)

745 
»t
 = 0;

746 
tw_£rviû_deviû
 * 
tsd
 = (tw_£rviû_deviû *)
fp
->
´iv©e_d©a
;

748 if(
fp
->
´iv©e_d©a
 =ğ
NULL
){

749 
	`dbg
("”rÜ: you g‘ c®È% w™houˆİ’ed!\n",
__FUNCTION__
);

750  -
EINVAL
;

753 if(
NULL
 =ğ
tsd
->
tsd_fİs
){

754 
	`dbg
("nosd fop„egistered!\n");

755  -
EINVAL
;

758 if(
tsd
->
tsd_fİs
->
wr™e
)

759 
»t
 = 
tsd
->
tsd_fİs
->
	`wr™e
(
fp
,
buff
,
couÁ
,
ofå
);

762  
»t
;

765 
	}
}

768 
	$tws_ioùl
(
šode
 * inode,
fe
 * 
fp
,
cmd
, 
¬g
)

770 
»t
;

771 
tw_£rviû_deviû
 * 
tsd
 = (tw_£rviû_deviû *)
fp
->
´iv©e_d©a
;

773 if(
fp
->
´iv©e_d©a
 =ğ
NULL
){

774 
	`dbg
("ÿÎ % w™houˆİ’ed!\n",
__FUNCTION__
);

775  -
EINVAL
;

777 if(!
tsd
->
tsd_fİs
 || !tsd->tsd_fİs->
ioùl
){

778 
	`dbg
("nosd fop„egistered!\n");

779  -
EINVAL
;

781 
»t
 = 
tsd
->
tsd_fİs
->
	`ioùl
(
fp
,
cmd
,
¬g
);

785  
»t
;

786 
	}
}

789 
	$tws_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

791 
»t
 = 0;

792 
tw_£rviû_deviû
 * 
tsd
 = (tw_£rviû_deviû *)
fe
->
´iv©e_d©a
;

794 if(
NULL
 =ğ
fe
->
´iv©e_d©a
){

795 
	`dbg
("ÿÎ % w™houˆİ’ed!\n",
__FUNCTION__
);

796  -
EINVAL
;

798 if(
NULL
 =ğ
tsd
->
tsd_fİs
){

799 
	`dbg
("nosd fop„egistered!\n");

800  -
EINVAL
;

803 if(
tsd
->
tsd_fİs
->
pŞl
)

804 
»t
 = 
tsd
->
tsd_fİs
->
	`pŞl
(
fe
,
wa™
);

806 
	`´štk
("no…oll function!\n");

808  
»t
;

809 
	}
}

817 
	$tc_vm_İ’
(
vm_¬—_¡ruù
 *
vma
)

821 
	`dbg
("vm_İ’ vœtu®:%X…hy:%d\n",
vma
->
vm_¡¬t
,vma->
vm_pgoff
 << 
PAGE_SHIFT
);

823 
	}
}

825 
	$tc_vm_şo£
(
vm_¬—_¡ruù
 *
vma
)

827 
	`dbg
("vm_close \n");

829 
	}
}

832 
·ge
 * 
	$tc_vm_nİage
(
vm_¬—_¡ruù
 *
vma
, 
vaddr
,*
ty³
)

834 
·ge
 *·gğ
NOPAGE_SIGBUS
;

835 
tw_audio_’
 *
e
 = 
vma
->
vm_´iv©e_d©a
;

836 
off
 = 0;

837 
tc_queue
 *
q
 = 
e
->
queue
;

838 
tc_bufãr_k”n
 * 
tck
 = 
q
->
bufs
[q->
½
];

840 
	`dbg
("nİage: fauÉ @ %08lx [vm¨%08lx-%08lx]\n",
vaddr
,
vma
->
vm_¡¬t
,vma->
vm_’d
);

841 ià(
vaddr
 > 
vma
->
vm_’d
)

842  
NOPAGE_SIGBUS
;

845 
off
 = (
vaddr
 - 
vma
->
vm_¡¬t
è+ (vma->
vm_pgoff
 << 
PAGE_SIZE
);

846 if(
off
 > 4096*3){

847 
	`dbg
("%s---------> ouˆog„ªge!\n",
__FUNCTION__
);

848  
·ge
;

851 
	`dbg
("%s--->ofàğ%d\n",
__FUNCTION__
,
off
);

852 
	`mu‹x_lock
(&
e
->
queue
->
lock
);

853 
·ge
 = 
	`vœt_to_·ge
(
tck
->
¡¬t
);

854 
	`dbg
("givth%dck ;tck->off_to_·gğ%d\n",
q
->
½
,
tck
->
off_to_·ge
);

855 
	`mu‹x_uÆock
(&
e
->
queue
->
lock
);

857 
	`dbg
("\Àtck' ·gğ%X;tc->¡¬ˆğ%X‡ndck->off_to_·gğ%d\n",
·ge
,
tck
->
¡¬t
,tck->
off_to_·ge
);

858 if(!
·ge
)

859  
NOPAGE_OOM
;

860 
	`g‘_·ge
(
·ge
);

861 ià(
ty³
)

862 *
ty³
 = 
VM_FAULT_MINOR
;

863  
·ge
;

864 
	}
}

865 
vm_İ”©iÚs_¡ruù
 
	gtc_vm_İs
 =

867 .
İ’
 = 
tc_vm_İ’
,

868 .
	gşo£
 = 
tc_vm_şo£
,

869 .
	gnİage
 = 
NULL
,

875 
	$mm­_sÿ‰”
(
vm_¬—_¡ruù
 *
vma
,
tc_queue
 *
tq
, 
size
)

877 
»t
=0;

878 
idx
 = 0,
cix
 = 0;

879 
¡¬t
,
pâ
;

880 
ú
 = 0;

881 
tc_bufãr_k”n
 *
tck
;

884 
¡¬t
 = 
vma
->
vm_¡¬t
;

885 
tck
 = 
tq
->
bufs
[0];

888 if(!
tck
->
thb
 || !tck->thb->
d©a
){

889 
	`dbg
("tck has‚o header buf orhb->data is NULL\n");

890  -
EINVAL
;

892 
pâ
 = (
	`__·
(
tck
->
thb
->
d©a
)è>> 
PAGE_SHIFT
;

893 if(
	`»m­_pâ_¿nge
(
vma
,
¡¬t
,
pâ
,
PAGE_SIZE
,
PAGE_SHARED
)){

894 
	`dbg
("remap header_buf failed\n");

895  -
ENXIO
;

898 
¡¬t
 +ğ
PAGE_SIZE
;

902 (
tck
 = 
tq
->
bufs
[
cix
]è&& (
STATE_READY
 =ğ
	`g‘_tck_¡©e
(tck))){

903 
ú
 = 
	`round_up
(
tck
->
size
,
PAGE_SIZE
);

904 
	`£t_tck_¡©e
(
tck
,
STATE_BUSY
);

905 
idx
 = 0; idx < 
ú
; idx++){

906 if(!
tck
->
sg
[
idx
].
ÿ¼›r
 || !tck->sg[idx].
addr
 || !tck->sg[idx].
Ën
)

908 
pâ
 = (
	`__·
(
tck
->
sg
[
idx
].
addr
)è>> 
PAGE_SHIFT
;

910 if(
	`»m­_pâ_¿nge
(
vma
,
¡¬t
,
pâ
,
PAGE_SIZE
,
PAGE_SHARED
)){

911 
	`dbg
("remap…age„ange failed\n");

912  -
ENXIO
;

914 
¡¬t
 +ğ
PAGE_SIZE
;

916 
cix
++;

917 if(
cix
 >ğ
tq
->
buf_Ä
)

920  
»t
;

921 
	}
}

923 
	$mm­_sšgË
(
vm_¬—_¡ruù
 *
vma
,
tc_queue
 *
tq
)

925 
pâ
,
Ï¡_pâ
 = 0,
¡¬t
;

926 
tc_bufãr_k”n
 *
tck
 = 
tq
->
bufs
[0];

927 
idx
 = 0;

929 
¡¬t
 = 
vma
->
vm_¡¬t
;

931 if(!
tck
->
thb
 || !tck->thb->
d©a
){

932 
	`dbg
("tck has‚o header buf orhb->data is NULL\n");

933  -
EINVAL
;

936 
pâ
 = (
	`__·
(
tck
->
thb
->
d©a
)è>> 
PAGE_SHIFT
;

937 if(
	`»m­_pâ_¿nge
(
vma
,
¡¬t
,
pâ
,
PAGE_SIZE
,
PAGE_SHARED
)){

938 
	`dbg
("remap header_buf failed\n");

939  -
ENXIO
;

942 
¡¬t
 +ğ
PAGE_SIZE
;

944 (
tck
 = 
tq
->
bufs
[
idx
]è&& (
STATE_READY
 =ğ
	`g‘_tck_¡©e
(tck))){

945 
pâ
 = (
	`__·
(
tck
->
¡¬t
)è>> 
PAGE_SHIFT
;

947 
	`£t_tck_¡©e
(
tck
,
STATE_BUSY
);

948 if(
Ï¡_pâ
 !ğ
pâ
){

950 ià(
	`»m­_pâ_¿nge
(
vma
,
¡¬t
,
pâ
,
PAGE_SIZE
,
PAGE_SHARED
)){

951 
	`dbg
("remap…age„ange failed\n");

952  -
ENXIO
;

954 
¡¬t
 +ğ
PAGE_SIZE
;

956 
Ï¡_pâ
 = 
pâ
;

957 
idx
++;

958 if(
idx
 >ğ
tq
->
buf_Ä
)

962 
	}
}

964 
	$tws_mm­
(
fe
 *fe, 
vm_¬—_¡ruù
 *
vma
)

966 
»t
 = 0;

967 
tw_£rviû_deviû
 *
tsd
 = (tw_£rviû_deviû *)
fe
->
´iv©e_d©a
;

968 
off£t
 = 
vma
->
vm_pgoff
 << 
PAGE_SHIFT
;

969 
size
 = 
vma
->
vm_’d
 - vma->
vm_¡¬t
;

970 
tc_queue
 *
q
 = 
tsd
->
queue
;

972 #ifdeà
STATIC_COUNTING


973 
	`g‘_ic_m­_¡¬t
(
tsd
);

975 ià(
off£t
 & ~
PAGE_MASK
){

976 
	`dbg
("off£ˆnÙ‡ligÃd: %ld\n", 
off£t
);

977  -
ENXIO
;

986 ià((
vma
->
vm_æags
 & 
VM_WRITE
è&& !(vma->vm_æag & 
VM_SHARED
)){

987 
	`dbg
("writeable mappings must be shared,„ejecting\n");

988 (-
EINVAL
);

1001 if(!
q
){

1002 
	`dbg
("tsd‚o queue\n");

1003  -
EINVAL
;

1007 if(
q
->
un™_size
 >
PAGE_SIZE
)

1008 
»t
 = 
	`mm­_sÿ‰”
(
vma
,
q
,
size
);

1010 
»t
 = 
	`mm­_sšgË
(
vma
,
q
);

1012 #ifdeà
STATIC_COUNTING


1013 
	`ÿlc_ic_m­_time
(
tsd
);

1015  
»t
;

1016 
	}
}

1019 
fe_İ”©iÚs
 
	gtws_fİs
 = {

1020 .
owÃr
 = 
THIS_MODULE
,

1021 .
	gİ’
 = 
tws_İ’
,

1022 .
	g»Ëa£
 = 
tws_»Ëa£
,

1023 .
	g»ad
 = 
tws_»ad
,

1024 .
	gwr™e
 = 
tws_wr™e
,

1025 .
	gioùl
 = 
tws_ioùl
,

1026 .
	gmm­
 = 
tws_mm­
,

1027 .
	gpŞl
 = 
tws_pŞl
,

1032 
	$ch_»Ëa£
(
şass_deviû
 *
cd
)

1035 
	}
}

1037 
şass
 
	gtw_tcd
 = {

1038 .
Çme
 = "twell",

1039 .
	g»Ëa£
 = 
ch_»Ëa£
,

1043 
	$»gi¡”_chdeviû_nÙif›r
(
nÙif›r_block
 *
nb
)

1045 
tw_ch_deviû
 *
dev
;

1046 
li¡_h—d
 * 
p
;

1047 
tw_ch_deviû
 *
Ï¡
;

1048 
”r
;

1050 
	`mu‹x_lock
(&
tw_cÜe_li¡s
);

1051 
”r
 = 
	`¿w_nÙif›r_chaš_»gi¡”
(&
tw_chdev_chaš
, 
nb
);

1052 ià(
”r
)

1053 
uÆock
;

1055 
	`li¡_fÜ_—ch
(
p
, &
tw_chdev
){

1056 
dev
 = 
	`cÚš”_of
(
p
, 
tw_ch_deviû
,
li¡
);

1057 
”r
 = 
nb
->
	`nÙif›r_ÿÎ
Òb, 
CHIPDEV_REGISTER
, 
dev
);

1058 
”r
 = 
	`nÙif›r_to_”ºo
(err);

1059 ià(
”r
)

1060 
rŞlback
;

1065 
nb
->
	`nÙif›r_ÿÎ
Òb, 
CHIPDEV_UP
, 
dev
);

1067 
uÆock
:

1068 
	`mu‹x_uÆock
(&
tw_cÜe_li¡s
);

1069  
”r
;

1071 
rŞlback
:

1072 
Ï¡
 = 
dev
;

1073 
	`li¡_fÜ_—ch
(
p
, &
tw_chdev
){

1074 ià(
dev
 =ğ
Ï¡
)

1081 
nb
->
	`nÙif›r_ÿÎ
Òb, 
CHIPDEV_UNREGISTER
, 
dev
);

1084 
	`¿w_nÙif›r_chaš_uÄegi¡”
(&
tw_chdev_chaš
, 
nb
);

1085 
uÆock
;

1086 
	}
}

1087 
	$uÄegi¡”_chdeviû_nÙif›r
(
nÙif›r_block
 *
nb
)

1089 
”r
;

1091 
	`mu‹x_lock
(&
tw_cÜe_li¡s
);

1092 
”r
 = 
	`¿w_nÙif›r_chaš_uÄegi¡”
(&
tw_chdev_chaš
, 
nb
);

1093 
	`mu‹x_uÆock
(&
tw_cÜe_li¡s
);

1094  
”r
;

1095 
	}
}

1098 
	$tw_ch_commªd
(
tw_ch_deviû
 *
ch
, 
cmd
, *
¬g
)

1100 
li¡_h—d
 *
™em
;

1103 
ch
->
driv”
->
	`commªd
(ch,
cmd
,
¬g
);

1105 
nÙify
 
Ùh”s
 
which
 
is
 
š‹»¡ed
 
w™h
 
this
 
ch


1114 
	`dumy_»Ëa£
(
deviû
 * 
dev
)

1124 
tw_ch_deviû
 * 
	`tc_chdev_®loc
(
´iv_size
)

1126 * 
p
;

1127 
size
;

1128 
tw_ch_deviû
 *
tcd
;

1130 
size
 = ((*
tcd
è+ 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK;

1131 
size
 +ğ
´iv_size
 + 
CHIPDEV_ALIGN_MASK
;

1132 
p
 = 
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

1133 if(!
p
){

1134 
	`´štk
("%s:‚Ømem!, %lu\n",
__FUNCTION__
, 
size
);

1135  
NULL
;

1137 
	`mem£t
(
p
, 0, 
size
);

1138 
	`dbg
("°=%p\n",
p
);

1139 
tcd
 = (
tw_ch_deviû
 *)((()
p
 + 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK);

1140 
	`dbg
("tcd = %p\n",
tcd
);

1141 
tcd
->
·dded
 = (*écd - (*)
p
;

1142 
tcd
->
´iv_Ën
 = 
´iv_size
;

1143 
tcd
->
tÙ®_Ën
 = 
size
;

1144 
	`dbg
("cd->·dded = %d\n",
tcd
->
·dded
);

1145 if(
´iv_size
)

1146 
tcd
->
´iv
 = 
	`tcd_´iv
(tcd);

1147  
tcd
;

1150 
	`tc_chdev_ä“
(
tw_ch_deviû
 * 
tcd
)

1152 *
p
 = (*)
tcd
;

1154 
p
 =…- 
tcd
->
·dded
;

1155 
	`dbg
("ä“‡dd¸=%p\n",
p
);

1157 
	`ä“_·ges
(()
p
,
	`g‘_Üd”
(
tcd
->
tÙ®_Ën
));

1165 
	`check_chdev_šfo
(
tw_ch_deviû
 * 
tcd
)

1167 if(!
tcd
->
Çme
[0]){

1168 
	`dbg
("no‚ame for chip device!\n");

1176 
	`£tup_ch_dev
(
tw_ch_deviû
 * 
tcd
)

1183 
	`bšd_ch_driv”
(
tw_ch_deviû
 * 
tcd
)

1185 
li¡_h—d
 *
p
;

1186 
tw_ch_driv”
 *
tdr
;

1187 
tw_dev_bË_id
 *
bË_id
;

1190 
	`__li¡_fÜ_—ch
(
p
,&
tw_chdrv
){

1191 
tdr
 = 
	`li¡_’Œy
(
p
,
tw_ch_driv”
,
li¡
);

1192 
bË_id
 = &
tdr
->
deviû_id
;

1193 if(!
bË_id
->
tid
){

1194 
	`´štk
("BUG:noid„egistered withw_chip_driver!\n");

1195  -
EINVAL
;

1197 if(
	`ch_deviû_m©ch
(&
tcd
->
•obj
,&
bË_id
->
tid
->epobj)){

1198 
tcd
->
driv”
 = 
tdr
;

1199 if(
tdr
->
©ch_ch
)

1200  
tdr
->
	`©ch_ch
Ñdr,
tcd
);

1207 
	`unbšd_ch_driv”
(
tw_ch_deviû
 *
tcd
)

1209 
li¡_h—d
 *
p
;

1210 
tw_ch_driv”
 *
tdr
;

1211 
tw_dev_bË_id
 *
bË_id
;

1214 
	`__li¡_fÜ_—ch
(
p
,&
tw_chdrv
){

1215 
tdr
 = 
	`li¡_’Œy
(
p
,
tw_ch_driv”
,
li¡
);

1216 
bË_id
 = &
tdr
->
deviû_id
;

1217 if(!
bË_id
->
tid
){

1218 
	`´štk
("BUG:noid„egistered withw_chip_driver!\n");

1221 if(
	`ch_deviû_m©ch
(&
tcd
->
•obj
,&
bË_id
->
tid
->epobj)){

1222 
tcd
->
driv”
 = 
tdr
;

1223 if(
tdr
->
d‘ach_ch
)

1224 
tdr
->
	`d‘ach_ch
Ñdr,
tcd
);

1232 
	`ch_deviû_m©ch
(
•obj_t
 *
a
, •obj_ˆ*
b
)

1234 
	`dbg
("a->vid[%lu],a->bid[%lu],a->cid[%lu]---\Àb->vid[%lu],b->bid[%lu],b->cid[%lu]---\n",
a
->
v’dÜ_id
,

1235 
a
->
bus_id
,a->
ch_id
,
b
->
v’dÜ_id
,b->bus_id,b->chip_id);

1236 if(
a
->
v’dÜ_id
 =ğ
b
->v’dÜ_id &&‡->
bus_id
 =ğb->bus_id &&‡->
ch_id
 == b->chip_id)

1242 
	`»gi¡”_ch_deviû
(
tw_ch_deviû
 *
tcd
)

1244 
»t
 = 0;

1245 
idx
 = 0;

1246 
mšÜ
 = -1;

1247 
æag
 = 0;

1248 
ch_dœ_Çme
[50]={0};

1249 
kobjeù
 *
kobj
 = 
NULL
;

1250 
fix_id
;

1251 
cmd_¬g
 
ÿ
 = {0};

1254 if(
	`check_chdev_šfo
(
tcd
))

1255  -
EINVAL
;

1260 
ÿ
.
ty³
 = 0;

1261 
mšÜ
 = 
	`g‘_ä“_mšÜ
(&
ÿ
);

1262 if(
mšÜ
 < 0 || minor > 256)

1264 
	`dbg
("mšÜ i %d",
mšÜ
);

1265  -
EINVAL
;

1268 
	`¢´štf
(
ch_dœ_Çme
,(ch_dœ_Çme),"%s",
tcd
->
Çme
);

1269 
kobj
 = 
	`tw_ü—‹_dœ
(
ch_dœ_Çme
,
kroÙ
);

1270 if(
kobj
 =ğ
NULL
){

1271 
	`dbg
("create dir failed!\n");

1272  -
EINVAL
;

1275 
tcd
->
cdev
 = (cdev *)
	`cdev_®loc
();

1276 if(
tcd
->
cdev
 =ğ
NULL
){

1277 
	`dbg
("cdev_alloc failed!\n");

1278 
»t
 = -
ENOMEM
;

1279 
ş—nup
;

1282 
	`cdev_š™
(
tcd
->
cdev
,&
tw_fİs
);

1283 
tcd
->
cdev
->
owÃr
 = 
THIS_MODULE
;

1284 
»t
 = 
	`cdev_add
(
tcd
->
cdev
,
	`MKDEV
(
TW_CHIP_MAJOR
,
mšÜ
),1);

1285 if(
»t
 < 0){

1286 
æag
 = 1;

1287 
	`dbg
("cdev_add failed!\n");

1288 
ş—nup
;

1291 
idx
 = 0; idx < (
tcd
->
tsd_li¡
)/(
li¡_h—d
) ; idx++){

1292 
	`INIT_LIST_HEAD
(&
tcd
->
tsd_li¡
[
idx
]);

1293 
tcd
->
dœs
[
idx
] = 
NULL
;

1295 
tcd
->
mšÜ
 = minor;

1297 
tcd
->
dev
.
·»Á
 = 
NULL
;

1298 
tcd
->
dev
.
kobj
.
·»Á
 = kobj;

1299 
tcd
->
dev
.
devt
 = 
	`MKDEV
(
TW_CHIP_MAJOR
,
mšÜ
);

1300 
tcd
->
dev
.
»Ëa£
 = 
dumy_»Ëa£
;

1301 
fix_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

1302 
	`¢´štf
(
tcd
->
dev
.
bus_id
,Ñcd->dev.bus_id),"%scÚŒŞ%02lu",tcd->
Çme
,
fix_id
);

1303 
»t
 = 
	`deviû_»gi¡”
(&
tcd
->
dev
);

1304 if(
»t
 < 0){

1305 
	`dbg
("device„egister failed!\n");

1306 
ş—nup
;

1308 
»t
 = 
	`bšd_ch_driv”
(
tcd
);

1309 if(
»t
)

1310 
bšd_”rÜ
;

1312 
	`mu‹x_lock
(&
mu‹x_chdev
);

1313 
	`li¡_add_
(&
tcd
->
li¡
,&
tw_chdev
);

1314 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

1317  
»t
;

1318 
ş—nup
:

1319 if(
kobj
)

1320 
	`kä“
(
kobj
);

1321 if(
tcd
->
cdev
){

1322 if(
æag
 == 0)

1323 
	`cdev_d–
(
tcd
->
cdev
);

1324 
	`kä“
(
tcd
->
cdev
);

1326  
»t
;

1327 
bšd_”rÜ
:

1328 
	`´štk
("chip driver bindƒrror!");

1329  
»t
;

1334 
	`uÄegi¡”_ch_deviû
(
tw_ch_deviû
 * 
tcd
)

1336 
kobjeù
 * 
dœ_kobj
 = 
NULL
;

1339 
	`dbg
("·s£dcd[0x%8p]\n",
tcd
);

1340 if(!
tcd
){

1341 
	`dbg
("ungister with NULL…ointer!\n");

1342 
dÚÙhšg
;

1344 if(
	`fšd_ch_dev
(
tcd
->
mšÜ
è=ğ
NULL
){

1345 
	`dbg
("bad ungister!\n");

1346 
dÚÙhšg
;

1349 
dœ_kobj
 = 
tcd
->
dev
.
kobj
.
·»Á
;

1350 if(!
dœ_kobj
){

1351 
	`dbg
("this device is†ocated wrong…lace!\n");

1352 
dÚÙhšg
;

1355 
	`mu‹x_lock
(&
mu‹x_chdev
);

1356 
	`li¡_d–
(&
tcd
->
li¡
);

1357 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

1359 
	`cdev_d–
(
tcd
->
cdev
);

1360 
	`kä“
(
tcd
->
cdev
);

1362 
	`deviû_uÄegi¡”
(&
tcd
->
dev
);

1365 
	`unbšd_ch_driv”
(
tcd
);

1366 
	`put_ä“_mšÜ
(
tcd
->
mšÜ
,0);

1367 if(!
tcd
->
ş—n_up
){

1368 
	`dbg
("no clean_up function„egisted forcd\n");

1369 
	`tw_»move_dœ
(
dœ_kobj
);

1370 
	`dbg
("afterw_remove_dir!\n");

1373 
tcd
->
	`ş—n_up
(tcd);

1374 
	`tw_»move_dœ
(
dœ_kobj
);

1376 
dÚÙhšg
:

1384 
	`»gi¡”_ch_driv”
(
tw_ch_driv”
 * 
driv
)

1386 
»s
 = 0;

1387 
li¡_h—d
 *
p
;

1388 
tw_ch_deviû
 * 
tcd
 = 
NULL
;

1389 
tw_dev_bË_id
 * 
bË_id
 = &
driv
->
deviû_id
;

1392 
driv
->
driv”
.
bus
 = &
tw_vœtu®_bus
;

1393 
	`INIT_LIST_HEAD
(&
driv
->
tcd_li¡
);

1396 
»s
 = 
	`driv”_»gi¡”
(&
driv
->
driv”
);

1397 ià(
»s
)

1398  
»s
;

1400 
	`mu‹x_lock
(&
mu‹x_chdrv
);

1401 
	`li¡_add_
(&
driv
->
li¡
,&
tw_chdrv
);

1402 
	`mu‹x_uÆock
(&
mu‹x_chdrv
);

1406 
	`__li¡_fÜ_—ch
(
p
,&
tw_chdev
){

1407 
tcd
 = 
	`li¡_’Œy
(
p
,
tw_ch_deviû
,
li¡
);

1408 if(
	`ch_deviû_m©ch
(&
tcd
->
•obj
,&
bË_id
->
tid
->epobj)){

1409 
tcd
->
driv”
 = 
driv
;

1410 if(
driv
->
©ch_ch
)

1411 
driv
->
	`©ch_ch
(driv,
tcd
);

1414  
»s
;

1419 
	`uÄegi¡”_ch_driv”
(
tw_ch_driv”
 * 
driv
)

1421 
li¡_h—d
 * 
p
 = 
NULL
;

1422 
tw_ch_deviû
 * 
tcd
 = 
NULL
;

1423 
tw_dev_bË_id
 * 
bË_id
 = &
driv
->
deviû_id
;

1425 if(
driv
->
d‘ach_ch
){

1426 
	`__li¡_fÜ_—ch
(
p
,&
tw_chdev
){

1427 
tcd
 = 
	`li¡_’Œy
(
p
, 
tw_ch_deviû
, 
li¡
);

1428 if(
	`ch_deviû_m©ch
(&
tcd
->
•obj
,&
bË_id
->
tid
->epobj))

1429 
driv
->
	`d‘ach_ch
(driv,
tcd
);

1433 
	`driv”_uÄegi¡”
(&
driv
->
driv”
);

1434 
	`mu‹x_lock
(&
mu‹x_chdrv
);

1435 
	`li¡_d–
(&
driv
->
li¡
);

1436 
	`mu‹x_uÆock
(&
mu‹x_chdrv
);

1441 
	`check_v®id
(
tw_ch_deviû
* 
tcd
,
ty³
)

1445 if((
ty³
 > 
MAX_SERVICE_NR
è|| 
tcd
 =ğ
NULL
)

1452 
	`check_chdev_lim™
(
tw_ch_deviû
 *
tcd
, 
cmd_¬g
 *
¬g
)

1454 
li¡_h—d
 *
p
;

1455 
cmd_li¡
 *
ş
;

1457 
	`li¡_fÜ_—ch
(
p
,&
ş_h—d
){

1458 
ş
 = 
	`cÚš”_of
(
p
, 
cmd_li¡
, 
node
);

1459 if(
	`cmd_equ®
(&
ş
->
¬g
,arg))

1460  -
EINVAL
;

1466 
kobjeù
 * 
	`g‘_dœ
(
tw_ch_deviû
 *
tcd
, 
ty³
)

1468 * 
Çme_´efix
 = 
NULL
;

1469 
kobjeù
 *
dœ
 = 
NULL
;

1471 if(
tcd
->
dœs
[
ty³
])

1472  
tcd
->
dœs
[
ty³
];

1474 
ty³
+1)

1476 
TW_ENCODER
:

1477 
Çme_´efix
 = "tw_encoder";

1479 
TW_DECODER
:

1480 
Çme_´efix
 = "tw_decoder";

1482 
TW_VIDEO_IN
:

1483 
Çme_´efix
 = "tw_video_in";

1485 
TW_VIDEO_OUT
:

1486 
Çme_´efix
 = "tw_video_out";

1488 
TW_AUDIO_IN
:

1489 
Çme_´efix
 = "tw_audio_in";

1491 
TW_AUDIO_OUT
:

1492 
Çme_´efix
 = "tw_audio_out";

1495 
Çme_´efix
 = "unknown";

1502 
dœ
 = 
	`tw_ü—‹_dœ
(
Çme_´efix
, 
tcd
->
dev
.
kobj
.
·»Á
);

1503 if(
dœ
 =ğ
NULL
)

1504 
	`dbg
("ü—‹ dœ faed iÀ%s\n", 
__FUNCTION__
);

1507  
dœ
;

1514 
tw_dev_bË_id
 * 
	`lookup_tcdev_be_id
(
•obj_t
 *
•
)

1516 
li¡_h—d
 *
p
 = &
tw_tc_dev
;

1517 
tw_dev_bË_id
 *
dev
;

1519 
	`li¡_fÜ_—ch
(
p
, &
tw_tc_dev
){

1520 
dev
 = 
	`li¡_’Œy
(
p
, 
tw_dev_bË_id
, 
li¡
);

1521 ià(
	`•obj_euq®
(
•
,&
dev
->
tid
->
•obj
))

1522  
dev
;

1524  
NULL
;

1528 
	`·r£_¬g
(
tw_ch_deviû
 *
tcd
, 
cmd_¬g
 *
¬g
)

1530 
ch_driv”_t
 *
cd
;

1531 
tw_logic_phy_bË
 *
p
;

1532 
u32
 
logic
 = 0,
phy
 = 0;

1533 
»t
 = -1;

1534 
LOGIC_MAP_TABLE_TYPE
 
mt
;

1536 if(!
tcd
 || !
¬g
 || !tcd->
³d
){

1537 
	`dbg
("invalid…arameters!\n");

1538  -
EINVAL
;

1542 
cd
 = 
	`cÚš”_of
(
tcd
->
³d
, 
ch_driv”_t
,
İ’ed_cÚŒŞ_ed
);

1543 
p
 = &
cd
->
logic_m­_phy
;

1544 if(!
p
->
İ
 || !p->İ->
fšd_phy_by_logic
){

1545 
	`´štk
("logic map‚o op\n");

1546  -
EINVAL
;

1549 if(
TW_ENCODER
 =ğ
¬g
->
ty³
){

1550 if(
CODEC_VIDEO_H264
 =ğ
¬g
->
®gÜ™hm
){

1551 
mt
 = 
LOGIC_MAP_TABLE_BIND_H264E
;

1553 if(
STREAM_TYPE_AUDIO
 =ğ
¬g
->
¡»am
){

1554 
mt
 = 
LOGIC_MAP_TABLE_BIND_AENC
;

1556 if(
CODEC_VIDEO_MJPG
 =ğ
¬g
->
®gÜ™hm
){

1557 
mt
 = 
LOGIC_MAP_TABLE_BIND_JPEGE
;

1560 
out
;

1563 if(
TW_DECODER
 =ğ
¬g
->
ty³
){

1564 if(
STREAM_TYPE_AUDIO
 =ğ
¬g
->
¡»am
){

1565 
mt
 = 
LOGIC_MAP_TABLE_BIND_ADEC
;

1567 if(
CODEC_VIDEO_H264
 =ğ
¬g
->
®gÜ™hm
){

1568 
mt
 = 
LOGIC_MAP_TABLE_BIND_H264D
;

1571 
out
;

1575 
out
;

1578 
logic
 = 
¬g
->
chªÃl_idx
;

1579 
»t
 = 
p
->
İ
->
	`fšd_phy_by_logic
ÑÍ, 
mt
,
logic
, &
phy
);

1580 if(
»t
){

1581 
	`dbg
("logico…hy find‚othing!!!!\n");

1582 
out
;

1584 
¬g
->
chªÃl_idx
 = 
phy
;

1587 
out
:

1588  
»t
;

1592 
	`tc_driv”_š™
(
tw_ch_deviû
 *
tcd
, 
tw_£rviû_deviû
 *
tsd
,
tw_£rviû_driv”
 *
driv
, 
cmd_¬g
 *
¬g
)

1594 
»t
 = 0;

1595 
tsd_driv”_İ”©iÚs
 *
tsdr
;

1596 
tw_dev_bË_id
 *
bË_id
;

1597 
cmd_¬g
 
tmp_¬g
 = {0};

1599 if(!
driv
){

1600 
	`´štk
("--->š %s\n",
__FUNCTION__
);

1601  -
EINVAL
;

1603 
bË_id
 = (
tw_dev_bË_id
 *)&
driv
->
deviû_id
;

1604 if(!
bË_id
->
İs
){

1605 
	`dbg
("driver with‚o ops!\n");

1606  -
EINVAL
;

1608 
tsdr
 = (
tsd_driv”_İ”©iÚs
 *)
bË_id
->
İs
;

1609 if(!
tsdr
->
š™
){

1610 
	`dbg
("driver with‚o init function!\n");

1611  -
EINVAL
;

1614 
	`cİy_äom_u£r
((*)&
tmp_¬g
,(
__u£r
 *)
¬g
, (
cmd_¬g
));

1615 if(
TW_ENCODER
 =ğ
¬g
->
ty³
 || 
TW_DECODER
 ==‡rg->type){

1616 if(
	`·r£_¬g
(
tcd
,&
tmp_¬g
))

1617  -
EINVAL
;

1621 
	`´štk
("[[logiøid = %lu]]\n",
tmp_¬g
.
chªÃl_idx
);

1622 
»t
 = 
tsdr
->
	`š™
(
tcd
,
tsd
,
bË_id
->
·¿
,&
tmp_¬g
);

1623 if(
»t
){

1624 
	`dbg
("driver can‚ot‡lloc„esource!\n");

1625  -
ENOMEM
;

1627 
	`•obj_key_upd©e_phy_id
((
•key_t
 *)&(
tsd
->
•obj
.
key
),
tmp_¬g
.
chªÃl_idx
);

1628  
»t
;

1634 
	`£tup_£rviû_deviû
(
tw_£rviû_deviû
 *
tsd
, 
tw_ch_deviû
 *
tcd
, 
cmd_¬g
 *
¬g
, 
kobjeù
 *
dœ
,
tw_dev_bË_id
 *
bË_id
)

1636 
»t
 = 0,
sma
,
mšÜ
;

1637 
i§dd
 = 0;

1638 
deviû_šfo
 
di
 = {0};

1639 
li¡_h—d
 *
¶i¡
 = 
NULL
;

1640 
ty³
 = 
¬g
->type - 1;

1641 
tmp
[255] = {0};

1642 *
ı
 = 
tmp
;

1644 if(
ty³
 < 0){

1645 
	`´štk
("BUG:y³ƒ¼Ü iÀ%s!\n", 
__FUNCTION__
);

1649 
tcd
->
dœs
[
ty³
] = 
dœ
;

1650 
	`•obj_£t
(&
tsd
->
•obj
,&
tcd
->epobj);

1651 
tsd
->
•obj
.
ty³
 = 
¬g
->type;

1652 
tsd
->
•obj
.
func_id
 = (
¬g
->
¡»am
 << 16è|‡rg->
®gÜ™hm
;

1654 
	`mem£t
((*)&
tsd
->
•obj
.
key
,0,(
•key_t
));

1655 
	`make_£rviû_key
((
•key_t
 *)&
tsd
->
•obj
.
key
,
tcd
,
¬g
);

1656 
	`dbg_•obj_´št
(&
tsd
->
•obj
);

1657 if((
»t
 = 
	`tc_driv”_š™
(
tcd
,
tsd
,
bË_id
->
´iv
,
¬g
))){

1658 
	`´štk
("service driver init failed!\n");

1659  
»t
;

1662 
sma
 = 
TW_SERVICE_BASE_MAJOR
 + 
ty³
;

1663 if(
ty³
 > 1)

1664 
	`¢´štf
(
tsd
->
Çme
,Ñsd->Çme),"chª%02lu-%s",
¬g
->
chªÃl_idx
,
tc_dev_Çme
[
ty³
+1]);

1666 
	`¢´štf
(
tsd
->
Çme
,Ñsd->Çme),"chª%02lu-%s-%s",
¬g
->
chªÃl_idx
,
¡»am
[¬g->¡»am],
®gÜ™hm
[arg->algorithm]);

1667 
tsd
->
cdev
 = 
	`cdev_®loc
();

1668 if(
tsd
->
cdev
 =ğ
NULL
){

1669 
	`dbg
("cdev_alloc failed!\n");

1670  -
ENOMEM
;

1673 
mšÜ
 = 
	`g‘_ä“_mšÜ
(
¬g
);

1675 if(
mšÜ
 < 0){

1676 
	`dbg
("service minor get failed!\n");

1677 
	`kä“
(
tsd
->
cdev
);

1678  -
EINVAL
;

1681 
	`cdev_š™
(
tsd
->
cdev
,&
tws_fİs
);

1682 
tsd
->
cdev
->
owÃr
 = 
THIS_MODULE
;

1683 
»t
 = 
	`cdev_add
(
tsd
->
cdev
,
	`MKDEV
(
sma
,
mšÜ
),1);

1684 if(
»t
 < 0){

1685 
	`dbg
("cdev_add failed!\n");

1686 
”rÜ
;

1688 
i§dd
 = 1;

1690 
tsd
->
mšÜ
 = minor;

1691 
tsd
->
±cd
 = 
tcd
;

1692 
tsd
->
ty³
 =ype;

1693 
tsd
->
dev
.
kobj
.
·»Á
 = 
dœ
;

1694 
tsd
->
dev
.
şass
 = 
NULL
;

1695 
tsd
->
dev
.
devt
 = 
	`MKDEV
(
sma
,
mšÜ
);

1696 
tsd
->
dev
.
»Ëa£
 = 
dumy_»Ëa£
;

1697 
	`¥rštf
(
tsd
->
dev
.
bus_id
,"%s",tsd->
Çme
);

1698 
»t
 = 
	`deviû_»gi¡”
(&
tsd
->
dev
);

1699 if(
»t
<0){

1700 
	`dbg
("deviû_»gi¡” faed iÀ%s!\n",
__FUNCTION__
);

1701 
”rÜ
;

1703 #ifdeà 
STATIC_COUNTING


1704 
	`mem£t
((*)&
tsd
->
b_™v®
, 0, (
tc_buf_š‹rv®
));

1705 
tsd
->
b_™v®
.
u_time
 = 5;

1707 
¶i¡
 = &
tcd
->
tsd_li¡
[
ty³
];

1708 
	`li¡_add_
(&
tsd
->
li¡
,
¶i¡
);

1718 
di
.
majÜ
 = 
sma
;

1719 
di
.
mšÜ
 = minor;

1720 
	`memıy
(
di
.
·th
,
tsd
->
Çme
,255);

1722 
	`cİy_to_u£r
(
¬g
->
dev_šfo
,&
di
,(
deviû_šfo
));

1725 
”rÜ
:

1726 if(
tsd
->
cdev
){

1727 if(
i§dd
)

1728 
	`cdev_d–
(
tsd
->
cdev
);

1729 
	`kä“
(
tsd
->
cdev
);

1730 
	`put_ä“_mšÜ
(
mšÜ
,
¬g
->
ty³
);

1732  
»t
;

1737 
tw_£rviû_deviû
 * 
	`tc_£rdev_®loc
(
´iv_size
)

1739 * 
p
;

1740 
size
;

1741 
tw_£rviû_deviû
 *
tsd
;

1743 
size
 = ((*
tsd
è+ 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK;

1744 
size
 +ğ
´iv_size
 + 
CHIPDEV_ALIGN_MASK
;

1745 
p
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

1746 if(!
p
){

1747 
	`´štk
("%s:‚Ømem!\n",
__FUNCTION__
);

1748  
NULL
;

1750 
tsd
 = (
tw_£rviû_deviû
 *)((()
p
 + 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK);

1751 
tsd
->
·dded
 = (*ésd - (*)
p
;

1752 if(
´iv_size
)

1753 
tsd
->
´iv
 = 
	`tsd_´iv
(tsd);

1755  
tsd
;

1758 
	`tc_£rdev_ä“
(
tw_£rviû_deviû
 * 
tsd
)

1760 
	`kä“
((*)
tsd
 -sd->
·dded
);

1765 
	`do_ü—‹_£rviû_dev
(
tw_ch_deviû
 * 
tcd
, 
cmd_¬g
 * 
¬g
, 
kobjeù
 * 
dœ
)

1767 
»t
 = 0;

1768 
•obj_t
 
•
 = {0};

1769 
tsd_fe_İ”©iÚs
 *
tsd_İs
 = 
NULL
;

1770 
tw_£rviû_deviû
 *
tsd
 = 
NULL
;

1771 
tw_dev_bË_id
 *
bË_id
;

1772 
cmd_li¡
 *
ş
 = 
NULL
;

1773 
ty³
 = 
¬g
->type - 1;

1775 if(
ty³
 < 0){

1776 
	`´štk
("BUG:y³ƒ¼Ü iÀ%s!\n", 
__FUNCTION__
);

1779 
tcd
->
dœs
[
ty³
] = 
dœ
;

1781 
	`•obj_£t
(&
•
,&
tcd
->
•obj
);

1782 
•
.
ty³
 = 
¬g
->type;

1783 
•
.
func_id
 = (
¬g
->
¡»am
 << 16è|‡rg->
®gÜ™hm
;

1785 
	`make_£rviû_key
((
•key_t
 *)&
•
.
key
,
tcd
,
¬g
);

1787 
bË_id
 = 
	`lookup_tcdev_be_id
(&
•
);

1788 if(!
bË_id
){

1789 
	`´štk
("we didn't supporthisype device!\n");

1790  -
ENODEV
;

1792 
tsd_İs
 = (
tsd_fe_İ”©iÚs
 *)
bË_id
->
İs
;

1794 if(!
tsd_İs
->
š™
){

1795 
	`dbg
("no init function for service device!\n");

1796  -
EINVAL
;

1800 
»t
 = 
tsd_İs
->
	`š™
(
tcd
,
¬g
,&
tsd
);

1801 if(
»t
 || !
tsd
){

1802 
tsd_İs
->
	`de¡Üy
(
tsd
);

1803  -
ENOMEM
;

1805 
tsd
->
tsd_fİs
 = 
bË_id
->
İs
;

1806 
tsd
->
´iv©e_d©a
 = 
bË_id
->
·¿
;

1808 
»t
 = 
	`£tup_£rviû_deviû
(
tsd
,
tcd
,
¬g
,
dœ
,
bË_id
);

1809 if(
»t
){

1810 
tsd_İs
->
	`de¡Üy
(
tsd
);

1811  
»t
;

1815 
ş
 = 
	`kz®loc
((*ş),
GFP_KERNEL
);

1816 if(!
ş
){

1817 
	`dbg
("cmd_list‡lloc failed!\n");

1818 
»t
 = -
ENOMEM
;

1819 
d_out
;

1823 
	`INIT_LIST_HEAD
(&
ş
->
node
);

1824 
ş
->
tcd
 =cd;

1825 
	`memıy
((*)&
ş
->
¬g
,(*ïrg,(
cmd_¬g
));

1826 
	`li¡_add_
(&
ş
->
node
,&
ş_h—d
);

1827 
	`´štk
("cmd_ty³[%d],cmd_cix[%lu],cmd_®go[%d],cmd_¡»am[%d]\n",
ş
->
¬g
.
ty³
,ş->¬g.
chªÃl_idx
,ş->¬g.
®gÜ™hm
,ş->¬g.
¡»am
);

1829 
d_out
:

1830 
	`»Ëa£_£rviû_deviû
(
tcd
, (*)
¬g
);

1831  
»t
;

1836 
	`do_add_to_k”Ãl
(
tw_ch_deviû
 * 
tcd
, *
¬g
)

1838 
»t
 =0,
majÜ
 = 0;

1839 
•key_t
 
Ãw_key
;

1840 
tw_£rviû_deviû
 *
tmp
 =
NULL
;

1841 
li¡_h—d
 *
h—d
 = 
NULL
;

1842 
li¡_h—d
 *
p
 = 
NULL
;

1843 
cmd_¬g
 *
d©a
 = (cmd_¬g *)
¬g
;

1844 
deviû_šfo
 
di
 = {0};

1845 
ty³
 = 
d©a
->type -1;

1847 if(
ty³
 < 0){

1848 
	`´štk
("š % ty³ƒ¼Ü !\n",
__FUNCTION__
);

1849  -
EINVAL
;

1851 
majÜ
 = 
ty³
 + 
TW_SERVICE_BASE_MAJOR
;

1852 
Ãw_key
 = 
	`make_£rviû_key
(
tcd
,
¬g
);

1853 
h—d
 = &
tcd
->
tsd_li¡
[
ty³
];

1854 
p
 = 
h—d
->
Ãxt
;

1855 ;
p
 !ğ
h—d
;… =…->
Ãxt
)

1857 
tmp
 = 
	`cÚš”_of
(
p
,
tw_£rviû_deviû
,
li¡
);

1858 if(
	`•key_equ®
(
tmp
->
•obj
.
key
,
Ãw_key
))

1859 
fšd
;

1861  -
ENODEV
;

1862 
fšd
:

1863 
di
.
majÜ
 = major;

1864 
di
.
mšÜ
 = 
tmp
->minor;

1865 
	`memıy
(
di
.
·th
,
tmp
->
Çme
,255);

1866 
	`cİy_to_u£r
(
d©a
->
dev_šfo
,&
di
,(
deviû_šfo
));

1867  
»t
;

1873 
	`ü—‹_£rviû_deviû
(
tw_ch_deviû
 * 
tcd
, 
d©a
)

1875 
»t
 = 0;

1876 
kobjeù
 *
dœ
 = 
NULL
;

1877 
cmd_¬g
 *
¬g
 = (cmd_¬g *)
d©a
;

1878 
™
 = 
¬g
->
ty³
 -1;

1880 if(
™
 < 0){

1881 
	`´štk
("BUG:”rÜy³ iÀ% \n",
__FUNCTION__
);

1882  -
EINVAL
;

1884 if(
	`check_v®id
(
tcd
,
¬g
->
ty³
)){

1885 
	`dbg
("invalid…arameters\n");

1886  -
EINVAL
;

1889 if(
	`check_chdev_lim™
(
tcd
, 
¬g
)){

1890 
	`dbg
("no more„esource!\n");

1891  -
EINVAL
;

1894 
dœ
 = 
	`g‘_dœ
(
tcd
, 
™
);

1895 if(
dœ
 =ğ
NULL
){

1896 
	`dbg
("get dir failed\n");

1897  -
EEXIST
;

1899 
»t
 = 
	`do_ü—‹_£rviû_dev
(
tcd
, 
¬g
,
dœ
);

1900 if(
»t
)

1901 
	`tw_»move_dœ
(
dœ
);

1902  
»t
;

1907 
	`tc_driv”_š¡ªt_»move
(
tw_ch_deviû
 *
tcd
, 
tw_£rviû_deviû
 *
tsd
,
tw_£rviû_driv”
 *
driv
, 
cmd_¬g
 *
¬g
)

1909 
tsd_driv”_İ”©iÚs
 *
tsdr
;

1910 
tw_dev_bË_id
 *
driv_bË_id
;

1912 if(!
driv
){

1913 
	`´štk
("NULL…oš‹r--->š %s\n",
__FUNCTION__
);

1916 
driv_bË_id
 = (
tw_dev_bË_id
 *)&
driv
->
deviû_id
;

1917 if(!
driv_bË_id
->
İs
){

1918 
	`dbg
("driver with‚o ops!\n");

1921 
tsdr
 = (
tsd_driv”_İ”©iÚs
 *)
driv_bË_id
->
İs
;

1922 if(!
tsdr
->
»move
){

1923 
	`dbg
("driver with‚o„emove function!\n");

1926 
tsdr
->
	`»move
(
tcd
,
tsd
,
driv_bË_id
->
·¿
,
¬g
);

1931 
tw_dev_bË_id
 *
	`fšd_tc_£rdriv_äom_tcd
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
)

1933 
•obj_t
 
•
 = {0};

1935 
	`•obj_£t
(&
•
,&
tcd
->
•obj
);

1936 
•
.
ty³
 = 
¬g
->type;

1937 
•
.
func_id
 = (
¬g
->
¡»am
 << 16è|‡rg->
®gÜ™hm
;

1939 
	`make_£rviû_key
((
•key_t
 *)&
•
.
key
,
tcd
,
¬g
);

1942  
	`lookup_tcdev_be_id
(&
•
);

1948 
	`do_»Ëa£_£rviû_deviû
(
tw_£rviû_deviû
 *
tsd
,*
d©a
)

1950 
kobjeù
 *
k
;

1951 
tw_ch_deviû
 *
t
;

1952 
li¡_h—d
 *
p
,*
tmp
;

1953 
cmd_li¡
 *
ş
;

1954 
cmd_¬g
 *
¬g
 = (cmd_¬g *)
d©a
;

1957 
tc_Œaû
;

1958 
	`´štk
("@@@@@@@@@@ty³[%d],cix[%lu],®go[%d],¡»am[%d]\n",
¬g
->
ty³
,¬g->
chªÃl_idx
,¬g->
®gÜ™hm
,¬g->
¡»am
);

1960 
k
 = 
tsd
->
dev
.
kobj
.
·»Á
;

1961 
	`cdev_d–
(
tsd
->
cdev
);

1962 
	`kä“
(
tsd
->
cdev
);

1963 
	`deviû_uÄegi¡”
(&
tsd
->
dev
);

1965 
	`put_ä“_mšÜ
(
tsd
->
mšÜ
,tsd->
ty³
 + 1);

1966 
t
 = 
tsd
->
±cd
;

1967 if(
d©a
){

1968 if(
	`li¡_em±y
(&
t
->
tsd_li¡
[
tsd
->
ty³
])){

1970 
	`tw_»move_dœ
(
k
);

1971 
t
->
dœs
[
tsd
->
ty³
] = 
NULL
;

1973 
	`li¡_fÜ_—ch_§ã
(
p
, 
tmp
, &
ş_h—d
){

1974 
ş
 = 
	`cÚš”_of
(
p
, 
cmd_li¡
, 
node
);

1975 if(
	`cmd_equ®
(&
ş
->
¬g
,
d©a
)){

1976 
	`li¡_d–
(
p
);

1982 if(!
tsd
->
ş—n_up
){

1983 
	`dbg
("you guys have‚o clean_up function„egisted\n");

1986 
tsd
->
	`ş—n_up
(tsd);

1987 
	`´štk
("aá”…”fÜem„–—£ s”viû -deviûsd[0x%8p]\n",
tsd
);

1991 
	`»Ëa£_®l_£rviû_deviû
()

1993 
li¡_h—d
 *
p
,*
q
,*
tmp
,*
tmt
;

1995 
tw_ch_deviû
 * 
tcd
 = 
NULL
;

1996 
tw_£rviû_deviû
 *
tsd
 = 
NULL
;

1997 
idx
 = 0;

1998 
kobjeù
 *
k
;

2000 
	`LIST_HEAD
(
rm_li¡
);

2001 
	`INIT_LIST_HEAD
(&
rm_li¡
);

2003 
	`mu‹x_lock
(&
mu‹x_chdev
);

2004 
	`li¡_fÜ_—ch
(
p
,&
tw_chdev
){

2005 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

2006 
idx
=0; idx < 
MAX_SERVICE_NR
-1; idx++){

2007 
q
 = &
tcd
->
tsd_li¡
[
idx
];

2008 if(
	`li¡_em±y
(
q
))

2010 
	`li¡_fÜ_—ch_§ã
(
tmp
,
tmt
,
q
){

2011 
	`li¡_move_
(
tmp
,&
rm_li¡
);

2015 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2018 
	`li¡_fÜ_—ch_§ã
(
p
, 
tmp
, &
rm_li¡
){

2020 
	`li¡_d–
(
p
);

2021 
tsd
 = 
	`li¡_’Œy
(
p
, 
tw_£rviû_deviû
, 
li¡
);

2022 
	`do_»Ëa£_£rviû_deviû
(
tsd
,
NULL
);

2029 if(!
	`li¡_em±y
(&
rm_li¡
))

2030 
	`´štk
("BUG: hav£rviû_dev†eáed! %s\n",
__FUNCTION__
);

2032 
	`li¡_fÜ_—ch_§ã
(
p
,
tmp
,&
ş_h—d
){

2033 
	`li¡_d–
(
p
);

2036 
	`mu‹x_lock
(&
mu‹x_chdev
);

2037 
	`li¡_fÜ_—ch
(
p
,&
tw_chdev
){

2038 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

2039 
idx
=0; idx < 
MAX_SERVICE_NR
-1; idx++){

2041 
k
 = 
tcd
->
dœs
[
idx
];

2043 if(
k
){

2045 
	`tw_»move_dœ
(
k
);

2049 
tcd
->
dœs
[
idx
] = 
NULL
;

2052 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2057 
	`»Ëa£_®l_£rviû_deviû_ext
()

2059 
li¡_h—d
 *
p
,*
q
,*
tmp
;

2061 
tw_ch_deviû
 * 
tcd
 = 
NULL
;

2063 
idx
 = 0;

2064 
kobjeù
 *
k
;

2065 
cmd_li¡
 *
ş
;

2067 
	`mu‹x_lock
(&
mu‹x_chdev
);

2068 
	`li¡_fÜ_—ch
(
p
,&
tw_chdev
){

2069 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

2070 
	`li¡_fÜ_—ch_§ã
(
q
,
tmp
,&
ş_h—d
){

2072 
ş
 = 
	`cÚš”_of
(
q
,
cmd_li¡
,
node
);

2073 if(
ş
->
tcd
 ==cd){

2074 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2075 
	`»Ëa£_£rviû_deviû
(
ş
->
tcd
,(*)&ş->
¬g
);

2076 
	`mu‹x_lock
(&
mu‹x_chdev
);

2080 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2108 
	`»Ëa£_£rviû_deviû
(
tw_ch_deviû
 *
tcd
, *
d©a
)

2110 
cmd_¬g
 *
¬g
 = (cmd_¬g *)
d©a
;

2111 
majÜ
;

2112 
•key_t
 
Ãw_key
 = {0};

2113 
tw_£rviû_deviû
 *
tmp
;

2114 
li¡_h—d
 *
p
,*
h—d
;

2115 
ty³
 = 
¬g
->type -1;

2116 
tw_dev_bË_id
 *
bË_id
;

2118 if(
ty³
 < 0){

2119 
	`´štk
("BUG:ƒ¼Üy³ iÀ% \n", 
__FUNCTION__
);

2122 
tc_Œaû
;

2123 
	`mu‹x_lock
(&
mu‹x_chdev
);

2124 
majÜ
 = 
ty³
 + 
TW_SERVICE_BASE_MAJOR
;

2126 
	`make_£rviû_key
((
•key_t
 *)&
Ãw_key
,
tcd
,
¬g
);

2127 
	`´štk
("ty³ =%d\n",
ty³
);

2128 
h—d
 = &
tcd
->
tsd_li¡
[
ty³
];

2129 
	`li¡_fÜ_—ch
(
p
,
h—d
)

2133 
	`´štk
("&&&&&&&&&\n");

2134 
tmp
 = 
	`cÚš”_of
(
p
,
tw_£rviû_deviû
,
li¡
);

2135 
	`dbg_•obj_´št
(&
tmp
->
•obj
);

2136 if(
	`•key_equ®_w™hout_phyid
(&
tmp
->
•obj
.
key
,&
Ãw_key
))

2137 
fšd
;

2139 
	`´štk
("@@@@@@@@@@š % ---->šv®id…¬am‘”! \n",
__FUNCTION__
);

2140 
	`´štk
("@@@@@@@@@@ty³[%d],cix[%lu],®go[%d],¡»am[%d]\n",
¬g
->
ty³
,¬g->
chªÃl_idx
,¬g->
®gÜ™hm
,¬g->
¡»am
);

2141 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2143 
fšd
:

2144 
	`li¡_d–
(&
tmp
->
li¡
);

2145 
	`mu‹x_uÆock
(&
mu‹x_chdev
);

2147 
bË_id
 = 
	`fšd_tc_£rdriv_äom_tcd
(
tcd
,
¬g
);

2148 if(
bË_id
)

2149 
	`tc_driv”_š¡ªt_»move
(
tcd
,
tmp
,
bË_id
->
´iv
,
¬g
);

2151 
	`dbg
("can‚ot find driver inc_dev†ist\n");

2153 
	`do_»Ëa£_£rviû_deviû
(
tmp
,
d©a
);

2184 
	`»gi¡”_tc_deviû
(
tw_dev_bË_id
 *
Ãw
)

2186 
»t
 = 0;

2187 
li¡_h—d
 *
p
 = &
tw_tc_dev
;

2188 
tw_dev_bË_id
 *
tb
,*
´ev
;

2191 
	`mu‹x_lock
(&
mu‹x_tc_dev
);

2192 if(
p
->
Ãxt
 =ğ&
tw_tc_dev
 &&…->
´ev
 == &tw_tc_dev){

2193 
	`li¡_add_
(&
Ãw
->
li¡
,&
tw_tc_dev
);

2194 
»t
 = 0;

2195 
out
;

2198 
p
 =…->
Ãxt
;

2199 if(
p
 =ğ&
tw_tc_dev
){

2200 
	`li¡_add_
(&
Ãw
->
li¡
,&
tw_tc_dev
);

2201 
»t
 = 0;

2202 
out
;

2205 ;
p
 !ğ&
tw_tc_dev
; 
´ev
 = 
tb
,… =…->
Ãxt
)

2207 
tb
 = 
	`cÚš”_of
(
p
,
tw_dev_bË_id
,
li¡
);

2208 if(
tb
->
tid
->
•obj
.
v’dÜ_id
 !ğ
Ãw
->tid->•obj.v’dÜ_id ||b->tid->•obj.
bus_id
 !=‚ew->tid->epobj.bus_id

2209 || 
tb
->
tid
->
•obj
.
ch_id
 !ğ
Ãw
->tid->•obj.ch_id ||b->tid->•obj.
func_id
 !=‚ew->tid->epobj.func_id)

2211 if(
tb
->
tid
->
v”siÚ
 !ğ
Ãw
->tid->version){

2212 
	`´štk
("alreadyƒxist!\n");

2213 
»t
 = -
EEXIST
;

2214 
out
;

2216 if(
Ãw
->
tid
->
v”siÚ
 > 
tb
->tid->version){

2217 
	`li¡_add
(&
Ãw
->
li¡
,&
´ev
->list);

2218 
»t
 = 0;

2219 
out
;

2222 
	`dbg_•obj_´št
(&
Ãw
->
tid
->
•obj
);

2223 
	`li¡_add
(&
Ãw
->
li¡
,&
´ev
->list);

2224 
out
:

2225 
	`mu‹x_uÆock
(&
mu‹x_tc_dev
);

2226  
»t
;

2232 
	`uÄegi¡”_®l_tc_deviû
()

2234 
li¡_h—d
 *
_p
,*
tmp
;

2235 
tw_dev_bË_id
 *
dev
;

2237 
	`LIST_HEAD
(
»move_li¡
);

2238 
	`INIT_LIST_HEAD
(&
»move_li¡
);

2240 
	`mu‹x_lock
(&
mu‹x_tc_dev
);

2241 !
	`li¡_em±y
(&
tw_tc_dev
)){

2242 
	`li¡_fÜ_—ch_§ã
(
_p
, 
tmp
, &
tw_tc_dev
){

2244 
	`li¡_move_
(
_p
,&
»move_li¡
);

2247 
	`mu‹x_uÆock
(&
mu‹x_tc_dev
);

2250 
	`li¡_fÜ_—ch_§ã
(
_p
, 
tmp
, &
»move_li¡
){

2252 
	`li¡_d–
(
_p
);

2253 
dev
 = 
	`li¡_’Œy
(
_p
, 
tw_dev_bË_id
, 
li¡
);

2254 
	`kä“
(
dev
);

2256 if(!
	`li¡_em±y
(&
»move_li¡
))

2257 
	`´štk
("BUG: havec_dev†efted\n");

2264 
	`uÄegi¡”_tc_deviû
(
tw_dev_bË_id
 *
tb
)

2266 
	`mu‹x_lock
(&
mu‹x_tc_dev
);

2267 
	`li¡_d–
(&
tb
->
li¡
);

2268 
	`mu‹x_uÆock
(&
mu‹x_tc_dev
);

2269 
	`kä“
(
tb
);

2275 
	`tc_driv”_m©ch
(
tw_dev_bË_id
 * 
driv
,tw_dev_bË_id * 
dev
)

2277 if(
	`•obj_euq®
(&
driv
->
tid
->
•obj
,&
dev
->tid->epobj))

2285 
	`»gi¡”_tc_driv”
(
tw_£rviû_driv”
 * 
driv
)

2287 
»t
= 0;

2288 
li¡_h—d
 *
_p
;

2289 
tw_dev_bË_id
 *
dev
;

2291 
dev
 = &
driv
->
deviû_id
;

2292 
	`dbg_•obj_´št
(&
dev
->
tid
->
•obj
);

2293 
driv
->
driv”
.
bus
 = &
tw_vœtu®_bus
;

2294 
»t
 = 
	`driv”_»gi¡”
(&
driv
->
driv”
);

2295 if(
»t
)

2296  
»t
;

2297 
	`mu‹x_lock
(&
mu‹x_tc_drv
);

2298 
	`li¡_add_
(&
driv
->
li¡
,&
tw_tc_drv
);

2299 
	`mu‹x_uÆock
(&
mu‹x_tc_drv
);

2301 
	`li¡_fÜ_—ch
(
_p
, &
tw_tc_dev
){

2302 
dev
 = 
	`li¡_’Œy
(
_p
, 
tw_dev_bË_id
, 
li¡
);

2303 ià(
	`tc_driv”_m©ch
(&
driv
->
deviû_id
,
dev
)){

2304 
	`´štk
("attached!\n");

2305 
dev
->
´iv
 = 
driv
;

2309  
»t
;

2315 
	`uÄegi¡”_tc_driv”
(
tw_£rviû_driv”
 *
driv
)

2317 
li¡_h—d
 *
_p
;

2318 
tw_dev_bË_id
 *
dev
;

2320 
	`li¡_fÜ_—ch
(
_p
, &
tw_tc_dev
){

2321 
dev
 = 
	`li¡_’Œy
(
_p
, 
tw_dev_bË_id
, 
li¡
);

2322 ià(
	`tc_driv”_m©ch
(&
driv
->
deviû_id
,
dev
)){

2323 
dev
->
´iv
 = 
NULL
;

2327 
	`driv”_uÄegi¡”
(&
driv
->
driv”
);

2328 
	`mu‹x_lock
(&
mu‹x_tc_drv
);

2329 
	`li¡_d–
(&
driv
->
li¡
);

2330 
	`mu‹x_uÆock
(&
mu‹x_tc_drv
);

2331 
	`´štk
("%s\n",
__FUNCTION__
);

2339 
	`EXPORT_SYMBOL
(
»gi¡”_ch_deviû
);

2340 
	`EXPORT_SYMBOL
(
uÄegi¡”_ch_deviû
);

2342 
	`EXPORT_SYMBOL
(
»gi¡”_ch_driv”
);

2343 
	`EXPORT_SYMBOL
(
uÄegi¡”_ch_driv”
);

2345 
	`EXPORT_SYMBOL
(
ü—‹_£rviû_deviû
);

2346 
	`EXPORT_SYMBOL
(
»Ëa£_£rviû_deviû
);

2348 
	`EXPORT_SYMBOL
(
»gi¡”_tc_deviû
);

2349 
	`EXPORT_SYMBOL
(
uÄegi¡”_tc_deviû
);

2351 
	`EXPORT_SYMBOL
(
»gi¡”_tc_driv”
);

2352 
	`EXPORT_SYMBOL
(
uÄegi¡”_tc_driv”
);

2354 
	`EXPORT_SYMBOL
(
fšd_ch_dev
);

2355 
	`EXPORT_SYMBOL
(
fšd_£rviû_dev
);

2357 
	`EXPORT_SYMBOL
(
tc_chdev_®loc
);

2358 
	`EXPORT_SYMBOL
(
tc_chdev_ä“
);

2365 
	`»que¡_devno_»sourû
()

2367 
»t
 = -1,
i
;

2369 
»t
 = 
	`š™_nfm_b™m­
();

2370 if(-1 =ğ
»t
)

2372 
i
=0; i<
MAX_SERVICE_NR
; i++)

2374 
»t
 = 
	`»gi¡”_chrdev_»giÚ
(
	`MKDEV
(
TW_CHIP_MAJOR
+
i
,0), 
MAX_MINOR_NR
, 
tc_dev_Çme
[i]);

2375 ià(
»t
 < 0){

2376 
	`dbg
(
KERN_WARNING
 "uÇbËØg‘ majÜ %d\n",
TW_CHIP_MAJOR
);

2392 
	`ä“_devno_»sourû
()

2394 
i
;

2396 
	`ä“_nfm_b™m­
();

2397 
i
=0; i<
MAX_SERVICE_NR
; i++)

2398 
	`uÄegi¡”_chrdev_»giÚ
(
	`MKDEV
(
TW_CHIP_MAJOR
+
i
,0), 
MAX_MINOR_NR
);

2405 
	`tc_h—d”_bufãr_š™
(
tc_hb_poŞ
 *
poŞ
,
tc_h—d”_buf
 *
thb
, 
šdex
)

2407 
tcb_node_t
 *
node
;

2408 * 
ı
 = 
NULL
;

2410 if(!
poŞ
 || !
thb
){

2411 
	`´štk
("šv®id…¬¨š %s\n",
__FUNCTION__
);

2412  
EINVAL
;

2414 
	`©omic_£t
(&
thb
->
»f
, 0);

2415 
node
 = &
thb
->node;

2416 
node
->
İ
 = &
tcb_node_İ
;

2417 
node
->
İ
->
	`š™
(node);

2418 
node
->
İ
->
	`£t_´iv
Òode, 
thb
);

2419 
	`¥š_lock_š™
(&
thb
->
lock
);

2420 
thb
->
id
 = 
šdex
;

2421 
thb
->
un™_size
ğ
PAGE_SIZE
;

2423 
ı
 = (*)
poŞ
->
p
;

2424 
thb
->
d©a
 = (*)(
ı
 + (thb->
un™_size
 * 
šdex
));

2425 
	`mem£t
((*)
thb
->
d©a
,0,thb->
un™_size
);

2432 
	`tc_h—d”_bufãr_»Ëa£
(
tc_hb_poŞ
 *
poŞ
,
tc_h—d”_buf
 *
thb
)

2434 
tc_h—d”_buf
 * 
tb
;

2435 
tcb_node_t
 * 
node
;

2436 
æags
;

2438 if(
thb
){

2439 
tb
 = 
thb
;

2440 if(!
poŞ
)

2441 
poŞ
 = 
tb
->pool;

2443 
	`¥š_lock_œq§ve
(&
tb
->
lock
, 
æags
);

2444 if(
	`©omic_»ad
(&
tb
->
»f
) > 1){

2445 
	`©omic_dec
(&
tb
->
»f
);

2451 
node
 = &
tb
->node;

2452 if(
node
->
İ
){

2454 
node
->
İ
->
	`»Ëa£
Òode,&
poŞ
->
Å
);

2459 
	`¥š_uÆock_œq»¡Üe
(&
tb
->
lock
, 
æags
);

2463 
tc_hb_İ”©iÚ
 
tc_hb_İ
 =

2465 .
š™
 = 
tc_h—d”_bufãr_š™
,

2466 .
»Ëa£
 = 
tc_h—d”_bufãr_»Ëa£
,

2470 
	`tc_ü—‹_h—d”_bufãr_poŞ
(
Ën
)

2472 
»t
 = 0,
idx
;

2473 
tcb_node_poŞ_t
 *
Å
;

2474 
tc_h—d”_buf
 *
thb
;

2476 
thb_poŞ
->
Üd”
 = 
	`g‘_Üd”
(
Ën
);

2477 
thb_poŞ
->
p
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,thb_poŞ->
Üd”
);

2478 if(!
thb_poŞ
->
p
){

2479 
	`dbg
("no mem forc header buffer…ool!\n");

2480 
»t
 = -
ENOMEM
;

2481 
”r
;

2483 
thb_poŞ
->
Ä
 = 
Ën
/
TC_HEADER_BUFFER_LEN
;

2484 
Å
 = &
thb_poŞ
->np;

2485 
Å
->
İ
 = &
tcb_node_poŞ_İ
;

2487 
thb_poŞ
->
bufs
 = 
	`kz®loc
((
tc_h—d”_buf
è*hb_poŞ->
Ä
, 
GFP_KERNEL
);

2488 if(!
thb_poŞ
->
bufs
){

2489 
»t
 = -
ENOMEM
;

2490 
”r
;

2492 
Å
->
İ
->
	`š™
Òp,
thb_poŞ
->
Ä
);

2493 
thb
 = 
thb_poŞ
->
bufs
;

2494 
idx
 = 0; idx < 
thb_poŞ
->
Ä
; idx++,
thb
++){

2496 
thb
->
İ
 = &
tc_hb_İ
;

2497 
thb
->
poŞ
 = 
thb_poŞ
;

2498 
thb
->
İ
->
	`š™
(
thb_poŞ
,thb,
idx
);

2499 
thb
->
İ
->
	`»Ëa£
(
thb_poŞ
,thb);

2501  
»t
;

2502 
”r
:

2503 if(
thb_poŞ
->
bufs
)

2504 
	`kä“
(
thb_poŞ
->
bufs
);

2505 if(
thb_poŞ
->
p
)

2506 
	`ä“_·ges
(()
thb_poŞ
->
p
,thb_poŞ->
Üd”
);

2507  
»t
;

2512 
	`tc_de¡Üy_h—d”_bufãr_poŞ
(
tc_hb_poŞ
 *

)

2514 
tcb_node_poŞ_t
 *
²
;

2516 if(!

)

2519 
²
 = &

->
Å
;

2520 if(
²
->
İ
){

2521 
²
->
İ
->
	`»Ëa£
(pn);

2523 if(

->
bufs
)

2524 
	`kä“
(

->
bufs
);

2525 if(

->
p
)

2526 
	`ä“_·ges
(()

->
p
,->
Üd”
);

2527 

->
Ä
 = 0;

2528 

->
p
 =p->
bufs
 =p->
İ
 = 
NULL
;

2532 
	`tc_g‘_h—d”_buf
(
tc_hb_poŞ
 *

, 
tc_h—d”_buf
 **
thb
)

2534 
tcb_node_poŞ_t
 *
Šp
;

2535 
tcb_node_t
 *
Š
;

2537 if(!

 || !
thb
){

2538 
	`´štk
("šv®id…¬am‘” iÀ%s!\n",
__FUNCTION__
);

2541 
Šp
 = &

->
Å
;

2542 *
thb
 = 
NULL
;

2543 if(!
Šp
->
İ
){

2544 
	`´štk
("pool‚ode has‚o op!\n");

2547 
Šp
->
İ
->
	`g‘
ÑÅ,&
Š
);

2548 if(
Š
){

2549 *
thb
 = 
	`g‘_thb_äom_node
(
Š
);

2550 
	`©omic_šc
(&((*
thb
)->
»f
));

2554 *
thb
 = 
NULL
;

2557 
	`tc_Œy_g‘_h—d”_buf
(
tc_hb_poŞ
 *

, 
tc_h—d”_buf
 **
thb
)

2559 
tcb_node_poŞ_t
 *
Šp
;

2560 
tcb_node_t
 *
Š
;

2562 if(!

 || !
thb
){

2563 
	`´štk
("šv®id…¬am‘” iÀ%s!\n",
__FUNCTION__
);

2566 
Šp
 = &

->
Å
;

2567 *
thb
 = 
NULL
;

2568 if(!
Šp
->
İ
){

2569 
	`´štk
("pool‚ode has‚o op!\n");

2572 
Šp
->
İ
->
	`Œy_g‘
ÑÅ,&
Š
);

2573 if(
Š
){

2574 *
thb
 = 
	`g‘_thb_äom_node
(
Š
);

2575 
	`©omic_šc
(&((*
thb
)->
»f
));

2579 *
thb
 = 
NULL
;

2583 
	`tc_put_h—d”_buf
(
tc_hb_poŞ
 *

, 
tc_h—d”_buf
 *
thb
)

2585 
tcb_node_poŞ_t
 *
Šp
;

2587 if(!

 || !
thb
){

2588 
	`´štk
("šv®id…¬am‘” iÀ%s!\n",
__FUNCTION__
);

2591 
Šp
 = &

->
Å
;

2592 if(!
Šp
->
İ
){

2593 
	`´štk
("pool‚ode has‚o op!\n");

2596 
Šp
->
İ
->
	`put
ÑÅ,&
thb
->
node
);

2599 
	`tc_g‘_hb_poŞ_’Œy_numb”
(
tc_hb_poŞ
 *

)

2601 
tcb_node_poŞ_t
 *
Šp
;

2603 if(!

){

2604 
	`´štk
("šv®id…¬am‘” iÀ%s!\n",
__FUNCTION__
);

2605  
EINVAL
;

2607 
Šp
 = &

->
Å
;

2608 if(!
Šp
->
İ
){

2609 
	`´štk
("pool‚ode has‚o op!\n");

2610  
EINVAL
;

2612  
Šp
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(tnp);

2616 
tc_hb_poŞ_İ”©iÚ
 
thb_İ
 =

2618 .
ü—‹
 = 
tc_ü—‹_h—d”_bufãr_poŞ
,

2619 .
de¡Üy
 = 
tc_de¡Üy_h—d”_bufãr_poŞ
,

2620 .
g‘_h—d”_buf
 = 
tc_g‘_h—d”_buf
,

2621 .
Œy_g‘_h—d”_buf
 = 
tc_Œy_g‘_h—d”_buf
,

2622 .
put_h—d”_buf
 = 
tc_put_h—d”_buf
,

2623 .
g‘_hb_poŞ_’Œy_numb”
 = 
tc_g‘_hb_poŞ_’Œy_numb”
,

2626 
	`£tup_thb_poŞ
()

2628 
»t
 = 0;

2630 
thb_poŞ
 = 
	`kz®loc
((*thb_poŞ),
GFP_KERNEL
);

2631 if(!
thb_poŞ
)

2632  -
ENOMEM
;

2634 
thb_poŞ
->
İ
 = &
thb_İ
;

2635 
»t
 = 
thb_poŞ
->
İ
->
	`ü—‹
(
TC_HEADER_BUFFER_POOL_LEN
);

2636  
»t
;

2639 
	`ş—nup_thb_poŞ
(
tc_hb_poŞ
 *

)

2641 if(

 =ğ
NULL
){

2642 
	`´štk
("šv®id…¬am‘”! iÀ%s\n",
__FUNCTION__
);

2646 if(

->
İ
 !ğ
NULL
)

2647 

->
İ
->
	`de¡Üy
(tp);

2649 
	`tc_de¡Üy_h—d”_bufãr_poŞ
(

);

2651 
	`kä“
(

);

2655  
	`tw_cÜe_š™
()

2657 
»t
;

2659 
	`INIT_LIST_HEAD
(&
tw_chdev
);

2660 
	`INIT_LIST_HEAD
(&
tw_chdrv
);

2661 
	`INIT_LIST_HEAD
(&
tw_tc_dev
);

2662 
	`INIT_LIST_HEAD
(&
tw_tc_drv
);

2663 
»t
 = 
	`bus_»gi¡”
(&
tw_vœtu®_bus
);

2664 if(
»t
){

2665 
	`dbg
("tw_virtual bus„egister failed!\n");

2666  
»t
;

2669 if(
	`»que¡_devno_»sourû
())

2670 
”r_devno
;

2671 if(
	`£tup_thb_poŞ
())

2672 
”r_hb_poŞ
;

2675 
kroÙ
 = 
	`tw_ü—‹_dœ
("tw–l",
NULL
);

2676 if(
kroÙ
 =ğ
NULL
) {

2677 
	`dbg
("Err: failed in„oot dirwell!\n");

2678 
”r_tw_dœ
;

2691 
”r_tw_dœ
:

2692 
	`tw_»move_dœ
(
kroÙ
);

2693 
”r_hb_poŞ
:

2694 
	`ş—nup_thb_poŞ
(
thb_poŞ
);

2695 
”r_devno
:

2696 
	`ä“_devno_»sourû
();

2697 
	`bus_uÄegi¡”
(&
tw_vœtu®_bus
);

2698  
»t
;

2702  
	`tw_cÜe_ex™
()

2704 
	`tw_»move_dœ
(
kroÙ
);

2706 
	`ş—nup_thb_poŞ
(
thb_poŞ
);

2707 
	`ä“_devno_»sourû
();

2709 
	`bus_uÄegi¡”
(&
tw_vœtu®_bus
);

2710 
	`´štk
("all‡re„eleased!\n");

	@../../tw5864/device_layer/tc_audio_de.c

1 
	~<tw5864/tc_commÚ.h
>

3 
tw_ch_audio_·¿m_my
 
	gdef_audio_·rm_de
 = {

4 .
i_b™_wide
 = 
TW_AUDIO_16BIT
,

5 .
	gi_§m¶e_¿‹
 = 
TW_AUDIO_8K
,

6 .
	ge_audio_ty³
 = 
TW_AUDIO_PCM
,

10 
	$de_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
,
tc_bufãr
 *
tc
)

12 
tc_bufãr_k”n
 *
tck
;

13 
tw_audio_de
 * 
tde
 = (tw_audio_d*)
´iv
;

14 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
tde
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

15 
tw_audio_·ck‘_queue_t
 *
adpq
;

16 
tw_audio_·ck‘_£ùiÚ_t
 *
as
;

17 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
;

19 
adpq
 = &
driv
->
audio_·ck‘_queue
;

20 
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

22 
tc_Œaû
;

25 
adpq
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(adpq);

26 
	`dbg
("after get consumer!\n");

27 
as
 = 
adpq
->
cu¼_cÚsum”
;

28 if(!
as
){

29 
	`dbg
("\n we get section‚othing!---------------------------------\n");

36 
	`mu‹x_lock
(&
tde
->
tsd
.
queue
->
lock
);

38 
tck
 = 
tq
->
bufs
[tq->
wp
];

40 
tck
->
šdex
 = 
as
->
id
;

41 
tck
->
ty³
 = 
MEM_MMAP
;

42 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

43 
tck
->
i§lign
 = (()
as
->
d©a
 >> 
PAGE_SHIFT
)? 1: 0;

44 
tck
->
off_to_·ge
 = (()
as
->
d©a
) & 0xFFF;

45 
tck
->
¡¬t
 = 
as
->
d©a
;

46 
tck
->
size
 = 
tde
->
tsd
.
queue
->
un™_size
;

47 
	`queue_šc_wp
(
tde
->
tsd
.
queue
);

48 
	`mu‹x_uÆock
(&
tde
->
tsd
.
queue
->
lock
);

55 
	}
}

57 
	$de_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

59 
»t
 = 0;

60 
tw_audio_de
 * 
tde
 = (tw_audio_d*)
´iv
;

61 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
tde
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

62 
tw_audio_·ck‘_queue_t
 *
adpq
;

63 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
;

65 
tc_Œaû
;

66 
adpq
 = &
driv
->
audio_·ck‘_queue
;

67 
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

68 
adpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×dpq, 
adpoŞ
);

69  
»t
;

70 
	}
}

72 
tc_queue_İs
 
	gde_queue_İs
 = {

73 .
buf_´•¬e
 = 
de_buf_´•¬e
,

74 .
	gbuf_»Ëa£
 = 
de_buf_»Ëa£
,

136 
tw_audio_driv”_t
 * 
	$lookup_drive_š¡ªû_de
(
tw_£rviû_deviû
 *
tsd
)

138 
tw_audio_driv”_t
 *
p
 = 
tsd
->
´iv©e_d©a
;

139 
ld
 = 
	`g‘_phchª_id_äom_•obj
(&
tsd
->
•obj
);

140 
uËn
 = (
tw_audio_driv”_t
);

141 * 
q
 = (*)&
p
[
ld
];

142 
q
 = q - 17*
uËn
;

143 
	`´štk
("% ld = %lu, decod”‡dd = %°fœ¡ƒncod”‡dd should b%p\n",
__FUNCTION__
,
ld
,&
p
[ld],
q
);

145  &
p
[
ld
];

147 
	}
}

150 
	$tde_ş—nup
(*
¬g
)

152 
tw_audio_de
 *
tde
 = (tw_audio_d*)
¬g
;

154 
tc_Œaû
;

155 
	`tc_queue_»Ëa£
(
tde
->
tsd
.
queue
);

156 
	`kä“
(
tde
);

157 
	}
}

161 
	$audi_de_pŞlšg
(*
p
)

163 
tw_audio_de
 *
tde
 = (tw_audio_d*)
p
;

164 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
tde
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

165 
tw_audio_·ck‘_queue_t
 *
adpq
 = &
driv
->
audio_·ck‘_queue
;

166 
Ä
 = 
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq);

168 if(
Ä
)

170 
	`wake_up
(&
tde
->
wa™_pŞl
);

177 
	}
}

180 
	$audio_de_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

182 
»t
 = 0;

183 
ed_tcb_t
 *
aded
;

184 
tw_audio_de
 *
tde
 = 
	`cÚš”_of
(
tsd
,tw_audio_de,tsd);

186 
tc_Œaû
;

188 if(!
tde
)

189  -
EINVAL
;

190 if(
f
->
´iv©e_d©a
){

191 
	`dbg
("have‡lready opened!\n");

195 if(!
tde
->
tsd
.
³d
){

196 
	`dbg
("audio decoder has‚o driver‡ttached!\n");

197 
»t
 = -1;

198  
»t
;

202 
tde
->
tim”_id
 = 
	`AddFÜFœeTim”Job
(20,
audi_de_pŞlšg
,tde);

203 if(
tde
->
tim”_id
 =ğ
ADDJOBERROR
){

204 
	`´štk
("š % addim” job faed!\n",
__FUNCTION__
);

205  
»t
;

207 
aded
 = 
tde
->
tsd
.
³d
;

208 
»t
 = 
aded
->
İ
->
	`İ’
(aded);

209 if(
»t
 !ğ
TW_OK
){

210 
	`´štk
("š % audiØdecod” driv” o³Àçed!\n",
__FUNCTION__
);

211  
»t
;

213 
f
->
´iv©e_d©a
 = 
tde
;

215  
»t
;

216 
	}
}

220 
ssize_t
 
	$audio_de_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

223 
	}
}

226 
	$w©ch_time¡amp
(
time
)

228 
Ï¡
 = 0, 
út
 = 0,
d–
 = 0;

230 
út
 = 
time
;

231 
d–
 = (0x10000 + 
út
 - 
Ï¡
)&0xffff;

232 if(
d–
 > 100 && 
Ï¡
 != 0){

233 
	`dbg
("% lÚgimha nØÃw f¿me!\n",
__FUNCTION__
);

235 
Ï¡
 = 
út
;

236 
	}
}

239 
ssize_t
 
	$´oûss_logic_äame
(
tw_audio_·ck‘_queue_t
 *
adpq
, 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
, 
uËn
, 
’
,

240 cÚ¡ 
__u£r
 *
buff
, 
size_t
 * 
off£t
, 
loff_t
 *
lof
,
time_¡•
 )

242 
»t
 = 0,
»maš
 = 
’
;

243 
size_t
 
Ï¡_»maš
;

244 
tw_audio_·ck‘_£ùiÚ_t
 *
as
;

245 
iof
 = ()(*
off£t
 - 
TW_TOTAL_AUDIO_FRAMEHEADER_LEN
);

246 
tw_äame_h—d”_t
 *
ph
 = (tw_äame_h—d”_ˆ*)&
buff
[
iof
];

247 
tw_audio_äame_·d_t
 *
·d
 = (tw_audio_äame_·d_ˆ*)
ph
->pad;

249 
icouÁ
 =0;

252 
»maš
 > 0){

253 
icouÁ
++;

254 if((
as
 = 
adpq
->
cu¼_´oduûr
)){

255 ifĞ
·d
->
§m¶e_¿‹
 !ğ
as
->§m¶e_¿‹ ||…ad->
b™_wide
 !ğas->b™_wid||…ad->
ty³
 !=‡s->type){

256 
as
->
·ylßd_Ën
 = (
»maš
 > 
uËn
)? ulen:remain;

257 if(
as
->
·ylßd_Ën
 < 
uËn
è
	`´štk
("one†ogic frame isoo small!\n");

258 
as
->
§m¶e_¿‹
 = 
·d
->sample_rate;

259 
as
->
ty³
 = 
·d
->type;

260 
as
->
b™_wide
 = 
·d
->bit_wide;

261 
as
->
time¡amp
 = 
ph
->
timeSmp
;

262 
	`w©ch_time¡amp
(
ph
->
timeSmp
);

263 
	`cİy_äom_u£r
(
as
->
d©a
,&
buff
[*
off£t
],as->
·ylßd_Ën
);

264 if(
as
->
·ylßd_Ën
 < 
uËn
)

265 
d—l_
;

266 
adpq
->
İ
->
	`put_cu¼_´oduûr_što_queue
(adpq);

267 *
off£t
 +ğ
as
->
·ylßd_Ën
;

268 
»maš
 -ğ
as
->
·ylßd_Ën
;

272 
	`cİy_äom_u£r
(&
as
->
d©a
[
Ï¡_»maš
],&
buff
[*
off£t
],
uËn
 -last_remain);

273 
as
->
·ylßd_Ën
 = 
uËn
;

274 
adpq
->
İ
->
	`put_cu¼_´oduûr_što_queue
(adpq);

275 *
off£t
 +ğ
uËn
 -
Ï¡_»maš
;

276 
»maš
 -ğ
uËn
 -
Ï¡_»maš
;

281 
adpq
->
İ
->
	`g‘_cu¼_´oduûr_äom_poŞ
×dpq,
adpoŞ
);

282 
as
 = 
adpq
->
cu¼_´oduûr
;

283 if(
as
){

284 
as
->
·ylßd_Ën
 = (
»maš
 > 
uËn
)? ulen:remain;

285 
as
->
§m¶e_¿‹
 = 
·d
->sample_rate;

286 
as
->
ty³
 = 
·d
->type;

287 
as
->
b™_wide
 = 
·d
->bit_wide;

288 
as
->
time¡amp
 = 
ph
->
timeSmp
;

289 
	`w©ch_time¡amp
(
ph
->
timeSmp
);

290 
	`cİy_äom_u£r
(
as
->
d©a
,&
buff
[*
off£t
],as->
·ylßd_Ën
);

291 if(
as
->
·ylßd_Ën
 < 
uËn
){

292 
d—l_
;

294 
adpq
->
İ
->
	`put_cu¼_´oduûr_što_queue
(adpq);

295 *
off£t
 +ğ
as
->
·ylßd_Ën
;

296 
»maš
 -ğ
as
->
·ylßd_Ën
;

300 
	`dbg
("can‚ot get section!!!!!!!!!!!!!!!!!!!!!!!!\n");

301 
»t
 = -
ENOMEM
;

302 
çed
;

306 
d—l_
:

307 if(
»maš
)

308 
Ï¡_»maš
 = 
as
->
·ylßd_Ën
;

310 
Ï¡_»maš
 = 0;

313 *
lof
 +ğ*
off£t
;

314 
»t
 = 
’
-
»maš
;

315  
»t
;

316 
çed
:

317  
»t
;

318 
	}
}

322 
ssize_t
 
	$audio_de_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

324 
»t
 = 0;

325 
tÙ®_·yËn
;

326 
tw_audio_de
 *
tde
 = (tw_audio_d*)
f
->
´iv©e_d©a
;

327 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
tde
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

328 
tw_audio_·ck‘_queue_t
 *
adpq
 = &
driv
->
audio_·ck‘_queue
;

329 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

330 
tw_äame_h—d”_t
 *
ph
 = (tw_äame_h—d”_ˆ*)
buff
;

332 
tw_audio_äame_·d_t
 *
·d
 = (tw_audio_äame_·d_ˆ*)
ph
->pad;

334 
size_t
 
off£t
 = 0;

335 
g­
 = 0,
·d_Ä
 = 0;

336 
un™_·yËn
 = 384;

337 
time_d–
 = 20;

339 
	`down
(&
tde
->
£m
);

343 
off£t
 +ğ
TW_TOTAL_AUDIO_FRAMEHEADER_LEN
;

344 #ifdeà
TW_CONFIG_ADD_NAL


345 
tÙ®_·yËn
 = 
·d
->
äame_size
 - (
ext_h264_Çl_b™¡»am_t
);

347 
tÙ®_·yËn
 = 
·d
->
äame_size
;

350 
»t
 = 
	`´oûss_logic_äame
(
adpq
,
adpoŞ
,
un™_·yËn
,
tÙ®_·yËn
,
buff
,&
off£t
,
lof
,
time_d–
);

351 if(
»t
 < 0){

352 
	`up
(&
tde
->
£m
);

353  
»t
;

355 
g­
 = 
tÙ®_·yËn
-
»t
;

356 if(
off£t
 >ğ
couÁ
-3)

358 
·d_Ä
 = (
off£t
 + 
g­
) & 0x3;

359 if(
g­
 < 
un™_·yËn
){

360 if(
off£t
 + 
g­
 + 
·d_Ä
 + 
TW_TOTAL_AUDIO_FRAMEHEADER_LEN
 >ğ
couÁ
)

361 
out
;

362 
ph
 = (
tw_äame_h—d”_t
 *)&
buff
[
off£t
 + 
g­
 + 
·d_Ä
];

363 
off£t
 +ğ
g­
;

364 
off£t
 +ğ
·d_Ä
;

368 
	`´štk
("data wrong format!!!!!!!!!!!!!!!!\n");

369 
	`up
(&
tde
->
£m
);

370  -
EINVAL
;

372 
·d
 = (
tw_audio_äame_·d_t
 *)
ph
->pad;

374 
out
:

375 
	`up
(&
tde
->
£m
);

377  (
ssize_t
)
off£t
;

378 
	}
}

392 
	$audio_de_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

394 
»t
 = 0;

395 
tw_audio_de
 *
tde
 = (tw_audio_d*)
f
->
´iv©e_d©a
;

396 
’dpošt_tcb
 *
ed
;

398 
cmd
)

402 
	`dbg
("Ùh” cmd iÀ%s\n",
__FUNCTION__
);

403 if(!
tde
->
tsd
.
³d
){

404 
	`´štk
("the device has‚o driverƒd!\n");

405 
»t
 = 
EFAULT
;

408 
ed
 = 
tde
->
tsd
.
³d
;

409 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

413  
»t
;

414 
	}
}

418 
	$audio_de_»Ëa£
(
fe
 *
f
)

420 
»t
;

421 
ed_tcb_t
 *
aded
;

422 
tw_audio_de
 *
tde
 = (tw_audio_d*)
f
->
´iv©e_d©a
;

425 
tc_Œaû
;

426 
	`down
(&
tde
->
£m
);

427 
aded
 = 
tde
->
tsd
.
³d
;

428 
»t
 = 
aded
->
İ
->
	`şo£
(aded);

429 
	`D–‘eFÜFœeTim”Job
(
tde
->
tim”_id
);

430 
	`tc_queue_»£t
(
tde
->
tsd
.
queue
);

432 
	`up
(&
tde
->
£m
);

433 
f
->
´iv©e_d©a
 = 
NULL
;

434  
»t
;

435 
	}
}

439 
	$audio_de_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

441 
mask
 = 0;

442 
tw_audio_de
 *
tde
 = (tw_audio_d*)
fe
->
´iv©e_d©a
;

443 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
tde
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

444 
tw_audio_·ck‘_queue_t
 *
adpq
 = &
driv
->
audio_·ck‘_queue
;

446 
	`down
(&
tde
->
£m
);

447 
	`pŞl_wa™
(
fe
,&
tde
->
wa™_pŞl
,
wa™
);

448 if(
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq))

450 
mask
 |ğ
POLLIN
 | 
POLLRDNORM
;

456 
	`up
(&
tde
->
£m
);

457  
mask
;

458 
	}
}

462 
	$audio_de_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

465 
tw_audio_de
 *
tde
;

467 
tde
 = 
	`kz®loc
((*tde),
GFP_KERNEL
);

468 if(
NULL
 =ğ
tde
)

469  -
ENOMEM
;

470 *
tsd
 = &
tde
->tsd;

472 
tde
->
tsd
.
ş—n_up
 = 
tde_ş—nup
;

473 
tde
->
tsd
.
queue
 = 
	`kz®loc
((
tc_queue
),
GFP_KERNEL
);

474 if(!
tde
->
tsd
.
queue
)

475  -
ENOMEM
;

476 
	`tc_queue_š™
(
tde
->
tsd
.
queue
,&
de_queue_İs
,
NULL
,512,10,tde);

477 
tde
->
Çme
 = "tw5864-audio_decoder";

478 
tde
->
u£rs
 = 1;

480 
	`tc_£t_audio_·¿m
(&
tde
->
·¿
,&
def_audio_·rm_de
);

481 
	`š™_MUTEX
(&
tde
->
£m
);

482 
	`š™_wa™queue_h—d
(&
tde
->
wa™_pŞl
);

484 
	}
}

486 
	$audio_de_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

488 
tw_audio_de
 *
tde
;

490 if(!
tsd
)

493 
tde
 = 
	`cÚš”_of
(
tsd
,
tw_audio_de
,tsd);

494 if(
tde
->
tsd
.
queue
)

495 
	`kä“
(
tde
->
tsd
.
queue
);

496 
	`kä“
(
tde
);

497 
	}
}

500 
tsd_fe_İ”©iÚs
 
	gaudio_de_fİs
 = {

501 .
owÃr
 = 
THIS_MODULE
,

502 .
	gš™
 = 
audio_de_š™
,

503 .
	gde¡Üy
ğ
audio_de_de¡Üy
,

504 .
	gİ’
 = 
audio_de_İ’
,

505 .
	g»ad
 = 
audio_de_»ad
,

506 .
	gwr™e
 = 
audio_de_wr™e
,

507 .
	gioùl
 = 
audio_de_ioùl
,

508 .
	g»Ëa£
ğ
audio_de_»Ëa£
,

509 .
	gpŞl
 = 
audio_de_pŞl
,

512 
tw_dev_id
 
	gtw_audio_de_id
 = {

513 .
•obj
 = {

514 .
v’dÜ_id
 = 
TWELL
,

515 .
	gbus_id
 = 1,

516 .
	gch_id
 = 
TW5864
,

517 .
	gfunc_id
 = (
STREAM_TYPE_AUDIO
 << 16è| 
CODEC_AUDIO_ADPCM
,

518 .
	gty³
 = 
TW_DECODER
,

519 .
	gkey
 = {0},

521 .
	gv”siÚ
 = 0,

524 
tw_dev_bË_id
 *
	gtde_bË
 = 
NULL
;

526 
	$tw_audio_de_š™
(* 
d©a
)

529 
tde_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

530 if(!
tde_bË
){

531 
	`dbg
("nØmem iÀ%s\n",
__FUNCTION__
);

532  -
ENOMEM
;

534 
	`INIT_LIST_HEAD
(&
tde_bË
->
li¡
);

535 
tde_bË
->
tid
 = &
tw_audio_de_id
;

536 
tde_bË
->
İs
 = &
audio_de_fİs
;

537 
tde_bË
->
·¿
 = 
d©a
;

538 
	`»gi¡”_tc_deviû
(
tde_bË
);

539 
	`´štk
("decod” <0x%8p>\n",
d©a
);

541 
	}
}

543 
	$tw_audio_de_»move
()

545 if(
tde_bË
)

546 
	`uÄegi¡”_tc_deviû
(
tde_bË
);

547 
tde_bË
 = 
NULL
;

548 
	}
}

	@../../tw5864/device_layer/tc_audio_en.c

1 
	~<tw5864/tc_commÚ.h
>

3 
tw_ch_audio_·¿m_my
 
	gdef_audio_·rm_’
 = {

4 .
i_b™_wide
 = 
TW_AUDIO_16BIT
,

5 .
	gi_§m¶e_¿‹
 = 
TW_AUDIO_8K
,

6 .
	ge_audio_ty³
 = 
TW_AUDIO_ADPCM_32K
,

10 
	$if_exi¡
(*
ba£
, 
Ën
, 
key
)

12 *
p
 = 
ba£
;

14 
p
 !ğ
ba£
+
Ën
){

15 if(
key
 =ğ*
p
++)

19 
	}
}

23 
	$«_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
, 
tc_bufãr
 
__u£r
 *
tc
)

25 
tc_bufãr_k”n
 *
tck
,*
tmp
;

26 
tw_audio_’
 * 
e
 = (tw_audio_’ *)
´iv
;

27 
tw_audio_·ck‘_queue_t
 *
adpq
;

28 
tw_audio_·ck‘_£ùiÚ_t
 *
as
;

29 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
;

30 
Ä_»ady
,
Ä_h—d”
,
bufãr_Ãed
 = 
PAGE_SIZE
,
us
 = 
tc
->
__tc__size
;

31 
tc_h—d”_buf
 *
thb
;

32 
idx
,
Ï
 = 0;

33 
off£t
 = 0,
ns
 = 0;

34 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

36 
adpq
 = &
driv
->
audio_·ck‘_queue
;

37 
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

40 
tmp
 = 
tq
->
bufs
[0];

41 if((
STATE_READY
 =ğ
	`g‘_tck_¡©e
(
tmp
)è&& (0 !ğtmp->
Ï¡_´•¬e
)){

43 
tc
->
__tc__Ä_äame
 = 1;

44 if(
tmp
->
Ï¡_´•¬e
 > 
us
){

45 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

46  -
ENOMEM
;

48 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

49 
tmp
->
Ï¡_´•¬e
 = 0;

53 
»Œy
:

54 
Ä_»ady
 = 
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq);

56 
thb_poŞ
->
İ
->
	`Œy_g‘_h—d”_buf
Ñhb_poŞ,&
thb
);

57 if(!
thb
){

58 
	`dbg
("g‘ h—d”_bufã¸nÙhšg iÀ%s!\n",
__FUNCTION__
);

59  -
EAGAIN
;

61 
Ä_h—d”
 = 
	`round_low
(
thb
->
un™_size
,
MIN_HEADER_LEN_AUDIO
);

62 
Ä_»ady
 = 
	`tc_mš
Òr_»ady,
Ä_h—d”
);

63 
Ä_»ady
 = 
	`tc_mš
Òr_»ady,
tq
->
buf_Ä
);

64 
tc
->
__tc__Ä_äame
 = 0;

65 
idx
 = 0; idx < 
Ä_»ady
; idx++){

66 
as
 = 
NULL
;

67 if(!
adpq
->
cu¼_cÚsum”
){

68 
adpq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(adpq);

69 if(!
adpq
->
cu¼_cÚsum”
){

70 
	`dbg
("g‘‡udiØ·ck‘‚Ùhšg! iÀ%s!\n",
__FUNCTION__
);

71 
tc
->
__tc__size
 = 
bufãr_Ãed
;

72 if(
PAGE_SIZE
 ==
tc
->
__tc__size
)

74 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

75  -
EAGAIN
;

83 if(
e
->
disÿrd
){

84 
adpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×dpq,
adpoŞ
);

85 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

86 
e
->
disÿrd
 = 0;

87 
»Œy
;

89 
adpq
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×dpq->cu¼_cÚsum”,&
as
);

90 
adpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×dpq,
adpoŞ
);

91 
tck
 = 
tq
->
bufs
[
idx
];

92 
tck
->
šdex
 = 
idx
;

93 
tck
->
ty³
 = 
MEM_MMAP
;

94 
tck
->
thb
 =hb;

95 
tck
->
hŞd”
 = 
as
;

96 
tck
->
i§lign
 = ((()
as
->
d©a
) & 0xFFF)? 0: 1;

97 
tck
->
off_to_·ge
 = (()
as
->
d©a
) & 0xFFF;

98 
tck
->
¡¬t
 = (
__u32
 *)
as
->
d©a
;

99 
tck
->
size
 = 
as
->
·ylßd_Ën
;

101 
Ï
 = 
tck
->
off_to_·ge
 -†a;

102 if(
Ï
 < 0)

103 
ns
 = 
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
);

105 
ns
 = 
	`tc_®ign_up
(
tck
->
size
,
as
->
£ùiÚ_size
);

107 if(
bufãr_Ãed
 + 
ns
 > 
us
){

108 if(0 =ğ
idx
){

109 
tc
->
__tc__size
 = 
bufãr_Ãed
 + 
ns
;

110 
tc
->
__tc__Ä_äame
 = 1;

111 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

112 
	`tc_bufãr_£t_audio_d©a
((
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
as
,&
off£t
);

113 
tmp
->
Ï¡_´•¬e
 = 
tc
->
__tc__size
;

115  -
ENOMEM
;

119 
as
->
İ
->
	`»ã»nû
×s,&
adpq
->
cu¼_cÚsum”
);

120 
as
->
İ
->
	`»Ëa£
(&as,
adpoŞ
);

121 
tck
->
hŞd”
 = 
NULL
;

126 
Ï
 = 
tck
->
off_to_·ge
;

127 
bufãr_Ãed
 +ğ
ns
;

128 
tc
->
__tc__size
 = 
bufãr_Ãed
;

129 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

130 
	`tc_bufãr_£t_audio_d©a
((
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
as
,&
off£t
);

131 
tc
->
__tc__Ä_äame
++;

135 
	}
}

137 
	$«_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

139 
»t
 = 0,
Ä
 = 0;

140 
tw_audio_’
 * 
e
 = (tw_audio_’ *)
´iv
;

141 
tw_audio_·ck‘_£ùiÚ_t
 *
as
 = 
NULL
;

142 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

143 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

144 
tc_bufãr_k”n
 *
tck
 = 
tb
;

147 if(!
adpoŞ
){

148 
	`dbg
("chan_buf_pool is NULL!\n");

149  -
EINVAL
;

152 if(!
tck
->
thb
 || !tck->
hŞd”
){

153 
	`dbg
("šv®id…¬am‘” šck! -->%s\n",
__FUNCTION__
);

154  -
EINVAL
;

156 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
tck
->
thb
);

158 (
tck
 = 
tq
->
bufs
[
Ä
]è&& (
STATE_BUSY
 =ğ
	`g‘_tck_¡©e
(tck))){

159 
as
 = (
tw_audio_·ck‘_£ùiÚ_t
 *)
tck
->
hŞd”
;

160 
as
->
İ
->
	`»Ëa£
(&as,
adpoŞ
);

161 
	`£t_tck_¡©e
(
tck
,
STATE_FREE
);

162 
Ä
++;

163 if(
Ä
 >ğ
tq
->
buf_Ä
)

167  
»t
;

168 
	}
}

173 
tc_queue_İs
 
	g«_queue_İs
 =

175 .
buf_´•¬e
 = 
«_buf_´•¬e
,

176 .
	gbuf_»Ëa£
 = 
«_buf_»Ëa£
,

179 
	$»que¡_memÜy
(
fe
 *
f
,
¬g
)

181 
»t
 = 0;

182 
tc_bufãr
 *
tc
 = (tc_bufã¸*)
¬g
;

183 
tw_audio_’
 * 
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

184 
tc_queue
 *
q
 = 
e
->
tsd
.
queue
;

187 
	`down
(&
e
->
£m
);

188 #ifdeà
STATIC_COUNTING


202 if(!
q
->
İs
){

203 
	`dbg
("tq has‚o ops!\n");

204 
»t
 = -
EINVAL
;

205 
out
;

207 if(!
q
->
İs
->
buf_´•¬e
){

208 
	`dbg
("tq->ops has‚o buf_prepare!\n");

209 
»t
 = -
EINVAL
;

210 
out
;

212 
»t
 = 
q
->
İs
->
	`buf_´•¬e
(q,
e
,
tc
);

213 
out
:

214 
	`up
(&
e
->
£m
);

215  
»t
;

216 
	}
}

248 
	$»Ëa£_memÜy
(
fe
 *
f
,
¬g
)

250 
»t
 = 0;

251 
tw_audio_’
 * 
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

252 
tc_queue
 *
tq
 = 
e
->
tsd
.
queue
;

253 
tc_bufãr_k”n
 * 
tck
;

255 
	`down
(&
e
->
£m
);

256 #ifdeà
STATIC_COUNTING


260 
tck
 = 
tq
->
bufs
[0];

261 if(!
tq
->
İs
 || !tq->İs->
buf_»Ëa£
){

262 
	`dbg
("no ops or‚o buf_release!\n");

263 
»t
 = -
EINVAL
;

264 
out
;

266 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
e
,
tck
);

267 
out
:

268 
	`up
(&
e
->
£m
);

270 
	}
}

278 
	$e_ş—nup
(* 
¬g
)

280 
tw_audio_’
 *
e
 = (tw_audio_’ *)
¬g
;

282 
tc_Œaû
;

283 
	`tc_queue_»Ëa£
(
e
->
tsd
.
queue
);

284 
	`kä“
(
e
);

285 
	}
}

288 
tw_audio_driv”_t
 * 
	$lookup_drive_š¡ªû
(
tw_£rviû_deviû
 *
tsd
)

290 
tw_audio_driv”_t
 *
p
 = 
tsd
->
´iv©e_d©a
;

291 
ld
 = 
	`g‘_phchª_id_äom_•obj
(&
tsd
->
•obj
);

292 
	`´štk
("tsd->mšÜ = %d,†d = %luƒncod”‡dd = %8p\n",
tsd
->
mšÜ
,
ld
,&
p
[ld]);

294  &
p
[
ld
];

296 
	}
}

299 
	$audi_’_pŞlšg
(*
p
)

301 
tw_audio_’
 *
e
 = (tw_audio_’ *)
p
;

302 
tw_audio_·ck‘_queue_t
 *
adpq
;

303 
Ä
;

304 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

307 
adpq
 = &
driv
->
audio_·ck‘_queue
;

308 
Ä
 = 
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq);

309 if(
Ä
)

311 
	`wake_up
(&
e
->
wa™_pŞl
);

319 
	}
}

324 
	$audio_’_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

326 
»t
 = 0;

327 
ed_tcb_t
 *
«d
;

328 
tw_audio_’
 *
e
 = 
	`cÚš”_of
(
tsd
,tw_audio_en,tsd);

330 
tc_Œaû
;

332 if(!
e
->
tsd
.
³d
){

333 
	`dbg
("audio dev has‚o driver‡ttached!\n");

334 
»t
 = -1;

335  
»t
;

339 
e
->
tim”_id
 = 
	`AddFÜFœeTim”Job
(12,
audi_’_pŞlšg
,tae);

340 if(
e
->
tim”_id
 =ğ
ADDJOBERROR
){

341 
	`´štk
("š % addim” job faed!\n",
__FUNCTION__
);

342 
»t
 = -1;

343  
»t
;

345 
«d
 = 
e
->
tsd
.
³d
;

346 
»t
 = 
«d
->
İ
->
	`İ’
(aed);

347 if(
»t
 !ğ
TW_OK
){

348 
	`´štk
("š % audio_driv” o³Àçed!\n",
__FUNCTION__
);

349 
»t
 = -1;

350  
»t
;

352 
f
->
´iv©e_d©a
 = 
e
;

353  
»t
;

354 
	}
}

358 
ssize_t
 
	$audio_’_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

360 
off£t
 = 0;

361 
tw_audio_’
 *
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

362 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

363 
·yËn
 = 
	`g‘_·ylßd_Ën
(&
e
->
·¿
);

364 
queue_’Œy
 = 0;

365 
size_t
 
ú
 = 
couÁ
,
mš
 = 
·yËn
 + (
tw_äame_h—d”_t
è+ (
tw_audio_äame_·d_t
);

366 
__u£r
 *
p
 = 
buff
;

367 
tw_audio_·ck‘_queue_t
 *
adpq
 = &
driv
->
audio_·ck‘_queue
;

368 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

369 
tw_äame_h—d”_t
 *
äame_h—d
 = 
NULL
;

370 
tw_audio_·ck‘_£ùiÚ_t
 *
as
 = 
NULL
;

371 
loff_t
 
äame_off£t
;

372 
tw_audio_·ck‘_£ùiÚ_t
 *
ªÙh”
 = 
NULL
;

374 
	`down
(&
e
->
£m
);

375 
	`dbg
("ú = %d,mš = %d\n", 
ú
,
mš
);

376 
ú
 >ğ
mš
){

377 
	`dbg
("’cod”‡dd = <%8p>, queue_’Œy‚umb” = %lu\n",
driv
,
queue_’Œy
);

378 
queue_’Œy
 = 
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq);

379 
adpq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(adpq);

380 
as
 = 
adpq
->
cu¼_cÚsum”
;

381 if(!
as
){

383 
	`´štk
("no consumer!\n");

384 
out
;

388 
as
->
İ
->
	`»ã»nû
×s,&
ªÙh”
);

389 
adpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×dpq,
adpoŞ
);

390 if(
ªÙh”
){

392 
	`´štk
("off£ˆğ%d\n",
off£t
);

393 
äame_off£t
 = 0;

394 
ªÙh”
->
İ
->
	`subm™
×nÙh”,&
buff
[
off£t
],
ú
,&
äame_off£t
,
TW_MASTER_BITSTREAM
,
adpoŞ
);

395 
ªÙh”
->
İ
->
	`»Ëa£
(&ªÙh”,
adpoŞ
);

397 
äame_h—d
 = (
tw_äame_h—d”_t
 *)&
buff
[
off£t
];

398 
off£t
 +ğ
äame_off£t
;

399 
p
 = (*)&
buff
[
off£t
];

400 ()
p
 & 0x3){

401 
	`´štk
("doing…adding!\n");

402 
	`__put_u£r
(0, 
p
++);

403 
äame_h—d
->
·ylßdL’
++;

404 
äame_off£t
 += 1;

405 
off£t
++;

408 if(
ú
 >ğ
äame_off£t
)

409 
ú
 = cÀ-
äame_off£t
;

411 
out
;

415 
out
:

416 
	`up
(&
e
->
£m
);

417 *
lof
 = 
off£t
;

418 
	`dbg
("»ad %d by‹s\n",
off£t
);

419  (
ssize_t
)
off£t
;

420 
	}
}

424 
ssize_t
 
	$audio_’_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

427 
»t
 = 0,
idx
 = 0,
»maš
 = 
couÁ
;

428 
Ä
 = 0,
Ãt_·yËn
;

429 
tw_audio_’
 *
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

430 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

431 
tw_audio_·ck‘_queue_t
 *
adpq
;

432 
tw_audio_chª_buf_poŞ_t
 *
adpoŞ
;

433 
tw_audio_·ck‘_£ùiÚ_t
 *
as
;

435 
adpq
 = &
driv
->
audio_·ck‘_queue
;

436 
adpoŞ
 = &
driv
->
audio_buf_poŞ
;

437 
	`down
(&
e
->
£m
);

439 
Ãt_·yËn
 = 
	`g‘_·ylßd_Ën
(&
e
->
·¿
);

441 
Ä
 = 
	`round_up
(
couÁ
,
Ãt_·yËn
);

443 ; 
idx
 < 
Ä
; idx++,
»maš
 = 
couÁ
 -(idx >> 9)){

444 
adpq
->
İ
->
	`g‘_cu¼_´oduûr_äom_poŞ
×dpq,
adpoŞ
);

445 
as
 = 
adpq
->
cu¼_´oduûr
;

446 if(
as
){

447 
as
->
·ylßd_Ën
 = (
»maš
 > 512)? 512:remain;

449 if(
	`cİy_äom_u£r
(
as
->
d©a
, 
buff
,
couÁ
)){

450 
	`dbg
("copy from user failed!\n");

451 
»t
 = -
EFAULT
;

452 
çed_out
;

455 
adpq
->
İ
->
	`put_cu¼_´oduûr_što_queue
(adpq);

458 
	`dbg
("can‚ot get section!\n");

459 
out
;

462 
out
:

463 
»t
 = 
couÁ
-
»maš
;

464 
çed_out
:

465 
	`up
(&
e
->
£m
);

466  
»t
;

468 
	}
}

470 
	$audio_’_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

472 
»t
 = 0;

473 
tw_audio_’
 *
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

474 
’dpošt_tcb
 *
ed
;

475 
tc_queue
 *
tq
 = 
e
->
tsd
.
queue
;

476 
tc_bufãr_k”n
 * 
tck
;

478 
cmd
)

481 
TW_CODEC_CHAN_REQUEST_MEM
:

482 
»t
 = 
	`»que¡_memÜy
(
f
,
¬g
);

484 
TW_CODEC_CHAN_RELEASE_MEM
:

485 
»t
 = 
	`»Ëa£_memÜy
(
f
,
¬g
);

487 
TW_CODEC_CHAN_DISCAED_FRAME
:

488 
e
->
disÿrd
 = 1;

489 
	`£t_tq_¡©e_busy
(
tq
);

490 
tck
 = 
tq
->
bufs
[0];

491 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
e
,
tck
);

492 if(
»t
)

493 
	`´štk
("disÿrd f¿m---»Ëa£ faed! iÀ%s\n",
__FUNCTION__
);

496 
	`dbg
("Ùh” cmd iÀ%s\n",
__FUNCTION__
);

497 if(!
e
->
tsd
.
³d
){

498 
	`´štk
("the device has‚o driverƒd!\n");

499 
»t
 = 
EFAULT
;

502 
ed
 = 
e
->
tsd
.
³d
;

503 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

507  
»t
;

508 
	}
}

512 
	$audio_’_»Ëa£
(
fe
 *
f
)

514 
»t
;

515 
ed_tcb_t
 *
«d
;

516 
tw_audio_’
 *
e
 = (tw_audio_’ *)
f
->
´iv©e_d©a
;

517 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

519 
tc_Œaû
;

520 
	`down
(&
e
->
£m
);

521 
«d
 = &
driv
->
audio_ed
;

522 
»t
 = 
«d
->
İ
->
	`şo£
(aed);

523 
	`D–‘eFÜFœeTim”Job
(
e
->
tim”_id
);

524 
	`tc_queue_»£t
(
e
->
tsd
.
queue
);

525 
	`up
(&
e
->
£m
);

527 
f
->
´iv©e_d©a
 = 
NULL
;

528  
»t
;

529 
	}
}

533 
	$audio_’_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

535 
mask
 = 0;

536 
tw_audio_’
 *
e
 = (tw_audio_’ *)
fe
->
´iv©e_d©a
;

537 
tw_audio_chª_driv”
 *
driv
 = 
	`cÚš”_of
(
e
->
tsd
.
³d
,tw_audio_chª_driv”, 
audio_ed
);

538 
tw_audio_·ck‘_queue_t
 *
adpq
 = &
driv
->
audio_·ck‘_queue
;

540 
	`down
(&
e
->
£m
);

541 
	`pŞl_wa™
(
fe
,&
e
->
wa™_pŞl
,
wa™
);

542 if(
adpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(adpq))

544 
mask
 |ğ
POLLIN
 | 
POLLRDNORM
;

551 
	`up
(&
e
->
£m
);

552  
mask
;

553 
	}
}

558 
	$audio_’_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

560 
tw_audio_’
 *
e
;

562 
tc_Œaû
;

563 
e
 = 
	`kz®loc
((*e),
GFP_KERNEL
);

564 if(
NULL
 =ğ
e
)

565  -
ENOMEM
;

566 *
tsd
 = &
e
->tsd;

568 
e
->
tsd
.
ş—n_up
 = 
e_ş—nup
;

569 
e
->
tsd
.
queue
 = 
	`kz®loc
((
tc_queue
),
GFP_KERNEL
);

570 if(
NULL
 =ğ
e
->
tsd
.
queue
)

571  -
ENOMEM
;

573 
	`tc_queue_š™
(
e
->
tsd
.
queue
,&
«_queue_İs
,
NULL
,512,10,tae);

574 
e
->
Çme
 = "tw5864-audio_encoder";

575 
e
->
u£rs
 = 1;

577 
	`tc_£t_audio_·¿m
(&
e
->
·¿
,&
def_audio_·rm_’
);

578 
	`š™_MUTEX
(&
e
->
£m
);

579 
	`š™_wa™queue_h—d
(&
e
->
wa™_pŞl
);

581 
	}
}

583 
	$audio_’_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

585 
tw_audio_’
 *
e
;

586 
tc_Œaû
;

588 if(!
tsd
)

590 
e
 = 
	`cÚš”_of
(
tsd
,
tw_audio_’
,tsd);

591 if(
e
->
tsd
.
queue
)

592 
	`kä“
(
e
->
tsd
.
queue
);

593 
	`kä“
(
e
);

594 
	}
}

597 
tsd_fe_İ”©iÚs
 
	gaudio_’_fİs
 = {

598 .
owÃr
 = 
THIS_MODULE
,

599 .
	gš™
 = 
audio_’_š™
,

600 .
	gde¡Üy
ğ
audio_’_de¡Üy
,

601 .
	gİ’
 = 
audio_’_İ’
,

602 .
	g»ad
 = 
audio_’_»ad
,

603 .
	gwr™e
 = 
audio_’_wr™e
,

604 .
	gioùl
 = 
audio_’_ioùl
,

605 .
	g»Ëa£
ğ
audio_’_»Ëa£
,

606 .
	gpŞl
 = 
audio_’_pŞl
,

609 
tw_dev_id
 
	gtw_audio_’_id
 = {

610 .
•obj
 = {

611 .
v’dÜ_id
 = 
TWELL
,

612 .
	gbus_id
 = 1,

613 .
	gch_id
 = 
TW5864
,

614 .
	gfunc_id
 = (
STREAM_TYPE_AUDIO
 << 16è| 
CODEC_AUDIO_ADPCM
,

615 .
	gty³
 = 
TW_ENCODER
,

616 .
	gkey
 = {0},

618 .
	gv”siÚ
 = 0,

621 
tw_dev_bË_id
 *
	ge_bË
 = 
NULL
;

623 
	$tw_audio_’_š™
(* 
d©a
)

625 
e_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

626 if(!
e_bË
){

627 
	`dbg
("nØmem iÀ%s\n",
__FUNCTION__
);

628  -
ENOMEM
;

630 
	`INIT_LIST_HEAD
(&
e_bË
->
li¡
);

631 
e_bË
->
tid
 = &
tw_audio_’_id
;

632 
e_bË
->
İs
 = &
audio_’_fİs
;

633 
e_bË
->
·¿
 = 
d©a
;

635 
	`»gi¡”_tc_deviû
(
e_bË
);

636 
	`´štk
("’cod” <0x%8p>\n",
d©a
);

638 
	}
}

640 
	$tw_audio_’_»move
()

642 if(
e_bË
)

643 
	`uÄegi¡”_tc_deviû
(
e_bË
);

644 
e_bË
 = 
NULL
;

645 
	}
}

	@../../tw5864/device_layer/tc_buffer.c

1 
	~<tw5864/tc_commÚ.h
>

2 
	$£t_tq_¡©e_busy
(
tc_queue
 *
tq
)

4 
tc_bufãr_k”n
 *
tck
;

5 
cix
 = 0;

7 (
tck
 = 
tq
->
bufs
[
cix
]è&& (
STATE_READY
 =ğ
	`g‘_tck_¡©e
(tck))){

8 
	`£t_tck_¡©e
(
tck
,
STATE_BUSY
);

9 
cix
++;

11 
	}
}

14 
	$ÿlc_d©a_¥ª
(
tc_bufãr_k”n
 *
tck
)

16 
s
 = 0,
Ä
 = 
tck
->
šdex
,
idx
;

17 
tc_bufãr_k”n
 *
tk
;

18 
tc_queue
 *
tq
 = 
tck
->tq;

19 
o
;

21 
tk
 = 
tq
->
bufs
[0];

22 
o
 = 
tk
->
off_to_·ge
;

23 if(
o
 >= 4096)

24 
	`dbg
("BUG:he off_to_page isoo big!\n");

27 
idx
 = 0; idx < 
Ä
;)

29 
tk
 = 
tq
->
bufs
[
idx
];

30 if(
tk
->
tq
->
un™_size
 >ğ
PAGE_SIZE
)

32 
s
 +ğ
	`tc_®ign_up
(
tk
->
size
, 
PAGE_SIZE
);

36 
s
 +ğ
	`tc_®ign_up
(
tk
->
size
,tk->
tq
->
un™_size
);

38 
idx
++;

39 if(
idx
 >ğ
tq
->
buf_Ä
)

42 if(
tk
->
tq
->
un™_size
 < 
PAGE_SIZE
)

43 
s
 +ğ
o
;

46  
s
;

47 
	}
}

51 
	$tc_bufãr_£t_audio_d©a
(
tc_bufãr
 *
tc
, 
tc_bufãr_k”n
 *
tck
,
tw_audio_·ck‘_£ùiÚ_t
 *
ps
, *
off
)

53 
tc_bufãr
 
¡ck
 = {0};

54 
tc_äame_h—d”
 
tfh
 = {0};

55 
tc_audio_äame_·d
 
å
 = {0};

56 
tc_äame_h—d”
 *
±fh
;

58 
x
 = 
PAGE_SIZE
 - (*
off
 + 
MIN_COMMON_HEAD_LEN
);

59 
s
;

60 *
de¡
;

64 
±fh
 = (
tc_äame_h—d”
 *)((*)(
tc
->
tc_äame_h—d
è+ *
off
);

65 
de¡
 = (*)
tc
 + *
off
;

66 
s
 = 
	`ÿlc_d©a_¥ª
(
tck
);

69 
å
.
ty³
 = 
ps
->type;

70 
å
.
b™_wide
 = 
ps
->bit_wide;

71 
å
.
§m¶e_¿‹
 = 
ps
->sample_rate;

72 
å
.
b™_¿‹
 = 0;

73 
å
.
äame_off£t
 = 
x
 + 
s
;

74 
å
.
äame_size
 = 
ps
->
·ylßd_Ën
;

77 
tfh
.
codecTy³
 = 
TW_AUDIO_CODEC_TYPE
;

78 
tfh
.
¡»amTy³
 = 
TW_MASTER_BITSTREAM
;

79 
tfh
.
äameS”Ÿl
 = 
ps
->frameSerial;

80 
tfh
.
äameTy³
 = 
AUDIO_FRAME_TYPE
;

81 
tfh
.
timeSmp
 = 
ps
->
time¡amp
;

82 
tfh
.
·ylßd_off£t
 = (
tc_äame_h—d”
);

83 
tfh
.
·ylßdL’
 = (
tc_audio_äame_·d
è+ 
å
.
äame_size
;

86 
¡ck
.
šdex
 = 
tck
->index;

87 
¡ck
.
ty³
 = 
tck
->type;

88 
¡ck
.
æag
 = 
tck
->flag;

90 
¡ck
.
__tc__¡©e
 = 
tck
->
¡©e
;

91 
¡ck
.
__tc__i§lign
 = 
tck
->
i§lign
;

92 
¡ck
.
__tc__off_to_·ge
 = 
tck
->
off_to_·ge
;

93 
¡ck
.
__tc__¡¬t
 = 
tck
->
¡¬t
;

94 
¡ck
.
__tc__size
 = 
ps
->
·ylßd_Ën
;

95 
	`memıy
(
±fh
->
·d
,&
å
,(
tc_audio_äame_·d
));

96 
	`memıy
(
±fh
,&
tfh
,(
tc_äame_h—d”
));

97 
	`memıy
(
de¡
,&
¡ck
,(
tc_bufãr
));

98 *
off
 +ğ
	`tc_®ign_up
(
MIN_HEADER_LEN_AUDIO
,4);

99 
	}
}

103 
	$ÿlc_äame_size
(
tc_bufãr_k”n
 *
tck
)

105 
size
 = 0,
idx
 = 0;

107 
tck
->
sg
[
idx
].
ÿ¼›r
 &&ck->sg[idx].
addr
 &&ck->sg[idx].
Ën
){

108 
size
 +ğ
tck
->
sg
[
idx
].
Ën
;

109 
idx
++;

110 if(
idx
 >ğ
SCATTRT_MAX_ENTRY
)

115  
size
;

116 
	}
}

121 
	$tc_bufãr_£t_h264_d©a
(
is_ma¡”
,
tc_bufãr
 *
tc
, 
tc_bufãr_k”n
 *
tck
, 
tw_video_äame_tcb_t
 *
vf
,*
off
)

123 
tc_bufãr
 
¡ck
 = {0};

124 
tc_äame_h—d”
 
tfh
 = {0};

125 
tc_h264_idr_äame_·d
 
två
 = {0};

126 
tc_äame_h—d”
 *
±fh
;

127 
h264_Çl_t
 *
Çl
 = &
vf
->nal;

128 
äame_size
 = 0;

129 
x
 = 
PAGE_SIZE
 - (*
off
 + 
MIN_COMMON_HEAD_LEN
);

130 
y
 = 
PAGE_SIZE
 - (*
off
 + (
tc_bufãr
));

131 
s
;

132 *
de¡
;

133 
tc_äame_h—d”
 *

;

134 *
p
;

137 
±fh
 = (
tc_äame_h—d”
 *)((*)(
tc
->
tc_äame_h—d
è+ *
off
);

138 
de¡
 = (*)
tc
 + *
off
;

139 if((()
±fh
è- (()
tc
) >= 4000){

140 
	`´štk
("\n\n&&&&&&&&&&&&&impossŸbË&&&&&&&&&&&&&&&&&&&&&&&&&&&&& %p, %p\n", 
±fh
, 
tc
);

142 if((()
de¡
è- (()
tc
) >= 4000){

143 
	`´štk
("\n\n**************impossŸbË**************************** %°%p\n", 
de¡
, 
tc
);

145 

 = (
tc_äame_h—d”
 *)((
tc_bufãr
 *)
de¡
)->
tc_äame_h—d
;

146 
äame_size
 = 
tck
->
size
;

149 
s
 = 
	`ÿlc_d©a_¥ª
(
tck
);

152 if(
H264_FRAME_TYPE_IDR
 =ğ
vf
->
äame_ty³
){

154 
två
.
ås
 = 
vf
->fps;

155 
två
.
š™_qp
 = 
vf
->
i_š™_qp
;

156 
två
.
log2MaxF¿meNumNšus4
 = 
vf
->
i_log_gİ_v®ue
;

157 
två
.
mb_width_mšus1
 = 
vf
->
i_mb_x
;

158 
två
.
mb_height_mšus1
 = 
vf
->
i_mb_y
;

159 
två
.
i_cu¼_qp
 = 
vf
->i_curr_qp;

161 
två
.
¥s_äame_off£t
 = 
x
 + 
s
;

162 
två
.
¥s_äame_size
 = 
Çl
->
¥s_·ysize
;

163 
två
.
µs_äame_off£t
 =vå.
¥s_äame_off£t
 + 
Çl
->
¥s_·ysize
;

164 
två
.
µs_äame_size
 = 
Çl
->
µs_·ysize
;

165 
två
.
idr_äame_off£t
 =vå.
µs_äame_off£t
 + 
Çl
->
µs_·ysize
;

166 
två
.
idr_äame_size
 = 
vf
->
äame_Ën
;

173 
tfh
.
codecTy³
 = 
TW_VIDEO_H264_CODEC_TYPE
;

174 if(
is_ma¡”
)

175 
tfh
.
¡»amTy³
 = 
TW_MASTER_BITSTREAM
;

177 
tfh
.
¡»amTy³
 = 
TW_SUB_BITSTREAM
;

179 
tfh
.
äameS”Ÿl
 = 
vf
->
äame_numb”
;

180 
tfh
.
äameTy³
 = 
vf
->
äame_ty³
;

181 
tfh
.
timeSmp
 = 
vf
->
time¡amp
;

182 if(
H264_FRAME_TYPE_IDR
 =ğ
vf
->
äame_ty³
){

183 
tfh
.
·ylßd_off£t
 = (
tc_äame_h—d”
);

184 
tfh
.
·ylßdL’
 = (
tc_h264_idr_äame_·d
è+ 
äame_size
;

188 
tfh
.
·ylßd_off£t
 = 
y
 + 
s
;

189 
tfh
.
·ylßdL’
 = 
äame_size
;

193 
¡ck
.
šdex
 = 
tck
->index;

194 
¡ck
.
ty³
 = 
tck
->type;

195 
¡ck
.
æag
 = 
tck
->flag;

197 
¡ck
.
__tc__¡©e
 = 
tck
->
¡©e
;

198 
¡ck
.
__tc__i§lign
 = 1;

199 
¡ck
.
__tc__off_to_·ge
 = 0;

200 
¡ck
.
__tc__¡¬t
 = 
tck
->
sg
[0].
addr
;

201 
¡ck
.
__tc__size
 = 
äame_size
;

203 if(
H264_FRAME_TYPE_IDR
 =ğ
vf
->
äame_ty³
)

204 
	`memıy
(
±fh
->
·d
,&
två
,(
tc_h264_idr_äame_·d
));

205 
	`memıy
(
±fh
,&
tfh
,(
tc_äame_h—d”
));

206 
	`memıy
(
de¡
,&
¡ck
,(
tc_bufãr
));

208 if(
H264_FRAME_TYPE_IDR
 =ğ
vf
->
äame_ty³
)

209 *
off
 +ğ
	`tc_®ign_up
(
MIN_HEADER_LEN_VIDEO_IDR
,4);

211 *
off
 +ğ
	`tc_®ign_up
(
MIN_HEADER_LEN_VIDEO
,4);

216 
	}
}

219 
	$tc_bufãr_£t_j³g_d©a
(
tc_bufãr
 *
tc
, 
tc_bufãr_k”n
 *
tck
, 
tw_vb_äame_tcb
 *
tvf
, *
off
)

221 
tc_bufãr
 
¡ck
 = {0};

222 
tc_äame_h—d”
 
tfh
 = {0};

223 
tc_äame_h—d”
 *
±fh
;

224 
äame_size
 = 0;

225 
x
 = 
PAGE_SIZE
 - (*
off
 + (
tc_bufãr
));

226 
s
;

227 *
de¡
;

230 
±fh
 = (
tc_äame_h—d”
 *)(((*)
tc
->
tc_äame_h—d
è+ (*
off
));

231 
de¡
 = (*)
tc
 + (*
off
);

232 
äame_size
 = 
tck
->
size
;

233 
s
 = 
	`ÿlc_d©a_¥ª
(
tck
);

236 
tfh
.
codecTy³
 = 
TW_VIDEO_MJPEG_CODEC_TYPE
;

237 
tfh
.
¡»amTy³
 = 
TW_MASTER_BITSTREAM
;

238 
tfh
.
äameS”Ÿl
 = 
tvf
->
äame_numb”
;

239 
tfh
.
äameTy³
 = 
tvf
->
äame_ty³
;

240 
tfh
.
timeSmp
 = 
tvf
->
time¡amp
;

241 
tfh
.
·ylßd_off£t
 = 
x
 + 
s
;

242 
tfh
.
·ylßdL’
 = 
äame_size
;

245 
¡ck
.
šdex
 = 
tck
->index;

246 
¡ck
.
ty³
 = 
tck
->type;

247 
¡ck
.
æag
 = 
tck
->flag;

249 
¡ck
.
__tc__¡©e
 = 
tck
->
¡©e
;

250 
¡ck
.
__tc__i§lign
 = 1;

251 
¡ck
.
__tc__off_to_·ge
 = 0;

252 
¡ck
.
__tc__¡¬t
 = 
tck
->
sg
[0].
addr
;

253 
¡ck
.
__tc__size
 = 
äame_size
;

254 
	`memıy
(
±fh
,&
tfh
,(
tc_äame_h—d”
));

255 
	`memıy
(
de¡
,&
¡ck
,(
tc_bufãr
));

256 *
off
 +ğ
	`tc_®ign_up
(
MIN_HEADER_LEN_JPEG
,4);

257 
	}
}

280 
	$š™_queue_bufs
(
tc_queue
 * 
tq
)

282 
idx
,
cidx
;

283 
Ä
;

286 if(
NULL
 =ğ
tq
->
bufs
){

287 
	`TW_DBG
(
TW_DBG_ERR
,"theq->bufs = NULL!\n");

288  -
EINVAL
;

291 if(0 =ğ
tq
->
buf_Ä
){

292 
	`TW_DBG
(
TW_DBG_ERR
,"theq->buf_nr = 0!\n");

293  -
EINVAL
;

296 
Ä
 = 
	`tc_mš
(
tq
->
buf_Ä
,
QUEUE_MAX_FRAME
);

297 if(
tq
->
buf_Ä
 > 
QUEUE_MAX_FRAME
){

298 
	`TW_DBG
(
TW_DBG_ERR
,"max %d bufs\n",
QUEUE_MAX_FRAME
);

299 
tq
->
buf_Ä
 = 
QUEUE_MAX_FRAME
;

302 
idx
 = 0;idx < 
Ä
; idx++)

304 
tq
->
bufs
[
idx
] = 
	`kz®loc
((
tc_bufãr_k”n
),
GFP_KERNEL
);

305 if(
NULL
 =ğ
tq
->
bufs
[
idx
])

306 
ş—nup
;

307 
	`š™_wa™queue_h—d
(&
tq
->
bufs
[
idx
]->
dÚe
);

308 
tq
->
bufs
[
idx
]->
šdex
 = idx;

309 
tq
->
bufs
[
idx
]->tq =q;

310 
	`£t_tck_¡©e
(
tq
->
bufs
[
idx
],
STATE_FREE
);

313 
ş—nup
:

314 
cidx
 = 0; cidx < 
idx
; cidx++)

316 
	`kä“
(
tq
->
bufs
[
cidx
]);

320 
	}
}

329 
	$tc_queue_š™
(
tc_queue
 *
q
, 
tc_queue_İs
 *
İs
, * 
dev
,

330 
usize
, 
buf_couÁ
,*
´iv
)

332 if(
usize
 =ğ0 || 
buf_couÁ
 == 0){

333 
	`TW_DBG
(
TW_DBG_ERR
,"init with 0 size or 0 count!\n");

337 
	`mem£t
(
q
,0,(*q));

338 
q
->
dev
 = dev;

340 
q
->
un™_size
 = 
usize
;

341 
q
->
İs
 = ops;

342 
q
->
´iv_d©a
 = 
´iv
;

343 
q
->
buf_Ä
 = 
buf_couÁ
;

344 
	`mu‹x_š™
(&
q
->
lock
);

345 
	`š™_wa™queue_h—d
(&
q
->
dÚe
);

346 
q
->
wp
 = 0;

347 
q
->
½
 = 0;

348  
	`š™_queue_bufs
(
q
);

349 
	}
}

351 
	$tc_queue_»£t
(
tc_queue
 *
q
)

353 
idx
 = 0;

354 
tc_bufãr_k”n
 * 
tck
;

356 
tc_Œaû
;

357 
	`mu‹x_lock
(&
q
->
lock
);

365 
	`mu‹x_uÆock
(&
q
->
lock
);

367 
idx
 = 0; idx < 
q
->
buf_Ä
; idx++)

369 
tck
 = 
q
->
bufs
[
idx
];

370 
	`š™_wa™queue_h—d
(&
tck
->
dÚe
);

371 
	`£t_tck_¡©e
(
tck
,
STATE_FREE
);

373 
q
->
wp
 = 0;

374 
q
->
½
 = 0;

376 
	}
}

379 
	$tc_queue_»Ëa£
(
tc_queue
 *
q
)

381 
idx
 = 0;

384 
	`mu‹x_lock
(&
q
->
lock
);

392 
	`mu‹x_uÆock
(&
q
->
lock
);

394 
idx
=0; idx < 
q
->
buf_Ä
; idx++)

395 
	`kä“
(
q
->
bufs
[
idx
]);

397 
	`kä“
(
q
);

398 
	}
}

	@../../tw5864/device_layer/tc_chip.c

1 
	~<tw5864/tc_commÚ.h
>

4 
	$‹¡_İ’
(
tw_ch_deviû
 *
tcd
,
fe
 * file)

6 
»t
 = 0;

8 
tc_Œaû
;

9 if(!
tcd
->
³d
 || !tcd->³d->
İ
)

10 
	`dbg
("šˆ% havdriv”‡‰ached!\n",
__FUNCTION__
);

12 
»t
 = 
tcd
->
³d
->
İ
->
	`İ’
(tcd->ped);

13 if(
»t
){

14 
	`´štk
("š % driv” o³Àçed!\n", 
__FUNCTION__
);

15  
»t
;

17 
fe
->
´iv©e_d©a
 = 
tcd
;

18  
»t
;

19 
	}
}

25 
	$‹¡_»Ëa£
(
tw_ch_deviû
 *
ch_dev
, 
fe
 *file)

27 
»t
;

28 
tw_ch_deviû
 *
tcd
 = (tw_ch_deviû *)
fe
->
´iv©e_d©a
;

30 
	`´štk
("--->funùiÚ % ÿÎed\n",
__FUNCTION__
);

31 if(!
tcd
->
³d
 || !tcd->³d->
İ
){

32 
	`´štk
("tcd->ped is NULL or…ed->op is NULL\n");

33  -
EINVAL
;

36 
»t
 = 
tcd
->
³d
->
İ
->
	`şo£
(tcd->ped);

37 
fe
->
´iv©e_d©a
 = 
NULL
;

38  
»t
;

39 
	}
}

41 
	$‹¡_ioùl
(
fe
 * 
fp
,
cmd
, 
¬g
)

43 
tw_ch_deviû
 *
tcd
 = (tw_ch_deviû *)
fp
->
´iv©e_d©a
;

45 
	`´štk
("---->funùiÚ % ÿÎed!\n",
__FUNCTION__
);

46 if(!
tcd
->
³d
 || !tcd->³d->
İ
){

47 
	`´štk
("tcd->ped is NULL or…ed->op is NULL\n");

48  -
EINVAL
;

51  
tcd
->
³d
->
İ
->
	`ioùl
Ñcd->³d,
cmd
,
¬g
);

52 
	}
}

55 
tcd_fe_İ”©iÚs
 
	g‹¡_fİ
 = {

56 .
İ’
 = 
‹¡_İ’
,

57 .
	g»Ëa£
 = 
‹¡_»Ëa£
,

58 .
	gioùl
 = 
‹¡_ioùl
,

66 
	$tc_ch_š™
(
tw_ch_deviû
 *
tcd
,
bus_id
,
ch_id
)

68 
»t
 = 0;

69 
•key_t
 
key
 = {0};

70 
idx
 = 0;

72 
	`dbg
("@@@@:bus_id[%lu];ch_id[%lu]\n",
bus_id
,
ch_id
);

73 ;
idx
 < 1; idx++){

74 
	`¥rštf
(
tcd
->
Çme
,"%s-%02lu","tw5864",
ch_id
);

75 
	`make_key
((
•key_t
 *)&
key
,0x3f,0x3f,
bus_id
,0,
ch_id
,0);

76 
	`•obj_š™
(&
tcd
->
•obj
, 
TWELL
, 
bus_id
,
TW5864
,0,0,&
key
);

77 
tcd
->
tcd_fİs
 = &
‹¡_fİ
;

78 
»t
 = 
	`»gi¡”_ch_deviû
(
tcd
);

79 if(
»t
){

80 
	`´štk
("regisrter chip dev failed!\n");

81  
»t
;

85  
»t
;

86 
	}
}

91 
	$tc_ch_ex™
(
tw_ch_deviû
 *
tcd
)

93 
	`uÄegi¡”_ch_deviû
(
tcd
);

94 
	}
}

	@../../tw5864/device_layer/tc_chip_ai.c

1 
	~<tw5864/tc_commÚ.h
>

12 
	$ai_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
, 
tc_bufãr
 
__u£r
 *
tc
)

15 
	}
}

17 
	$ai_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

19 
»t
 = 0;

20  
»t
;

21 
	}
}

26 
tc_queue_İs
 
	gai_queue_İs
 =

28 .
buf_´•¬e
 = 
ai_buf_´•¬e
,

29 .
	gbuf_»Ëa£
 = 
ai_buf_»Ëa£
,

38 
	$ai_»que¡_memÜy
(
fe
 *
f
,
¬g
)

40 
»t
 = 0;

42  
»t
;

43 
	}
}

46 
	$ai_»Ëa£_memÜy
(
fe
 *
f
,
¬g
)

49 
	}
}

54 
	$i_ş—nup
(* 
¬g
)

56 
tw_ch_ai
 *
i
 = (tw_ch_a˜*)
¬g
;

58 
tc_Œaû
;

60 
	`kä“
(
i
);

61 
	}
}

75 
	$audi_’_pŞlšg
(*
p
)

96 
	}
}

101 
	$ch_ai_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

103 
»t
 = 0;

104 
ed_tcb_t
 *
«d
;

105 
tw_ch_ai
 *
i
 = 
	`cÚš”_of
(
tsd
,tw_chip_ai,tsd);

107 
tc_Œaû
;

118 if(!
i
->
tsd
.
³d
){

119 
	`dbg
("ai dev has‚o driver‡ttached!\n");

122 
«d
 = 
i
->
tsd
.
³d
;

123 
»t
 = 
«d
->
İ
->
	`İ’
(aed);

124 if(
»t
 !ğ
TW_OK
){

125 
	`´štk
("š % audio_driv” o³Àçed!\n",
__FUNCTION__
);

126 
»t
 = -1;

127  
»t
;

129 
f
->
´iv©e_d©a
 = 
i
;

130  
»t
;

131 
	}
}

135 
ssize_t
 
	$ch_ai_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

137 
off£t
 = 0;

138  (
ssize_t
)
off£t
;

139 
	}
}

143 
ssize_t
 
	$ch_ai_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

146 
»t
 = 0;

148  
»t
;

150 
	}
}

152 
	$ch_ai_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

154 
»t
 = 0;

155 
tw_ch_ai
 *
i
 = (tw_ch_a˜*)
f
->
´iv©e_d©a
;

156 
’dpošt_tcb
 *
ed
;

158 
cmd
)

161 
TW_CODEC_CHAN_REQUEST_MEM
:

162 
»t
 = 
	`ai_»que¡_memÜy
(
f
,
¬g
);

164 
TW_CODEC_CHAN_RELEASE_MEM
:

165 
»t
 = 
	`ai_»Ëa£_memÜy
(
f
,
¬g
);

168 
	`dbg
("Ùh” cmd iÀ%s\n",
__FUNCTION__
);

169 if(!
i
->
tsd
.
³d
){

170 
	`´štk
("the device has‚o driverƒd!\n");

171 
»t
 = 
EFAULT
;

174 
ed
 = 
i
->
tsd
.
³d
;

175 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

179  
»t
;

180 
	}
}

184 
	$ch_ai_»Ëa£
(
fe
 *
f
)

186 
»t
;

187 
ed_tcb_t
 *
«d
;

188 
tw_ch_ai
 *
i
 = (tw_ch_a˜*)
f
->
´iv©e_d©a
;

190 
tc_Œaû
;

191 
	`down
(&
i
->
£m
);

192 
«d
 = 
i
->
tsd
.
³d
;

193 
»t
 = 
«d
->
İ
->
	`şo£
(aed);

194 
	`D–‘eFÜFœeTim”Job
(
i
->
tim”_id
);

196 
	`up
(&
i
->
£m
);

198 
f
->
´iv©e_d©a
 = 
NULL
;

199  
»t
;

200 
	}
}

204 
	$ch_ai_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

206 
mask
 = 0;

224  
mask
;

225 
	}
}

230 
	$ch_ai_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

232 
tw_ch_ai
 *
i
;

234 
tc_Œaû
;

235 
i
 = 
	`kz®loc
((*i),
GFP_KERNEL
);

236 if(
NULL
 =ğ
i
)

237  -
ENOMEM
;

238 *
tsd
 = &
i
->tsd;

240 
i
->
tsd
.
ş—n_up
 = 
i_ş—nup
;

242 
i
->
Çme
 = "tw5864-audio_input";

243 
i
->
u£rs
 = 1;

246 
	`š™_MUTEX
(&
i
->
£m
);

247 
	`š™_wa™queue_h—d
(&
i
->
wa™_pŞl
);

249 
	}
}

251 
	$ch_ai_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

253 
tw_ch_ai
 *
i
;

254 
tc_Œaû
;

256 if(!
tsd
)

258 
i
 = 
	`cÚš”_of
(
tsd
,
tw_ch_ai
,tsd);

261 
	`kä“
(
i
);

262 
	}
}

265 
tsd_fe_İ”©iÚs
 
	gch_ai_fİs
 = {

266 .
owÃr
 = 
THIS_MODULE
,

267 .
	gš™
 = 
ch_ai_š™
,

268 .
	gde¡Üy
ğ
ch_ai_de¡Üy
,

269 .
	gİ’
 = 
ch_ai_İ’
,

270 .
	g»ad
 = 
ch_ai_»ad
,

271 .
	gwr™e
 = 
ch_ai_wr™e
,

272 .
	gioùl
 = 
ch_ai_ioùl
,

273 .
	g»Ëa£
ğ
ch_ai_»Ëa£
,

274 .
	gpŞl
 = 
ch_ai_pŞl
,

277 
tw_dev_id
 
	gtw_ch_ai_id
 = {

278 .
•obj
 = {

279 .
v’dÜ_id
 = 
TWELL
,

280 .
	gbus_id
 = 1,

281 .
	gch_id
 = 
TW5864
,

282 .
	gfunc_id
 = 0,

283 .
	gty³
 = 
TW_AUDIO_IN
,

284 .
	gkey
 = {0},

286 .
	gv”siÚ
 = 0,

289 
tw_dev_bË_id
 *
	gi_bË
 = 
NULL
;

291 
	$tw_ch_ai_š™
(* 
d©a
)

293 
i_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

294 if(!
i_bË
){

295 
	`dbg
("nØmem iÀ%s\n",
__FUNCTION__
);

296  -
ENOMEM
;

298 
	`INIT_LIST_HEAD
(&
i_bË
->
li¡
);

299 
i_bË
->
tid
 = &
tw_ch_ai_id
;

300 
i_bË
->
İs
 = &
ch_ai_fİs
;

301 
i_bË
->
·¿
 = 
d©a
;

302 
	`dbg_•obj_´št
(&
i_bË
->
tid
->
•obj
);

303 
	`»gi¡”_tc_deviû
(
i_bË
);

305 
	}
}

307 
	$tw_ch_ai_»move
()

309 if(
i_bË
)

310 
	`uÄegi¡”_tc_deviû
(
i_bË
);

311 
i_bË
 = 
NULL
;

312 
	}
}

	@../../tw5864/device_layer/tc_chip_vi.c

1 
	~<tw5864/tc_commÚ.h
>

12 
	$vi_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
, 
tc_bufãr
 
__u£r
 *
tc
)

15 
	}
}

17 
	$vi_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

19 
»t
 = 0;

20  
»t
;

21 
	}
}

23 
tc_queue_İs
 
	gvi_queue_İs
 =

25 .
buf_´•¬e
 = 
vi_buf_´•¬e
,

26 .
	gbuf_»Ëa£
 = 
vi_buf_»Ëa£
,

29 
	$vi_»que¡_memÜy
(
fe
 *
f
,
¬g
)

31 
»t
 = 0;

33  
»t
;

34 
	}
}

36 
	$vi_»Ëa£_memÜy
(
fe
 *
f
,
¬g
)

39 
	}
}

42 
	$tvi_ş—nup
(* 
¬g
)

44 
tw_ch_vi
 *
tvi
 = (tw_ch_v˜*)
¬g
;

46 
tc_Œaû
;

48 
	`kä“
(
tvi
);

49 
	}
}

63 
	$audi_’_pŞlšg
(*
p
)

84 
	}
}

89 
	$ch_vi_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

91 
»t
 = 0;

92 
ed_tcb_t
 *
vid
;

93 
tw_ch_vi
 *
tvi
 = 
	`cÚš”_of
(
tsd
,tw_chip_vi,tsd);

95 
tc_Œaû
;

106 if(!
tvi
->
tsd
.
³d
){

107 
	`dbg
("ai dev has‚o driver‡ttached!\n");

110 
vid
 = 
tvi
->
tsd
.
³d
;

111 
»t
 = 
vid
->
İ
->
	`İ’
(vid);

112 if(
»t
 !ğ
TW_OK
){

113 
	`´štk
("š % audio_driv” o³Àçed!\n",
__FUNCTION__
);

114 
»t
 = -1;

115  
»t
;

117 
f
->
´iv©e_d©a
 = 
tvi
;

118  
»t
;

119 
	}
}

123 
ssize_t
 
	$ch_vi_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

125 
off£t
 = 0;

126  (
ssize_t
)
off£t
;

127 
	}
}

131 
ssize_t
 
	$ch_vi_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

134 
»t
 = 0;

136  
»t
;

138 
	}
}

140 
	$ch_vi_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

142 
»t
 = 0;

143 
tw_ch_vi
 *
tvi
 = (tw_ch_v˜*)
f
->
´iv©e_d©a
;

144 
’dpošt_tcb
 *
ed
;

146 
cmd
)

149 
TW_CODEC_CHAN_REQUEST_MEM
:

150 
»t
 = 
	`vi_»que¡_memÜy
(
f
,
¬g
);

152 
TW_CODEC_CHAN_RELEASE_MEM
:

153 
»t
 = 
	`vi_»Ëa£_memÜy
(
f
,
¬g
);

156 
	`dbg
("Ùh” cmd iÀ%s\n",
__FUNCTION__
);

157 if(!
tvi
->
tsd
.
³d
){

158 
	`´štk
("the device has‚o driverƒd!\n");

159 
»t
 = -
EFAULT
;

162 
ed
 = 
tvi
->
tsd
.
³d
;

163 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

167  
»t
;

168 
	}
}

172 
	$ch_vi_»Ëa£
(
fe
 *
f
)

174 
»t
;

175 
ed_tcb_t
 *
vid
;

176 
tw_ch_vi
 *
tvi
 = (tw_ch_v˜*)
f
->
´iv©e_d©a
;

178 
tc_Œaû
;

179 
	`down
(&
tvi
->
£m
);

180 
vid
 = 
tvi
->
tsd
.
³d
;

181 
»t
 = 
vid
->
İ
->
	`şo£
(vid);

182 
	`D–‘eFÜFœeTim”Job
(
tvi
->
tim”_id
);

184 
	`up
(&
tvi
->
£m
);

186 
f
->
´iv©e_d©a
 = 
NULL
;

187  
»t
;

188 
	}
}

192 
	$ch_vi_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

194 
mask
 = 0;

212  
mask
;

213 
	}
}

218 
	$ch_vi_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

220 
»t
=0;

221 
tw_ch_vi
 *
tvi
;

223 
tc_Œaû
;

224 
tvi
 = 
	`kz®loc
((*tvi),
GFP_KERNEL
);

225 if(
NULL
 =ğ
tvi
)

226  -
ENOMEM
;

227 *
tsd
 = &
tvi
->tsd;

229 
tvi
->
tsd
.
ş—n_up
 = 
tvi_ş—nup
;

236 
tvi
->
Çme
 = "tw5864-audio_input";

237 
tvi
->
u£rs
 = 1;

240 
	`š™_MUTEX
(&
tvi
->
£m
);

241 
	`š™_wa™queue_h—d
(&
tvi
->
wa™_pŞl
);

242  
»t
;

243 
	}
}

245 
	$ch_vi_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

247 
tw_ch_vi
 *
tvi
;

248 
tc_Œaû
;

250 if(!
tsd
)

252 
tvi
 = 
	`cÚš”_of
(
tsd
,
tw_ch_vi
,tsd);

255 
	`kä“
(
tvi
);

256 
	}
}

259 
tsd_fe_İ”©iÚs
 
	gch_vi_fİs
 = {

260 .
owÃr
 = 
THIS_MODULE
,

261 .
	gš™
 = 
ch_vi_š™
,

262 .
	gde¡Üy
ğ
ch_vi_de¡Üy
,

263 .
	gİ’
 = 
ch_vi_İ’
,

264 .
	g»ad
 = 
ch_vi_»ad
,

265 .
	gwr™e
 = 
ch_vi_wr™e
,

266 .
	gioùl
 = 
ch_vi_ioùl
,

267 .
	g»Ëa£
ğ
ch_vi_»Ëa£
,

268 .
	gpŞl
 = 
ch_vi_pŞl
,

271 
tw_dev_id
 
	gtw_ch_vi_id
 = {

272 .
•obj
 = {

273 .
v’dÜ_id
 = 
TWELL
,

274 .
	gbus_id
 = 1,

275 .
	gch_id
 = 
TW5864
,

276 .
	gfunc_id
 = 0,

277 .
	gty³
 = 
TW_VIDEO_IN
,

278 .
	gkey
 = {0},

280 .
	gv”siÚ
 = 0,

283 
tw_dev_bË_id
 *
	gtvi_bË
 = 
NULL
;

285 
	$tw_ch_vi_š™
(* 
d©a
)

287 
tvi_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

288 if(!
tvi_bË
){

289 
	`dbg
("nØmem iÀ%s\n",
__FUNCTION__
);

290  -
ENOMEM
;

292 
	`INIT_LIST_HEAD
(&
tvi_bË
->
li¡
);

293 
tvi_bË
->
tid
 = &
tw_ch_vi_id
;

294 
tvi_bË
->
İs
 = &
ch_vi_fİs
;

295 
tvi_bË
->
·¿
 = 
d©a
;

296 
	`dbg_•obj_´št
(&
tvi_bË
->
tid
->
•obj
);

297 
	`»gi¡”_tc_deviû
(
tvi_bË
);

299 
	}
}

301 
	$tw_ch_vi_»move
()

303 if(
tvi_bË
)

304 
	`uÄegi¡”_tc_deviû
(
tvi_bË
);

305 
tvi_bË
 = 
NULL
;

306 
	}
}

	@../../tw5864/device_layer/tc_helper.c

1 
	~<tw5864/tc_commÚ.h
>

7 
LIST_HEAD
(
memblock_li¡
);

8 
rwlock_t
 
	gmemblock_lock
 = 
RW_LOCK_UNLOCKED
;

10 
	$memblock_add
(*
±r
, 
size_t
 
size
)

12 
memblock_s
 *
m
;

14 ià(!(
m
 = 
	`kz®loc
((
memblock_s
), 
GFP_KERNEL
)))

15  -
ENOMEM
;

16 
m
->
±r
 =…tr;

17 
m
->
size
 = size;

19 
	`wr™e_lock
(&
memblock_lock
);

20 
	`li¡_add
(&
m
->
li¡
, &
memblock_li¡
);

21 
	`wr™e_uÆock
(&
memblock_lock
);

24 
	}
}

26 
	$memblock_d–
(
memblock_s
 *
m
)

28 
	`wr™e_lock
(&
memblock_lock
);

29 
	`li¡_d–
(&
m
->
li¡
);

30 
	`wr™e_uÆock
(&
memblock_lock
);

31 
	`kä“
(
m
);

32 
	}
}

34 
memblock_s
 *
	$memblock_g‘
(*
±r
)

36 
li¡_h—d
 *
l
;

37 
memblock_s
 *
m
;

39 
	`»ad_lock
(&
memblock_lock
);

40 
	`li¡_fÜ_—ch
(
l
, &
memblock_li¡
) {

41 
m
 = 
	`li¡_’Œy
(
l
, 
memblock_s
, 
li¡
);

42 ià(
m
->
±r
 ==…tr) {

44 
	`»ad_uÆock
(&
memblock_lock
);

45  
m
;

48 
	`»ad_uÆock
(&
memblock_lock
);

49  
NULL
;

50 
	}
}

53 *
	$tc_m®loc
(
size_t
 
size
)

55 *
±r
;

57 ià(!(
±r
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
)))

58  
NULL
;

59 ià(
	`memblock_add
(
±r
, 
size
)) {

60 
	`kä“
(
±r
);

61  
NULL
;

63  
±r
;

64 
	}
}

66 
	$tc_ä“
(*
±r
)

68 
memblock_s
 *
m
;

70 ià(!
±r
)

72 ià(!(
m
 = 
	`memblock_g‘
(
±r
))) {

73 
	`´štk
(
KERN_ERR
 "bug: free‚on-exist memory\n");

76 
	`memblock_d–
(
m
);

77 
	`kä“
(
±r
);

78 
	}
}

84 *
	$tc_»®loc
(*
±r
, 
size_t
 
size
)

86 
memblock_s
 *
m
;

87 *
Ãw
 = 
NULL
;

89 ià(
±r
) {

90 ià(!(
m
 = 
	`memblock_g‘
(
±r
))) {

91 
	`´štk
(
KERN_ERR
 "bug:„ealloc‚on-exist memory\n");

92  
NULL
;

95 ià(
size
 < 
m
->size){

96 
	`´štk
(
KERN_ERR
 "bug:„ealloc‚ot support small„ealloc\n");

97  
NULL
;

99 ià(
size
 =ğ
m
->size)

100  
±r
;

101 ià(
size
 != 0) {

102 ià(!(
Ãw
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
)))

103  
NULL
;

104 
	`memmove
(
Ãw
, 
±r
, 
m
->
size
);

105 ià(
	`memblock_add
(
Ãw
, 
size
)) {

106 
	`kä“
(
Ãw
);

107  
NULL
;

111 
	`memblock_d–
(
m
);

112 
	`kä“
(
±r
);

114 ià(
size
 != 0) {

115 ià(!(
Ãw
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
)))

116  
NULL
;

117 ià(
	`memblock_add
(
Ãw
, 
size
)) {

118 
	`kä“
(
Ãw
);

119  
NULL
;

124  
Ãw
;

125 
	}
}

127 
EXPORT_SYMBOL
(
tc_»®loc
);

	@../../tw5864/device_layer/tc_jpeg_en.c

1 
	~<tw5864/tc_commÚ.h
>

4 
	$´št_j³g_äame_h—d”
(* 
±
)

6 
idx
 =0;

7 ;
idx
 < 7; idx++)

8 
	`dbg
("<0x%02X>",*
±
++);

9 
	`dbg
("\n");

10 
	}
}

13 
	$j³g_g©h”_sÿ‰”_šfo
(
tw_vb_äame_tcb_t
 * 
vjf
,
tc_bufãr_k”n
 *
tck
)

15 
tw_vb_·ck‘_tcb_queue_t
 *
vpq
 = &
vjf
->
vb_·ck‘_queue
;

16 
tw_vb_·ck‘_tcb_t
 *
vp
 = 
NULL
;

17 
idx
 = 0,
»t
 = 0;

19 
vpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vpq)){

20 
vpq
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(vpq);

21 
vp
 = 
vpq
->
cu¼_cÚsum”
;

22 if(
vp
){

23 
vp
->
İ
->
	`»ã»nû
(vp,(
tw_vb_·ck‘_tcb_t
 **)&
tck
->
sg
[
idx
].
ÿ¼›r
);

24 
tck
->
sg
[
idx
].
addr
 = (
__u32
 *)
vp
->
d©a
;

25 
tck
->
sg
[
idx
].
Ën
 = 
vp
->
·ylßd_Ën
;

26 
»t
 +ğ
vp
->
·ylßd_Ën
;

29 
vpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vpq,
vjf
->
poŞ
);

30 
idx
++;

31 if(
idx
 >ğ
SCATTRT_MAX_ENTRY
)

36 
	`dbg
("can‚ot gather‡ll…ackages for one frame!\n");

40  
»t
;

41 
	}
}

44 
	$vje_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
, 
tc_bufãr
 
__u£r
 *
tc
)

46 
tc_bufãr_k”n
 *
tck
,*
tmp
;

47 
tw_j³g_’
 * 
tje
 = (tw_j³g_’ *)
´iv
;

48 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

49 
tw_vb_äame_tcb_queue_t
 *
vfq
 = &
driv
->
j³g_äame_queue
;

50 
tw_vb_äame_tcb_t
 *
vjf
 = 
NULL
;

51 
bufãr_Ãed
 = 
PAGE_SIZE
;

52 
Ä_»ady
,
Ä_h—d”
,
idx
,
us
 = 
tc
->
__tc__size
;

53 
tc_h—d”_buf
 *
thb
;

54 
off
 = 0;

55 
no£n£
;

58 
tmp
 = 
tq
->
bufs
[0];

59 if((
STATE_READY
 =ğ
	`g‘_tck_¡©e
(
tmp
)è&& (0 !ğtmp->
Ï¡_´•¬e
)){

60 
tc
->
__tc__Ä_äame
 = 1;

62 if(
tmp
->
Ï¡_´•¬e
 > 
us
){

63 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

64  -
ENOMEM
;

66 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

67 
tmp
->
Ï¡_´•¬e
 = 0;

71 
»Œy
:

72 
Ä_»ady
 = 
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq);

74 
thb_poŞ
->
İ
->
	`g‘_h—d”_buf
Ñhb_poŞ,&
thb
);

75 if(!
thb
){

76 
	`dbg
("g‘ h—d”_bufã¸nÙhšg iÀ%s!\n",
__FUNCTION__
);

77  -
EAGAIN
;

79 
Ä_h—d”
 = 
	`round_low
(
thb
->
un™_size
,
MIN_HEADER_LEN_JPEG
);

80 
Ä_»ady
 = 
	`tc_mš
Òr_»ady,
Ä_h—d”
);

81 
Ä_»ady
 = 
	`tc_mš
Òr_»ady, 
tq
->
buf_Ä
);

82 
tc
->
__tc__Ä_äame
 = 0;

83 
idx
 = 0; idx < 
Ä_»ady
; idx++){

84 
vjf
 = 
NULL
;

85 if(!
vfq
->
cu¼_cÚsum”
){

86 
vfq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(vfq);

87 if(!
vfq
->
cu¼_cÚsum”
){

88 
	`dbg
("cÚsum” i NULL %s;\n",
__FUNCTION__
);

89 
tc
->
__tc__size
 = 
bufãr_Ãed
;

90 if(
PAGE_SIZE
 !ğ
tc
->
__tc__size
){

94 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

95  -
EAGAIN
;

100 if(
tje
->
disÿrd
){

101 
vfq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vfq,&
driv
->
poŞ
);

102 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

103 
tje
->
disÿrd
 = 0;

104 
»Œy
;

107 
vfq
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(vfq->cu¼_cÚsum”,&
vjf
);

108 
vfq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vfq,&
driv
->
poŞ
);

110 
tck
 = 
tq
->
bufs
[
idx
];

112 
tck
->
šdex
 = 
idx
;

113 
tck
->
ty³
 = 
MEM_MMAP
;

114 
tck
->
thb
 =hb;

115 
tck
->
hŞd”
 = 
vjf
;

116 
tck
->
size
 = 
vjf
->
äame_Ën
;

118 if((
bufãr_Ãed
 + 
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
)è> 
us
){

119 if(0 =ğ
idx
){

120 
tc
->
__tc__size
 = 
bufãr_Ãed
 + 
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
);

121 
tc
->
__tc__Ä_äame
 = 1;

122 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

123 
no£n£
 = 
	`j³g_g©h”_sÿ‰”_šfo
(
vjf
,
tck
);

124 
	`tc_bufãr_£t_j³g_d©a
((
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
vjf
,&
off
);

125 
tmp
->
Ï¡_´•¬e
 = 
tc
->
__tc__size
;

126 
	`dbg
("user buffer isoo smaller!\n");

127  -
ENOMEM
;

130 
vjf
->
İ
->
	`»ã»nû
(vjf,&
vfq
->
cu¼_cÚsum”
);

131 
vjf
->
İ
->
	`»Ëa£
(&vjf,&
driv
->
poŞ
);

132 
tck
->
hŞd”
 = 
NULL
;

136 
bufãr_Ãed
 +ğ
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
);

137 
tc
->
__tc__size
 = 
bufãr_Ãed
;

138 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

139 
no£n£
 = 
	`j³g_g©h”_sÿ‰”_šfo
(
vjf
,
tck
);

140 
	`tc_bufãr_£t_j³g_d©a
((
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
vjf
,&
off
);

141 
tc
->
__tc__Ä_äame
++;

145 
	}
}

147 
	$vje_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

149 
»t
 = 0,
idx
,
ú
 = 0;

150 
tw_j³g_’
 * 
tje
 = (tw_j³g_’ *)
´iv
;

151 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

152 
tw_vb_poŞ_t
 *
vjpoŞ
 = &
driv
->
poŞ
;

153 
tw_vb_·ck‘_tcb_t
 *
vp
 = 
NULL
;

154 
tw_vb_äame_tcb_t
 *
vf
 = 
NULL
;

155 
tc_bufãr_k”n
 *
tck
 = 
tq
->
bufs
[0];

159 if(!
tck
->
thb
 || !tck->
hŞd”
){

160 
	`dbg
("šv®id…¬am‘” šck! -->%s\n",
__FUNCTION__
);

161  -
EINVAL
;

163 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
tck
->
thb
);

165 (
tck
 = 
tq
->
bufs
[
ú
]è&& (
STATE_BUSY
 =ğ
	`g‘_tck_¡©e
(tck))){

166 
idx
 = 0;

168 
tck
->
sg
[
idx
].
ÿ¼›r
 &&ck->sg[idx].
addr
 &&ck->sg[idx].
Ën
){

169 
vp
 = (
tw_vb_·ck‘_tcb_t
 *)
tck
->
sg
[
idx
].
ÿ¼›r
;

170 
vp
->
İ
->
	`»Ëa£
(&vp,
vjpoŞ
);

171 
	`mem£t
(&
tck
->
sg
[
idx
],0,(
tc_sÿ‰”
));

172 
idx
++;

173 if(
idx
 >ğ
SCATTRT_MAX_ENTRY
)

177 
vf
 = (
tw_vb_äame_tcb_t
 *)
tck
->
hŞd”
;

178 
vf
->
İ
->
	`»Ëa£
(&vf,
vjpoŞ
);

179 
	`£t_tck_¡©e
(
tck
,
STATE_FREE
);

180 
ú
++;

181 if(
ú
 >ğ
tq
->
buf_Ä
)

185  
»t
;

186 
	}
}

188 
tc_queue_İs
 
	gvje_queue_İs
 =

190 .
buf_´•¬e
 = 
vje_buf_´•¬e
,

191 .
	gbuf_»Ëa£
 = 
vje_buf_»Ëa£
,

195 
	$j³g_’_»que¡_memÜy
(
fe
 *
f
,
¬g
)

197 
»t
 = 0;

198 
tc_bufãr
 *
tc
 = (tc_bufã¸*)
¬g
;

199 
tw_j³g_’
 * 
tje
 = (tw_j³g_’ *)
f
->
´iv©e_d©a
;

200 
tc_queue
 *
q
 = 
tje
->
tsd
.
queue
;

204 
	`down
(&
tje
->
£m
);

205 #ifdeà
STATIC_COUNTING


208 if(!
q
->
İs
){

209 
	`dbg
("tq has‚o ops!\n");

210 
»t
 = 
EINVAL
;

211 
out
;

213 if(!
q
->
İs
->
buf_´•¬e
){

214 
	`dbg
("tq->ops has‚o buf_prepare!\n");

215 
»t
 = 
EINVAL
;

216 
out
;

218 
»t
 = 
q
->
İs
->
	`buf_´•¬e
(q,
tje
,
tc
);

219 
out
:

220 
	`up
(&
tje
->
£m
);

221  
»t
;

222 
	}
}

225 
	$j³g_’_»Ëa£_memÜy
(
fe
 *
f
,
¬g
)

227 
»t
 = 0;

228 
tw_j³g_’
 * 
tje
 = (tw_j³g_’ *)
f
->
´iv©e_d©a
;

229 
tc_queue
 *
tq
 = 
tje
->
tsd
.
queue
;

230 
tc_bufãr_k”n
 * 
tck
;

232 
	`down
(&
tje
->
£m
);

233 #ifdeà
STATIC_COUNTING


236 
tck
 = 
tq
->
bufs
[0];

237 if(!
tq
->
İs
 || !tq->İs->
buf_»Ëa£
){

238 
	`dbg
("no ops or‚o buf_release!\n");

239 
»t
 = 
EINVAL
;

240 
out
;

244 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
tje
,
tck
);

248 
out
:

249 
	`up
(&
tje
->
£m
);

250  
»t
;

251 
	}
}

256 
	$tje_ş—nup
(* 
¬g
)

258 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
¬g
;

260 
tc_Œaû
;

261 
	`tc_queue_»Ëa£
(
tje
->
tsd
.
queue
);

262 
	`kä“
(
tje
);

264 
	}
}

279 
	$tc_j³g_’_pŞlšg
(*
p
)

281 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
p
;

282 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

283 
tw_vb_äame_tcb_queue_t
 *
vfq
 = &
driv
->
j³g_äame_queue
;

285 
Ä
 = 
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq);

286 if(
Ä
)

288 
	`wake_up
(&
tje
->
wa™_pŞl
);

295 
	}
}

297 
	$j³g_’_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

299 
»t
 = 0;

300 
ed_tcb_t
 *
j³d
;

301 
tw_j³g_’
 *
tje
 = 
	`cÚš”_of
(
tsd
,tw_jpeg_en,tsd);

302 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

313 if(!
tje
->
tsd
.
³d
){

314 
	`dbg
("jpeg has‚o driver‡ttached!\n");

317 
tje
->
tim”_id
 = 
	`AddFÜFœeTim”Job
(12,
tc_j³g_’_pŞlšg
,tje);

318 if(
tje
->
tim”_id
 =ğ
ADDJOBERROR
){

319 
	`´štk
("š % addim” job faed!\n",
__FUNCTION__
);

320 
»t
 = -1;

321  
»t
;

323 
j³d
 = 
tje
->
tsd
.
³d
;

324 
»t
 = 
j³d
->
İ
->
	`İ’
(&
driv
->
İ’ed_logic_chª_ed
);

325 if(
»t
 !ğ
TW_OK
){

326 
	`´štk
("š % audio_driv” o³Àçed!\n",
__FUNCTION__
);

327 
»t
 = -1;

328  
»t
;

330 
f
->
´iv©e_d©a
 = 
tje
;

333  
»t
;

334 
	}
}

338 
ssize_t
 
	$j³g_’_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

340 
ssize_t
 
off£t
 = 0;

341 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
f
->
´iv©e_d©a
;

342 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

343 
tw_vb_poŞ_t
 *
vjpoŞ
 = &
driv
->
poŞ
;

344 
tw_vb_äame_tcb_queue_t
 *
vjq
 = &
driv
->
j³g_äame_queue
;

345 
tw_vb_äame_tcb_t
 *
vjf
 = 
NULL
;

346 
size_t
 
ú
 = 
couÁ
;

347 
size_t
 
mš
 = (
tw_äame_h—d”_t
è+ 
vjpoŞ
->
vb_·ck‘_bufãr_size
;

348 
loff_t
 
äame_off£t
;

351 
	`down
(&
tje
->
£m
);

352 
ú
 > 
mš
)

354 
vjq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(vjq);

355 
vjf
 = 
vjq
->
cu¼_cÚsum”
;

356 if(
vjf
){

357 
äame_off£t
 = 0;

358 
vjf
->
İ
->
	`subm™
(vjf,&
buff
[
off£t
],
ú
,&
äame_off£t
,
TW_MASTER_BITSTREAM
,
vjpoŞ
);

359 
vjq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vjq,
vjpoŞ
);

360 
off£t
 +ğ
äame_off£t
;

361 
ú
 -ğ
äame_off£t
;

366 
	`dbg
("ÿÀnÙ g‘ cunsum” iÀ%s\n",
__FUNCTION__
);

367 
out
;

370 
out
:

371 
	`up
(&
tje
->
£m
);

372 *
lof
 = 
off£t
;

373 
	`dbg
("»ad %d by‹s\n",
off£t
);

374  
off£t
;

375 
	}
}

379 
ssize_t
 
	$j³g_’_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

382 
	}
}

384 
	$j³g_’_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

386 
»t
 = 0;

387 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
f
->
´iv©e_d©a
;

388 
’dpošt_tcb
 *
ed
;

389 
tc_queue
 *
tq
 = 
tje
->
tsd
.
queue
;

390 
tc_bufãr_k”n
 * 
tck
;

393 
cmd
)

395 
TW_CODEC_CHAN_REQUEST_MEM
:

396 
»t
 = 
	`j³g_’_»que¡_memÜy
(
f
,
¬g
);

398 
TW_CODEC_CHAN_RELEASE_MEM
:

399 
»t
 = 
	`j³g_’_»Ëa£_memÜy
(
f
,
¬g
);

401 
TW_CODEC_CHAN_DISCAED_FRAME
:

402 
tje
->
disÿrd
 = 1;

403 
	`£t_tq_¡©e_busy
(
tq
);

404 
tck
 = 
tq
->
bufs
[0];

405 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
tje
,
tck
);

406 if(
»t
)

407 
	`´štk
("disÿrd f¿m---»Ëa£ faed! iÀ%s\n",
__FUNCTION__
);

410 
	`dbg
("Ùh” cmd iÀ%s\n",
__FUNCTION__
);

411 if(!
tje
->
tsd
.
³d
){

412 
	`´štk
("the device has‚o driverƒd!\n");

413 
»t
 = 
EFAULT
;

416 
ed
 = 
tje
->
tsd
.
³d
;

417 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

421  
»t
;

422 
	}
}

427 
	$j³g_’_»Ëa£
(
fe
 *
f
)

429 
»t
;

430 
ed_tcb_t
 *
j³d
;

431 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
f
->
´iv©e_d©a
;

434 
tc_Œaû
;

435 
	`down
(&
tje
->
£m
);

436 
	`tc_queue_»£t
(
tje
->
tsd
.
queue
);

437 
j³d
 = 
tje
->
tsd
.
³d
;

438 
»t
 = 
j³d
->
İ
->
	`şo£
(jped);

439 
	`D–‘eFÜFœeTim”Job
(
tje
->
tim”_id
);

441 
	`up
(&
tje
->
£m
);

442 
f
->
´iv©e_d©a
 = 
NULL
;

443  
»t
;

444 
	}
}

448 
	$j³g_’_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

450 
mask
 = 0;

451 
tw_j³g_’
 *
tje
 = (tw_j³g_’ *)
fe
->
´iv©e_d©a
;

452 
tw_j³g_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tje
->
tsd
.
³d
,tw_j³g_logic_’code_chª, 
İ’ed_logic_chª_ed
);

453 
tw_vb_äame_tcb_queue_t
 *
vfq
 = &
driv
->
j³g_äame_queue
;

455 
	`down
(&
tje
->
£m
);

458 
	`pŞl_wa™
(
fe
,&
tje
->
wa™_pŞl
,
wa™
);

459 if(
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq))

460 
mask
 |ğ
POLLIN
 | 
POLLRDNORM
;

461 
	`up
(&
tje
->
£m
);

462  
mask
;

463 
	}
}

468 
	$j³g_’_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

471 
tw_j³g_’
 *
tje
;

474 
tje
 = 
	`kz®loc
((*tje),
GFP_KERNEL
);

475 if(
NULL
 =ğ
tje
)

476  -
ENOMEM
;

477 *
tsd
 = &
tje
->tsd;

479 
tje
->
tsd
.
ş—n_up
 = 
tje_ş—nup
;

480 
tje
->
tsd
.
queue
 = 
	`kz®loc
((
tc_queue
),
GFP_KERNEL
);

481 if(
NULL
 =ğ
tje
->
tsd
.
queue
)

482  -
ENOMEM
;

484 
	`tc_queue_š™
(
tje
->
tsd
.
queue
,&
vje_queue_İs
,
NULL
,512*1024,10,tje);

485 
tje
->
Çme
 = "tw5864_jpeg_encoder";

486 
tje
->
u£rs
 = 1;

489 
	`š™_MUTEX
(&
tje
->
£m
);

490 
	`š™_wa™queue_h—d
(&
tje
->
wa™_pŞl
);

492 
	}
}

494 
	$j³g_’_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

496 
tw_j³g_’
 *
tje
;

497 
tc_Œaû
;

499 if(!
tsd
)

501 
tje
 = 
	`cÚš”_of
(
tsd
,
tw_j³g_’
,tsd);

502 if(
tje
->
tsd
.
queue
)

503 
	`kä“
(
tje
->
tsd
.
queue
);

504 
	`kä“
(
tje
);

505 
	}
}

509 
tsd_fe_İ”©iÚs
 
	gj³g_’_fİs
 = {

510 .
owÃr
 = 
THIS_MODULE
,

511 .
	gš™
 = 
j³g_’_š™
,

512 .
	gde¡Üy
ğ
j³g_’_de¡Üy
,

513 .
	gİ’
 = 
j³g_’_İ’
,

514 .
	g»ad
 = 
j³g_’_»ad
,

515 .
	gwr™e
 = 
j³g_’_wr™e
,

516 .
	gioùl
 = 
j³g_’_ioùl
,

517 .
	g»Ëa£
ğ
j³g_’_»Ëa£
,

518 .
	gpŞl
 = 
j³g_’_pŞl
,

521 
tw_dev_id
 
	gtw_j³g_’_id
 = {

522 .
•obj
 = {

523 .
v’dÜ_id
 = 
TWELL
,

524 .
	gbus_id
 = 1,

525 .
	gch_id
 = 
TW5864
,

526 .
	gfunc_id
 = (
STREAM_TYPE_MAJOR
 << 16è| 
CODEC_VIDEO_MJPG
,

527 .
	gty³
 = 
TW_ENCODER
,

528 .
	gkey
 = {0},

530 .
	gv”siÚ
 = 0,

536 
tw_dev_bË_id
 *
	gtje_bË
 = 
NULL
;

540 
	$tw_j³g_’_š™
(* 
d©a
)

542 
»t
 = 0;

543 
tje_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

544 if(!
tje_bË
){

545 
	`dbg
("nØmem iÀ%s\n",
__FUNCTION__
);

546  -
ENOMEM
;

548 
	`INIT_LIST_HEAD
(&
tje_bË
->
li¡
);

549 
tje_bË
->
tid
 = &
tw_j³g_’_id
;

550 
tje_bË
->
İs
 = &
j³g_’_fİs
;

551 
tje_bË
->
·¿
 = 
d©a
;

553 
»t
 = 
	`»gi¡”_tc_deviû
(
tje_bË
);

554  
»t
;

555 
	}
}

560 
	$tw_j³g_’_»move
()

562 if(
tje_bË
)

563 
	`uÄegi¡”_tc_deviû
(
tje_bË
);

564 
tje_bË
 = 
NULL
;

565 
	}
}

	@../../tw5864/device_layer/tc_video_en.c

1 
	~<tw5864/tc_commÚ.h
>

4 
	$´št_äame_h—d”
(* 
±
)

6 
idx
 =0;

7 ;
idx
 < 48; idx++){

8 if(0 =ğ(
idx
%16))

9 
	`dbg
("\n\n");

10 
	`dbg
("<0x%02X>,",*
±
++);

12 
	`dbg
("\n\n");

13 
	}
}

16 
	$g©h”_sÿ‰”_šfo
(
tw_video_äame_tcb_t
 * 
vf
,
tc_bufãr_k”n
 *
tck
)

18 
tw_video_·ck‘_tcb_queue_t
 *
vpq
 = &
vf
->
video_·ck‘_queue
;

19 
tw_video_·ck‘_tcb_t
 *
vp
 = 
NULL
;

20 
idx
 = 0, 
»t
 = 0;

23 
vpq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vpq)){

24 
vpq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(vpq);

25 
vp
 = 
vpq
->
cu¼_cÚsum”
;

26 if(
vp
){

27 
vp
->
İ
->
	`»ã»nû
(vp,(
tw_video_·ck‘_tcb_t
 **)&
tck
->
sg
[
idx
].
ÿ¼›r
);

28 
tck
->
sg
[
idx
].
addr
 = (
__u32
 *)
vp
->
d©a
;

29 
tck
->
sg
[
idx
].
Ën
 = 
vp
->
·ylßd_Ën
;

30 
»t
 +ğ
vp
->
·ylßd_Ën
;

31 if(!
vf
->
video_chª_buf_poŞ
)

32 
	`dbg
("BUG:…oŞ i NULL! %d\n",
__LINE__
);

34 
vpq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vpq,
vf
->
video_chª_buf_poŞ
);

35 
idx
++;

36 if(
idx
 >ğ
SCATTRT_MAX_ENTRY
)

41 
	`dbg
("can‚ot gather‡ll…ackages for one frame!\n");

45  
»t
;

46 
	}
}

53 
	$ve_buf_´•¬e
(
tc_queue
 * 
tq
, *
´iv
, 
tc_bufãr
 
__u£r
 *
tc
)

55 
tc_bufãr_k”n
 *
tck
,*
tmp
;

56 
tw_video_’
 * 
tve
 = (tw_video_’ *)
´iv
;

57 
tw_h264_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tve
->
tsd
.
³d
,tw_h264_logic_’code_chª, 
İ’ed_logic_chª_ed
);

58 
tw_video_äame_tcb_queue_t
 *
vfq
 = &
driv
->
’code_äame_queue
;

59 
tw_video_äame_tcb_t
 *
vf
 = 
NULL
;

60 
is_ma¡”
 = 0,
bufãr_Ãed
 = 
PAGE_SIZE
;

61 
Ä_»ady
,
Ä_h—d”
,
idx
,
us
 = 
tc
->
__tc__size
,
cix
=0;

62 
tc_h—d”_buf
 *
thb
 = 
NULL
;

63 
off
 = 0,
no£n£
;

65 
tmp
 = 
tq
->
bufs
[0];

66 
is_ma¡”
 = (
	`g‘_¡»am_äom_•obj
(&
tve
->
tsd
.
•obj
è=ğ
STREAM_TYPE_MAJOR
)? 1: 0;

67 if((
STATE_READY
 =ğ
	`g‘_tck_¡©e
(
tmp
)è&& (0 !ğtmp->
Ï¡_´•¬e
)){

69 
tc
->
__tc__Ä_äame
 = 1;

70 if(
tmp
->
Ï¡_´•¬e
 > 
us
){

71 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

72  -
ENOMEM
;

74 
tc
->
__tc__size
 = 
tmp
->
Ï¡_´•¬e
;

75 
tmp
->
Ï¡_´•¬e
 = 0;

79 
»Œy
:

80 
Ä_»ady
 = 
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq);

81 
thb_poŞ
->
İ
->
	`Œy_g‘_h—d”_buf
Ñhb_poŞ,&
thb
);

82 if(!
thb
){

83 
	`dbg
("g‘ h—d”_bufã¸nÙhšg iÀ%s!\n",
__FUNCTION__
);

84  -
EAGAIN
;

86 
Ä_h—d”
 = 
	`round_low
(
thb
->
un™_size
,
MIN_HEADER_LEN_VIDEO
);

87 
Ä_»ady
 = 
	`tc_mš
Òr_»ady,
Ä_h—d”
);

88 
Ä_»ady
 = 
	`tc_mš
Òr_»ady, 
tq
->
buf_Ä
);

89 
tc
->
__tc__Ä_äame
 = 0;

90 
idx
 = 0; idx < 
Ä_»ady
; idx++){

91 
vf
 = 
NULL
;

92 if(!
vfq
->
cu¼_cÚsum”
){

93 
vfq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(vfq);

94 if(!
vfq
->
cu¼_cÚsum”
){

95 
	`dbg
("cÚsum” i NULL %s;\n",
__FUNCTION__
);

96 
tc
->
__tc__size
 = 
bufãr_Ãed
;

97 if(
PAGE_SIZE
 !ğ
tc
->
__tc__size
){

101 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

102  -
EAGAIN
;

106 if(
tve
->
disÿrd
){

107 if(
H264_FRAME_TYPE_IDR
 !ğ
vfq
->
cu¼_cÚsum”
->
äame_ty³
)

109 
	`´štk
("disÿrd f¿m%°\n",
vfq
->
cu¼_cÚsum”
);

110 
vfq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vfq,&
driv
->
’code_chª_buf_poŞ
);

111 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
thb
);

112 
»Œy
;

116 
tve
->
disÿrd
 = 0;

120 
vfq
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(vfq->cu¼_cÚsum”,&
vf
);

121 
vfq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vfq,&
driv
->
’code_chª_buf_poŞ
);

122 
tck
 = 
tq
->
bufs
[
idx
];

123 if(
	`g‘_tck_¡©e
(
tck
è=ğ
STATE_READY
){

124 
	`dbg
("BUG:%s,%d\n",
__FUNCTION__
,
__LINE__
);

125  -
EINVAL
;

128 
tck
->
šdex
 = 
idx
;

129 
tck
->
ty³
 = 
MEM_MMAP
;

130 
tck
->
thb
 =hb;

131 
tck
->
hŞd”
 = 
vf
;

132 if(
H264_FRAME_TYPE_IDR
 =ğ
vf
->
äame_ty³
)

133 
tck
->
size
 = 
vf
->
äame_Ën
 + vf->
Çl
.
¥s_·ysize
 + vf->Çl.
µs_·ysize
;

135 
tck
->
size
 = 
vf
->
äame_Ën
;

137 if((
bufãr_Ãed
 + 
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
)è> 
us
){

138 if(0 =ğ
idx
){

139 
tc
->
__tc__size
 = 
bufãr_Ãed
 + 
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
);

140 
tc
->
__tc__Ä_äame
 = 1;

141 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

142 
no£n£
 = 
	`g©h”_sÿ‰”_šfo
(
vf
,
tck
);

143 
	`tc_bufãr_£t_h264_d©a
(
is_ma¡”
,(
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
vf
,&
off
);

144 
tmp
->
Ï¡_´•¬e
 = 
tc
->
__tc__size
;

145  -
ENOMEM
;

148 
vf
->
İ
->
	`»ã»nû
(vf,&
vfq
->
cu¼_cÚsum”
);

149 
vf
->
İ
->
	`»Ëa£
(&vf,&
driv
->
’code_chª_buf_poŞ
);

150 
tck
->
hŞd”
 = 
NULL
;

154 
bufãr_Ãed
 +ğ
	`tc_®ign_up
(
tck
->
size
,
PAGE_SIZE
);

155 
tc
->
__tc__size
 = 
bufãr_Ãed
;

156 
	`£t_tck_¡©e
(
tck
,
STATE_READY
);

157 
no£n£
 = 
	`g©h”_sÿ‰”_šfo
(
vf
,
tck
);

158 
	`tc_bufãr_£t_h264_d©a
(
is_ma¡”
,(
tc_bufãr
 *)(
thb
->
d©a
),
tck
,
vf
,&
off
);

159 
tc
->
__tc__Ä_äame
++;

163 
	}
}

168 
	$ve_buf_»Ëa£
(
tc_queue
 * 
tq
, * 
´iv
, 
tc_bufãr_k”n
 *
tb
)

170 
»t
 = 0,
idx
,
ú
 = 0;

171 
tw_video_’
 * 
tve
 = (tw_video_’ *)
´iv
;

172 
tw_h264_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tve
->
tsd
.
³d
,tw_h264_logic_’code_chª, 
İ’ed_logic_chª_ed
);

173 
tw_video_chª_buf_poŞ_t
 *
vdpoŞ
 = &
driv
->
’code_chª_buf_poŞ
;

174 
tw_video_äame_tcb_t
 *
vf
 = 
NULL
;

175 
tw_video_·ck‘_tcb_t
 *
vp
 = 
NULL
;

176 
tc_bufãr_k”n
 *
tck
 = 
tq
->
bufs
[0];

179 if(!
tck
->
thb
 || !tck->
hŞd”
){

180 
	`dbg
("šv®id…¬am‘” šck! -->%s\n",
__FUNCTION__
);

181  -
EINVAL
;

183 
thb_poŞ
->
İ
->
	`put_h—d”_buf
Ñhb_poŞ,
tck
->
thb
);

185 (
tck
 = 
tq
->
bufs
[
ú
]è&& (
STATE_BUSY
 =ğ
	`g‘_tck_¡©e
(tck))){

186 
idx
 = 0;

188 
tck
->
sg
[
idx
].
ÿ¼›r
 &&ck->sg[idx].
addr
 &&ck->sg[idx].
Ën
){

189 
vp
 = (
tw_video_·ck‘_tcb_t
 *)
tck
->
sg
[
idx
].
ÿ¼›r
;

190 if(!
vp
->
İ
 || !vp->İ->
»Ëa£
){

191 
	`´štk
("BUG: iÀ%  %d----@@@\n",
__FUNCTION__
,
__LINE__
);

192  -
EINVAL
;

194 if(!
vdpoŞ
){

195 
	`dbg
("encode_chan_buf_pool is NULL!\n");

196  -
EINVAL
;

198 
vp
->
İ
->
	`»Ëa£
(&vp,
vdpoŞ
);

199 
	`mem£t
(&
tck
->
sg
[
idx
],0,(
tc_sÿ‰”
));

200 
idx
++;

201 if(
idx
 >ğ
SCATTRT_MAX_ENTRY
)

205 
vf
 = (
tw_video_äame_tcb_t
 *)
tck
->
hŞd”
;

206 if(!
vf
->
İ
 || !vf->İ->
»Ëa£
){

207 
	`´štk
("BUG: iÀ%  %d----@@@\n",
__FUNCTION__
,
__LINE__
);

208  -
EINVAL
;

210 
vf
->
İ
->
	`»Ëa£
(&vf,
vdpoŞ
);

211 
	`£t_tck_¡©e
(
tck
,
STATE_FREE
);

212 
ú
++;

213 if(
ú
 >ğ
tq
->
buf_Ä
)

216  
»t
;

217 
	}
}

219 
tc_queue_İs
 
	gve_queue_İs
 =

221 .
buf_´•¬e
 = 
ve_buf_´•¬e
,

222 .
	gbuf_»Ëa£
 = 
ve_buf_»Ëa£
,

226 
	$h264_’_»que¡_memÜy
(
fe
 *
f
,
¬g
)

228 
»t
 = 0;

230 
tc_bufãr
 *
tc
 = (tc_bufã¸*)
¬g
;

231 
tw_video_’
 * 
tve
 = (tw_video_’ *)
f
->
´iv©e_d©a
;

232 
tc_queue
 *
q
 = 
tve
->
tsd
.
queue
;

236 
	`down
(&
tve
->
£m
);

237 #ifdeà
STATIC_COUNTING


238 
	`g‘_loİ_¡¬t
((
tw_£rviû_deviû
 *)&
tve
->
tsd
);

240 if(!
q
->
İs
){

241 
	`TW_DBG
(
TW_DBG_ERR
,"tq has‚o ops!\n");

242 
»t
 = 
EINVAL
;

243 
out
;

245 if(!
q
->
İs
->
buf_´•¬e
){

246 
	`TW_DBG
(
TW_DBG_ERR
,"tq->ops has‚o buf_prepare!\n");

247 
»t
 = 
EINVAL
;

248 
out
;

250 
»t
 = 
q
->
İs
->
	`buf_´•¬e
(q,
tve
,
tc
);

251 #ifdeà
STATIC_COUNTING


252 
	`ÿlc_ic_»q_time
((
tw_£rviû_deviû
 *)&
tve
->
tsd
);

254 
out
:

255 
	`up
(&
tve
->
£m
);

257  
»t
;

258 
	}
}

264 
	$h264_’_»Ëa£_memÜy
(
fe
 *
f
,
¬g
)

266 
»t
 = 0;

267 
tw_video_’
 * 
tve
 = (tw_video_’ *)
f
->
´iv©e_d©a
;

268 
tc_queue
 *
tq
 = 
tve
->
tsd
.
queue
;

269 
tc_bufãr_k”n
 * 
tck
;

271 
	`down
(&
tve
->
£m
);

272 #ifdeà
STATIC_COUNTING


273 
	`g‘_ic_»l_¡¬t
((
tw_£rviû_deviû
 *)&
tve
->
tsd
);

275 
tck
 = 
tq
->
bufs
[0];

276 if(!
tq
->
İs
 || !tq->İs->
buf_»Ëa£
){

277 
	`TW_DBG
(
TW_DBG_ERR
,"no ops or‚o buf_release!\n");

278 
»t
 = 
EINVAL
;

279 
out
;

283 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
tve
,
tck
);

287 #ifdeà
STATIC_COUNTING


288 
	`ÿlc_ic_»l_time
((
tw_£rviû_deviû
 *)&
tve
->
tsd
);

289 
	`g‘_loİ_’d
((
tw_£rviû_deviû
 *)&
tve
->
tsd
);

291 
out
:

292 
	`up
(&
tve
->
£m
);

293  
»t
;

294 
	}
}

299 
	$tve_ş—nup
(* 
¬g
)

301 
tw_video_’
 *
tve
 = (tw_video_’ *)
¬g
;

303 
tc_Œaû
;

304 
	`tc_queue_»Ëa£
(
tve
->
tsd
.
queue
);

305 
	`kä“
(
tve
);

307 
	}
}

310 
tw_h264_logic_’code_chª_t
 * 
	$lookup_video_drive_š¡ªû
(
tw_£rviû_deviû
 *
tsd
)

312 
tw_h264_logic_’code_chª_t
 *
p
 = 
tsd
->
´iv©e_d©a
;

313 
ld
 = 
	`g‘_phchª_id_äom_•obj
(&
tsd
->
•obj
);

317  &
p
[
ld
];

319 
	}
}

322 
	$video_h264_’_pŞlšg
(*
p
)

324 
tw_video_’
 *
tve
 = (tw_video_’ *)
p
;

325 
tw_h264_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tve
->
tsd
.
³d
,tw_h264_logic_’code_chª, 
İ’ed_logic_chª_ed
);

326 
tw_video_äame_tcb_queue_t
 *
vfq
 = &
driv
->
’code_äame_queue
;

329 
Ä
 = 
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq);

330 if(
Ä
)

333 
	`wake_up
(&
tve
->
wa™_pŞl
);

341 
	}
}

343 
	$videoh264_’_İ’
(
tw_£rviû_deviû
 *
tsd
,
fe
 *
f
)

345 
»t
 = 0;

346 
ed_tcb_t
 *
v“d
;

347 
tw_video_’
 *
tve
 = 
	`cÚš”_of
(
tsd
,tw_video_en,tsd);

351 if(!
tve
->
tsd
.
³d
){

352 
	`dbg
("video dev has‚o driver‡ttached!\n");

353 
»t
 = -1;

354  
»t
;

356 
tve
->
tim”_id
 = 
	`AddFÜFœeTim”Job
(12,
video_h264_’_pŞlšg
,tve);

357 if(
tve
->
tim”_id
 =ğ
ADDJOBERROR
){

358 
	`´štk
("š % addim” job faed!\n",
__FUNCTION__
);

359 
»t
 = -1;

360  
»t
;

362 
v“d
 = 
tve
->
tsd
.
³d
;

363 
»t
 = 
v“d
->
İ
->
	`İ’
(veed);

364 if(
»t
 !ğ
TW_OK
){

365 
	`´štk
("š % audio_driv” o³Àçed!\n",
__FUNCTION__
);

366 
»t
 = -1;

367  
»t
;

369 
f
->
´iv©e_d©a
 = 
tve
;

372  
»t
;

373 
	}
}

377 
ssize_t
 
	$videoh264_’_»ad
(
fe
 *
f
,
__u£r
 *
buff
,
size_t
 
couÁ
, 
loff_t
 * 
lof
)

379 
ssize_t
 
off£t
 = 0;

380 
tw_video_’
 *
tve
 = (tw_video_’ *)
f
->
´iv©e_d©a
;

381 
tw_h264_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tve
->
tsd
.
³d
,tw_h264_logic_’code_chª, 
İ’ed_logic_chª_ed
);

382 
tw_video_chª_buf_poŞ_t
 *
vdpoŞ
 = &
driv
->
’code_chª_buf_poŞ
;

383 
tw_video_äame_tcb_queue_t
 *
vfq
 = &
driv
->
’code_äame_queue
;

384 
tw_video_äame_tcb_t
 *
vf
 = 
NULL
;

385 
size_t
 
ú
 = 
couÁ
;

386 
size_t
 
mš
 = (
tw_äame_h—d”_t
è+ 
vdpoŞ
->
video_·ck‘_bufãr_size
;

387 
loff_t
 
äame_off£t
;

390 
	`down
(&
tve
->
£m
);

391 
ú
 > 
mš
)

393 
vfq
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(vfq);

394 
vf
 = 
vfq
->
cu¼_cÚsum”
;

395 if(
vf
){

396 
äame_off£t
 = 0;

397 
vf
->
İ
->
	`subm™
(vf,&
buff
[
off£t
],
ú
,&
äame_off£t
,
TW_MASTER_BITSTREAM
,
vdpoŞ
);

398 
vfq
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vfq,
vdpoŞ
);

399 
off£t
 +ğ
äame_off£t
;

400 
ú
 -ğ
äame_off£t
;

405 
	`TW_DBG
(
TW_DBG_ERR
,"ÿÀnÙ g‘ cunsum” iÀ%s\n",
__FUNCTION__
);

406 
out
;

409 
out
:

410 
	`up
(&
tve
->
£m
);

411 *
lof
 = 
off£t
;

413  
off£t
;

414 
	}
}

418 
ssize_t
 
	$videoh264_’_wr™e
 (
fe
 *
f
, cÚ¡ 
__u£r
 *
buff
, 
size_t
 
couÁ
, 
loff_t
 *
lof
)

421 
	}
}

423 
	$videoh264_’_ioùl
 (
fe
 *
f
, 
cmd
, 
¬g
)

425 
»t
 = 0;

426 
tw_video_’
 *
tve
 = (tw_video_’ *)
f
->
´iv©e_d©a
;

427 
’dpošt_tcb
 *
ed
;

428 
tc_queue
 *
tq
 = 
tve
->
tsd
.
queue
;

429 
tc_bufãr_k”n
 * 
tck
;

434 
cmd
)

436 
TW_CODEC_CHAN_REQUEST_MEM
:

437 
»t
 = 
	`h264_’_»que¡_memÜy
(
f
,
¬g
);

439 
TW_CODEC_CHAN_RELEASE_MEM
:

440 
»t
 = 
	`h264_’_»Ëa£_memÜy
(
f
,
¬g
);

442 
TW_CODEC_CHAN_DISCAED_FRAME
:

443 
tve
->
disÿrd
 = 1;

444 
	`£t_tq_¡©e_busy
(
tq
);

445 
tck
 = 
tq
->
bufs
[0];

446 
»t
 = 
tq
->
İs
->
	`buf_»Ëa£
Ñq,
tve
,
tck
);

447 if(
»t
)

448 
	`´štk
("discard frame ---release failed!\n");

451 
	`TW_DBG
(
TW_DBG_ERR
,"Ùh” cmd iÀ%s\n",
__FUNCTION__
);

452 if(!
tve
->
tsd
.
³d
){

453 
	`´štk
("the device has‚o driverƒd!\n");

454 
»t
 = 
EFAULT
;

457 
ed
 = 
tve
->
tsd
.
³d
;

458 
»t
 = 
ed
->
İ
->
	`ioùl
Ód,
cmd
,
¬g
);

462  
»t
;

463 
	}
}

468 
	$videoh264_’_»Ëa£
(
fe
 *
f
)

470 
»t
;

471 
ed_tcb_t
 *
v“d
;

472 
tw_video_’
 *
tve
 = (tw_video_’ *)
f
->
´iv©e_d©a
;

475 
tc_Œaû
;

476 
	`down
(&
tve
->
£m
);

477 
	`tc_queue_»£t
(
tve
->
tsd
.
queue
);

478 
v“d
 = 
tve
->
tsd
.
³d
;

479 
»t
 = 
v“d
->
İ
->
	`şo£
(veed);

480 
	`D–‘eFÜFœeTim”Job
(
tve
->
tim”_id
);

481 
tve
->
tim”_id
 = 
INVALIDTIMERID
;

483 
	`up
(&
tve
->
£m
);

484 
f
->
´iv©e_d©a
 = 
NULL
;

485  
»t
;

486 
	}
}

490 
	$videoh264_’_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

492 
mask
 = 0;

493 
tw_video_’
 *
tve
 = (tw_video_’ *)
fe
->
´iv©e_d©a
;

494 
tw_h264_logic_’code_chª
 *
driv
 = 
	`cÚš”_of
(
tve
->
tsd
.
³d
,tw_h264_logic_’code_chª, 
İ’ed_logic_chª_ed
);

495 
tw_video_äame_tcb_queue_t
 *
vfq
 = &
driv
->
’code_äame_queue
;

498 
	`down
(&
tve
->
£m
);

501 
	`pŞl_wa™
(
fe
,&
tve
->
wa™_pŞl
,
wa™
);

502 if(
vfq
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vfq))

503 
mask
 |ğ
POLLIN
 | 
POLLRDNORM
;

504 
	`up
(&
tve
->
£m
);

505  
mask
;

506 
	}
}

511 
	$videoh264_’_š™
(
tw_ch_deviû
 *
tcd
,
cmd_¬g
 *
¬g
,
tw_£rviû_deviû
 **
tsd
)

513 
»t
;

514 
tw_video_’
 *
tve
;

516 
tc_Œaû
;

517 
tve
 = 
	`kz®loc
((*tve),
GFP_KERNEL
);

518 if(
NULL
 =ğ
tve
)

519  -
ENOMEM
;

520 
	`dbg
("š™_tve[%8p]\n",
tve
);

521 *
tsd
 = &
tve
->tsd;

523 
tve
->
tsd
.
ş—n_up
 = 
tve_ş—nup
;

524 
tve
->
Çme
 = "tw5864-h264master_encoder";

525 
tve
->
u£rs
 = 1;

528 
	`š™_MUTEX
(&
tve
->
£m
);

529 
	`š™_wa™queue_h—d
(&
tve
->
wa™_pŞl
);

537 
tve
->
tsd
.
queue
 = 
	`kz®loc
((
tc_queue
),
GFP_KERNEL
);

538 if(
NULL
 =ğ
tve
->
tsd
.
queue
)

539  -
ENOMEM
;

541  
	`tc_queue_š™
(
tve
->
tsd
.
queue
,&
ve_queue_İs
,
NULL
,512*1024,10,tve);

542 
	}
}

544 
	$videoh264_’_de¡Üy
(
tw_£rviû_deviû
 *
tsd
)

546 
tw_video_’
 *
tve
;

547 
tc_Œaû
;

549 if(!
tsd
)

551 
tve
 = 
	`cÚš”_of
(
tsd
,
tw_video_’
,tsd);

552 if(
tve
->
tsd
.
queue
)

553 
	`kä“
(
tve
->
tsd
.
queue
);

554 
	`kä“
(
tve
);

555 
	}
}

559 
	$tc_video_’_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,
couÁ
, *
eof
, *
d©a
)

561 
Ën
 = 0;

562 
tw_dev_id
 *
id
 = (tw_dev_id *)
d©a
;

563 
li¡_h—d
 *
p
,*
q
,*
tmp
,*
lh
;

564 
tw_ch_deviû
 *
tcd
;

565 
tw_£rviû_deviû
 *
tsd
;

566 
ty³
 = 
TW_ENCODER
 - 1;

569 
	`lock_chdev
();

570 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en,"%10s %10s %10s %10s %10s\n","req_time", "map_time", "rel_time", "min", "max");

572 
lh
 = 
	`g‘_chdev_li¡h—d
();

573 
	`li¡_fÜ_—ch
(
p
,
lh
){

574 
tcd
 = 
	`cÚš”_of
(
p
,
tw_ch_deviû
, 
li¡
);

575 
tmp
 = &
tcd
->
tsd_li¡
[
ty³
];

576 
	`li¡_fÜ_—ch
(
q
,
tmp
){

577 
tsd
 = 
	`cÚš”_of
(
q
,
tw_£rviû_deviû
,
li¡
);

578 if(
	`•obj_euq®
(&
tsd
->
•obj
,&
id
->epobj)){

579 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%10u %10u %10u %10u %10u\n", 
tsd
->
b_™v®
.
ic_»q_time
,sd->b_™v®.
ic_m­_time
,

580 
tsd
->
b_™v®
.
ic_»l_time
,sd->b_™v®.
mš
,sd->b_™v®.
max
);

584 
	`uÆock_chdev
();

586  
Ën
;

587 
	}
}

598 
tsd_fe_İ”©iÚs
 
	gvideoh264_’_fİs
 = {

599 .
owÃr
 = 
THIS_MODULE
,

600 .
	gš™
 = 
videoh264_’_š™
,

601 .
	gde¡Üy
ğ
videoh264_’_de¡Üy
,

602 .
	gİ’
 = 
videoh264_’_İ’
,

603 .
	g»ad
 = 
videoh264_’_»ad
,

604 .
	gwr™e
 = 
videoh264_’_wr™e
,

605 .
	gioùl
 = 
videoh264_’_ioùl
,

606 .
	g»Ëa£
ğ
videoh264_’_»Ëa£
,

607 .
	gpŞl
 = 
videoh264_’_pŞl
,

610 
tw_dev_id
 
	gtw_videoh264_’_id
 = {

611 .
•obj
 = {

612 .
v’dÜ_id
 = 
TWELL
,

613 .
	gbus_id
 = 1,

614 .
	gch_id
 = 
TW5864
,

615 .
	gfunc_id
 = (
STREAM_TYPE_MAJOR
 << 16è| 
CODEC_VIDEO_H264
,

616 .
	gty³
 = 
TW_ENCODER
,

617 .
	gkey
 = {0},

619 .
	gv”siÚ
 = 0,

624 
tw_dev_id
 
	gtw_videoh264s_’_id
 = {

625 .
•obj
 = {

626 .
v’dÜ_id
 = 
TWELL
,

627 .
	gbus_id
 = 1,

628 .
	gch_id
 = 
TW5864
,

629 .
	gfunc_id
 = (
STREAM_TYPE_MINOR
 << 16è| 
CODEC_VIDEO_H264
,

630 .
	gty³
 = 
TW_ENCODER
,

631 .
	gkey
 = {0},

633 .
	gv”siÚ
 = 0,

637 
tw_dev_bË_id
 *
	gtve_bË
 = 
NULL
;

638 
tw_dev_bË_id
 *
	gtve_sub_bË
 = 
NULL
;

639 
tw_´oc_»gi¡”_s
 *
	gtc_video
 = 
NULL
;

640 
tw_´oc_»gi¡”_s
 *
	gtc_sub_video
 = 
NULL
;

643 
	$tw_videoh264_’_š™
(* 
d©a
)

645 
»t
 = 0;

646 
tw_h264_logic_’code_chª
 *
h264
 = (tw_h264_logic_’code_chª *)
d©a
;

647 
dvm_ch_t
 *
ch
 = 
	`cÚš”_of
(
h264
,dvm_ch_t,
h264_ma¡”_’code_logic_chª
);

650 
tve_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

651 if(!
tve_bË
){

652 
	`TW_DBG
(
TW_DBG_ERR
,"nØmem iÀ%s\n",
__FUNCTION__
);

653 
”r
;

655 
	`INIT_LIST_HEAD
(&
tve_bË
->
li¡
);

656 
tve_bË
->
tid
 = &
tw_videoh264_’_id
;

657 
tve_bË
->
İs
 = &
videoh264_’_fİs
;

658 
tve_bË
->
·¿
 = 
d©a
;

660 
»t
 = 
	`»gi¡”_tc_deviû
(
tve_bË
);

661 if(
»t
)

662 
”r1
;

664 
tc_video
 = 
	`kz®loc
((*tc_video),
GFP_KERNEL
);

665 if(!
tc_video
)

666 
”r1
;

667 
	`¡rıy
(
tc_video
->
Çme
,"tc_video_en");

668 
tc_video
->
»ad
 = 
tc_video_’_»ad
;

669 
tc_video
->
wr™e
 = 
NULL
;

670 
tc_video
->
´iv©e
 = &
tw_videoh264_’_id
;

671 
»t
 = 
	`tw_moduË_»gi¡”
(
ch
,
tc_video
);

672 if(
»t
)

673 
”r1
;

674  
»t
;

676 
”r1
:

677 if(
tc_video
)

678 
	`kä“
(
tc_video
);

679 
	`tw_videoh264_’_»move
(
d©a
);

680 
”r
:

681 if(
tve_bË
)

682 
	`kä“
(
tve_bË
);

684  
»t
;

685 
	}
}

687 
	$tw_videoh264_’_»move
(*
d©a
)

689 
tc_Œaû
;

690 if(
tc_video
 && 
d©a
)

691 
	`tw_moduË_uÄegi¡”
((
dvm_ch_t
 *)
d©a
,
tc_video
);

692 if(
tve_bË
)

693 
	`uÄegi¡”_tc_deviû
(
tve_bË
);

694 
tve_bË
 = 
NULL
;

695 
	}
}

697 
	$tw_videoh264s_’_š™
(* 
d©a
)

699 
»t
 = 0;

700 
tve_sub_bË
 = 
	`kz®loc
((
tw_dev_bË_id
),
GFP_KERNEL
);

701 if(!
tve_sub_bË
){

702 
	`TW_DBG
(
TW_DBG_ERR
,"nØmem iÀ%s\n",
__FUNCTION__
);

703  -
ENOMEM
;

705 
	`INIT_LIST_HEAD
(&
tve_sub_bË
->
li¡
);

706 
tve_sub_bË
->
tid
 = &
tw_videoh264s_’_id
;

707 
tve_sub_bË
->
İs
 = &
videoh264_’_fİs
;

708 
tve_sub_bË
->
·¿
 = 
d©a
;

710 
»t
 = 
	`»gi¡”_tc_deviû
(
tve_sub_bË
);

711  
»t
;

712 
	}
}

714 
	$tw_videoh264s_’_»move
(* 
d©a
)

716 if(
tve_sub_bË
)

717 
	`uÄegi¡”_tc_deviû
(
tve_sub_bË
);

718 
tve_sub_bË
 = 
NULL
;

719 
	}
}

	@../../tw5864/device_layer/video_en_driver.c

1 
	~<tw5864/tc_commÚ.h
>

3 
	$tw_video_’_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

5 
»t
;

6 
bus_id
,
ch_id
,
lg_id
;

7 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

8 
tw_h264_logic_’code_chª_t
 *
ved
;

10 
bus_id
 = 
	`g‘_busid_äom_•obj
(&
tcd
->
•obj
);

11 
ch_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

12 
lg_id
 = 
¬g
->
chªÃl_idx
;

14 
ved
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

15 
ved
 +ğ
lg_id
;

17 
	`´štk
("ved[0x%8p]†ogic_id =%dš %s---> \n",
ved
,
lg_id
, 
__FUNCTION__
);

18 
»t
 = 
	`š™_tw5864_h264_’code_chª
(
ved
, 
ch
->
bus_id
, ch->
ch_id
, 
lg_id
, 
TW_MASTER_BITSTREAM
, chip);

19 if(
»t
){

20 
	`dbg
("h264 master driv init failed!\n");

21  
»t
;

23 
tsd
->
³d
 = &
ved
->
İ’ed_logic_chª_ed
;

24  
»t
;

25 
	}
}

28 
	$tw_video_’_driv”_»move
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

30 
tw_h264_logic_’code_chª_t
 *
vd
;

32 
tc_Œaû
;

33 if(!
tsd
->
³d
){

34 
	`dbg
("tsd has‚oƒd!\n");

37 
vd
 = 
	`cÚš”_of
(
tsd
->
³d
,
tw_h264_logic_’code_chª_t
,
İ’ed_logic_chª_ed
);

38 
	`»move_tw5864_h264_’code_chª
(
vd
);

39 
	}
}

42 
tw_dev_id
 
	gtw_video_’_dev_id
 =

44 .
•obj
 = {

45 .
v’dÜ_id
 = 
TWELL
,

46 .
	gbus_id
 = 1,

47 .
	gch_id
 = 
TW5864
,

48 .
	gfunc_id
 = 
STREAM_TYPE_MAJOR
 | 
CODEC_VIDEO_H264
,

49 .
	gty³
 = 
TW_ENCODER
,

51 .
	gv”siÚ
 = 1,

55 
tsd_driv”_İ”©iÚs
 
	gtw_video_’_İs
 =

57 .
š™
 = 
tw_video_’_driv”_š™
,

58 .
	g»move
 = 
tw_video_’_driv”_»move
,

61 
tw_£rviû_driv”
 
	gtw_video_’_driv
 =

63 .
driv”
 = {

64 .
Çme
 = "tw5864_video_driv",

66 .
	gdeviû_id
 = {

67 .
tid
 = &
tw_video_’_dev_id
,

68 .
	gİs
 = &
tw_video_’_İs
,

74 
	$tw5864_video_’_driv”_š™
(* 
·¿
)

76 
tc_Œaû
;

77 
tw_video_’_driv
.
deviû_id
.
·¿
 =…ara;

78  
	`»gi¡”_tc_driv”
(&
tw_video_’_driv
);

79 
	}
}

82 
	$tw5864_video_’_driv”_»move
()

84 
	`uÄegi¡”_tc_driv”
(&
tw_video_’_driv
);

85 
	}
}

96 
	$tw_videosub_’_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 * 
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

98 
»t
;

99 
bus_id
,
ch_id
,
lg_id
;

100 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

101 
tw_h264_logic_’code_chª_t
 *
ved
;

103 
bus_id
 = 
	`g‘_busid_äom_•obj
(&
tcd
->
•obj
);

104 
ch_id
 = 
	`g‘_chid_äom_•obj
(&
tcd
->
•obj
);

105 
lg_id
 = 
¬g
->
chªÃl_idx
;

107 
ved
 = 
ch
->
h264_sub_’code_logic_chª
;

108 
ved
 +ğ
lg_id
;

110 
	`´štk
("ved[0x%8p] iÀ%s---> \n",
ved
, 
__FUNCTION__
);

111 
»t
 = 
	`š™_tw5864_h264_’code_chª
(
ved
, 
ch
->
bus_id
, ch->
ch_id
, 
lg_id
, 
TW_SUB_BITSTREAM
, chip);

112 if(
»t
){

113 
	`dbg
("sub h264 driv init failed!\n");

114  
»t
;

116 
tsd
->
³d
 = &
ved
->
İ’ed_logic_chª_ed
;

117  
»t
;

118 
	}
}

122 
tw_dev_id
 
	gtw_videosub_’_dev_id
 =

124 .
•obj
 = {

125 .
v’dÜ_id
 = 
TWELL
,

126 .
	gbus_id
 = 1,

127 .
	gch_id
 = 
TW5864
,

128 .
	gfunc_id
 = (
STREAM_TYPE_MINOR
 << 16è| 
CODEC_VIDEO_H264
,

129 .
	gty³
 = 
TW_ENCODER
,

131 .
	gv”siÚ
 = 1,

135 
tsd_driv”_İ”©iÚs
 
	gtw_videosub_’_İs
 =

137 .
š™
 = 
tw_videosub_’_driv”_š™
,

140 
tw_£rviû_driv”
 
	gtw_videosub_’_driv
 =

142 .
driv”
 = {

143 .
Çme
 = "tw5864_videosub_driv",

145 .
	gdeviû_id
 = {

146 .
tid
 = &
tw_videosub_’_dev_id
,

147 .
	gİs
 = &
tw_videosub_’_İs
,

153 
	$tw5864_videosub_’_driv”_š™
(* 
·¿
)

155 
tc_Œaû
;

156 
tw_videosub_’_driv
.
deviû_id
.
·¿
 =…ara;

157  
	`»gi¡”_tc_driv”
(&
tw_videosub_’_driv
);

158 
	}
}

161 
	$tw5864_videosub_’_driv”_»move
()

163 
	`uÄegi¡”_tc_driv”
(&
tw_videosub_’_driv
);

164 
	}
}

	@../../tw5864/include/tw5864/HalSoftTimerLib.h

1 #iâdeà
__HALSOFTTIMERLIB_H


2 
	#__HALSOFTTIMERLIB_H


	)

4 #ifdeà
__ılu¥lus


9 
	#MAXSINGLEFIREQUEUENUM
 (128)

	)

10 
	#MAXFORFIREQUEUENUM
 (128)

	)

12 
	#ADDJOBERROR
 (
MAXSINGLEFIREQUEUENUM
+2)

	)

13 
	#GETFREETMCBERROR
 
ADDJOBERROR


	)

14 
	#INVALIDTIMERID
 
ADDJOBERROR


	)

16 (*
tim”Hook
)(* 
	tcÚ‹xt
);

18 
Re£tSigÇlTim”
();

19 
Re£tFÜTim”
();

20 
AddSšgËFœeTim”Job
(
__u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
);

21 
D–‘eSšgËFœeTim”Job
(
šdex
);

22 
AddFÜFœeTim”Job
(
__u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
);

23 
D–‘eFÜFœeTim”Job
(
šdex
);

24 
Tig”SšgËFœeTim”
();

25 
Tig”FÜFœeTim”
();

26 
u32
 
g‘_tw_sy¡em_tick
();

27 
Œigg”_tim”0_dma
();

29 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/algo_h264_driver.h

1 #iâdef 
ALGO_NAL_DRIVER_H


2 
	#ALGO_NAL_DRIVER_H


	)

4 #ifdeà
__ılu¥lus


9 
	#SLICE_HEAD_BUF_SIZE
 (128)

	)

10 #ifdeà 
ADD_DVM_NAL_HEAD


11 
	#NAL_HEAD_LEN
 (12)

	)

13 
	#NAL_HEAD_LEN
 (8)

	)

15 
	#MAX_SPS_RBSP_LEN
 (
SLICE_HEAD_BUF_SIZE
-
NAL_HEAD_LEN
)

	)

16 
	#MAX_PPS_RBSP_LEN
 
MAX_SPS_RBSP_LEN


	)

17 
	#MAX_SLICE_HEAD_LEN
 
MAX_SPS_RBSP_LEN


	)

19 
	#NAL_FILL_ZERO_NUM
 0

	)

20 
	e´ofe_e


22 
PROFILE_BASELINE
 = 66,

23 
PROFILE_MAIN
 = 77,

24 
PROFILE_EXTENTED
 = 88,

25 
PROFILE_HIGH
 = 100,

26 
PROFILE_HIGH10
 = 110,

27 
PROFILE_HIGH422
 = 122,

28 
PROFILE_HIGH444
 = 144

31 
	eÇl_un™_ty³
 {

32 
NAL_UNKNOWN
 = 0,

33 
NAL_SLICE
 = 1,

34 
NAL_SLICE_DPA
 = 2,

35 
NAL_SLICE_DPB
 = 3,

36 
NAL_SLICE_DPC
 = 4,

37 
NAL_SLICE_IDR
 = 5,

38 
NAL_SEI
 = 6,

39 
NAL_SPS
 = 7,

40 
NAL_PPS
 = 8,

41 
NAL_AUD
 = 9,

42 
NAL_SERIAL_OVER
 = 10,

43 
NAL_STREAM_OVER
 = 11,

44 
NAL_PADDING
 = 12,

45 
NAL_TYPE_EX_PIC
 = 24,

46 
NAL_TYPE_EX_VIDEO
 = 25,

47 
NAL_TYPE_EX_AUDIO
 = 26,

48 
NAL_TYPE_EX_MV
 = 27

51 
	eDVM_NAL_TYPE_EX_PIC
{

52 
NAL_TYPE_EX_P_MJPEG
 = 0x80,

53 
NAL_TYPE_EX_P_BMP
 = 0x81,

56 
	eDVM_NAL_TYPE_EX_V
{

57 
NAL_TYPE_EX_V_MPEG
 = 0x90,

60 
	eDVM_NAL_TYPE_EX_A
{

61 
NAL_TYPE_EX_A_PCM
 = 0xC0,

62 
NAL_TYPE_EX_A_ALAW
 = 0xC1,

63 
NAL_TYPE_EX_A_ULAW
 = 0xC2,

64 
NAL_TYPE_EX_A_ADPCM
 = 0xC3,

65 
NAL_TYPE_EX_A_IMAADPCM
 = 0xC4,

68 
	eDVM_NAL_TYPE_EX_MV
{

69 
NAL_TYPE_EX_MV_D1
 = 0xD1,

72 
	eÇl_´iÜ™y


74 
NAL_PRIORITY_DISPOSABLE
 = 0,

75 
NAL_PRIORITY_LOW
 = 1,

76 
NAL_PRIORITY_HIGH
 = 2,

77 
NAL_PRIORITY_HIGHEST
 = 3

80 
	eedvm_Çl_ty³


82 
DVM_NAL_UNKNOWN
 = 0,

83 
DVM_NAL_MV
 = 0x50,

84 
DVM_NAL_MJPEG
 = 0x80,

85 
DVM_NAL_BMP
 = 0x81,

86 
DVM_NAL_SPS
 = 0xA0,

87 
DVM_NAL_PPS
 = 0xA1,

88 
DVM_NAL_SLICE
 = 0xB0,

89 
DVM_NAL_SLICE_IDR
 = 0xB1,

90 
DVM_NAL_SLICE_DPA
 = 0xB2,

91 
DVM_NAL_SLICE_DPB
 = 0xB3,

92 
DVM_NAL_SLICE_DPC
 = 0xB4,

93 
DVM_NAL_SLICE_P
 = 0xB5,

94 
DVM_NAL_SLICE_I
 = 0xB6,

95 
DVM_NAL_AUDIO_PCM
 = 0xC0,

96 
DVM_NAL_AUDIO_ALAW
 = 0xC1,

97 
DVM_NAL_AUDIO_ULAW
 = 0xC2,

98 
DVM_NAL_AUDIO_ADPCM
 = 0xC3,

99 
DVM_NAL_AUDIO_IMAADPCM
 = 0xC4,

102 #ifdeà 
ADD_DVM_NAL_HEAD


103 
	s_g_dvm_Çl_h—d
 {

104 
u8
 
e_Çl_ty³
;

105 
u8
 
i_Çl_size_0_7
;

106 
u8
 
i_Çl_size_8_15
;

107 
u8
 
i_Çl_size_16_23
;

108 }
STRUCT_PACKET_ALIGN
(1);

111 
	sÇl_šfo
{

112 #ià
NAL_FILL_ZERO_NUM


113 
__u8
 
z”o1
;

114 
__u8
 
z”o2
;

116 
__u8
 
z”o3
;

117 
__u8
 
z”o4
;

118 
__u8
 
z”o5
;

119 
__u8
 
cÚ¡ªt_v®ue_1
;

120 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

121 
__u8
 
Çl_un™_ty³
 : 5;

122 
__u8
 
Çl_»f_idc
 : 2;

123 
__u8
 
fÜbidd’_z”o_b™
 : 1;

124 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

125 
__u8
 
fÜbidd’_z”o_b™
 : 1;

126 
__u8
 
Çl_»f_idc
 : 2;

127 
__u8
 
Çl_un™_ty³
 : 5;

129 #”rÜ 
Úe
 
of
 
__LITTLE_ENDIAN_BITFIELD
 
Ü
 
__BIG_ENDIAN_BITFIELD
 
mu¡
 
be
 
defšed


131 }
	tSTRUCT_PACKET_ALIGN
(1è
	tNAL_INFO
;

133 
	sh264_Çl_h—d
{

134 #ifdeà 
ADD_DVM_NAL_HEAD


135 
DVM_NAL_HEAD
 
h—d
;

137 
H264_NAL_INFO
 
Çl
;

138 
u8
 
rb¥
[0];

139 }
STRUCT_PACKET_ALIGN
(1);

141 
	sext_h264_Çl_h—d
{

142 #ifdeà 
ADD_DVM_NAL_HEAD


143 
DVM_NAL_HEAD
 
h—d
;

145 
H264_NAL_INFO
 
Çl
;

146 
u8
 
ext_ty³
;

147 
u8
 
rb¥
[0];

148 }
STRUCT_PACKET_ALIGN
(1);

150 
	sh264_Çl
 {

151 
i_»f_idc
;

152 
i_ty³
;

153 
i_‹mp_b™®ign_numb”
;

154 
__u32
 
i_‹mp_b™®ign_cÚ‹Á
;

155 
__u8
 *
¦iû_h—d_buf
;

156 
__u8
 *
¥s_·ylßd
;

157 
¥s_·ysize
;

158 
__u8
 *
µs_·ylßd
;

159 
µs_·ysize
;

160 
__u8
 *
¦iû_·ylßd
;

161 
¦iû_·ysize
;

164 
	sh264_¥s


166 
i_´ofe_idc
;

167 
b_cÚ¡¿št_£t0
;

168 
b_cÚ¡¿št_£t1
;

169 
b_cÚ¡¿št_£t2
;

170 
i_Ëv–_idc
;

171 
i_id
;

172 
i_log2_max_äame_num
;

173 
i_poc_ty³
;

175 
i_log2_max_poc_lsb
;

177 
b_d–_pic_Üd”_®ways_z”o
;

178 
i_off£t_fÜ_nÚ_»f_pic
;

179 
i_off£t_fÜ_tİ_to_bÙtom_f›ld
;

180 
i_num_»f_äames_š_poc_cyşe
;

181 
i_off£t_fÜ_»f_äame
[256];

183 
i_num_»f_äames
;

184 
b_g­s_š_äame_num_v®ue_®lowed
;

185 
i_mb_width
;

186 
i_mb_height
;

187 
b_äame_mbs_Úly
;

188 
b_mb_ad­tive_äame_f›ld
;

189 
b_dœeù8x8_šã»nû
;

191 
b_üİ
;

192 
b_vui
;

195 
	sh264_µs


197 
i_id
;

198 
i_¥s_id
;

200 
b_ÿbac
;

202 
b_pic_Üd”
;

203 
i_num_¦iû_groups
;

205 
i_num_»f_idx_l0_aùive
;

206 
i_num_»f_idx_l1_aùive
;

208 
b_weigh‹d_´ed
;

209 
b_weigh‹d_b»d
;

211 
i_pic_š™_qp
;

212 
i_pic_š™_qs
;

214 
i_chroma_qp_šdex_off£t
;

216 
b_deblockšg_f‹r_cÚŒŞ
;

217 
b_cÚ¡¿šed_šŒa_´ed
;

218 
b_»dundªt_pic_út
;

221 
	e¦iû_ty³


223 
SLICE_TYPE_P
 = 0,

224 
SLICE_TYPE_B
 = 1,

225 
SLICE_TYPE_I
 = 2,

226 
SLICE_TYPE_SP
 = 3,

227 
SLICE_TYPE_SI
 = 4

230 
	sh264_¦iû_h—d”


232 
h264_¥s_t
 *
¥s
;

233 
h264_µs_t
 *
µs
;

235 
i_ty³
;

236 
i_fœ¡_mb
;

237 
i_Ï¡_mb
;

238 
i_µs_id
;

239 
i_äame_num
;

240 
b_f›ld_pic
;

241 
b_bÙtom_f›ld
;

242 
i_idr_pic_id
;

243 
i_poc_lsb
;

244 
i_d–_poc_bÙtom
;

245 
i_d–_poc
[2];

246 
i_»dundªt_pic_út
;

247 
b_dœeù_¥©Ÿl_mv_´ed
;

248 
b_num_»f_idx_ov”ride
;

249 
i_num_»f_idx_l0_aùive
;

250 
i_num_»f_idx_l1_aùive
;

251 
b_»f_pic_li¡_»Üd”šg_l0
;

252 
b_»f_pic_li¡_»Üd”šg_l1
;

255 
idc
;

256 
¬g
;

257 }
»f_pic_li¡_Üd”
[2][16];

259 
i_ÿbac_š™_idc
;

260 
i_qp_d–
;

261 
b_¥_fÜ_swidth
;

262 
i_qs_d–
;

265 
i_di§bË_deblockšg_f‹r_idc
;

266 
i_®pha_c0_off£t
;

267 
i_b‘a_off£t
;

271 
g’_h264_¥s
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
);

272 
g’_h264_µs
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
);

273 
g’_h264_¦iûh—d
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
, 
äame_ty³
);

274 
g’_ext_Çl_audio_h—d”
(*
buf
, 
audio_ty³
, 
Ën
);

275 
g’_ext_mj³g_h—d”
(*
buf
, 
Ën
);

276 
g’_ext_mv_h—d”
(*
buf
, 
Ën
);

279 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/bar_ctl.h

1 #iâdeà
__CROSSBAR_CTROL_H__


2 
	#__CROSSBAR_CTROL_H__


	)

4 #ifdeà
__ılu¥lus


10 
	#TW_MAX_VI
 16

	)

12 
	#TW_MAX_GRP
 4

	)

14 
	#TW_MAX_CAPABILITY
 (7)

	)

16 
	#TW_BUS_MAX_D1
 2

	)

19 
	#TW_CHN_NO
 (
TW_MAX_VI
 / 
TW_MAX_GRP
)

	)

21 
	#IO_BLOCK
 1

	)

22 
	#IO_NOBLOCK
 0

	)

24 
	#TW_INVAL_CHN
 (-1)

	)

27 
	#TW_GRP_MAX_PFRAME
 25

28 
	#TW_GRP_MAX_NFRAME
 30

29 

	)

41 
	eGROUP_MODE
{

42 
MODE_D1
,

43 
MODE_D1_HALFD1
,

44 
MODE_D1_HALFD1_CIF
,

45 
MODE_D1_CIF
,

46 
MODE_HALFD1
,

47 
MODE_HALFD1_CIF
,

48 
MODE_CIF
,

49 
MODE_NONE
,

52 
	#TW_VI_PAL
 
TW_VIDEO_STANDARD_PAL


	)

53 
	#TW_VI_NTSC
 
TW_VIDEO_STANDARD_NTSC


	)

56 
g½_id
;

57 
š_£Ëù
[
TW_CHN_NO
];

58 
š_m­
[
TW_CHN_NO
];

59 
š_fmt
[
TW_CHN_NO
];

60 
š_¿‹
[
TW_CHN_NO
];

61 
out_¿‹
[
TW_CHN_NO
];

62 
tÙ®äm
;

63 
GROUP_MODE
 
mode
;

64 
tÙ®
;

65 }
	tVGROUP_S
;

81 
cb_ù¾_ÿlcuÏ‹
(*
chn
, *
fÜm©
, *
¿‹
, 
nÜm
, 
VGROUP_S
 *
vgroup
, 
couÁ
, 
adju¡
);

97 
´ev›w_ù¾_ÿlcuÏ‹
(*
chn
, *
fÜm©
, *
¿‹
, 
nÜm
, 
VGROUP_S
 *
vgroup
, 
couÁ
, 
adju¡
);

100 
u32
 
g‘_b™s_m­
(u32 
¤c
, u32 
rg‘
);

102 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/bitstream.h

1 #iâdeà
BITSTREAM_H


2 
	#BITSTREAM_H


	)

4 #ifdeà
__ılu¥lus


9 
	sG‘B™CÚ‹xt


11 cÚ¡ 
ušt8_t
 *
bufãr
, *
bufãr_’d
;

12 
šdex
;

13 
size_š_b™s
;

14 }
	tG‘B™CÚ‹xt
;

16 
	#NEG_SSR32
(
a
,
s
è((Ğ
št32_t
)×))>>(32-(s)))

	)

17 
	#NEG_USR32
(
a
,
s
è(((
ušt32_t
)×))>>(32-(s)))

	)

20 
šlše
 
uÇligÃd32_be
(cÚ¡ *
v
)

22 cÚ¡ 
ušt8_t
 *
p
=
v
;

23  (((
p
[0]<<8) |…[1])<<16) | (p[2]<<8) | (p[3]);

26 
	#OPEN_READER
(
Çme
, 
gb
)\

27 
Çme
##
_šdex
ğ(
gb
)->
šdex
;\

28 
Çme
##
_ÿche
= 0;\

29 

	)

30 
	#CLOSE_READER
(
Çme
, 
gb
)\

31 (
gb
)->
šdex
ğ
Çme
##
_šdex
;\

32 

	)

33 
	#UPDATE_CACHE
(
Çme
, 
gb
)\

34 
Çme
##
_ÿche
ğ
	`uÇligÃd32_be
Ğ((cÚ¡ 
ušt8_t
 *)(
gb
)->
bufãr
)+Òame##
_šdex
>>3) ) << (name##_index&0x07);\

35 

	)

36 
	#SKIP_COUNTER
(
Çme
, 
gb
, 
num
)\

37 
Çme
##
_šdex
 +ğ(
num
);\

38 

	)

39 
	#LAST_SKIP_BITS
(
Çme
, 
gb
, 
num
è
	`SKIP_COUNTER
Òame, gb,‚um)

	)

41 
	#SHOW_UBITS
(
Çme
, 
gb
, 
num
)\

42 
	`NEG_USR32
(
Çme
##
_ÿche
, 
num
)

	)

44 
	#GET_CACHE
(
Çme
, 
gb
)\

45 ((
ušt32_t
)
Çme
##
_ÿche
)

	)

47 
šlše
 
g‘_b™s_couÁ
(
G‘B™CÚ‹xt
 *
s
)

49  
s
->
šdex
;

52 
šlše
 
g‘_b™s
(
G‘B™CÚ‹xt
 *
s
, 
n
)

54 
tmp
;

55 
OPEN_READER
(
»
, 
s
)

56 
UPDATE_CACHE
(
»
, 
s
)

57 
tmp
ğ
SHOW_UBITS
(
»
, 
s
, 
n
);

58 
LAST_SKIP_BITS
(
»
, 
s
, 
n
)

59 
CLOSE_READER
(
»
, 
s
)

60  
tmp
;

63 
šlše
 
g‘_b™s1
(
G‘B™CÚ‹xt
 *
s
)

65 
šdex
ğ
s
->index;

66 
ušt8_t
 
»suÉ
ğ
s
->
bufãr
[ 
šdex
>>3 ];

67 
»suÉ
 <<ğ(
šdex
&0x07);

68 
»suÉ
 >>= 7;

69 
s
->
šdex
++;

70  
»suÉ
;

73 
šlše
 
š™_g‘_b™s
(
G‘B™CÚ‹xt
 *
s
, cÚ¡ 
ušt8_t
 *
bufãr
, 
b™_size
)

75 
bufãr_size
 = (
b™_size
+7)>>3;

77 if(
bufãr_size
 < 0 || 
b™_size
 < 0)

79 
bufãr_size
 = 
b™_size
 = 0;

80 
bufãr
 = 
NULL
;

82 
s
->
bufãr
 = buffer;

83 
s
->
size_š_b™s
 = 
b™_size
;

84 
s
->
bufãr_’d
 = 
bufãr
 + 
bufãr_size
;

85 
s
->
šdex
=0;

88 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/bs.h

1 #iâdeà
_BS_H


2 
	#_BS_H


	)

4 #ifdeà
__ılu¥lus


9 
	sbs_s


11 
__u8
 *
p_¡¬t
;

12 
__u8
 *
p
;

13 
__u8
 *
p_’d
;

15 
i_Ëá
;

16 }
	tbs_t
;

18 
šlše
 
bs_š™
(
bs_t
 *
s
, *
p_d©a
, 
i_d©a
)

20 
s
->
p_¡¬t
 = 
p_d©a
;

21 
s
->
p
 = 
p_d©a
;

22 
s
->
p_’d
 = s->
p
 + 
i_d©a
;

23 
s
->
i_Ëá
 = 8;

26 
šlše
 
bs_pos
Ğ
bs_t
 *
s
 )

28 Ğ8 * ( 
s
->
p
 - s->
p_¡¬t
 ) + 8 - s->
i_Ëá
 );

31 
šlše
 
bs_eof
Ğ
bs_t
 *
s
 )

33 Ğ
s
->
p
 >ğs->
p_’d
 ? 1: 0 );

36 
šlše
 
bs_Ën
(
bs_t
 *
s
)

38  (
s
->
p
 - s->
p_¡¬t
);

41 
šlše
 
bs_Ëá
(
bs_t
 *
s
)

43  (8-
s
->
i_Ëá
);

46 
šlše
 
bs_dœeù_wr™e
(
bs_t
 *
s
, 
u8
 
v®ue
)

48 *
s
->
p
 = 
v®ue
;

49 
s
->
p
++;

50 
s
->
i_Ëá
 = 8;

53 
šlše
 
bs_wr™e
(
bs_t
 *
s
, 
i_couÁ
, 
u32
 
i_b™s
)

55 ifĞ
s
->
p
 >ğs->
p_’d
 - 4 )

57  
i_couÁ
 > 0 )

59 ifĞ
i_couÁ
 < 32 )

60 
i_b™s
 &ğ(1<<
i_couÁ
)-1;

61 ifĞ
i_couÁ
 < 
s
->
i_Ëá
 )

63 *
s
->
p
 = (*s->°<< 
i_couÁ
è| 
i_b™s
;

64 
s
->
i_Ëá
 -ğ
i_couÁ
;

69 *
s
->
p
 = (*s->°<< s->
i_Ëá
è| (
i_b™s
 >> (
i_couÁ
 - s->i_left));

70 
i_couÁ
 -ğ
s
->
i_Ëá
;

71 
s
->
p
++;

72 
s
->
i_Ëá
 = 8;

77 
šlše
 
bs_wr™e1
Ğ
bs_t
 *
s
, 
u32
 
i_b™
 )

79 ifĞ
s
->
p
 < s->
p_’d
 )

81 *
s
->
p
 <<= 1;

82 *
s
->
p
 |ğ
i_b™
;

83 
s
->
i_Ëá
--;

84 ifĞ
s
->
i_Ëá
 == 0 )

86 
s
->
p
++;

87 
s
->
i_Ëá
 = 8;

92 
šlše
 
bs_®ign_0
Ğ
bs_t
 *
s
 )

94 ifĞ
s
->
i_Ëá
 != 8 )

96 *
s
->
p
 <<ğs->
i_Ëá
;

97 
s
->
i_Ëá
 = 8;

98 
s
->
p
++;

102 
šlše
 
bs_sh_®ign
Ğ
bs_t
 *
s
 )

104 ifĞ
s
->
i_Ëá
 != 8 )

106 *
s
->
p
 <<ğs->
i_Ëá
;

107 
s
->
i_Ëá
 = 8;

111 
šlše
 
bs_®ign_1
Ğ
bs_t
 *
s
 )

113 ifĞ
s
->
i_Ëá
 != 8 )

115 *
s
->
p
 <<ğs->
i_Ëá
;

116 *
s
->
p
 |ğ(1 << s->
i_Ëá
) - 1;

117 
s
->
i_Ëá
 = 8;

118 
s
->
p
++;

122 
šlše
 
bs_®ign
Ğ
bs_t
 *
s
 )

124 
bs_®ign_0
Ğ
s
 );

128 
šlše
 
bs_wr™e_ue
Ğ
bs_t
 *
s
, 
u32
 
v®
 )

130 
i_size
 = 0;

131 cÚ¡ 
i_size0_255
[256] =

143 ifĞ
v®
 == 0 )

145 
bs_wr™e1
Ğ
s
, 1 );

149 
tmp
 = ++
v®
;

151 ifĞ
tmp
 >= 0x00010000 )

153 
i_size
 += 16;

154 
tmp
 >>= 16;

156 ifĞ
tmp
 >= 0x100 )

158 
i_size
 += 8;

159 
tmp
 >>= 8;

161 
i_size
 +ğ
i_size0_255
[
tmp
];

163 
bs_wr™e
Ğ
s
, 2 * 
i_size
 - 1, 
v®
 );

167 
šlše
 
bs_wr™e_£
Ğ
bs_t
 *
s
, 
v®
 )

169 
bs_wr™e_ue
Ğ
s
, 
v®
 <= 0 ? -val * 2 : val * 2 - 1);

172 
šlše
 
bs_wr™e_‹
Ğ
bs_t
 *
s
, 
x
, 
v®
 )

174 ifĞ
x
 == 1 )

176 
bs_wr™e1
Ğ
s
, 1&~
v®
 );

178 ifĞ
x
 > 1 )

180 
bs_wr™e_ue
Ğ
s
, 
v®
 );

184 
šlše
 
bs_rb¥_Œašg
Ğ
bs_t
 *
s
 )

186 
bs_wr™e1
Ğ
s
, 1 );

187 ifĞ
s
->
i_Ëá
 != 8 )

189 
bs_wr™e
Ğ
s
, s->
i_Ëá
, 0x00 );

193 
šlše
 
bs_size_ue
Ğ
v®
 )

195 cÚ¡ 
i_size0_254
[255] =

211 ifĞ
v®
 < 255 )

213  
i_size0_254
[
v®
];

217 
i_size
 = 0;

219 
v®
++;

221 ifĞ
v®
 >= 0x10000 )

223 
i_size
 += 32;

224 
v®
 = (val >> 16) - 1;

226 ifĞ
v®
 >= 0x100 )

228 
i_size
 += 16;

229 
v®
 = (val >> 8) - 1;

231  
i_size0_254
[
v®
] + 
i_size
;

235 
šlše
 
bs_size_£
Ğ
v®
 )

237  
bs_size_ue
Ğ
v®
 <= 0 ? -val * 2 : val * 2 - 1);

240 
šlše
 
bs_size_‹
Ğ
x
, 
v®
 )

242 ifĞ
x
 == 1 )

246 ifĞ
x
 > 1 )

248  
bs_size_ue
Ğ
v®
 );

253 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/chip_bus_schedule.h

1 #iâdef 
CHIP_BUS_SCHEDULE_H


2 
	#CHIP_BUS_SCHEDULE_H


	)

4 #ifdeà
__ılu¥lus


9 
	snÙify_msg


11 
msg_ty³
;

12 *
msg_´iv©e
;

13 *
msg_·¿m
;

16 (*
nÙify_»gi¡”_node_´iv
)(
	ttw_»gi¡”_node_t
 *, *, 
	ttw_nÙify_msg
 *);

17 (*
m©ch_»gs™”_node_´iv_id
)(
	ttw_»gi¡”_node_t
 *, *, );

19 
	stw_»gi¡”_node_İ”©iÚ
{

20 (*
š™_com¶‘e
)(
tw_»gi¡”_node_t
 *);

21 (*
wa™_com¶‘e
)(
tw_»gi¡”_node_t
 *);

22 (*
com¶‘e_dÚe
)(
tw_»gi¡”_node_t
 *);

25 
	#to_g‘_»gi¡”_node
(
node
è
	`cÚš”_of
Òode, 
tw_»gi¡”_node_t
, 
li¡
)

	)

26 
	stw_»gi¡”_node
{

27 
li¡_h—d
 
li¡
;

28 
com¶‘iÚ
 
wa™_¡İ
;

30 *
»gi¡”_node_´iv
;

31 
nÙify_»gi¡”_node_´iv
 
nÙify_´iv
;

32 
m©ch_»gs™”_node_´iv_id
 
m©ch_id
;

34 
tw_»gi¡”_node_İ”©iÚ
 *
İ
;

37 
	s»gi¡”_bË_node_İ”©iÚ
{

38 (*
»gi¡”_node_što_bË
)(
tw_»gi¡”_bË_t
 *, 
tw_»gi¡”_node_t
 *);

39 (*
uÄegi¡”_node_äom_bË
)(
tw_»gi¡”_bË_t
 *, 
tw_»gi¡”_node_t
 *);

40 (*
fšd_»gi¡”_node_š_bË
)(
tw_»gi¡”_bË_t
 *, 
tw_»gi¡”_node_t
 **, );

41 (*
g‘_cu¼_»gi¡”_node_numb”
)(
tw_»gi¡”_bË_t
 *);

44 
	s»gi¡”_bË_node
{

45 
¥šlock_t
 
lock
;

46 
li¡_h—d
 
»gi¡”_h—d”
;

47 
©omic_t
 
cu¼_»gi¡”_’Œy_numb”
;

49 
»gi¡”_bË_node_İ”©iÚ
 *
İ
;

52 
	stw_roÙ_bus
{

53 
tw_»gi¡”_bË_t
 
roÙ_»gi¡”_bË
;

56 
	sty³_bus_İ”©iÚ
{

57 (*
š™
)(
ty³_bus_t
 *, );

59 (*
»gi¡”_ch_bus_što_ty³_bus_bË
)(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 *
ch_bus
);

60 (*
uÄegi¡”_ch_bus_što_ty³_bus_bË
)(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 *
ch_bus
);

61 (*
fšd_ch_bus_š_ty³_bus_bË
)(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 **
ch_bus
, 
ch_id
);

64 
	#to_g‘_ty³_bus_w™h_»gi¡”_node
(
node
è
	`cÚš”_of
Òode, 
ty³_bus_t
, 
»gi¡”_node
)

	)

65 
	sty³_bus
{

66 
tw_»gi¡”_node_t
 
»gi¡”_node
;

67 
tw_»gi¡”_bË_t
 
ty³_bus_roÙ_»gi¡”_bË
;

68 
bus_id
;

70 
ty³_bus_İ”©iÚ
 *
İ
;

73 
	sch_bus_İ”©iÚ
{

74 (*
š™
)(
tw_ch_bus_t
 *, , );

77 
	#to_g‘_ch_bus_w™h_ch_»gi¡”_node
(
node
è
	`cÚš”_of
Òode, 
tw_ch_bus_t
, 
ch_»gi¡”_node
)

	)

78 
	stw_ch_bus
{

79 
tw_»gi¡”_node_t
 
ch_»gi¡”_node
;

80 
bus_id
;

81 
ch_id
;

83 
ch_bus_İ”©iÚ
 *
İ
;

86 
g‘_roÙ_bus
(
tw_roÙ_bus_t
 **
±r_roÙ_bus
);

87 
g‘_tw_ho¡_bus
(
ty³_bus_t
 **
±r_ty³_bus
);

88 
g‘_tw_pci_bus
(
ty³_bus_t
 **
±r_ty³_bus
);

89 
g’_tw_bus_ev’t
();

90 
wa™_tw_bus_ev’t
();

92 
š™_tw_roÙ_bus
();

93 
»move_tw_roÙ_bus
();

94 
š™_ty³_bus
(
ty³_bus_t
 *
bus
, 
bus_id
);

95 
»move_ty³_bus
(
ty³_bus_t
 *
bus
);

96 
š™_ch_bus
(
tw_ch_bus_t
 *
ch_bus
, 
bus_id
, 
ch_id
);

97 
»move_ch_bus
(
tw_ch_bus_t
 *
ch_bus
, 
bus_id
);

98 
š™_’dpošt_tcb
(
ed_tcb_t
 *
ed_tcb
, 
bus_id
, 
ch_id
, 
ty³_id
, 
group_chª_id
, 
logic_chª_id
, *
´iv
, 
nÙify_»gi¡”_node_´iv
 
nÙify_´iv
, 
m©ch_»gs™”_node_´iv_id
 
m©ch_id
, 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *
fsm_bË
);

99 
š™_»gi¡”_bË_node
(
tw_»gi¡”_bË_t
 *
bË
);

100 
š™_»gi¡”_node
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
nÙify_»gi¡”_node_´iv
 
nÙify_´iv
, 
m©ch_»gs™”_node_´iv_id
 
m©ch_id
);

102 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/ddr_burst_interface.h

1 #iâdef 
DDR_BURST_INTERFACE_H


2 
	#DDR_BURST_INTERFACE_H


	)

4 #ifdeà
__ılu¥lus


9 
	#MPI_ACCESS_PAGE_MODE_REG_OFFSET
 (0x00030)

	)

10 
	#MPI_CMD_STATUS_REG_OFFSET
 (0x80000)

	)

11 
	#MPI_BURST_DDR_ADDR_REG_OFFSET
 (0x80004)

	)

12 
	#MPI_BURST_SRAM_ADDR_REG_OFFSET
 (0x80008)

	)

13 
	#MPI_DPRAM_BASE_OFFSET
 (0x84000)

	)

15 
	#DPRAM_SEGMENT_SIZE
 (0x0800)

	)

16 
	#DPRAM_PAGE_SIZE
 (0x0800)

	)

17 
	#DPRAM_PAGE_NUMBER
 (1)

	)

19 
	#BURST_INTERFACE_CHECKUP_TIMEOUT
 (200)

	)

21 
	#VIDEO_BITSTREAM_DDR_SECTION_NUMBER
 (8)

	)

23 
	sacûss_·ge_mode_»g
{

24 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

25 
u32
 
·ge_id
 : 8;

26 
u32
 
»£rve8_12
 : 5;

27 
u32
 
mpi_bur¡_»ad_4_’abË
 : 1;

28 
u32
 
ddr_a_b_£Ëù
 : 1;

29 
u32
 
bur¡_mode_’
 : 1;

30 
u32
 
»£rve16_31
 : 16;

31 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

32 
u32
 
»£rve16_31
 : 16;

33 
u32
 
bur¡_mode_’
 : 1;

34 
u32
 
ddr_a_b_£Ëù
 : 1;

35 
u32
 
mpi_bur¡_»ad_4_’abË
 : 1;

36 
u32
 
»£rve8_12
 : 5;

37 
u32
 
·ge_id
 : 8;

44 
acûss_·ge_mode_»g
 
b™_v®ue
;

45 
u32
 
v®ue
;

46 }
	tacûss_·ge_mode_»g_v®ue
;

48 
	sbur¡_cmd_¡©us_»g
{

49 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

50 
u32
 
bur¡_Ën
 : 16;

51 
u32
 
bur¡_dœ
 : 1;

52 
u32
 
bur¡_Œigg”
 : 1;

53 
u32
 
»£rve18_23
 : 6;

54 
u32
 
ddr_bur¡_’d_æag
 : 1;

55 
u32
 
ddr_sšgË_acûss_”r_št_’abË
 : 1;

56 
u32
 
ddr_bur¡_acûss_”r_št_’abË
 : 1;

57 
u32
 
bur¡_’d_št_’abË
 : 1;

58 
u32
 
ddr_sšgË_acûss_”r_æag
 : 1;

59 
u32
 
ddr_sšgË_acûss_busy_æag
 : 1;

60 
u32
 
ddr_bur¡_”r_æag
 : 1;

61 
u32
 
ddr_bur¡_busy_æag
 : 1;

62 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

63 
u32
 
ddr_bur¡_busy_æag
 : 1;

64 
u32
 
ddr_bur¡_”r_æag
 : 1;

65 
u32
 
ddr_sšgË_acûss_busy_æag
 : 1;

66 
u32
 
ddr_sšgË_acûss_”r_æag
 : 1;

67 
u32
 
bur¡_’d_št_’abË
 : 1;

68 
u32
 
ddr_bur¡_acûss_”r_št_’abË
 : 1;

69 
u32
 
ddr_sšgË_acûss_”r_št_’abË
 : 1;

70 
u32
 
ddr_bur¡_’d_æag
 : 1;

71 
u32
 
»£rve18_23
 : 6;

72 
u32
 
bur¡_Œigg”
 : 1;

73 
u32
 
bur¡_dœ
 : 1;

74 
u32
 
bur¡_Ën
 : 16;

81 
bur¡_cmd_¡©us_»g
 
b™_v®ue
;

82 
u32
 
v®ue
;

83 }
	tbur¡_cmd_¡©us_»g_v®ue
;

85 
	sbur¡_ddr_ba£_addr_»g
{

86 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

87 
u32
 
ddr_ba£_addr
 : 28;

88 
u32
 
»£rve28_31
 : 4;

89 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

90 
u32
 
»£rve28_31
 : 4;

91 
u32
 
ddr_ba£_addr
 : 28;

98 
bur¡_ddr_ba£_addr_»g
 
b™_v®ue
;

99 
u32
 
v®ue
;

100 }
	tbur¡_ddr_ba£_addr_»g_v®ue
;

102 
	sbur¡_¤am_ba£_addr_»g
{

103 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

104 
u32
 
¤am_ba£_addr
 : 16;

105 
u32
 
»£rve16_31
 : 16;

106 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

107 
u32
 
»£rve16_31
 : 16;

108 
u32
 
¤am_ba£_addr
 : 16;

115 
bur¡_¤am_ba£_addr_»g
 
b™_v®ue
;

116 
u32
 
v®ue
;

117 }
	tbur¡_¤am_ba£_addr_»g_v®ue
;

119 
	sddr_bur¡_š‹rçû_»g_İ”©iÚ
{

120 (*
š™
)(
ddr_bur¡_š‹rçû_t
 *);

121 (*
»£t
)(
ddr_bur¡_š‹rçû_t
 *);

122 (*
g‘_·ge_mode_»g
)(
ddr_bur¡_š‹rçû_t
 *, 
dvm_ch_t
 *);

123 (*
upd©e_·ge_mode_»g
)(
ddr_bur¡_š‹rçû_t
 *, 
dvm_ch_t
 *);

124 (*
g‘_bur¡_š‹rçû_·¿m
)(
ddr_bur¡_š‹rçû_t
 *, 
dvm_ch_t
 *);

125 (*
upd©e_bur¡_š‹rçû_·¿m
)(
ddr_bur¡_š‹rçû_t
 *, 
dvm_ch_t
 *);

127 (*
’abË_acûss_¤am_block
)(
ddr_bur¡_š‹rçû_t
 *);

128 (*
’abË_acûss_ddr_block
)(
ddr_bur¡_š‹rçû_t
 *);

129 (*
£Ëù_ddr_A
)(
ddr_bur¡_š‹rçû_t
 *);

130 (*
£Ëù_ddr_B
)(
ddr_bur¡_š‹rçû_t
 *);

131 (*
’abË_»ad_4
)(
ddr_bur¡_š‹rçû_t
 *);

132 (*
di§bË_»ad_4
)(
ddr_bur¡_š‹rçû_t
 *);

133 (*
£t_ddr_·ge_numb”
)(
ddr_bur¡_š‹rçû_t
 *, 
·ge_id
);

135 (*
£t_ddr_bur¡_·¿m
)(
ddr_bur¡_š‹rçû_t
 *, 
Ën
, 
dœ
);

136 (*
¡¬t_ddr_bur¡
)(
ddr_bur¡_š‹rçû_t
 *);

137 (*
št_’abË
)(
ddr_bur¡_š‹rçû_t
 *, , , );

138 (*
g‘_sšgË_acûss_”r_æag
)(
ddr_bur¡_š‹rçû_t
 *);

139 (*
g‘_bur¡_acûss_”r_æag
)(
ddr_bur¡_š‹rçû_t
 *);

140 (*
g‘_bur¡_busy_æag
)(
ddr_bur¡_š‹rçû_t
 *);

141 (*
g‘_bur¡_’d_æag
)(
ddr_bur¡_š‹rçû_t
 *);

142 (*
ş—r_bur¡_’d_æag
)(
ddr_bur¡_š‹rçû_t
 *);

143 (*
£t_bur¡_ddr_addr
)(
ddr_bur¡_š‹rçû_t
 *, 
u32
 
addr_off£t
);

144 (*
£t_bur¡_¤am_addr
)(
ddr_bur¡_š‹rçû_t
 *, 
u32
 
addr_off£t
);

146 (*
pio_ho¡_to_¤am_wr™e
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 *, );

147 (*
dma_ho¡_to_¤am_wr™e
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
dma_addr_t
 , );

148 (*
pio_ho¡_to_¤am_»ad
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 *, );

149 (*
dma_ho¡_to_¤am_»ad
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
dma_addr_t
 , );

151 (*
¡¬t_block_Œªsãr_äom_¤am_to_ddr
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 , , , );

152 (*
¡¬t_nÚblock_Œªsãr_äom_¤am_to_ddr
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 , , , );

153 (*
¡¬t_block_Œªsãr_äom_ddr_to_¤am
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 , , , );

154 (*
¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
)(
ddr_bur¡_š‹rçû_t
 *, 
d´am_·ge_node_t
 *, 
u32
 , , , );

155 (*
ş—r_bur¡_dÚe
)(
ddr_bur¡_š‹rçû_t
 *);

158 
	sddr_bur¡_š‹rçû_»g
{

159 
acûss_·ge_mode_»g_v®ue
 
·ge_mode_»g_v®ue
;

160 
u32
 
acûss_·ge_mode_»g_off£t
;

162 
bur¡_cmd_¡©us_»g_v®ue
 
cmd_¡©us_»g_v®ue
;

163 
u32
 
bur¡_cmd_¡©us_»g_off£t
;

165 
bur¡_ddr_ba£_addr_»g_v®ue
 
ddr_ba£_addr_»g_v®ue
;

166 
u32
 
bur¡_ddr_addr_»g_off£t
;

168 
bur¡_¤am_ba£_addr_»g_v®ue
 
¤am_ba£_addr_»g_v®ue
;

169 
u32
 
bur¡_¤am_addr_»g_off£t
;

171 
ddr_bur¡_š‹rçû_»g_İ”©iÚ
 *
İ
;

172 
dvm_ch_t
 *
ch
;

175 
	sd´am_·ge_node_İ”©iÚ
{

176 
u32
 (*
g‘_·ge_ba£
)(
d´am_·ge_node_t
 *);

177 
u32
 (*
g‘_·ge_off£t
)(
d´am_·ge_node_t
 *);

178 (*
g‘_·ge_size
)(
d´am_·ge_node_t
 *);

181 
	sd´am_·ge_node
{

182 
u32
 
d´am_ba£
;

183 
u32
 
d´am_·ge_ba£_off£t
;

184 
·ge_size
;

186 
d´am_·ge_node_İ”©iÚ
 *
İ
;

189 
	sd´am_·ge_»sourû_mªage_İ”©iÚ
{

190 (*
š™
)(
d´am_·ge_»sourû_mªage_t
 *);

191 (*
g‘_d´am_·ge
)(
d´am_·ge_»sourû_mªage_t
 *, 
d´am_·ge_node_t
 **);

192 (*
put_d´am_·ge
)(
d´am_·ge_»sourû_mªage_t
 *, 
d´am_·ge_node_t
 **);

193 (*
g‘_ÿn_u£_»sourû_numb”
)(
d´am_·ge_»sourû_mªage_t
 *);

196 
	sd´am_·ge_»sourû_mªage
{

197 
d´am_·ge_node_t
 
d´am
[
DPRAM_PAGE_NUMBER
];

198 
d´am_numb”
, 
cu¼_u£d_d´am_šdex
;

199 
©omic_t
 
cu¼_ÿn_u£_d´am_·ge_numb”
;

200 
¥šlock_t
 
lock
;

202 
d´am_·ge_»sourû_mªage_İ”©iÚ
 *
İ
;

205 
	sddr_video_b™¡»am_buf_node_İ”©iÚ
{

206 (*
g‘_buf_id
)(
ddr_video_b™¡»am_buf_node_t
 *);

207 (*
g‘_buf_š_ch_a_Ü_b
)(
ddr_video_b™¡»am_buf_node_t
 *);

208 (*
g‘_·ge_id
)(
ddr_video_b™¡»am_buf_node_t
 *);

209 
u32
 (*
g‘_buf_ba£_off£t
)(
ddr_video_b™¡»am_buf_node_t
 *);

212 
	#DDR_CHIP_A
 (0)

	)

213 
	#DDR_CHIP_B
 (1)

	)

214 
	sddr_video_b™¡»am_buf_node
{

215 
u32
 
buf_ba£_off£t
;

216 
buf_id
, 
ddr_phy_·ge_id
;

217 
ch_a_Ü_b
;

219 
ddr_video_b™¡»am_buf_node_İ”©iÚ
 *
İ
;

222 
	sddr_video_b™¡»am_»sourû_mªage_İ”©iÚ
{

223 (*
š™
)(
ddr_video_b™¡»am_»sourû_mªage_t
 *);

224 (*
g‘_video_b™¡»am
)(
ddr_video_b™¡»am_»sourû_mªage_t
 *, 
ddr_video_b™¡»am_buf_node_t
 **);

225 (*
put_video_b™¡»am
)(
ddr_video_b™¡»am_»sourû_mªage_t
 *, 
ddr_video_b™¡»am_buf_node_t
 **);

226 (*
g‘_ÿn_u£_»sourû_numb”
)(
ddr_video_b™¡»am_»sourû_mªage_t
 *);

229 
	sddr_video_b™¡»am_»sourû_mªage
{

230 
ddr_video_b™¡»am_buf_node_t
 
ddr_buf_£ùiÚ
[
VIDEO_BITSTREAM_DDR_SECTION_NUMBER
];

231 
ddr_buf_£ùiÚ_numb”
, 
cu¼_u£d_ddr_buf_£ùiÚ_šdex
;

232 
©omic_t
 
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
;

233 
¥šlock_t
 
lock
;

235 
ddr_video_b™¡»am_»sourû_mªage_İ”©iÚ
 *
İ
;

238 
	#DPRAM_BLOCK_TRANSFER_REQUEST
 (0)

	)

239 
	#DPRAM_NONBLOCK_TRANSFER_REQUEST
 (1)

	)

240 
	#to_g‘_d´am_»que¡_w™h_»que¡_node
(
node
è
	`cÚš”_of
Òode, 
d´am_»que¡_t
, 
»que¡_node
)

	)

241 
	sd´am_»que¡
{

242 
ty³
;

243 *
cÚ‹xt
;

244 (*
»q_ÿÎback
)(
d´am_»que¡_t
 *, *);

245 
tcb_node_t
 
»que¡_node
;

248 
	sd´am_»que¡_queue_İ”©iÚ
{

249 (*
š™
)(
d´am_»que¡_queue_t
 *);

250 (*
g‘_queue_cu¼_’Œy_numb”
)(
d´am_»que¡_queue_t
 *);

251 (*
put_£rviû_»que¡_što_queue
)(
d´am_»que¡_queue_t
 *, 
d´am_»que¡_t
 *);

252 (*
put_£rviû_»que¡_što_queue_h—d”
)(
d´am_»que¡_queue_t
 *, 
d´am_»que¡_t
 *);

253 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
d´am_»que¡_queue_t
 *);

254 (*
»Ëa£_cu¼_cÚsum”
)(
d´am_»que¡_queue_t
 *);

255 (*
Œigg”_ch_³ndšg_£rviû_»que¡
)(
d´am_»que¡_queue_t
 *);

258 
	sd´am_»que¡_queue
{

259 
tcb_node_queue_t
 
»que¡_queue
;

260 
d´am_»que¡_t
 *
cu¼_£rviû_»q
;

261 
¥šlock_t
 
lock
;

263 
d´am_»que¡_queue_İ”©iÚ
 *
İ
;

266 
	sd´am_cÚŒŞ_İ”©iÚ
{

267 (*
š™
)(
d´am_cÚŒŞ_t
 *, 
dvm_ch_t
 *);

268 (*
is_ÿn_subm™_h264_’code_£rviû_»q
)(
d´am_cÚŒŞ_t
 *, 
ddr_video_b™¡»am_buf_node_t
 **);

269 (*
»Ëa£_h264_ddr_·ge_»sourû
)(
d´am_cÚŒŞ_t
 *, 
ddr_video_b™¡»am_buf_node_t
 **);

270 (*
is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
)(
d´am_cÚŒŞ_t
 *, 
d´am_·ge_node_t
 **);

271 (*
nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
)(
d´am_cÚŒŞ_t
 *, 
d´am_·ge_node_t
 **);

272 (*
is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
)(
d´am_cÚŒŞ_t
 *, 
d´am_·ge_node_t
 **);

273 (*
nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
)(
d´am_cÚŒŞ_t
 *, 
d´am_·ge_node_t
 **);

274 (*
subm™_»ad_h264_b™¡»am_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_h264_logic_’code_chª_t
 *);

275 (*
ack_»ad_h264_b™¡»am_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_h264_logic_’code_chª_t
 *);

276 (*
subm™_wr™e_video_’code_osd_d©a_»q
)(
d´am_cÚŒŞ_t
 *, 
osd_»ùªgË_’Œy_t
 *);

277 (*
ack_wr™e_video_’code_osd_d©a_»q
)(
d´am_cÚŒŞ_t
 *, 
osd_»ùªgË_’Œy_t
 *);

278 (*
subm™_wr™e_video_’code_osd_©Œ_»q
)(
d´am_cÚŒŞ_t
 *, 
osd_©Œibu‹_»gs_group_t
 *);

279 (*
ack_wr™e_video_’code_osd_©Œ_»q
)(
d´am_cÚŒŞ_t
 *, 
osd_©Œibu‹_»gs_group_t
 *);

280 (*
subm™_»ad_audio_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_audio_driv”_t
 *);

281 (*
ack_»ad_audio_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_audio_driv”_t
 *);

282 (*
subm™_wr™e_audio_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_audio_driv”_t
 *);

283 (*
ack_wr™e_audio_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_audio_driv”_t
 *);

284 (*
subm™_»ad_mj³g_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_j³g_logic_’code_chª_t
 *);

285 (*
ack_»ad_mj³g_»q
)(
d´am_cÚŒŞ_t
 *, 
tw_j³g_logic_’code_chª_t
 *);

288 
	#HOST_END_BUS_BUSY
 (1)

	)

289 
	#DDR_END_BUS_BUSY
 (2)

	)

290 
	#BUS_IDLE
 (0)

	)

291 
	sd´am_cÚŒŞ
{

292 
¥šlock_t
 
lock
;

293 
©omic_t
 
bus_¡©e
;

294 
dvm_ch_t
 *
ch
;

295 
ddr_bur¡_š‹rçû_t
 
bur¡_š‹rçû
;

296 
d´am_»que¡_queue_t
 
»que¡_queue
;

297 
d´am_·ge_»sourû_mªage_t
 
d´am_»sourû
;

298 
ddr_video_b™¡»am_»sourû_mªage_t
 
video_b™¡»am_»sourû
;

300 
d´am_cÚŒŞ_İ”©iÚ
 *
İ
;

303 
š™_ddr_bur¡_š‹rçû_t
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
);

304 
š™_d´am_·ge_»sourû_mªage
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
);

305 
š™_ddr_video_b™¡»am_»sourû_mªage
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
);

306 
š™_d´am_»que¡_£rviû_tcb
(
d´am_»que¡_t
 *
»que¡_tcb
);

307 
š™_d´am_»que¡_queue
(
d´am_»que¡_queue_t
 *
»que¡_queue
);

308 
š™_d´am_cÚŒŞ
(
d´am_cÚŒŞ_t
 *
d´am
, 
dvm_ch_t
 *
ch
);

310 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/dma.h

1 #iâdeà
__DMA_H__


2 
	#__DMA_H__


	)

4 #ifdeà
__ılu¥lus


9 
	#DISRC_OFFSET
 (0)

	)

10 
	#DISRCC_OFFSET
 (4)

	)

11 
	#DIDST_OFFSET
 (8)

	)

12 
	#DIDSTC_OFFSET
 (0xc)

	)

13 
	#DCON_OFFSET
 (0x10)

	)

14 
	#DSTAT_OFFSET
 (0x14)

	)

15 
	#DCSRC_OFFSET
 (0x18)

	)

16 
	#DCDST_OFFSET
 (0x1c)

	)

17 
	#DMASKTRIG_OFFSET
 (0x20)

	)

19 
	#VLC_ENCODER_PING
 (0x2000)

	)

20 
	#VLC_ENCODER_DMA_LEN
 (4096)

	)

21 
	#VLC_ENCODER_PONG
 (0x3000)

	)

22 
	#FPGA_LEN_OFFSET_MASK
 (0x7ff)

	)

24 
	sgDMA


26 vŞ©
u32
 
DISRC
;

27 vŞ©
u32
 
DISRCC
;

28 vŞ©
u32
 
DIDST
;

29 vŞ©
u32
 
DIDSTC
;

30 vŞ©
u32
 
DCON
;

31 vŞ©
u32
 
DSTAT
;

32 vŞ©
u32
 
DCSRC
;

33 vŞ©
u32
 
DCDST
;

34 vŞ©
u32
 
DMASKTRIG
;

35 }
	tDMA_REG
;

37 
	sDMA·¿m


39 
u32
 
¤cAddr
;

40 
s32
 
ifSrcAddrChªge
;

41 
u32
 
de¡Addr
;

42 
s32
 
ifDe¡AddrChªge
;

43 
couÁ
;

44 
dsz
;

45 }
	tDMA_PARAM
;

47 
åga_dma_»ûive
(
u32
 
¤c
, u32 
de¡
, u32 
Ën
);

49 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/dvm_common.h

1 #iâdef 
DVM_COMMON_H


2 
	#DVM_COMMON_H


	)

4 #ifdeà
__ılu¥lus


9 
	~<lšux/ty³s.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/moduË·¿m.h
>

12 
	~<lšux/iİÜt.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/li¡.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/š‹¼u±.h
>

18 
	~<lšux/kmod.h
>

19 
	~<lšux/i2c.h
>

20 
	~<lšux/¡ršgify.h
>

21 
	~<lšux/mu‹x.h
>

22 
	~<lšux/¦ab.h
>

23 
	~<lšux/vm®loc.h
>

24 
	~<lšux/mm.h
>

25 
	~<lšux/wa™.h
>

26 
	~<lšux/com¶‘iÚ.h
>

27 
	~<lšux/time.h
>

28 
	~<lšux/dma-m­pšg.h
>

29 
	~<lšux/¶©fÜm_deviû.h
>

30 
	~<lšux/videodev2.h
>

31 
	~<lšux/dma-m­pšg.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/highmem.h
>

34 
	~<lšux/ä“z”.h
>

35 
	~<lšux/pŞl.h
>

36 
	~<lšux/œq.h
>

37 
	~<lšux/ioùl.h
>

38 
	~<lšux/´oc_fs.h
>

39 
	~<lšux/£q_fe.h
>

40 
	~<lšux/v”siÚ.h
>

42 
	~<asm/io.h
>

43 
	~<asm/·ge.h
>

44 
	~<asm/œq.h
>

45 
	~<asm/©omic.h
>

46 
	~<asm/dma.h
>

47 
	~<asm/uacûss.h
>

49 
	#TW5864_CHIP


	)

51 #ifdef 
ARM_PLATFORM


52 
	~<asm/mach/œq.h
>

53 
	~<asm/mach/dma.h
>

54 
	~<asm/¬ch/»gs-œq.h
>

55 
	~<asm/¬ch/»gs-gpio.h
>

56 
	~<asm/¬ch/»gs-¥i.h
>

57 
	~<asm/£m­hÜe.h
>

60 #ifdeà
POWERPC_PLATFORM


61 #ifdeà
POWERPC_PCI_PLATFORM


62 
	~<lšux/pci.h
>

64 
	#PCI_VENDOR_ID_TW5864
 0x10“

	)

65 
	#PCI_DEVICE_ID_TW5864
 0x0300

	)

67 
	#PCI_VENDOR_ID_TW5864
 0x1797

	)

68 
	#PCI_DEVICE_ID_TW5864
 0x5864

	)

73 
	~<medŸ/v4l2-commÚ.h
>

74 
	~<medŸ/v4l2-dev.h
>

75 #iâdeà
POWERPC_PLATFORM


76 
	~<medŸ/video-buf.h
>

80 
	#MJPEG_MODULE


	)

81 
	#MV_MODULE


	)

82 
	#OSD_MODULE


	)

83 
	#TESTING_TIMESTAMP


	)

84 
	#SUBMIT_OSD_DATA_BY_DPRAM


	)

85 
	#USE_POLLING_DMA


	)

86 
	#HARDWARE_FILL_HEADER


	)

89 
	#USE_ON_CHIP_TIMER


	)

91 
	#TW5864_ASIC_NEW


	)

94 #ifdef 
POWERPC_PLATFORM


95 
	#MAX_CHIP_NUM_IN_BOARD
 (4)

	)

96 
	#INVALID_CHIP_ID
 (
MAX_CHIP_NUM_IN_BOARD
)

	)

97 
	#MAX_GROUP_NUMBER_PER_CHIP
 (4)

	)

98 #iâdeà
POWERPC_PCI_PLATFORM


99 
	#UPM_SYNC_MODE


	)

101 
	#DEFAULT_FRAME_WIDTH
 (704)

	)

102 
	#DEFAULT_FRAME_HEIGHT
 (576)

	)

104 #ifdef 
ARM_S3C2410_TW5864_PLATFORM


105 
	#MAX_CHIP_NUM_IN_BOARD
 (1)

	)

106 
	#INVALID_CHIP_ID
 (
MAX_CHIP_NUM_IN_BOARD
)

	)

107 
	#MAX_CHANNEL_PER_CHIP
 (16)

	)

108 
	#DEFAULT_FRAME_WIDTH
 (704)

	)

109 
	#DEFAULT_FRAME_HEIGHT
 (576)

	)

113 
	#DATA_SECTION_ALIGN
(
x
è
	`__©Œibu‹__
 ((
	`®igÃd
(x)))

	)

114 
	#STRUCT_PACKET_ALIGN
(
x
è
	`__©Œibu‹__
 ((
·cked
))

	)

118 
	#TW_CHIP_IOC_MAGIC
 'H'

	)

119 
	#TW_CODEC_IOC_MAGIC
 'S'

	)

121 
	#H264_MIN
(
a
,
b
èĞ×)<(bè? (aè: (bè)

	)

122 
	#H264_MAX
(
a
,
b
èĞ×)>(bè? (aè: (bè)

	)

123 
	#ABS
(
x
è(((x)<0è? -(xè: (x))

	)

124 
	#H264_MEDIAN
(
mš
, 
max
, 
x
è(
	`H264_MIN
(
	`H264_MAX
((mš), (x)), (max)))

	)

125 
	#H264_MIN3
(
a
,
b
,
c
è
	`H264_MIN
(×),
	`X264_MIN
((b),(c)))

	)

126 
	#H264_MAX3
(
a
,
b
,
c
è
	`H264_MAX
(×),
	`X264_MAX
((b),(c)))

	)

127 
	#H264_MIN4
(
a
,
b
,
c
,
d
è
	`H264_MIN
(×),
	`X264_MIN3
((b),(c),(d)))

	)

128 
	#H264_MAX4
(
a
,
b
,
c
,
d
è
	`H264_MAX
(×),
	`X264_MAX3
((b),(c),(d)))

	)

129 
	#XCHG
(
ty³
,
a
,
b
è{y³ 
t
 =‡;‡ = b; b =; }

	)

131 
	#WIDTH_FRAME_720P
 (1280)

	)

132 
	#WIDTH_FRAME_4CIF_PAL
 (704)

	)

133 
	#WIDTH_FRAME_4CIF_NTSC
 (704)

	)

134 
	#WIDTH_FRAME_D1_PAL
 (704)

135 
	#WIDTH_FRAME_D1_NTSC
 (704)

	)

136 
	#WIDTH_FRAME_HALF_D1_PAL
 (720)

	)

137 
	#WIDTH_FRAME_HALF_D1_NTSC
 (720)

	)

138 
	#WIDTH_FRAME_VGA
 (640)

	)

139 
	#WIDTH_FRAME_CIF_PAL
 (
WIDTH_FRAME_D1_PAL
>>1)

	)

140 
	#WIDTH_FRAME_CIF_NTSC
 (
WIDTH_FRAME_D1_NTSC
>>1)

	)

141 
	#WIDTH_FRAME_QCIF_PAL
 (
WIDTH_FRAME_D1_PAL
>>2)

	)

142 
	#WIDTH_FRAME_QCIF_NTSC
 (
WIDTH_FRAME_D1_NTSC
>>2)

	)

143 
	#WIDTH_FRAME_QVGA
 (
WIDTH_FRAME_VGA
>>1)

	)

145 
	#HEIGHT_FRAME_720P
 (720)

	)

146 
	#HEIGHT_FRAME_4CIF_PAL
 (576)

	)

147 
	#HEIGHT_FRAME_4CIF_NTSC
 (480)

	)

148 
	#HEIGHT_FRAME_D1_PAL
 (576)

	)

149 
	#HEIGHT_FRAME_D1_NTSC
 (480)

	)

150 
	#HEIGHT_FRAME_HALF_D1_PAL
 (288)

	)

151 
	#HEIGHT_FRAME_HALF_D1_NTSC
 (240)

	)

152 
	#HEIGHT_FRAME_VGA
 (480)

	)

153 
	#HEIGHT_FRAME_CIF_PAL
 (
HEIGHT_FRAME_D1_PAL
>>1)

	)

154 
	#HEIGHT_FRAME_CIF_NTSC
 (
HEIGHT_FRAME_D1_NTSC
>>1)

	)

155 
	#HEIGHT_FRAME_QCIF_PAL
 (
HEIGHT_FRAME_D1_PAL
>>2)

	)

156 
	#HEIGHT_FRAME_QCIF_NTSC
 (
HEIGHT_FRAME_D1_NTSC
>>2)

	)

157 
	#HEIGHT_FRAME_QVGA
 (
HEIGHT_FRAME_VGA
>>1)

	)

159 
	#MAX_FRAME_WIDTH
 (
WIDTH_FRAME_720P
)

	)

160 
	#MIN_FRAME_WIDTH
 (
WIDTH_FRAME_QCIF_PAL
)

	)

161 
	#MAX_FRAME_HEIGHT
 (
HEIGHT_FRAME_720P
)

	)

162 
	#MIN_FRAME_HEIGHT
 (
HEIGHT_FRAME_QCIF_NTSC
)

	)

163 
	#MAX_FRAME_RATE_PAL
 (25)

	)

164 
	#MAX_FRAME_RATE_NTSC
 (30)

	)

165 
	#MAX_FRAME_RATE_VGA
 (60)

	)

166 
	#MIN_FRAME_RATE
 (0)

	)

167 
	#MAX_GOP
 (65535)

	)

168 
	#MIN_GOP
 (100)

	)

169 
	#MAX_I_P_STRIDE
 (
MAX_GOP
)

	)

170 
	#MIN_I_P_STRIDE
 (25)

	)

171 
	#MASTER_MAX_BIT_RATE
 (3000000)

	)

172 
	#MASTER_MIN_BIT_RATE
 (64000)

	)

173 
	#SUB_MAX_BIT_RATE
 (1000000)

	)

174 
	#SUB_MIN_BIT_RATE
 (32000)

	)

176 
	#DEFAULT_I_P_STRIDE
 (
MIN_I_P_STRIDE
)

	)

177 
	#DEFAULT_GOP_VALUE
 (
MIN_GOP
)

	)

178 
	#DEFAULT_BITRATE_D1SIZE
 (2000000)

	)

179 
	#DEFAULT_BITRATE_VGASIZE
 (2000000)

180 
	#DEFAULT_BITRATE_QVGASIZE
 (700000)

181 
	#DEFAULT_BITRATE_CIFSIZE
 (1000000)

	)

182 
	#DEFAULT_BITRATE_QCIFSIZE
 (500000)

	)

183 
	#DEFAULT_QP
 (28)

	)

184 
	#DEFAULT_LEVEL_IDC
 (30)

	)

185 
	#DEFAULT_FRAMERATE_PAL
 (
MAX_FRAME_RATE_PAL
)

	)

186 
	#DEFAULT_FRAMERATE_NTSC
 (
MAX_FRAME_RATE_NTSC
)

	)

187 
	#DEFAULT_FRAMERATE_VGA
 (
MAX_FRAME_RATE_VGA
)

	)

190 
	#TW5864_LOGIC_VD_CHAN0
 (0)

	)

191 
	#TW5864_LOGIC_VD_CHAN1
 (1)

	)

192 
	#TW5864_LOGIC_VD_CHAN2
 (2)

	)

193 
	#TW5864_LOGIC_VD_CHAN3
 (3)

	)

194 
	#TW5864_LOGIC_VD_CHAN4
 (4)

	)

195 
	#TW5864_LOGIC_VD_CHAN5
 (5)

	)

196 
	#TW5864_LOGIC_VD_CHAN6
 (6)

	)

197 
	#TW5864_LOGIC_VD_CHAN7
 (7)

	)

198 
	#TW5864_LOGIC_VD_CHAN8
 (8)

	)

199 
	#TW5864_LOGIC_VD_CHAN9
 (9)

	)

200 
	#TW5864_LOGIC_VD_CHAN10
 (10)

	)

201 
	#TW5864_LOGIC_VD_CHAN11
 (11)

	)

202 
	#TW5864_LOGIC_VD_CHAN12
 (12)

	)

203 
	#TW5864_LOGIC_VD_CHAN13
 (13)

	)

204 
	#TW5864_LOGIC_VD_CHAN14
 (14)

	)

205 
	#TW5864_LOGIC_VD_CHAN15
 (15)

	)

206 
	#TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
 (16)

	)

207 
	#TW5864_PHY_VD_CHAN_NUMBER
 (16)

	)

208 
	#TW5864_LOGIC_VD_INVALID
 (-1)

	)

209 
	#TW5864_PHY_VJ_CHAN_NUMBER
 (16)

	)

211 
	#TW_AUDIO_IN_CHAN0_ID
 (0)

	)

212 
	#TW_AUDIO_IN_CHAN1_ID
 (1)

	)

213 
	#TW_AUDIO_IN_CHAN2_ID
 (2)

	)

214 
	#TW_AUDIO_IN_CHAN3_ID
 (3)

	)

215 
	#TW_AUDIO_IN_CHAN4_ID
 (4)

	)

216 
	#TW_AUDIO_IN_CHAN5_ID
 (5)

	)

217 
	#TW_AUDIO_IN_CHAN6_ID
 (6)

	)

218 
	#TW_AUDIO_IN_CHAN7_ID
 (7)

	)

219 
	#TW_AUDIO_IN_CHAN8_ID
 (8)

	)

220 
	#TW_AUDIO_IN_CHAN9_ID
 (9)

	)

221 
	#TW_AUDIO_IN_CHAN10_ID
 (10)

	)

222 
	#TW_AUDIO_IN_CHAN11_ID
 (11)

	)

223 
	#TW_AUDIO_IN_CHAN12_ID
 (12)

	)

224 
	#TW_AUDIO_IN_CHAN13_ID
 (13)

	)

225 
	#TW_AUDIO_IN_CHAN14_ID
 (14)

	)

226 
	#TW_AUDIO_IN_CHAN15_ID
 (15)

	)

227 
	#TW_AUDIO_IN_SPEAKER_ID
 (16)

	)

228 
	#TW_AUDIO_OUT_SPEAKER_ID
 (17)

	)

229 
	#TW_AUDIO_OUT_PLAYBACK_ID
 (18)

	)

231 
	#TW_TRUE
 1

	)

232 
	#TW_FALSE
 0

	)

234 
	#TW_DBG_DEBUG
 3

	)

235 
	#TW_DBG_INFO
 2

	)

236 
	#TW_DBG_ERR
 1

	)

237 
	#TW_DBG_FATAL
 0

	)

239 
	#TW_DBG_CUR_LEVEL
 
TW_DBG_DEBUG


	)

241 
	#MESSAGE_LOG


	)

242 #iâdeà
MESSAGE_LOG


243 
	#TW_DBG
(
Ëv–
, 
fmt
...) \

245 if(
Ëv–
 <ğ
TW_DBG_CUR_LEVEL
){\

246 
	`´štk
("<%d>%s, %d:", 
Ëv–
, 
__FUNCTION__
, 
__LINE__
);\

247 
	`´štk
(
fmt
);\

249 }0)

	)

252 
	#MESSAGE_LEN
 (0x40000)

	)

254 
	#tw_mes§ge_log
(
fmt
...) \

256 if(
mes§ge_log
) { \

257 
mes§ge_log
->
’d
 +ğ
	`¥rštf
(mes§ge_log->
buf
 + mes§ge_log->’d, 
fmt
); \

258 if(
mes§ge_log
->
’d
 >ğ(
MESSAGE_LEN
 - (MESSAGE_LEN>>8))) {\

259 
mes§ge_log
->
’d
 = 0; \

261 
	`wake_up_š‹¼u±ibË
(&
mes§ge_log
->
wa™
);\

263 }0)

	)

265 
	#TW_DBG
(
Ëv–
, 
fmt
...) \

267 if(
Ëv–
 <ğ
TW_DBG_CUR_LEVEL
){\

268 
	`tw_mes§ge_log
("<%d>%s, %d:", 
Ëv–
, 
__FUNCTION__
, 
__LINE__
);\

269 
	`tw_mes§ge_log
(
fmt
);\

271 }0)

	)

275 
tcb_node
 
	ttcb_node_t
;

276 
tcb_poŞ
 
	ttcb_node_poŞ_t
;

277 
tcb_node_queue
 
	ttcb_node_queue_t
;

280 
nÙify_msg
 
	ttw_nÙify_msg
;

281 
tw_»gi¡”_node
 
	ttw_»gi¡”_node_t
;

282 
»gi¡”_bË_node
 
	ttw_»gi¡”_bË_t
;

283 
tw_roÙ_bus
 
	ttw_roÙ_bus_t
;

284 
ty³_bus
 
	tty³_bus_t
;

285 
tw_ch_bus
 
	ttw_ch_bus_t
;

288 
’dpošt_id
 
	ted_id
;

289 
’dpošt_tcb
 
	ted_tcb_t
;

290 
fsm_¡©e_Œªsãr_m©rix_bË
 
	tfsm_¡©e_Œªsãr_m©rix_bË_t
;

291 
tw_ed_fsm
 
	ttw_ed_fsm_t
;

292 
hcd_š‹rçû_İ”©iÚ
 
	ttw_hcd_š‹rçû_İ”©iÚ
;

295 
Çl_´iÜ™y
 
	tÇl_´iÜ™y_e
;

296 
Çl_un™_ty³
 
	tÇl_un™_ty³_e
;

297 
äame_ty³
 
	täame_ty³_e
;

298 
¦iû_ty³
 
	t¦iû_ty³_e
;

299 
h264_Çl
 
	th264_Çl_t
;

300 #ifdeà 
ADD_DVM_NAL_HEAD


301 
_g_dvm_Çl_h—d
 
	tDVM_NAL_HEAD
;

303 
Çl_šfo
 
	tH264_NAL_INFO
;

304 
h264_Çl_h—d
 
	th264_Çl_b™¡»am_t
;

305 
ext_h264_Çl_h—d
 
	text_h264_Çl_b™¡»am_t
;

306 
h264_¥s
 
	th264_¥s_t
;

307 
h264_µs
 
	th264_µs_t
;

308 
h264_¦iû_h—d”
 
	th264_¦iû_h—d”_t
;

311 
š£¹_03_¡©e_machše
 
	tš£¹_03_¡©e_machše_t
;

312 
tw_video_chª_buf_poŞ
 
	ttw_video_chª_buf_poŞ_t
;

313 
tw_video_·ck‘_tcb
 
	ttw_video_·ck‘_tcb_t
;

314 
tw_video_·ck‘_tcb_queue
 
	ttw_video_·ck‘_tcb_queue_t
;

315 
tw_video_äame_tcb
 
	ttw_video_äame_tcb_t
;

316 
tw_video_äame_tcb_queue
 
	ttw_video_äame_tcb_queue_t
;

317 #ifdeà 
MV_MODULE


318 
tw_video_mv_·ck‘_tcb
 
	ttw_video_mv_·ck‘_tcb_t
;

319 
tw_video_mv_·ck‘_tcb_queue
 
	ttw_video_mv_·ck‘_tcb_queue_t
;

320 
tw_video_mv_äame_tcb
 
	ttw_video_mv_äame_tcb_t
;

321 
tw_video_mv_äame_tcb_queue
 
	ttw_video_mv_äame_tcb_queue_t
;

325 
cbr_rc_¡ruù
 
	ttw_cbr_rc_·¿m_t
;

326 
¿‹_cÚŒŞ_driv”_İ
 
	ttw_rc_driv”_İ
;

327 
vbr_rc_¡ruù
 
	ttw_vbr_rc_¡ruù_t
;

328 
cbr_driv”
 
	ttw_cbr_driv”_t
;

329 
vbr_driv”
 
	ttw_vbr_driv”_t
;

330 
rc_tİ_driv”
 
	ttw_rc_driv”_t
;

332 #ifdeà 
OSD_MODULE


334 
osd_©Œibu‹_»gs
 
	tosd_©Œibu‹_»gs_t
;

335 
osd_©Œibu‹_»gs_group
 
	tosd_©Œibu‹_»gs_group_t
;

336 
’code_osd_tim”_©Œ
 
	t’code_osd_tim”_©Œ_t
;

337 
’code_osd_¡ršg_©Œ
 
	t’code_osd_¡ršg_©Œ_t
;

338 
’code_osd_mask_©Œ
 
	t’code_osd_mask_©Œ_t
;

339 
»ùªgË_©Œibu‹
 
	t»ùªgË_©Œibu‹_t
;

340 
osd_mb_poŞ
 
	tosd_mb_poŞ_t
;

341 
osd_mb_ch¬_’Œy
 
	tosd_mb_ch¬_’Œy_t
;

342 
osd_»ùªgË_d´am_tcb
 
	tosd_»ùªgË_d´am_tcb_t
;

343 
osd_»ùªgË_’Œy
 
	tosd_»ùªgË_’Œy_t
;

344 
osd_chª_’gše
 
	tosd_chª_’gše_t
;

345 
_TW_OSD_PARAM
 
	tTW_OSD_PARAM
;

349 
tw_time¡amp
 
	ttw_time¡amp_t
;

350 
tw_h264_’code_cÚfigu¿tiÚ
 
	ttw_h264_’code_cÚfigu¿tiÚ_t
;

351 
tw_h264_’code_´İ”ty
 
	ttw_h264_’code_´İ”ty_t
;

352 
tw_h264_logic_video_¦Ù
 
	ttw_h264_logic_video_¦Ù_t
;

353 
vd_chª_m­_šfo
 
	tvd_chª_m­_šfo_t
;

354 
tw5864_vd_üoss_bus
 
	ttw5864_vd_üoss_bus_t
;

355 
tw_vd_Üig_buf_šfo
 
	ttw_vd_Üig_buf_šfo_t
;

356 
tw_h264_phy_video_¦Ù
 
	ttw_h264_phy_video_¦Ù_t
;

357 
tw_h264_’code_cÚŒŞ
 
	ttw_h264_’code_cÚŒŞ_t
;

358 
’code_chª_£rviû_tcb
 
	t’code_chª_£rviû_tcb_t
;

359 
ch_’code_chª_£rviû_queue
 
	tch_’code_chª_£rviû_queue_t
;

360 
tw_h264_logic_’code_chª
 
	ttw_h264_logic_’code_chª_t
;

361 
ddr_b™¡»am_h—d”
 
	tddr_b™¡»am_h—d”_t
;

362 
ddr_video_b™¡»am_h—d”
 
	tddr_video_b™¡»am_h—d”_t
;

365 
tw_j³g_logic_’code_chª
 
	ttw_j³g_logic_’code_chª_t
;

369 
tw_audio_£ùiÚ_desütÜ
 
	ttw_audio_desütÜ_t
;

370 
tw_audio_·¿m
 
	ttw_audio_·¿m_t
;

371 
audio_cÚfig_desütÜ
 
	ttw_audio_cÚfig_desütÜ_t
;

372 
audio_’code_cÚŒŞ
 
	taudio_’code_cÚŒŞ_t
;

373 
audio_pcm_’code_±r_cÚŒŞ
 
	taudio_pcm_’code_±r_cÚŒŞ_t
;

374 
audio_pcm_’code_d©a_addr
 
	taudio_pcm_’code_d©a_addr_t
;

375 
audio_adpcm_’code_±r_cÚŒŞ
 
	taudio_adpcm_’code_±r_cÚŒŞ_t
;

376 
audio_adpcm_’code_d©a_addr
 
	taudio_adpcm_’code_d©a_addr_t
;

377 
ch_audio_’code
 
	tch_audio_’code_t
;

378 
audio_decode_cÚŒŞ
 
	taudio_decode_cÚŒŞ_t
;

379 
audio_decode_±r_cÚŒŞ
 
	taudio_decode_±r_cÚŒŞ_t
;

380 
audio_decode_d©a_addr
 
	taudio_decode_d©a_addr_t
;

381 
ch_audio_decode
 
	tch_audio_decode_t
;

382 
audio_’abË_cÚŒŞ
 
	taudio_’abË_cÚŒŞ_t
;

383 
ch_audio
 
	tch_audio_t
;

386 
audio_£ùiÚ_desütÜ
 
	taudio_£ùiÚ_desütÜ_t
;

387 
tw_audio_chª_buf_poŞ
 
	ttw_audio_chª_buf_poŞ_t
;

388 
tw_audio_·ck‘_£ùiÚ
 
	ttw_audio_·ck‘_£ùiÚ_t
;

389 
tw_audio_·ck‘_queue
 
	ttw_audio_·ck‘_queue_t
;

392 
tw_audio_chª_driv”
 
	ttw_audio_driv”_t
;

393 
audio_£ùiÚ_±r_šfo
 
	taudio_£ùiÚ_±r_šfo_t
;

396 
ddr_bur¡_š‹rçû_»g
 
	tddr_bur¡_š‹rçû_t
;

397 
d´am_·ge_node
 
	td´am_·ge_node_t
;

398 
d´am_·ge_»sourû_mªage
 
	td´am_·ge_»sourû_mªage_t
;

399 
ddr_video_b™¡»am_buf_node
 
	tddr_video_b™¡»am_buf_node_t
;

400 
ddr_video_b™¡»am_»sourû_mªage
 
	tddr_video_b™¡»am_»sourû_mªage_t
;

401 
d´am_»que¡
 
	td´am_»que¡_t
;

402 
d´am_»que¡_queue
 
	td´am_»que¡_queue_t
;

403 
d´am_cÚŒŞ
 
	td´am_cÚŒŞ_t
;

407 
	tblock¿m_addr
;

408 
	tåga_»g_addr
;

409 
dvm4000i_ch
 
	tdvm_ch_t
;

410 
tw5864_š‹¼u±_cÚŒŞ
 
	ttw5864_š‹¼u±_cÚŒŞ_t
;

418 
avSync_äame_buf_poŞ
 
	tavSync_äame_buf_poŞ_t
;

419 
avSync_äame_tcb
 
	tavSync_äame_tcb_t
;

420 
avSync_äame_queue
 
	tavSync_äame_queue_t
;

424 
tw5864_avSync_dev
 
	ttw5864_avSync_dev_t
;

429 
tw_kth»ad_msg
 
	ttw_kth»ad_msg_t
;

430 
tw_kth»ad_msg_queue
 
	ttw_kth»ad_msg_queue_t
;

431 
tw_kth»ad_msg_poŞ
 
	ttw_kth»ad_msg_poŞ_t
;

435 
tw_äame_h—d”
 
	ttw_äame_h—d”_t
;

436 
tw_h264_idr_äame_·d
 
	ttw_h264_idr_äame_·d_t
;

437 
tw_video_mÙiÚ_veùÜ_·d
 
	ttw_video_mÙiÚ_veùÜ_·d_t
;

438 
tw_audio_äame_·d
 
	ttw_audio_äame_·d_t
;

440 
	~<tw5864/H®SoáTim”Lib.h
>

441 
	~<tw5864/dma.h
>

443 
	~<tw5864/dvm_Ãw_buf.h
>

444 
	~<tw5864/ch_bus_scheduË.h
>

445 
	~<tw5864/tw_’dpošt.h
>

446 
	~<tw5864/tw_kth»ad_msg.h
>

447 
	~<tw5864/ddr_bur¡_š‹rçû.h
>

448 
	~<tw5864/b¬_ùl.h
>

449 
	~<tw5864/bs.h
>

450 
	~<tw5864/b™¡»am.h
>

451 
	~<tw5864/gŞomb.h
>

452 
	~<tw5864/®go_h264_driv”.h
>

453 
	~<tw5864/tw_h264_video_buf.h
>

454 
	~<tw5864/dvm_rc.h
>

455 #ifdeà 
OSD_MODULE


456 
	~<tw5864/dvm_osd.h
>

458 
	~<tw5864/tw_h264_’code.h
>

460 
	~<tw5864/tw_audio_iİ.h
>

461 
	~<tw5864/tw_audio_buf.h
>

462 
	~<tw5864/tw_audio_chª_driv”.h
>

464 
	~<tw5864/tw_vb_commÚ.h
>

465 
	~<tw5864/tw_j³g_codec.h
>

467 
	~<tw5864/tw_avSync_deviû_buf.h
>

468 
	~<tw5864/tw_avSync_deviû.h
>

471 
	~<tw5864/´oc_’Œy.h
>

472 
	~<tw5864/tc_commÚ.h
>

473 
	~<tw5864/tw_ch_driv”.h
>

474 
	~<tw5864/tw_ch_ai.h
>

475 
	~<tw5864/tw_ch_ao.h
>

476 
	~<tw5864/tw_ch_vi.h
>

477 
	~<tw5864/tw_ch_vo.h
>

478 
	~<tw5864/tw_decode_sync.h
>

479 
	~<tw5864/tw_video_di¥Ïy.h
>

480 
	~<tw5864/tw5864_ch.h
>

482 
	~<tw5864/tw_š‹rçû.h
>

484 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/dvm_new_buf.h

1 #iâdef 
DVM_NEW_BUF_H


2 
	#DVM_NEW_BUF_H


	)

4 #ifdeà
__ılu¥lus


9 
	eTCB_NODE_STATE
 {

10 
TCB_IDLE_STATE
 = 0,

11 
TCB_STANDBY_STATE
,

12 
TCB_RUNNING_STATE
,

13 
TCB_SUSPEND_STATE
,

14 
TCB_CLOSE_STATE


17 
	stcb_node_İ”©iÚ
{

18 (*
š™
)(
tcb_node_t
 *);

19 (*
£t_´iv
)(
tcb_node_t
 *, *);

20 (*
»ã»nû
)(
tcb_node_t
 *,cb_node_t **);

21 (*
»Ëa£
)(
tcb_node_t
 *, 
tcb_node_poŞ_t
 *);

22 (*
upd©e_¡©e
)(
tcb_node_t
 *, );

25 
	stcb_node
{

26 
li¡_h—d
 
li¡
;

27 *
tcb_´iv
;

28 
©omic_t
 
»f_couÁ
;

29 
TCB_NODE_STATE
 
¡©e
;

31 
tcb_node_İ”©iÚ
 *
İ
;

34 
	stcb_poŞ_İ”©iÚ
{

35 (*
š™
)(
tcb_node_poŞ_t
 *, );

36 (*
»Ëa£
)(
tcb_node_poŞ_t
 *);

38 (*
g‘
)(
tcb_node_poŞ_t
 *, 
tcb_node_t
 **);

39 (*
Œy_g‘
)(
tcb_node_poŞ_t
 *, 
tcb_node_t
 **);

40 (*
put
)(
tcb_node_poŞ_t
 *, 
tcb_node_t
 *);

42 (*
g‘_cu¼_poŞ_’Œy_numb”
)(
tcb_node_poŞ_t
 *);

45 
	stcb_poŞ
{

46 
li¡_h—d
 
poŞ_h—d”
;

47 
wa™_queue_h—d_t
 
wa™
;

48 
¥šlock_t
 
lock
;

49 
©omic_t
 
cu¼_poŞ_’Œy_numb”
;

50 
poŞ_’Œy_numb”
;

52 
tcb_poŞ_İ”©iÚ
 *
İ
;

55 
	stcb_node_queue_İ”©iÚ
{

56 (*
g‘_queue_cu¼_’Œy_numb”
)(
tcb_node_queue_t
 *);

58 (*
š™
)(
tcb_node_queue_t
 *);

59 (*
put
)(
tcb_node_queue_t
 *, 
tcb_node_t
 *);

60 (*
put_h—d”
)(
tcb_node_queue_t
 *, 
tcb_node_t
 *);

61 (*
g‘
)(
tcb_node_queue_t
 *, 
tcb_node_t
 **);

62 (*
g‘_”
)(
tcb_node_queue_t
 *, 
tcb_node_t
 **);

63 (*
Œy_g‘
)(
tcb_node_queue_t
 *, 
tcb_node_t
 **);

64 (*
Œy_g‘_”
)(
tcb_node_queue_t
 *, 
tcb_node_t
 **);

67 
	stcb_node_queue
{

68 
¥šlock_t
 
lock
;

69 
li¡_h—d
 
queue_h—d”
;

70 
wa™_queue_h—d_t
 
wa™
;

71 
©omic_t
 
cu¼_queue_’Œy_numb”
;

73 
tcb_node_queue_İ”©iÚ
 *
İ
;

76 
tcb_node_İ”©iÚ
 
tcb_node_İ
;

77 
tcb_poŞ_İ”©iÚ
 
tcb_node_poŞ_İ
;

78 
tcb_node_queue_İ”©iÚ
 
tcb_node_queue_İ
;

80 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/dvm_osd.h

1 #iâdef 
DVM_OSD_H


2 
	#DVM_OSD_H


	)

4 #ifdeà
__ılu¥lus


9 
	#TIMER_RECTANGLE_ID
 (0)

	)

10 
	#CHAN_NAME_RECTANGLE_ID
 (1)

	)

11 
	#SUBTILTE1_RECTANGLE_ID
 (2)

	)

12 
	#SUBTILTE2_RECTANGLE_ID
 (3)

	)

13 
	#SUBTILTE3_RECTANGLE_ID
 (4)

	)

14 
	#SUBTILTE4_RECTANGLE_ID
 (5)

	)

15 
	#SHELTER1_RECTANGLE_ID
 (6)

	)

16 
	#SHELTER2_RECTANGLE_ID
 (7)

	)

18 
	#NAME_LEN
 (32)

	)

19 
	#SUB_LEN
 (44)

	)

20 
	#OSD_ATTR_DISPLAY_OFF
 (0)

	)

21 
	#OSD_ATTR_DISPLAY_ON
 (0x1)

	)

22 
	#OSD_FONT_12
 (0x2)

	)

23 
	#OSD_FONT_24
 (0x8)

	)

24 
	#OSD_FONT_MASK
 (0xe)

	)

25 
	#CHAR_RECTANGLE_X_LEFT
 (8)

	)

26 
	#CHAR_RECTANGLE_Y_LEFT
 (2)

	)

28 
	s_TW_OSD_PARAM
 {

29 
chªÃl
;

30 
Çme
[
NAME_LEN
];

31 
Çme_©Œib
;

32 
Çme_pos_x
;

33 
Çme_pos_y
;

34 
time_©Œib
;

35 
time_pos_x
;

36 
time_pos_y
;

37 
sh–‹r1_©Œib
;

38 
sh–‹r1_pos_x
;

39 
sh–‹r1_pos_y
;

40 
sh–‹r1_width
;

41 
sh–‹r1_height
;

42 
sh–‹r2_©Œib
;

43 
sh–‹r2_pos_x
;

44 
sh–‹r2_pos_y
;

45 
sh–‹r2_width
;

46 
sh–‹r2_height
;

47 
subt™Ë1
[
SUB_LEN
];

48 
subt™Ë1_©Œib
;

49 
subt™Ë1_pos_x
;

50 
subt™Ë1_pos_y
;

51 
subt™Ë2
[
SUB_LEN
];

52 
subt™Ë2_©Œib
;

53 
subt™Ë2_pos_x
;

54 
subt™Ë2_pos_y
;

55 
subt™Ë3
[
SUB_LEN
];

56 
subt™Ë3_©Œib
;

57 
subt™Ë3_pos_x
;

58 
subt™Ë3_pos_y
;

59 
subt™Ë4
[
SUB_LEN
];

60 
subt™Ë4_©Œib
;

61 
subt™Ë4_pos_x
;

62 
subt™Ë4_pos_y
;

65 
	#OSD_CHAN_RECTANGLE_NUMBER
 (8)

	)

66 
	#OSD_CHAN_MAX_STRING_RECTANGLE_NUMBER
 (7)

	)

67 
	#OSD_MB_ENTRY_NUMBER
 (1024)

	)

68 
	#OSD_MB_BUF_CHAR_BITMAP_LEN
 (32>>2)

	)

70 
	#INVALID_OSD_VALUE_ID
 (-1)

	)

72 
	#ENCODE_OSD_MODE0
 (0)

	)

73 
	#ENCODE_OSD_MODE1
 (1)

	)

74 
	#ENCODE_OSD_MODE2
 (2)

	)

75 
	#ENCODE_OSD_MODE3
 (3)

	)

78 
	sosd_©Œibu‹_»gs1
{

79 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

80 
u32
 
»ùªgË_mb_x
:7;

81 
u32
 
»ùªgË_mb_y
:7;

82 
u32
 
»ùªgË_mb_x_width
:7;

83 
u32
 
»ùªgË_mb_y_height
:7;

84 
u32
 
d©a_ba£_addr8
:1;

85 
u32
 
mode
:2;

86 
u32
 
’abË
:1;

87 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

88 
u32
 
’abË
:1;

89 
u32
 
mode
:2;

90 
u32
 
d©a_ba£_addr8
:1;

91 
u32
 
»ùªgË_mb_y_height
:7;

92 
u32
 
»ùªgË_mb_x_width
:7;

93 
u32
 
»ùªgË_mb_y
:7;

94 
u32
 
»ùªgË_mb_x
:7;

98 }
STRUCT_PACKET_ALIGN
(1);

100 
	uosd_©Œ_»g1_v®ue
{

101 
osd_©Œibu‹_»gs1
 
»g1
;

102 
u32
 
v®ue
;

103 }
STRUCT_PACKET_ALIGN
(1);

105 
	sosd_©Œibu‹_»gs2
{

106 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

107 
u32
 
mode1_äÚt_v
:8;

108 
u32
 
mode1_äÚt_u
:8;

109 
u32
 
mode1_äÚt_y
:8;

110 
u32
 
d©a_ba£_addr_7_0
:8;

111 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

112 
u32
 
d©a_ba£_addr_7_0
:8;

113 
u32
 
mode1_äÚt_y
:8;

114 
u32
 
mode1_äÚt_u
:8;

115 
u32
 
mode1_äÚt_v
:8;

119 }
STRUCT_PACKET_ALIGN
(1);

121 
	uosd_©Œ_»g2_v®ue
{

122 
osd_©Œibu‹_»gs2
 
»g2
;

123 
u32
 
v®ue
;

124 }
STRUCT_PACKET_ALIGN
(1);

126 
	sosd_©Œibu‹_»gs3
{

127 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

128 
u32
 
mode1_background_v
:8;

129 
u32
 
mode1_background_u
:8;

130 
u32
 
mode1_background_y
:8;

131 
u32
 
d©a_ba£_m­_mode
:2;

132 
u32
 
osd_d©a_add»ss_off£t
:3;

133 
u32
 
»£rved
:3;

134 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

135 
u32
 
»£rved
:3;

136 
u32
 
osd_d©a_add»ss_off£t
:3;

137 
u32
 
d©a_ba£_m­_mode
:2;

138 
u32
 
mode1_background_y
:8;

139 
u32
 
mode1_background_u
:8;

140 
u32
 
mode1_background_v
:8;

144 }
STRUCT_PACKET_ALIGN
(1);

146 
	uosd_©Œ_»g3_v®ue
{

147 
osd_©Œibu‹_»gs3
 
»g3
;

148 
u32
 
v®ue
;

149 }
STRUCT_PACKET_ALIGN
(1);

151 
	sosd_©Œibu‹_»gs_İ”©iÚ
{

152 (*
£t
)(
osd_©Œibu‹_»gs_t
 *);

153 (*
£t_no_di¥Ïy
)(
osd_©Œibu‹_»gs_t
 *);

154 (*
»£t
)(
osd_©Œibu‹_»gs_t
 *);

157 
	sosd_©Œibu‹_»gs
{

158 
osd_©Œ_»g1_v®ue
 
»g1_v®ue
;

159 
osd_©Œ_»g2_v®ue
 
»g2_v®ue
;

160 
osd_©Œ_»g3_v®ue
 
»g3_v®ue
;

163 
	eENCODE_OSD_TIMER_DISPLAY
{

164 
YEAR_MONTH_DAY_HOUR_MINUTE_SECOND
=0,

165 
YEAR_NONTH_DAY_NEWLINE_HOUR_MINUTE_SECOND_LEFT_ALIGN
,

166 
YEAR_MONTH_DAY_NEWLINE_HOUR_MINUTE_SECOND_RIGHT_ALIGN
,

167 
DONT_DISPLAY_TIMER
,

170 
osd_sy¡em_tim”
 
	tosd_sy¡em_tim”_t
;

171 
	sosd_sy¡em_tim”
{

172 
y—r
;

173 
mÚth
;

174 
day
;

175 
hour
;

176 
mšu‹
;

177 
£cÚd
;

178 
u32
 
Ãed_upd©e_m­_bË
[
MAX_CHIP_NUM_IN_BOARD
];

181 
	s’code_osd_tim”_©Œ_İ”©iÚ
{

182 (*
»£t
)(
’code_osd_tim”_©Œ_t
 *, , );

185 
	s’code_osd_tim”_©Œ
{

186 
tim”_di¥Ïy_mode
;

187 
mb_x
, 
mb_y
;

188 
fÚt_ty³
;

189 
Ãed_upd©e_æag
;

190 
osd_sy¡em_tim”_t
 *
tim”
;

191 
’code_osd_tim”_©Œ_İ”©iÚ
 *
İ
;

194 
	eENCODE_OSD_STRING_DATA_ADDR_MAP_MODE
{

195 
Y8MB_X128MB_OSDMODE013
 = 0,

196 
Y16MB_X64MB_OSDMODE013
,

197 
Y32MB_X32MB_OSDMODE013
,

198 
Y64MB_X16MB_OSDMODE013
,

201 
	s’code_osd_¡ršg_©Œ_İ”©iÚ
{

202 (*
»£t
)(
’code_osd_¡ršg_©Œ_t
 *);

205 
	#FONT_TYPE_12X12
 (0x02)

	)

206 
	#ASCII12_PIXEL_WIDTH
 (8)

	)

207 
	#FONT12_PIXEL_WIDTH
 (12)

	)

208 
	#FONT_TYPE_16X16
 (0x04)

	)

209 
	#ASCII16_PIXEL_WIDTH
 (8)

	)

210 
	#FONT16_PIXEL_WIDTH
 (16)

	)

211 
	#FONT_TYPE_24X24
 (0x08)

	)

212 
	#ASCII24_PIXEL_WIDTH
 (12)

	)

213 
	#FONT24_PIXEL_WIDTH
 (24)

	)

214 
	#MB_PIXEL_WIDTH
 (16)

	)

215 
	s’code_osd_¡ršg_©Œ
{

216 
mb_x
, 
mb_y
;

217 
mb_width
, 
mb_height
;

218 
d©a_addr_m­_mode
;

219 
Ãed_upd©e_æag
;

220 
u8
 *
¡ršg
;

221 
¡ršg_Ën
;

222 
fÚt_ty³
;

223 
’code_osd_¡ršg_©Œ_İ”©iÚ
 *
İ
;

226 
	s’code_osd_mask_©Œ_İ”©iÚ
{

227 (*
»£t
)(
’code_osd_mask_©Œ_t
 *);

230 
	s’code_osd_mask_©Œ
{

231 
mb_x
, 
mb_y
;

232 
mask_width
, 
mask_height
;

233 
y_v®ue
, 
u_v®ue
, 
v_v®ue
;

234 
d©a_addr_m­_mode
;

235 
Ãed_upd©e_æag
;

236 
is_di¥Ïy
;

237 
’code_osd_mask_©Œ_İ”©iÚ
 *
İ
;

240 
	sosd_mb_poŞ_İ”©iÚ
{

241 (*
ü—‹
)(
osd_mb_poŞ_t
 *
chª_osd_mb_buf_poŞ
, );

242 (*
»Ëa£
)(
osd_mb_poŞ_t
 *
chª_osd_mb_buf_poŞ
);

244 (*
g‘
)(
osd_mb_poŞ_t
 *, 
osd_mb_ch¬_’Œy_t
 **, 
osd_»ùªgË_’Œy_t
 *);

245 (*
Œy_g‘
)(
osd_mb_poŞ_t
 *, 
osd_mb_ch¬_’Œy_t
 **, 
osd_»ùªgË_’Œy_t
 *);

246 (*
put
)(
osd_mb_poŞ_t
 *, 
osd_mb_ch¬_’Œy_t
 *);

247 (*
g‘_osd_mb_tcb_poŞ_’Œy_numb”
)(
osd_mb_poŞ_t
 *
chª_osd_buf_poŞ
);

250 
	sosd_mb_poŞ
{

251 
mb_ch¬_ÿche_Üd”
;

252 
tcb_node_poŞ_t
 
osd_mb_ch¬_poŞ_tcb
;

253 
dvm_ch_t
 *
ch
;

254 
osd_mb_ch¬_’Œy_t
 *
mb_ch¬_’Œy_ÿche
;

256 
osd_mb_poŞ_İ”©iÚ
 *
İ
;

259 
	sosd_mb_ch¬_İ”©iÚ
{

260 (*
»£t
)(
osd_mb_ch¬_’Œy_t
 *);

261 (*
»Ëa£
)(
osd_mb_ch¬_’Œy_t
 *);

262 (*
upd©e_mb_vœtu®_d©a
)(
osd_mb_ch¬_’Œy_t
 *, , );

263 (*
upd©e_åga_osd_d©a
)(
osd_mb_ch¬_’Œy_t
 *);

266 
	#to_g‘_osd_mb_ch¬_’Œy_w™h_node
(
node
è
	`cÚš”_of
Òode, 
osd_mb_ch¬_’Œy_t
, 
osd_mb_node
)

	)

267 
	sosd_mb_ch¬_’Œy
{

268 
osd_mb_poŞ_t
 *
poŞ
;

269 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

270 
tcb_node_t
 
osd_mb_node
;

271 
ddr_·ge
, 
ddr_·ge_off£t
;

272 
u32
 
osd_d©a_addr_ba£
;

274 
u8
 
mb_ch¬_buf
[
OSD_MB_BUF_CHAR_BITMAP_LEN
<<2];

275 
u32
 *
·ylßd
, 
·ylßd_Ën
;

276 
»f_mb_x
, 
»f_mb_y
;

278 
osd_mb_ch¬_İ”©iÚ
 *
İ
;

281 
	sosd_»ùªgË_d´am_tcb_İ”©iÚ
{

282 (*
š™
)(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
);

283 (*
subm™_wr™e_osd_»ùªgË_d©a_»q
)(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
);

284 (*
subm™_wr™e_osd_»ùªgË_©Œ
)(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
);

285 (*
»¥Ú£_wr™e_osd_»ùªgË
)(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
);

288 
	sosd_»ùªgË_d´am_tcb
{

289 
d´am_»que¡_t
 
osd_d©a_»q
;

290 
d´am_·ge_node_t
 *
d´am_·ge
;

292 
osd_»ùªgË_d´am_tcb_İ”©iÚ
 *
İ
;

295 
	sosd_»ùªgË_İ”©iÚ
{

296 (*
»£t
)(
osd_»ùªgË_’Œy_t
 *);

297 (*
şo£_»ùªgË
)(
osd_»ùªgË_’Œy_t
 *);

298 (*
put_mb_što_»ùªgË
)(
osd_»ùªgË_’Œy_t
 *, 
osd_mb_ch¬_’Œy_t
 *);

299 (*
Œy_g‘_mb_äom_»ùªgË
)(
osd_»ùªgË_’Œy_t
 *, 
osd_mb_ch¬_’Œy_t
 **);

300 (*
upd©e_»ùªgË_åga_buf
)(
osd_»ùªgË_’Œy_t
 *);

301 (*
upd©e_»ùªgË_©Œ_»gs
)(
osd_»ùªgË_’Œy_t
 *);

302 (*
decide_»ùªgË_d©a_addr_m­
)(
osd_»ùªgË_’Œy_t
 *, 
video_sourû_size
);

303 (*
£t_»ùªgË_m­_mode
)(
osd_»ùªgË_’Œy_t
 *, );

306 
	u»ùªgË_©Œibu‹
{

307 *
em±y_»ùªgË_©Œibu‹
;

308 
’code_osd_tim”_©Œ_t
 *
time_»ùªgË_©Œibu‹
;

309 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_»ùªgË_©Œibu‹
;

310 
’code_osd_mask_©Œ_t
 *
mask_»ùªgË_©Œibu‹
;

313 
	eENCODE_OSD_RECTANGLE_TYPE
{

314 
EMPTY_RECTANGLE_ENCODE_OSD
,

315 
TIMER_RECTANGLE_ENCODE_OSD
,

316 
CHAR_RECTANGLE_ENCODE_OSD
,

317 
MASK_RECTANGLE_ENCODE_OSD
,

320 
	#to_osd_»ùªgË_’Œy_w™h_osd_»ùªgË_d´am_tcb
(
node
è
	`cÚš”_of
Òode, 
osd_»ùªgË_’Œy_t
, 
osd_d´am_»q
)

	)

321 
	sosd_»ùªgË_’Œy
{

322 
dvm_ch_t
 *
ch
;

323 
osd_chª_’gše_t
 *
osd_chª_’gše
;

324 
tcb_node_queue_t
 
mb_ch¬_queue_node
;

325 
osd_’abË
;

326 
Ãed_upd©e_d©a
;

327 
Ãed_upd©e_©Œ
;

328 
»ùªgË_mode
;

329 
»ùªgË_id
;

330 
chª_id
;

331 
»ùªgË_Ëá_x
, 
»ùªgË_Ëá_y
, 
»ùªgË_right_x
, 
»ùªgË_right_y
;

332 
»ùªgË_©Œibu‹_t
 
´iv©e_©Œi
;

333 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
;

334 
osd_d©a_addr_ba£
;

335 
osd_»ùªgË_d´am_tcb_t
 
osd_d´am_»q
;

337 
osd_»ùªgË_İ”©iÚ
 *
İ
;

340 
	sosd_chª_’gše_İ”©iÚ
{

341 (*
ü—‹_ch¬_»ùªgË
)(
osd_chª_’gše_t
 *, );

342 (*
ü—‹_mask_»ùªgË
)(
osd_chª_’gše_t
 *, );

343 #ifdef 
TESTING_TIMESTAMP


344 (*
ü—‹_tim”_»ùªgË
)(
osd_chª_’gše_t
 *, , , , , );

345 (*
ü—‹_»ùªgË
)(
osd_chª_’gše_t
 *, 
TW_OSD_PARAM
 *, , , , , );

347 (*
ü—‹_tim”_»ùªgË
)(
osd_chª_’gše_t
 *);

348 (*
ü—‹_»ùªgË
)(
osd_chª_’gše_t
 *, 
TW_OSD_PARAM
 *);

350 (*
şo£_chª_’gše_»ùªgËs
)(
osd_chª_’gše_t
 *);

351 (*
upd©e_’code_osd_´İ”ty
)(
osd_chª_’gše_t
 *, 
TW_OSD_PARAM
 *);

352 (*
upd©e_åga_osd_’code
)(
osd_chª_’gše_t
 *);

353 (*
g‘_»ùªgË
)(
osd_chª_’gše_t
 *, 
osd_»ùªgË_’Œy_t
 **, , );

354 (*
put_»ùªgË
)(
osd_chª_’gše_t
 *, 
osd_»ùªgË_’Œy_t
 *);

357 
	sosd_©Œibu‹_»gs_group_İ”©iÚ
{

358 (*
š™_osd_chª_»ùªgË_©Œ_»gs_group
)(
osd_©Œibu‹_»gs_group_t
 *);

359 (*
chª_»ùªgË_©Œ_»gs_£t
)(
osd_©Œibu‹_»gs_group_t
 *, 
»ù_id
);

360 (*
chª_»ùªgË_©Œ_»gs_£t_no_di¥Ïy
)(
osd_©Œibu‹_»gs_group_t
 *, 
»ù_id
);

361 (*
chª_»ùªgË_©Œ_»gs_»£t
)(
osd_©Œibu‹_»gs_group_t
 *, 
»ù_id
);

362 (*
upd©e_chª_»ùªgË_©Œ_»gs
)(
osd_©Œibu‹_»gs_group_t
 *, 
dvm_ch_t
 *);

365 
	#to_osd_©Œibu‹_»gs_group_w™h_osd_d´am_»q
(
node
è
	`cÚš”_of
Òode, 
osd_©Œibu‹_»gs_group_t
, 
osd_d´am_»q
)

	)

366 
	sosd_©Œibu‹_»gs_group
{

367 
osd_©Œibu‹_»gs_t
 
©Œibu‹_»gs_group
[
OSD_CHAN_RECTANGLE_NUMBER
];

368 
u32
 
osd_chª_©Œ_»g_ba£
;

369 
u32
 
osd_chª_©Œ_»g_·ge_id
;

370 
osd_»ùªgË_d´am_tcb_t
 
osd_d´am_»q
;

372 
osd_©Œibu‹_»gs_group_İ”©iÚ
 *
chª_»ù_©Œ_»gs_group_İ
;

373 
osd_©Œibu‹_»gs_İ”©iÚ
 *
»ù_©Œ_»gs_İ
;

376 
	#to_osd_chª_’gše_w™h_osd_©Œibu‹_»gs_group
(
node
è
	`cÚš”_of
Òode, 
osd_chª_’gše_t
, 
©Œibu‹_»gs
)

	)

377 
	sosd_chª_’gše
{

378 
¥šlock_t
 
osd_lock
;

379 
©omic_t
 
osd_is_wÜkšg
;

380 
com¶‘iÚ
 
wa™_dÚe
;

381 
osd_©Œibu‹_»gs_group_t
 
©Œibu‹_»gs
;

382 
osd_mb_poŞ_t
 
osd_chª_poŞ
;

384 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

385 
TW_OSD_PARAM
 
osd_ruÂšg_·¿m
;

386 
©omic_t
 
sync_osd_·¿m
;

387 
u32
 
chª_»ùªgË_u£d_m­_bË
;

388 
u32
 
chª_d©a_ba£
;

389 
ma¡”OrSub
;

390 
videoSizeMode
;

391 
osd_»ùªgË_’Œy_t
 
»ùªgË
[
OSD_CHAN_RECTANGLE_NUMBER
];

392 
’code_osd_tim”_©Œ_t
 
tim”_©Œ
;

393 
’code_osd_¡ršg_©Œ_t
 
¡ršg_©Œ
[
OSD_CHAN_MAX_STRING_RECTANGLE_NUMBER
];

394 
’code_osd_mask_©Œ_t
 
mask_©Œ
[
OSD_CHAN_MAX_STRING_RECTANGLE_NUMBER
];

396 
osd_chª_’gše_İ”©iÚ
 *
İ
;

400 
check_¹c_time
(
timev®
 *
tv1
);

401 
şo£_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *);

402 
»move_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *);

403 
š™_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *, );

405 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/dvm_rc.h

1 #iâdeà
_DVM_RC_H_


2 
	#_DVM_RC_H_


	)

4 #ifdeà
__ılu¥lus


9 
__u8
 
	tboŞ—n
;

11 
	#SMOOTH_WINDOW_MIN_SIZE
 (10)

	)

12 
	#SMOOTH_WINDOW_MAX_SIZE
 (60)

	)

13 
	#RC_WINDOWS_VALUE
 (20)

	)

15 
	#RC_MIN_BIT_BUDGET_CONST
 (45)

	)

16 
	#RC_RHO_BITRATE_A
 (1597)

	)

17 
	#MAX_PERCENT_QP_CHANGE_DOWN
 (5)

	)

18 
	#MAX_PERCENT_QP_CHANGE_UP
 (10)

	)

19 
	#QUANT_SCALE_MIN
 (16)

	)

20 
	#QUANT_SCALE_MAX
 (51)

	)

21 
	#QUANT_SCALE_MAX_ADD1
 (
QUANT_SCALE_MAX
+1)

	)

22 
	#HIGH_TEXT_PERCENT
 (256)

	)

23 
	#QP_LOOKUP_TABLE_STEP
 (52)

	)

26 
	scbr_rc_¡ruù


28 
b_æag_upd©e
;

29 
b™s_u£d_äame
;

30 
nÜm_äame_b™_budg‘
;

31 
b™s_fÜ_nÚ‹xt_e¡
;

32 
mš_äame_b™_budg‘
;

33 
max_äame_b™_budg‘
;

34 
´ev_nÜm_äame_b™s_u£d
;

35 
b™s_³r_äame
;

36 
tÙ®_b™_d–
;

37 
rho
;

38 
A
;

40 
nz_couÁ
;

41 
rc_wšdow
;

42 
š™_rc_wšdow
;

43 
´ev_qp
;

44 
´ev_two_qp
;

45 
´ev_b™_budg‘
;

47 
¿tio
 ;

48 
tÙ®_¿tio
;

49 
fœ¡_äame_qp
;

50 
fœ¡_10_max_qp
;

51 
fœ¡_10_mš_qp
;

52 
rho_qp_bË
[
QP_LOOKUP_TABLE_STEP
];

56 
	s¿‹_cÚŒŞ_driv”_İ


58 (*
š™_rc
)(
tw_h264_logic_’code_chª_t
 *);

59 (*
£t_qp
)(
tw_h264_logic_’code_chª_t
 *, 
tw_video_äame_tcb_t
 *);

60 (*
upd©e_rc
)(
tw_h264_logic_’code_chª_t
 *);

61 (*
jump_rc
)(
tw_h264_logic_’code_chª_t
 *);

64 
	scbr_driv”


66 
tw_cbr_rc_·¿m_t
 
rc_·¿m
;

67 
tw_rc_driv”_İ
 *
rc_İ
;

70 
	svbr_rc_¡ruù


72 
b_æag_upd©e
;

73 
b™s_u£d_äame
;

74 
nÜm_äame_b™_budg‘
;

75 
b™s_fÜ_nÚ‹xt_e¡
;

76 
mš_äame_b™_budg‘
;

77 
max_äame_b™_budg‘
;

78 
´ev_nÜm_äame_b™s_u£d
;

79 
b™s_³r_äame
;

80 
tÙ®_b™_d–
;

81 
rho
;

82 
A
;

84 
nz_couÁ
;

85 
rc_wšdow
;

86 
š™_rc_wšdow
;

87 
´ev_qp
;

88 
´ev_two_qp
;

89 
´ev_b™_budg‘
;

90 
b™s_pF¿me
;

92 
¿tio
 ;

93 
tÙ®_¿tio
;

94 
fœ¡_äame_qp
;

95 
fœ¡_10_max_qp
;

96 
fœ¡_10_mš_qp
;

97 
rho_qp_bË
[
QP_LOOKUP_TABLE_STEP
];

99 
Ëak_bufãr
;

100 
bufãr_th»shŞd
;

101 
rg‘_š™_qp
;

102 
´e_sknum
;

105 
	svbr_driv”


107 
tw_vbr_rc_¡ruù_t
 
rc_·¿m
;

108 
tw_rc_driv”_İ
 *
rc_İ
;

111 
	src_tİ_driv”


113 
is_rc_image_Ëv–_´iÜ™y
;

114 
is_rc_image_smoÙhly_´iÜ™y
;

115 
disÿrd_äame_numb”_by_Ëv–
;

116 
tw_rc_driv”_İ
 *
rc_İ
;

117 
tw_cbr_driv”_t
 
cbr
;

118 
tw_vbr_driv”_t
 
vbr
;

121 
š™_rc_driv”
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

123 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/golomb.h

1 #iâdeà
GOLOMB_H


2 
	#GOLOMB_H


	)

4 #ifdeà
__ılu¥lus


9 cÚ¡ 
__u8
 
ff_log2_b
[256];

10 cÚ¡ 
__u8
 
ff_gŞomb_vlc_Ën
[512];

11 cÚ¡ 
__u8
 
ff_ue_gŞomb_vlc_code
[512];

12 cÚ¡ 
__s8
 
ff_£_gŞomb_vlc_code
[512];

14 
šlše
 
av_log2
(
v
)

16 
	gn
;

18 
	gn
 = 0;

19 if(
	gv
 & 0xffff0000)

21 
	gv
 >>= 16;

22 
	gn
 += 16;

24 if(
	gv
 & 0xff00)

26 
	gv
 >>= 8;

27 
	gn
 += 8;

29 
	gn
 +ğ
ff_log2_b
[
v
];

30  
	gn
;

33 
šlše
 
g‘_ue_gŞomb
(
G‘B™CÚ‹xt
 *
gb
)

35 
	gbuf
;

36 
	glog
;

38 
OPEN_READER
(
»
, 
gb
);

39 
UPDATE_CACHE
(
»
, 
gb
);

40 
	gbuf
=
GET_CACHE
(
»
, 
gb
);

41 if(
	gbuf
 >= (1<<27))

43 
buf
 >>= 32 - 9;

44 
LAST_SKIP_BITS
(
»
, 
gb
, 
ff_gŞomb_vlc_Ën
[
buf
]);

45 
CLOSE_READER
(
»
, 
gb
);

47  
	gff_ue_gŞomb_vlc_code
[
buf
];

51 
	glog
ğ2*
av_log2
(
buf
) - 31;

52 
	gbuf
>>ğ
log
;

53 
	gbuf
--;

54 
LAST_SKIP_BITS
(
»
, 
gb
, 32 - 
log
);

55 
CLOSE_READER
(
»
, 
gb
);

57  
	gbuf
;

64 
šlše
 
g‘_£_gŞomb
(
G‘B™CÚ‹xt
 *
gb
)

66 
	gbuf
;

67 
	glog
;

69 
OPEN_READER
(
»
, 
gb
);

70 
UPDATE_CACHE
(
»
, 
gb
);

71 
	gbuf
=
GET_CACHE
(
»
, 
gb
);

72 if(
	gbuf
 >= (1<<27))

74 
buf
 >>= 32 - 9;

75 
LAST_SKIP_BITS
(
»
, 
gb
, 
ff_gŞomb_vlc_Ën
[
buf
]);

76 
CLOSE_READER
(
»
, 
gb
);

78  
	gff_£_gŞomb_vlc_code
[
buf
];

82 
	glog
ğ2*
av_log2
(
buf
) - 31;

83 
	gbuf
>>ğ
log
;

85 
LAST_SKIP_BITS
(
»
, 
gb
, 32 - 
log
);

86 
CLOSE_READER
(
»
, 
gb
);

88 if(
	gbuf
&1)

89 
	gbuf
 = -(
buf
>>1);

91 
	gbuf
 = (
buf
>>1);

93  
	gbuf
;

97 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/proc_entry.h

1 #iâdeà
__PROC_ENTRY_H__


2 
	#__PROC_ENTRY_H__


	)

4 #ifdeà
__ılu¥lus


8 #ifdeà
MESSAGE_LOG


9 
	smes§ge_´iv‹
{

10 
wa™_queue_h—d_t
 
wa™
;

11 
¥šlock_t
 
lock
;

13 *
buf
;

14 
u32
 
buf_Ën
;

15 
u32
 
¡¬t
;

16 
u32
 
’d
;

20 
	gÇme
[64];

21 
´oc_dœ_’Œy
 *
	g’Œy
;

22 
»ad_´oc_t
 *
	g»ad
;

23 
wr™e_´oc_t
 *
	gwr™e
;

24 *
	g´iv©e
;

25 }
	ttw_´oc_»gi¡”_s
;

27 #ifdeà
MESSAGE_LOG


28 
mes§ge_´iv‹
 *
mes§ge_log
;

31 
tw_moduË_»gi¡”
(
dvm_ch_t
 *
ch
, 
tw_´oc_»gi¡”_s
 *
»g
);

32 
tw_moduË_uÄegi¡”
(
dvm_ch_t
 *
ch
, 
tw_´oc_»gi¡”_s
 *
»g
);

33 
´oc_moduË_š™
();

34 
´oc_moduË_»Ëa£
();

36 
©oi
(*
¡r
);

37 
fe
 *
tw_k”Ãl_fe_İ’
(*);

38 
tw_k”Ãl_fe_şo£
(
fe
 *);

40 #ifdeà
ARM_PLATFORM


41 
¬gv_ä“
(**
¬gv
);

42 **
¬gv_¥l™
(
gå_t
 
gå
, cÚ¡ *
¡r
, *
¬gı
);

45 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc.h

1 #iâdeà 
__TW_SERVICE_DEV_H__


2 
	#__TW_SERVICE_DEV_H__


	)

4 
	~<lšux/deviû.h
>

5 
	~<asm/sy¡em.h
>

6 
	~<asm/ty³s.h
>

7 
	~<lšux/kobjeù.h
>

8 
	~<lšux/kdev_t.h
>

10 
	#DMDEBUG


	)

11 
	#STATIC_COUNTING


	)

14 #ifdeà
DMDEBUG


15 
	#dbg
 
´štk


	)

16 
	#tc_Œaû
 
	`dbg
("š funùiÚ:%s------------------------------------>\n",
__FUNCTION__
)

	)

18 
	#dbg
(
fÜm©
, 
¬g
...èdo{ }0)

	)

22 
	#U32LONG_MAX
 0xFFFFFFFFUL

	)

25 
	#PATH_LEN
 256

	)

27 
	#TWELL
 0x00000001UL

	)

29 
	#TW2851
 0x00000001UL

	)

30 
	#TW5864
 0x00000002UL

	)

34 
	#BUS_PCI
 0x00000001UL

	)

38 
	#FUNC_TYPE_OFFSET
 20

	)

39 
	#FUNC_STREAM_OFFSET
 10

	)

40 
	#FUNC_ALGORTM_OFFSET
 0

	)

41 
	#MAKE_FUNC_ID
(
t
,
s
,
a
è((Ñè<< 
FUNC_TYPE_OFFSET
è| ((sè<< 
FUNC_STREAM_OFFSET
è| (×è<< 
FUNC_ALGORTM_OFFSET
))

	)

45 
	#STREAM_OFFSET
 26

	)

46 
	#ALGO_OFFSET
 20

	)

47 
	#BUS_OFFSET
 17

	)

48 
	#CHIP_OFFSET
 11

	)

49 
	#PHYCHAN_OFFSET
 5

	)

50 
	#LOGIC_OFFSET
 0

	)

53 
	#MAX_CHIPS_NR
 (1 << 
CHIP_OFFSET
)

	)

54 
	#MAX_PHYCHAN_PER_CHIP
 (1 << 8)

	)

55 
	#MAX_LOGCHAN_PER_PHYCHAN
 (1 << 8)

	)

56 
	#MAX_LOGCHAN_PER_PHYCHAN
 (1 << 8)

	)

60 
	#MAX_NAME_LEN
 256

	)

61 
	#TW_CHIP_MAJOR
 242

	)

62 
	#TW_SERVICE_BASE_MAJOR
 243

	)

63 
	#MAX_SERVICE_NR
 7

	)

64 
	#MAX_MINOR_NR
 255

	)

65 
	#CHIPDEV_ALIGN
 32

	)

66 
	#CHIPDEV_ALIGN_MASK
 (
CHIPDEV_ALIGN
 -1)

	)

69 
	#CHIPDEV_REGISTER
 0x0001

	)

70 
	#CHIPDEV_UNREGISTER
 0x0002

	)

71 
	#CHIPDEV_UP
 0x0003

	)

72 
	#CHIPDEV_GOING_DOWN
 0x0004

	)

73 
	#CHIPDEV_REST
 0x0005

	)

74 
	#CHIPDEV_DOWN
 0x0006

	)

78 
	#TC_HEADER_BUFFER_POOL_LEN
 0x20000

79 

	)

82 
	#tc_mš
(
x
,
y
è(((xè< (y))? (x): (y))

	)

83 
	#tc_max
(
x
,
y
è(((xè> (y))? (x): (y))

	)

86 
tc_hb_poŞ
 *
thb_poŞ
;

87 *
®gÜ™hm
[];

88 *
¡»am
[];

89 
nfm
[
MAX_SERVICE_NR
];

94 
	gtc_h—d”_buf
;

95 
	gtc_hb_poŞ
;

101 
	mCODEC_VIDEO_H264
 = 0,

102 
	mCODEC_VIDEO_MJPG
,

105 
	mCODEC_AUDIO_ALAW
,

106 
	mCODEC_AUDIO_ULAW
,

107 
	mCODEC_AUDIO_ABADPCM
,

108 
	mCODEC_AUDIO_MPMLQ
,

109 
	mCODEC_AUDIO_ADPCM
,

110 
	mCODEC_AUDIO_EMBED_ADPCM
,

111 
	mCODEC_AUDIO_LDCELP
,

112 
	mCODEC_AUDIO_CSACELP
,

113 }
	tCODEC_TYPE
;

118 
	mSTREAM_TYPE_MAJOR
 = 0,

119 
	mSTREAM_TYPE_MINOR
,

120 
	mSTREAM_TYPE_PIC
,

121 
	mSTREAM_TYPE_MV
,

122 
	mSTREAM_TYPE_AUDIO
,

123 
	mSTREAM_TYPE_NOTHING
 = 0xFFFF,

124 }
	tSTREAM_TYPE
;

126 
	etw_£rviû_ty³


128 
	mTW_CHIP
 = 0,

129 
	mTW_ENCODER
,

130 
	mTW_DECODER
,

131 
	mTW_VIDEO_IN
,

132 
	mTW_VIDEO_OUT
,

133 
	mTW_AUDIO_IN
,

134 
	mTW_AUDIO_OUT
,

135 
	mTW_SERVICE_TYPE_NOTHING
 = 0XFFFF,

136 }
	tTW_SERVICE_TYPE
;

138 
	etw_dev_¡©e


140 
	mTW_DEV_NEEDINIT
 = 0,

141 
	mTW_DEV_CLOSED
,

142 
	mTW_DEV_IDLE
,

143 
	mTW_DEV_SUSPEND
,

144 
	mTW_DEV_BUSY
,

145 
	mTW_DEV_BROKEN
,

146 }
	tTW_DEV_STATE
;

149 
	smsg_t


151 
li¡_h—d
 
	mli¡
;

152 
	mty³
;

153 
	msize
;

154 *
	md©a
;

158 
	smsg_queue


160 
time_t
 
	m¹ime
;

161 
	mmsg_Ä
;

162 
li¡_h—d
 
	mqh—d
;

168 
	sdeviû_šfo


170 
	mmajÜ
;

171 
	mmšÜ
;

172 
	m·th
[256];

176 
	scmd_¬g


178 
TW_SERVICE_TYPE
 
	mty³
;

179 
	mchªÃl_idx
;

180 
CODEC_TYPE
 
	m®gÜ™hm
;

181 
STREAM_TYPE
 
	m¡»am
;

182 
	mdev_šfo
[0];

186 
	scmd_li¡


188 
li¡_h—d
 
	mnode
;

189 
tw_ch_deviû
 *
	mtcd
;

190 
cmd_¬g
 
	m¬g
;

193 
	s’d_pošt_obj


195 #ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

196 
u32
 
	m¡»am
:6;

197 
u32
 
	m®go
:6;

198 
u32
 
	mbus_id
:3;

199 
u32
 
	mch_id
:6;

200 
u32
 
	mphy_chª_id
:6;

201 
u32
 
	mlgc_chª_id
:5;

202 #–ià
defšed
 (
__LITTLE_ENDIAN_BITFIELD
)

203 
u32
 
	mlgc_chª_id
:5;

204 
u32
 
	mphy_chª_id
:6;

205 
u32
 
	mch_id
:6;

206 
u32
 
	mbus_id
:3;

207 
u32
 
	m®go
:6;

208 
u32
 
	m¡»am
:6;

213 
	#KEY_MAX_LGC_ID
 0x20

	)

214 
	#KEY_MAX_PHY_ID
 0x40

	)

215 
	#KEY_MAX_CHIP_ID
 0x40

	)

216 
	#KEY_MAX_BUS_ID
 0x08

	)

217 
	#KEY_MAX_STREAM_ID
 0x40

	)

218 
	#KEY_MAX_ALGO_ID
 0x40

	)

220 
’d_pošt_obj
 
	t•key_t
;

227 
	s•obj_t


229 
	mv’dÜ_id
;

230 
	mbus_id
;

231 
	mch_id
;

232 
	mfunc_id
;

233 
	mty³
;

234 
•key_t
 
	mkey
;

243 
	stw_dev_id


245 
•obj_t
 
	m•obj
;

246 
	mv”siÚ
;

254 
	stw_dev_bË_id


256 
li¡_h—d
 
	mli¡
;

257 
tw_dev_id
 *
	mtid
;

258 *
	mİs
;

259 *
	m´iv
;

260 *
	m·¿
;

267 
	stw_ch_deviû


269 
li¡_h—d
 
	mli¡
;

270 
	mÇme
[
MAX_NAME_LEN
];

271 
	mmšÜ
;

272 
•obj_t
 
	m•obj
;

273 
deviû
 
	mdev
;

274 
cdev
 *
	mcdev
;

276 
tcd_fe_İ”©iÚs
 *
	mtcd_fİs
;

277 
li¡_h—d
 
	mtsd_li¡
[
MAX_SERVICE_NR
-1];

278 
kobjeù
 *
	mdœs
[
MAX_SERVICE_NR
-1];

279 
__u32
 
	m·dded
;

280 
tw_ch_driv”
 *
	mdriv”
;

281 
’dpošt_tcb
 *
	m³d
;

282 (*
	mş—n_up
)(*);

283 *
	m´iv
;

284 
	m´iv_Ën
;

285 
	mtÙ®_Ën
;

288 
	stw_ch_driv”


290 
li¡_h—d
 
	mli¡
;

291 
	mÇme
[
MAX_NAME_LEN
];

292 
deviû_driv”
 
	mdriv”
;

293 
tw_dev_bË_id
 
	mdeviû_id
;

295 (*
	m©ch_ch
)(*
	mdriv
,
tw_ch_deviû
 *
	mtcd
);

296 (*
	md‘ach_ch
)(*
	mdriv
,
tw_ch_deviû
 *
	mtcd
);

299 (*
	mshutdown
)(
tw_ch_deviû
 *
	mtcd
);

300 (*
	msu¥’d
)(
tw_ch_deviû
 *
	mtcd
, 
	m¥msg
);

301 (*
	m»sume
)(
tw_ch_deviû
 *
	mtcd
);

304 (*
	mcommªd
)(
tw_ch_deviû
 *
	m±cd
,
	mcmd
, *
	mcmd_¬g
);

305 
li¡_h—d
 
	mtcd_li¡
;

312 #ifdeà
STATIC_COUNTING


313 
	stc_buf_š‹rv®


316 
u32
 
	mmš
;

317 
u32
 
	mmax
;

318 
u32
 
	mu_time
;

319 
u32
 
	mcu¼_tick
;

320 
u32
 
	ms_»q_tick
;

321 
u32
 
	ms_m­_tick
;

322 
u32
 
	ms_»l_tick
;

324 
u32
 
	mic_»q_time
;

325 
u32
 
	mic_m­_time
;

326 
u32
 
	mic_»l_time
;

327 
u32
 
	mic4_tÙ®_time
;

333 
	stw_£rviû_deviû


335 
li¡_h—d
 
	mli¡
;

336 
	mÇme
[
MAX_NAME_LEN
];

337 
	mty³
;

338 
•obj_t
 
	m•obj
;

339 
	mmšÜ
;

341 
deviû
 
	mdev
;

342 
__u32
 
	m·dded
;

343 
cdev
 *
	mcdev
;

344 
tw_ch_deviû
 *
	m±cd
;

345 
tsd_fe_İ”©iÚs
 *
	mtsd_fİs
;

346 
’dpošt_tcb
 *
	m³d
;

347 
tc_queue
 *
	mqueue
;

348 (*
	mş—n_up
)(*);

349 *
	m´iv©e_d©a
;

350 *
	m´iv
;

351 #ifdeà 
STATIC_COUNTING


352 
tc_buf_š‹rv®
 
	mb_™v®
;

373 
	stw_£rviû_driv”


375 
li¡_h—d
 
	mli¡
;

376 
	mÇme
[
MAX_NAME_LEN
];

377 
deviû_driv”
 
	mdriv”
;

378 
tw_dev_bË_id
 
	mdeviû_id
;

380 (*
	m©ch_£rviû
)(*
	mdrv
, 
tw_£rviû_deviû
 * 
	mtsd
);

381 (*
	md‘ach_£rviû
)(*
	mdrv
, 
tw_£rviû_deviû
 * 
	mtsd
);

382 (*
	mshutdown
)(
tw_£rviû_deviû
 *
	mtsd
);

383 (*
	msu¥’d
)(
tw_£rviû_deviû
 *
	mtsd
, 
	m¥msg
);

384 (*
	m»sume
)(
tw_£rviû_deviû
 *
	mtsd
);

385 (*
	mcommªd
)(
tw_£rviû_deviû
 *
	mtsd
,
	mcmd
, *
	mcmd_¬g
);

386 
li¡_h—d
 
	mtsd_li¡
;

390 
	stcd_fe_İ”©iÚs


392 
moduË
 *
	mowÃr
;

393 (*
	mİ’
)(
	mtw_ch_deviû
 *,
	mfe
 *);

394 
ssize_t
 (*
»ad
)(
	mfe
 *,
	m__u£r
 *,
	msize_t
, 
	mloff_t
 *);

395 
ssize_t
 (*
wr™e
è(
	mfe
 *, cÚ¡ 
	m__u£r
 *, 
	msize_t
, 
	mloff_t
 *);

396 (*
	mioùl
è(
	mfe
 *, , );

397 (*
	m»Ëa£
)(
	mtw_ch_deviû
 *,
	mfe
 *);

401 
	stsd_fe_İ”©iÚs


403 
moduË
 *
	mowÃr
;

404 (*
	mš™
)(
	mtw_ch_deviû
 *,
	mcmd_¬g
 *,
	mtw_£rviû_deviû
 **);

405 (*
	mde¡Üy
)(
	mtw_£rviû_deviû
 *);

407 (*
	mİ’
)(
	mtw_£rviû_deviû
 *,
	mfe
 *);

408 
ssize_t
 (*
»ad
)(
	mfe
 *,
	m__u£r
 *,
	msize_t
, 
	mloff_t
 *);

409 
ssize_t
 (*
wr™e
è(
	mfe
 *, cÚ¡ 
	m__u£r
 *, 
	msize_t
, 
	mloff_t
 *);

410 (*
	mioùl
è(
	mfe
 *, , );

411 (*
	m»Ëa£
)(
	mfe
 *);

412 (*
	mpŞl
)(
fe
 *
	mfe
, 
pŞl_bË_¡ruù
 *
	mwa™
);

415 
	stsd_driv”_İ”©iÚs


417 (*
	mš™
)(
	mtw_ch_deviû
 *,
	mtw_£rviû_deviû
 *,*,
	mcmd_¬g
 *);

418 (*
	m»move
)(
	mtw_ch_deviû
 *,
	mtw_£rviû_deviû
 *,*,
	mcmd_¬g
 *);

421 
	stcd_driv”_İ”©iÚs


423 (*
	mš™
)(
	mtw_ch_deviû
 *,*);

424 (*
	m»move
)(
	mtw_ch_deviû
 *,*);

430 
	#TC_HEADER_BUFFER_LEN
 
PAGE_SIZE


	)

432 
	stc_hb_İ”©iÚ


434 (*
	mš™
)(
	mtc_hb_poŞ
 *,
	mtc_h—d”_buf
 *, );

435 (*
	m»Ëa£
)(
	mtc_hb_poŞ
 *, 
	mtc_h—d”_buf
 *);

440 
	stc_h—d”_buf


442 
¥šlock_t
 
	mlock
;

443 
	mid
;

444 
©omic_t
 
	m»f
;

445 
tcb_node_t
 
	mnode
;

446 
	mun™_size
;

447 *
	md©a
;

448 
tc_hb_poŞ
 *
	mpoŞ
;

449 
tc_hb_İ”©iÚ
 *
	mİ
;

452 
	#g‘_thb_äom_node
(
x
è
	`cÚš”_of
(x,
tc_h—d”_buf
,
node
)

	)

454 
	stc_hb_poŞ_İ”©iÚ


456 (*
	mü—‹
)(
	msize
);

457 (*
	mde¡Üy
)(
	mtc_hb_poŞ
 *);

459 (*
	mg‘_h—d”_buf
)(
	mtc_hb_poŞ
 *, 
	mtc_h—d”_buf
 **);

460 (*
	mŒy_g‘_h—d”_buf
)(
	mtc_hb_poŞ
 *, 
	mtc_h—d”_buf
 **);

461 (*
	mput_h—d”_buf
)(
	mtc_hb_poŞ
 *, 
	mtc_h—d”_buf
 *);

462 (*
	mg‘_hb_poŞ_’Œy_numb”
)(
	mtc_hb_poŞ
 *);

465 
	stc_hb_poŞ


467 
	mÜd”
;

468 *
	mp
;

469 
	mÄ
;

470 
tcb_node_poŞ_t
 
	mÅ
;

471 
tc_h—d”_buf
 *
	mbufs
;

472 
tc_hb_poŞ_İ”©iÚ
 *
	mİ
;

478 
	#•key_equ®
(
a
,
b
è(×)->
¡»am
 =ğ(b)->¡»am && (a)->
®go
 =ğ(b)->®gØ&& (a)->
bus_id
 == (b)->bus_id \

479 && (
a
)->
ch_id
 =ğ(
b
)->ch_id && (a)->
phy_chª_id
 =ğ(b)->phy_chª_id && (a)->
lgc_chª_id
 =ğ(b)->lgc_chª_id)

	)

481 
	#•key_equ®_w™hout_phyid
(
a
,
b
è(×)->
¡»am
 =ğ(b)->¡»am && (a)->
®go
 =ğ(b)->®gØ&& (a)->
bus_id
 == (b)->bus_id \

482 && (
a
)->
ch_id
 =ğ(
b
)->ch_id &&×)->
lgc_chª_id
 =ğ(b)->lgc_chª_id)

	)

485 
	#•obj_euq®
(
a
,
b
è(×)->
v’dÜ_id
 =ğ(b)->v’dÜ_id && (a)->
bus_id
 == (b)->bus_id \

486 && (
a
)->
ch_id
 =ğ(
b
)->ch_id && (a)->
func_id
 == (b)->func_id \

487 && (
a
)->
ty³
 =ğ(
b
)->ty³ )

	)

489 
	#cmd_equ®
(
a
,
b
è(!
	`memcmp
((*)×),(*)(b), (
cmd_¬g
)))

	)

491 
	#•obj_£t
(
d
,
s
è(
	`memıy
((*)(d),(*)(s),(
•obj_t
)))

	)

493 
	#g‘_bus_id
(
key
è(key.
bus_id
)

	)

494 
	#g‘_ch_id
(
key
è(key.
ch_id
)

	)

495 
	#g‘_phy_id
(
key
è(key.
phy_chª_id
)

	)

496 
	#g‘_log_id
(
key
è(key.
lgc_chª_id
)

	)

497 
	#dbg_•obj_´št
(
•
è
	`dbg
("vendor_id=%lu,bus_id=%lu,chip_id=%lu,func_id=%d,type=%lu,key=0x08%x stream=%d,algo=%d,bid=%d,cid=%d,p=%d,l=%d \n", \

498 (
•
)->
v’dÜ_id
,Óp)->
bus_id
,Óp)->
ch_id
,Óp)->
func_id
,Óp)->
ty³
,*((
u32
 *)&Óp)->
key
),Óp)->key.
¡»am
,Óp)->key.
®go
,(ep)->key.bus_id,\

499 (
•
)->
key
.
ch_id
,Óp)->key.
phy_chª_id
,Óp)->key.
lgc_chª_id
)

	)

502 
šlše
 
	$make_key
(
•key_t
 *
key
,
¡»am
,
®go
,
bid
,
cid
,
pid
,
lid
)

505 if(
¡»am
 >ğ
KEY_MAX_STREAM_ID
){

506 
	`dbg
("errype stream…assed!\n");

509 if(
®go
 >ğ
KEY_MAX_ALGO_ID
){

510 
	`dbg
("err‡lgoype…assed!\n");

513 
key
->
¡»am
 = stream;

514 
key
->
®go
 =‡lgo;

515 
key
->
bus_id
 = 
bid
;

516 
key
->
ch_id
 = 
cid
;

517 
key
->
phy_chª_id
 = 
pid
;

518 
key
->
lgc_chª_id
 = 
lid
;

520 
	}
}

522 
šlše
 
	$g‘_func_id_äom_•obj
(
•obj_t
 *
•
)

524  
•
->
func_id
;

525 
	}
}

527 
šlše
 
	$•obj_š™
(
•obj_t
 *
•
, 
vid
, 
bid
,
cid
, 
fid
,
ty³
, 
•key_t
 *
key
)

529 
	`mem£t
((*)
•
, 0, (
•obj_t
));

530 
•
->
v’dÜ_id
 = 
vid
;

531 
•
->
bus_id
 = 
bid
;

532 
•
->
ch_id
 = 
cid
;

533 
•
->
func_id
 = 
fid
;

534 
•
->
ty³
 =ype;

535 
	`memıy
((*)&
•
->
key
,(*)key,(
•key_t
));

537 
	}
}

539 
šlše
 
	$•obj_key_upd©e_phy_id
(
•key_t
 *
ekey
, 
phy_id
)

541 if(
phy_id
 >ğ
KEY_MAX_PHY_ID
)

543 
ekey
->
phy_chª_id
 = 
phy_id
;

544 
	}
}

547 
šlše
 
	$•obj_key_upd©e_lgc_id
(
•key_t
 *
ekey
, 
lgc_id
)

549 if(
lgc_id
 >ğ
KEY_MAX_LGC_ID
)

551 
ekey
->
lgc_chª_id
 = 
lgc_id
;

552 
	}
}

555 
šlše
 
	$round_up
(
tÙ®
,
un™_size
)

557  (
tÙ®
 % 
un™_size
)? (total / unit_size) + 1:otal / unit_size;

558 
	}
}

560 
šlše
 
	$round_low
(
tÙ®
,
un™_size
)

562  (
tÙ®
/
un™_size
);

563 
	}
}

565 
šlše
 
	$g‘_¡»am_äom_•obj
(
•obj_t
 * 
•t
)

567  (
•t
->
key
.
¡»am
);

568 
	}
}

570 
šlše
 
	$g‘_®go_äom_•obj
(
•obj_t
 * 
•t
)

572  (
•t
->
key
.
®go
);

573 
	}
}

575 
šlše
 
	$g‘_busid_äom_•obj
(
•obj_t
 * 
•t
)

577  (
•t
->
key
.
bus_id
);

578 
	}
}

580 
šlše
 
	$g‘_chid_äom_•obj
(
•obj_t
 * 
•t
)

582  (
•t
->
key
.
ch_id
);

583 
	}
}

585 
šlše
 
	$g‘_phchª_id_äom_•obj
(
•obj_t
 * 
•t
)

587  (
•t
->
key
.
phy_chª_id
);

588 
	}
}

590 
šlše
 
	$g‘_lgcchª_id_äom_•obj
(
•obj_t
 * 
•t
)

592  (
•t
->
key
.
lgc_chª_id
);

593 
	}
}

595 
šlše
 *
	$tcd_´iv
(
tw_ch_deviû
 *
tcd
)

597  (*)
tcd
 + (((
tw_ch_deviû
è+ 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK);

598 
	}
}

600 
šlše
 
tw_ch_deviû
 *
	$´iv_2_tcd
(*
´iv
)

602 *
p
 =(*)(
´iv
è-(((
tw_ch_deviû
è+ 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK);

604  (
tw_ch_deviû
 *)
p
;

605 
	}
}

607 
šlše
 *
	$tsd_´iv
(
tw_£rviû_deviû
 *
tsd
)

609  (*)
tsd
 + (((
tw_£rviû_deviû
è+ 
CHIPDEV_ALIGN_MASK
) & ~CHIPDEV_ALIGN_MASK);

610 
	}
}

625 
šlše
 
tw_£rviû_deviû
* 
	$g‘_£rviû_dev_by_ùvl
(
tw_ch_deviû
 *
tcd
, 
ty³
, 
av_ty³
, 
chªÃl
)

627 
tw_£rviû_deviû
 * 
tsd
 = 
NULL
;

628 
li¡_h—d
 *
p
,*
h
;

630 if(
ty³
 < 1)

631  
NULL
;

633 
h
 = &
tcd
->
tsd_li¡
[
ty³
-1];

634 
	`dbg
("ty³ = %d\n",
ty³
);

635 
	`li¡_fÜ_—ch
(
p
,
h
){

636 
tsd
 = 
	`cÚš”_of
(
p
,
tw_£rviû_deviû
, 
li¡
);

637 if(
	`g‘_lgcchª_id_äom_•obj
(&
tsd
->
•obj
è=ğ
chªÃl
){

638 if(0 =ğ
av_ty³
){

639 if(
CODEC_VIDEO_H264
 =ğ
	`g‘_®go_äom_•obj
(&
tsd
->
•obj
))

640  
tsd
;

642 if(1 =ğ
av_ty³
){

643 if(
STREAM_TYPE_AUDIO
 =ğ
	`g‘_¡»am_äom_•obj
(&
tsd
->
•obj
))

644  
tsd
;

648  
NULL
;

649 
	}
}

652 
šlše
 
	$tc_®ign_up
(
size
, 
®ign
)

654 
»t
;

656 
»t
 = (
size
 + (
®ign
-1)) & (~(align-1));

657  
»t
;

659 
	}
}

661 #ifdeà
STATIC_COUNTING


662 
šlše
 
	$g‘_loİ_¡¬t
(
tw_£rviû_deviû
 *
tsd
)

664 
tc_buf_š‹rv®
 *
tbi
;

666 
tbi
 = (
tc_buf_š‹rv®
 *)&
tsd
->
b_™v®
;

667 
tbi
->
s_»q_tick
 = 
	`g‘_tw_sy¡em_tick
();

668 
	}
}

671 
šlše
 
	$ÿlc_ic_»q_time
(
tw_£rviû_deviû
 *
tsd
)

673 
tc_buf_š‹rv®
 *
tbi
 = (tc_buf_š‹rv® *)&
tsd
->
b_™v®
;

674 
u32
 
tick
;

676 
tick
 = 
	`g‘_tw_sy¡em_tick
();

677 if(
tick
 >ğ
tbi
->
s_»q_tick
)

678 
tbi
->
ic_»q_time
 = 
tick
 -bi->
s_»q_tick
;

680 
tbi
->
ic_»q_time
 = 
U32LONG_MAX
 - (tbi->
s_»q_tick
 - 
tick
);

681 
	}
}

683 
šlše
 
	$g‘_ic_m­_¡¬t
(
tw_£rviû_deviû
 *
tsd
)

685 
tc_buf_š‹rv®
 *
tbi
 = (tc_buf_š‹rv® *)&
tsd
->
b_™v®
;

687 
tbi
->
s_m­_tick
 = 
	`g‘_tw_sy¡em_tick
();

688 
	}
}

690 
šlše
 
	$ÿlc_ic_m­_time
(
tw_£rviû_deviû
 *
tsd
)

692 
tc_buf_š‹rv®
 *
tbi
 = (tc_buf_š‹rv® *)&
tsd
->
b_™v®
;

693 
u32
 
tick
;

695 
tick
 = 
	`g‘_tw_sy¡em_tick
();

696 if(
tick
 >ğ
tbi
->
s_m­_tick
)

697 
tbi
->
ic_m­_time
 = 
tick
 -bi->
s_m­_tick
;

699 
tbi
->
ic_m­_time
 = 
U32LONG_MAX
 - (tbi->
s_m­_tick
 - 
tick
);

700 
	}
}

702 
šlše
 
	$g‘_ic_»l_¡¬t
(
tw_£rviû_deviû
 *
tsd
)

704 
tc_buf_š‹rv®
 *
tbi
 = (tc_buf_š‹rv® *)&
tsd
->
b_™v®
;

706 
tbi
->
s_»l_tick
 = 
	`g‘_tw_sy¡em_tick
();

707 
	}
}

709 
šlše
 
	$ÿlc_ic_»l_time
(
tw_£rviû_deviû
 *
tsd
)

711 
tc_buf_š‹rv®
 *
tbi
 = (tc_buf_š‹rv® *)&
tsd
->
b_™v®
;

712 
u32
 
tick
;

714 
tick
 = 
	`g‘_tw_sy¡em_tick
();

715 if(
tick
 >ğ
tbi
->
s_»l_tick
)

716 
tbi
->
ic_»l_time
 = 
tick
 -bi->
s_»l_tick
;

718 
tbi
->
ic_»l_time
 = 
U32LONG_MAX
 - (tbi->
s_»l_tick
 - 
tick
);

719 
	}
}

723 
šlše
 
	$g‘_loİ_’d
(
tw_£rviû_deviû
 *
tsd
)

725 
tc_buf_š‹rv®
 *
tbi
;

726 
tick
,
¥ª
;

728 
tbi
 = (
tc_buf_š‹rv®
 *)&
tsd
->
b_™v®
;

729 
tick
 = 
	`g‘_tw_sy¡em_tick
();

730 if(
tick
 >ğ
tbi
->
s_»q_tick
)

731 
¥ª
 = 
tick
 - 
tbi
->
s_»q_tick
;

733 
¥ª
 = 
U32LONG_MAX
 - (
tbi
->
s_»q_tick
 - 
tick
);

735 
tbi
->
ic4_tÙ®_time
 = 
¥ª
;

736 if(
¥ª
 < 
tbi
->
mš
)bi->min = span;

737 if(
¥ª
 > 
tbi
->
max
)bi->max = span;

738 
	}
}

742 
lock_chdev
();

743 
uÆock_chdev
();

744 
li¡_h—d
 * 
g‘_chdev_li¡h—d
();

745 
do_ü—‹_£rviû_dev
(
tw_ch_deviû
 * 
tcd
, 
cmd_¬g
 * 
¬g
, 
kobjeù
 * 
dœ
);

746 
do_add_to_k”Ãl
(
tw_ch_deviû
 * 
tcd
, *
¬g
);

747 
tw_ch_deviû
 * 
fšd_ch_dev
(
mšÜ
);

748 
tw_£rviû_deviû
 * 
fšd_£rviû_dev
(
majÜ
,
mšÜ
);

749 
»gi¡”_ch_deviû
(
tw_ch_deviû
 *
tcd
);

750 
uÄegi¡”_ch_deviû
(
tw_ch_deviû
 * 
tcd
);

751 
»gi¡”_ch_driv”
(
tw_ch_driv”
 * 
driv
);

752 
uÄegi¡”_ch_driv”
(
tw_ch_driv”
 * 
driv
);

753 
ü—‹_£rviû_deviû
(
tw_ch_deviû
 * 
tcd
, 
d©a
);

754 
»Ëa£_£rviû_deviû
(
tw_ch_deviû
 *
tcd
, *
d©a
);

755 
»gi¡”_tc_deviû
(
tw_dev_bË_id
 *
Ãw
);

756 
uÄegi¡”_tc_deviû
(
tw_dev_bË_id
 *
tb
);

757 
»gi¡”_tc_driv”
(
tw_£rviû_driv”
 * 
driv
);

758 
uÄegi¡”_tc_driv”
(
tw_£rviû_driv”
 *
driv
);

759 
»lšk_tsd
(
tw_£rviû_deviû
 *
Şd
, tw_£rviû_deviû *
Ãw”
);

760 
tw_ch_deviû
 * 
tc_chdev_®loc
(
´iv_size
);

761 
tc_chdev_ä“
(
tw_ch_deviû
 * 
tcd
);

762 
ch_deviû_m©ch
(
•obj_t
 *
a
, •obj_ˆ*
b
);

763 
do_»Ëa£_£rviû_deviû
(
tw_£rviû_deviû
 *
tsd
,*
d©a
);

764 
»Ëa£_®l_£rviû_deviû
();

765 
»Ëa£_®l_£rviû_deviû_ext
();

767 
tw_cÜe_š™
();

768 
tw_cÜe_ex™
();

	@../../tw5864/include/tw5864/tc_audio_decode.h

1 #iâdef 
TW_AUDIO_DE_H__


2 
	#TW_AUDIO_DE_H__


	)

4 #ifdeà
__ılu¥lus


15 
	#TW_AUDIO_8K
 (0)

	)

16 
	#TW_AUDIO_16K
 (1)

	)

18 
	#TW_AUDIO_16BIT
 (0)

	)

19 
	#TW_AUDIO_8BIT
 (1)

	)

21 
	#TW_AUDIO_PCM
 (0)

	)

22 
	#TW_AUDIO_ALAW
 (1)

	)

23 
	#TW_AUDIO_ULAW
 (2)

	)

24 
	#TW_AUDIO_ADPCM_32K
 (3)

	)

25 
	#TW_AUDIO_ADPCM_16K
 (4)

	)

26 
	#TW_AUDIO_ADPCM_48K
 (5)

	)

28 
	#AUDIO_ENABLE
 (0x0001)

	)

29 
	#AUDIO_DISABLE
 (0x0000)

	)

30 
	#AUDIO_MUTE_ENABLE
 (0x0001)

	)

31 
	#AUDIO_MUTE_DISABLE
 (0x0000)

	)

35 
	eaudio_¡©e


37 
NEED_INIT
 = 0,

38 
INITED
,

39 
OPENED
,

40 
CLOSED
,

41 }
	tAUDIO_STATE
;

44 
	saudio_’_İ”©iÚ


46 (*
š™
)(
tw_audio_’
 *
ai
);

50 
	stw_audio_cÚfig


52 
ty³
;

53 
§m¶e_¿‹
;

54 
b™_wide
;

57 
	stw_audio_·¿mts


59 
tw_audio_cÚfig
 
´İ”ty
;

60 
audio_’_İ”©iÚ
 *
İ
;

64 
	stw_audio_de


66 
tw_£rviû_deviû
 
tsd
;

67 *
Çme
;

68 
u£rs
;

69 
AUDIO_STATE
 
¡©e
;

70 
tw_audio_·¿mts
 
·¿
;

71 
tw_audio_driv”_t
 *
«_driv
;

72 
tc_queue
 *
queue
;

73 
£m­hÜe
 
£m
;

86 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc_audio_encode.h

1 #iâdef 
TW_AUDIO_EN_H__


2 
	#TW_AUDIO_EN_H__


	)

4 #ifdeà
__ılu¥lus


12 
	#TW_CONFIG_ADD_NAL


	)

15 #ifdeà
TW_CONFIG_ADD_NAL


16 
	#TW_TOTAL_AUDIO_FRAMEHEADER_LEN
 ((
tw_äame_h—d”_t
è+ (
tw_audio_äame_·d_t
è+ (
ext_h264_Çl_b™¡»am_t
))

	)

18 
	#TW_TOTAL_AUDIO_FRAMEHEADER_LEN
 ((
tw_äame_h—d”_t
è+ (
tw_audio_äame_·d_t
))

	)

23 
	#TW_PCM_AUDIO_LEN
 (498)

	)

24 
	#TW_ADPCM_AUDIO_LEN
 (384)

	)

26 
	#TW_AUDIO_8K
 (0)

	)

27 
	#TW_AUDIO_16K
 (1)

	)

29 
	#TW_AUDIO_16BIT
 (0)

	)

30 
	#TW_AUDIO_8BIT
 (1)

	)

32 
	#AUDIO_ENABLE
 (0x0001)

	)

33 
	#AUDIO_DISABLE
 (0x0000)

	)

34 
	#AUDIO_MUTE_ENABLE
 (0x0001)

	)

35 
	#AUDIO_MUTE_DISABLE
 (0x0000)

	)

47 
tw_audio_’
;

49 
	eaudio_¡©e
{

50 
NEED_INIT
 = 0,

51 
INITED
,

52 
OPENED
,

53 
CLOSED
,

54 }
	tAUDIO_STATE
;

57 
	saudio_’_İ”©iÚ


59 (*
š™
)(
tw_audio_’
 *
ai
);

62 
	stw_audio_cÚfig


64 
ty³
;

65 
§m¶e_¿‹
;

66 
b™_wide
;

69 
	stw_ch_audio_·¿m_my


71 
u32
 
chªge_mask_æag
;

72 
u8
 
i_b™_wide
;

73 
u8
 
i_§m¶e_¿‹
;

74 
e_audio_ty³
;

79 
	stw_audio_’


81 
tw_£rviû_deviû
 
tsd
;

82 
tw_dev_bË_id
 
tbid
;

83 *
Çme
;

84 
u£rs
;

85 
AUDIO_STATE
 
¡©e
;

86 
tw_ch_audio_·¿m_my
 
·¿
;

88 
£m­hÜe
 
£m
;

89 
wa™_queue_h—d_t
 
wa™_pŞl
;

90 
tim”_id
;

91 
disÿrd
;

95 
	stw_audio_de


97 
tw_£rviû_deviû
 
tsd
;

98 
tw_dev_bË_id
 
tbid
;

99 *
Çme
;

100 
u£rs
;

101 
AUDIO_STATE
 
¡©e
;

102 
tw_ch_audio_·¿m_my
 
·¿
;

104 
£m­hÜe
 
£m
;

105 
wa™_queue_h—d_t
 
wa™_pŞl
;

106 
tim”_id
;

109 
	stw_video_’


111 
tw_£rviû_deviû
 
tsd
;

112 
tw_dev_bË_id
 
tbid
;

113 *
Çme
;

114 
u£rs
;

115 
¡©e
;

118 
£m­hÜe
 
£m
;

119 
wa™_queue_h—d_t
 
wa™_pŞl
;

120 
tim”_id
;

121 
disÿrd
;

125 
	stw_j³g_’


127 
tw_£rviû_deviû
 
tsd
;

128 
tw_dev_bË_id
 
tbid
;

129 *
Çme
;

130 
u£rs
;

131 
¡©e
;

134 
£m­hÜe
 
£m
;

135 
wa™_queue_h—d_t
 
wa™_pŞl
;

136 
tim”_id
;

137 
disÿrd
;

141 
	stw_ch_ai


143 
tw_£rviû_deviû
 
tsd
;

144 
tw_dev_bË_id
 
tbid
;

145 *
Çme
;

146 
u£rs
;

147 
¡©e
;

150 
£m­hÜe
 
£m
;

151 
wa™_queue_h—d_t
 
wa™_pŞl
;

152 
tim”_id
;

155 
	stw_ch_vi


157 
tw_£rviû_deviû
 
tsd
;

158 
tw_dev_bË_id
 
tbid
;

159 *
Çme
;

160 
u£rs
;

161 
¡©e
;

164 
£m­hÜe
 
£m
;

165 
wa™_queue_h—d_t
 
wa™_pŞl
;

166 
tim”_id
;

169 
šlše
 
£t_tve_¡©e
(
tw_audio_’
 *
tve
, 
AUDIO_STATE
 
Ãw_¡©e
)

171 
tve
->
¡©e
 = 
Ãw_¡©e
;

175 
šlše
 
£t_e_¡©e
(
tw_audio_’
 *
e
, 
AUDIO_STATE
 
Ãw_¡©e
)

177 
e
->
¡©e
 = 
Ãw_¡©e
;

180 
šlše
 
£t_tde_¡©e
(
tw_audio_de
 *
tde
, 
AUDIO_STATE
 
Ãw_¡©e
)

182 
tde
->
¡©e
 = 
Ãw_¡©e
;

185 
šlše
 
tc_£t_audio_·¿m
(
tw_ch_audio_·¿m_my
 *
¤c
,tw_ch_audio_·¿m_my *
de¡
)

188 
¤c
->
i_b™_wide
 = 
de¡
->i_bit_wide;

189 
¤c
->
i_§m¶e_¿‹
 = 
de¡
->i_sample_rate;

190 
¤c
->
e_audio_ty³
 = 
de¡
->e_audio_type;

194 
šlše
 
g‘_·ylßd_Ën
(
tw_ch_audio_·¿m_my
 *
·¿
)

196 
»t
 = 
U32LONG_MAX
;

198 
·¿
->
e_audio_ty³
)

200 
TW_AUDIO_PCM
:

201 
»t
 = 
TW_PCM_AUDIO_LEN
;

203 
TW_AUDIO_ADPCM_32K
:

204 
TW_AUDIO_ADPCM_16K
:

205 
TW_AUDIO_ADPCM_48K
:

206 
»t
 = 
TW_ADPCM_AUDIO_LEN
;

208 
TW_AUDIO_ALAW
:

209 
TW_AUDIO_ULAW
:

211 
´štk
("not supported‚ow!\n");

214  
»t
;

251 
tw_ch_audio_·¿m_my
 
def_audio_·rm
;

252 
tc_ch_š™
(
tw_ch_deviû
 *
tcd
,
bus_id
,
ch_id
);

253 
tc_ch_ex™
(
tw_ch_deviû
 *
tcd
);

254 
tw_audio_’_š™
(* 
d©a
);

255 
tw_audio_’_»move
();

257 
tw_audio_de_š™
(* 
d©a
);

258 
tw_audio_de_»move
();

260 
tw_videoh264_’_š™
(* 
d©a
);

261 
tw_videoh264_’_»move
(*
d©a
);

263 
tw_videoh264s_’_š™
(* 
d©a
);

264 
tw_videoh264s_’_»move
(*
d©a
);

266 
tw_j³g_’_š™
(* 
d©a
);

267 
tw_j³g_’_»move
();

269 
tw5864_audio_de_driv”_š™
(* 
·¿
);

270 
tw5864_audio_de_driv”_»move
();

272 
tw5864_audio_’_driv”_š™
(* 
·¿
);

273 
tw5864_audio_’_driv”_»move
();

275 
tw5864_video_’_driv”_š™
(* 
·¿
);

276 
tw5864_video_’_driv”_»move
();

278 
tw5864_videosub_’_driv”_š™
(* 
·¿
);

279 
tw5864_videosub_’_driv”_»move
();

281 
tw5864_j³g_’_driv”_š™
(* 
·¿
);

282 
tw5864_j³g_’_driv”_»move
();

284 
tw_ch_vi_š™
(* 
d©a
);

285 
tw_ch_vi_»move
();

287 
tw_ch_ai_š™
(* 
d©a
);

288 
tw_ch_ai_»move
();

291 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc_buffer.h

1 #iâdef 
__TWELL_CORE_BUF_H__


2 
	#__TWELL_CORE_BUF_H__


	)

5 #ifdeà
__ılu¥lus


12 
	#QUEUE_MAX_FRAME
 10

	)

13 
	#SCATTRT_MAX_ENTRY
 128

	)

15 
	#MIN_COMMON_HEAD_LEN
 ((
tc_bufãr
è+ (
tc_äame_h—d”
))

	)

17 
	#MIN_HEADER_LEN_AUDIO
 (
MIN_COMMON_HEAD_LEN
 + (
tc_audio_äame_·d
))

	)

18 
	#MIN_HEADER_LEN_VIDEO
 
MIN_COMMON_HEAD_LEN


	)

19 
	#MIN_HEADER_LEN_VIDEO_IDR
 (
MIN_COMMON_HEAD_LEN
 + (
tc_h264_idr_äame_·d
))

	)

20 
	#MIN_HEADER_LEN_JPEG
 
MIN_COMMON_HEAD_LEN


	)

22 
	etc_mem_ty³


24 
MEM_MMAP
 = 0,

26 
	etc_buf_ty³


28 
BUF_ENCODER_MAP
 = 0,

29 
BUF_ENCODER_SYNC
,

30 
BUF_DECODER_MAP
,

31 
BUF_DECODER_SYNC
,

35 
	etc_buf_§‹


37 
STATE_NEEDINIT
 = 0,

38 
STATE_FREE
,

39 
STATE_READY
,

40 
STATE_BUSY
,

41 
STATE_OBSOLETE
,

45 
	stc_buf_de¥t


47 
__u32
 
couÁ
;

48 
tc_buf_ty³
 
bty³
;

49 
tc_mem_ty³
 
mty³
;

52 
	stc_sÿ‰”


54 
__u32
 *
addr
;

55 
__u32
 
Ën
;

56 *
ÿ¼›r
;

60 
	#TC_BUFFER_TYPE_DS_H264
 0x0001

	)

61 
	#TC_BUFFER_TYPE_DS_AUDIO
 0x0002

	)

62 
	#TC_BUFFER_TYPE_DS_MJPEG
 0x0003

	)

69 
	stc_time


71 
hour
;

72 
mš
;

73 
£cÚd
;

74 
»sv”ed
;

76 
	stc_d©e


78 
y—r
;

79 
mÚth
;

80 
day
;

82 
	stc_xtime


84 
tc_d©e
 
d©e
;

85 
tc_time
 
time
;

88 
	stc_bufãr_h264_d¥t


90 
is_di¥Ïy
:1;

91 
is_’d
:1;

92 
is_fe_’d
:1;

93 
is_gİ_’d
:1;

96 
	stc_bufãr


99 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

100 
šdex
:8;

101 
ty³
:4;

102 
æag
:4;

103 
memÜy
:3;

104 
»v
:13;

105 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

106 
»v
:13;

107 
memÜy
:3;

108 
æag
:4;

109 
ty³
:4;

110 
šdex
:8;

120 
tc_xtime
 
abs_time
;

121 
·y_off
;

122 
·y_Ën
;

123 
ds_ty³
;

124 
is_xtime_v®id
;

125 
´iv©e_Ën
;

126 
´iv©e
[0];

127 }
ds
;

131 
tc_buf_§‹
 
¡©e
;

132 
Ä_äame
;

133 
i§lign
;

134 
off_to_·ge
;

135 
__u32
 *
¡¬t
;

136 
__u32
 
size
;

138 
´iv©e_Ën
;

139 
´iv©e
[0];

140 }
m
;

144 }
codec_šfo
;

146 
tc_äame_h—d
[0];

152 
	#__tc__¡©e
 
codec_šfo
.
m
.
¡©e


	)

153 
	#__tc__Ä_äame
 
codec_šfo
.
m
.
Ä_äame


	)

154 
	#__tc__i§lign
 
codec_šfo
.
m
.
i§lign


	)

155 
	#__tc__off_to_·ge
 
codec_šfo
.
m
.
off_to_·ge


	)

156 
	#__tc__¡¬t
 
codec_šfo
.
m
.
¡¬t


	)

157 
	#__tc__size
 
codec_šfo
.
m
.
size


	)

160 
	#__tc__abs_time
 
codec_šfo
.
ds
.
abs_time


	)

161 
	#__tc__·y_off
 
codec_šfo
.
ds
.
·y_off


	)

162 
	#__tc__·y_Ën
 
codec_šfo
.
ds
.
·y_Ën


	)

163 
	#__tc__ds_ty³
 
codec_šfo
.
ds
.
ds_ty³


	)

164 
	#__tc__is_abs_time_v®id
 
codec_šfo
.
ds
.
is_xtime_v®id


	)

165 
	#__tc__ds_´ivËn
 
codec_šfo
.
ds
.
´iv©e_Ën


	)

169 
	#INVALID_TIME
 0xAF

	)

174 
	stc_bufãr_k”n


176 
__u32
 
šdex
;

177 
tc_buf_ty³
 
ty³
;

178 
tc_buf_§‹
 
¡©e
;

179 
__u32
 
æag
;

180 
timev®
 
time¡­
;

181 
tc_queue
 *
tq
;

182 
wa™_queue_h—d_t
 
dÚe
;

183 
tc_mem_ty³
 
memÜy
;

184 
tc_h—d”_buf
 *
thb
;

185 
__u32
 
Ï¡_´•¬e
;

187 *
hŞd”
;

189 
i§lign
;

190 
off_to_·ge
;

191 
__u32
 *
¡¬t
;

192 
__u32
 
size
;

195 
tc_sÿ‰”
 
sg
[
SCATTRT_MAX_ENTRY
];

196 
tc_äame_h—d
[0];

200 
	stc_äame_h—d”
 {

201 
codecTy³
;

202 
¡»amTy³
;

203 
äameTy³
;

204 
äameS”Ÿl
;

205 
timeSmp
;

206 
·ylßd_off£t
;

207 
·ylßdL’
;

208 
·d
[0];

211 
	stc_audio_äame_·d
 {

212 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

213 
u32
 
bus_id
:4;

214 
u32
 
ch_id
:4;

215 
u32
 
chª_id
:4;

216 
u32
 
ty³
:4;

217 
u32
 
b™_wide
:4;

218 
u32
 
§m¶e_¿‹
:4;

219 
u32
 
b™_¿‹
:8;

220 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

221 
u32
 
b™_¿‹
:8;

222 
u32
 
§m¶e_¿‹
:4;

223 
u32
 
b™_wide
:4;

224 
u32
 
ty³
:4;

225 
u32
 
chª_id
:4;

226 
u32
 
ch_id
:4;

227 
u32
 
bus_id
:4;

231 
u32
 
äame_off£t
;

232 
u32
 
äame_size
;

233 
Çl
[0];

236 
	stc_h264_idr_äame_·d
{

237 
ås
;

238 
š™_qp
;

239 
log2MaxF¿meNumNšus4
;

240 
mb_width_mšus1
;

241 
mb_height_mšus1
;

242 
i_cu¼_qp
;

243 
¥s_äame_off£t
;

244 
¥s_äame_size
;

245 
µs_äame_off£t
;

246 
µs_äame_size
;

247 
idr_äame_off£t
;

248 
idr_äame_size
;

249 
Çl
[0];

252 
	stc_queue_İs


255 (*
buf_£tup
)(
tc_queue
 * 
tq
, *
outv®
);

256 (*
buf_´•¬e
)(
tc_queue
 * 
tq
, *
´iv
,
tc_bufãr
 
__u£r
 *
tc
);

257 (*
buf_»Ëa£
)(
tc_queue
 * 
tq
, *
´iv
,
tc_bufãr_k”n
 *
tc
);

258 (*
buf_to_»ady
)(
tc_queue
 * 
tq
, 
tc_bufãr_k”n
 *
tc
);

259 (*
buf_to_obsŞ‘e
)(
tc_queue
 * 
tq
, 
tc_bufãr_k”n
 *
tc
);

264 
	stc_queue
 {

265 
mu‹x
 
lock
;

266 *
dev
;

268 
tc_buf_ty³
 
ty³
;

269 
un™_size
;

270 
buf_Ä
;

271 
tc_bufãr_k”n
 *
bufs
[
QUEUE_MAX_FRAME
];

272 
wp
;

273 
½
;

274 
wa™_queue_h—d_t
 
dÚe
;

276 
tc_queue_İs
 *
İs
;

281 *
´iv_d©a
;

290 
šlše
 
queue_fuÎ
(
tc_queue
 * 
tq
)

292  (
tq
->
½
 =ğÑq->
wp
 + 1)%Ñq->
buf_Ä
));

295 
šlše
 
queue_em±y
(
tc_queue
 * 
tq
)

297  
tq
->
wp
 =ğtq->
½
;

302 
šlše
 
queue_šc_wp
(
tc_queue
 * 
tq
)

304 
tq
->
wp
++;

305 
tq
->
wp
 =q->w°%q->
buf_Ä
;

308 
šlše
 
queue_šc_½
(
tc_queue
 * 
tq
)

310 
tq
->
½
++;

311 
tq
->
½
 =q->½ %q->
buf_Ä
;

315 
šlše
 
£t_tck_¡©e
(
tc_bufãr_k”n
 *
tck
, 
tc_buf_§‹
 
Ãw_¡©e
)

317 
tck
->
¡©e
 = 
Ãw_¡©e
;

320 
šlše
 
tc_buf_§‹
 
g‘_tck_¡©e
(
tc_bufãr_k”n
 *
tck
)

322  
tck
->
¡©e
;

330 
£t_tq_¡©e_busy
(
tc_queue
 *
tq
);

331 
tc_bufãr_£t_audio_d©a
(
tc_bufãr
 *
tc
, 
tc_bufãr_k”n
 *
tck
,
tw_audio_·ck‘_£ùiÚ_t
 *
ps
,*
off
);

333 
tc_bufãr_£t_h264_d©a
(
is_ma¡”
,
tc_bufãr
 
__u£r
 *
tc
, 
tc_bufãr_k”n
 *
tck
, 
tw_video_äame_tcb_t
 *
vf
,*
off
);

334 
tc_bufãr_£t_j³g_d©a
(
tc_bufãr
 
__u£r
 *
tc
, 
tc_bufãr_k”n
 *
tck
, 
tw_vb_äame_tcb
 *
tvf
, *
off
);

335 
tc_queue_š™
(
tc_queue
 *
q
, 
tc_queue_İs
 *
İs
, * 
dev
,
usize
, 
buf_couÁ
,*
´iv
);

336 
tc_queue_»£t
(
tc_queue
 *
q
);

337 
tc_queue_»Ëa£
(
tc_queue
 *
q
);

344 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc_common.h

1 #iâdef 
__TW_CORE_COMMON_H__


2 
	#__TW_CORE_COMMON_H__


	)

4 #ifdeà
__ılu¥lus


9 
	~<lšux/ty³s.h
>

10 
	~<lšux/moduË.h
>

11 
	~<lšux/moduË·¿m.h
>

12 
	~<lšux/iİÜt.h
>

13 
	~<lšux/k”Ãl.h
>

14 
	~<lšux/li¡.h
>

15 
	~<lšux/d–ay.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/š‹¼u±.h
>

18 
	~<lšux/kmod.h
>

19 
	~<lšux/i2c.h
>

20 
	~<lšux/¡ršgify.h
>

21 
	~<lšux/mu‹x.h
>

22 
	~<lšux/¦ab.h
>

23 
	~<lšux/vm®loc.h
>

24 
	~<lšux/mm.h
>

25 
	~<lšux/wa™.h
>

26 
	~<lšux/com¶‘iÚ.h
>

27 
	~<lšux/time.h
>

28 
	~<lšux/dma-m­pšg.h
>

29 
	~<lšux/¶©fÜm_deviû.h
>

30 
	~<lšux/videodev2.h
>

31 
	~<lšux/dma-m­pšg.h
>

32 
	~<lšux/kth»ad.h
>

33 
	~<lšux/highmem.h
>

34 
	~<lšux/sysfs.h
>

35 
	~<lšux/pŞl.h
>

36 
	~<lšux/œq.h
>

37 
	~<lšux/ioùl.h
>

38 
	~<lšux/´oc_fs.h
>

39 
	~<lšux/v”siÚ.h
>

40 
	~<asm/io.h
>

41 
	~<asm/·ge.h
>

42 
	~<asm/œq.h
>

43 
	~<asm/©omic.h
>

44 
	~<asm/dma.h
>

45 
	~<asm/uacûss.h
>

48 
	~<tw5864/dvm_commÚ.h
>

49 
	~<tw5864/tw_ch_driv”.h
>

50 
	~<tw5864/tw_codec_commÚ.h
>

51 
	~<tw5864/tc.h
>

52 
	~<tw5864/tc_audio_’code.h
>

53 
	~<tw5864/tc_bufãr.h
>

54 
	~<tw5864/tc_h–³r.h
>

56 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc_helper.h

1 #iâdef 
__TC_HELPER_H__


2 
	#__TC_HELPER_H__


	)

4 #ifdeà
__ılu¥lus


13 
	smemblock_s


15 
li¡_h—d
 
li¡
;

16 *
±r
;

17 
size_t
 
size
;

24 *
tc_m®loc
(
size_t
 
size
);

25 
tc_ä“
(*
±r
);

26 *
tc_»®loc
(*
±r
, 
size_t
 
size
);

39 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tc_ioctl.h

1 #iâdeà
__DVM_CORE_IOCTL_H__


2 
	#__DVM_CORE_IOCTL_H__


	)

4 
	~<lšux/ioùl.h
>

5 
	~<tw5864/tc_commÚ.h
>

9 
	#DVM_SYS_IOC_MAGIC
 'S'

	)

10 
	#DVM_CODEC_IOC_MAGIC
 'C'

	)

11 
	#DVM_MOTION_DECTION_IOC_MAGIC
 'D'

	)

12 
	#DVM_OSD_IOC_MAGIC
 'O'

	)

13 
	#DVM_IOC_MAXNR
 (256)

	)

19 
	#DVM_SYS_GET_CHAN_WORK_MODE
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 12, )

	)

20 
	#DVM_SYS_SET_CHAN_WORK_MODE
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 13, )

	)

21 
	#DVM_SYS_CREATE_CHAN
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 14, )

	)

22 
	#DVM_SYS_RELEASE_CHAN
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 15, )

	)

23 
	#DVM_SYS_QUERY_CAP
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 16, )

	)

24 
	#DVM_SYS_GET_CTL
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 17, )

	)

25 
	#DVM_SYS_SET_CTL
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 18, )

	)

27 
	#DVM_SYS_REQUEST_MEM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 19, )

	)

28 
	#DVM_SYS_RELEASE_MEM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 20, )

	)

41 
	#DVM_CODEC_GET_AUDIO_ENCODER_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 4, )

	)

42 
	#DVM_CODEC_SET_AUDIO_ENCODER_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 5, )

	)

43 
	#DVM_CODEC_SET_VIDEO_TIMESTAMP_BASE
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 6, )

	)

44 
	#DVM_CODEC_GET_VIDEO_TIMESTAMP_BASE
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 7, )

	)

47 
	#DVM_MOTION_DECTION_GET_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 0, )

	)

48 
	#DVM_MOTION_DECTION_SET_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 1, )

	)

51 
	#DVM_OSD_GET_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 0, )

	)

52 
	#DVM_OSD_SET_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 1, )

	)

	@../../tw5864/include/tw5864/tc_video_en.h

1 #iâdef 
TW_AUDIO_EN_H__


2 
	#TW_AUDIO_EN_H__


	)

5 #ifdeà
__ılu¥lus


13 
	stw_video_·¿


15 
id
;

21 
	stw_video_’


23 
tw_£rviû_deviû
 
tsd
;

24 
tw_dev_bË_id
 
tbid
;

25 *
Çme
;

26 
u£rs
;

27 
¡©e
;

28 
tw_video_·¿
 
·¿
;

29 
tw_h264_logic_’code_chª
 *
driv
;

30 
£m­hÜe
 
£m
;

31 
wa™_queue_h—d_t
 
wa™_pŞl
;

32 
tim”_id
;

36 
šlše
 
£t_tve_¡©e
(
tw_audio_’
 *
tve
, 
AUDIO_STATE
 
Ãw_¡©e
)

38 
tve
->
¡©e
 = 
Ãw_¡©e
;

67 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw5864_chip.h

1 #iâdef 
TW5864_CHIP_H


2 
	#TW5864_CHIP_H


	)

4 #ifdeà
__ılu¥lus


9 
	#QUANTIZATION_TABLE_LEN
 (96)

	)

10 
	#VLC_LOOKUP_TABLE_LEN
 (1024)

	)

11 
	#VLC_LOOKUP_TABLE_BASE
 (0x2000)

	)

12 
	#ENCRYPT_FIRMWARE_BASE
 (0x82000)

	)

13 
	#ENCRYPT_FIRMWARE_LEN
 (2048)

	)

14 
	#START_ENCRYPT_FIRMWARE
 (0x80044)

	)

16 
	#DDRON
 (0x0001)

	)

17 
	#INTERON
 (0x0002)

	)

18 
	#CMOSON
 (0x0004)

	)

19 
	#INTRAON
 (0x0008)

	)

20 
	#DEBLOCKINGON
 (0x0010)

	)

21 
	#DAON
 (0x0020)

	)

22 
	#CIF
 (0x0000)

	)

23 
	#D1
 (0x0040)

	)

24 
	#HD_720P_1080I
 (0x0080)

	)

25 
	#HALFD1
 (0x00c0)

	)

27 
	#ENABLE_INSERT_03
 (0x00080)

	)

28 
	#ENABLE_CDC_VLCS_MAST_R
 (0x02000)

	)

29 
	#ENABLE_VLC_FLOWCONTROL
 (0x04000)

	)

30 
	#MASK_HARDWARE_INSERT_03
 (0x10000)

	)

32 
	#ENABLE_VLC_BITSTREAM_SEND_DDR
 (0x0080)

	)

34 
	#AD_DA_LOOP
 (8)

	)

35 
	#START_DAC
 (2)

	)

36 
	#START_COMS_EN
 (4)

	)

37 
	#START_ORIG_DAC
 (1)

	)

38 
	#DDR_A_CHIP
 (0<<5)

	)

39 
	#DDR_B_CHIP
 (1<<5)

	)

41 
	#MAX_MB_DELAY
 (128 * 16)

	)

42 
	#MIN_MB_DELAY
 (0)

	)

43 
	#MB_DELAY_VALUE
 (0xf<<4)

44 
	#SEARCH_WINDOW_SIZE_VALUE
 (0x0109)

	)

46 
	#DEFAULT_SYS_CLK
 185

	)

48 
	#MODE
 (0x0004)

	)

49 
	#CHIPSCOPE
 (0x000c)

	)

50 
	#TOTAL_CHAN_CUR_PTR
 (0x0010)

	)

51 
	#WORD_SHORT_CNTL
 (0x0014)

	)

52 
	#QP
 (0x0018)

	)

53 
	#CIF_MAP_D1_MODE
 (0x001c)

	)

54 
	#ORIGINALSEQUENCE
 (0x0020)

	)

55 
	#REFERENCEFRAME
 (0x0024)

	)

56 
	#CHANNEL_SELECT
 (0x0028)

	)

57 
	#CHANNEL_ID
 (0x002c)

	)

58 
	#DDRPAGE
 (0x0030)

	)

59 
	#DSP_DEBUG_CNTL
 (0x0034)

	)

60 
	#AD_ORIG_RAM_BASE
 (0x0038)

	)

61 
	#AD_CHAN_8_15_ORIG_BASE
 (0x003c)

	)

62 
	#NEW_SENSOR_CONTROL
 (0x0040)

	)

63 
	#TOTAL_CHAN_8_15_CUR_PTR
 (0x004c)

	)

64 
	#INTERSTART
 (0x0200)

	)

65 
	#WINDOWSIZE
 (0x0204)

	)

66 
	#MBADDR
 (0x0208)

	)

67 
	#INTRANDMECONTROL
 (0x020c)

	)

68 
	#REFFRAMEINDEX
 (0x0210)

	)

69 
	#LAMDA
 (0x0214)

	)

70 
	#FRAMERESOLUTION
 (0x0218)

	)

71 
	#DSP_CUR_RAM_BASE
 (0x021c)

	)

73 
	#OSD_ATTRI_BASE_REG
 (0x0220)

	)

74 
	#OSD_ATTRI_UPDATE_REG
 (0x0224)

	)

75 
	#OSD_RECTANGLE_EN_REG
 (0x0228)

	)

77 
	#ENCRYPT_CLOCK
 (0x0248)

	)

78 
	#INTRASTART
 (0x0400)

	)

79 
	#INTRA4X4_THRESHOLD_I
 (0x040c)

	)

80 
	#INTRAENABLE
 (0x0410)

	)

81 
	#MB4X4LAMDA
 (0x0414)

	)

82 
	#MEREADY
 (0x0600)

	)

83 
	#INTRA4X4_THRESHOLD_IP
 (0x604)

	)

84 
	#MBMODE
 (0x060c)

	)

85 
	#QUANTIZATION
 (0x0800)

	)

86 
	#ENCODER_VLC_PARAM
 (0x1000)

	)

87 
	#SLICE_TOTAL_BIT_NUMBER
 (0x1004)

	)

88 
	#RES_TOTAL_BIT_NUMBER
 (0x1008)

	)

89 
	#TOTAL_COEFF_NUMBER
 (0x1010)

	)

90 
	#ENCODER_VLC_INTR_STATUS
 (0x100c)

	)

91 
	#VLC_ENCODER_INTERRUPT
 (0x1014)

	)

92 
	#ENABLE_VLC_LOOKUP_TABLE
 (0x101c)

	)

94 
	#MV_VECTOR_CONTROL
 (0xfc04)

	)

96 
	#CHIP_TIEMR_INTERVAL
 (0x1804c)

	)

97 
	#ONE_MS_INTERVAL
 (0x0)

	)

98 
	#TWO_MS_INTERVAL
 (0x1)

	)

99 
	#FOUR_MS_INTERVAL
 (0x2)

	)

100 
	#EIGHT_MS_INTERVAL
 (0x3)

	)

103 
	#SENIF_BUS01_MODE
 (0x0d00)

	)

104 
	#SENIF_BUS23_MODE
 (0x0d04)

	)

105 
	#SENIF_HOR_MIR
 (0x0d08)

	)

106 
	#SENIF_VER_MIR
 (0x0d0c)

	)

107 
	#SENIF_WIDTH_PARTA
(
bus
è(0x0d10 + (busè* 0x10)

	)

108 
	#SENIF_WIDTH_PARTB
(
bus
è(0x0d14 + (busè* 0x10)

	)

109 
	#SENIF_HEIGHT_PARTA
(
bus
è(0x0d18 + (busè* 0x10)

	)

110 
	#SENIF_HEIGHT_PARTB
(
bus
è(0x0d1ø+ (busè* 0x10)

	)

111 
	#SENIF_FULL_FLAGS
 (0x0d50)

	)

112 
	#SENIF_PARTAB_SELECT
 (0x0d54)

	)

114 #ifdef 
TW5864_CHIP


115 
	#AUDIO_1MS_PLL_COUNTER_REG
 (0x4000)

	)

116 
	#AUDIO_EN_CONTROL_REG
 (0x4004)

	)

117 
	#AUDIO_IN_ORIG_EN_CONTROL_REG
 (0x4008)

	)

118 
	#AUDIO_IN_ADPCM_EN_CONTROL_REG
 (0x400c)

	)

119 
	#AUDIO_OUT_CONTROL_REG
 (0x4014)

	)

121 
	#HOST_BLOCK_RD_ADPCM_FINISH_REG
 (0x4018)

	)

122 
	#ADPCM_ENCODE_WR_PTR_CH0_CH9_REG
 (0x401c)

	)

123 
	#ADPCM_ENCODE_WR_PTR_CH10_CH16_REG
 (0x4020)

	)

124 
	#ADPCM_ENCODE_RD_PTR_CH0_CH9_REG
 (0x4024)

	)

125 
	#ADPCM_ENCODE_RD_PTR_CH10_CH16_REG
 (0x4028)

	)

127 
	#ADPCM_DECODE_RD_WR_PTR_REG
 (0x402c)

	)

129 
	#PCM_ENCODE_WR_PTR_CH0_CH7_REG
 (0x4030)

	)

130 
	#PCM_ENCODE_WR_PTR_CH8_CH15_REG
 (0x4034)

	)

131 
	#PCM_ENCODE_WR_PTR_CH16_REG
 (0x4038)

	)

132 
	#PCM_ENCODE_RD_PTR_CH0_CH7_REG
 (0x403c)

	)

133 
	#PCM_ENCODE_RD_PTR_CH8_CH15_REG
 (0x4040)

	)

134 
	#PCM_ENCODE_RD_PTR_CH16_REG
 (0x4044)

	)

135 
	#HOST_BLOCK_RD_PCM_FINISH_REG
 (0x4048)

	)

138 
	#CDC_VLCS_MASTER_REG
 (0x8008)

	)

139 
	#CHIP_IRQS_NR
 (32)

	)

140 
	#INTERRUPT_SOURCE_TRIGGER_REG_L
 (0x8800)

	)

141 
	#INTERRUPT_SOURCE_TRIGGER_REG_H
 (0x8804)

	)

142 
	#EDGE_TRIGGER
 (1)

	)

143 
	#LEVEL_TRIGGER
 (0)

	)

144 
	#INTERRUPT_SOURCE_ENABLE_REG_L
 (0x8808)

	)

145 
	#INTERRUPT_SOURCE_ENABLE_REG_H
 (0x880c)

	)

146 
	#INTERRUPT_ENABLE
 (1)

	)

147 
	#INTERRUPT_DISABLE
 (0)

	)

148 
	#INTERRUPT_CLEAR_REG_L
 (0x8810)

	)

149 
	#INTERRUPT_CLEAR_REG_H
 (0x8814)

	)

150 
	#INTERRUPT_ASSERT_REG_L
 (0x8818)

	)

151 
	#INTERRUPT_ASSERT_REG_H
 (0x881c)

	)

152 
	#INTERRUPT_OUTPUT_ASSERT_REG
 (0x8820)

	)

153 
	#INTERRUPT_STATUS_REG_L
 (0x8838)

	)

154 
	#INTERRUPT_STATUS_REG_H
 (0x883c)

	)

156 
	#INTERRUPT_FLAGS_EXT
 (0x18000)

	)

157 
	#PCI_MASTER_CONTROL
 (0x18004)

	)

158 
	#IRQ_EXT_VLC_INTR
 (1)

	)

159 
	#IRQ_EXT_ADSYNC_INTR
 (3)

	)

160 
	#IRQ_EXT_PRVEOF_INTR
 (4)

	)

161 
	#IRQ_EXT_PRVOVR_INTR
 (5)

	)

162 
	#IRQ_EXT_TIMER_INTR
 (6)

	)

163 
	#IRQ_EXT_AUDIO_EOF_INTR
 (8)

	)

164 
	#IRQ_EXT_IIC_INTR
 (24)

	)

165 
	#IRQ_EXT_AD_INTR
 (25è

	)

167 
	#PCI_I2C
 (0x18014)

	)

168 
	#MCU_IIC_CONF
 (0x18048)

	)

169 
	#PCI_TIMER_CONTROL
 (0x1804c)

	)

170 
	#I2C_PHASE_SHIFT
 (0x800c)

	)

172 #ifdeà
USE_ON_CHIP_TIMER


173 
	#MS_PER_TICK
 (4)

	)

175 
	#MS_PER_TICK
 (5)

	)

178 
	#IRQ_VLC_TYPE_INTR
 (0)

	)

179 
	#IRQ_BURST_TYPE_INTR
 (1)

	)

180 
	#IRQ_MV_TYPE_INTR
 (2)

	)

181 
	#IRQ_FRONT_END_TYPE_INTR
 (3)

	)

182 
	#IRQ_JPEG_TYPE_INTR
 (12)

	)

183 
	#IRQ_TIMER_TYPE_INTR
 (22)

	)

184 
	#IRQ_VLC_DONE_TYPE_INTR
 (17)

	)

185 
	#IRQ_AD_SYNC_TYPE_INTR
 (19)

	)

186 
	#IRQ_PREV_EOF_TYPE_INTR
 (20)

	)

187 
	#IRQ_PREV_OVERFLOW_TYPE_INTR
 (21)

	)

188 
	#IRQ_AUDIO_EOF_TYPE_INTR
 (24)

	)

189 
	#IRQ_IIC_DONE_INTR
 (25)

	)

190 
	#IRQ_AD_EVENT_INTR
 (26)

	)

192 
	#ASIC_FRAME_MODE
 (0x9000)

	)

193 
	#ASIC_FRAME_MODE_UPDATE
 (0x900C)

	)

195 
	#DDRBASE
 (0x80000)

	)

196 
	#DDR_BURST_REG
 (0x80040)

	)

197 
	#DDR_MAP_COMPRESS_ENABLE
 (0)

	)

198 
	#DDR_MAP_COMPRESS_DISABLE
 (1)

	)

200 
	#AUDIO_ONE_CHIP_FOUR_CHAN
 (0x3)

	)

201 
	#AUDIO_TWO_CHIP_FOUR_CHAN
 (0xc)

	)

202 
	#AUDIO_ONE_CHIP_TWO_CHAN_AND_TWO_CHIP_TWO_CHAN
 (0xa)

	)

204 
	#OSD_ATTR_REG_BASE_ADDR
 (0x047f)

	)

205 
	#OSD_ATTR_REG_SHIFT
 (10)

	)

207 
	#CHAN_VIDEO_TIMESTAMP_BASE
 (0xc00)

	)

209 
	#FPGA_LEN_OFFSET
 (4)

	)

210 
	#VLC_INTR_STATUS_MASK
 (7)

	)

211 
	#VLC_INTR_MASK_ALL
 (0xf)

	)

213 
	#VLC_INTERRUPT_NULL
 (0)

	)

214 
	#VLC_A_BANK_FULL
 (1)

	)

215 
	#VLC_B_BANK_FULL
 (2)

	)

216 
	#VLC_A_B_BANK_FULL
 (3)

	)

217 
	#VLC_END_SLICE
 (4)

	)

218 
	#VLC_A_FULL_END_SLICE
 (5)

	)

219 
	#VLC_B_FULL_END_SLICE
 (6)

	)

220 
	#VLC_BANK_END_OVERFLOW
 (7)

	)

221 
	#VLC_OVERFLOW
 (8)

	)

223 
	#FPGA_ASYNC_SECTION_LEN
 (0x200000)

	)

225 
	#FPGA_RESET_VALID
 0

	)

226 
	#FPGA_RESET_INVALID
 1

	)

229 #ifdef 
ARM_PLATFORM


230 
	#FPGA0_BASE_ADDR
 (
S3C2410_PA_FPGA
)

	)

231 
	#FPGA0_SECTION_LEN
 (0x200000)

	)

233 
	#FPGA_CCLK_PIN
 
S3C2410_GPG7


	)

234 
	#FPGA_CCLK_PIN_FN
 
S3C2410_GPG7_SPICLK1


	)

235 
	#FPGA_DIN_PIN
 
S3C2410_GPG6


	)

236 
	#FPGA_DIN_PIN_FN
 
S3C2410_GPG6_SPIMOSI1


	)

237 
	#FPGA_DONE_PIN
 
S3C2410_GPG5


	)

238 
	#FPGA_DONE_PIN_FN
 
S3C2410_GPG5_INP


	)

239 
	#FPGA_INIT_B_PIN
 
S3C2410_GPG4


	)

240 
	#FPGA_INIT_B_PIN_FN
 
S3C2410_GPG4_INP


	)

241 
	#FPGA_PROG_PIN
 
S3C2410_GPG3


	)

242 
	#FPGA_PROG_PIN_FN
 
S3C2410_GPG3_OUTP


	)

244 
	#BOARD_STATUS_INDICATION_PIN
 
S3C2410_GPF5


	)

245 
	#BOARD_STATUS_INDICATION_PIN_FN
 
S3C2410_GPF5_OUTP


	)

247 #ifdef 
ARM_S3C2410_NVS_PLATFORM


248 
	#IRQ_FPGA_PIN
 
S3C2410_GPF1


	)

249 
	#IRQ_FPGA_PIN_FN
 
S3C2410_GPF1_EINT1


	)

250 
	#UNIRQ_FPGA_PIN_FN
 
S3C2410_GPF1_INP


	)

251 
	#IRQ_FPGA
 
IRQ_EINT1


	)

252 
	#IRQ_IDE_PIN
 
S3C2410_GPF6


	)

253 
	#IRQ_IDE_PIN_FN
 
S3C2410_GPF6_EINT6


	)

254 
	#UNIRQ_IDE_PIN_FN
 
S3C2410_GPF6_INP


	)

255 
	#IRQ_IDE
 
IRQ_EINT6


	)

256 
	#IRQ_DM9K_PIN
 
S3C2410_GPF2


	)

257 
	#IRQ_DM9K_PIN_FN
 
S3C2410_GPF2_EINT2


	)

258 
	#UNIRQ_DM9K_PIN_FN
 
S3C2410_GPF2_INP


	)

259 
	#IRQ_DM9K
 
IRQ_EINT2


	)

260 
	#LOST_VIDEO_PIN
 
S3C2410_GPG0


	)

261 
	#LOST_VIDEO_PIN_FN
 
S3C2410_GPG0_EINT8


	)

262 
	#UNLOST_VIDEO_PIN_FN
 
S3C2410_GPG0_INP


	)

263 
	#LOST_VIDEO_IRQ
 
IRQ_EINT8


	)

264 
	#FPGA_RESET_PIN
 
S3C2410_GPE8


	)

265 
	#FPGA_RESET_PIN_FN
 
S3C2410_GPE8_OUTP


	)

266 
	#RESTORE_DEFAULT_PIN
 
S3C2410_GPE2


	)

267 
	#RESTORE_DEFAULT_PIN_FN
 
S3C2410_GPE2_INP


	)

269 
	#NVS_ALARM_IN_OC1
 
S3C2410_GPG8


	)

270 
	#NVS_ALARM_IN_OC1_FN
 
S3C2410_GPG8_INP


	)

271 
	#NVS_ALARM_IN_OC2
 
S3C2410_GPG9


	)

272 
	#NVS_ALARM_IN_OC2_FN
 
S3C2410_GPG9_INP


	)

273 
	#NVS_ALARM_IN_OC3
 
S3C2410_GPG10


	)

274 
	#NVS_ALARM_IN_OC3_FN
 
S3C2410_GPG10_INP


	)

275 
	#NVS_ALARM_IN_OC4
 
S3C2410_GPG11


	)

276 
	#NVS_ALARM_IN_OC4_FN
 
S3C2410_GPG11_INP


	)

277 
	#NVS_ALARM_OUT1
 
S3C2410_GPG12


	)

278 
	#NVS_ALARM_OUT1_FN
 
S3C2410_GPG12_OUTP


	)

279 
	#NVS_ALARM_OUT1_UNFN
 
S3C2410_GPG12_INP


	)

280 
	#NVS_ALARM_OUT1_INVALID
 0

	)

281 
	#NVS_ALARM_OUT1_VALID
 1

	)

282 
	#NVS_ALARM_OUT2
 
S3C2410_GPG13


	)

283 
	#NVS_ALARM_OUT2_FN
 
S3C2410_GPG13_OUTP


	)

284 
	#NVS_ALARM_OUT2_UNFN
 
S3C2410_GPG13_INP


	)

285 
	#NVS_ALARM_OUT2_INVALID
 0

	)

286 
	#NVS_ALARM_OUT2_VALID
 1

	)

288 #ifdef 
ARM_S3C2440_DVR_PLATFORM


289 
	#IRQ_FPGA_PIN
 
S3C2410_GPF0


	)

290 
	#IRQ_FPGA_PIN_FN
 
S3C2410_GPF0_EINT0


	)

291 
	#UNIRQ_FPGA_PIN_FN
 
S3C2410_GPF0_INP


	)

292 
	#IRQ_FPGA
 
IRQ_EINT0


	)

293 
	#IRQ_IDE_PIN
 
S3C2410_GPF6


	)

294 
	#IRQ_IDE_PIN_FN
 
S3C2410_GPF6_EINT6


	)

295 
	#UNIRQ_IDE_PIN_FN
 
S3C2410_GPF6_INP


	)

296 
	#IRQ_IDE
 
IRQ_EINT6


	)

297 
	#IRQ_DM9K_PIN
 
S3C2410_GPF4


	)

298 
	#IRQ_DM9K_PIN_FN
 
S3C2410_GPF4_EINT4


	)

299 
	#UNIRQ_DM9K_PIN_FN
 
S3C2410_GPF4_INP


	)

300 
	#IRQ_DM9K
 
IRQ_EINT4


	)

301 
	#FPGA_RESET_PIN
 
S3C2410_GPG0


	)

302 
	#FPGA_RESET_PIN_FN
 
S3C2410_GPG0_OUTP


	)

304 #ifdef 
ARM_S3C2440_ANALOG_VGA_DVR


305 
	#IRQ_FPGA_PIN
 
S3C2410_GPF1


	)

306 
	#IRQ_FPGA_PIN_FN
 
S3C2410_GPF1_EINT1


	)

307 
	#UNIRQ_FPGA_PIN_FN
 
S3C2410_GPF1_INP


	)

308 
	#IRQ_FPGA
 
IRQ_EINT1


	)

309 
	#IRQ_IDE_PIN
 
S3C2410_GPF6


	)

310 
	#IRQ_IDE_PIN_FN
 
S3C2410_GPF6_EINT6


	)

311 
	#UNIRQ_IDE_PIN_FN
 
S3C2410_GPF6_INP


	)

312 
	#IRQ_IDE
 
IRQ_EINT6


	)

313 
	#IRQ_DM9K_PIN
 
S3C2410_GPF2


	)

314 
	#IRQ_DM9K_PIN_FN
 
S3C2410_GPF2_EINT2


	)

315 
	#UNIRQ_DM9K_PIN_FN
 
S3C2410_GPF2_INP


	)

316 
	#IRQ_DM9K
 
IRQ_EINT2


	)

317 
	#FPGA_RESET_PIN
 
S3C2410_GPE8


	)

318 
	#FPGA_RESET_PIN_FN
 
S3C2410_GPE8_OUTP


	)

321 
	#DMA_AUDIO_CHAN
 (1)

	)

322 
	#IRQ_DMA_AUDIO
 
IRQ_DMA1


	)

324 
	#DMA_IDE_CHAN
 (0)

	)

325 
	#IRQ_IDE_DMA
 
IRQ_DMA0


	)

326 
	#IDE_DEMAND_DMA_CON_AUTO
 (
S3C2410_DCON_SYNC_HCLK
|
S3C2410_DCON_INTREQ
|
S3C2410_DCON_WHOLE_SERVICE
|
S3C2410_DCON_CH0_XDREQ0
|
S3C2410_DCON_HWTRIG
|
S3C2410_DCON_HALFWORD
)

	)

327 
	#IDE_DEMAND_DMA_CON_NOAUTO
 (
S3C2410_DCON_SYNC_HCLK
|
S3C2410_DCON_INTREQ
|
S3C2410_DCON_WHOLE_SERVICE
|
S3C2410_DCON_CH0_XDREQ0
|
S3C2410_DCON_HWTRIG
|
S3C2410_DCON_NORELOAD
|
S3C2410_DCON_HALFWORD
)

	)

328 
	#IDE_HANDSHAKE_DMA_CON_AUTO
 (
S3C2410_DCON_HANDSHAKE
|
S3C2410_DCON_SYNC_HCLK
|
S3C2410_DCON_INTREQ
|
S3C2410_DCON_WHOLE_SERVICE
|
S3C2410_DCON_CH0_XDREQ0
|
S3C2410_DCON_HWTRIG
|
S3C2410_DCON_HALFWORD
)

	)

329 
	#IDE_HANDSHAKE_DMA_CON_NOAUTO
 (
S3C2410_DCON_HANDSHAKE
|
S3C2410_DCON_SYNC_HCLK
|
S3C2410_DCON_INTREQ
|
S3C2410_DCON_WHOLE_SERVICE
|
S3C2410_DCON_CH0_XDREQ0
|
S3C2410_DCON_HWTRIG
|
S3C2410_DCON_NORELOAD
|
S3C2410_DCON_HALFWORD
)

	)

332 #ifdef 
POWERPC_PLATFORM


333 
	#TEST_REG
 (0x00)

	)

334 
	#TW2815_INT
 (0x01)

	)

335 
	#ALM_IN_HIGH
 (0x02)

	)

336 
	#ALM_IN_LOW
 (0x03)

	)

337 
	#FPGA_INT_ID
 (0x04)

	)

338 
	#FPGA_CHIP_ALL_MASK
 (0x1f)

	)

339 
	#FPGA_CHIP_1_INT_ID
 (0x10)

	)

340 
	#FPGA_CHIP_2_INT_ID
 (0x08)

	)

341 
	#FPGA_CHIP_3_INT_ID
 (0x04)

	)

342 
	#FPGA_CHIP_4_INT_ID
 (0x02)

	)

343 
	#FPGA_CHIP_5_INT_ID
 (0x01)

	)

344 
	#RESET_REG
 (0x08)

	)

345 
	#RESET_REG_TW2835
 (0x80)

	)

346 
	#RESET_REG_VGA
 (0x40)

	)

347 
	#RESET_REG_FPGA_CHIP_5
 (0x20)

	)

348 
	#RESET_REG_FPGA_CHIP_4
 (0x10)

	)

349 
	#RESET_REG_FPGA_CHIP_3
 (0x08)

	)

350 
	#RESET_REG_FPGA_CHIP_2
 (0x04)

	)

351 
	#RESET_REG_FPGA_CHIP_1
 (0x02)

	)

352 
	#CPLD_BASE_ADDR
 (0x50000000)

	)

353 
	#CPLD_SECTION_LEN
 (0x100000)

	)

355 
	#FPGA0_BASE_ADDR
 (0x60000000)

	)

356 
	#FPGA1_BASE_ADDR
 (0x60400000)

	)

357 
	#FPGA2_BASE_ADDR
 (0x60800000)

	)

358 
	#FPGA3_BASE_ADDR
 (0x60c00000)

	)

359 
	#FPGA4_BASE_ADDR
 (0x61000000)

	)

361 
	#FPGA0_SYNC_BASE_ADDR
 (0x70000000)

	)

362 
	#FPGA1_SYNC_BASE_ADDR
 (0x70400000)

	)

363 
	#FPGA2_SYNC_BASE_ADDR
 (0x70800000)

	)

364 
	#FPGA3_SYNC_BASE_ADDR
 (0x70c00000)

	)

365 
	#FPGA4_SYNC_BASE_ADDR
 (0x71000000)

	)

366 
	#FPGA_SYNC_SECTION_LEN
 (0x100000)

	)

368 #ifdeà
POWERPC_PCI_PLATFORM


369 
	#IRQ_FPGA
 (0x13)

	)

371 
	#IRQ_FPGA
 (0x30)

	)

373 
	#IRQT_LOW
 (
IRQ_TYPE_LEVEL_LOW
)

	)

374 
	#IRQ_SYS_INTERNAL
 (0x41)

	)

377 
	#ENCODE_4_D1
 (0x00000000)

	)

378 
	#ENCODE_16_CIF
 (0x00000001)

	)

379 
	#ENCODE_WORK_MODE_MASK
 (0x00000003)

	)

383 
u8
 
fœ¡_deviû_numb”
;

384 
u32
 
video_’code_wÜk_mode
;

385 
u32
 
’code_»g_4
;

386 
u32
 
åga_sync_ba£_addr
;

387 
u32
 
åga_sync_£ùiÚ_Ën
;

388 
u32
 
åga_async_ba£_addr
;

389 
u32
 
åga_async_£ùiÚ_Ën
;

390 
u32
 
ddr_m­_mode
;

391 }
	tDVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
;

393 
	stw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_İ”©iÚ
{

394 (*
š™
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
dvm_ch_t
 *
ch
);

395 (*
’abË_š‹¼u±_sourû
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
u32
 
sourû
);

396 (*
di§bË_š‹¼u±_sourû
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
u32
 
sourû
);

397 (*
£t_š‹¼u±_sourû_edge_Œigg”
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
u32
 
sourû
);

398 (*
£t_š‹¼u±_sourû_Ëv–_Œigg”
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
u32
 
sourû
);

401 
	stw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_İ”©iÚ
{

402 (*
g‘_š‹¼u±_¡©us
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *);

403 (*
ack_š‹¼u±
)(
tw5864_š‹¼u±_cÚŒŞ_t
 *, 
u32
 
sourû
);

406 
	sch_œq_aùiÚ
{

407 
œq_hªdËr_t
 
hªdËr
;

408 
œq
;

409 
æags
;

410 cÚ¡ *
Çme
;

411 *
cÚ‹xt
;

412 
ch_œq_aùiÚ
 *
Ãxt
;

415 
	sch_œq_desc
{

416 
u32
 
œq
;

417 
u32
 
œq_couÁ
;

418 
u32
 
œqs_unhªdËd
;

419 
¥šlock_t
 
lock
;

420 
©omic_t
 
d•th
;

421 
ch_œq_aùiÚ
 
aùiÚ
;

422 cÚ¡ *
Çme
;

427 
	stw5864_š‹¼u±_cÚŒŞ
{

428 
¥šlock_t
 
lock
;

429 
__u32
 
š‹¼u±_sourû
;

430 
__u32
 
š‹¼u±_sourû_Œigg”_mode
;

431 
__u32
 
š‹¼u±_sourû_as£¹
;

432 
__u32
 
ch_š‹¼u±_ouut_as£¹
;

433 
__u32
 
ch_š‹¼u±_¡©us
;

435 
ch_œq_desc
 ch_œq_desc[
CHIP_IRQS_NR
];

437 
ch_œq
;

438 
dvm_ch_t
 *
ch
;

440 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_İ”©iÚ
 *
sy¡em_İ
;

441 
tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_İ”©iÚ
 *
h¬dw¬e_İ
;

444 
	sch_io_İ”©iÚ
{

445 
u32
 (*
ch_»ad32
)(
dvm_ch_t
 *, u32 
off£t
);

446 
u16
 (*
ch_»ad16
)(
dvm_ch_t
 *, 
u32
 
off£t
);

447 
u8
 (*
ch_»ad8
)(
dvm_ch_t
 *, 
u32
 
off£t
);

448 (*
ch_»ad_block
)(
dvm_ch_t
 *, 
u32
 
off£t
, 
Ën
, u32 *
de¡
);

449 (*
ch_wr™e32
)(
dvm_ch_t
 *, 
u32
 
off£t
, u32 
v®ue
);

450 (*
ch_wr™e16
)(
dvm_ch_t
 *, 
u32
 
off£t
, 
u16
 
v®ue
);

451 (*
ch_wr™e8
)(
dvm_ch_t
 *, 
u32
 
off£t
, 
u8
 
v®ue
);

452 (*
ch_wr™e_block
)(
dvm_ch_t
 *, 
u32
 
off£t
, 
Ën
, u32 *
¤c
);

455 
	#to_g‘_ch_w™h_ch_d´am_cÚŒŞËr
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
ch_d´am_cÚŒŞËr
)

	)

456 
	#to_g‘_ch_w™h_ch_üoss_bus
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
ch_vd_üoss_bus
)

	)

457 
	#to_g‘_ch_w™h_ch_vj_bus
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
ch_vj_bus
)

	)

458 
	#to_g‘_ch_w™h_ch_driv”
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
ch_driv”
)

	)

459 
	#to_g‘_ch_w™h_ch_bus
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
tw5864_ch_bus
)

	)

460 
	#to_g‘_ch_w™h_ch_’code_£rviû_queue
(
node
è
	`cÚš”_of
Òode, 
dvm_ch_t
, 
ch_’code_£rviû_queue
)

	)

461 
	#CHIP_NAME_LEN
 (32)

	)

462 
	sdvm4000i_ch


464 
Çme
[
CHIP_NAME_LEN
];

465 
bus_id
;

466 
ch_id
;

467 
fœ¡_deviû_id
;

468 
©omic_t
 
İ’_chª_numb”
;

469 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

471 
u32
 
sys_şock
;

473 
»sourû
 *resource;

474 
__iomem
 *
»gs
;

475 
·_»gs
;

476 
»sourû
 *
sync_»sourû
;

477 
__iomem
 *
sync_»gs
;

478 
·_sync_»gs
;

479 
tw5864_š‹¼u±_cÚŒŞ_t
 
tw5864_št_cÚŒŞ
;

481 
¥šlock_t
 
lock
;

482 
tw_h264_logic_’code_chª_t
 *
cu¼_h264_’code_chª
;

483 
vlc_pšg_pÚg_šdex
;

484 (*
»gi¡”_cu¼_h264_’code_chª
)(
dvm_ch_t
 *, 
tw_h264_logic_’code_chª_t
 *);

485 (*
uÄegi¡”_cu¼_h264_’code_chª
)(
dvm_ch_t
 *, 
tw_h264_logic_’code_chª_t
 *);

487 (*
»gi¡”_tim”
)(
dvm_ch_t
 *, 
œq_hªdËr_t
);

488 (*
’abË_tim”
)(
dvm_ch_t
 *);

489 (*
di§bË_tim”
)(
dvm_ch_t
 *);

490 (*
uÄegi¡”_tim”
)(
dvm_ch_t
 *);

492 (*
ch_İ’
)(
dvm_ch_t
 *);

493 (*
ch_şo£
)(
dvm_ch_t
 *);

494 (*
ch_£t_šv®id
)(
dvm_ch_t
 *);

495 (*
ch_£t_v®id
)(
dvm_ch_t
 *);

496 (*
ch_»£t
)(
dvm_ch_t
 *);

497 
ch_io_İ”©iÚ
 *
io_İ
;

498 
ch_pŞlšg_timeid
;

499 (*
add_ch_pŞlšg_sk
)(
dvm_ch_t
 *);

500 (*
d–‘e_ch_pŞlšg_sk
)(
dvm_ch_t
 *);

502 
tw_ch_bus_t
 
tw5864_ch_bus
;

503 
ch_audio_t
 
ch_audio
;

504 
d´am_cÚŒŞ_t
 
ch_d´am_cÚŒŞËr
;

505 
tw5864_vd_üoss_bus_t
 
ch_vd_üoss_bus
;

506 
tw5864_vj_bus_t
 
ch_vj_bus
;

507 
ch_’code_chª_£rviû_queue_t
 
ch_’code_£rviû_queue
;

509 
ch_driv”_t
 *
ch_driv”
;

510 
tw_ch_ai_driv”_t
 *
ch_ai_driv”
;

511 
tw_ch_vi_driv”_t
 *
ch_vi_driv”
;

512 
tw_di¥Ïy_driv”_t
 *
di¥Ïy_driv”
;

514 
tw_audio_driv”_t
 
audio_chª_driv”
[
TW_AUDIO_CHAN_NUMBER
];

515 
tw_h264_logic_’code_chª_t
 
h264_ma¡”_’code_logic_chª
[
TW5864_PHY_VD_CHAN_NUMBER
];

516 
tw_h264_logic_’code_chª_t
 
h264_sub_’code_logic_chª
[
TW5864_PHY_VD_CHAN_NUMBER
];

517 #ifdeà 
MJPEG_MODULE


518 
tw_j³g_logic_’code_chª_t
 
j³g_’code_chª
[
TW5864_PHY_VJ_CHAN_NUMBER
];

520 
tw5864_avSync_dev_t
 
av_avSync_deviû_chª
[
TW5864_PHY_VD_CHAN_NUMBER
];

523 
´oc_dœ_’Œy
 *
´oc_’Œy
;

524 
tw_´oc_»gi¡”_s
 
ch_´oc
, 
h264_´oc
, 
j³g_´oc
, 
audio_´oc
;

527 
	sFPGA_DDR_BURST_REG
{

528 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

529 
u32
 
ddr_İ_ba£_addr
 : 20,

530 
»£rved
 : 4,

531 
ddr_Ën
 : 4,

532 
ddr_»ad_¡©us
 : 1,

533 
ddr_wr™e_¡©us
 : 1,

534 
ddr_»ad
 : 1,

535 
ddr_wr™e
 : 1;

536 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

537 
u32
 
ddr_wr™e
 : 1,

538 
ddr_»ad
 : 1,

539 
ddr_wr™e_¡©us
 : 1,

540 
ddr_»ad_¡©us
 : 1,

541 
ddr_Ën
 : 4,

542 
»£rved
 : 4,

543 
ddr_İ_ba£_addr
 : 20;

548 
FPGA_DDR_BURST_REG
 
»g
;

549 
u32
 
v®ue
;

550 }
	tFPGA_DDR_BURST_CONTROLLER
;

552 
šlše
 
ch_œq_desc
 *
ch_œq_to_desc
(
dvm_ch_t
 *
ch
, 
œq
)

554 
tw5864_š‹¼u±_cÚŒŞ_t
 *
œq_ù¾
;

556 if(
ch
){

557 
œq_ù¾
 = &
ch
->
tw5864_št_cÚŒŞ
;

558  (
œq
 < 
CHIP_IRQS_NR
è? 
œq_ù¾
->
ch_œq_desc
 + irq : 
NULL
;

561  
NULL
;

565 
g‘_tw5864_avSync_deviû
(
tw5864_avSync_dev_t
 **
±r_deviû
, 
šode_id
);

566 
di§bË_tim”_št
();

567 
’abË_tim”_št
();

568 
di§bË_ch_št
(
dvm_ch_t
 *
ch
);

569 
’abË_ch_št
(
dvm_ch_t
 *
ch
);

571 
ch_»que¡_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
, 
œq_hªdËr_t
 
hªdËr
, cÚ¡ *
devÇme
, *
cÚ‹xt
);

572 
ch_ä“_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
, *
cÚ‹xt
);

573 
ch_’abË_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
);

574 
ch_di§bË_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
);

577 
mpb_wr™e
(
dvm_ch_t
 *
ch
, 
u32
 
addr
,u32 
d©a
);

578 
u32
 
mpb_»ad
(
dvm_ch_t
 *
ch
, u32 
addr
);

579 
pci_i2c_»ad
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 *
buf
);

580 
pci_i2c_wr™e
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 
buf
);

581 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_audio_buf.h

1 #iâdef 
TW_AUDIO_BUF_H


2 
	#TW_AUDIO_BUF_H


	)

4 #ifdeà
__ılu¥lus


9 
	#AUDIO_CHAN_BUF_POOL_LEN
 (0x10000)

10 

	)

11 
	#D–T_8K_16BIT_1ms_LEN
 (16)

	)

12 
	#D–T_16K_16BIT_1ms_LEN
 (32)

	)

13 
	#D–T_8K_8BIT_1ms_LEN
 (8)

	)

14 
	#D–T_16K_8BIT_1ms_LEN
 (16)

	)

16 
	stw_audio_chª_buf_poŞ_İ”©iÚ
{

17 (*
ü—‹
)(
tw_audio_chª_buf_poŞ_t
 *, );

18 (*
»Ëa£
)(
tw_audio_chª_buf_poŞ_t
 *);

20 (*
g‘_audio_£ùiÚ_tcb
)(
tw_audio_chª_buf_poŞ_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

21 (*
Œy_g‘_audio_£ùiÚ_tcb
)(
tw_audio_chª_buf_poŞ_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

22 (*
put_audio_£ùiÚ_tcb
)(
tw_audio_chª_buf_poŞ_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 *);

23 (*
g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
)(
tw_audio_chª_buf_poŞ_t
 *);

26 
	stw_audio_chª_buf_poŞ
{

27 
audio_bufãr_’Œy_Üd”
;

28 
u8
 *
audio_bufãr_ÿche
;

30 
u32
 
audio_£ùiÚ_tcb_numb”
;

31 
tcb_node_poŞ_t
 
poŞ_node
;

32 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_£ùiÚ_tcb_ÿche
;

34 
tw_audio_chª_buf_poŞ_İ”©iÚ
 *
İ
;

37 
	stw_audio_·ck‘_£ùiÚ_İ”©iÚ
{

38 (*
š™
)(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
id
);

39 (*
»£t
)(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
);

40 (*
»Ëa£
)(
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

41 (*
»ã»nû
)(
tw_audio_·ck‘_£ùiÚ_t
 *
¤c_audio_·ck‘_£ùiÚ
,w_audio_·ck‘_£ùiÚ_ˆ**
de¡_audio_·ck‘_£ùiÚ
);

42 (*
dma_m­
)(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

43 (*
dma_unm­
)(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

44 
size_t
 (*
subm™
)(
tw_audio_·ck‘_£ùiÚ_t
 *, 
__u£r
 *, size_ˆ, 
loff_t
 *, , 
tw_audio_chª_buf_poŞ_t
 *);

47 
	#to_g‘_tw_audio_·ck‘_£ùiÚ
(
node
è
	`cÚš”_of
Òode, 
tw_audio_·ck‘_£ùiÚ_t
, 
·ck‘_node
)

	)

48 
	stw_audio_·ck‘_£ùiÚ
{

49 
©omic_t
 
»f_couÁ
;

50 
tcb_node_t
 
·ck‘_node
;

51 
¥šlock_t
 
lock
;

53 
id
;

54 
£ùiÚ_size
;

55 
·ylßd_Ën
;

56 
§m¶e_¿‹
;

57 
ty³
;

58 
b™_wide
;

59 
cÚsum”_off£t
;

60 
u32
 
äameS”Ÿl
;

61 
__u32
 
time¡amp
;

62 
tw_audio_desütÜ_t
 
desütÜ
;

64 
u8
 *
d©a
;

65 
dma_addr_t
 
dma_addr
;

67 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
;

68 
tw_audio_·ck‘_£ùiÚ_İ”©iÚ
 *
İ
;

71 
	stw_audio_·ck‘_queue_İ”©iÚ
{

72 (*
g‘
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

73 (*
Œy_g‘
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

74 (*
g‘_”
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

75 (*
Œy_g‘_”
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 **);

76 (*
put
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 *);

77 (*
put_h—d”
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_·ck‘_£ùiÚ_t
 *);

79 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

80 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

81 (*
put_cu¼_´oduûr_što_queue
)(
tw_audio_·ck‘_queue_t
 *);

82 (*
»Ëa£_cu¼_´oduûr
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

83 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_audio_·ck‘_queue_t
 *);

84 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_audio_·ck‘_queue_t
 *);

85 (*
»Ëa£_cu¼_cÚsum”
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

87 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_audio_·ck‘_queue_t
 *);

88 (*
»Ëa£
)(
tw_audio_·ck‘_queue_t
 *, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

89 (*
š™
)(
tw_audio_·ck‘_queue_t
 *);

92 
	stw_audio_·ck‘_queue
{

93 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

94 
tcb_node_queue_t
 
queue_node
;

95 
tw_audio_·ck‘_£ùiÚ_t
 *
cu¼_cÚsum”
;

96 
tw_audio_·ck‘_£ùiÚ_t
 *
cu¼_´oduûr
;

97 
¥šlock_t
 
lock
;

99 
tw_audio_·ck‘_queue_İ”©iÚ
 *
İ
;

103 
š™_tw_audio_·ck‘_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
);

104 
»move_tw_audio_·ck‘_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

105 
š™_audio_chª_buf_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

106 
»move_audio_chª_buf_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
);

108 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_audio_chan_driver.h

1 #iâdef 
TW_AUDIO_CHAN_DRIVER_H


2 
	#TW_AUDIO_CHAN_DRIVER_H


	)

4 #ifdeà
__ılu¥lus


9 
	saudio_£ùiÚ_±r_šfo_İ”©iÚ
{

10 (*
š™
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
);

11 (*
upd©e_h—d”_±r
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
);

12 (*
upd©e_”_±r
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
);

13 (*
queue_ÿ·c™y
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
);

14 (*
upd©e_cu¼_£ùiÚ_off£t
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
);

15 (*
g‘_upd©e_fšish_id
)(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
);

18 
	saudio_£ùiÚ_±r_šfo
{

19 
audio_£ùiÚ_queue_h—d”_±r
;

20 
audio_£ùiÚ_queue_h—d”_±r_ext_æag
;

21 
Ï¡_audio_£ùiÚ_queue_h—d”_±r_ext_æag
;

22 
audio_£ùiÚ_queue_”_±r
;

23 
audio_£ùiÚ_queue_”_±r_ext_æag
;

24 
£ùiÚ_queue_size
;

25 
disÿrd_numb”
;

26 
·ge_id
;

27 
ch_a_Ü_b
;

28 
ddr_’d_addr
;

30 
audio_£ùiÚ_±r_šfo_İ”©iÚ
 *
İ
;

33 
	eaudio_driv”_ty³
{

34 
TW_AUDIO_ENCODE
 = 0,

35 
TW_AUDIO_DECODE


38 
	#to_tw_audio_chª_driv”_w™h_audio_ed
(
node
è
	`cÚš”_of
Òode, 
tw_audio_driv”_t
, 
audio_ed
)

	)

39 
	#to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
node
è
	`cÚš”_of
Òode, 
tw_audio_driv”_t
, 
audio_£ùiÚ_·¿m
)

	)

40 
	stw_audio_chª_driv”
 {

41 
tw_time¡amp_t
 
time¡amp
;

42 
tw_audio_·ck‘_queue_t
 
audio_·ck‘_queue
;

43 
tw_audio_chª_buf_poŞ_t
 
audio_buf_poŞ
;

44 
audio_£ùiÚ_±r_šfo_t
 
audio_£ùiÚ_·¿m
;

46 
©omic_t
 
’abË
;

47 
audio_driv”_ty³
 
ty³
;

48 
ed_tcb_t
 
audio_ed
;

49 
audio_logic_chª_id
;

50 
©omic_t
 
audio_sync_disÿrd_numb”
;

51 
u32
 
i_äame_£rŸl
;

52 
u32
 
disÿrd_numb”
;

53 
©omic_t
 
İ’ed_æag
;

54 
d´am_»que¡_t
 
audio_b™¡»am_»q
;

55 
d´am_·ge_node_t
 *
d´am_·ge
;

56 
ch_audio_t
 *
ch_audio
;

57 
tw5864_avSync_dev_t
 *
tw_deviû_chª
;

60 
»£t_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
);

61 
š™_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
, 
ch_audio_t
 *
ch_audio
, 
bus_id
, 
ch_id
, 
group_chª_id
);

62 
»move_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
);

63 
»£t_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
);

64 
š™_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
, 
ch_audio_t
 *
ch_audio
, 
bus_id
, 
ch_id
, 
group_chª_id
);

65 
»move_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
);

67 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_audio_iop.h

1 #iâdef 
TW_AUDIO_IOP


2 
	#TW_AUDIO_IOP


	)

4 #ifdeà
__ılu¥lus


9 
	#TW_AUDIO_BUF_PAGE_ID
 (14)

	)

10 
	#TW_AUDIO_BUF_OF_DDR_ID
 (
DDR_CHIP_B
)

	)

11 
	#TW_PCM_AUDIO_LEN
 (498)

	)

12 
	#TW_ADPCM_AUDIO_LEN
 (384)

	)

14 
	#TW_AUDIO_IN_CHAN_NUMBER
 (17)

	)

15 
	#TW_AUDIO_OUT_CHAN_NUMBER
 (2)

	)

16 
	#TW_AUDIO_CHAN_NUMBER
 (
TW_AUDIO_IN_CHAN_NUMBER
+
TW_AUDIO_OUT_CHAN_NUMBER
)

	)

18 
	#AUDIO_SECTION_SIZE
 (0x200)

	)

19 
	#AUDIO_OUT_SECTION_VALID_SIZE
 (0x180)

	)

21 
	#INVALID_TW_AUDIO_SECTION_ID
 (-1)

	)

22 
	#AUDIO_IN_PCM_CHAN_SECTION_NUMBER
 (6)

	)

23 
	#AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
 (4)

	)

24 
	#AUDIO_OUT_CHAN_SECTION_NUMBER
 (8)

	)

26 
	#AUDIO_ENABLE
 (0x0001)

	)

27 
	#AUDIO_DISABLE
 (0x0000)

	)

28 
	#AUDIO_MUTE_ENABLE
 (0x0001)

	)

29 
	#AUDIO_MUTE_DISABLE
 (0x0000)

	)

31 
	saudio_´İ”ty_upd©e_İ”©iÚ
 {

32 (*
š™
)(
tw_audio_·¿m_t
 *, 
tw_audio_cÚfig_desütÜ_t
 *);

33 (*
upd©e_§m¶e_¿‹
)(
tw_audio_·¿m_t
 *, );

34 (*
g‘_§m¶e_¿‹
)(
tw_audio_·¿m_t
 *);

35 (*
upd©e_b™_wide
)(
tw_audio_·¿m_t
 *, );

36 (*
g‘_b™_wide
)(
tw_audio_·¿m_t
 *);

37 (*
upd©e_ty³
)(
tw_audio_·¿m_t
 *, );

38 (*
g‘_ty³
)(
tw_audio_·¿m_t
 *);

41 
	saudio_cÚfig_desütÜ
{

42 
ty³
;

43 
§m¶e_¿‹
;

44 
b™_wide
;

45 }
STRUCT_PACKET_ALIGN
(1);

47 
	stw_audio_·¿m
 {

48 
tw_audio_cÚfig_desütÜ_t
 
´İ”ty
;

49 
audio_´İ”ty_upd©e_İ”©iÚ
 *
İ
;

52 
	stw_audio_£ùiÚ_desütÜ_İ”©iÚ
 {

53 (*
š™_audio_desütÜ
)(
tw_audio_desütÜ_t
 *, *);

54 
u32
 (*
g‘_audio_desütÜ_time¡amp
)(
tw_audio_desütÜ_t
 *);

55 (*
£t_audio_desütÜ_time¡amp
)(
tw_audio_desütÜ_t
 *, 
u32
);

56 (*
g‘_audio_desütÜ_§m¶e_¿‹
)(
tw_audio_desütÜ_t
 *);

57 (*
£t_audio_desütÜ_§m¶e_¿‹
)(
tw_audio_desütÜ_t
 *, );

58 (*
g‘_audio_desütÜ_ty³
)(
tw_audio_desütÜ_t
 *);

59 (*
£t_audio_desütÜ_ty³
)(
tw_audio_desütÜ_t
 *, );

60 (*
g‘_audio_desütÜ_b™_wide
)(
tw_audio_desütÜ_t
 *);

61 (*
£t_audio_desütÜ_b™_wide
)(
tw_audio_desütÜ_t
 *, );

62 
u32
 (*
g‘_audio_desütÜ_v®id_Ën
)(
tw_audio_desütÜ_t
 *);

63 (*
£t_audio_desütÜ_v®id_Ën
)(
tw_audio_desütÜ_t
 *, 
u32
);

66 
	saudio_£ùiÚ_desütÜ
 {

67 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

68 
u32
 
time¡amp
:16;

69 
u32
 
§m¶e_¿‹
:2;

70 
u32
 
ty³
:4;

71 
u32
 
b™_wide
:1;

72 
u32
 
v®id_Ën
:9;

73 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

74 
u32
 
v®id_Ën
:9;

75 
u32
 
b™_wide
:1;

76 
u32
 
ty³
:4;

77 
u32
 
§m¶e_¿‹
:2;

78 
u32
 
time¡amp
:16;

82 }
STRUCT_PACKET_ALIGN
(1);

84 
	stw_audio_£ùiÚ_desütÜ
 {

85 
audio_£ùiÚ_desütÜ_t
 *
desütÜ
;

86 
tw_audio_£ùiÚ_desütÜ_İ”©iÚ
 *
İ
;

89 
š™_tw_audio_desütÜ
(
tw_audio_desütÜ_t
 *, *);

90 
š™_audio_’code_´İ”ty
(
tw_audio_·¿m_t
 *, 
tw_audio_cÚfig_desütÜ_t
 *);

91 
š™_audio_decode_´İ”ty
(
tw_audio_·¿m_t
 *, 
tw_audio_cÚfig_desütÜ_t
 *);

93 
	saudio_’abË_cÚŒŞ_»g
 {

94 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

95 
u32
 
	gadpcm_decode_’abË
 : 1;

96 
u32
 
	gpcm_’code_’abË
 : 1;

97 
u32
 
	gadpcm_’code_’abË
 : 1;

98 
u32
 
	g»£rve
 : 29;

99 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

100 
u32
 
	g»£rve
 : 29;

101 
u32
 
	gadpcm_’code_’abË
 : 1;

102 
u32
 
	gpcm_’code_’abË
 : 1;

103 
u32
 
	gadpcm_decode_’abË
 : 1;

107 }
STRUCT_PACKET_ALIGN
(1);

109 
	uaudio_’abË_cÚŒŞ_uniÚ
{

110 
audio_’abË_cÚŒŞ_»g
 
	gb™_v®ue
;

111 
u32
 
	gv®ue
;

112 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_’abË_cÚŒŞ_»g_v®ue
;

114 
	saudio_pcm_’code_cÚŒŞ_»g
 {

115 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

116 
u32
 
	gaudio_chª0_’
 : 1;

117 
u32
 
	gaudio_chª1_’
 : 1;

118 
u32
 
	gaudio_chª2_’
 : 1;

119 
u32
 
	gaudio_chª3_’
 : 1;

120 
u32
 
	gaudio_chª4_’
 : 1;

121 
u32
 
	gaudio_chª5_’
 : 1;

122 
u32
 
	gaudio_chª6_’
 : 1;

123 
u32
 
	gaudio_chª7_’
 : 1;

124 
u32
 
	gaudio_chª8_’
 : 1;

125 
u32
 
	gaudio_chª9_’
 : 1;

126 
u32
 
	gaudio_chª10_’
 : 1;

127 
u32
 
	gaudio_chª11_’
 : 1;

128 
u32
 
	gaudio_chª12_’
 : 1;

129 
u32
 
	gaudio_chª13_’
 : 1;

130 
u32
 
	gaudio_chª14_’
 : 1;

131 
u32
 
	gaudio_chª15_’
 : 1;

132 
u32
 
	g¥—k”_’
 : 1;

133 
u32
 
	gAD_BIT_WIDE
 : 1;

134 
u32
 
	gaudio_ty³
 : 4;

135 
u32
 
	gaudio_§m¶e_¿‹
 : 2;

136 
u32
 
	gaudio_loİback_chª_id
 : 5;

137 
u32
 
	gaudio_loİback_’abË
 : 1;

138 
u32
 
	gaudio_ad_loİ
 : 1;

139 
u32
 
	g¬m_mode_Ü_pci_mod
 : 1;

140 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

141 
u32
 
	g¬m_mode_Ü_pci_mod
 : 1;

142 
u32
 
	gaudio_ad_loİ
 : 1;

143 
u32
 
	gaudio_loİback_’abË
 : 1;

144 
u32
 
	gaudio_loİback_chª_id
 : 5;

145 
u32
 
	gaudio_§m¶e_¿‹
 : 2;

146 
u32
 
	gaudio_ty³
 : 4;

147 
u32
 
	gAD_BIT_WIDE
 : 1;

148 
u32
 
	g¥—k”_’
 : 1;

149 
u32
 
	gaudio_chª15_’
 : 1;

150 
u32
 
	gaudio_chª14_’
 : 1;

151 
u32
 
	gaudio_chª13_’
 : 1;

152 
u32
 
	gaudio_chª12_’
 : 1;

153 
u32
 
	gaudio_chª11_’
 : 1;

154 
u32
 
	gaudio_chª10_’
 : 1;

155 
u32
 
	gaudio_chª9_’
 : 1;

156 
u32
 
	gaudio_chª8_’
 : 1;

157 
u32
 
	gaudio_chª7_’
 : 1;

158 
u32
 
	gaudio_chª6_’
 : 1;

159 
u32
 
	gaudio_chª5_’
 : 1;

160 
u32
 
	gaudio_chª4_’
 : 1;

161 
u32
 
	gaudio_chª3_’
 : 1;

162 
u32
 
	gaudio_chª2_’
 : 1;

163 
u32
 
	gaudio_chª1_’
 : 1;

164 
u32
 
	gaudio_chª0_’
 : 1;

168 }
STRUCT_PACKET_ALIGN
(1);

171 
audio_pcm_’code_cÚŒŞ_»g
 
	gb™_v®ue
;

172 
u32
 
	gv®ue
;

173 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_pcm_’code_cÚŒŞ_»g_v®ue
;

175 
	saudio_adpcm_’code_cÚŒŞ_»g
 {

176 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

177 
u32
 
	gaudio_chª0_’
 : 1;

178 
u32
 
	gaudio_chª1_’
 : 1;

179 
u32
 
	gaudio_chª2_’
 : 1;

180 
u32
 
	gaudio_chª3_’
 : 1;

181 
u32
 
	gaudio_chª4_’
 : 1;

182 
u32
 
	gaudio_chª5_’
 : 1;

183 
u32
 
	gaudio_chª6_’
 : 1;

184 
u32
 
	gaudio_chª7_’
 : 1;

185 
u32
 
	gaudio_chª8_’
 : 1;

186 
u32
 
	gaudio_chª9_’
 : 1;

187 
u32
 
	gaudio_chª10_’
 : 1;

188 
u32
 
	gaudio_chª11_’
 : 1;

189 
u32
 
	gaudio_chª12_’
 : 1;

190 
u32
 
	gaudio_chª13_’
 : 1;

191 
u32
 
	gaudio_chª14_’
 : 1;

192 
u32
 
	gaudio_chª15_’
 : 1;

193 
u32
 
	g¥—k”_’
 : 1;

194 
u32
 
	g»£rve
 : 15;

195 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

196 
u32
 
	g»£rve
 : 15;

197 
u32
 
	g¥—k”_’
 : 1;

198 
u32
 
	gaudio_chª15_’
 : 1;

199 
u32
 
	gaudio_chª14_’
 : 1;

200 
u32
 
	gaudio_chª13_’
 : 1;

201 
u32
 
	gaudio_chª12_’
 : 1;

202 
u32
 
	gaudio_chª11_’
 : 1;

203 
u32
 
	gaudio_chª10_’
 : 1;

204 
u32
 
	gaudio_chª9_’
 : 1;

205 
u32
 
	gaudio_chª8_’
 : 1;

206 
u32
 
	gaudio_chª7_’
 : 1;

207 
u32
 
	gaudio_chª6_’
 : 1;

208 
u32
 
	gaudio_chª5_’
 : 1;

209 
u32
 
	gaudio_chª4_’
 : 1;

210 
u32
 
	gaudio_chª3_’
 : 1;

211 
u32
 
	gaudio_chª2_’
 : 1;

212 
u32
 
	gaudio_chª1_’
 : 1;

213 
u32
 
	gaudio_chª0_’
 : 1;

217 }
STRUCT_PACKET_ALIGN
(1);

220 
audio_adpcm_’code_cÚŒŞ_»g
 
	gb™_v®ue
;

221 
u32
 
	gv®ue
;

222 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_adpcm_’code_cÚŒŞ_»g_v®ue
;

224 
	saduio_decode_cÚŒŞ_»g
 {

225 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

226 
u32
 
	gaudio_out_chª0_mu‹
 : 1;

227 
u32
 
	gaudio_out_chª0_DA_BIT_WIDE
 : 1;

228 
u32
 
	gaudio_out_chª1_mu‹
 : 1;

229 
u32
 
	gaudio_out_chª1_DA_BIT_WIDE
 : 1;

230 
u32
 
	gaudio_out_chª0_’abË
 : 1;

231 
u32
 
	gaudio_out_chª1_’abË
 : 1;

232 
u32
 
	g»£rve
 : 26;

233 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

234 
u32
 
	g»£rve
 : 26;

235 
u32
 
	gaudio_out_chª1_’abË
 : 1;

236 
u32
 
	gaudio_out_chª0_’abË
 : 1;

237 
u32
 
	gaudio_out_chª1_DA_BIT_WIDE
 : 1;

238 
u32
 
	gaudio_out_chª1_mu‹
 : 1;

239 
u32
 
	gaudio_out_chª0_DA_BIT_WIDE
 : 1;

240 
u32
 
	gaudio_out_chª0_mu‹
 : 1;

244 }
STRUCT_PACKET_ALIGN
(1);

247 
aduio_decode_cÚŒŞ_»g
 
	gb™_v®ue
;

248 
u32
 
	gv®ue
;

249 }
	tSTRUCT_PACKET_ALIGN
(1è
	taduio_decode_cÚŒŞ_»g_v®ue
;

251 
	saudio_adpcm_’code_±r_ch0_ch9_»g
 {

252 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

253 
u32
 
	gaudio_chª0_±r
 : 3;

254 
u32
 
	gaudio_chª1_±r
 : 3;

255 
u32
 
	gaudio_chª2_±r
 : 3;

256 
u32
 
	gaudio_chª3_±r
 : 3;

257 
u32
 
	gaudio_chª4_±r
 : 3;

258 
u32
 
	gaudio_chª5_±r
 : 3;

259 
u32
 
	gaudio_chª6_±r
 : 3;

260 
u32
 
	gaudio_chª7_±r
 : 3;

261 
u32
 
	gaudio_chª8_±r
 : 3;

262 
u32
 
	gaudio_chª9_±r
 : 3;

263 
u32
 
	g»£rve
 : 2;

264 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

265 
u32
 
	g»£rve
 : 2;

266 
u32
 
	gaudio_chª9_±r
 : 3;

267 
u32
 
	gaudio_chª8_±r
 : 3;

268 
u32
 
	gaudio_chª7_±r
 : 3;

269 
u32
 
	gaudio_chª6_±r
 : 3;

270 
u32
 
	gaudio_chª5_±r
 : 3;

271 
u32
 
	gaudio_chª4_±r
 : 3;

272 
u32
 
	gaudio_chª3_±r
 : 3;

273 
u32
 
	gaudio_chª2_±r
 : 3;

274 
u32
 
	gaudio_chª1_±r
 : 3;

275 
u32
 
	gaudio_chª0_±r
 : 3;

279 }
STRUCT_PACKET_ALIGN
(1);

282 
audio_adpcm_’code_±r_ch0_ch9_»g
 
	gb™_v®ue
;

283 
u32
 
	gv®ue
;

284 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_adpcm_’code_±r_ch0_ch9_»g_v®ue
;

286 
	saudio_adpcm_’code_±r_ch10_ch16_»g
 {

287 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

288 
u32
 
	gaudio_chª10_±r
 : 3;

289 
u32
 
	gaudio_chª11_±r
 : 3;

290 
u32
 
	gaudio_chª12_±r
 : 3;

291 
u32
 
	gaudio_chª13_±r
 : 3;

292 
u32
 
	gaudio_chª14_±r
 : 3;

293 
u32
 
	gaudio_chª15_±r
 : 3;

294 
u32
 
	gaudio_chª16_±r
 : 3;

295 
u32
 
	g»£rve
 : 11;

296 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

297 
u32
 
	g»£rve
 : 11;

298 
u32
 
	gaudio_chª16_±r
 : 3;

299 
u32
 
	gaudio_chª15_±r
 : 3;

300 
u32
 
	gaudio_chª14_±r
 : 3;

301 
u32
 
	gaudio_chª13_±r
 : 3;

302 
u32
 
	gaudio_chª12_±r
 : 3;

303 
u32
 
	gaudio_chª11_±r
 : 3;

304 
u32
 
	gaudio_chª10_±r
 : 3;

308 }
STRUCT_PACKET_ALIGN
(1);

311 
audio_adpcm_’code_±r_ch10_ch16_»g
 
	gb™_v®ue
;

312 
u32
 
	gv®ue
;

313 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_adpcm_’code_±r_ch10_ch16_»g_v®ue
;

315 
	saudio_decode_wr_rd_±r_»g
 {

316 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

317 
u32
 
	gchª0_rd_±r
 : 4;

318 
u32
 
	gchª1_rd_±r
 : 4;

319 
u32
 
	gchª0_wr_±r
 : 4;

320 
u32
 
	gchª1_wr_±r
 : 4;

321 
u32
 
	g»£rve
 : 16;

322 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

323 
u32
 
	g»£rve
 : 16;

324 
u32
 
	gchª1_wr_±r
 : 4;

325 
u32
 
	gchª0_wr_±r
 : 4;

326 
u32
 
	gchª1_rd_±r
 : 4;

327 
u32
 
	gchª0_rd_±r
 : 4;

331 }
STRUCT_PACKET_ALIGN
(1);

334 
audio_decode_wr_rd_±r_»g
 
	gb™_v®ue
;

335 
u32
 
	gv®ue
;

336 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_decode_wr_rd_±r_»g_v®ue
;

338 
	saudio_pcm_’code_±r_ch0_ch7_»g
 {

339 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

340 
u32
 
	gaudio_chª0_±r
 : 4;

341 
u32
 
	gaudio_chª1_±r
 : 4;

342 
u32
 
	gaudio_chª2_±r
 : 4;

343 
u32
 
	gaudio_chª3_±r
 : 4;

344 
u32
 
	gaudio_chª4_±r
 : 4;

345 
u32
 
	gaudio_chª5_±r
 : 4;

346 
u32
 
	gaudio_chª6_±r
 : 4;

347 
u32
 
	gaudio_chª7_±r
 : 4;

348 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

349 
u32
 
	gaudio_chª7_±r
 : 4;

350 
u32
 
	gaudio_chª6_±r
 : 4;

351 
u32
 
	gaudio_chª5_±r
 : 4;

352 
u32
 
	gaudio_chª4_±r
 : 4;

353 
u32
 
	gaudio_chª3_±r
 : 4;

354 
u32
 
	gaudio_chª2_±r
 : 4;

355 
u32
 
	gaudio_chª1_±r
 : 4;

356 
u32
 
	gaudio_chª0_±r
 : 4;

360 }
STRUCT_PACKET_ALIGN
(1);

363 
audio_pcm_’code_±r_ch0_ch7_»g
 
	gb™_v®ue
;

364 
u32
 
	gv®ue
;

365 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_pcm_’code_±r_ch0_ch7_»g_v®ue
;

367 
	saudio_pcm_’code_±r_ch8_ch15_»g
 {

368 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

369 
u32
 
	gaudio_chª08_±r
 : 4;

370 
u32
 
	gaudio_chª09_±r
 : 4;

371 
u32
 
	gaudio_chª10_±r
 : 4;

372 
u32
 
	gaudio_chª11_±r
 : 4;

373 
u32
 
	gaudio_chª12_±r
 : 4;

374 
u32
 
	gaudio_chª13_±r
 : 4;

375 
u32
 
	gaudio_chª14_±r
 : 4;

376 
u32
 
	gaudio_chª15_±r
 : 4;

377 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

378 
u32
 
	gaudio_chª15_±r
 : 4;

379 
u32
 
	gaudio_chª14_±r
 : 4;

380 
u32
 
	gaudio_chª13_±r
 : 4;

381 
u32
 
	gaudio_chª12_±r
 : 4;

382 
u32
 
	gaudio_chª11_±r
 : 4;

383 
u32
 
	gaudio_chª10_±r
 : 4;

384 
u32
 
	gaudio_chª09_±r
 : 4;

385 
u32
 
	gaudio_chª08_±r
 : 4;

389 }
STRUCT_PACKET_ALIGN
(1);

392 
audio_pcm_’code_±r_ch8_ch15_»g
 
	gb™_v®ue
;

393 
u32
 
	gv®ue
;

394 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_pcm_’code_±r_ch8_ch15_»g_v®ue
;

396 
	saudio_pcm_’code_±r_ch16_»g
 {

397 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

398 
u32
 
	gaudio_chª16_±r
 : 4;

399 
u32
 
	g»£rve
 : 28;

400 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

401 
u32
 
	g»£rve
 : 28;

402 
u32
 
	gaudio_chª16_±r
 : 4;

406 }
STRUCT_PACKET_ALIGN
(1);

409 
audio_pcm_’code_±r_ch16_»g
 
	gb™_v®ue
;

410 
u32
 
	gv®ue
;

411 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_pcm_’code_±r_ch16_»g_v®ue
;

413 
	saudio_’abË_cÚŒŞ_İ”©iÚ
 {

414 (*
	gg‘_adpcm_decode_¡©e
)(
	gaudio_’abË_cÚŒŞ_t
 *);

415 (*
	gupd©e_’abË_adpcm_decode
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
);

416 (*
	g£t_’abË_adpcm_decode
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
, 
	gdvm_ch_t
 *);

418 (*
	gg‘_pcm_’code_¡©e
)(
	gaudio_’abË_cÚŒŞ_t
 *);

419 (*
	gupd©e_’abË_pcm_’code
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
);

420 (*
	g£t_’abË_pcm_’code
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
, 
	gdvm_ch_t
 *);

422 (*
	gg‘_adpcm_’code_¡©e
)(
	gaudio_’abË_cÚŒŞ_t
 *);

423 (*
	gupd©e_’abË_adpcm_’code
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
);

424 (*
	g£t_’abË_adpcm_’code
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	g’
, 
	gdvm_ch_t
 *);

426 (*
	gš™
)(
	gaudio_’abË_cÚŒŞ_t
 *);

427 (*
	gg‘_’abË_cÚŒŞ_·¿m
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

428 (*
	g£t_’abË_cÚŒŞ_·¿m
)(
	gaudio_’abË_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

431 
	saudio_’abË_cÚŒŞ
 {

432 
audio_’abË_cÚŒŞ_»g_v®ue
 
	gv®ue
;

433 
u32
 
	g»g_off£t
;

434 
audio_’abË_cÚŒŞ_İ”©iÚ
 *
	gİ
;

437 
	saudio_pcm_’code_wr_rd_±r_İ”©iÚ
 {

438 (*
	gš™
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *);

439 (*
	gg‘_pcm_wr_rd_±r
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

441 (*
	gg‘_chª_wr_±r
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *, , *);

442 (*
	gg‘_chª_rd_±r
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *, , *);

443 (*
	gg‘_chª_£ùiÚ_numb”
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *);

445 (*
	g£t_rd_fšish_numb”
)(
	gaudio_pcm_’code_±r_cÚŒŞ_t
 *, , 
	gdvm_ch_t
 *);

448 
	saudio_pcm_’code_±r_cÚŒŞ
 {

449 
audio_pcm_’code_±r_ch0_ch7_»g_v®ue
 
	gch0_ch7_wr_±r_v®ue
;

450 
u32
 
	gch0_ch7_wr_±r_»g_off£t
;

451 
audio_pcm_’code_±r_ch8_ch15_»g_v®ue
 
	gch8_ch15_wr_±r_v®ue
;

452 
u32
 
	gch8_ch15_wr_±r_»g_off£t
;

453 
audio_pcm_’code_±r_ch16_»g_v®ue
 
	gch16_wr_±r_v®ue
;

454 
u32
 
	gch16_wr_±r_»g_off£t
;

456 
audio_pcm_’code_±r_ch0_ch7_»g_v®ue
 
	gch0_ch7_rd_±r_v®ue
;

457 
u32
 
	gch0_ch7_rd_±r_»g_off£t
;

458 
audio_pcm_’code_±r_ch8_ch15_»g_v®ue
 
	gch8_ch15_rd_±r_v®ue
;

459 
u32
 
	gch8_ch15_rd_±r_»g_off£t
;

460 
audio_pcm_’code_±r_ch16_»g_v®ue
 
	gch16_rd_±r_v®ue
;

461 
u32
 
	gch16_rd_±r_»g_off£t
;

463 
u32
 
	grd_fšish_numb”_»g_off£t
;

465 
	g£ùiÚ_numb”
;

467 
audio_pcm_’code_wr_rd_±r_İ”©iÚ
 *
	gİ
;

470 
	#ADUIO_DATA_ADDR_PCM_ENCODE_TYPE
 (0x00)

	)

471 
	saudio_pcm_’code_d©a_addr_»g
 {

472 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

473 
u32
 
	g£ùiÚ_off£t
 : 7;

474 
u32
 
	g£ùiÚ_id
 : 3;

475 
u32
 
	gchª_id
 : 5;

476 
u32
 
	gpcm_ty³
 : 1;

477 
u32
 
	g»£rve
 : 16;

478 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

479 
u32
 
	g»£rve
 : 16;

480 
u32
 
	gpcm_ty³
 : 1;

481 
u32
 
	gchª_id
 : 5;

482 
u32
 
	g£ùiÚ_id
 : 3;

483 
u32
 
	g£ùiÚ_off£t
 : 7;

487 }
STRUCT_PACKET_ALIGN
(1);

490 
audio_pcm_’code_d©a_addr_»g
 
	gb™_v®ue
;

491 
u32
 
	gv®ue
;

492 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_pcm_’code_d©a_addr_»g_v®ue
;

494 
	saudio_pcm_’code_d©a_addr_İ”©iÚ
{

495 (*
	g£t_»g_b™_£ùiÚ_off£t
)(
	gaudio_pcm_’code_d©a_addr_t
 *, 
	gu32
 );

496 
u32
 (*
g‘_»g_b™_£ùiÚ_off£t
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

498 (*
	g£t_»g_b™_£ùiÚ_id
)(
	gaudio_pcm_’code_d©a_addr_t
 *, 
	gu32
 );

499 
u32
 (*
g‘_»g_b™_£ùiÚ_id
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

501 (*
	g£t_»g_b™_chª_id
)(
	gaudio_pcm_’code_d©a_addr_t
 *, 
	gu32
 );

502 
u32
 (*
g‘_»g_b™_chª_id
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

504 (*
	g£t_»g_b™_pcm_ty³
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

505 
u32
 (*
g‘_»g_b™_pcm_ty³
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

507 
u32
 (*
g‘_pcm_’code_d©a_addr
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

508 (*
	gg‘_buf_·ge_id
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

509 (*
	gg‘_buf_š_ch_a_Ü_b
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

510 
u32
 (*
g‘_pcm_’code_d©a_addr_š_ho¡_’d_off£t
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

511 
u32
 (*
g‘_pcm_’code_d©a_addr_š_ddr_’d_off£t
)(
	gaudio_pcm_’code_d©a_addr_t
 *);

512 (*
	gš™
)(
	gaudio_pcm_’code_d©a_addr_t
 *, , );

515 
	saudio_pcm_’code_d©a_addr
 {

516 
	gbuf_·ge_id
, 
	gch_a_Ü_b
;

517 
audio_pcm_’code_d©a_addr_»g_v®ue
 
	gv®ue
;

518 
audio_pcm_’code_d©a_addr_İ”©iÚ
 *
	gİ
;

521 
	saudio_adpcm_’code_wr_rd_±r_İ”©iÚ
 {

522 (*
	gš™
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *);

523 (*
	gg‘_adpcm_wr_rd_±r
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

525 (*
	gg‘_chª_wr_±r
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *, , *);

526 (*
	gg‘_chª_rd_±r
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *, , *);

527 (*
	gg‘_chª_£ùiÚ_numb”
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *);

529 (*
	g£t_rd_fšish_numb”
)(
	gaudio_adpcm_’code_±r_cÚŒŞ_t
 *, , 
	gdvm_ch_t
 *);

532 
	saudio_adpcm_’code_±r_cÚŒŞ
 {

533 
audio_adpcm_’code_±r_ch0_ch9_»g_v®ue
 
	gch0_ch9_wr_±r_v®ue
;

534 
u32
 
	gch0_ch9_wr_±r_»g_off£t
;

535 
audio_adpcm_’code_±r_ch10_ch16_»g_v®ue
 
	gch10_ch16_wr_±r_v®ue
;

536 
u32
 
	gch10_ch16_wr_±r_»g_off£t
;

538 
audio_adpcm_’code_±r_ch0_ch9_»g_v®ue
 
	gch0_ch9_rd_±r_v®ue
;

539 
u32
 
	gch0_ch9_rd_±r_»g_off£t
;

540 
audio_adpcm_’code_±r_ch10_ch16_»g_v®ue
 
	gch10_ch16_rd_±r_v®ue
;

541 
u32
 
	gch10_ch16_rd_±r_»g_off£t
;

543 
u32
 
	grd_fšish_numb”_»g_off£t
;

544 
	g£ùiÚ_numb”
;

546 
audio_adpcm_’code_wr_rd_±r_İ”©iÚ
 *
	gİ
;

549 
	#ADUIO_DATA_ADDR_ADPCM_ENCODE_TYPE
 (0x02)

	)

550 
	saudio_adpcm_’code_d©a_addr_»g
 {

551 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

552 
u32
 
	g£ùiÚ_off£t
 : 7;

553 
u32
 
	g£ùiÚ_id
 : 2;

554 
u32
 
	gchª_id
 : 5;

555 
u32
 
	gadpcm_’code_ty³
 : 2;

556 
u32
 
	g»£rve
 : 16;

557 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

558 
u32
 
	g»£rve
 : 16;

559 
u32
 
	gadpcm_’code_ty³
 : 2;

560 
u32
 
	gchª_id
 : 5;

561 
u32
 
	g£ùiÚ_id
 : 2;

562 
u32
 
	g£ùiÚ_off£t
 : 7;

566 }
STRUCT_PACKET_ALIGN
(1);

569 
audio_adpcm_’code_d©a_addr_»g
 
	gb™_v®ue
;

570 
u32
 
	gv®ue
;

571 }
	taudio_adpcm_’code_d©a_addr_»g_v®ue
;

573 
	saudio_adpcm_’code_d©a_addr_İ”©iÚ
 {

574 (*
	g£t_»g_b™_£ùiÚ_off£t
)(
	gaudio_adpcm_’code_d©a_addr_t
 *, 
	gu32
 );

575 
u32
 (*
g‘_»g_b™_£ùiÚ_off£t
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

577 (*
	g£t_»g_b™_£ùiÚ_id
)(
	gaudio_adpcm_’code_d©a_addr_t
 *, 
	gu32
 );

578 
u32
 (*
g‘_»g_b™_£ùiÚ_id
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

580 (*
	g£t_»g_b™_chª_id
)(
	gaudio_adpcm_’code_d©a_addr_t
 *, 
	gu32
 );

581 
u32
 (*
g‘_»g_b™_chª_id
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

583 (*
	g£t_»g_b™_adpcm_ty³
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

584 
u32
 (*
g‘_»g_b™_adpcm_ty³
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

586 
u32
 (*
g‘_adpcm_’code_d©a_addr
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

587 (*
	gg‘_buf_·ge_id
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

588 (*
	gg‘_buf_š_ch_a_Ü_b
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

589 
u32
 (*
g‘_adpcm_’code_d©a_addr_š_ho¡_’d_off£t
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

590 
u32
 (*
g‘_adpcm_’code_d©a_addr_š_ddr_’d_off£t
)(
	gaudio_adpcm_’code_d©a_addr_t
 *);

591 (*
	gš™
)(
	gaudio_adpcm_’code_d©a_addr_t
 *, , );

594 
	saudio_adpcm_’code_d©a_addr
 {

595 
	gbuf_·ge_id
, 
	gch_a_Ü_b
;

596 
audio_adpcm_’code_d©a_addr_»g_v®ue
 
	gv®ue
;

597 
audio_adpcm_’code_d©a_addr_İ”©iÚ
 *
	gİ
;

600 
	saudio_’code_cÚŒŞ_İ”©iÚ
 {

601 (*
	g’abË_pcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, );

602 (*
	gdi§bË_pcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, );

603 (*
	g£t_’abË_pcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, , , 
	gdvm_ch_t
 *);

604 (*
	gg‘_pcm_chª_¡©e
)(
	gaudio_’code_cÚŒŞ_t
 *, );

605 (*
	gš™_audio_pcm
)(
	gaudio_’code_cÚŒŞ_t
 *);

607 (*
	g’abË_adpcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, );

608 (*
	gdi§bË_adpcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, );

609 (*
	g£t_’abË_adpcm_chª
)(
	gaudio_’code_cÚŒŞ_t
 *, , , 
	gdvm_ch_t
 *);

610 (*
	gg‘_adpcm_chª_¡©e
)(
	gaudio_’code_cÚŒŞ_t
 *, );

611 (*
	gš™_audio_adpcm
)(
	gaudio_’code_cÚŒŞ_t
 *);

613 (*
	gupd©e_audio_§m¶e_¿‹
)(
	gaudio_’code_cÚŒŞ_t
 *, );

614 (*
	gg‘_audio_§m¶e_¿‹
)(
	gaudio_’code_cÚŒŞ_t
 *);

615 (*
	g£t_audio_§m¶e_¿‹
)(
	gaudio_’code_cÚŒŞ_t
 *, , 
	gdvm_ch_t
 *);

617 (*
	gupd©e_audio_ty³
)(
	gaudio_’code_cÚŒŞ_t
 *, );

618 (*
	gg‘_audio_ty³
)(
	gaudio_’code_cÚŒŞ_t
 *);

619 (*
	g£t_audio_ty³
)(
	gaudio_’code_cÚŒŞ_t
 *, , 
	gdvm_ch_t
 *);

621 (*
	gupd©e_b™_wide
)(
	gaudio_’code_cÚŒŞ_t
 *, );

622 (*
	gg‘_b™_wide
)(
	gaudio_’code_cÚŒŞ_t
 *);

623 (*
	g£t_b™_wide
)(
	gaudio_’code_cÚŒŞ_t
 *, , 
	gdvm_ch_t
 *);

625 (*
	g£t_audio_·¿m
)(
	gaudio_’code_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

626 (*
	gg‘_audio_·¿m
)(
	gaudio_’code_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

629 
	saudio_’code_cÚŒŞ
 {

630 
audio_pcm_’code_cÚŒŞ_»g_v®ue
 
	gpcm_v®ue
;

631 
u32
 
	gpcm_»g_off£t
;

632 
audio_adpcm_’code_cÚŒŞ_»g_v®ue
 
	gadpcm_v®ue
;

633 
u32
 
	gadpcm_»g_off£t
;

635 
audio_’code_cÚŒŞ_İ”©iÚ
 *
	gİ
;

638 
	sch_audio_’code_İ”©iÚ
 {

639 (*
	gš™
)(
ch_audio_’code_t
 *
	gaudio_’code
);

641 (*
	g£t_’abË_audio_’code_chª
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gchª_id
, 
	g’abË
, 
dvm_ch_t
 *
	gch
);

642 (*
	gupd©e_’abË_audio_’code_chª
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gchª_id
, 
	g’abË
);

643 (*
	gg‘_audio_’code_chª_’abË_¡©e
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gchª_id
);

645 (*
	gg‘_audio_’code_chª_rd_±r
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gchª_id
, *
	gext_æag
, *
	gqueue_size
);

646 (*
	gg‘_audio_’code_chª_wr_±r
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gchª_id
, *
	gext_æag
, *
	gqueue_size
);

648 (*
	gg‘_audio_’code_·¿m
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
dvm_ch_t
 *
	gch
);

649 (*
	g£t_audio_’code_·¿m
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
dvm_ch_t
 *
	gch
);

650 (*
	g£t_fšish_rd_±r
)(
ch_audio_’code_t
 *
	gaudio_’code
, 
	gfšish_rd_±r
, 
dvm_ch_t
 *
	gch
);

653 
	#to_g‘_ch_audio_’code_w™h_´İ”ty
(
node
è
	`cÚš”_of
Òode, 
ch_audio_’code_t
, 
cÚfig_·¿m
)

	)

654 
	sch_audio_’code
 {

655 
tw_audio_·¿m_t
 
	gcÚfig_·¿m
;

656 
audio_’code_cÚŒŞ_t
 
	gaudio_cÚŒŞ
;

657 
audio_pcm_’code_±r_cÚŒŞ_t
 
	gpcm_audio_±r
;

658 
audio_pcm_’code_d©a_addr_t
 
	gpcm_audio_d©a_ba£
;

659 
audio_adpcm_’code_±r_cÚŒŞ_t
 
	gadpcm_audio_±r
;

660 
audio_adpcm_’code_d©a_addr_t
 
	gadpcm_audio_d©a_ba£
;

662 
ch_audio_’code_İ”©iÚ
 *
	gİ
;

665 
	saudio_decode_cÚŒŞ_İ”©iÚ
 {

666 (*
	gš™
)(
	gaudio_decode_cÚŒŞ_t
 *);

668 (*
	gupd©e_decode_chª_mu‹
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	gmu‹
);

669 (*
	gg‘_decode_chª_mu‹
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
);

670 (*
	g£t_decode_chª_mu‹
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	gmu‹
, 
dvm_ch_t
 *
	gch
);

672 (*
	gupd©e_decode_chª_b™_wide
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	gb™_wide
);

673 (*
	gg‘_decode_chª_b™_wide
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
);

674 (*
	g£t_decode_chª_b™_wide
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	gb™_wide
, 
dvm_ch_t
 *
	gch
);

676 (*
	gupd©e_decode_chª_’abË
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	g’abË
);

677 (*
	gg‘_decode_chª_’abË
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
);

678 (*
	g£t_decode_chª_’abË
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
	gchª_id
, 
	g’abË
, 
dvm_ch_t
 *
	gch
);

680 (*
	g£t_decode_·¿m
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
dvm_ch_t
 *
	gch
);

681 (*
	gg‘_decode_·¿m
)(
audio_decode_cÚŒŞ_t
 *
	gdecode_cÚŒŞ
, 
dvm_ch_t
 *
	gch
);

684 
	saudio_decode_cÚŒŞ
 {

685 
aduio_decode_cÚŒŞ_»g_v®ue
 
	gv®ue
;

686 
u32
 
	g»g_off£t
;

687 
audio_decode_cÚŒŞ_İ”©iÚ
 *
	gİ
;

690 
	saudio_decode_±r_cÚŒŞ_İ”©iÚ
 {

691 (*
	gš™
)(
	gaudio_decode_±r_cÚŒŞ_t
 *);

692 (*
	gg‘_adpcm_wr_rd_±r
)(
	gaudio_decode_±r_cÚŒŞ_t
 *, 
	gdvm_ch_t
 *);

694 (*
	gg‘_chª_wr_±r
)(
	gaudio_decode_±r_cÚŒŞ_t
 *, , *);

695 (*
	gg‘_chª_rd_±r
)(
	gaudio_decode_±r_cÚŒŞ_t
 *, , *);

696 (*
	gg‘_chª_£ùiÚ_numb”
)(
	gaudio_decode_±r_cÚŒŞ_t
 *);

697 (*
	g£t_fšish_wr_±r
)(
	gaudio_decode_±r_cÚŒŞ_t
 *, 
	gfšish_id
, 
dvm_ch_t
 *
	gch
, 
	gchª_id
);

700 
	saudio_decode_±r_cÚŒŞ
 {

701 
audio_decode_wr_rd_±r_»g_v®ue
 
	gwr_rd_v®ue
;

702 
u32
 
	gwr_rd_»g_off£t
;

703 
	g£ùiÚ_numb”
;

705 
audio_decode_±r_cÚŒŞ_İ”©iÚ
 *
	gİ
;

708 
	#AUDIO_DATA_ADDR_ADPCM_DECODE_TYPE
 (0x18)

	)

709 
	saudio_decode_d©a_addr_»g
 {

710 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

711 
u32
 
	g£ùiÚ_off£t
 : 7;

712 
u32
 
	g£ùiÚ_id
 : 3;

713 
u32
 
	gchª_id
 : 1;

714 
u32
 
	gdecode_ty³
 : 5;

715 
u32
 
	g»£rve
 : 16;

716 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

717 
u32
 
	g»£rve
 : 16;

718 
u32
 
	gdecode_ty³
 : 5;

719 
u32
 
	gchª_id
 : 1;

720 
u32
 
	g£ùiÚ_id
 : 3;

721 
u32
 
	g£ùiÚ_off£t
 : 7;

725 }
STRUCT_PACKET_ALIGN
(1);

728 
audio_decode_d©a_addr_»g
 
	gb™_v®ue
;

729 
u32
 
	gv®ue
;

730 }
	tSTRUCT_PACKET_ALIGN
(1è
	taudio_decode_d©a_addr_»g_v®ue
;

732 
	saudio_decode_d©a_addr_İ”©iÚ
 {

733 (*
	g£t_»g_b™_£ùiÚ_off£t
)(
	gaudio_decode_d©a_addr_t
 *, 
	gu32
 );

734 
u32
 (*
g‘_»g_b™_£ùiÚ_off£t
)(
	gaudio_decode_d©a_addr_t
 *);

735 (*
	g£t_»g_b™_£ùiÚ_id
)(
	gaudio_decode_d©a_addr_t
 *, 
	gu32
 );

736 
u32
 (*
g‘_»g_b™_£ùiÚ_id
)(
	gaudio_decode_d©a_addr_t
 *);

737 (*
	g£t_»g_b™_chª_id
)(
	gaudio_decode_d©a_addr_t
 *, 
	gu32
 );

738 
u32
 (*
g‘_»g_b™_chª_id
)(
	gaudio_decode_d©a_addr_t
 *);

739 (*
	g£t_»g_b™_decode_ty³
)(
	gaudio_decode_d©a_addr_t
 *);

740 
u32
 (*
g‘_»g_b™_decode_ty³
)(
	gaudio_decode_d©a_addr_t
 *);

741 
u32
 (*
g‘_decode_d©a_addr
)(
	gaudio_decode_d©a_addr_t
 *);

742 (*
	gg‘_buf_·ge_id
)(
	gaudio_decode_d©a_addr_t
 *);

743 (*
	gg‘_buf_š_ch_a_Ü_b
)(
	gaudio_decode_d©a_addr_t
 *);

744 
u32
 (*
g‘_adpcm_decode_d©a_addr_š_ho¡_’d_off£t
)(
	gaudio_decode_d©a_addr_t
 *);

745 
u32
 (*
g‘_adpcm_decode_d©a_addr_š_ddr_’d_off£t
)(
	gaudio_decode_d©a_addr_t
 *);

746 (*
	gš™
)(
	gaudio_decode_d©a_addr_t
 *);

749 
	saudio_decode_d©a_addr
 {

750 
	gbuf_·ge_id
, 
	gch_a_Ü_b
;

751 
audio_decode_d©a_addr_»g_v®ue
 
	gv®ue
;

752 
audio_decode_d©a_addr_İ”©iÚ
 *
	gİ
;

755 
	sch_audio_decode_İ”©iÚ
 {

756 (*
	gš™
)(
ch_audio_decode_t
 *
	gaudio_decode
);

758 (*
	gupd©e_’abË_audio_decode_chª
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, 
	g’abË
);

759 (*
	gg‘_audio_decode_chª_’abË_¡©e
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
);

760 (*
	g£t_’abË_audio_decode_chª
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, 
	g’abË
, 
dvm_ch_t
 *
	gch
);

762 (*
	gupd©e_mu‹_audio_decode_chª
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, 
	gmu‹
);

763 (*
	gg‘_audio_decode_mu‹_¡©e
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
);

764 (*
	g£t_mu‹_audio_decode_chª
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, 
	gmu‹
, 
dvm_ch_t
 *
	gch
);

766 (*
	gg‘_audio_decode_chª_rd_±r
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, *
	gext_æag
, *
	gqueue_size
);

767 (*
	gg‘_audio_decode_chª_wr_±r
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
	gchª_id
, *
	gext_æag
, *
	gqueue_size
);

769 (*
	gg‘_audio_decode_·¿m
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
dvm_ch_t
 *
	gch
);

770 (*
	g£t_audio_decode_·¿m
)(
ch_audio_decode_t
 *
	gaudio_decode
, 
dvm_ch_t
 *
	gch
);

773 
	#to_g‘_ch_audio_decode_w™h_´İ”ty
(
node
è
	`cÚš”_of
Òode, 
ch_audio_decode_t
, 
cÚfig_·¿m
)

	)

774 
	sch_audio_decode
 {

775 
tw_audio_·¿m_t
 
	gcÚfig_·¿m
;

776 
audio_decode_cÚŒŞ_t
 
	gaudio_cÚŒŞ
;

777 
audio_decode_±r_cÚŒŞ_t
 
	gaudio_±r
;

778 
audio_decode_d©a_addr_t
 
	gaudio_d©a_ba£
;

780 
ch_audio_decode_İ”©iÚ
 *
	gİ
;

783 
	sch_audio_İ”©iÚ
 {

784 (*
	gš™
)(
ch_audio_t
 *
	gch_audio
);

786 (*
	g£t_’code_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
, 
	gty³
);

787 (*
	gupd©e_’code_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
, 
	gty³
);

788 (*
	gg‘_’code_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
);

790 (*
	g£t_decode_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
, 
	gty³
);

791 (*
	gupd©e_decode_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
, 
	gty³
);

792 (*
	gg‘_decode_audio_chª_ty³
)(
ch_audio_t
 *
	gch_audio
);

794 (*
	g£t_’abË_audio_chª
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
, 
	g’abË
);

795 (*
	gupd©e_’abË_audio_chª
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
, 
	g’abË
);

796 (*
	gg‘_audio_chª_’abË_¡©e
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
);

798 (*
	g£t_mu‹_audio_chª
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
, 
	gmu‹
);

799 (*
	gupd©e_mu‹_audio_chª
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
, 
	gmu‹
);

800 (*
	gg‘_audio_chª_mu‹_¡©e
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
);

802 (*
	gg‘_ch_audio_·¿m
)(
ch_audio_t
 *
	gch_audio
);

803 (*
	g£t_ch_audio_·¿m
)(
ch_audio_t
 *
	gch_audio
);

805 (*
	g´oûss_audio_’code
)(
ch_audio_t
 *
	gch_audio
);

806 (*
	g´oûss_audio_decode
)(
ch_audio_t
 *
	gch_audio
);

807 (*
	gg‘_audio_chª_driv”
)(
ch_audio_t
 *
	gch_audio
, 
	gchª_id
, 
tw_audio_driv”_t
 **
	g±r_audio_driv”
);

810 
	#to_g‘_ch_audio_w™h_audio_’abË
(
node
è
	`cÚš”_of
Òode, 
ch_audio_t
, 
audio_’abË
)

	)

811 
	#to_g‘_ch_audio_w™h_audio_’code
(
node
è
	`cÚš”_of
Òode, 
ch_audio_t
, 
audio_’code
)

	)

812 
	#to_g‘_ch_audio_w™h_audio_decode
(
node
è
	`cÚš”_of
Òode, 
ch_audio_t
, 
audio_decode
)

	)

813 
	sch_audio
 {

814 
audio_’abË_cÚŒŞ_t
 
	gaudio_’abË
;

815 
ch_audio_’code_t
 
	gaudio_’code
;

816 
ch_audio_decode_t
 
	gaudio_decode
;

817 
dvm_ch_t
 *
	gch
;

819 
ch_audio_İ”©iÚ
 *
	gİ
;

823 
tw_audio_cÚfig_desütÜ_t
 
deçuÉ_audio_’code_cÚfig_desütÜ
;

824 
tw_audio_cÚfig_desütÜ_t
 
deçuÉ_audio_decode_cÚfig_desütÜ
;

826 
g‘_pow”_ba£
(
u32
 
v®ue
);

827 
š™_audio_’abË_cÚŒŞ
(
audio_’abË_cÚŒŞ_t
 *);

828 
š™_audio_pcm_’code_±r_cÚŒŞ
(
audio_pcm_’code_±r_cÚŒŞ_t
 *);

829 
š™_audio_pcm_’code_d©a_addr
(
audio_pcm_’code_d©a_addr_t
 *);

830 
š™_audio_adpcm_’code_±r_cÚŒŞ
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *);

831 
š™_audio_adpcm_’code_d©a_addr
(
audio_adpcm_’code_d©a_addr_t
 *);

832 
š™_audio_’code_cÚŒŞ
(
audio_’code_cÚŒŞ_t
 *);

833 
š™_audio_decode_cÚŒŞ
(
audio_decode_cÚŒŞ_t
 *);

834 
š™_audio_decode_±r_cÚŒŞ
(
audio_decode_±r_cÚŒŞ_t
 *);

835 
š™_audio_decode_d©a_addr
(
audio_decode_d©a_addr_t
 *);

836 
š™_ch_audio_’code
(
ch_audio_’code_t
 *);

837 
š™_ch_audio_decode
(
ch_audio_decode_t
 *);

838 
š™_ch_audio
(
ch_audio_t
 *, 
dvm_ch_t
 *, );

839 
»move_ch_audio
(
ch_audio_t
 *
ch_audio
);

841 
š™_subm™_»cv_audio_b™¡»am_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_audio_driv”_t
 *
audio_chª_driv”
);

842 
š™_subm™_£nd_audio_b™¡»am_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_audio_driv”_t
 *
audio_chª_driv”
);

844 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_avSync_device.h

1 #iâdeà
TW_AVSYNC_DEVICE_H


2 
	#TW_AVSYNC_DEVICE_H


	)

4 #ifdeà
__ılu¥lus


9 
	#DEV_NAME_LEN
 32

	)

10 
	stw5864_avSync_dev


12 
Çme
[
DEV_NAME_LEN
];

13 
bus_id
;

14 
ch_id
;

15 
dev_šode_id
;

16 
id
;

17 
video_deviû
 
vfd
;

18 
£m­hÜe
 
£m
;

19 
©omic_t
 
İ’ed_æags
;

20 
wa™_queue_h—d_t
 
wa™_pŞl
;

22 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_driv”
;

23 
tw_h264_logic_’code_chª_t
 *
h264_sub_’code_driv”
;

24 
tw_j³g_logic_’code_chª_t
 *
j³g_’code_driv”
;

25 
tw_audio_driv”_t
 *
audio_’code_driv”
;

26 
tw_audio_driv”_t
 *
audio_decode_driv”
;

28 
avSync_äame_queue_t
 
avSync_äame_queue
;

29 
avSync_äame_buf_poŞ_t
 
deviû_buf_poŞ
;

32 
š™_tw5864_avSync_dev
(
tw5864_avSync_dev_t
 *
dev
, 
bus_id
, 
ch_id
, 
šode_id
, 
id
);

33 
»move_tw5864_avSync_dev
(
tw5864_avSync_dev_t
 *
dev
);

34 
bšd_av_deviû_ªd_driv”
(
tw5864_avSync_dev_t
 *
tw_deviû_chª
, 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_logic_chª
,w_h264_logic_’code_chª_ˆ*
h264_sub_’code_logic_chª
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
, 
tw_audio_driv”_t
 *
audio_’code_driv”
);

35 
unbšd_av_deviû_ªd_driv”
(
tw5864_avSync_dev_t
 *
tw_deviû_chª
, 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_logic_chª
,w_h264_logic_’code_chª_ˆ*
h264_sub_’code_logic_chª
, 
tw_j³g_logic_’code_chª_t
 * 
j³g_logic_chª
, 
tw_audio_driv”_t
 *
audio_’code_driv”
);

38 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_avSync_device_buf.h

1 #iâdef 
TW_AVSYNC_DEVICE_BUF_H


2 
	#TW_AVSYNC_DEVICE_BUF_H


	)

4 #ifdeà
__ılu¥lus


9 
	savSync_äame_buf_poŞ_İ”©iÚ
{

10 (*
ü—‹
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, );

11 (*
»Ëa£
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

13 (*
g‘_avSync_äame_tcb
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 **
±r_äame
);

14 (*
Œy_g‘_avSync_äame_tcb
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 **
±r_äame
);

15 (*
put_avSync_äame_tcb
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 *
äame
);

16 (*
g‘_avSync_äame_tcb_poŞ_’Œy_numb”
)(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

19 
	savSync_äame_buf_poŞ
{

20 
avSync_äame_’Œy_numb”
;

21 
tcb_node_poŞ_t
 
avSync_äame_poŞ_node
;

22 
avSync_äame_tcb_t
 *
avSync_äame_poŞ
;

24 
avSync_äame_buf_poŞ_İ”©iÚ
 *
İ
;

27 
	savSync_äame_tcb_İ”©iÚ
{

28 (*
š™
)(
avSync_äame_tcb_t
 *
äame
);

29 (*
»£t
)(
avSync_äame_tcb_t
 *
äame
);

30 (*
»Ëa£
)(
avSync_äame_tcb_t
 **
±r_äame
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

31 (*
»ã»nû
)(
avSync_äame_tcb_t
 *
¤c_äame
,‡vSync_äame_tcb_ˆ**
±r_de¡_äame
);

33 
size_t
 (*
subm™
)(
avSync_äame_tcb_t
 *
avSync_äame
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, *
äame_’d
, 
tw5864_avSync_dev_t
 *
dev
);

36 
	#CURR_SUBMIT_IS_264_MASTER_FRAME
 (0)

	)

37 
	#CURR_SUBMIT_IS_264_MASTER_MV_FRAME
 (1)

	)

38 
	#CURR_SUBMIT_IS_264_SUB_FRAME
 (2)

	)

39 
	#CURR_SUBMIT_IS_264_SUB_MV_FRAME
 (3)

	)

40 
	#CURR_SUBMIT_IS_AUDIO_FRAME
 (4)

	)

41 
	#CURR_SUBMIT_IS_JPEG_FRAME
 (5)

	)

42 
	#to_g‘_avSync_äame_tcb
(
node
è
	`cÚš”_of
Òode, 
avSync_äame_tcb_t
, 
äame_node
)

	)

43 
	savSync_äame_tcb
{

44 
©omic_t
 
»f_couÁ
;

45 
¥šlock_t
 
lock
;

46 
tcb_node_t
 
äame_node
;

48 
cu¼_subm™_tcb
;

49 
tw_video_äame_tcb_t
 *
h264_ma¡”_äame
;

50 #ifdeà 
MV_MODULE


51 
tw_video_mv_äame_tcb_t
 *
h264_ma¡”_mv_äame
;

53 
tw_video_äame_tcb_t
 *
h264_sub_äame
;

54 #ifdeà 
MV_MODULE


55 
tw_video_mv_äame_tcb_t
 *
h264_sub_mv_äame
;

57 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_’code_äame
;

58 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_decode_äame
;

59 #ifdeà
MJPEG_MODULE


60 
tw_vb_äame_tcb_t
 *
j³g_äame
;

62 
avSync_äame_tcb_İ”©iÚ
 *
İ
;

65 
	savSync_äame_queue_İ”©iÚ
{

66 (*
g‘
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 **);

67 (*
Œy_g‘
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 **);

68 (*
g‘_”
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 **);

69 (*
Œy_g‘_”
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 **);

70 (*
put
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 *);

71 (*
put_h—d”
)(
avSync_äame_queue_t
 *, 
avSync_äame_tcb_t
 *);

73 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
avSync_äame_queue_t
 *, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

74 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
avSync_äame_queue_t
 *, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

75 (*
put_cu¼_´oduûr_što_queue
)(
avSync_äame_queue_t
 *);

76 (*
»Ëa£_cu¼_´oduûr
)(
avSync_äame_queue_t
 *, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

77 (*
g‘_cu¼_cÚsum”_äom_queue
)(
avSync_äame_queue_t
 *);

78 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
avSync_äame_queue_t
 *);

79 (*
»Ëa£_cu¼_cÚsum”
)(
avSync_äame_queue_t
 *, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

81 (*
g‘_cu¼_queue_’Œy_numb”
)(
avSync_äame_queue_t
 *);

82 (*
»Ëa£
)(
avSync_äame_queue_t
 *, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

83 (*
š™
)(
avSync_äame_queue_t
 *);

86 
	savSync_äame_queue
{

87 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

88 
tcb_node_queue_t
 
queue_node
;

89 
avSync_äame_tcb_t
 *
cu¼_cÚsum”
;

90 
avSync_äame_tcb_t
 *
cu¼_´oduûr
;

91 
¥šlock_t
 
lock
;

93 
avSync_äame_queue_İ”©iÚ
 *
İ
;

96 
š™_avSync_äame_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
);

97 
»move_avSync_äame_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

98 
š™_avSync_äame_buf_poŞ
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

99 
»move_avSync_äame_buf_poŞ
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
);

102 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_chip_ai.h

1 #iâdeà
_TW_CHIP_AI_H__


2 
	#_TW_CHIP_AI_H__


	)

4 #ifdeà
__ılu¥lus


8 
	#TW_DRIVER_AI_IOC_MAGIC
 'H'

	)

10 
	#TW_AI_SET_AUDIO_SYS_PARM
 
	`_IOW
(
TW_DRIVER_AI_IOC_MAGIC
, 49, )

	)

11 
	#TW_AI_GET_AUDIO_SYS_PARM
 
	`_IOR
(
TW_DRIVER_AI_IOC_MAGIC
, 48, )

	)

12 
	#TW_AI_GET_AUDIO_CHN_PARM
 
	`_IOR
(
TW_DRIVER_AI_IOC_MAGIC
, 47, )

	)

13 
	#TW_AI_SET_AUDIO_GAIN
 
	`_IOW
(
TW_DRIVER_AI_IOC_MAGIC
, 02, )

	)

14 
	#TW_AI_MAX_CHNL
 (4)

	)

16 
	#TW_AI_CLOCK_MODE
 (0x06c)

	)

17 
	#TW_AI_SYNC_MODE
 (0x062)

	)

18 
	#TW_AI_BITS
 (0x06c)

	)

19 
	#TW_AI_SAMPLE_RATE
 (0x075)

	)

21 
	#TW_AI_GAIN_21
 (0x060)

	)

22 
	#TW_AI_GAIN_43
 (0x061)

	)

23 
	#MAX_AI_GAIN
 (15)

	)

24 
	#DEFAULT_AI_GAIN
 (8)

	)

25 
	#MIN_AI_GAIN
 (0)

	)

27 
	#to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_ch_ai_driv”_t
, 
İ’ed_ai_ed
)

	)

29 
	eAUDIO_SYNC_MODE
{

30 
AUDIO_SYNC_MODE_I2S
 = 0,

31 
AUDIO_SYNC_MODE_DSP
,

34 
	eAUDIO_CLOCK_MODE
{

35 
AUDIO_CLOCK_SLAVE
 = 0,

36 
AUDIO_CLOCK_MASTER
,

39 
tw_ch_ai_driv”
 
	ttw_ch_ai_driv”_t
;

40 
tw_ch_ai_İ”©iÚ
 
	ttw_ch_ai_İ”©iÚ_t
;

41 
tw_ch_ai_´İ”ty
 
	ttw_ch_ai_´İ”ty_t
;

42 
tw_ch_ai_´İ”ty_İ”©iÚ
 
	ttw_ch_ai_´İ”ty_İ”©iÚ_t
;

43 
tw_ch_ai_cÚfig_´İ”ty
 
	ttw_ch_ai_cÚfig_´İ”ty_t
;

45 
	stw_ch_ai_sys
{

46 
u32
 
chªgemask
;

47 
	#TW_CHIP_AI_CHANGEMASK_CLOCK_MODE
 (0x0001)

	)

48 
	#TW_CHIP_AI_CHANGEMASK_SYNC_MODE
 (0x0002)

	)

49 
	#TW_CHIP_AI_CHANGEMASK_SAMPLE_RATE
 (0x0004)

	)

50 
	#TW_CHIP_AI_CHANGEMASK_BITS
 (0x0008)

	)

51 
	#TW_CHIP_AI_CHANGEMASK_MASKALL
 (0x000f)

	)

53 
AUDIO_CLOCK_MODE
 
şock_mode
;

54 
AUDIO_SYNC_MODE
 
sync_mode
;

55 
TW_AUDIO_SAMPLE_RATE
 
§m¶e_¿‹
;

56 
TW_AUDIO_BIT
 
b™s
;

61 
u32ChID
;

62 
u32ChªÃl
;

63 
u32VŞume
;

64 } 
	tAI_CH_VOLUME
;

66 
	stw_ch_ai_´İ”ty
{

67 
u32
 
chªÃl
;

68 
u32
 
chªgemask
;

69 
	#TW_CHIP_AI_CHANGEMASK_GAIN
 (0x0001)

	)

70 
u32
 
gaš
;

73 
	stw_ch_ai_´İ”ty_İ”©iÚ
{

74 (*
š™
)(
tw_ch_ai_´İ”ty_t
 *, 
u32
);

75 (*
»£t
)(
tw_ch_ai_´İ”ty_t
 *);

77 
u32
 (*
g‘_gaš
)(
tw_ch_ai_´İ”ty_t
 *);

78 (*
£t_gaš
)(
tw_ch_ai_´İ”ty_t
 *, 
u32
);

79 (*
upd©e
)(
tw_ch_ai_´İ”ty_t
 *, 
dvm_ch_t
 *
ch
);

82 
	stw_ch_ai_cÚfig_´İ”ty
{

83 
tw_ch_ai_´İ”ty_t
 
audio_´İ”ty
;

84 
tw_ch_ai_´İ”ty_İ”©iÚ_t
 *
İ
;

87 
	stw_ch_ai_İ”©iÚ
{

88 (*
š™
)(
tw_ch_ai_driv”_t
 *);

89 (*
»Ëa£
)(
tw_ch_ai_driv”_t
 *);

90 (*
»£t
)(
tw_ch_ai_driv”_t
 *);

92 (*
g‘_şock_mode
)(
tw_ch_ai_driv”_t
 *);

93 (*
£t_şock_mode
)(
tw_ch_ai_driv”_t
 *, 
AUDIO_CLOCK_MODE
);

94 (*
g‘_sync_mode
)(
tw_ch_ai_driv”_t
 *);

95 (*
£t_sync_mode
)(
tw_ch_ai_driv”_t
 *, 
AUDIO_SYNC_MODE
);

96 (*
g‘_§m¶e_¿‹
)(
tw_ch_ai_driv”_t
 *);

97 (*
£t_§m¶e_¿‹
)(
tw_ch_ai_driv”_t
 *, 
TW_AUDIO_SAMPLE_RATE
);

98 (*
g‘_b™s
)(
tw_ch_ai_driv”_t
 *);

99 (*
£t_b™s
)(
tw_ch_ai_driv”_t
 *, 
TW_AUDIO_BIT
);

102 
	stw_ch_ai_driv”
{

103 
©omic_t
 
İ’ed_æag
;

104 
ed_tcb_t
 
İ’ed_ai_ed
;

106 
dvm_ch_t
 *
ch
;

108 
AUDIO_CLOCK_MODE
 
şock_mode
;

109 
AUDIO_SYNC_MODE
 
sync_mode
;

110 
TW_AUDIO_SAMPLE_RATE
 
§m¶e_¿‹
;

111 
TW_AUDIO_BIT
 
b™s
;

113 
tw_ch_ai_cÚfig_´İ”ty_t
 
audio_´İ”ty
[
TW_AI_MAX_CHNL
];

115 
tw_ch_ai_İ”©iÚ_t
 *
İ
;

118 
š™_ch_ai_driv”
(
tw_£rviû_deviû
 *
tsd
,
dvm_ch_t
 *
ch
);

119 
»move_ch_ai_driv”
(
tw_£rviû_deviû
 *
tsd
);

120 
tw5864_ch_ai_driv”_š™
(* 
·¿
);

121 
tw5864_ch_ai_driv”_»move
();

123 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_chip_ao.h

1 #iâdeà
_TW_CHIP_AO_H__


2 
	#_TW_CHIP_AO_H__


	)

4 #ifdeà
__ılu¥lus


9 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_chip_driver.h

1 #iâdeà
__TW_CHIP_DRIVER_H__


2 
	#__TW_CHIP_DRIVER_H__


	)

4 #ifdeà
__ılu¥lus


9 
	#TW_CHIP_IOC_MAGIC
 'H'

	)

12 
	#TW_CHIP_VD_WORK_MODE_SET
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 255, )

	)

13 
	#TW_CHIP_VD_WORK_MODE_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 254, )

	)

16 
	#TW_VIDEO_BUS_PARAM_SET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 253, )

	)

17 
	#TW_VIDEO_BUS_PARAM_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 252, )

	)

18 
	#TW_CHIP_VD_CONFIG_PARAM_SET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 251, )

	)

19 
	#TW_CHIP_VD_CONFIG_PARAM_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 250, )

	)

20 
	#TW_CHIP_AUDIO_ENCODE_PARAM_SET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 249, )

	)

21 
	#TW_CHIP_AUDIO_ENCODE_PARAM_GET
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 248, )

	)

22 
	#TW_CHIP_AUDIO_DECODE_PARAM_SET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 247, )

	)

23 
	#TW_CHIP_AUDIO_DECODE_PARAM_GET
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 246, )

	)

24 
	#TW_CHIP_CREATE_CHAN
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 245, )

	)

25 
	#TW_CHIP_RELEASE_CHAN
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 244, )

	)

26 
	#TW_CHIP_ID_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 243, )

	)

27 
	#TW_CHIP_CTL_OP
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 200, )

	)

28 
	#TW_CHIP_CONFIG_WRITE_REG
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 201, )

	)

29 
	#TW_CHIP_CONFIG_READ_REG
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 202, )

	)

30 
	#TW_CHIP_VIN_CHAN_NUMBER_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 203, )

	)

31 
	#TW_CHIP_VOUT_CHAN_NUMBER_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 204, )

	)

32 
	#TW_CHIP_AIN_CHAN_NUMBER_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 205, )

	)

33 
	#TW_CHIP_AOUT_CHAN_NUMBER_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 206, )

	)

34 
	#TW_CHIP_LOGIC_MAP_TABLE_SET
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 207, )

	)

35 
	#TW_CHIP_LOGIC_MAP_TABLE_GET
 
	`_IOW
(
TW_CHIP_IOC_MAGIC
, 208, )

	)

36 
	#TW_CHIP_VD_CHNL_CONFIG_GET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 209, )

	)

37 
	#TW_CHIP_VD_CHNL_CONFIG_SET
 
	`_IOR
(
TW_CHIP_IOC_MAGIC
, 210, )

	)

40 
	#TW_VIDEO_BUS_PARAM_ENABLE_CHANGE_VIDEO_STANDARD_MASK
 (0x00000001)

	)

42 
	#TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
 (0x00000001)

	)

43 
	#TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
 (0x00000002)

	)

44 
	#TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
 (0x00000004)

	)

46 
	#TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
 (0x00000001)

	)

47 
	#TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
 (0x00000002)

	)

48 
	#TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
 (0x00000004)

	)

51 
	#to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
ch_driv”_t
, 
İ’ed_cÚŒŞ_ed
)

	)

53 
	eTW_AUDIO_SAMPLE_RATE
{

54 
TW_AUDIO_8000
 = 0,

55 
TW_AUDIO_16000
,

56 
TW_AUDIO_32000
,

57 
TW_AUDIO_44100
,

58 
TW_AUDIO_48000
,

59 
TW_AUDIO_RESERVED
,

62 
	eTW_AUDIO_BIT
{

63 
TW_AUDIO_16BIT
 = 0,

64 
TW_AUDIO_8BIT
,

67 
tw_ch_video_·¿m
 
	ttw_ch_video_·¿m_t
;

68 
video_bus_İ”©iÚ
 
	tvideo_bus_İ”©iÚ_t
;

69 
tw_video_bus
 
	ttw_video_bus_t
;

70 
audio_bus_İ”©iÚ
 
	taudio_bus_İ”©iÚ_t
;

71 
tw_audio_bus
 
	ttw_audio_bus_t
;

72 
ch_driv”_İ”©iÚ
 
	tch_driv”_İ”©iÚ_t
;

73 
ch_driv”
 
	tch_driv”_t
;

74 
tw_logic_m­_bË
 
	ttw_logic_m­_bË_t
;

75 
tw_logic_phy_bË
 
	ttw_logic_phy_bË_t
;

76 
tw_logic_phy_İ”©iÚ
 
	ttw_logic_phy_İ”©iÚ_t
;

78 
	eTW_AUDIO_TYPE
{

79 
TW_AUDIO_PCM
 = 0,

80 
TW_AUDIO_ALAW
,

81 
TW_AUDIO_ULAW
,

82 
TW_AUDIO_ADPCM_32K
,

83 
TW_AUDIO_ADPCM_16K
,

84 
TW_AUDIO_ADPCM_48K


87 
	eTW_VIDEO_MD_TRIGGER_MODE
{

88 
VIDEO_MD_TRIGGER_AUTO
 = 0,

89 
VIDEO_MD_TRIGGER_USER
,

92 
	eTW_VIDEO_MD_SEL
{

93 
TW_VIDEO_MD_ODD
 = 0,

94 
TW_VIDEO_MD_EVEN
,

95 
TW_VIDEO_MD_BOTH
,

98 
	eTW_VIDEO_MD_REF
{

99 
TW_VIDEO_MD_REF_AUTO
,

100 
TW_VIDEO_MD_REF_USER
,

103 
	stw_»g_cÚf
{

104 
u32
 
addr
;

105 
u32
 
v®
;

108 
	stw_video_md_·¿m
{

112 
	stw_ch_vi_šfo
{

113 
u32
 
i_vš_chª_nubm”
;

114 
u32
 
i_vš_ad_chª_numb”
;

115 
u32
 
i_ÿsÿde_vš_ad_chª_numb”
;

117 
	stw_ch_vo_šfo
{

118 
u32
 
i_vout_chª_nubm”
;

119 
u32
 
i_vout_ad_chª_numb”
;

121 
	stw_ch_ai_šfo
{

122 
u32
 
i_aš_chª_nubm”
;

123 
u32
 
i_aš_ad_chª_numb”
;

124 
u32
 
i_ÿsÿde_aš_ad_chª_numb”
;

126 
	stw_ch_ao_šfo
{

127 
u32
 
i_aout_chª_nubm”
;

128 
u32
 
i_aout_ad_chª_numb”
;

131 
	stw_ch_id_šfo
{

132 
u32
 
i_v’dÜ_id
;

133 
u32
 
i_v”siÚ_id
;

136 
	stw_ch_audio_·¿m
{

137 
u32
 
chªge_mask_æag
;

138 
u32
 
chªÃl
;

139 
u8
 
i_b™_wide
;

140 
u8
 
i_§m¶e_¿‹
;

141 
u16
 
e_audio_ty³
;

144 
	eLOGIC_MAP_TABLE_TYPE
{

145 
LOGIC_MAP_TABLE_BIND_H264E
 = 0,

146 
LOGIC_MAP_TABLE_BIND_H264D
,

147 
LOGIC_MAP_TABLE_BIND_AENC
,

148 
LOGIC_MAP_TABLE_BIND_ADEC
,

149 
LOGIC_MAP_TABLE_BIND_JPEGE
,

150 
LOGIC_MAP_TABLE_BIND_RESERVED
,

153 
	stw_logic_m­_bË
{

154 
u32
 
i_chª_numb”
;

155 
LOGIC_MAP_TABLE_TYPE
 
e_bšd_ty³
;

158 #ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

159 
u32
 
logic_¦Ù_id
:16;

160 
u32
 
phy_¦Ù_id
:16;

161 #–ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

162 
u32
 
phy_¦Ù_id
:16;

163 
u32
 
logic_¦Ù_id
:16;

167 }
m­_bË
[0];

170 
	stw_logic_phy_İ”©iÚ
{

171 (*
š™
)(
tw_logic_phy_bË_t
 *);

172 (*
»£t
)(
tw_logic_phy_bË_t
 *);

173 (*
»Ëa£
)(
tw_logic_phy_bË_t
 *);

175 (*
fšd_logic_by_phy
)(
tw_logic_phy_bË_t
 *, 
LOGIC_MAP_TABLE_TYPE
, 
u32
, u32 *);

176 (*
fšd_phy_by_logic
)(
tw_logic_phy_bË_t
 *, 
LOGIC_MAP_TABLE_TYPE
, 
u32
, u32 *);

177 (*
upd©e_m­_bË
)(
tw_logic_phy_bË_t
 *, 
LOGIC_MAP_TABLE_TYPE
, 
tw_logic_m­_bË_t
 *);

178 (*
g‘_m­_bË
)(
tw_logic_phy_bË_t
 *, 
LOGIC_MAP_TABLE_TYPE
, 
tw_logic_m­_bË_t
 *);

181 
	stw_logic_phy_bË
{

182 
¥šlock_t
 
lock
;

183 
tw_logic_m­_bË_t
 *
logic_lbe
[
LOGIC_MAP_TABLE_BIND_RESERVED
];

185 
tw_logic_phy_İ”©iÚ_t
 *
İ
;

188 
	stw_ch_video_·¿m
{

189 
u32
 
chªge_mask_æag
;

190 
TW_VIDEO_STANDARD
 
e_video_¡ªd¬d
;

193 
	stw_vd_chª_·¿m
{

194 
u32
 
chªge_mask_æag
;

195 
u8
 
i_phy_chª_id
;

196 
u8
 
i_phy_chª_’abË
;

197 
u8
 
i_phy_chª_ås
;

198 
u8
 
i_»£rve
;

199 
u32
 
hÜ_»v”£
;

200 
u32
 
v”_»v”£
;

201 
u16
 
i_phy_video_width_mb_size
;

202 
u16
 
i_phy_video_height_mb_size
;

205 
	stw_ch_vd_·¿m
{

206 
u32
 
i_vd_chª_numb”
;

207 
tw_vd_chª_·¿m
 
vd_chª_·¿m
[
TW5864_PHY_VD_CHAN_NUMBER
];

210 
	svideo_bus_İ”©iÚ
{

211 (*
š™
)(
tw_video_bus_t
 *, 
dvm_ch_t
 *);

212 (*
»Ëa£
)(
tw_video_bus_t
 *);

213 (*
»£t
)(
tw_video_bus_t
 *);

215 (*
g‘_video_¡ªd¬d
)(
tw_video_bus_t
 *);

216 (*
£t_video_¡ªd¬d
)(
tw_video_bus_t
 *, );

217 (*
nÙify_logic_chª_chªge
)(
tw_video_bus_t
 *);

218 (*
nÙify_su¥’d_logic_chª
)(
tw_video_bus_t
 *);

219 (*
nÙify_»sume_logic_chª
)(
tw_video_bus_t
 *);

222 
	stw_video_bus
{

223 
tw_ch_video_·¿m_t
 
video_·¿m
;

225 
tw5864_vd_üoss_bus_t
 *
vd_bus_driv”
;

226 
tw5864_vj_bus_t
 *
vj_bus_driv”
;

228 
video_bus_İ”©iÚ_t
 *
İ
;

231 
	saudio_bus_İ”©iÚ
{

232 (*
š™
)(
tw_audio_bus_t
 *, 
dvm_ch_t
 *);

233 (*
»Ëa£
)(
tw_audio_bus_t
 *);

234 (*
»£t
)(
tw_audio_bus_t
 *);

237 
	stw_audio_bus
{

238 
ch_audio_t
 *
ch_audio_driv”
;

240 
audio_bus_İ”©iÚ_t
 *
İ
;

243 
	sch_driv”_İ”©iÚ
{

244 (*
š™
)(
ch_driv”_t
 *);

245 (*
»Ëa£
)(
ch_driv”_t
 *);

246 (*
»£t
)(
ch_driv”_t
 *);

249 
	sch_driv”
{

250 
©omic_t
 
İ’ed_æag
;

251 
ed_tcb_t
 
İ’ed_cÚŒŞ_ed
;

253 
dvm_ch_t
 *
ch
;

254 
tw_video_bus_t
 
video_bus
;

255 
tw_audio_bus_t
 
audio_bus
;

256 
tw_logic_phy_bË_t
 
logic_m­_phy
;

258 
ch_driv”_İ”©iÚ_t
 *
İ
;

262 
tw5864_ch_driv”_š™
();

263 
tw5864_ch_driv”_»move
();

267 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_chip_vi.h

1 #iâdeà
_TW_CHIP_VI_H__


2 
	#_TW_CHIP_VI_H__


	)

4 #ifdeà
__ılu¥lus


8 
	#TW_DRIVER_VI_IOC_MAGIC
 'H'

	)

10 
	#TW_VI_SET_VIDEO_AD_PARM
 
	`_IOW
(
TW_DRIVER_VI_IOC_MAGIC
, 51, )

	)

11 
	#TW_VI_GET_VIDEO_AD_PARM
 
	`_IOR
(
TW_DRIVER_VI_IOC_MAGIC
, 52, )

	)

12 
	#TW_VI_GET_FEATURE
 
	`_IOR
(
TW_DRIVER_VI_IOC_MAGIC
, 147, )

	)

13 
	#TW_VI_SET_FEATURE
 
	`_IOW
(
TW_DRIVER_VI_IOC_MAGIC
, 146, )

	)

14 
	#TW_VI_GET_VIDEO_STANDARD
 
	`_IOR
(
TW_DRIVER_VI_IOC_MAGIC
, 145, )

	)

16 
	#TW_VI_SET_VIDEO_TYPE
 
	`_IOW
(
TW_DRIVER_VI_IOC_MAGIC
, 55, )

	)

18 
	#TW_VI_MAX_CHNL
 (16)

	)

19 
	#TW_VI_ON_CHIP_CHNL
 (4è

	)

21 
	#TW_VI_BRIGHNESS
 (0x00A)

	)

22 
	#TW_VI_CONTRAST
 (0x009)

	)

23 
	#TW_VI_SATURATION_U
 (0x00B)

	)

24 
	#TW_VI_SATURATION_V
 (0x00C)

	)

25 
	#TW_VI_HUE
 (0x007)

	)

26 
	#TW_VI_SHARPNESS
 (0x008)

	)

28 
	#TW_VI_STANDARD
 (0x00e)

	)

31 
	#TW_VI_SYSTEM_RESET
 (0xef0)

	)

32 
	#TW_VI_SYSTEM_CLOCK
 (0xefc)

	)

33 
	#TW_VI_SYSTEM_CLOCK_REVERSE
 (0xefdè

	)

34 
	#TW_VI_SYSTEM_VIDEO_STANDARD
 (0x260è

	)

35 
	#TW_VI_SYSTEM_IN_WIDTH
(
n
è(0x200 + (n<<2)è

	)

36 
	#TW_VI_SYSTEM_IN_HEIGHT
(
n
è(0x201 + (n<<2)è

	)

37 
	#TW_VI_SYSTEM_OUT_WIDTH
(
n
è(0x202 + (n<<2)è

	)

38 
	#TW_VI_SYSTEM_OUT_HEIGHT
(
n
è(0x203 + (n<<2)è

	)

41 
	#TW_VI_EVENT_CONTROL
(
n
è(0x300 + (n<<3))

	)

42 
	#TW_VI_EVENT_MD_TMPSENS
(
n
è(0x301 + (n<<3)è

	)

43 
	#TW_VI_EVENT_MD_FIELD
(
n
è(0x302 + (n<<3)è

	)

44 
	#TW_VI_EVENT_MD_CELL
(
n
è(0x303 + (n<<3)è

	)

45 
	#TW_VI_EVENT_MD_SPSENS
(
n
è(0x304 + (n<<3)è

	)

46 
	#TW_VI_EVENT_ND_TMPSENS
(
n
è(0x305 + (n<<3)è

	)

49 
	#TW_VI_EVENT_MOTION_L
 (0x2d0)

	)

50 
	#TW_VI_EVENT_MOTION_H
 (0x2d1)

	)

51 
	#TW_VI_EVENT_NIGHT_L
 (0x2d2)

	)

52 
	#TW_VI_EVENT_NIGHT_H
 (0x2d3)

	)

53 
	#TW_VI_EVENT_BLIND_L
 (0x2d4)

	)

54 
	#TW_VI_EVENT_BLIND_H
 (0x2d5)

	)

55 
	#TW_VI_EVENT_NOVIDEO_L
 (0x2d6)

	)

56 
	#TW_VI_EVENT_NOVIDEO_H
 (0x2d7)

	)

57 
	#TW_VI_EVENT_UNDERFLOW_L
 (0x2e0)

	)

58 
	#TW_VI_EVENT_UNDERFLOW_H
 (0x2e1)

	)

59 
	#TW_VI_EVENT_OVERFLOW_L
 (0x2e2)

	)

60 
	#TW_VI_EVENT_OVERFLOW_H
 (0x2e3)

	)

62 
	#TW_VI_EVENT_MASK_MOTION_L
 (0x2d8)

	)

63 
	#TW_VI_EVENT_MASK_MOTION_H
 (0x2d9)

	)

64 
	#TW_VI_EVENT_MASK_NIGHT_L
 (0x2da)

	)

65 
	#TW_VI_EVENT_MASK_NIGHT_H
 (0x2db)

	)

66 
	#TW_VI_EVENT_MASK_BLIND_L
 (0x2dc)

	)

67 
	#TW_VI_EVENT_MASK_BLIND_H
 (0x2dd)

	)

68 
	#TW_VI_EVENT_MASK_NOVIDEO_L
 (0x2de)

	)

69 
	#TW_VI_EVENT_MASK_NOVIDEO_H
 (0x2df)

	)

70 
	#TW_VI_EVENT_MASK_UNDERFLOW_L
 (0x2e8)

	)

71 
	#TW_VI_EVENT_MASK_UNDERFLOW_H
 (0x2e9)

	)

72 
	#TW_VI_EVENT_MASK_OVERFLOW_L
 (0x2—)

	)

73 
	#TW_VI_EVENT_MASK_OVERFLOW_H
 (0x2eb)

	)

75 
	#TW_VI_EVENT_SUMMARY_L
 (0x2f0)

	)

76 
	#TW_VI_EVENT_SUMMARY_H
 (0x2f1)

	)

78 
	#CHIP_VI_EVENT_MIN_SENSITIVE
 (0è

	)

79 
	#CHIP_VI_EVENT_MAX_SENSITIVE
 (15è

	)

81 
	eCHIP_VI_STANDARD
 {

82 
CHIP_VI_STANDARD_NTSC_M
,

83 
CHIP_VI_STANDARD_PAL_BDGHI
,

84 
CHIP_VI_STANDARD_SECAM
,

85 
CHIP_VI_STANDARD_NTSC443
,

86 
CHIP_VI_STANDARD_PAL_M
,

87 
CHIP_VI_STANDARD_PAL_CN
,

88 
CHIP_VI_STANDARD_PAL_60
,

89 
CHIP_VI_STANDARD_INVALID
,

90 
CHIP_VI_STANDARD_AUTO
,

93 
	#DEFAULT_VI_STANDARD
 
CHIP_VI_STANDARD_AUTO


	)

95 
	eCHIP_VI_EVENT
{

96 
CHIP_VI_EVENT_MOTION
 = 0,

97 
CHIP_VI_EVENT_NIGHT
,

98 
CHIP_VI_EVENT_BLIND
,

99 
CHIP_VI_EVENT_LOST
,

100 
CHIP_VI_EVENT_UNDERFLOW
,

101 
CHIP_VI_EVENT_OVERFLOW
,

102 
CHIP_VI_EVENT_RESERVED
,

105 
	eMOTION_TRIGGER_MODE
{

106 
MOTION_TRIGGER_AUTIO
 = 0,

107 
MOTION_TRIGGER_USER
,

108 
MOTION_TRIGGER_RESERVED
,

111 
tw_ch_vi_ã©u»
 
	ttw_ch_vi_ã©u»_t
;

112 
tw_ch_vi_´İ”ty_İ”©iÚ
 
	ttw_ch_vi_´İ”ty_İ”©iÚ_t
;

113 
tw_ch_vi_cÚfig_´İ”ty
 
	ttw_ch_vi_cÚfig_´İ”ty_t
;

114 
tw_ch_vi_´İ”ty
 
	ttw_ch_vi_´İ”ty_t
;

115 
tw_ch_vi_İ”©iÚ
 
	ttw_ch_vi_İ”©iÚ_t
;

116 
tw_vi_ev’t_aùiÚ
 
	ttw_vi_ev’t_aùiÚ_t
;

117 
tw_ch_vi_ev’t
 
	ttw_ch_vi_ev’t_t
;

118 
tw_ch_vi_driv”
 
	ttw_ch_vi_driv”_t
;

119 (*
ev’t_hªdËr
)(
	tu32
, *);

121 
	#to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_ch_vi_driv”_t
, 
İ’ed_vi_ed
)

	)

123 
	#MAX_VI_BRIGHNESS
 (255)

	)

124 
	#DEFAULT_VI_BRIGHTNESS
 (128)

	)

125 
	#MIN_VI_BRIGHNESS
 (0)

	)

127 
	#MAX_VI_CONTRAST
 (255)

	)

128 
	#DEFAULT_VI_CONTRAST
 (100)

	)

129 
	#MIN_VI_CONTRAST
 (0)

	)

131 
	#MAX_VI_SATURATION
 (255)

	)

132 
	#DEFAULT_VI_SATURATION
 (128)

	)

133 
	#MIN_VI_SATURATION
 (0)

	)

135 
	#MAX_VI_HUE
 (255)

	)

136 
	#DEFAULT_VI_HUE
 (128)

	)

137 
	#MIN_VI_HUE
 (0)

	)

139 
	#MAX_VI_SHARPNESS
 (15)

	)

140 
	#DEFAULT_VI_SHARPNESS
 (1)

	)

141 
	#MIN_VI_SHARPNESS
 (0)

	)

143 
	#TW_VI_FEATURE_ENABLE_CHANGE_MODE_MASK
 (0x01)

	)

144 
	#TW_VI_FEATURE_ENABLE_CHANGE_MOTION_MASK
 (0x02)

	)

145 
	#TW_VI_FEATURE_ENABLE_CHANGE_NIGHT_MASK
 (0x04)

	)

146 
	#TW_VI_FEATURE_ENABLE_CHANGE_BLIND_MASK
 (0x08)

	)

147 
	#TW_VI_FEATURE_ENABLE_CHANGE_NOVIDEO_MASK
 (0x010)

	)

148 
	#TW_VI_FEATURE_ENABLE_CHANGE_UNDERFLOW_MASK
 (0x020)

	)

149 
	#TW_VI_FEATURE_ENABLE_CHANGE_OVERFLOW_MASK
 (0x040)

	)

150 
	#TW_VI_FEATURE_ENABLE_CHANGE_MASK_ALL
 (0x07f)

	)

152 
	#TW_VI_FEATURE_ON
 (1)

	)

153 
	#TW_VI_FEATURE_OFF
 (0)

	)

155 
	stw_ch_vi_ã©u»
{

156 
u32
 
chªÃl
;

157 
u32
 
chªge_mask
;

159 
MOTION_TRIGGER_MODE
 
e_mÙiÚ_mode
;

160 
u32
 
i_mÙiÚ_£ns™ive
;

161 
u32
 
i_night_£ns™ive
;

162 
u32
 
i_blšd_£ns™ive
;

164 
u8
 
b_novideo_’abË
;

165 
u8
 
b_und”æow_’abË
;

166 
u8
 
b_ov”æow_’abË
;

167 
u8
 
b_»£rved
[1];

170 
	stw_ch_vi_´İ”ty
{

171 
u32
 
ch_num
;

172 
u32
 
u32ChªÃl
;

173 
u32
 
u32Mask
;

175 
	#MASK_VI_BRIGHTNESS
 (0x01)

	)

176 
	#MASK_VI_CONTRAST
 (0x02)

	)

177 
	#MASK_VI_SATURATION
 (0x04)

	)

178 
	#MASK_VI_HUE
 (0x08)

	)

179 
	#MASK_VI_SHARPNESS
 (0x10)

	)

180 
	#MASK_VI_ALL
 (0x1f)

	)

182 
u32
 
u32BrighŠess
;

183 
u32
 
u32CÚŒa¡
;

184 
u32
 
u32S©u¿tiÚ
;

185 
u32
 
u32Hue
;

186 
u32
 
u32Sh¬²ess
;

191 
u32ChID
;

192 
u32ChªÃl
;

193 
CHIP_VI_STANDARD
 
eVideoTy³
;

194 }
	tVI_CH_VIDEOTYPE
;

196 
	stw_ch_vi_´İ”ty_İ”©iÚ
{

197 (*
š™
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
 
chn
);

198 (*
»£t
)(
tw_ch_vi_´İ”ty_t
 *);

200 
u32
 (*
g‘_brighŠess
)(
tw_ch_vi_´İ”ty_t
 *);

201 (*
£t_brighŠess
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
);

202 
u32
 (*
g‘_cÚŒa¡
)(
tw_ch_vi_´İ”ty_t
 *);

203 (*
£t_cÚŒa¡
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
);

204 
u32
 (*
g‘_§tu¿tiÚ
)(
tw_ch_vi_´İ”ty_t
 *);

205 (*
£t_§tu¿tiÚ
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
);

206 
u32
 (*
g‘_hue
)(
tw_ch_vi_´İ”ty_t
 *);

207 (*
£t_hue
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
);

208 
u32
 (*
g‘_sh¬²ess
)(
tw_ch_vi_´İ”ty_t
 *);

209 (*
£t_sh¬²ess
)(
tw_ch_vi_´İ”ty_t
 *, 
u32
);

211 (*
upd©e
)(
tw_ch_vi_driv”_t
 *, 
tw_ch_vi_cÚfig_´İ”ty_t
 *);

214 
	stw_ch_vi_cÚfig_´İ”ty
{

215 
tw_ch_vi_´İ”ty_t
 
video_´İ”ty
;

216 
tw_ch_vi_ã©u»_t
 
video_ã©u»
;

217 
tw_ch_vi_´İ”ty_İ”©iÚ_t
 *
İ
;

220 
	stw_ch_vi_İ”©iÚ
{

221 (*
š™
)(
tw_ch_vi_driv”_t
*);

222 (*
»£t
)(
tw_ch_vi_driv”_t
*);

223 (*
»Ëa£
)(
tw_ch_vi_driv”_t
*);

225 (*
£t_video_¡ªd¬d
)(
tw_ch_vi_driv”_t
 *, 
CHIP_VI_STANDARD
);

226 (*
£t_video_¡ªd¬d_ext
)(
tw_ch_vi_driv”_t
 *, 
CHIP_VI_STANDARD
);

227 (*
g‘_video_¡ªd¬d
)(
tw_ch_vi_driv”_t
 *);

229 
u32
 (*
g‘_video_ev’t
)(
tw_ch_vi_driv”_t
 *);

232 
	stw_vi_ev’t_aùiÚ
{

233 
ev’t_hªdËr
 
hªdËr
;

234 
u32
 
ev’t
;

235 *
cÚ‹xt
;

236 
tw_vi_ev’t_aùiÚ_t
 *
Ãxt
;

239 
	stw_ch_vi_ev’t
{

240 
CHIP_VI_EVENT
 
ev’t
;

241 
u32
 
couÁ
;

242 
u32
 
unhªdËd
;

243 
u32
 
ev’t_æags
;

244 
¥šlock_t
 
lock
;

245 
tw_vi_ev’t_aùiÚ_t
 
aùiÚ
;

246 cÚ¡ *
Çme
;

249 
	stw_ch_vi_driv”
{

250 
©omic_t
 
İ’ed_æag
;

251 
ed_tcb_t
 
İ’ed_vi_ed
;

253 
dvm_ch_t
 *
ch
;

254 
CHIP_VI_STANDARD
 
video_¡ªd¬d
;

256 
u32
 
ev’t_æags
;

257 
u32
 
ev’t_tim”
;

258 
tw_ch_vi_ev’t_t
 
driv”_ev’t
[
CHIP_VI_EVENT_RESERVED
];

259 
tw_ch_vi_cÚfig_´İ”ty_t
 
video_´İ”ty
[
TW_VI_MAX_CHNL
];

261 
tw_ch_vi_İ”©iÚ_t
 *
İ
;

263 
tw_´oc_»gi¡”_s
 
vi_´oc
;

266 
š™_ch_vi_driv”
(
tw_£rviû_deviû
 *
tsd
, 
dvm_ch_t
 *
ch
);

267 
»move_ch_vi_driv”
(
tw_£rviû_deviû
 *
tsd
);

268 
tw5864_ch_vi_driv”_š™
(* 
·¿
);

269 
tw5864_ch_vi_driv”_»move
();

271 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_chip_vo.h

1 #iâdeà
_TW_CHIP_VO_H__


2 
	#_TW_CHIP_VO_H__


	)

4 #ifdeà
__ılu¥lus


9 
tw_vo_driv”
 
	ttw_vo_driv”_t
;

10 
tw_vo_İ”©iÚ
 
	ttw_vo_İ”©iÚ_t
;

12 
	stw_vo_İ”©iÚ
{

13 (*
š™
)(
tw_vo_driv”_t
 *);

14 (*
»£t
)(
tw_vo_driv”_t
 *);

15 (*
»Ëa£
)(
tw_vo_driv”_t
 *);

18 
	stw_vo_driv”
{

19 
©omic_t
 
İ’ed_æag
;

20 
ed_tcb_t
 
İ’ed_vo_ed
;

22 
dvm_ch_t
 *
ch
;

23 
CHIP_VI_STANDARD
 
video_¡ªd¬d
;

25 
tw_vo_İ”©iÚ_t
 *
İ
;

26 
tw_´oc_»gi¡”_s
 
vo_´oc
;

29 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_codec_common.h

1 #iâdeà
__TW_CODEC_COMMON_H__


2 
	#__TW_CODEC_COMMON_H__


	)

4 #ifdeà
__ılu¥lus


10 
	#TW_CODEC_CHAN_REQUEST_MEM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 243, )

	)

11 
	#TW_CODEC_CHAN_RELEASE_MEM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 242, )

	)

12 
	#TW_CODEC_CHAN_DISCAED_FRAME
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 244, )

	)

13 
	#TW_CODEC_CHAN_FLUSH
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 150, )

	)

14 
	#TW_CODEC_CHAN_CHANG_MODE
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 151, )

15 
	#TW_CODEC_CHAN_TS_RESYNC
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 152, )

	)

16 
	#TW_CODEC_CHAN_AVSYNC_BIND
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 153, )

17 

	)

19 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_common.h

18 #iâdeà
_TW_COMMON_H__


19 
	#_TW_COMMON_H__


	)

21 #ifdeà
__ılu¥lus


27 
ID_SYS
,

28 
ID_VB
,

29 
ID_VI
,

30 
ID_VO
,

31 
ID_H264E
,

32 
ID_H264D
,

33 
ID_JPEG
,

34 
ID_AUDIO_ENC
,

35 
ID_AUDIO_DEC
,

36 
ID_END
,

37 }
	tSYSTEM_ID_U
;

39 
	#DRIVER_VERSION
 "TW5864_0.1"

	)

41 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_common_err.h

1 #iâdeà
_TW_COMMON_ERR_H__


2 
	#_TW_COMMON_ERR_H__


	)

4 #ifdeà
__ılu¥lus


9 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_decode_sync.h

1 #iâdeà
__TW_DECODE_SYNC_H__


2 
	#__TW_DECODE_SYNC_H__


	)

4 #ifdeà
__ılu¥lus


9 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_devices.h

1 #iâdeà
DVM4000I_H


2 
	#DVM4000I_H


	)

4 #ifdeà
__ılu¥lus


9 
	#DEV_NAME_LEN
 32

	)

10 
	sdvm_video_deviû
{

11 
Çme
[
DEV_NAME_LEN
];

12 
deviû_id
;

13 
deviû_ty³
;

14 
deviû_¡©e
;

15 
£m­hÜe
 
deviû_lock
;

16 
dvm_ch_t
 *
ch
;

17 
video_deviû
 
vfd
;

19 
li¡_h—d
 
deviû_li¡
;

20 (*
»gi¡”_deviû
)(
ch_»gi¡”_t
 *, 
dvm_video_deviû_t
 *);

21 (*
uÄegi¡”_deviû
)(
ch_»gi¡”_t
 *, 
dvm_video_deviû_t
 *);

22 
li¡_h—d
 
İ’ed_deviû_li¡
;

23 (*
»gi¡”_İ’ed_deviû
)(
dvm_ch_t
 *, 
dvm_video_deviû_t
 *);

24 (*
uÄegi¡”_İ’ed_deviû
)(
dvm_ch_t
 *, 
dvm_video_deviû_t
 *);

26 
¥šlock_t
 
deviû_m­_lock
;

27 *
£rviû_chª_driv”
;

28 (*
©ch_£rviû_chª_driv”
)(
dvm_video_deviû_t
 *, *);

29 (*
d‘ach_£rviû_chª_driv”
)(
dvm_video_deviû_t
 *);

30 
wa™_queue_h—d_t
 
wa™_pŞl
;

31 
ssize_t
 (*
»ad
)(
dvm_video_deviû_t
 *, 
__u£r
 *, 
size_t
 , 
loff_t
 *);

32 
ssize_t
 (*
wr™e
)(
dvm_video_deviû_t
 *, cÚ¡ 
__u£r
 *, 
size_t
 , 
loff_t
 *);

36 
dvm_video_deviû_»move
();

37 
dvm_video_deviû_š™
(
dvm_ch_t
 *, );

38 
dvm_video_group_»move
(
dvm_video_group_t
 *);

39 
dvm_video_group_š™
(
dvm_ch_t
 *, );

40 
»move_’code_chª
(
dvm_h264_’code_t
 *);

41 
’code_chª_š™
(
dvm_video_group_t
 *, );

43 
´oûss_¦iû_h—d”_»q
(
dvm_h264_’code_t
 *);

44 
´oûss_µs_»q
(
dvm_h264_’code_t
 *);

45 
´oûss_¥s_»q
(
dvm_h264_’code_t
 *);

47 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_endpoint.h

1 #iâdef 
TW_ENDPOINT


2 
	#TW_ENDPOINT


	)

4 #ifdeà
__ılu¥lus


9 
	#TW_OK
 (0)

	)

10 
	#TW_ERR
 (-1)

	)

12 
	eTW_ED_STATUS
{

13 
TW_ED_UNREGISTER
 = 0,

14 
TW_ED_CLOSED
,

15 
TW_ED_IDLE
,

16 
TW_ED_STANDBY
,

17 
TW_ED_SUSPEND
,

18 
TW_ED_RUNNING
,

19 
TW_ED_TRANSFERING


22 
	eTW_ED_EVENT
{

23 
TW_ED_CLOSE_EVENT
 = 0,

24 
TW_ED_TIMEOUT_EVENT
,

25 
TW_ED_SUSPEND_EVENT
,

26 
TW_ED_RESUME_EVENT
,

27 
TW_ED_OPEN_EVENT
,

28 
TW_ED_DELIVER_EVENT
,

31 
	#TW_ED_STATE_NUMBER
 (7)

	)

32 
	#TW_ED_EVENT_NUMBER
 (6)

	)

33 
	stw_ed_fsm_Œªsãr_³ndšg
{

34 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

35 
u32
 
şo£_³ndšg_æag
 : 1;

36 
u32
 
timeout_³ndšg_æag
 : 1;

37 
u32
 
su¥’d_³ndšg_æag
 : 1;

38 
u32
 
»sume_³ndšg_æag
 : 1;

39 
u32
 
İ’_³ndšg_æag
 : 1;

40 
u32
 
d–iv”_³ndšg_æag
 : 1;

41 
u32
 
’abË_¡©e_Œªsãr_æag
 : 1;

42 
u32
 
’abË_Œigg”_³ndšg_æag
 : 1;

43 
u32
 
Ãed_sync
 : 1;

44 
u32
 
»£rve
 : 23;

45 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

46 
u32
 
»£rve
 : 23;

47 
u32
 
Ãed_sync
 : 1;

48 
u32
 
’abË_Œigg”_³ndšg_æag
 : 1;

49 
u32
 
’abË_¡©e_Œªsãr_æag
 : 1;

50 
u32
 
d–iv”_³ndšg_æag
 : 1;

51 
u32
 
İ’_³ndšg_æag
 : 1;

52 
u32
 
»sume_³ndšg_æag
 : 1;

53 
u32
 
su¥’d_³ndšg_æag
 : 1;

54 
u32
 
timeout_³ndšg_æag
 : 1;

55 
u32
 
şo£_³ndšg_æag
 : 1;

61 (*
fsm_Œªsãr_aùiÚ
)(
	ttw_ed_fsm_t
 *, *
	tcÚ‹xt
);

62 
	sfsm_¡©e_Œªsãr_m©rix_bË
{

63 
fsm_Œªsãr_aùiÚ
 
aùiÚ
[
TW_ED_STATE_NUMBER
][
TW_ED_EVENT_NUMBER
];

64 
fsm_Œªsãr_aùiÚ
 
sync_hook
;

67 
	stw_ed_fsm_İ”©iÚ
{

68 (*
š™
)(
tw_ed_fsm_t
 *);

69 (*
»£t
)(
tw_ed_fsm_t
 *);

70 (*
»gi¡”_bË
)(
tw_ed_fsm_t
 *, 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *, *);

71 (*
uÄegi¡”_bË
)(
tw_ed_fsm_t
 *);

72 (*
upd©e_Ãed_sync_hook
)(
tw_ed_fsm_t
 *, 
’
);

73 (*
upd©e_’abË_¡©e_Œªsãr
)(
tw_ed_fsm_t
 *, 
’
);

74 (*
upd©e_’abË_Œigg”_³ndšg_ev’t
)(
tw_ed_fsm_t
 *, 
’
);

75 (*
chªge_¡©e
)(
tw_ed_fsm_t
 *, 
TW_ED_STATUS
 
¡©e
);

76 (*
»q_fsm_ev’t
)(
tw_ed_fsm_t
 *, 
TW_ED_EVENT
 
ev’t
);

77 (*
ack_fsm_ev’t
)(
tw_ed_fsm_t
 *, 
TW_ED_EVENT
 
ev’t
);

78 (*
g’_fsm_ev’t
)(
tw_ed_fsm_t
 *, 
TW_ED_EVENT
 
ev’t
);

79 (*
Œªsãr
)(
tw_ed_fsm_t
 *, 
TW_ED_EVENT
 
ev’t
);

80 (*
g‘_cu¼_¡©e
)(
tw_ed_fsm_t
 *);

81 (*
g‘_Ï¡_¡©e
)(
tw_ed_fsm_t
 *);

84 
	stw_ed_fsm
{

85 
Ï¡_¡©e
, 
cu¼_¡©e
;

86 *
cÚ‹xt
;

87 
¥šlock_t
 
lock
;

88 
tw_ed_fsm_Œªsãr_³ndšg
 
Œªsãr_³ndšg
;

89 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *
bË
;

91 
tw_ed_fsm_İ”©iÚ
 *
İ
;

94 
	eTW_DIRECTION
{

95 
TW_READ
 = 0,

96 
TW_WRITE


99 
	eTW_ED_BUS_ID
{

100 
TW_ED_HOST_BUS
 = 0,

101 
TW_ED_PCI_BUS
,

102 
INVALID_TW_ED_BSU_ID


105 
	eTW_ED_TYPE_ID
{

106 
TW_ED_CONTROL
 = 0,

107 
TW_ED_VIDEO_ENCODE_IN
,

108 
TW_ED_VIDEO_PREVIEW_IN
,

109 
TW_ED_VIDEO_ENCODE_OSD_OUT
,

110 
TW_ED_VIDEO_DECODE_OUT
,

111 
TW_ED_VIDEO_PREVIEW_OUT
,

112 
TW_ED_VIDEO_DECODE_OSG_OUT
,

113 
TW_ED_AUDIO_ENCODE_IN
,

114 
TW_ED_AUDIO_DECODE_OUT
,

115 
INVALID_TW_ED_TYPE_ID


118 
	#BUS_NUMBER_MASK
 (0xf)

	)

119 
	#CHIP_NUMBER_MASK
 (0xf)

	)

120 
	#TYPE_NUMBER_MASK
 (0xf)

	)

121 
	#GROUP_CHAN_NUMBER_MASK
 (0x3ff)

	)

122 
	#LOGIC_CHAN_NUMBER_MASK
 (0x3ff)

	)

123 
	s’dpošt_id
{

124 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

125 
u32
 
bus_id
:4;

126 
u32
 
ch_id
:4;

127 
u32
 
ty³_id
:4;

128 
u32
 
group_chª_id
:10;

129 
u32
 
logic_chª_id
:10;

130 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

131 
u32
 
logic_chª_id
:10;

132 
u32
 
group_chª_id
:10;

133 
u32
 
ty³_id
:4;

134 
u32
 
ch_id
:4;

135 
u32
 
bus_id
:4;

141 
	#to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
node
è
	`cÚš”_of
Òode, 
ed_tcb_t
, 
ed
)

	)

142 
	#to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
node
è
	`cÚš”_of
Òode, 
ed_tcb_t
, 
ed_fsm
)

	)

143 
	s’dpošt_tcb
{

144 
ed_id
 
id
;

145 
©omic_t
 
¡©e
;

146 
tw_ed_fsm_t
 
ed_fsm
;

147 
tw_»gi¡”_node_t
 
ed
;

149 
tw_hcd_š‹rçû_İ”©iÚ
 *
İ
;

152 
	shcd_š‹rçû_İ”©iÚ
{

153 (*
İ’
)(
ed_tcb_t
 *);

154 (*
şo£
)(
ed_tcb_t
 *);

155 (*
su¥’d
)(
ed_tcb_t
 *);

156 (*
»sume
)(
ed_tcb_t
 *);

157 (*
ioùl
)(
ed_tcb_t
 *, , );

158 (*
g‘_¡©e
)(
ed_tcb_t
 *);

161 
driv”_Œigg”_³ndšg_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
’
);

162 
driv”_g’_şo£_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

163 
driv”_g’_timeout_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

164 
driv”_g’_su¥’d_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

165 
driv”_g’_»sume_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

166 
driv”_g’_İ’_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

167 
driv”_g’_d–iv”_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
);

171 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_h264_encode.h

1 #iâdef 
TW_H264_ENCODE_H


2 
	#TW_H264_ENCODE_H


	)

4 #ifdeà
__ılu¥lus


9 
	#AD_IS_READY
 (1)

	)

10 
	#SLICEHEAD_IS_READY
 (2)

	)

11 
	#HAVE_HARDWARE_BUF_CACHE
 (4)

	)

12 
	#DEV_CAN_SERVICE
 (3)

	)

13 
	#FIRST_START_DISCARD_FRAME_NUMBER
 (4)

	)

14 
	#ENCODE_CHAN_TIMEOUT
 (100/
MS_PER_TICK
)

	)

15 
	#ENCODE_CHAN_MONITOR_COUNTER
 (1)

	)

16 
	#TIMER_1MS
 (1/
MS_PER_TICK
)

	)

17 
	#TIMER_5MS
 (5/
MS_PER_TICK
)

	)

18 
	#TIMER_40MS
 (40/
MS_PER_TICK
)

	)

19 
	#TIMER_200MS
 (200/
MS_PER_TICK
)

	)

20 
	#TIMER_500MS
 (500/
MS_PER_TICK
)

	)

21 
	#TIMER_1_SECOND
 (1000/
MS_PER_TICK
)

	)

22 
	#TIMER_1_MINUTE
 (60000/
MS_PER_TICK
)

	)

24 
	#VLC_STATUS_NULL
 (0)

	)

25 
	#VLC_STATUS_NEED_PROCESS
 (1)

	)

26 
	#VLC_STATUS_OVER
 (2)

	)

27 
	#VLC_NO_PACKET_BUF
 (3)

	)

29 
	#READ_H264_BITSTREAM_BY_RAM
 (0)

	)

30 
	#READ_H264_BITSTREAM_BY_DDR
 (1)

	)

32 
	#VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
 (1)

	)

33 
	#VIDEO_LOGIC_MASTER_OR_SUB_MASK
 (1)

	)

34 
	#VD_CHANNEL_VALID
 (0x9000)

	)

35 
	#VD_CHANNEL_SWITCH
 (0x9004)

	)

36 
	#VD_CHANNEL_DOWNSAMPLE
 (0x9008)

	)

37 
	#VD_CHANNEL_INTERLACE
 (0x900c)

	)

38 
	#VD_BUS_MAX_CHANNEL
 (0x9010)

	)

39 
	#VD_BUS_MAX_LINE0
 (0x9014)

	)

40 
	#VD_BUS_MAX_LINE1
 (0x9018)

	)

41 
	#VD_CHANNEL_FORMAT0
 (0x9020)

	)

42 
	#VD_CHANNEL_FORMAT1
 (0x9024)

	)

43 
	#VD_CHANNEL_LMAP
(
pos
è(0x9100 + (posè* (è* 2)

	)

44 
	#VD_CHANNEL_HMAP
(
pos
è(0x9100 + (posè* (è* 2 + ())

	)

45 
	#VD_BUS_MAP
(
bus
è(0x9200 + (busè* ())

	)

47 
tw_h264_’code_ã©u»_·¿m
 
	ttw_h264_’code_ã©u»_·¿m_t
;

48 
tw_h264_’code_ã©u»
 
	ttw_h264_’code_ã©u»_t
;

49 
tw_h264_’code_ã©u»_İ”©iÚ
 
	ttw_h264_’code_ã©u»_İ”©iÚ_t
;

50 
tw_h264_’code_rc
 
	ttw_h264_’code_rc_t
;

51 
tw_h264_’code_rc_·¿m
 
	ttw_h264_’code_rc_·¿m_t
;

52 
tw_h264_’code_d–
 
	ttw_h264_’code_d–_t
;

53 
	eTW_VIDEO_SIZE
{

54 
TW_VIDEO_SIZE_QCIF
 = 0,

55 
TW_VIDEO_SIZE_QHALF_D1
,

56 
TW_VIDEO_SIZE_CIF
,

57 
TW_VIDEO_SIZE_HALF_D1
,

58 
TW_VIDEO_SIZE_D1
,

59 
TW_VIDEO_SIZE_USER
,

62 
	eTW_VIDEO_STANDARD
{

63 
TW_VIDEO_STANDARD_PAL
,

64 
TW_VIDEO_STANDARD_NTSC
,

65 
TW_VIDEO_STANDARD_USER_DEFINE
,

68 
	eTW_H264_RC_TYPE
{

69 
TW_H264_NO_RC
,

70 
TW_H264_CBR
,

71 
TW_H264_VBR
,

74 
	eTW_RC_IMAGE_PRIORITY
{

75 
TW_RC_IMAGE_QUALITY_FIRST
 = 0,

76 
TW_RC_IMAGE_SMOOTH_FIRST
,

79 
	eTW_CROSS_BUS_WORK_MODE
{

80 
TW_CROSS_BUS_4D1_REALTIME
 = 0,

81 
TW_CROSS_BUS_8H®fD1_REALTIME
,

82 
TW_CROSS_BUS_16CIF_REALTIME
,

83 
TW_CROSS_BUS_UNREALTIME
,

86 
	stw_time¡amp_İ”©iÚ
{

87 (*
š™
)(
tw_time¡amp_t
 *);

88 (*
»£t
)(
tw_time¡amp_t
 *);

89 (*
£t_time¡amp
)(
tw_time¡amp_t
 *, 
time¡amp
, *
ÿÎ_â_Çme
);

90 
u32
 (*
g‘_time¡amp
)(
tw_time¡amp_t
 *);

93 
	stw_time¡amp
{

94 
©omic_t
 
fœ¡_sync
;

95 
Ï¡_tim”_couÁ
, 
cu¼_tim”_couÁ
;

96 
tÙ®_d–_tim”_couÁ
;

98 
tw_time¡amp_İ”©iÚ
 *
İ
;

102 
	#DVM_CODEC_GET_VIDEO_ENCODER_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 0, )

	)

103 
	#DVM_CODEC_SET_VIDEO_ENCODER_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 1, )

	)

105 
	#DVM_CODEC_SET_VIDEO_TIMESTAMP_BASE
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 2, )

	)

106 
	#DVM_CODEC_GET_VIDEO_TIMESTAMP_BASE
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 3, )

	)

109 
	#DVM_MOTION_DECTION_GET_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 4, )

	)

110 
	#DVM_MOTION_DECTION_SET_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 5, )

	)

113 
	#TW_LOGIC_CHAN_OSD_GET_PARAM
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 6, )

	)

114 
	#TW_LOGIC_CHAN_OSD_SET_PARAM
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 7, )

	)

115 
	#TW_H264_ENCODE_CHAN_MAP_GET
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 8, )

	)

116 
	#TW_LOGIC_CHAN_ENABLE_SET
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 9, )

	)

117 
	#TW_LOGIC_CHAN_DISABLE_SET
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 10, )

	)

118 
	#TW_H264_ENCODE_FEATURE_SET
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 11, )

	)

119 
	#TW_H264_ENCODE_FEATURE_GET
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 12, )

	)

121 
	#TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
 0x00000001

	)

122 
	#TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_SKIP_MASK
 0x00000002

	)

123 
	#TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_I_4X4_MASK
 0x00000004

	)

124 
	#TW_H264_ENABLE_CHANGE_HALF_PIXEL_MASK
 0x00000008

	)

125 
	#TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_QUARTER_PIXEL_MASK
 0x00000010

	)

126 
	#TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_MB_DELAY_MASK
 0x00000020

	)

128 
	#TW_H264_FEATURE_ON
 1

	)

129 
	#TW_H264_FEATURE_OFF
 0

	)

131 
	#TW_H264_ENCODE_RC_SET
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 13, )

	)

132 
	#TW_H264_ENCODE_RC_GET
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 14, )

	)

133 
	#TW_H264_ENCODE_RC_PARAM_SET
 
	`_IOW
(
TW_CODEC_IOC_MAGIC
, 15, )

	)

134 
	#TW_H264_ENCODE_RC_PARAM_GET
 
	`_IOR
(
TW_CODEC_IOC_MAGIC
, 16, )

	)

136 
	#TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
 0x00000001

	)

137 
	#TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
 0x00000002

	)

138 
	#TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
 0x00000004

	)

140 
	stw_h264_chª_m­_šfo
{

141 
u16
 
i_logic_chª_id
;

142 
u16
 
i_phy_chª_id
;

145 
	stw_h264_’code_rc
{

146 
u32
 
chªge_mask_æag
;

147 
u32
 
e_rc_ty³
;

148 
u32
 
e_image_´iÜ™y
;

149 
u32
 
i_deçuÉ_qp
;

152 
	stw_h264_’code_rc_·¿m
{

153 
u32
 
e_rc_ty³
;

154 
u8
 
rc_·¿m
[0];

157 
	stw_h264_’code_ã©u»_·¿m
{

158 
u32
 
chªge_mask_æag
;

159 
u8
 
b_’abË_deš‹¾aû
;

160 
u8
 
b_’abË_sk
;

161 
u8
 
b_’abË_I_4X4
;

162 
u8
 
b_’abË_h®f_pix–
;

163 
u8
 
b_’abË_qu¬‹r_pix–
;

164 
u32
 
i_mb_d–ay_v®ue
;

167 
	stw_h264_’code_ã©u»_İ”©iÚ
{

168 (*
š™
)(
tw_h264_’code_ã©u»_t
 *);

169 (*
»£t
)(
tw_h264_’code_ã©u»_t
 *);

171 (*
upd©e_deš‹¾aû
)(
tw_h264_’code_ã©u»_t
 *, );

172 (*
g‘_deš‹¾aû
)(
tw_h264_’code_ã©u»_t
 *);

173 (*
upd©e_sk
)(
tw_h264_’code_ã©u»_t
 *, );

174 (*
g‘_sk
)(
tw_h264_’code_ã©u»_t
 *);

175 (*
upd©e_i_4x4
)(
tw_h264_’code_ã©u»_t
 *, );

176 (*
g‘_i_4x4
)(
tw_h264_’code_ã©u»_t
 *);

177 (*
upd©e_h®f_pix–
)(
tw_h264_’code_ã©u»_t
 *, );

178 (*
g‘_h®f_pix–
)(
tw_h264_’code_ã©u»_t
 *);

179 (*
upd©e_qu¬‹r_pix–
)(
tw_h264_’code_ã©u»_t
 *, );

180 (*
g‘_qu¬‹r_pix–
)(
tw_h264_’code_ã©u»_t
 *);

181 (*
upd©e_mb_d–ay
)(
tw_h264_’code_ã©u»_t
 *, 
u32
);

182 
u32
 (*
g‘_mb_d–ay
)(
tw_h264_’code_ã©u»_t
 *);

185 
	stw_h264_’code_ã©u»
{

186 
tw_h264_’code_ã©u»_·¿m_t
 
ã©u»_·¿m
;

187 
tw_h264_’code_ã©u»_İ”©iÚ
 *
İ
;

190 
	eTW5864_ENCODE_CONFIG_CHANGED_MASK


192 
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
 = 0x00000001,

193 
TW5864_ENCODE_CONFIG_ENABLE_DEINTERLACE_CHANGED
 = 0x00000002,

194 
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
 = 0x00000004,

195 
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
 = 0x00000008,

196 
TW5864_ENCODE_CONFIG_FPS_CHANGED
 = 0x00000010,

197 
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
 = 0x00000020,

198 
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
 = 0x00000040,

199 
TW5864_ENCODE_CONFIG_RCTYPE_CHANGED
 = 0x00000080,

200 
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
 = 0x00000100,

201 
TW5864_ENCODE_CONFIG_QPI_CHANGED
 = 0x00000200,

202 
TW5864_ENCODE_CONFIG_QPP_CHANGED
 = 0x00000400,

203 
TW5864_ENCODE_CONFIG_QPB_CHANGED
 = 0x00000800,

206 
	#TW_h264_ENCODER_PARAM_BPS_MASK
 0x0001

	)

207 
	#TW_h264_ENCODER_PARAM_FPS_MASK
 0x0002

	)

208 
	#TW_h264_ENCODER_PARAM_IP_STRIDE_MASK
 0x0004

	)

209 
	#TW_h264_ENCODER_PARAM_PB_STRIDE_MASK
 0x0008

	)

210 
	#TW_h264_ENCODER_PARAM_GOP_MASK
 0x0010

	)

211 
	#TW_h264_ENCODER_PARAM_FORCE_I_MASK
 0x0020

	)

212 
	#TW_h264_ENCODER_PARAM_WIDTH_MASK
 0x0040

	)

213 
	#TW_h264_ENCODER_PARAM_HEIGHT_MASK
 0x0080

	)

215 
	stw_h264_’code_·¿m
{

216 
u32
 
chªge_mask_æag
;

217 
u32
 
i_bps
;

218 
u32
 
i_ås
;

219 
u32
 
i_I_P_¡ride
;

220 
u32
 
i_P_B_¡ride
;

221 
u32
 
i_gİ_v®ue
;

222 
u32
 
b_fÜû_I_æag
;

223 
u16
 
i_logic_video_width_mb_size
;

224 
u16
 
i_logic_video_height_mb_size
;

227 
	#TW5864_ENCODE_CONFIG_MASKALL
 (0xfff)

	)

228 
	#TW_ENCODE_PROPERTY_CHANGED
 (1)

	)

229 
	#TW_ENCODE_PROPERTY_NO_CHANGED
 (0)

	)

231 
	stw_h264_’code_cÚfigu¿tiÚ


233 
u32
 
chªgedMask
;

234 
TW_VIDEO_STANDARD
 
videoSnd¬d
;

235 
’abËSubm™MÙiÚVeùÜ
;

236 
’abËMÙiÚVeùÜAÇly£s
;

237 
TW_VIDEO_SIZE
 
’codeSize
;

238 
width
;

239 
height
;

240 
b™¿‹
;

241 
ås
;

242 
keyF¿meIÁ”v®s
;

243 
gİIÁ”v®s
;

244 
´i
;

245 
Ëá_pix–_x
, 
Ëá_pix–_y
;

246 
right_pix–_x
, 
right_pix–_y
;

247 
imageLev–
;

248 
qpi
;

249 
qµ
;

250 
qpb
;

253 
	stw_h264_’code_´İ”ty_İ”©iÚ
{

254 (*
upd©e_’code_´İ”ty
)(
tw_h264_’code_´İ”ty_t
 *, 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
cÚfig_·¿m
);

255 (*
is_videoSnd¬d_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

256 (*
g‘_videoSnd¬d
)(
tw_h264_’code_´İ”ty_t
 *);

257 (*
is_’codeSize_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

258 (*
g‘_’codeSize
)(
tw_h264_’code_´İ”ty_t
 *);

259 (*
g‘_’codeSize_width
)(
tw_h264_’code_´İ”ty_t
 *);

260 (*
g‘_’codeSize_height
)(
tw_h264_’code_´İ”ty_t
 *);

261 (*
is_rg‘_b™¿‹_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

262 (*
g‘_rg‘_b™¿‹
)(
tw_h264_’code_´İ”ty_t
 *);

263 (*
is_rg‘_ås_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

264 (*
g‘_rg‘_ås
)(
tw_h264_’code_´İ”ty_t
 *);

265 (*
is_keyF¿meIÁ”v®s_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

266 (*
g‘_keyF¿meIÁ”v®s
)(
tw_h264_’code_´İ”ty_t
 *);

267 (*
is_gİIÁ”v®s_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

268 (*
g‘_gİIÁ”v®s
)(
tw_h264_’code_´İ”ty_t
 *);

269 (*
is_rcTy³_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

270 (*
g‘_rcTy³
)(
tw_h264_’code_´İ”ty_t
 *);

271 (*
is_ŸmgeLev–_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

272 (*
g‘_ŸmgeLev–
)(
tw_h264_’code_´İ”ty_t
 *);

273 (*
is_qpi_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

274 (*
g‘_qpi
)(
tw_h264_’code_´İ”ty_t
 *);

275 (*
is_qµ_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

276 (*
g‘_qµ
)(
tw_h264_’code_´İ”ty_t
 *);

277 (*
is_qpb_chªged
)(
tw_h264_’code_´İ”ty_t
 *);

278 (*
g‘_qpb
)(
tw_h264_’code_´İ”ty_t
 *);

281 
	stw_h264_’code_´İ”ty
{

282 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_´İ”ty
;

283 
tw_h264_’code_ã©u»_t
 
’code_ã©u»
;

284 
tw_h264_’code_rc_t
 
’code_rc
;

285 
¥šlock_t
 
lock
;

286 
tw_h264_’code_´İ”ty_İ”©iÚ
 *
İ
;

289 
	stw_vd_Üig_buf_šfo_İ”©iÚ
{

290 (*
š™
)(
tw_vd_Üig_buf_šfo_t
 *, 
¦Ù_id
);

291 (*
fœ¡_sync_Üig_buf_šfo
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
);

292 (*
vd_Üig_buf_»ady
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

293 (*
g‘_vd_ad_phy_±r
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
);

294 (*
£t_vd_upd©e_Üig_buf_»g
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
);

295 (*
£t_vd_cu¼_’code_±r
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
);

296 (*
upd©e_vd_’code_±r
)(
tw_vd_Üig_buf_šfo_t
 *);

297 (*
upd©e_time¡amp
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
);

298 
u32
 (*
g‘_time¡amp
)(
tw_vd_Üig_buf_šfo_t
 *);

299 (*
soáw¬e_disÿrd_äame
)(
tw_vd_Üig_buf_šfo_t
 *, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *);

300 (*
’code_’dof¦iû_nÙify
)(
tw_vd_Üig_buf_šfo_t
 *, 
tw_h264_logic_’code_chª_t
 *);

301 (*
’code_uÄegi¡”_nÙify
)(
tw_vd_Üig_buf_šfo_t
 *, 
tw_h264_logic_’code_chª_t
 *);

304 
	stw_vd_Üig_buf_šfo
{

305 
©omic_t
 
¡İ_check_ad
;

306 
¥šlock_t
 
lock
;

307 
phy_¦Ù_id
;

308 
fœ¡_¡¬t_disÿrd_äame_numb”
;

309 
u32
 
vd_Üig_ad_phy_±r
;

310 
u32
 
vd_upd©e_Üig_ad_phy_±r
;

311 
u32
 
vd_’code_±r
;

312 
tw_time¡amp_t
 
vd_’code_time¡amp
;

313 
vd_±r_check_couÁ
;

314 
u32
 
logic_chª_ad_»ady_m­_bË
;

315 
u32
 
logic_chª_’code_ov”_m­_bË
;

317 
tw_vd_Üig_buf_šfo_İ”©iÚ
 *
İ
;

320 
tw_ad­tive_deš‹¾aû_cÚŒŞ
;

321 
	stw_ad­tive_deš‹¾aû_cÚŒŞ_İ”©iÚ
{

322 (*
š™
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *);

323 (*
»£t
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *);

325 (*
adju¡_£ns™ive
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *, 
u32
);

326 (*
upd©e
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *);

327 (*
d‘eù
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *, 
dvm_ch_t
 *
ch
, 
u32
);

328 (*
ischªge
)(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *);

331 
	stw_ad­tive_deš‹¾aû_cÚŒŞ
{

332 
u32
 
Ï¡_æags
;

333 
u32
 
cu¼_æags
;

335 
u32
 
£ns™ive
;

336 
u32
 
’abË
;

338 
tw_ad­tive_deš‹¾aû_cÚŒŞ_İ”©iÚ
 *
İ
;

341 
	stw_h264_phy_video_¦Ù_İ”©iÚ
{

342 (*
š™
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
phy_¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
);

343 (*
¦Ù_»£t
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
);

344 (*
¦Ù_soáw¬e_disÿrd_äame
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

345 (*
¦Ù_ad_is_»ady
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

346 (*
¦Ù_fœ¡_¡¬t
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
);

347 (*
¦Ù_’d_¡İ
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

348 (*
£t_¦Ù_’code_±r
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

349 
u32
 (*
g‘_time¡amp
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
);

350 (*
’code_’dof¦iû_nÙify
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

351 (*
’code_uÄegi¡”_nÙify
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

352 (*
upd©e_m­_logic_¦Ù
)(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
m­_logic_id
, 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
);

353 (*
g‘_video_size
)(
tw_h264_phy_video_¦Ù_t
 *);

354 (*
£t_video_size
)(
tw_h264_phy_video_¦Ù_t
 *, 
TW_VIDEO_SIZE
 
video_size
);

355 (*
g‘_phy_¦Ù_by_phy_¦Ù_id
)(
dvm_ch_t
 *, 
phy_¦o_id
, 
tw_h264_phy_video_¦Ù_t
 **);

358 
	stw_h264_phy_video_¦Ù
{

360 
©omic_t
 
fœ¡_¡¬t_æag
;

361 
phy_¦Ù_id
;

362 
phy_bus_id
;

363 
m­_logic_id
;

364 
tw_h264_logic_video_¦Ù_t
 *
üoss_bus_logic_video_¦Ù
;

365 
tw_vd_Üig_buf_šfo_t
 
vd_Üig_buf
;

366 
TW_VIDEO_SIZE
 
video_size
;

368 
tw_h264_phy_video_¦Ù_İ”©iÚ
 *
İ
;

370 
tw_»gi¡”_bË_t
 
logic_chª_bË
;

371 
tw_»gi¡”_bË_t
 
İ’ed_logic_chª_bË
;

373 
tw_ad­tive_deš‹¾aû_cÚŒŞ
 
deš‹¾aû
;

375 
’code_chª_mÚ™Ü_timeid
;

376 (*
¡¬t_’code_chª_mÚ™Ü_hook
)(
tw_h264_phy_video_¦Ù_t
 *);

377 (*
d–‘e_’code_chª_mÚ™Ü_hook
)(
tw_h264_phy_video_¦Ù_t
 *);

380 
	stw_h264_logic_video_¦Ù_İ”©iÚ
{

381 (*
š™
)(
tw_h264_logic_video_¦Ù_t
 *, 
logic_¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
);

382 (*
£t_m­PhySlÙId
)(
tw_h264_logic_video_¦Ù_t
 *, 
phy_¦Ù_id
);

383 (*
g‘_m­PhySlÙId
)(
tw_h264_logic_video_¦Ù_t
 *, 
phy_¦Ù
);

384 (*
£t_disÿrdTabË
)(
tw_h264_logic_video_¦Ù_t
 *, 
u32
 
disÿrdTabË
);

385 
u32
 (*
g‘_disÿrdTabË
)(
tw_h264_logic_video_¦Ù_t
 *);

386 (*
£t_roundTabËSŒide
)(
tw_h264_logic_video_¦Ù_t
 *, 
roundTabËSŒide
);

387 (*
g‘_roundTabËSŒide
)(
tw_h264_logic_video_¦Ù_t
 *);

388 (*
ş—r_ÃedUpd©eFÏg
)(
tw_h264_logic_video_¦Ù_t
 *);

389 (*
g‘_ÃedUpd©eFÏg
)(
tw_h264_logic_video_¦Ù_t
 *);

390 (*
g‘_video_size
)(
tw_h264_logic_video_¦Ù_t
 *);

391 (*
£t_video_size
)(
tw_h264_logic_video_¦Ù_t
 *, 
TW_VIDEO_SIZE
 
video_size
);

392 
u32
 (*
g‘_ås
)(
tw_h264_logic_video_¦Ù_t
 *);

393 (*
£t_ås
)(
tw_h264_logic_video_¦Ù_t
 *, 
u32
);

394 
u32
 (*
g‘_’abË¦Ù
)(
tw_h264_logic_video_¦Ù_t
 *);

395 (*
£t_’abË¦Ù
)(
tw_h264_logic_video_¦Ù_t
 *, 
u32
 );

397 (*
£t_ch_’d_logic_video_¦Ù_·¿m
)(
tw_h264_logic_video_¦Ù_t
 *, 
dvm_ch_t
 *);

398 
u32
 (*
g‘_ch_’d_logic_video_¦Ù_·¿m
)(
tw_h264_logic_video_¦Ù_t
 *, 
dvm_ch_t
 *);

401 
	stw_h264_logic_video_¦Ù
{

402 
u32
 
logicSlÙId
;

403 
u32
 
m­PhySlÙId
;

404 
u32
 
’abËSlÙ
;

405 
u32
 
¦ÙFps
;

406 
u32
 
disÿrdTabË
;

407 
u32
 
roundTabËSŒide
;

408 
u32
 
hÜ_»v”£
;

409 
u32
 
v”_»v”£
;

410 
TW_VIDEO_SIZE
 
video_size
;

411 
©omic_t
 
ÃedUpd©eFÏg
;

413 
tw_h264_logic_video_¦Ù_İ”©iÚ
 *
İ
;

416 
	svd_chª_m­_šfo
{

417 
u32
 
phy_¦Ù_id
;

418 
u32
 
m­_logic_¦Ù_id
;

419 
u32
 
’abË
;

420 
u32
 
ås
;

421 
u32
 
roundTabËSŒide
;

422 
TW_VIDEO_SIZE
 
video_size
;

423 
u32
 
logic_¦Ù_disÿrd_bË
;

426 
	stw5864_vd_üoss_bus_İ”©iÚ
{

427 (*
š™
)(
tw5864_vd_üoss_bus_t
 *, 
TW_CROSS_BUS_WORK_MODE
 
mode
, 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
);

428 (*
»£t
)(
tw5864_vd_üoss_bus_t
 *);

429 (*
g‘_logic_video_¦Ù_by_logic_id
)(
tw5864_vd_üoss_bus_t
 *, 
logic_¦Ù_id
, 
tw_h264_logic_video_¦Ù_t
 **);

430 (*
g‘_logic_video_¦Ù_by_phy_id
)(
tw5864_vd_üoss_bus_t
 *, 
¦Ù_id
, 
tw_h264_logic_video_¦Ù_t
 **);

431 (*
g‘_phy_video_¦Ù_by_logic_id
)(
tw5864_vd_üoss_bus_t
 *, 
logic_¦Ù_id
, 
tw_h264_phy_video_¦Ù_t
 **);

432 (*
g‘_phy_video_¦Ù_by_phy_id
)(
tw5864_vd_üoss_bus_t
 *, 
¦Ù_id
, 
tw_h264_phy_video_¦Ù_t
 **);

434 (*
g‘_wÜk_mode
)(
tw5864_vd_üoss_bus_t
 *);

435 (*
upd©e_wÜk_mode
)(
tw5864_vd_üoss_bus_t
 *, 
TW_CROSS_BUS_WORK_MODE
 
mode
);

437 (*
ÿlcuÏ‹_üoss_bus_m­_bË
)(
tw5864_vd_üoss_bus_t
 *, 
vd_chª_m­_šfo_t
 *);

438 (*
£t_ch_’d_üoss_bus
)(
tw5864_vd_üoss_bus_t
 *, 
dvm_ch_t
 *);

441 
	stw5864_vd_üoss_bus
{

442 
TW_CROSS_BUS_WORK_MODE
 
mode
;

443 
GROUP_MODE
 
bus_mode
[
TW_MAX_GRP
];

444 
disÿrd_¡ride_lim™
;

445 
tw_h264_logic_video_¦Ù_t
 
logic_video_¦Ù
[
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
];

446 
tw_h264_phy_video_¦Ù_t
 
phy_video_¦Ù
[
TW5864_PHY_VD_CHAN_NUMBER
];

448 
tw5864_vd_üoss_bus_İ”©iÚ
 *
İ
;

451 
	stw_h264_’code_cÚŒŞ_İ”©iÚ
{

452 (*
š™
)(
tw_h264_’code_cÚŒŞ_t
 *);

453 (*
»£t
)(
tw_h264_’code_cÚŒŞ_t
 *);

455 (*
£t_¥s
)(
tw_h264_’code_cÚŒŞ_t
*);

456 (*
£t_µs
)(
tw_h264_’code_cÚŒŞ_t
 *);

457 (*
£t_¦iû_h—d
)(
tw_h264_’code_cÚŒŞ_t
 *);

458 (*
g’”©Ü_h—d
)(
tw_h264_’code_cÚŒŞ_t
 *, 
tw_video_äame_tcb_t
 *
äame
);

460 (*
ÿlcuÏ‹_äame_ty³
)(
tw_h264_’code_cÚŒŞ_t
 *);

461 (*
g‘_äame_ty³
)(
tw_h264_’code_cÚŒŞ_t
 *);

462 (*
fÜû_I_äame
)(
tw_h264_’code_cÚŒŞ_t
 *);

463 (*
upd©e_©_’code_äame_ok
)(
tw_h264_’code_cÚŒŞ_t
 *);

464 (*
upd©e_©_disÿrd_äame
)(
tw_h264_’code_cÚŒŞ_t
 *);

465 (*
upd©e_©_’code_äame_”r
)(
tw_h264_’code_cÚŒŞ_t
 *);

466 (*
upd©e_image_»sŞutiÚ
)(
tw_h264_’code_cÚŒŞ_t
 *);

467 (*
upd©e_ås_disÿrd_bË
)(
tw_h264_’code_cÚŒŞ_t
 *, 
u32
 , u32);

469 (*
g‘_¦iû_h—d_ªd_ad_¡©us
)(
tw_h264_’code_cÚŒŞ_t
 *);

470 (*
ş—r_¦iû_h—d_ªd_ad_¡©us
)(
tw_h264_’code_cÚŒŞ_t
 *);

471 (*
upd©e_¦iû_h—d_»ady
)(
tw_h264_’code_cÚŒŞ_t
 *);

472 (*
ş—r_¦iû_h—d_»ady
)(
tw_h264_’code_cÚŒŞ_t
 *);

473 (*
upd©e_ad_»ady
)(
tw_h264_’code_cÚŒŞ_t
 *);

474 (*
ş—r_ad_»ady
)(
tw_h264_’code_cÚŒŞ_t
 *);

475 (*
g‘_ad_¡©us
)(
tw_h264_’code_cÚŒŞ_t
 *);

477 
u32
 (*
g‘_time¡amp
)(
tw_h264_’code_cÚŒŞ_t
 *);

478 (*
fœ¡_¡¬t
)(
tw_h264_’code_cÚŒŞ_t
 *);

479 (*
¡¬t_’code
)(
tw_h264_’code_cÚŒŞ_t
 *);

481 (*
œq_func
)(
œq
, *);

482 (*
»ad_vlc_·¿m
)(
tw_h264_’code_cÚŒŞ_t
 *, 
dvm_ch_t
 *
ch
);

483 (*
ÿlcuÏ‹_mov_·¿m
)(
tw_h264_’code_cÚŒŞ_t
 *, 
dvm_ch_t
 *
ch
);

484 (*
mov_vlc_codšg
)(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
);

485 (*
ch_pšg_pÚg_upd©e
)(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
);

486 (*
nÙify
)(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
);

487 (*
chª_ÿn_com¶‘e
)(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
);

490 
	stw_h264_’code_d–
{

491 
timev®
 
Ï¡_time
;

492 
timev®
 
cu¼_time
;

494 
u32
 
max_d–
;

495 
u32
 
cur_d–
;

496 
u32
 
mš_d–
;

498 
	stw_h264_’code_cÚŒŞ
 {

499 
©omic_t
 
¦iû_h—d_ªd_ad_¡©us
;

500 
äame_ty³
;

502 
©omic_t
 
’abË
;

504 
b_fÜû_i_äame
;

505 
u32
 
i_äameNumb”
;

506 
u32
 
i_äame_£rŸl
;

507 
i_¦iû_äame_num
;

508 
i_üossbus_ås
;

509 
i_soáw¬e_disÿrd_äame_bË
;

510 
i_disÿrd_äame_numb”
;

511 
i_äame_³r_£cÚd
;

512 
i_p_¡ride
;

513 
i_gİ_¡ride
;

514 
i_Œigg”_sync_couÁ”
;

515 
i_¡©i¡ic_mšu‹r_couÁ”
;

516 
ad_check
;

517 
ad_d–1
;

518 
ad_d–2
;

519 
ad_d–3
;

520 
u64
 
Ï¡_jiff›s
;

521 
u32
 
i_cu¼_ås
;

522 
u32
 
i_Şd_ås
;

523 
i_åm
;

524 
u32
 
i_ås
;

525 
ad_»ady
;

527 
i_Ï¡_idr
;

528 
i_idr_pic_id
;

529 
i_mb_x
;

530 
i_mb_y
;

531 
i_fœ¡_mb
;

532 
i_fœ¡_mb_x_ªd_y
;

533 
i_cu¼_Ïmda
;

534 
i_cu¼_qp
;

535 
i_vd_»ã»nû_±r
;

537 
u32
 
tÙ®_äame_Ën
;

538 
äame_ba£_addr
;

539 
£ùiÚ_numb”
;

540 
have_»cv_£ùiÚ_numb”
;

541 
£ùiÚ_Ën
;

542 
”_Ën
;

544 
h264_¥s_t
 
¥s_¬¿y
[1];

545 
h264_µs_t
 
µs_¬¿y
[1];

546 
h264_¦iû_h—d”_t
 
¦iû_h—d_¬¿y
[1];

547 
h264_¥s_t
 *
¥s
;

548 
h264_µs_t
 *
µs
;

549 
h264_¦iû_h—d”_t
 *
¦iû_h—d
;

551 
ov”æow
;

552 
u32
 
vlc_¡©us
;

553 
u32
 
vlcIÁrL’
;

555 
tw_h264_’code_d–_t
 
’code_d–
;

556 
tw_h264_’code_cÚŒŞ_İ”©iÚ
 *
İ
;

558 
’code_timeout_mÚ™Ü_timeid
;

559 (*
add_’code_timeout_hook
)(
tw_h264_’code_cÚŒŞ_t
 *);

560 (*
d–‘e_’code_timeout_hook
)(
tw_h264_’code_cÚŒŞ_t
 *);

562 
d–ay_»¡¬t_’code_timeid
;

563 (*
add_d–ay_»¡¬t_’code_hook
)(
tw_h264_’code_cÚŒŞ_t
 *);

564 (*
d–‘e_d–ay_»¡¬t_’code_hook
)(
tw_h264_’code_cÚŒŞ_t
 *);

567 
	eTW5864_REQ_TYPE
{

568 
DVM_CHIP_REQ_FIRST_STRAT_ENCODE_CHAN
,

569 
DVM_CHIP_REQ_START_ENCODE_CHAN
,

572 
	#to_g‘_’code_chª_£rviû_tcb_w™h_£rviû_tcb
(
node
è
	`cÚš”_of
Òode, 
’code_chª_£rviû_tcb_t
, 
£rviû_tcb
)

	)

573 
	s’code_chª_£rviû_tcb
{

574 
tcb_node_t
 
£rviû_tcb
;

575 
TW5864_REQ_TYPE
 
ty³
;

576 *
cÚ‹xt
;

577 (*
»q_ÿÎback
)(*
cÚ‹xt
);

580 
	sch_’code_chª_£rviû_queue_İ”©iÚ
{

581 (*
š™
)(
ch_’code_chª_£rviû_queue_t
 *);

582 (*
g‘_queue_cu¼_’Œy_numb”
)(
ch_’code_chª_£rviû_queue_t
 *);

583 (*
put_£rviû_»que¡_što_queue
)(
ch_’code_chª_£rviû_queue_t
 *, 
’code_chª_£rviû_tcb_t
 *);

584 (*
put_£rviû_»que¡_što_queue_h—d”
)(
ch_’code_chª_£rviû_queue_t
 *, 
’code_chª_£rviû_tcb_t
 *);

585 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
ch_’code_chª_£rviû_queue_t
 *);

586 (*
»Ëa£_cu¼_cÚsum”
)(
ch_’code_chª_£rviû_queue_t
 *);

587 (*
Œigg”_ch_³ndšg_£rviû_»que¡
)(
ch_’code_chª_£rviû_queue_t
 *);

590 
	sch_’code_chª_£rviû_queue
{

591 
¥šlock_t
 
lock
;

592 
©omic_t
 
h264_ma¡”_ÿn_»cv_numb”
;

593 
©omic_t
 
h264_ddr_ÿche_numb”
;

594 
tcb_node_queue_t
 
£rviû_queue_node
;

595 
’code_chª_£rviû_tcb_t
 *
cu¼_cÚsum”
;

597 
ch_’code_chª_£rviû_queue_İ”©iÚ
 *
İ
;

600 
	#to_g‘_tw_h264_’code_chª_w™h_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
logic_chª_ed
)

	)

601 
	#to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
İ’ed_logic_chª_ed
)

	)

602 
	#to_g‘_tw_h264_’code_chª_w™h_vd_»f
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
vd_»f
)

	)

603 
	#to_g‘_tw_h264_’code_chª_w™h_’code_´İ”ty
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
’code_´İ”ty
)

	)

604 
	#to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
’code_cÚŒŞ
)

	)

605 
	#to_g‘_tw_h264_’code_chª_w™h_osd_’gše
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
’code_osd_’gše
)

	)

606 
	#to_g‘_tw_h264_’code_chª_w™h_’code_»que¡_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_h264_logic_’code_chª_t
, 
’code_»que¡_tcb
)

	)

607 
	stw_h264_logic_’code_chª


609 
phy_¦Ù_id
;

610 
logic_chª_id
;

611 
ty³
;

612 
»ad_b™¡»am_mode
;

613 
©omic_t
 
İ’ed_æag
;

614 
©omic_t
 
have_d–iv”_sync_æag
;

615 
ed_tcb_t
 
logic_chª_ed
;

616 
ed_tcb_t
 
İ’ed_logic_chª_ed
;

617 
nÚblock_msg_tim”_id
[
REQ_MSG_NUMBER
];

618 
d–ay_msg_tim”_id
[
REQ_MSG_NUMBER
];

620 
dvm_ch_t
 *
ch
;

621 
tw5864_avSync_dev_t
 *
tw_deviû_chª
;

622 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

624 
tw_h264_’code_´İ”ty_t
 
’code_´İ”ty
;

625 
tw_h264_’code_cÚŒŞ_t
 
’code_cÚŒŞ
;

626 #ifdeà 
OSD_MODULE


627 
osd_chª_’gše_t
 
’code_osd_’gše
;

629 
tw_rc_driv”_t
 
rc_driv”
;

630 
’code_chª_£rviû_tcb_t
 
’code_»que¡_tcb
;

631 
d´am_»que¡_t
 
»ad_video_b™¡»am_»q
;

632 
d´am_·ge_node_t
 *
d´am_·ge
;

633 
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am_buf
;

635 
tw_video_chª_buf_poŞ_t
 
’code_chª_buf_poŞ
;

636 
tw_video_äame_tcb_queue_t
 
’code_äame_queue
;

637 #ifdeà 
MV_MODULE


638 
tw_video_mv_äame_tcb_queue_t
 
’code_mv_äame_queue
;

642 
	sddr_b™¡»am_h—d”
{

643 
v®id
;

644 
ma¡”OrSub
;

645 
äameTy³
;

646 
chª_id_ªd_Üig_id
;

647 
off£t
;

648 
Ën
;

649 
timeSmp
;

650 
»£rv”1
;

651 
»£rv”2
;

652 
»£rv”3
;

653 
»£rv”4
;

656 
	sddr_video_b™¡»am_h—d”
{

657 
ddr_b™¡»am_h—d”_t
 
mvFÏgs_h—d”
;

658 
ddr_b™¡»am_h—d”_t
 
mvVextÜ_h—d”
;

659 
ddr_b™¡»am_h—d”_t
 
h264_b™¡»am_h—d”
;

662 
	#VIDEO_SIZE_FROM_VD
 0

	)

663 
	#VIDEO_SIZE_FROM_VJ
 1

	)

665 
u32
 
šlše
 
VIDEO_SIZE_TO_WIDTH
(
¤c
, 
TW_VIDEO_SIZE
 
size
, 
TW_VIDEO_STANDARD
 
¡ªd¬d
)

667 if(
¡ªd¬d
 =ğ
TW_VIDEO_STANDARD_PAL
) {

668 
size
) {

669 
TW_VIDEO_SIZE_QCIF
:

670 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

671  
WIDTH_FRAME_QCIF_PAL
;

673  (
WIDTH_FRAME_4CIF_PAL
>>2);

675 
TW_VIDEO_SIZE_CIF
:

676 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

677  
WIDTH_FRAME_CIF_PAL
;

679  (
WIDTH_FRAME_4CIF_PAL
>>1);

681 
TW_VIDEO_SIZE_HALF_D1
:

682 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

683  
WIDTH_FRAME_HALF_D1_PAL
;

687 
TW_VIDEO_SIZE_D1
:

688 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

689  
WIDTH_FRAME_D1_PAL
;

693 
TW_VIDEO_SIZE_QHALF_D1
:

694 
TW_VIDEO_SIZE_USER
:

696  (
WIDTH_FRAME_4CIF_PAL
>>1);

698 }if(
¡ªd¬d
 =ğ
TW_VIDEO_STANDARD_NTSC
){

699 
size
) {

700 
TW_VIDEO_SIZE_QCIF
:

701 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

702  
WIDTH_FRAME_QCIF_NTSC
;

704  (
WIDTH_FRAME_4CIF_NTSC
>>2);

706 
TW_VIDEO_SIZE_CIF
:

707 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

708  
WIDTH_FRAME_CIF_NTSC
;

710  (
WIDTH_FRAME_4CIF_NTSC
>>1);

712 
TW_VIDEO_SIZE_HALF_D1
:

713 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

714  
WIDTH_FRAME_HALF_D1_NTSC
;

718 
TW_VIDEO_SIZE_D1
:

719 if(
¤c
 =ğ
VIDEO_SIZE_FROM_VD
) {

720  
WIDTH_FRAME_D1_NTSC
;

724 
TW_VIDEO_SIZE_QHALF_D1
:

725 
TW_VIDEO_SIZE_USER
:

727  (
WIDTH_FRAME_4CIF_NTSC
>>1);

734 
u32
 
šlše
 
VIDEO_SIZE_TO_HEIGHT
(
¤c
, 
TW_VIDEO_SIZE
 
size
, 
TW_VIDEO_STANDARD
 
¡ªd¬d
)

736 if(
¡ªd¬d
 =ğ
TW_VIDEO_STANDARD_PAL
) {

737 
size
) {

738 
TW_VIDEO_SIZE_QCIF
:

739  
HEIGHT_FRAME_QCIF_PAL
;

740 
TW_VIDEO_SIZE_CIF
:

741  
HEIGHT_FRAME_CIF_PAL
;

742 
TW_VIDEO_SIZE_HALF_D1
:

743  
HEIGHT_FRAME_HALF_D1_PAL
;

744 
TW_VIDEO_SIZE_D1
:

745  
HEIGHT_FRAME_D1_PAL
;

746 
TW_VIDEO_SIZE_QHALF_D1
:

747 
TW_VIDEO_SIZE_USER
:

749  
HEIGHT_FRAME_CIF_PAL
;

751 }if(
¡ªd¬d
 =ğ
TW_VIDEO_STANDARD_NTSC
){

752 
size
) {

753 
TW_VIDEO_SIZE_QCIF
:

754  
HEIGHT_FRAME_QCIF_NTSC
;

755 
TW_VIDEO_SIZE_CIF
:

756  
HEIGHT_FRAME_CIF_NTSC
;

757 
TW_VIDEO_SIZE_HALF_D1
:

758  
HEIGHT_FRAME_HALF_D1_NTSC
;

759 
TW_VIDEO_SIZE_D1
:

760  
HEIGHT_FRAME_D1_NTSC
;

761 
TW_VIDEO_SIZE_QHALF_D1
:

762 
TW_VIDEO_SIZE_USER
:

764  
HEIGHT_FRAME_CIF_NTSC
;

771 
u32
 
šlše
 
VIDEO_SIZE_FROM_WIDTH_HEIGHT
(u32 
width
, u32 
height
, 
TW_VIDEO_STANDARD
 
¡ªd¬d
)

773 if((
width
 =ğ720è|| (width =ğ
WIDTH_FRAME_D1_PAL
è|| (width =ğ
WIDTH_FRAME_D1_NTSC
è|| (width =ğ
WIDTH_FRAME_4CIF_PAL
è|| (width =ğ
WIDTH_FRAME_4CIF_NTSC
)) {

774 if((
height
 =ğ
HEIGHT_FRAME_HALF_D1_PAL
è|| (heighˆ=ğ
HEIGHT_FRAME_HALF_D1_NTSC
)) {

775  
TW_VIDEO_SIZE_HALF_D1
;

777  
TW_VIDEO_SIZE_D1
;

780 if((
width
 =ğ(720>>1)è|| (width =ğ
WIDTH_FRAME_CIF_PAL
è|| (width =ğ
WIDTH_FRAME_CIF_NTSC
)|| (width =ğ(
WIDTH_FRAME_4CIF_PAL
>>1)è|| (width =ğ(
WIDTH_FRAME_4CIF_NTSC
>>1))) {

781  
TW_VIDEO_SIZE_CIF
;

784 if((
width
 =ğ
HEIGHT_FRAME_QCIF_PAL
è|| (width =ğ
HEIGHT_FRAME_QCIF_NTSC
è|| (width =ğ(
WIDTH_FRAME_4CIF_PAL
>>2)è|| (width =ğ(
WIDTH_FRAME_4CIF_NTSC
>>2))) {

785  
TW_VIDEO_SIZE_QCIF
;

788  
TW_VIDEO_SIZE_USER
;

791 
š™_tw5864_’code_time¡amp
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
);

792 
š™_tw5864_vd_üoss_bus
(
tw5864_vd_üoss_bus_t
 *, 
TW_CROSS_BUS_WORK_MODE
 
mode
, 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
);

793 
»move_tw5864_vd_üoss_bus
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
);

794 
š™_tw5864_h264_’code_chª
(
tw_h264_logic_’code_chª_t
 *, 
bus_id
, 
ch_id
, 
phy_¦Ù_id
, 
ty³
, 
dvm_ch_t
 *
ch
);

795 
»move_tw5864_h264_’code_chª
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

796 
nÙify_»move_’code_chª_£rviû
(
’code_chª_£rviû_tcb_t
 *
cu¼_cÚsum”
);

797 
š™_’code_chª_£rviû_tcb_w™h_nuÎ
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
);

798 
š™_’code_chª_£rviû_tcb_w™h_fœ¡_¡¬t
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
);

799 
š™_’code_chª_£rviû_tcb_w™h_¡¬t_’code
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
);

800 
h264_logic_’code_chª_d–ay_»¡¬t_’code
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
);

802 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_h264_video_buf.h

1 #iâdef 
TW_H264_VIDEO_BUF_H


2 
	#TW_H264_VIDEO_BUF_H


	)

4 #ifdeà
__ılu¥lus


9 
	#VIDEO_MASTER_CHAN_BUF_POOL_LEN
 (0x80000)

10 
	#VIDEO_SUB_CHAN_BUF_POOL_LEN
 (0x20000)

11 
	#MÙiÚVeùÜB™FÏg_BUF_LEN
 (24)

	)

13 
	sš£¹_03_¡©e_machše
{

14 
Œª_¡©e
;

15 
Œªsãr
;

18 
	stw_video_chª_buf_poŞ_İ”©iÚ
{

19 (*
ü—‹
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, );

20 (*
»Ëa£
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

22 (*
g‘_video_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 **
·ck‘
);

23 (*
Œy_g‘_video_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 **
·ck‘
);

24 (*
put_video_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 *
·ck‘
);

25 (*
g‘_video_·ck‘_tcb_poŞ_’Œy_numb”
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

27 (*
g‘_video_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 **
äame
);

28 (*
Œy_g‘_video_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 **
äame
);

29 (*
put_video_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 *
äame
);

30 (*
g‘_video_äame_tcb_poŞ_’Œy_numb”
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

32 #ifdeà 
MV_MODULE


33 (*
g‘_video_mv_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 **
·ck‘
);

34 (*
Œy_g‘_video_mv_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 **
·ck‘
);

35 (*
put_video_mv_·ck‘_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
);

36 (*
g‘_video_mv_·ck‘_tcb_poŞ_’Œy_numb”
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

38 (*
g‘_video_mv_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 **
äame
);

39 (*
Œy_g‘_video_mv_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 **
äame
);

40 (*
put_video_mv_äame_tcb
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 *
äame
);

41 (*
g‘_video_mv_äame_tcb_poŞ_’Œy_numb”
)(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

45 
	stw_video_chª_buf_poŞ
{

46 
ÿche_Üd”
;

47 *
ÿche_bufãr
;

49 
video_·ck‘_bufãr_size
;

50 
video_·ck‘_’Œy_numb”
;

51 
tcb_node_poŞ_t
 
video_·ck‘_poŞ_tcb
;

52 
tw_video_·ck‘_tcb_t
 *
video_·ck‘_’Œy_poŞ
;

54 
video_äame_’Œy_numb”
;

55 
tcb_node_poŞ_t
 
video_äame_poŞ_tcb
;

56 
tw_video_äame_tcb_t
 *
video_äame_’Œy_poŞ
;

57 #ifdeà 
MV_MODULE


58 
mv_ÿche_Üd”
;

59 *
mv_ÿche_bufãr
;

61 
mv_·ck‘_bufãr_size
;

62 
mv_·ck‘_’Œy_numb”
;

63 
tcb_node_poŞ_t
 
mv_·ck‘_poŞ_tcb
;

64 
tw_video_mv_·ck‘_tcb_t
 *
mv_·ck‘_’Œy_poŞ
;

66 
mv_äame_’Œy_numb”
;

67 
tcb_node_poŞ_t
 
mv_äame_poŞ_tcb
;

68 
tw_video_mv_äame_tcb_t
 *
mv_äame_’Œy_poŞ
;

70 
tw_video_chª_buf_poŞ_İ”©iÚ
 *
İ
;

73 
	stw_video_·ck‘_İ”©iÚ


75 (*
š™
)(
tw_video_·ck‘_tcb_t
 *
·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
, 
id
);

76 (*
»£t
)(
tw_video_·ck‘_tcb_t
 *
·ck‘
);

77 (*
»Ëa£
)(
tw_video_·ck‘_tcb_t
 **
·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
);

78 (*
»ã»nû
)(
tw_video_·ck‘_tcb_t
 *
¤c_·ck‘
,w_video_·ck‘_tcb_ˆ**
±r_de¡_·ck‘
);

80 (*
dma_m­
)(
tw_video_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

81 (*
dma_unm­
)(
tw_video_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

83 
size_t
 (*
subm™
)(
tw_video_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, 
h264_Çl_t
 *
Çl
);

86 
	#to_video_·ck‘_buf_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_video_·ck‘_tcb_t
, 
·ck‘_node
)

	)

87 
	stw_video_·ck‘_tcb


89 
©omic_t
 
»f_couÁ
;

90 
¥šlock_t
 
lock
;

91 
tcb_node_t
 
·ck‘_node
;

92 
·ck‘_id
;

94 
·ck‘_size
;

95 
·ylßd_Ën
;

96 
cÚsum”_Ën
;

97 
id_of_·ck‘_queue
;

99 
u8
 *
d©a
;

100 
dma_addr_t
 
dma_addr
;

102 
tw_video_·ck‘_İ”©iÚ
 *
İ
;

105 
	stw_video_·ck‘_queue_İ”©iÚ
{

106 (*
g‘
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 **);

107 (*
Œy_g‘
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 **);

108 (*
g‘_”
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 **);

109 (*
Œy_g‘_”
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 **);

110 (*
put
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 *);

111 (*
put_h—d”
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_·ck‘_tcb_t
 *);

113 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

114 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

115 (*
put_cu¼_´oduûr_što_queue
)(
tw_video_·ck‘_tcb_queue_t
 *);

116 (*
»Ëa£_cu¼_´oduûr
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

117 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_·ck‘_tcb_queue_t
 *);

118 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_·ck‘_tcb_queue_t
 *);

119 (*
»Ëa£_cu¼_cÚsum”
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

121 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_video_·ck‘_tcb_queue_t
 *);

122 (*
»Ëa£
)(
tw_video_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

123 (*
š™
)(
tw_video_·ck‘_tcb_queue_t
 *);

126 
	stw_video_·ck‘_tcb_queue
{

127 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

128 
tcb_node_queue_t
 
queue_node
;

129 
tw_video_·ck‘_tcb_t
 *
cu¼_cÚsum”
;

130 
tw_video_·ck‘_tcb_t
 *
cu¼_´oduûr
;

131 
¥šlock_t
 
lock
;

133 
tw_video_·ck‘_queue_İ”©iÚ
 *
İ
;

136 
	stw_video_äame_tcb_İ”©iÚ
 {

137 (*
š™
)(
tw_video_äame_tcb_t
 *
äame
);

138 (*
»£t
)(
tw_video_äame_tcb_t
 *
äame
);

139 (*
»Ëa£
)(
tw_video_äame_tcb_t
 **
±r_äame
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

140 (*
»ã»nû
)(
tw_video_äame_tcb_t
 *
¤c_äame
,w_video_äame_tcb_ˆ**
±r_de¡_äame
);

142 
size_t
 (*
subm™
)(
tw_video_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

145 
	#to_video_äame_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_video_äame_tcb_t
, 
äame_node
)

	)

146 
	stw_video_äame_tcb
{

147 
¥šlock_t
 
lock
;

148 
©omic_t
 
»f_couÁ
;

149 
tcb_node_t
 
äame_node
;

151 
äame_ty³
;

152 
h264_Çl_t
 
Çl
;

153 
äame_Ën
;

154 
cÚsum”_äame_off£t
;

155 
__u32
 
time¡amp
;

156 
du¿tiÚ
;

157 
i_š™_qp
;

158 
i_cu¼_qp
;

159 
i_mb_x
;

160 
i_mb_y
;

161 
i_log_gİ_v®ue
;

162 
äame_numb”
;

163 
ås
;

164 
äame_is_”r
;

166 
tw_video_·ck‘_tcb_queue_t
 
video_·ck‘_queue
;

167 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
;

168 
tw_video_äame_tcb_İ”©iÚ
 *
İ
;

171 
	stw_video_äame_queue_İ”©iÚ
{

172 (*
g‘
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 **);

173 (*
Œy_g‘
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 **);

174 (*
g‘_”
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 **);

175 (*
Œy_g‘_”
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 **);

176 (*
put
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 *);

177 (*
put_h—d”
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_äame_tcb_t
 *);

179 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

180 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

181 (*
put_cu¼_´oduûr_što_queue
)(
tw_video_äame_tcb_queue_t
 *);

182 (*
»Ëa£_cu¼_´oduûr
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

183 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_äame_tcb_queue_t
 *);

184 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_äame_tcb_queue_t
 *);

185 (*
»Ëa£_cu¼_cÚsum”
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

186 (*
put_cu¼_cÚsum”_što_queue_h—d”
)(
tw_video_äame_tcb_queue_t
 *);

188 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_video_äame_tcb_queue_t
 *);

189 (*
»Ëa£
)(
tw_video_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

190 (*
š™
)(
tw_video_äame_tcb_queue_t
 *);

193 
	stw_video_äame_tcb_queue
{

194 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

195 
tcb_node_queue_t
 
queue_node
;

196 
tw_video_äame_tcb_t
 *
cu¼_cÚsum”
;

197 
tw_video_äame_tcb_t
 *
cu¼_´oduûr
;

198 
¥šlock_t
 
lock
;

200 
tw_video_äame_queue_İ”©iÚ
 *
İ
;

203 #ifdeà 
MV_MODULE


204 
	stw_video_mv_·ck‘_tcb_İ”©iÚ
{

205 (*
š™
)(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
, 
id
);

206 (*
»£t
)(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
);

207 (*
»Ëa£
)(
tw_video_mv_·ck‘_tcb_t
 **
±r_·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
);

208 (*
»ã»nû
)(
tw_video_mv_·ck‘_tcb_t
 *
¤c_·ck‘
,w_video_mv_·ck‘_tcb_ˆ**
±r_de¡_·ck‘
);

210 (*
dma_m­
)(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

211 (*
dma_unm­
)(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

213 
size_t
 (*
subm™
)(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
);

216 
	#to_g‘_tw_video_mv_·ck‘_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_video_mv_·ck‘_tcb_t
, 
mv_·ck‘_node
)

	)

217 
	stw_video_mv_·ck‘_tcb
{

218 
¥šlock_t
 
lock
;

219 
©omic_t
 
»f_couÁ
;

220 
tcb_node_t
 
mv_·ck‘_node
;

222 
__u8
 *
d©a
;

223 
__u32
 
d©a_size
;

224 
__u8
 *
mvVeùÜ_buf
;

225 
__u32
 
mvVeùÜ_Ën
;

226 
dma_addr_t
 
dma_addr
;

228 
tw_video_mv_·ck‘_tcb_İ”©iÚ
 *
İ
;

231 
	stw_video_mv_·ck‘_tcb_queue_İ”©iÚ
{

232 (*
g‘
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 **);

233 (*
Œy_g‘
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 **);

234 (*
g‘_”
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 **);

235 (*
Œy_g‘_”
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 **);

236 (*
put
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 *);

237 (*
put_h—d”
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_mv_·ck‘_tcb_t
 *);

239 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

240 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

241 (*
put_cu¼_´oduûr_što_queue
)(
tw_video_mv_·ck‘_tcb_queue_t
 *);

242 (*
»Ëa£_cu¼_´oduûr
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

243 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_mv_·ck‘_tcb_queue_t
 *);

244 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_mv_·ck‘_tcb_queue_t
 *);

245 (*
»Ëa£_cu¼_cÚsum”
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

247 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_video_mv_·ck‘_tcb_queue_t
 *);

248 (*
»Ëa£
)(
tw_video_mv_·ck‘_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

249 (*
š™
)(
tw_video_mv_·ck‘_tcb_queue_t
 *);

252 
	stw_video_mv_·ck‘_tcb_queue
{

253 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

254 
tcb_node_queue_t
 
queue_node
;

255 
tw_video_mv_·ck‘_tcb_t
 *
cu¼_cÚsum”
;

256 
tw_video_mv_·ck‘_tcb_t
 *
cu¼_´oduûr
;

257 
¥šlock_t
 
lock
;

259 
tw_video_mv_·ck‘_tcb_queue_İ”©iÚ
 *
İ
;

262 
	stw_video_mv_äame_tcb_İ”©iÚ
{

263 (*
š™
)(
tw_video_mv_äame_tcb_t
 *
äame
);

264 (*
»£t
)(
tw_video_mv_äame_tcb_t
 *
äame
);

265 (*
»Ëa£
)(
tw_video_mv_äame_tcb_t
 **
±r_äame
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

266 (*
»ã»nû
)(
tw_video_mv_äame_tcb_t
 *
¤c_äame
,w_video_mv_äame_tcb_ˆ**
±r_de¡_äame
);

268 
size_t
 (*
subm™
)(
tw_video_mv_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

271 
	#to_g‘_tw_video_mv_äame_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_video_mv_äame_tcb_t
, 
mv_äame_node
)

	)

272 
	stw_video_mv_äame_tcb
{

273 
¥šlock_t
 
lock
;

274 
©omic_t
 
»f_couÁ
;

275 
tcb_node_t
 
mv_äame_node
;

276 
__u8
 
mvFÏg_buf
[
MÙiÚVeùÜB™FÏg_BUF_LEN
];

277 
__u32
 
mvFÏg_Ën
;

278 
__u32
 
mvBuf_·yLßdL’
;

279 
__u32
 
time¡amp
;

280 
äame_numb”
;

282 
tw_video_mv_·ck‘_tcb_queue_t
 
mv_queue
;

283 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
;

284 
tw_video_mv_äame_tcb_İ”©iÚ
 *
İ
;

287 
	stw_video_mv_äame_tcb_queue_İ”©iÚ
{

288 (*
g‘
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 **);

289 (*
Œy_g‘
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 **);

290 (*
g‘_”
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 **);

291 (*
Œy_g‘_”
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 **);

292 (*
put
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 *);

293 (*
put_h—d”
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_mv_äame_tcb_t
 *);

295 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

296 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

297 (*
put_cu¼_´oduûr_što_queue
)(
tw_video_mv_äame_tcb_queue_t
 *);

298 (*
»Ëa£_cu¼_´oduûr
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

299 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_mv_äame_tcb_queue_t
 *);

300 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_video_mv_äame_tcb_queue_t
 *);

301 (*
»Ëa£_cu¼_cÚsum”
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

303 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_video_mv_äame_tcb_queue_t
 *);

304 (*
»Ëa£
)(
tw_video_mv_äame_tcb_queue_t
 *, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

305 (*
š™
)(
tw_video_mv_äame_tcb_queue_t
 *);

308 
	stw_video_mv_äame_tcb_queue
{

309 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

310 
tcb_node_queue_t
 
queue_node
;

311 
tw_video_mv_äame_tcb_t
 *
cu¼_cÚsum”
;

312 
tw_video_mv_äame_tcb_t
 *
cu¼_´oduûr
;

313 
¥šlock_t
 
lock
;

315 
tw_video_mv_äame_tcb_queue_İ”©iÚ
 *
İ
;

319 
š™_tw_video_·ck‘_tcb_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
);

320 
»move_tw_video_·ck‘_tcb_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

321 
š™_tw_video_äame_tcb_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
);

322 
»move_tw_video_äame_tcb_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

323 #ifdeà 
MV_MODULE


324 
š™_tw_video_mv_·ck‘_tcb_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_queue
);

325 
»move_tw_video_mv_·ck‘_tcb_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

326 
š™_tw_video_mv_äame_tcb_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
);

327 
»move_tw_video_mv_äame_tcb_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

329 
š™_tw_video_chª_buf_poŞ
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
buf_Ën
);

330 
»move_tw_video_chª_buf_poŞ
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
);

332 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_interface.h

1 #iâdef 
DVM_INTERFACE_H


2 
	#DVM_INTERFACE_H


	)

4 #ifdeà
__ılu¥lus


13 
	#TW_VIDEO_H264_CODEC_TYPE
 (0)

	)

14 
	#TW_VIDEO_MJPEG_CODEC_TYPE
 (1)

	)

15 
	#TW_AUDIO_CODEC_TYPE
 (2)

	)

18 
	#TW_MASTER_BITSTREAM
 (0)

	)

19 
	#TW_SUB_BITSTREAM
 (1)

	)

22 
	#H264_FRAME_TYPE_IDR
 (0)

	)

23 
	#H264_FRAME_TYPE_I
 (1)

	)

24 
	#H264_FRAME_TYPE_P
 (2)

	)

25 
	#H264_FRAME_TYPE_B
 (3)

	)

26 
	#H264_FRAME_TYPE_SI
 (4)

	)

27 
	#H264_FRAME_TYPE_SP
 (5)

	)

28 
	#H264_MV_FRAME_TYPE
 (6)

	)

29 
	#MJPEG_FRAME_TYPE
 (7)

	)

30 
	#AUDIO_FRAME_TYPE
 (8)

	)

59 
	stw_äame_h—d”
 {

60 
codecTy³
;

61 
¡»amTy³
;

62 
äameTy³
;

63 
äameS”Ÿl
;

64 
timeSmp
;

65 
·ylßd_off£t
;

66 
·ylßdL’
;

67 
·d
[0];

72 
	stw_h264_idr_äame_·d
 {

73 
ås
;

74 
š™_qp
;

75 
log2MaxF¿meNumNšus4
;

76 
mb_width_mšus1
;

77 
mb_height_mšus1
;

78 
i_cu¼_qp
;

79 
¥s_äame_off£t
;

80 
¥s_äame_size
;

81 
µs_äame_off£t
;

82 
µs_äame_size
;

83 
idr_äame_off£t
;

84 
idr_äame_size
;

85 
Çl
[0];

90 
	stw_video_mÙiÚ_veùÜ_·d
 {

91 
mvFÏgs_off£t
;

92 
mvFÏgs_size
;

93 
mÙiÚVeùÜ_off£t
;

94 
mÙiÚVeùÜ_size
;

95 
Çl
[0];

100 
	stw_audio_äame_·d
 {

101 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

102 
u32
 
bus_id
:4;

103 
u32
 
ch_id
:4;

104 
u32
 
chª_id
:4;

105 
u32
 
ty³
:4;

106 
u32
 
b™_wide
:4;

107 
u32
 
§m¶e_¿‹
:4;

108 
u32
 
b™_¿‹
:8;

109 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

110 
u32
 
b™_¿‹
:8;

111 
u32
 
§m¶e_¿‹
:4;

112 
u32
 
b™_wide
:4;

113 
u32
 
ty³
:4;

114 
u32
 
chª_id
:4;

115 
u32
 
ch_id
:4;

116 
u32
 
bus_id
:4;

120 
u32
 
äame_off£t
;

121 
u32
 
äame_size
;

122 
Çl
[0];

152 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_jpeg_codec.h

6 #iâdef 
_TW_JPEG_CODEC_H__


7 
	#_TW_JPEG_CODEC_H__


	)

9 #ifdeà
__ılu¥lus


14 
	#VIDEO_JPEG_CMD_PATH0
 (0xC800)

	)

15 
	#VIDEO_JPEG_CMD_PATH1
 (0xC804)

	)

16 
	#VIDEO_JPEG_DDR_BASE
 (0x28800)

	)

17 
	#VIDEO_JPEG_BUF_POOL_LEN
 (0x80000)

18 
	#VIDEO_JPEG_PATH_CNT
 (2)

	)

19 
	#VIDEO_JPEG_PATH0
 (0)

	)

20 
	#VIDEO_JPEG_PATH1
 (1)

	)

21 
	#VIDEO_JPEG_PATH_BUF
 (4è

	)

23 
	#JPEG_CMD_SINGLE
 (0x001)

	)

24 
	#JPEG_CMD_BURST
 (0x002)

	)

25 
	#JPEG_CMD_CHANNEL
(
n
è((Òè& 0xf)<<2)

	)

26 
	#JPEG_CMD_FORMAT
(
fmt
è(((fmtè& 0x3è<< 6)

	)

27 
	#JPEG_CMD_PROG
 (0x100)

	)

28 
	#JPEG_CMD_DSAMPLE
 (0x200)

	)

30 
	#JPEG_ENCODE_QSCALE
 (0xd000)

	)

31 
	#JPEG_FRAME_VLD_0
 (0xd004)

	)

32 
	#JPEG_FRAME_VLD_1
 (0xd008)

	)

33 
	#JPEG_ENABLE_JPEG
 (0xd00c)

	)

34 
	#JPEG_IRQ
 (0xd010)

	)

35 
	#JPEG_LENGTH
(
n
è(0xd040 + (nè* ())

	)

36 
	#JPEG_TIMESTAMP
(
bufid
è(0xd060 + ((bufidè/ 2è* ())

	)

37 
	#JPEG_VIDEO_FORMAT
 (0xd07c)

	)

38 
	#JPEG_MODULE_REST
 (0xd0fc)

	)

40 
	#JPEG_CAP_PATH0_ENABLE
 (0xd014)

	)

41 
	#JPEG_CAP_PATH1_ENABLE
 (0xd018)

	)

42 
	#JPEG_CAP_TIMEOUT
 (0xd01c)

	)

44 
	#MJPEG_WIDTH_FRAME_D1_PAL
 (720)

	)

45 
	#MJPEG_WIDTH_FRAME_D1_NTSC
 (720)

	)

46 
	#MJPEG_HEIGHT_FRAME_D1_PAL
 (576)

	)

47 
	#MJPEG_HEIGHT_FRAME_D1_NTSC
 (480)

	)

50 
	#DVM_JPEG_IOC_MAGIC
 
TW_CODEC_IOC_MAGIC


	)

51 
	#TW_MJPEG_ENCODE_PARAM_GET
 
	`_IOR
(
DVM_JPEG_IOC_MAGIC
, 17, )

	)

52 
	#TW_MJPEG_ENCODE_PARAM_SET
 
	`_IOW
(
DVM_JPEG_IOC_MAGIC
, 18, )

	)

54 
	#TW5864_MJPEG_MIN_INTERVAL
 (80)

	)

56 
tw_j³g_’code_´İ”ty
 
	ttw_j³g_’code_´İ”ty_t
;

57 
tw_j³g_’code_cÚŒŞ
 
	ttw_j³g_’code_cÚŒŞ_t
;

58 
tw_mj³g_’code_·¿m
 
	ttw_mj³g_’code_·¿m_t
;

59 
tw_j³g_phy_video_¦Ù
 
	ttw_j³g_phy_video_¦Ù_t
;

60 
tw5864_vj_bus
 
	ttw5864_vj_bus_t
;

61 
tw_vj_Üig_buf_šfo
 
	ttw_vj_Üig_buf_šfo_t
;

62 
tw5864_vj_bus_İ”©iÚ
 
	ttw5864_vj_bus_İ”©iÚ_t
;

63 
j³g_£rviû_queue
 
	tj³g_£rviû_queue_t
;

64 
j³g_£rviû_tcb
 
	tj³g_£rviû_tcb_t
;

65 
tw5864_mj³g_·th
 
	ttw5864_mj³g_·th_t
;

66 
tw5864_mj³g_·th_İ”©iÚ
 
	ttw5864_mj³g_·th_İ”©iÚ_t
;

68 
	eTW5864_JPEG_REQ_TYPE
{

69 
DVM_CHIP_REQ_SINGLE
,

70 
DVM_CHIP_REQ_BURST
,

73 
	#to_g‘_j³g_£rviû_tcb_w™h_£rviû_tcb
(
node
è
	`cÚš”_of
Òode, 
j³g_£rviû_tcb_t
, 
£rviû_tcb
)

	)

74 
	#to_g‘_j³g_chªÃl_w™h_’code_´İ”ty
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
’code_´İ”ty
)

	)

75 
	#to_g‘_j³g_chªÃl_w™h_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
logic_chª_ed
)

	)

77 
	sj³g_£rviû_tcb
{

78 
tcb_node_t
 
£rviû_tcb
;

79 
TW5864_JPEG_REQ_TYPE
 
ty³
;

80 *
cÚ‹xt
;

81 (*
»q_ÿÎback
)(*
cÚ‹xt
);

84 
	sj³g_£rviû_queue_İ”©iÚ
{

85 (*
š™
)(
j³g_£rviû_queue_t
 *);

86 (*
g‘_queue_cu¼_’Œy_numb”
)(
j³g_£rviû_queue_t
 *);

87 (*
put_£rviû_»que¡_što_queue
)(
j³g_£rviû_queue_t
 *, 
j³g_£rviû_tcb_t
 *);

88 (*
put_£rviû_»que¡_što_queue_h—d”
)(
j³g_£rviû_queue_t
 *, 
j³g_£rviû_tcb_t
 *);

89 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
j³g_£rviû_queue_t
 *);

90 (*
»Ëa£_cu¼_cÚsum”
)(
j³g_£rviû_queue_t
 *);

91 (*
Œigg”_³ndšg_£rviû_»que¡
)(
j³g_£rviû_queue_t
 *);

94 
	sj³g_£rviû_queue
{

95 
¥šlock_t
 
lock
;

96 
©omic_t
 
j³g_»sourû
;

97 
tcb_node_queue_t
 
£rviû_queue
;

98 
j³g_£rviû_tcb_t
 *
cu¼_cÚsum”
;

100 
j³g_£rviû_queue_İ”©iÚ
 *
İ
;

103 
	stw_vj_Üig_buf_šfo_İ”©iÚ
{

105 (*
g‘_chn_id
)(
tw_vj_Üig_buf_šfo_t
 *);

107 (*
g‘_chn_»s
)(
tw_vj_Üig_buf_šfo_t
 *);

109 (*
Ãw_äame_±r
)(
tw_vj_Üig_buf_šfo_t
 *);

111 (*
äame_v®id
)(
tw_vj_Üig_buf_šfo_t
 * );

113 (*
’abË_’code
)(
tw_vj_Üig_buf_šfo_t
 * );

114 (*
di§bË_’code
)(
tw_vj_Üig_buf_šfo_t
 *);

115 (*
com¶©e
)(
tw_vj_Üig_buf_šfo_t
 *);

117 (*
g‘_Ëngth
)(
tw_vj_Üig_buf_šfo_t
 * );

119 (*
g‘_time¡amp
)(
tw_vj_Üig_buf_šfo_t
 * );

120 (*
m¬k_u§bË
)(
tw_vj_Üig_buf_šfo_t
 * );

121 (*
£t_qsÿË
)(
tw_vj_Üig_buf_šfo_t
 *, );

122 (*
£t_fÜm©
)(
tw_vj_Üig_buf_šfo_t
 *, );

123 (*
g‘_Şd_buf
)(
tw_vj_Üig_buf_šfo_t
 *);

126 
	stw_vj_Üig_buf_šfo
{

127 
©omic_t
 
»ã»nû
;

128 
·th_id
;

129 
buf_id
;

130 
u32
 
·ge_id
;

131 
u32
 
ddr_phy_ba£
;

132 
dvm_ch_t
 *
ch
;

133 
u32
 
Ï¡_tick
;

134 
u32
 
v®id_time
;

135 
tw_vj_Üig_buf_šfo_İ”©iÚ
 *
İ
;

138 
	stw_j³g_phy_video_¦Ù_İ”©iÚ
{

139 (*
š™
)(
tw_j³g_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
phy_¦Ù_id
);

142 
	stw_j³g_phy_video_¦Ù
{

143 
©omic_t
 
¡¬t_æag
;

144 
phy_¦Ù_id
;

145 
TW_VIDEO_SIZE
 
video_size
;

146 
tw_vj_Üig_buf_šfo_t
 *
Üig_buf_šfo
;

148 
tw_j³g_phy_video_¦Ù_İ”©iÚ
 *
İ
;

150 
tw_»gi¡”_bË_t
 
logic_chª_bË
;

151 
tw_»gi¡”_bË_t
 
İ’ed_logic_chª_bË
;

154 
	eTW_MJPEG_IMAGE_LEVEL_E
{

155 
MJPEG_IMAGE_LEVEL_0
 = 0,

156 
MJPEG_IMAGE_LEVEL_1
,

157 
MJPEG_IMAGE_LEVEL_2
,

158 
MJPEG_IMAGE_LEVEL_3
,

159 
MJPEG_IMAGE_LEVEL_4
,

160 
MJPEG_IMAGE_LEVEL_RESERVE
,

163 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_LEVEL_MASK
 0x00000001

	)

164 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
 0x00000002

	)

165 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
 0x00000004

	)

166 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_NUMBER_MASK
 0x00000008

	)

167 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_STRIDE_MASK
 0x00000010

	)

168 
	#TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_TYPE_MASK
 0x00000020

	)

170 
	#TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
 (1 << 31)

	)

171 
	#TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
 (1 << 30)

	)

173 
	stw_mj³g_’code_·¿m
{

174 
u32
 
chªge_mask_æag
;

175 
u32
 
e_image_Ëv–
;

176 
u32
 
i_image_width_mb_size
;

177 
u32
 
i_image_height_mb_size
;

178 
u32
 
i_ÿ±u»_äame_numb”
;

179 
u32
 
i_ÿ±u»_äame_¡ride
;

180 
u32
 
i_ÿ±u»_ty³
;

183 
	stw_j³g_’code_´İ”ty_İ”©iÚ
{

184 (*
š™
)(
tw_j³g_’code_´İ”ty_t
 *);

185 (*
»£t
)(
tw_j³g_’code_´İ”ty_t
 *);

187 
u32
 (*
g‘_image_Ëv–
)(
tw_j³g_’code_´İ”ty_t
 *);

188 
u32
 (*
g‘_mb_width
)(
tw_j³g_’code_´İ”ty_t
 *);

189 
u32
 (*
g‘_mb_height
)(
tw_j³g_’code_´İ”ty_t
 *);

190 
u32
 (*
g‘_ÿ±u»_numb”
)(
tw_j³g_’code_´İ”ty_t
 *);

191 
u32
 (*
g‘_ÿ±u»_¡ride
)(
tw_j³g_’code_´İ”ty_t
 *);

192 
u32
 (*
g‘_ÿ±u»_ty³
)(
tw_j³g_’code_´İ”ty_t
 *);

194 (*
£t_image_Ëv–
)(
tw_j³g_’code_´İ”ty_t
 *, 
TW_MJPEG_IMAGE_LEVEL_E
);

195 (*
£t_mb_width
)(
tw_j³g_’code_´İ”ty_t
 *, 
u32
);

196 (*
£t_mb_height
)(
tw_j³g_’code_´İ”ty_t
 *, 
u32
);

197 (*
£t_ÿ±u»_numb”
)(
tw_j³g_’code_´İ”ty_t
 *, 
u32
);

198 (*
£t_ÿ±u»_¡ride
)(
tw_j³g_’code_´İ”ty_t
 *, 
u32
);

199 (*
£t_ÿ±u»_ty³
)(
tw_j³g_’code_´İ”ty_t
 *, 
u32
);

202 
	stw_j³g_’code_´İ”ty
{

203 
tw_mj³g_’code_·¿m_t
 
’code_´İ”ty
;

204 
¥šlock_t
 
lock
;

205 
tw_j³g_’code_´İ”ty_İ”©iÚ
 *
İ
;

208 
	stw_j³g_’code_cÚŒŞ
{

210 
u32
 
tÙ®_äame_Ën
;

211 
©omic_t
 
fœ¡_·ck‘
;

212 
äame_ba£_addr
;

213 
£ùiÚ_numb”
;

214 
have_»cv_£ùiÚ_numb”
;

215 
£ùiÚ_Ën
;

216 
”_Ën
;

218 
cu¼_qsÿË
;

219 
TW_VIDEO_SIZE
 
cu¼_size
;

220 
cu¼_š‹rv®
;

222 
u32
 
ÿ±u»_æags
;

223 
ÿ±u»_Ëá_couÁ
;

225 
u32
 
Ï¡_jiff›s
;

226 
u32
 
äame_š‹rv®
;

227 
©omic_t
 
v®id
;

228 
u32
 
lo¡_äame
;

230 
u32
 
tim”_id
;

231 
u32
 
timeout_id
;

232 
u32
 
Ï¡_time_tick
;

235 (*
¡¬t_j³g
)(
tw_j³g_logic_’code_chª_t
 *);

236 (*
move_j³g
)(
tw_j³g_logic_’code_chª_t
 *);

237 (*
»ad_·¿m
)(
tw_j³g_logic_’code_chª_t
 *);

238 (*
nÙify
)(
tw_j³g_logic_’code_chª_t
 *);

239 (*
timeout_hook
)(*);

240 (*
tim”_hook
)(*);

241 (*
upd©e_ruÂšg_cÚfig
)(
tw_j³g_’code_cÚŒŞ_t
 *, 
tw_mj³g_’code_·¿m_t
 *);

245 
	stw_j³g_logic_’code_chª


247 
phy_¦Ù_id
;

248 
logic_chª_id
;

249 
©omic_t
 
İ’ed_æag
;

250 
u32
 
i_äame_£rŸl
;

251 
ed_tcb_t
 
logic_chª_ed
;

252 
ed_tcb_t
 
İ’ed_logic_chª_ed
;

253 
tw_time¡amp_t
 
time¡amp
;

255 
dvm_ch_t
 *
ch
;

256 
tw_j³g_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

257 
tw5864_avSync_dev_t
 *
tw_deviû_chª
;

258 
tw_j³g_’code_´İ”ty_t
 
’code_´İ”ty
;

259 
tw_j³g_’code_cÚŒŞ_t
 
’code_cÚŒŞ
;

260 
j³g_£rviû_tcb_t
 
’code_»que¡_tcb
;

262 
d´am_»que¡_t
 
»ad_video_b™¡»am_»q
;

263 
d´am_·ge_node_t
 *
d´am_·ge
;

265 
tw_vb_poŞ_t
 
poŞ
;

266 
tw_vb_äame_tcb_queue_t
 
j³g_äame_queue
;

269 
	stw5864_mj³g_·th_İ”©iÚ
{

270 (*
is_busy
)(
tw5864_mj³g_·th_t
 *);

271 (*
v®id_nÙify
)(
tw5864_mj³g_·th_t
 *);

272 (*
sšgË_ÿp
)(
tw5864_mj³g_·th_t
 *, 
tw_j³g_logic_’code_chª_t
 *);

273 (*
bur¡_ÿp
)(
tw5864_mj³g_·th_t
 *, 
tw_j³g_logic_’code_chª_t
 *);

274 (*
¡¬t_’codšg
)(*);

275 (*
sync_·th
)(
tw5864_mj³g_·th_t
 *);

276 
tim”Hook
 
timeout_hook
;

279 
	stw5864_mj³g_·th
{

280 
u32
 
·th_id
;

281 
u32
 
time_id
;

282 
u32
 
d–ay_time_id
;

283 
©omic_t
 
bur¡_æag
;

284 
tw5864_vj_bus_t
 *
vj_bus
;

285 
u32
 
cu¼’t_äame_±r
;

286 
u32
 
cu¼’t_’codšg_±r
;

287 
u32
 
cu¼’t_cÚsum”_±r
;

288 
tw_j³g_logic_’code_chª_t
 *
logic_’codšg_bË
[
VIDEO_JPEG_PATH_BUF
];

290 
tw5864_mj³g_·th_İ”©iÚ_t
 *
İ
;

292 
	stw5864_vj_bus_İ”©iÚ
{

293 (*
š™
)(
tw5864_vj_bus_t
 *);

294 (*
»Ëa£
)(
tw5864_vj_bus_t
 *);

296 (*
œq
)(, *);

297 (*
¡¬t_mÚ™Ü_sk
)(*);

298 (*
¡İ_mÚ™Ü_sk
)(*);

299 (*
»£t
)(
tw5864_vj_bus_t
 *);

302 
	stw5864_vj_bus
{

303 
¥šlock_t
 
lock
;

304 
u32
 
time_id
;

305 
j³g_£rviû_queue_t
 
j³g_£rviû_queue
;

306 
©omic_t
 
busy
;

307 
u32
 
·th_sw™ch
;

308 
u32
 
i_¡©ic_£cÚd_couÁ”
;

309 
u32
 
i_‹mp_ås_couÁ”
;

310 
u32
 
cu¼’t_ås
;

311 
tw5864_mj³g_·th_t
 
mj³g_·th
[
VIDEO_JPEG_PATH_CNT
];

312 
tw_vj_Üig_buf_šfo_t
 
vj_Üig_buf
[
VIDEO_JPEG_PATH_BUF
 * 
VIDEO_JPEG_PATH_CNT
];

313 
tw_j³g_phy_video_¦Ù_t
 
phy_video_¦Ù
[
TW5864_PHY_VJ_CHAN_NUMBER
];

315 
tw5864_vj_bus_İ”©iÚ
 *
İ
;

318 
	#to_g‘_tw_j³g_’code_chª_w™h_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
logic_chª_ed
)

	)

319 
	#to_g‘_tw_j³g_’code_chª_w™h_İ’ed_logic_chª_ed
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
İ’ed_logic_chª_ed
)

	)

320 
	#to_g‘_tw_j³g_’code_chª_w™h_’code_cÚŒŞ
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
’code_cÚŒŞ
)

	)

321 
	#to_g‘_tw_j³g_’code_chª_w™h_’code_»que¡_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_j³g_logic_’code_chª_t
, 
’code_»que¡_tcb
)

	)

323 
š™_tw5864_vj_bus
(
tw5864_vj_bus_t
 *);

324 
»move_tw5864_vj_bus
(
tw5864_vj_bus_t
 *
vj_bus
);

325 
š™_tw5864_j³g_’code_chª
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
, 
bus_id
, 
ch_id
, 
phy_¦Ù_id
, 
dvm_ch_t
 *
ch
);

326 
»move_tw5864_j³g_’code_chª
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
);

330 
	#JFIF_HEADER_SIZE


	)

333 
	#SOI
 (0xffd8)

334 
	#EOI
 (0xffd9)

335 
	#APP
(
n
) (0xffe0 +‚)

336 
	#JFIF_ID
 ("JFIF")

337 
	#SOF
(
n
) (0xffc0 +‚)

338 
	#SOS
 (0xffda)

339 
	#COM
 (0xfffe)

340 
	#DNL
 (0xffdc)

341 
	#DRI
 (0xffdd)

342 
	#DQT
 (0xffdb)

343 
	#DHT
 (0xffc4)

344 

	)

345 #´agm¨
·ck
(1)

348 
	sAPP_m¬k
{

349 
	gæag
;

350 
	g£gm’t_Ën
;

351 
	g¡ršg
[5];

352 
	gv”siÚ
;

353 
	gun™
;

354 
	gwidth
;

355 
	gheight
;

356 
	gsÿË_width
;

357 
	gsÿË_height
;

358 
	gsÿË_nb™s
[0];

362 
	sDQT_bË
{

363 
	gæag
;

364 
	g£gm’t_Ën
;

365 
	squªt_b
{

366 #ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

367 
	gb™s
:4;

368 
	gid
:4;

369 #–ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

370 
	gid
:4;

371 
	gb™s
:4;

375 
	gDQT_TABLE
[0];

376 }
	gbË
;

380 
	sSOF_bË
{

381 
	gæag
;

382 
	g£gm’t_Ën
;

383 
	gb™s
;

384 
	gheight
;

385 
	gwidth
;

386 
	gcŞÜ
;

387 
	scŞÜ_comp
{

388 
	gcŞÜ_id
;

389 
	gHV
;

390 
	gQDT_id
;

391 }
	gcomp
[0];

395 
	sDHT_bË
{

396 
	gæag
;

397 
	g£gm’t_Ën
;

398 
	shuffmª_bË
{

399 #ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

400 
	gid
:4;

401 
	gty³
:4;

402 #–ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

403 
	gty³
:4;

404 
	gid
:4;

408 
	gnb™s
[16];

409 
	gbË_d©a
[0];

410 }
	ghuff_bË
[0];

414 
	sDRI_bË
{

415 
	gæag
;

416 
	g£gm’t_Ën
;

417 
	gš‹rv®
;

420 
	sSOS_bË
{

421 
	gæag
;

422 
	g£gm’t_Ën
;

423 
	gcŞÜ_comp_id
;

425 
	sSTART_INFO
{

426 #ià
defšed
(
__BIG_ENDIAN_BITFIELD
)

427 
	gDC_bË
:4;

428 
	gAC_bË
:4;

429 #–ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

430 
	gAC_bË
:4;

431 
	gDC_bË
:4;

435 
	gd©a_¡¬t
;

436 
	gd©a_’d
;

437 
	gd©a_£Ëù
;

438 }
	g¡¬t_šfo
[0];

441 
	sCOM_£gm’t
{

442 
	gæag
;

443 
	g£gm’t_Ën
;

444 
	g¡ršg
[0];

446 #´agm¨
·ck
()

448 
šlše
 
sw­_shÜt
(
d©a
)

450 #ifdeà
__BIG_ENDIAN_BITFIELD


451  
	gd©a
;

453 
	g‹mp
 = 0;

455 
	g‹mp
 = 
d©a
 & 0x00ff;

457  (
	g‹mp
<<8 | 
	gd©a
>>8);

461 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_kthread_msg.h

1 #iâdef 
TW_KTHREAD_MSG_H


2 
	#TW_KTHREAD_MSG_H


	)

4 #ifdeà
__ılu¥lus


9 
	#REQ_ALGO_SLICE_HEAD
 (0)

	)

10 
	#REQ_AV_SYNC
 (1)

	)

11 
	#REQ_ALGO_CHIP_RESET
 (2)

	)

12 
	#REQ_ALGO_NULL
 (3)

	)

13 
	#SYSTEM_ESCAPE_MSG
 (4)

	)

14 
	#INVALID_REQ_ALGO
 (
SYSTEM_ESCAPE_MSG
+1)

	)

15 
	#REQ_MSG_NUMBER
 (
INVALID_REQ_ALGO
)

	)

17 
	#BLOCK_OP
 (0)

	)

18 
	#NONBLOCK_OP
 (1)

	)

19 
	#DELAY_OP
 (2)

	)

20 
	#NONBLOCK_COUNT
 (1)

	)

21 
	#DELAY_COUNT
 (20)

	)

24 
	stw_kth»ad_msg_İ”©iÚ
{

25 (*
š™
)(
tw_kth»ad_msg_t
 *, 
tw_kth»ad_msg_poŞ_t
 *);

26 (*
»£t
)(
tw_kth»ad_msg_t
 *);

27 (*
»Ëa£
)(
tw_kth»ad_msg_t
 **);

28 (*
upd©e_·¿m
)(
tw_kth»ad_msg_t
 *, 
dvm_ch_t
 * , , *);

31 
	#to_g‘_tw_kth»ad_msg
(
node
è
	`cÚš”_of
Òode, 
tw_kth»ad_msg_t
, 
msg_node
)

	)

32 
	stw_kth»ad_msg
{

33 
tcb_node_t
 
msg_node
;

34 
©omic_t
 
»f_couÁ
;

35 
¥šlock_t
 
lock
;

36 
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
;

38 
dvm_ch_t
 *
ch
;

39 
msg_ty³
;

40 *
msg_cÚ‹xt
;

42 
tw_kth»ad_msg_İ”©iÚ
 *
İ
;

45 
	stw_kth»ad_msg_queue_İ”©iÚ
{

46 (*
š™
)(
tw_kth»ad_msg_queue_t
 *);

47 (*
put
)(
tw_kth»ad_msg_queue_t
 *, 
tw_kth»ad_msg_t
 *);

48 (*
g‘
)(
tw_kth»ad_msg_queue_t
 *, 
tw_kth»ad_msg_t
 **);

49 (*
»Ëa£
)(
tw_kth»ad_msg_queue_t
 *);

51 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_kth»ad_msg_queue_t
 *);

52 (*
»Ëa£_cu¼_cÚsum”
)(
tw_kth»ad_msg_queue_t
 *);

53 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_kth»ad_msg_queue_t
 *);

56 
	stw_kth»ad_msg_queue
{

57 
tcb_node_queue_t
 
queue_node
;

58 
tw_kth»ad_msg_t
 *
cu¼_cÚsum”
;

59 
¥šlock_t
 
lock
;

61 
tw_kth»ad_msg_queue_İ”©iÚ
 *
İ
;

64 
	stw_kth»ad_msg_poŞ_İ”©iÚ
{

65 (*
g‘
)(
tw_kth»ad_msg_poŞ_t
 *, 
tw_kth»ad_msg_t
 **);

66 (*
Œy_g‘
)(
tw_kth»ad_msg_poŞ_t
 *, 
tw_kth»ad_msg_t
 **);

67 (*
put
)(
tw_kth»ad_msg_poŞ_t
 *, 
tw_kth»ad_msg_t
 *);

68 (*
»Ëa£
)(
tw_kth»ad_msg_poŞ_t
 *);

69 (*
š™
)(
tw_kth»ad_msg_poŞ_t
 *);

72 
	stw_kth»ad_msg_poŞ
{

73 
tcb_node_poŞ_t
 
poŞ_node
;

74 
msg_’Œy_numb”
;

75 
tw_kth»ad_msg_t
 *
msg_ÿche_poŞ
;

76 
tw_kth»ad_msg_poŞ_İ”©iÚ
 *
İ
;

79 
g‘_msg_queue_h—d”
(
tw_kth»ad_msg_queue_t
 **
±r_queue
);

80 
š™_tw_kth»ad_msg_queue
(
tw_kth»ad_msg_queue_t
 *
msg_queue
);

81 
»move_tw_kth»ad_msg_queue
(
tw_kth»ad_msg_queue_t
 *
msg_queue
);

83 
g‘_msg_poŞ_h—d”
(
tw_kth»ad_msg_poŞ_t
 **
msg_poŞ
);

84 
š™_tw_kth»ad_msg_poŞ
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
);

85 
»move_tw_kth»ad_msg_poŞ
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
);

87 
’code_chª_g’_»q_msg
(
tw_h264_logic_’code_chª_t
 *
’code_chª
, 
msg_ty³
, 
block
);

89 
¡¬t_dvm_kth»ad
();

90 
¡İ_dvm_kth»ad
();

92 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_vb_common.h

19 #iâdef 
_TW_VB_COMMON_H__


20 
	#_TW_VB_COMMON_H__


	)

22 #ifdeà
__ılu¥lus


27 
tw_vb_poŞ
 
	ttw_vb_poŞ_t
;

29 
tw_vb_·ck‘_tcb
 
	ttw_vb_·ck‘_tcb_t
;

30 
tw_vb_·ck‘_tcb_queue
 
	ttw_vb_·ck‘_tcb_queue_t
;

32 
tw_vb_äame_tcb
 
	ttw_vb_äame_tcb_t
;

33 
tw_vb_äame_tcb_queue
 
	ttw_vb_äame_tcb_queue_t
;

35 
	stw_vb_poŞ_İ”©iÚ
{

36 (*
ü—‹
)(
tw_vb_poŞ_t
 *
poŞ
, *, 
size
);

37 (*
»Ëa£
)(
tw_vb_poŞ_t
 *
poŞ
);

39 (*
g‘_·ck‘_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 **
·ck‘
);

40 (*
Œy_g‘_·ck‘_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 **
·ck‘
);

41 (*
put_·ck‘_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 *
·ck‘
);

42 (*
g‘_·ck‘_tcb_poŞ_’Œy_numb”
)(
tw_vb_poŞ_t
 *
poŞ
);

44 (*
g‘_äame_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 **
äame
);

45 (*
Œy_g‘_äame_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 **
äame
);

46 (*
put_äame_tcb
)(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 *
äame
);

47 (*
g‘_äame_tcb_poŞ_’Œy_numb”
)(
tw_vb_poŞ_t
 *
poŞ
);

50 
	stw_vb_poŞ
{

51 
ÿche_Üd”
;

52 *
ÿche_bufãr
;

54 
vb_·ck‘_bufãr_size
;

55 
vb_·ck‘_’Œy_numb”
;

56 
tcb_node_poŞ_t
 
vb_·ck‘_poŞ_tcb
;

57 
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_’Œy_poŞ
;

59 
vb_äame_’Œy_numb”
;

60 
tcb_node_poŞ_t
 
vb_äame_poŞ_tcb
;

61 
tw_vb_äame_tcb_t
 *
vb_äame_’Œy_poŞ
;

63 
tw_vb_poŞ_İ”©iÚ
 *
İ
;

66 
	stw_vb_·ck‘_İ”©iÚ


68 (*
š™
)(
tw_vb_·ck‘_tcb_t
 *
·ck‘
, 
tw_vb_poŞ_t
 *
poŞ
, 
id
);

69 (*
»£t
)(
tw_vb_·ck‘_tcb_t
 *
·ck‘
);

70 (*
»Ëa£
)(
tw_vb_·ck‘_tcb_t
 **
·ck‘
, 
tw_vb_poŞ_t
 *
poŞ
);

71 (*
»ã»nû
)(
tw_vb_·ck‘_tcb_t
 *
¤c_·ck‘
,w_vb_·ck‘_tcb_ˆ**
±r_de¡_·ck‘
);

73 (*
dma_m­
)(
tw_vb_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

74 (*
dma_unm­
)(
tw_vb_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
);

76 
size_t
 (*
subm™
)(
tw_vb_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, 
š£¹_03_¡©e_machše_t
 *
machše
);

79 
	#to_vb_·ck‘_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_vb_·ck‘_tcb_t
, 
·ck‘_node
)

	)

80 
	stw_vb_·ck‘_tcb


82 
©omic_t
 
»f_couÁ
;

83 
¥šlock_t
 
lock
;

84 
tcb_node_t
 
·ck‘_node
;

85 
·ck‘_id
;

87 
·ck‘_size
;

88 
·ylßd_Ën
;

89 
cÚsum”_Ën
;

90 
id_of_·ck‘_queue
;

92 
u8
 *
d©a
;

93 
dma_addr_t
 
dma_addr
;

95 
tw_vb_·ck‘_İ”©iÚ
 *
İ
;

98 
	stw_vb_·ck‘_queue_İ”©iÚ
{

99 (*
g‘
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 **);

100 (*
Œy_g‘
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 **);

101 (*
g‘_”
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 **);

102 (*
Œy_g‘_”
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 **);

103 (*
put
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 *);

104 (*
put_h—d”
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_·ck‘_tcb_t
 *);

106 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

107 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

108 (*
put_cu¼_´oduûr_što_queue
)(
tw_vb_·ck‘_tcb_queue_t
 *);

109 (*
»Ëa£_cu¼_´oduûr
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

110 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_vb_·ck‘_tcb_queue_t
 *);

111 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_vb_·ck‘_tcb_queue_t
 *);

112 (*
»Ëa£_cu¼_cÚsum”
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

114 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_vb_·ck‘_tcb_queue_t
 *);

115 (*
»Ëa£
)(
tw_vb_·ck‘_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

116 (*
š™
)(
tw_vb_·ck‘_tcb_queue_t
 *);

119 
	stw_vb_·ck‘_tcb_queue
{

120 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

121 
tcb_node_queue_t
 
queue_node
;

122 
tw_vb_·ck‘_tcb_t
 *
cu¼_cÚsum”
;

123 
tw_vb_·ck‘_tcb_t
 *
cu¼_´oduûr
;

124 
¥šlock_t
 
lock
;

126 
tw_vb_·ck‘_queue_İ”©iÚ
 *
İ
;

129 
	stw_vb_äame_tcb_İ”©iÚ
 {

130 (*
š™
)(
tw_vb_äame_tcb_t
 *
äame
);

131 (*
»£t
)(
tw_vb_äame_tcb_t
 *
äame
);

132 (*
»Ëa£
)(
tw_vb_äame_tcb_t
 **
±r_äame
, 
tw_vb_poŞ_t
 *
poŞ
);

133 (*
»ã»nû
)(
tw_vb_äame_tcb_t
 *
¤c_äame
,w_vb_äame_tcb_ˆ**
±r_de¡_äame
);

135 
size_t
 (*
subm™
)(
tw_vb_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, size_ˆ
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_vb_poŞ_t
 *
poŞ
);

138 
	#to_vb_äame_tcb
(
node
è
	`cÚš”_of
Òode, 
tw_vb_äame_tcb_t
, 
äame_node
)

	)

139 
	stw_vb_äame_tcb
{

140 
¥šlock_t
 
lock
;

141 
©omic_t
 
»f_couÁ
;

142 
tcb_node_t
 
äame_node
;

144 
äame_ty³
;

145 
h264_Çl_t
 
Çl
;

146 
äame_Ën
;

147 
cÚsum”_äame_off£t
;

148 
__u32
 
time¡amp
;

149 
i_š™_qp
;

150 
i_cu¼_qp
;

151 
i_mb_x
;

152 
i_mb_y
;

153 
äame_numb”
;

154 
äame_is_”r
;

155 
u32
 
äame_æags
;

157 
tw_vb_·ck‘_tcb_queue_t
 
vb_·ck‘_queue
;

158 
tw_vb_poŞ_t
 *
poŞ
;

159 
tw_vb_äame_tcb_İ”©iÚ
 *
İ
;

162 
	stw_vb_äame_queue_İ”©iÚ
{

164 (*
g‘
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 **);

165 (*
Œy_g‘
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 **);

166 (*
g‘_”
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 **);

167 (*
Œy_g‘_”
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 **);

168 (*
put
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 *);

169 (*
put_h—d”
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_äame_tcb_t
 *);

171 (*
g‘_cu¼_´oduûr_äom_poŞ
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

172 (*
Œy_g‘_cu¼_´oduûr_äom_poŞ
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

173 (*
put_cu¼_´oduûr_što_queue
)(
tw_vb_äame_tcb_queue_t
 *);

174 (*
»Ëa£_cu¼_´oduûr
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

175 (*
g‘_cu¼_cÚsum”_äom_queue
)(
tw_vb_äame_tcb_queue_t
 *);

176 (*
Œy_g‘_cu¼_cÚsum”_äom_queue
)(
tw_vb_äame_tcb_queue_t
 *);

177 (*
»Ëa£_cu¼_cÚsum”
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

179 (*
g‘_cu¼_queue_’Œy_numb”
)(
tw_vb_äame_tcb_queue_t
 *);

180 (*
»Ëa£
)(
tw_vb_äame_tcb_queue_t
 *, 
tw_vb_poŞ_t
 *
poŞ
);

181 (*
š™
)(
tw_vb_äame_tcb_queue_t
 *);

184 
	stw_vb_äame_tcb_queue
{

185 
u32
 
¡¬t_time¡amp
, 
tÙ®_du¿tiÚ
;

186 
tcb_node_queue_t
 
queue_node
;

187 
tw_vb_äame_tcb_t
 *
cu¼_cÚsum”
;

188 
tw_vb_äame_tcb_t
 *
cu¼_´oduûr
;

189 
¥šlock_t
 
lock
;

191 
tw_vb_äame_queue_İ”©iÚ
 *
İ
;

194 
tw_ü—‹_·ck‘_tcb_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
);

195 
tw_de¡roy_·ck‘_tcb_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
);

197 
tw_ü—‹_äame_tcb_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
);

198 
tw_de¡roy_äame_tcb_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
);

200 
tw_ü—‹_poŞ
(
tw_vb_poŞ_t
 *
poŞ
, *, 
buf_Ën
);

201 
tw_de¡roy_poŞ
(
tw_vb_poŞ_t
 *
poŞ
);

203 #ifdeà
__ılu¥lus


	@../../tw5864/include/tw5864/tw_video_display.h

1 #iâdeà
__TW_VIDEO_DISPLAY_H__


2 
	#__TW_VIDEO_DISPLAY_H__


	)

4 #ifdeà
__ılu¥lus


9 
	#MAX_DISPLAY_INTERFACE
 (4)

	)

10 
	#MAX_DISPLAY_POSITION
 (16)

	)

12 
	#DISP_REG_BASE
 (0xa800)

	)

13 
	#DISP_RD_WR_PTR
(
ch
è(
DISP_REG_BASE
 + ((ch)<< 4è+ 0x00)

	)

14 
	#DISP_CH_BUF
(
ch
è(
DISP_REG_BASE
 + ((ch)<< 4è+ 0x04)

	)

15 
	#DISP_DMA_MODE
(
ch
è(
DISP_REG_BASE
 + ((ch)<< 4è+ 0x08)

	)

16 
	#DISP_MODE
 (
DISP_REG_BASE
 + 0x0104)

	)

17 
	#DISP_CHNL_FMT07
 (
DISP_REG_BASE
 + 0x0108)

	)

18 
	#DISP_CHNL_FMT8f
 (
DISP_REG_BASE
 + 0x010c)

	)

19 
	#DISP_OUT_MODE
 (
DISP_REG_BASE
 + 0x0118)

	)

20 
	#DISP_OUT_NORM
 (
DISP_REG_BASE
 + 0x011c)

	)

21 
	#DISP_SIE_FMT
(
g½
è(
DISP_REG_BASE
 + 0x0120 + ((g½è<< 4))

	)

22 
	#DISP_SIE_SEL_L
(
g½
è(
DISP_REG_BASE
 + 0x0124 + ((g½è<< 4))

	)

23 
	#DISP_SIE_SEL_H
(
g½
è(
DISP_REG_BASE
 + 0x0128 + ((g½è<< 4))

	)

25 
	#DISP_IRQ_MODE
 (
DISP_REG_BASE
 + 0x01fc)

	)

26 
	#DISP_IRQ_FLAGS
 (
DISP_REG_BASE
 + 0x01f8)

	)

27 
	#DISP_IRQ_DMA_FLAGS
 (
DISP_REG_BASE
 + 0x01f4)

	)

28 
	#DISP_IRQ_LOST_SYNC
 (
DISP_REG_BASE
 + 0x01f0)

	)

30 
	eTW_DISPLAY_INTERFACE_MODE
{

31 
TW_DISPLAY_INTERFACE_MODE_27M
 = 0,

32 
TW_DISPLAY_INTERFACE_MODE_54M
,

33 
TW_DISPLAY_INTERFACE_MODE_108M
,

34 
TW_DISPLAY_INTERFACE_MODE_RESERVE
,

37 
	eTW_DISPLAY_POSITION_STATE
{

38 
TW_DISPLAY_POSITION_STATE_UNUSED
 = 0,

39 
TW_DISPLAY_POSITION_STATE_USED
,

40 
TW_DISPLAY_POSITION_STATE_RESERVE
,

43 
tw_di¥Ïy_driv”
 
	ttw_di¥Ïy_driv”_t
;

44 
tw_di¥Ïy_İ”©iÚ
 
	ttw_di¥Ïy_İ”©iÚ_t
;

45 
tw_di¥Ïy_š‹rçû
 
	ttw_di¥Ïy_š‹rçû_t
;

46 
tw_di¥Ïy_š‹rçû_İ”©iÚ
 
	ttw_di¥Ïy_š‹rçû_İ”©iÚ_t
;

47 
tw_di¥Ïy_pha£
 
	ttw_di¥Ïy_pha£_t
;

48 
tw_di¥Ïy_pha£_İ”©iÚ
 
	ttw_di¥Ïy_pha£_İ”©iÚ_t
;

49 
tw_di¥Ïy_pos™iÚ
 
	ttw_di¥Ïy_pos™iÚ_t
;

50 
tw_di¥Ïy_pos™iÚ_İ”©iÚ
 
	ttw_di¥Ïy_pos™iÚ_İ”©iÚ_t
;

52 
	stw_di¥Ïy_pos™iÚ_İ”©iÚ
{

53 (*
š™
)(
tw_di¥Ïy_pos™iÚ_t
 *, 
tw_di¥Ïy_pha£_t
*, 
u32
);

54 (*
»£t
)(
tw_di¥Ïy_pos™iÚ_t
 *);

55 (*
»Ëa£
)(
tw_di¥Ïy_pos™iÚ_t
 *);

57 (*
g‘_¡©e
)(
tw_di¥Ïy_pos™iÚ_t
 *);

58 (*
g‘_pos™iÚ
)(
tw_di¥Ïy_pos™iÚ_t
 *);

59 (*
chªge_pos_size
)(
tw_di¥Ïy_pos™iÚ_t
 *, 
u32
 , u32, u32 , u32);

61 (*
bšd
)(
tw_di¥Ïy_pos™iÚ_t
 *, *);

62 (*
unbšd
)(
tw_di¥Ïy_pos™iÚ_t
 *, *);

63 (*
sync
)(
tw_di¥Ïy_pos™iÚ_t
 *, *);

65 (*
£nd
)(
tw_di¥Ïy_pos™iÚ_t
 *);

66 (*
·u£
)(
tw_di¥Ïy_pos™iÚ_t
 *);

67 (*
»sume
)(
tw_di¥Ïy_pos™iÚ_t
 *);

68 (*
disÿrd
)(
tw_di¥Ïy_pos™iÚ_t
 *);

71 
	stw_di¥Ïy_pos™iÚ
{

72 
¥šlock_t
 
lock
;

73 
u32
 
pos™iÚ
;

74 
TW_DISPLAY_POSITION_STATE
 
¡©e
;

76 
u32
 
¡¬tx
, 
¡¬ty
, 
width
, 
height
;

78 
tw_di¥Ïy_pha£_t
 *
pha£
;

79 *
cÚ‹xt
;

81 
tw_di¥Ïy_pos™iÚ_İ”©iÚ_t
 *
İ
;

84 
	stw_di¥Ïy_pha£_İ”©iÚ
{

85 (*
š™
)(
tw_di¥Ïy_pha£_t
 *);

86 (*
»£t
)(
tw_di¥Ïy_pha£_t
 *);

87 (*
»Ëa£
)(
tw_di¥Ïy_pha£_t
 *);

89 (*
check_bound¬y
)(
tw_di¥Ïy_pha£_t
 *, 
tw_di¥Ïy_pos™iÚ_t
 *);

92 
	stw_di¥Ïy_pha£
{

93 
u32
 
pha£
;

95 
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
;

96 
tw_di¥Ïy_pos™iÚ_t
 
pos™iÚ
[
MAX_DISPLAY_POSITION
];

98 
tw_di¥Ïy_pha£_t
 *
·»Á
, *
siblšg
, *
chd
;

99 
tw_di¥Ïy_pha£_İ”©iÚ_t
 *
İ
;

102 
	stw_di¥Ïy_š‹rçû_İ”©iÚ
{

103 (*
š™
)(
tw_di¥Ïy_š‹rçû_t
 *, 
u32
 
pÜt
, 
dvm_ch_t
 *);

104 (*
»£t
)(
tw_di¥Ïy_š‹rçû_t
 *);

105 (*
»Ëa£
)(
tw_di¥Ïy_š‹rçû_t
 *);

107 (*
upd©e
)(
tw_di¥Ïy_š‹rçû_t
 *);

109 
u32
 (*
g‘_pÜt
)(
tw_di¥Ïy_š‹rçû_t
 *);

110 
u32
 (*
g‘_ÿ·b™y
)(
tw_di¥Ïy_š‹rçû_t
 *);

111 
u32
 (*
g‘_mode
)(
tw_di¥Ïy_š‹rçû_t
 *);

112 (*
£t_mode
)(
tw_di¥Ïy_š‹rçû_t
 *, 
TW_DISPLAY_INTERFACE_MODE
);

115 
	stw_di¥Ïy_š‹rçû
{

116 
TW_DISPLAY_INTERFACE_MODE
 
ÿ·b™y
;

117 
u32
 
pÜt
;

118 
TW_DISPLAY_INTERFACE_MODE
 
mode
;

120 
tw_di¥Ïy_pha£_t
 *
roÙ
;

121 
dvm_ch_t
 *
ch
;

122 
tw_di¥Ïy_š‹rçû_İ”©iÚ_t
 *
İ
;

125 
	stw_di¥Ïy_İ”©iÚ
{

126 (*
š™
)(
tw_di¥Ïy_driv”_t
 *);

127 (*
»£t
)(
tw_di¥Ïy_driv”_t
 *);

128 (*
»Ëa£
)(
tw_di¥Ïy_driv”_t
 *);

130 (*
g‘_video_¡ªd¬d
)(
tw_di¥Ïy_driv”_t
 *);

131 (*
£t_video_¡ªd¬d
)(
tw_di¥Ïy_driv”_t
 *, 
TW_VIDEO_STANDARD
);

134 
	stw_di¥Ïy_driv”
{

135 
©omic_t
 
İ’ed_æag
;

136 
ed_tcb_t
 
İ’ed_di¥Ïy_ed
;

138 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
;

139 
dvm_ch_t
 *
ch
;

140 
tw_di¥Ïy_š‹rçû_t
 
š‹rçû
[
MAX_DISPLAY_INTERFACE
];

142 
tw_di¥Ïy_İ”©iÚ_t
 *
İ
;

143 
tw_´oc_»gi¡”_s
 
di¥Ïy_´oc
;

146 
š™_di¥Ïy_driv”
(
dvm_ch_t
 *
ch
);

147 
»move_di¥Ïy_driv”
(
tw_di¥Ïy_driv”_t
 *
driv”
);

149 #ifdeà
__ılu¥lus


	@../../tw5864/interface/tw_interface.h

1 #iâdef 
DVM_INTERFACE_H


2 
	#DVM_INTERFACE_H


	)

4 #ifdeà
__ılu¥lus


13 
	#TW_VIDEO_H264_CODEC_TYPE
 (0)

	)

14 
	#TW_VIDEO_MJPEG_CODEC_TYPE
 (1)

	)

15 
	#TW_AUDIO_IAM_CODEC_TYPE
 (2)

	)

18 
	#TW_H264_MASTER_BITSTREAM
 (0)

	)

19 
	#TW_H264_SUB_BITSTREAM
 (1)

	)

21 
	stw_äame_h—d”


23 
äame_h—d”_size
;

24 
codecTy³
;

25 
¡»amTy³
;

26 
äameTy³
;

27 
äameS”Ÿl
;

28 
timeSmp
;

29 
·ylßdL’
;

30 
·ylßd_off£t
;

31 
·d
[0];

34 
	stw_h264_idr_äame_·d


36 
ås
;

37 
log2MaxF¿meNumNšus4
;

38 
mb_width_mšus1
;

39 
mb_height_mšus1
;

40 
š™_qp
;

41 
¥s_äame_off£t
;

42 
¥s_äame_size
;

43 
µs_äame_off£t
;

44 
µs_äame_size
;

45 
idr_äame_off£t
;

46 
idr_äame_size
;

47 
·ylßd
[0];

50 
	stw_video_mÙiÚ_veùÜ_·d
{

51 
mvFÏgs_off£t
;

52 
mvFÏgs_size
;

53 
mÙiÚVeùÜ_off£t
;

54 
mÙiÚVeùÜ_size
;

55 
·ylßd
[0];

58 
	stw_audio_äame_·d
{

59 #ià
defšed
(
__LITTLE_ENDIAN_BITFIELD
)

60 
u32
 
bus_id
:4;

61 
u32
 
ch_id
:4;

62 
u32
 
chª_id
:4;

63 
u32
 
ty³
:4;

64 
u32
 
b™_wide
:4;

65 
u32
 
§m¶e_¿‹
:4;

66 
u32
 
b™_¿‹
:8;

67 #–ià
defšed
 (
__BIG_ENDIAN_BITFIELD
)

68 
u32
 
b™_¿‹
:8;

69 
u32
 
§m¶e_¿‹
:4;

70 
u32
 
b™_wide
:4;

71 
u32
 
ty³
:4;

72 
u32
 
chª_id
:4;

73 
u32
 
ch_id
:4;

74 
u32
 
bus_id
:4;

78 
u32
 
äame_off£t
;

79 
u32
 
äame_size
;

80 
·ylßd
[0];

108 #ifdeà
__ılu¥lus


	@../../tw5864/tw5864/algo_h264_driver.c

1 
	~<tw5864/dvm_commÚ.h
>

5 
	$h264_g’_¥s_rb¥
(*
p_d©a
, 
h264_¥s_t
 *
¥s
)

7 
bs_t
 
bs
, *
s
;

9 
s
 = &
bs
;

10 
	`bs_š™
(
s
, 
p_d©a
, 
MAX_SPS_RBSP_LEN
);

11 
	`bs_wr™e
(
s
, 8, 
¥s
->
i_´ofe_idc
);

12 
	`bs_wr™e
(
s
, 8, ((
¥s
->
b_cÚ¡¿št_£t0
<<7)|(¥s->
b_cÚ¡¿št_£t1
<<6)|(¥s->
b_cÚ¡¿št_£t2
<<5)));

13 
	`bs_wr™e
(
s
, 8, 
¥s
->
i_Ëv–_idc
 );

14 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_id
);

15 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_log2_max_äame_num
 - 4);

16 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_poc_ty³
);

17 if(
¥s
->
i_poc_ty³
 == 0)

18 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_log2_max_poc_lsb
 - 4);

19 ià(
¥s
->
i_poc_ty³
 == 1) {

20 
i
;

21 
	`bs_wr™e
(
s
, 1, 
¥s
->
b_d–_pic_Üd”_®ways_z”o
);

22 
	`bs_wr™e_£
(
s
, 
¥s
->
i_off£t_fÜ_nÚ_»f_pic
);

23 
	`bs_wr™e_£
(
s
, 
¥s
->
i_off£t_fÜ_tİ_to_bÙtom_f›ld
);

24 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_num_»f_äames_š_poc_cyşe
);

25 
i
 = 0; i < 
¥s
->
i_num_»f_äames_š_poc_cyşe
; i++)

26 
	`bs_wr™e_£
(
s
, 
¥s
->
i_off£t_fÜ_»f_äame
[
i
]);

28 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_num_»f_äames
);

29 
	`bs_wr™e
(
s
, 1, 
¥s
->
b_g­s_š_äame_num_v®ue_®lowed
);

30 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_mb_width
 - 1);

31 
	`bs_wr™e_ue
(
s
, 
¥s
->
i_mb_height
 - 1);

32 
	`bs_wr™e
(
s
, 1, 
¥s
->
b_äame_mbs_Úly
);

33 ifĞ!
¥s
->
b_äame_mbs_Úly
)

34 
	`bs_wr™e
(
s
, 1, 
¥s
->
b_mb_ad­tive_äame_f›ld
);

35 
	`bs_wr™e
(
s
, 1, 
¥s
->
b_dœeù8x8_šã»nû
);

36 
	`bs_wr™e
(
s
, 1, 0);

37 
	`bs_wr™e
(
s
, 1, 0);

38 
	`bs_rb¥_Œašg
(
s
);

39  
	`bs_Ën
(
s
);

40 
	}
}

42 
	$g’_h264_¥s
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
)

44 
h264_Çl_t
 *
Çl
;

45 
h264_Çl_b™¡»am_t
 *
h264_Çl_¥s_h—d
;

46 
H264_NAL_INFO
 *
Çl_šfo
;

47 #ifdeà 
ADD_DVM_NAL_HEAD


48 
DVM_NAL_HEAD
 *
Çl_¥s_h—d
;

49 
Ën
;

51 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

52 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

54 
Çl
 = &
äame
->nal;

55 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

56 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

57 
Çl
->
¥s_·ylßd
 = &
·ck‘
->
d©a
[
äame
->
äame_Ën
];

58 
	`mem£t
(
Çl
->
¥s_·ylßd
, 0, 64);

59 
h264_Çl_¥s_h—d
 = (
h264_Çl_b™¡»am_t
*)
Çl
->
¥s_·ylßd
;

60 #ifdeà 
ADD_DVM_NAL_HEAD


61 
Çl_¥s_h—d
 = &
h264_Çl_¥s_h—d
->
h—d
;

63 
Çl_šfo
 = &
h264_Çl_¥s_h—d
->
Çl
;

65 #ifdeà 
ADD_DVM_NAL_HEAD


66 
Çl_¥s_h—d
->
e_Çl_ty³
 = 
DVM_NAL_SPS
;

68 #ià
NAL_FILL_ZERO_NUM


69 
Çl_šfo
->
z”o1
 = 0;

70 
Çl_šfo
->
z”o2
 = 0;

72 
Çl_šfo
->
z”o3
 = 0;

73 
Çl_šfo
->
z”o4
 = 0;

74 
Çl_šfo
->
z”o5
 = 0;

75 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

76 
Çl_šfo
->
Çl_»f_idc
 = 
Çl
->
i_»f_idc
 = 
NAL_PRIORITY_HIGHEST
;

77 
Çl_šfo
->
Çl_un™_ty³
 = 
Çl
->
i_ty³
 = 
NAL_SPS
;

78 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

80 
Çl
->
¥s_·ysize
 = (
h264_Çl_b™¡»am_t
);

81 
Çl
->
¥s_·ysize
 +ğ
	`h264_g’_¥s_rb¥
(
h264_Çl_¥s_h—d
->
rb¥
, 
h264_’code_cÚŒŞ
->
¥s
);

82 
äame
->
äame_Ën
 +ğ
Çl
->
¥s_·ysize
;

84 #ifdeà 
ADD_DVM_NAL_HEAD


85 
Ën
 = 
Çl
->
¥s_·ysize
 - (
DVM_NAL_HEAD
);

86 
Çl_¥s_h—d
->
i_Çl_size_0_7
 = (
Ën
 & 0xff);

87 
Çl_¥s_h—d
->
i_Çl_size_8_15
 = ((
Ën
>>8) & 0xff);

88 
Çl_¥s_h—d
->
i_Çl_size_16_23
 = ((
Ën
>>16) & 0xff);

90  
Çl
->
¥s_·ysize
;

91 
	}
}

93 
	$h264_g’_µs_rb¥
(*
p_d©a
, 
h264_µs_t
 *
µs
)

95 
bs_t
 
bs
, *
s
;

97 
s
 = &
bs
;

98 
	`bs_š™
(
s
, 
p_d©a
, 
MAX_PPS_RBSP_LEN
);

99 
	`bs_wr™e_ue
(
s
, 
µs
->
i_id
);

100 
	`bs_wr™e_ue
(
s
, 
µs
->
i_¥s_id
);

101 
	`bs_wr™e
(
s
, 1, 
µs
->
b_ÿbac
);

102 
	`bs_wr™e
(
s
, 1, 
µs
->
b_pic_Üd”
);

103 
	`bs_wr™e_ue
(
s
, 
µs
->
i_num_¦iû_groups
 - 1);

104 
	`bs_wr™e_ue
(
s
, 
µs
->
i_num_»f_idx_l0_aùive
 - 1);

105 
	`bs_wr™e_ue
(
s
, 
µs
->
i_num_»f_idx_l1_aùive
 - 1);

106 
	`bs_wr™e
(
s
, 1, 
µs
->
b_weigh‹d_´ed
);

107 
	`bs_wr™e
(
s
, 2, 
µs
->
b_weigh‹d_b»d
);

108 
	`bs_wr™e_£
(
s
, 
µs
->
i_pic_š™_qp
 - 26);

109 
	`bs_wr™e_£
(
s
, 
µs
->
i_pic_š™_qs
 - 26);

110 
	`bs_wr™e_£
(
s
, 
µs
->
i_chroma_qp_šdex_off£t
);

111 
	`bs_wr™e
(
s
, 1, 
µs
->
b_deblockšg_f‹r_cÚŒŞ
);

112 
	`bs_wr™e
(
s
, 1, 
µs
->
b_cÚ¡¿šed_šŒa_´ed
);

113 
	`bs_wr™e
(
s
, 1, 
µs
->
b_»dundªt_pic_út
);

114 
	`bs_rb¥_Œašg
(
s
);

115  
	`bs_Ën
(
s
);

116 
	}
}

118 
	$g’_h264_µs
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
)

120 
h264_Çl_t
 *
Çl
;

121 
h264_Çl_b™¡»am_t
 *
h264_Çl_µs_h—d
;

122 
H264_NAL_INFO
 *
Çl_šfo
;

123 #ifdeà 
ADD_DVM_NAL_HEAD


124 
DVM_NAL_HEAD
 *
Çl_µs_h—d
;

125 
Ën
;

127 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

128 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

130 
Çl
 = &
äame
->nal;

131 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

132 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

133 
Çl
->
µs_·ylßd
 = &
·ck‘
->
d©a
[
äame
->
äame_Ën
];

134 
	`mem£t
(
Çl
->
µs_·ylßd
, 0, 64);

135 
h264_Çl_µs_h—d
 = (
h264_Çl_b™¡»am_t
*)
Çl
->
µs_·ylßd
;

136 #ifdeà 
ADD_DVM_NAL_HEAD


137 
Çl_µs_h—d
 = &
h264_Çl_µs_h—d
->
h—d
;

139 
Çl_šfo
 = &
h264_Çl_µs_h—d
->
Çl
;

141 #ifdeà 
ADD_DVM_NAL_HEAD


142 
Çl_µs_h—d
->
e_Çl_ty³
 = 
DVM_NAL_PPS
;

144 #ià
NAL_FILL_ZERO_NUM


145 
Çl_šfo
->
z”o1
 = 0;

146 
Çl_šfo
->
z”o2
 = 0;

148 
Çl_šfo
->
z”o3
 = 0;

149 
Çl_šfo
->
z”o4
 = 0;

150 
Çl_šfo
->
z”o5
 = 0;

151 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

152 
Çl_šfo
->
Çl_»f_idc
 = 
Çl
->
i_»f_idc
 = 
NAL_PRIORITY_HIGHEST
;

153 
Çl_šfo
->
Çl_un™_ty³
 = 
Çl
->
i_ty³
 = 
NAL_PPS
;

154 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

156 
Çl
->
µs_·ysize
 = (
h264_Çl_b™¡»am_t
);

157 
Çl
->
µs_·ysize
 +ğ
	`h264_g’_µs_rb¥
(
h264_Çl_µs_h—d
->
rb¥
, 
h264_’code_cÚŒŞ
->
µs
);

158 
äame
->
äame_Ën
 +ğ
Çl
->
µs_·ysize
;

160 #ifdeà 
ADD_DVM_NAL_HEAD


161 
Ën
 = 
Çl
->
µs_·ysize
 - (
DVM_NAL_HEAD
);

162 
Çl_µs_h—d
->
i_Çl_size_0_7
 = (
Ën
 & 0xff);

163 
Çl_µs_h—d
->
i_Çl_size_8_15
 = ((
Ën
>>8) & 0xff);

164 
Çl_µs_h—d
->
i_Çl_size_16_23
 = ((
Ën
>>16) & 0xff);

166  
Çl
->
µs_·ysize
;

167 
	}
}

169 
	$h264_g’_¦iû_h—d
(*
p_d©a
, 
h264_¦iû_h—d”_t
 *
¦iû_h—d
, 
h264_Çl_t
 *
Çl
)

171 
bs_t
 
bs
, *
s
;

173 
s
 = &
bs
;

174 
	`bs_š™
(
s
, 
p_d©a
, 
MAX_SLICE_HEAD_LEN
);

175 
	`bs_wr™e_ue
(
s
, 
¦iû_h—d
->
i_fœ¡_mb
);

176 
	`bs_wr™e_ue
(
s
, 
¦iû_h—d
->
i_ty³
);

177 
	`bs_wr™e_ue
(
s
, 
¦iû_h—d
->
i_µs_id
);

178 
	`bs_wr™e
(
s
, 
¦iû_h—d
->
¥s
->
i_log2_max_äame_num
, sliû_h—d->
i_äame_num
);

179 if(
Çl
->
i_ty³
 =ğ
NAL_SLICE_IDR
)

180 
	`bs_wr™e_ue
(
s
, 
¦iû_h—d
->
i_idr_pic_id
);

181 if(
¦iû_h—d
->
¥s
->
i_poc_ty³
 == 0) {

182 
¦iû_h—d
->
i_poc_lsb
 = (¦iû_h—d->
i_äame_num
<<1);

183 
	`bs_wr™e
(
s
, 
¦iû_h—d
->
¥s
->
i_log2_max_poc_lsb
, sliû_h—d->
i_poc_lsb
);

185 if(
¦iû_h—d
->
i_ty³
 =ğ
SLICE_TYPE_P
 || sliû_h—d->i_ty³ =ğ
SLICE_TYPE_SP
 || sliû_h—d->i_ty³ =ğ
SLICE_TYPE_B
 ) {

186 
	`bs_wr™e1
(
s
, 
¦iû_h—d
->
b_num_»f_idx_ov”ride
);

187 if(
¦iû_h—d
->
b_num_»f_idx_ov”ride
==1) {

188 ià(
¦iû_h—d
->
i_ty³
 =ğ
SLICE_TYPE_P
)

189 
	`bs_wr™e_ue
(
s
, 
¦iû_h—d
->
i_äame_num
-1);

194 ià(
¦iû_h—d
->
i_ty³
 !ğ
SLICE_TYPE_I
 && sliû_h—d->i_ty³ !ğ
SLICE_TYPE_SI
) {

195 
¦iû_h—d
->
b_»f_pic_li¡_»Üd”šg_l0
 = 0;

196 
	`bs_wr™e1
(
s
, 
¦iû_h—d
->
b_»f_pic_li¡_»Üd”šg_l0
);

198 ià(
Çl
->
i_»f_idc
 !ğ
NAL_PRIORITY_DISPOSABLE
) {

199 ià(
Çl
->
i_ty³
 =ğ
NAL_SLICE_IDR
) {

200 
	`bs_wr™e1
(
s
, 0);

201 
	`bs_wr™e1
(
s
, 0);

203 
	`bs_wr™e1
(
s
, 0);

205 
	`bs_wr™e_£
(
s
, 
¦iû_h—d
->
i_qp_d–
 );

207 ià(
s
->
i_Ëá
 != 8){

208 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
 = ((
s
->
p
[0])<<s->
i_Ëá
);

209 
Çl
->
i_‹mp_b™®ign_numb”
 = 8-
s
->
i_Ëá
;

211 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
 = 0;

212 
Çl
->
i_‹mp_b™®ign_numb”
 = 0;

215  
	`bs_Ën
(
s
);

216 
	}
}

218 
	$g’_h264_¦iûh—d
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
, 
äame_ty³
)

220 
h264_Çl_t
 *
Çl
;

221 
h264_Çl_b™¡»am_t
 *
h264_Çl_¦iû_h—d
;

222 
H264_NAL_INFO
 *
Çl_šfo
;

223 #ifdeà 
ADD_DVM_NAL_HEAD


224 
DVM_NAL_HEAD
 *
Çl_¦iû_h—d
;

225 
Ën
;

227 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

228 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

229 
u8
 *
ch
;

230 
u32
 
‹mp_v®ue
;

232 
Çl
 = &
äame
->nal;

233 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

234 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

235 
Çl
->
¦iû_·ylßd
 = &
·ck‘
->
d©a
[
äame
->
äame_Ën
];

236 
	`mem£t
(
Çl
->
¦iû_·ylßd
, 0, 64);

237 
h264_Çl_¦iû_h—d
 = (
h264_Çl_b™¡»am_t
*)
Çl
->
¦iû_·ylßd
;

238 #ifdeà 
ADD_DVM_NAL_HEAD


239 
Çl_¦iû_h—d
 = &
h264_Çl_¦iû_h—d
->
h—d
;

241 
Çl_šfo
 = &
h264_Çl_¦iû_h—d
->
Çl
;

243 
äame_ty³
){

244 
H264_FRAME_TYPE_P
:

245 #ifdeà 
ADD_DVM_NAL_HEAD


246 
Çl_¦iû_h—d
->
e_Çl_ty³
 = 
DVM_NAL_SLICE_P
;

247 
Çl_¦iû_h—d
->
i_Çl_size_0_7
 = 0;

248 
Çl_¦iû_h—d
->
i_Çl_size_8_15
 = 0;

249 
Çl_¦iû_h—d
->
i_Çl_size_16_23
 = 0;

251 
Çl_šfo
->
Çl_un™_ty³
 = 
Çl
->
i_ty³
 = 
NAL_SLICE
;

253 
H264_FRAME_TYPE_I
:

254 #ifdeà 
ADD_DVM_NAL_HEAD


255 
Çl_¦iû_h—d
->
e_Çl_ty³
 = 
DVM_NAL_SLICE_I
;

256 
Çl_¦iû_h—d
->
i_Çl_size_0_7
 = 0;

257 
Çl_¦iû_h—d
->
i_Çl_size_8_15
 = 0;

258 
Çl_¦iû_h—d
->
i_Çl_size_16_23
 = 0;

260 
Çl_šfo
->
Çl_un™_ty³
 = 
Çl
->
i_ty³
 = 
NAL_SLICE
;

263 #ifdeà 
ADD_DVM_NAL_HEAD


264 
Çl_¦iû_h—d
->
e_Çl_ty³
 = 
DVM_NAL_SLICE_IDR
;

265 
Çl_¦iû_h—d
->
i_Çl_size_0_7
 = 0;

266 
Çl_¦iû_h—d
->
i_Çl_size_8_15
 = 0;

267 
Çl_¦iû_h—d
->
i_Çl_size_16_23
 = 0;

269 
Çl_šfo
->
Çl_un™_ty³
 = 
Çl
->
i_ty³
 = 
NAL_SLICE_IDR
;

272 #ià
NAL_FILL_ZERO_NUM


273 
Çl_šfo
->
z”o1
 = 0;

274 
Çl_šfo
->
z”o2
 = 0;

276 
Çl_šfo
->
z”o3
 = 0;

277 
Çl_šfo
->
z”o4
 = 0;

278 
Çl_šfo
->
z”o5
 = 0;

279 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

280 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

281 
Çl_šfo
->
Çl_»f_idc
 = 
Çl
->
i_»f_idc
 = 
NAL_PRIORITY_LOW
;

283 
Çl
->
¦iû_·ysize
 = (
h264_Çl_b™¡»am_t
);

284 
Çl
->
¦iû_·ysize
 +ğ
	`h264_g’_¦iû_h—d
(
h264_Çl_¦iû_h—d
->
rb¥
, 
h264_’code_cÚŒŞ
->
¦iû_h—d
,‚al);

285 
äame
->
äame_Ën
 +ğ
Çl
->
¦iû_·ysize
;

286 
ch
 = &
·ck‘
->
d©a
[
äame
->
äame_Ën
];

287 
äame
->
äame_Ën
&0x1) {

289 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
 <<= 8;

292 
äame
->
äame_Ën
--;

293 
ch
--;

294 
‹mp_v®ue
 = *
ch
;

295 
‹mp_v®ue
 <<= 8;

296 
‹mp_v®ue
 |ğ(
Çl
->
i_‹mp_b™®ign_cÚ‹Á
);

297 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
 = 
‹mp_v®ue
;

298 
Çl
->
i_‹mp_b™®ign_numb”
 += 8;

302 
äame
->
i_š™_qp
 = 
h264_’code_cÚŒŞ
->
µs
->
i_pic_š™_qp
;

303  
Çl
->
¦iû_·ysize
;

304 
	}
}

306 
	$g’_ext_Çl_audio_h—d”
(*
buf
, 
audio_ty³
, 
Ën
)

308 
ext_h264_Çl_b™¡»am_t
 *
ext_Çl_audio_h—d
 = (ext_h264_Çl_b™¡»am_t*)
buf
;

309 #ifdeà 
ADD_DVM_NAL_HEAD


310 
DVM_NAL_HEAD
 *
Çl_audio_h—d
;

312 
H264_NAL_INFO
 *
Çl_šfo
;

313 
»t
 ;

315 #ifdeà 
ADD_DVM_NAL_HEAD


316 
Çl_audio_h—d
 = &
ext_Çl_audio_h—d
->
h—d
;

318 
Çl_šfo
 = &
ext_Çl_audio_h—d
->
Çl
;

320 #ifdeà 
ADD_DVM_NAL_HEAD


321 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
 - (
DVM_NAL_HEAD
);

322 
Çl_audio_h—d
->
i_Çl_size_0_7
 = (
»t
&0xff);

323 
Çl_audio_h—d
->
i_Çl_size_8_15
 = ((
»t
>>8)&0xff);

324 
Çl_audio_h—d
->
i_Çl_size_16_23
 = ((
»t
>>16)&0xff);

326 
audio_ty³
){

328 
TW_AUDIO_PCM
:

329 #ifdeà 
ADD_DVM_NAL_HEAD


330 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_PCM
;

332 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_PCM
;

334 
TW_AUDIO_ALAW
:

335 #ifdeà 
ADD_DVM_NAL_HEAD


336 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_ALAW
;

338 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_ALAW
;

340 
TW_AUDIO_ULAW
:

341 #ifdeà 
ADD_DVM_NAL_HEAD


342 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_ULAW
;

344 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_ULAW
;

346 
TW_AUDIO_ADPCM_32K
:

347 #ifdeà 
ADD_DVM_NAL_HEAD


348 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_IMAADPCM
;

350 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_IMAADPCM
;

352 
TW_AUDIO_ADPCM_48K
:

353 #ifdeà 
ADD_DVM_NAL_HEAD


354 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_IMAADPCM
;

356 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_IMAADPCM
;

358 
TW_AUDIO_ADPCM_16K
:

359 #ifdeà 
ADD_DVM_NAL_HEAD


360 
Çl_audio_h—d
->
e_Çl_ty³
 = 
DVM_NAL_AUDIO_IMAADPCM
;

362 
ext_Çl_audio_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_A_IMAADPCM
;

365 #ià
NAL_FILL_ZERO_NUM


366 
Çl_šfo
->
z”o1
 = 0;

367 
Çl_šfo
->
z”o2
 = 0;

369 
Çl_šfo
->
z”o3
 = 0;

370 
Çl_šfo
->
z”o4
 = 0;

371 
Çl_šfo
->
z”o5
 = 0;

372 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

373 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

374 
Çl_šfo
->
Çl_»f_idc
 = 
NAL_PRIORITY_LOW
;

375 
Çl_šfo
->
Çl_un™_ty³
 = 
NAL_TYPE_EX_AUDIO
;

377 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
;

378  
»t
;

379 
	}
}

381 
	$g’_ext_mj³g_h—d”
(*
buf
, 
Ën
)

383 
ext_h264_Çl_b™¡»am_t
 *
ext_Çl_mj³g_h—d
 = (ext_h264_Çl_b™¡»am_t*)
buf
;

384 #ifdeà 
ADD_DVM_NAL_HEAD


385 
DVM_NAL_HEAD
 *
Çl_mj³g_h—d
;

387 
H264_NAL_INFO
 *
Çl_šfo
;

388 
»t
 ;

390 #ifdeà 
ADD_DVM_NAL_HEAD


391 
Çl_mj³g_h—d
 = &
ext_Çl_mj³g_h—d
->
h—d
;

393 
Çl_šfo
 = &
ext_Çl_mj³g_h—d
->
Çl
;

394 #ifdeà 
ADD_DVM_NAL_HEAD


395 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
 - (
DVM_NAL_HEAD
);

396 
Çl_mj³g_h—d
->
i_Çl_size_0_7
 = (
»t
&0xff);

397 
Çl_mj³g_h—d
->
i_Çl_size_8_15
 = ((
»t
>>8)&0xff);

398 
Çl_mj³g_h—d
->
i_Çl_size_16_23
 = ((
»t
>>16)&0xff);

399 
Çl_mj³g_h—d
->
e_Çl_ty³
 = 
DVM_NAL_MJPEG
;

401 #ià
NAL_FILL_ZERO_NUM


402 
Çl_šfo
->
z”o1
 = 0;

403 
Çl_šfo
->
z”o2
 = 0;

405 
Çl_šfo
->
z”o3
 = 0;

406 
Çl_šfo
->
z”o4
 = 0;

407 
Çl_šfo
->
z”o5
 = 0;

408 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

409 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

410 
Çl_šfo
->
Çl_»f_idc
 = 
NAL_PRIORITY_LOW
;

411 
Çl_šfo
->
Çl_un™_ty³
 = 
NAL_TYPE_EX_PIC
;

413 
ext_Çl_mj³g_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_P_MJPEG
;

414 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
;

415  
»t
;

416 
	}
}

418 
	$g’_ext_mv_h—d”
(*
buf
, 
Ën
)

420 
ext_h264_Çl_b™¡»am_t
 *
ext_Çl_mv_h—d
 = (ext_h264_Çl_b™¡»am_t*)
buf
;

421 #ifdeà 
ADD_DVM_NAL_HEAD


422 
DVM_NAL_HEAD
 *
Çl_mv_h—d
;

424 
H264_NAL_INFO
 *
Çl_šfo
;

425 
»t
 ;

427 #ifdeà 
ADD_DVM_NAL_HEAD


428 
Çl_mv_h—d
 = &
ext_Çl_mv_h—d
->
h—d
;

430 
Çl_šfo
 = &
ext_Çl_mv_h—d
->
Çl
;

432 #ifdeà 
ADD_DVM_NAL_HEAD


433 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
 - (
DVM_NAL_HEAD
);

434 
Çl_mv_h—d
->
i_Çl_size_0_7
 = (
»t
&0xff);

435 
Çl_mv_h—d
->
i_Çl_size_8_15
 = ((
»t
>>8)&0xff);

436 
Çl_mv_h—d
->
i_Çl_size_16_23
 = ((
»t
>>16)&0xff);

437 
Çl_mv_h—d
->
e_Çl_ty³
 = 
DVM_NAL_MV
;

439 #ià
NAL_FILL_ZERO_NUM


440 
Çl_šfo
->
z”o1
 = 0;

441 
Çl_šfo
->
z”o2
 = 0;

443 
Çl_šfo
->
z”o3
 = 0;

444 
Çl_šfo
->
z”o4
 = 0;

445 
Çl_šfo
->
z”o5
 = 0;

446 
Çl_šfo
->
cÚ¡ªt_v®ue_1
 = 1;

447 
Çl_šfo
->
fÜbidd’_z”o_b™
 = 0;

448 
Çl_šfo
->
Çl_»f_idc
 = 
NAL_PRIORITY_LOW
;

449 
Çl_šfo
->
Çl_un™_ty³
 = 
NAL_TYPE_EX_MV
;

451 
ext_Çl_mv_h—d
->
ext_ty³
 = 
NAL_TYPE_EX_MV_D1
;

452 
»t
 = (
ext_h264_Çl_b™¡»am_t
è+ 
Ën
;

453  
»t
;

454 
	}
}

	@../../tw5864/tw5864/bar_ctl.c

7 
	~<tw5864/dvm_commÚ.h
>

9 
	#ROL
(
v®
, 
b™s
, 
wide
, 
mask
) do{ \

10 *(
v®
èğ(*(v®)<<(
b™s
è| *(v®)>>((
wide
è- (b™s))è& (
mask
); \

11 }0)

	)

12 
	#ROR
(
v®
, 
b™s
, 
wide
, 
mask
) do{ \

13 *(
v®
èğ(*(v®)>>(
b™s
è| *(v®)<<((
wide
è- (b™s))è& (
mask
); \

14 }0)

	)

16 
	gPAL_MAP
[13] = {

23 
	gNTSC_MAP
[16] = {

30 
	gGROUP_MAP
[121] = {

55 
u32
 
	$g‘_b™s_m­
(
u32
 
m
, u32 
n
)

57 
i
, 
div
, 
h®f
, 
sm®l
;

58 
m­
, 
mask
;

60 
mask
 = 0;

61 
i
 = 0; i < 
m
; i++){

62 
mask
 |ğ(1 << 
i
);

65 if(
n
 > 
m
){

66  
mask
;

69 
m­
 =0x00000000;

70 if((
m
 =ğ0è|| (
n
 == 0)){

71  
m­
;

72 }if(
m
 <ğ
n
){

73  
mask
;

76 
h®f
 = ((
m
) / 2);

77 if(
n
 <ğ
h®f
){

78 
sm®l
 = 
n
;

80 
sm®l
 = 
m
 - 
n
;

82 
div
 = 
m
 / 
sm®l
;

84 if(
m
 > 0){

85 
i
 = 0; i < 
sm®l
; i++){

86 
m­
 |ğ1 << (
i
 * 
div
);

90 if(
n
 > 
h®f
){

91 
m­
 = (~m­è& 
mask
;

93 !(
m­
 & 0x00000001)){

94 
	`ROR
(&
m­
, 1, 
m
, 
mask
);

97  (
m­
 & 
mask
);

98 
	}
}

100 
šlše
 
	$loÿ‹_m­
(
d1
, 
cif
)

102 if((
d1
 > 15è|| (d1 < 5è|| (
cif
 < 1) || (cif > 11))

108  (
d1
 - 5è* 11 + 
cif
 - 1;

109 
	}
}

119 
	$cb_»sŞve_g½
(*
š_chÆ
, *
š_fmt
, *
š_äm
,

120 
VGROUP_S
 *
vg½
, 
tÙ®
, 
g½út
)

122 
i
 = 0, 
j
 = 0, 
k
 = 0, 
d1_út
 = 0, 
h®fd1_út
 = 0, 
‹mp
 = 0, 
cif_út
 = 0;

123 
šv®
 = 0;

124 
fÜm©
[
TW_MAX_VI
], 
äm_¿‹
[TW_MAX_VI];

125 
‹mp_ch
[
TW_MAX_VI
] = {0};

126 
d1_±r
, 
cif_±r
, 
dœ
 = 0;

127 
g½_m­
 = 0x0;

129 if((
tÙ®
 <ğ0è|| (
g½út
 <= 0))

134 
	`mem£t
(
fÜm©
, 0, (è* 
TW_MAX_VI
);

135 
	`mem£t
(
äm_¿‹
, 0, (è* 
TW_MAX_VI
);

137 
i
 = 0; i < 
g½út
; i++)

139 
j
 = 0; j < 
TW_CHN_NO
; j++)

141 
vg½
[
i
].
š_£Ëù
[
j
] = 
TW_INVAL_CHN
;

142 
vg½
[
i
].
š_fmt
[
j
] = 
TW_VIDEO_SIZE_USER
;

143 
vg½
[
i
].
š_¿‹
[
j
] = -1;

148 
i
 = 0, 
j
 = 0, 
k
 = 0; i < 
tÙ®
; i++)

150 if(
š_chÆ
[
i
] =ğ
TW_INVAL_CHN
)

152 
šv®
++;

155 if((
š_fmt
[
i
] =ğ
TW_VIDEO_SIZE_D1
è|| (š_fmt[i] =ğ
TW_VIDEO_SIZE_HALF_D1
))

157 
‹mp_ch
[
j
] = 
š_chÆ
[
i
];

158 
fÜm©
[
j
] = 
š_fmt
[
i
];

159 
äm_¿‹
[
j
] = 
š_äm
[
i
];

160 
d1_út
++;

161 if(
š_fmt
[
i
] =ğ
TW_VIDEO_SIZE_HALF_D1
)

163 
h®fd1_út
++;

165 
j
++;

169 
‹mp_ch
[
tÙ®
 - 
k
 - 1] = 
š_chÆ
[
i
];

170 
fÜm©
[
tÙ®
 - 
k
 - 1] = 
š_fmt
[
i
];

171 
äm_¿‹
[
tÙ®
 - 
k
 - 1] = 
š_äm
[
i
];

172 
k
++;

175 
tÙ®
 -ğ
šv®
;

177 
i
 = 0; i < (
d1_út
 - 1); i++)

179 
j
 = 
i
; j < 
d1_út
; j++)

181 if(
äm_¿‹
[
i
] > frm_¿‹[
j
])

183 
‹mp
 = 
‹mp_ch
[
i
];

184 
‹mp_ch
[
i
] =emp_ch[
j
];

185 
‹mp_ch
[
j
] = 
‹mp
;

187 
‹mp
 = 
fÜm©
[
i
];

188 
fÜm©
[
i
] = fÜm©[
j
];

189 
fÜm©
[
j
] = 
‹mp
;

191 
‹mp
 = 
äm_¿‹
[
i
];

192 
äm_¿‹
[
i
] = frm_¿‹[
j
];

193 
äm_¿‹
[
j
] = 
‹mp
;

199 
i
 = 
d1_út
; i < 
tÙ®
 -1; i++)

201 
j
 = 
i
; j < 
tÙ®
; j++)

203 if(
äm_¿‹
[
i
] > frm_¿‹[
j
])

205 
‹mp
 = 
‹mp_ch
[
i
];

206 
‹mp_ch
[
i
] =emp_ch[
j
];

207 
‹mp_ch
[
j
] = 
‹mp
;

209 
‹mp
 = 
fÜm©
[
i
];

210 
fÜm©
[
i
] = fÜm©[
j
];

211 
fÜm©
[
j
] = 
‹mp
;

213 
‹mp
 = 
äm_¿‹
[
i
];

214 
äm_¿‹
[
i
] = frm_¿‹[
j
];

215 
äm_¿‹
[
j
] = 
‹mp
;

220 
cif_út
 = 
tÙ®
 - 
d1_út
;

223 if(
tÙ®
 <ğ
g½út
)

225 
i
 = 0; i < 
tÙ®
; i++)

227 
vg½
[
i
].
š_£Ëù
[0] = 
‹mp_ch
[i];

228 
vg½
[
i
].
š_fmt
[0] = 
fÜm©
[i];

229 
vg½
[
i
].
š_¿‹
[0] = 
äm_¿‹
[i];

230 
vg½
[
i
].
tÙ®
 = 1;

237 if((
d1_út
 <ğ
g½út
è|| (d1_úˆ=ğ
tÙ®
è|| (
h®fd1_út
 ==otal))

255 
g½_m­
 = 0xffffffff;

257 
g½_m­
 = 
GROUP_MAP
[
	`loÿ‹_m­
(
d1_út
, 
cif_út
)];

261 if(!
g½_m­
)

264 
	`TW_DBG
(
TW_DBG_ERR
, "dÚ'ˆexs™ m­, %dD1 + %dCIF = %d\n", 
d1_út
, 
cif_út
);

267 
d1_±r
 = 
d1_út
 - 1;

268 
cif_±r
ğ
d1_út
;

270 
j
 = 0; j < 
g½út
; j++){

271 
dœ
 = !dir;

272 if(
dœ
){

273 
i
 = (
g½út
 - 1); i >= 0; i--){

274 if(
g½_m­
 & (0x80000000 >> (
i
 * 
TW_CHN_NO
 + 
j
)))

276 if(
d1_±r
 < 0){

279 
vg½
[
i
].
š_£Ëù
[
j
] = 
‹mp_ch
[
d1_±r
];

280 
vg½
[
i
].
š_fmt
[
j
] = 
fÜm©
[
d1_±r
];

281 
vg½
[
i
].
š_¿‹
[
j
] = 
äm_¿‹
[
d1_±r
];

282 
vg½
[
i
].
tÙ®
++;

283 
d1_±r
--;

287 
i
 = 0; i < 
g½út
; i++){

288 if(
g½_m­
 & (0x80000000 >> (
i
 * 
TW_CHN_NO
 + 
j
)))

290 if(
d1_±r
 < 0){

293 
vg½
[
i
].
š_£Ëù
[
j
] = 
‹mp_ch
[
d1_±r
];

294 
vg½
[
i
].
š_fmt
[
j
] = 
fÜm©
[
d1_±r
];

295 
vg½
[
i
].
š_¿‹
[
j
] = 
äm_¿‹
[
d1_±r
];

296 
vg½
[
i
].
tÙ®
++;

297 
d1_±r
--;

304 
i
 = 0; i < 
g½út
; i++)

306 
j
 = 0; j < 
TW_CHN_NO
; j++)

308 if(
g½_m­
 & (0x00008000 >> (
i
 * 
TW_CHN_NO
 + 
j
)))

310 if(
cif_±r
 >ğ
tÙ®
){

313 if(
vg½
[
i
].
š_£Ëù
[
j
] !ğ
TW_INVAL_CHN
) {

316 
vg½
[
i
].
š_£Ëù
[
j
] = 
‹mp_ch
[
cif_±r
];

317 
vg½
[
i
].
š_fmt
[
j
] = 
fÜm©
[
cif_±r
];

318 
vg½
[
i
].
š_¿‹
[
j
] = 
äm_¿‹
[
cif_±r
];

319 
cif_±r
++;

320 
vg½
[
i
].
tÙ®
++;

326 
	}
}

329 
	$cb_»sŞve_outäame
(
VGROUP_S
 *
vg½
, 
nÜm
, 
i¥»v›w
)

332 
i
 = 0, 
cif_út
 = 0, 
h®fd1_út
 = 0, 
d1_út
 = 0;

333 
sum
 = 0, 
lo¡
 = 0;

334 
max_äm¿‹
 = (
nÜm
 =ğ
TW_VIDEO_STANDARD_PAL
è? 
TW_GRP_MAX_PFRAME
:
TW_GRP_MAX_NFRAME
;

337 if(
i¥»v›w
)

339 
	`memıy
(
vg½
->
out_¿‹
, vg½->
š_¿‹
, (è* 
TW_CHN_NO
);

343 
i
 = 0; i < 
vg½
->
tÙ®
; i++)

345 
vg½
->
š_fmt
[
i
])

347 
TW_VIDEO_SIZE_CIF
:

348 
cif_út
++;

350 
TW_VIDEO_SIZE_QCIF
:

351 
cif_út
++;

353 
TW_VIDEO_SIZE_HALF_D1
:

354 
h®fd1_út
++;

355 
sum
 +ğ
vg½
->
š_¿‹
[
i
];

357 
TW_VIDEO_SIZE_D1
:

358 
d1_út
++;

359 
sum
 +ğ
vg½
->
š_¿‹
[
i
];

362 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀvideØsiz%d\n", 
vg½
->
š_fmt
[
i
]);

367 if((((
d1_út
 + 
h®fd1_út
è=ğ2)||((d1_úˆ+ h®fd1_útè=ğ3)è&& 
cif_út
)

369 
	`TW_DBG
(
TW_DBG_ERR
, "nÙ suµÜˆ%dd1 + %dcif\n", (
d1_út
 + 
h®fd1_út
), 
cif_út
);

373 if(
d1_út
 && !
h®fd1_út
 && !
cif_út
)

375 
vg½
->
mode
 = 
MODE_D1
;

377 if(
d1_út
 && 
h®fd1_út
 && !
cif_út
)

379 
vg½
->
mode
 = 
MODE_D1_HALFD1
;

382 if(
d1_út
 && 
h®fd1_út
 && 
cif_út
)

384 
vg½
->
mode
 = 
MODE_D1_HALFD1_CIF
;

387 if(
d1_út
 && !
h®fd1_út
 && 
cif_út
)

389 
vg½
->
mode
 = 
MODE_D1_CIF
;

391 if(!
d1_út
 && 
h®fd1_út
 && !
cif_út
)

393 
vg½
->
mode
 = 
MODE_HALFD1
;

396 if(!
d1_út
 && 
h®fd1_út
 && 
cif_út
)

398 
vg½
->
mode
 = 
MODE_HALFD1_CIF
;

401 if(!
d1_út
 && !
h®fd1_út
 && 
cif_út
)

403 
vg½
->
mode
 = 
MODE_CIF
;

405 if(!
d1_út
 && !
h®fd1_út
 && !
cif_út
)

407 
vg½
->
mode
 = 
MODE_NONE
;

410 
lo¡
 = 
sum
;

411 
	`memıy
(
vg½
->
out_¿‹
, vg½->
š_¿‹
, (è* 
TW_CHN_NO
);

413 if(((
d1_út
 > 1è|| (
h®fd1_út
 > 1)) && (halfd1_cnt != 2))

415 
sum
 > 
max_äm¿‹
)

417 
i
 = 0; i < 
vg½
->
tÙ®
; i++)

419 if(
vg½
->
out_¿‹
[
i
] > (
max_äm¿‹
 / 
TW_CHN_NO
))

421 
vg½
->
out_¿‹
[
i
]--;

422 
sum
--;

423 if(
sum
 <ğ
max_äm¿‹
)

432 
vg½
->
tÙ®äm
 = 
sum
;

433 
lo¡
 -ğ
sum
;

435  
lo¡
;

436 
	}
}

438 
	$v”fiy_m­
(
tÙ®
, *
m­
, 
b™út
)

440 
i
 = 0, 
j
 = 0, 
ä©e
 = 0;

441 *
‹mp_m­
 = 
m­
;

443 
i
 = 0; i < 
b™út
; i++)

445 
ä©e
 = 0;

446 
j
 = 0; j < 
tÙ®
; j++)

448 
ä©e
 +ğ(
‹mp_m­
[
j
]>>
i
) & 0x01;

450 if(
ä©e
 > 2)

454 if((
ä©e
 >= 2) && ((

455 ((
‹mp_m­
[0]>>(
i
+1)) & 0x01)

456 + ((
‹mp_m­
[1]>>(
i
+1)) & 0x01)

457 + ((
‹mp_m­
[2]>>(
i
+1)) & 0x01)

458 + ((
‹mp_m­
[3]>>(
i
+1)) & 0x01)) >=2))

465 
	}
}

468 
	$cb_»sŞve_m­
(
VGROUP_S
 *
vg½
, 
nÜm
, 
i¥»v›w
)

470 
i
 = 0, 
j
 = 0, 
k
 = 0, 
have_cif
 = 0;

471 
ä©e
 = 0;

472 
max_äm¿‹
 = (
nÜm
 =ğ
TW_VIDEO_STANDARD_PAL
) ? 25:30;

473 *
‹mp_¿‹
 = 
vg½
->
out_¿‹
;

474 *
‹mp_ch
 = 
vg½
->
š_£Ëù
;

475 *
‹mp_m­
 = 
vg½
->
š_m­
;

476 
mask
 = 0x1ffffff;

479 
	`memıy
(
‹mp_ch
, 
vg½
->
š_£Ëù
, (è* 
TW_CHN_NO
);

480 
	`mem£t
(
‹mp_m­
, 0, (è* 
TW_CHN_NO
);

482 if(
i¥»v›w
)

484 
i
 = 0; i < 
TW_CHN_NO
; i++)

486 if(
vg½
->
š_£Ëù
[
i
] != -1)

488 if(
nÜm
 =ğ
TW_VIDEO_STANDARD_PAL
){

489 if(
vg½
->
out_¿‹
[
i
] < ((
max_äm¿‹
 + 1) >> 1)){

490 
vg½
->
š_m­
[
i
] = 
PAL_MAP
[vg½->
out_¿‹
[i]];

493 
vg½
->
š_m­
[
i
] = ~
PAL_MAP
[
max_äm¿‹
 - vg½->
out_¿‹
[i]];

495 
mask
 = 0x1ffffff;

498 if(
vg½
->
out_¿‹
[
i
] <ğ((
max_äm¿‹
 + 1) >> 1)){

499 
vg½
->
š_m­
[
i
] = 
NTSC_MAP
[vg½->
out_¿‹
[i]];

502 
vg½
->
š_m­
[
i
] = ~
NTSC_MAP
[
max_äm¿‹
 - vg½->
out_¿‹
[i]];

504 
mask
 = 0x3fffffff;

506 
vg½
->
š_m­
[
i
] &ğ
mask
;

513 
i
 = 0; i < 
vg½
->
tÙ®
; i++)

515 if((
vg½
->
š_fmt
[
i
] =ğ
TW_VIDEO_SIZE_CIF
è|| (vg½->š_fmt[i] =ğ
TW_VIDEO_SIZE_QCIF
))

517 
have_cif
 = 1;

519 if(
nÜm
 =ğ
TW_VIDEO_STANDARD_PAL
)

521 if(
vg½
->
out_¿‹
[
i
] < ((
max_äm¿‹
 + 1) >> 1))

523 
vg½
->
š_m­
[
i
] = 
PAL_MAP
[vg½->
out_¿‹
[i]];

527 
vg½
->
š_m­
[
i
] = ~
PAL_MAP
[
max_äm¿‹
 - vg½->
out_¿‹
[i]];

529 
mask
 = 0x1ffffff;

533 if(
vg½
->
out_¿‹
[
i
] <ğ((
max_äm¿‹
 + 1) >> 1))

535 
vg½
->
š_m­
[
i
] = 
NTSC_MAP
[vg½->
out_¿‹
[i]];

539 
vg½
->
š_m­
[
i
] = ~
NTSC_MAP
[
max_äm¿‹
 - vg½->
out_¿‹
[i]];

541 
mask
 = 0x3fffffff;

543 
vg½
->
š_m­
[
i
] &ğ
mask
;

547 if(
have_cif
 || ((
vg½
->
mode
 =ğ
MODE_HALFD1
è&& (vg½->
tÙ®
 == 2)))

552 
i
 = 0; i < 
vg½
->
tÙ®
 - 1; i++)

554 
j
 = 
i
; j < 
vg½
->
tÙ®
; j++)

556 if(
‹mp_¿‹
[
i
] <emp_¿‹[
j
])

559 
ä©e
 = 
vg½
->
š_¿‹
[
i
];

560 
vg½
->
š_¿‹
[
i
] = vg½->š_¿‹[
j
];

561 
vg½
->
š_¿‹
[
j
] = 
ä©e
;

563 
ä©e
 = 
‹mp_¿‹
[
i
];

564 
‹mp_¿‹
[
i
] =emp_¿‹[
j
];

565 
‹mp_¿‹
[
j
] = 
ä©e
;

567 
ä©e
 = 
‹mp_ch
[
i
];

568 
‹mp_ch
[
i
] =emp_ch[
j
];

569 
‹mp_ch
[
j
] = 
ä©e
;

571 
ä©e
 = 
‹mp_m­
[
i
];

572 
‹mp_m­
[
i
]ğ‹mp_m­[
j
];

573 
‹mp_m­
[
j
]ğ
ä©e
;

578 if(
nÜm
 =ğ
TW_VIDEO_STANDARD_NTSC
)

580 if(
‹mp_¿‹
[0] == 9)

581 
j
=1;

583 
j
=2;

587 if((
‹mp_¿‹
[0] > 7) && (temp_rate[0] < 10))

588 
j
=1;

590 
j
=3;

592 
i
 = 0; i < 
vg½
->
tÙ®
; i++)

595 
	`ROL
(&
‹mp_m­
[
i
], 
j
*i, 
max_äm¿‹
, 
mask
);

598 if(!
	`v”fiy_m­
(
vg½
->
tÙ®
, 
‹mp_m­
, 
max_äm¿‹
))

603 
i
 = 0; i <ğ
max_äm¿‹
; i++)

605 
	`ROR
(&
‹mp_m­
[1], 1, 
max_äm¿‹
, 
mask
);

606 
j
 = 0; j <ğ
max_äm¿‹
; j++)

608 
	`ROR
(&
‹mp_m­
[2], 1, 
max_äm¿‹
, 
mask
);

609 
k
 = 0; k <ğ
max_äm¿‹
; k++)

611 
	`ROR
(&
‹mp_m­
[3], 1, 
max_äm¿‹
, 
mask
);

612 if(!
	`v”fiy_m­
(
vg½
->
tÙ®
, 
‹mp_m­
, 
max_äm¿‹
))

620 
	`TW_DBG
(
TW_DBG_ERR
, "uÇbËØg’”©m­ (%d, %d, %d, %dètÙ® %d\n", 
‹mp_¿‹
[0],emp_¿‹[1],emp_¿‹[2],emp_¿‹[3], 
vg½
->
tÙ®
);

622  
TW_ERR
;

623 
	}
}

639 
	$cb_ù¾_ÿlcuÏ‹
(*
chn
, *
fÜm©
, *
¿‹
, 
nÜm
, 
VGROUP_S
 *
vgroup
, 
couÁ
, 
adju¡
)

641 
i
 = 0, 
j
 = 0, 
lo¡
 = 0;

642 
s32R‘
 = 0;

643 
šv®id
 = 0;

644 
VGROUP_S
 
loÿl_g½
[
TW_MAX_GRP
];

645 
loÿl_chn
[
TW_MAX_VI
];

646 
loÿl_fÜm©
[
TW_MAX_VI
];

647 
loÿl_¿‹
[
TW_MAX_VI
];

648 
chª_mask
 = 0;

650 
	`mem£t
(
loÿl_g½
, 0, (
VGROUP_S
è* 
TW_MAX_GRP
);

651 
	`mem£t
(
loÿl_chn
, 0, (local_chn));

652 
	`mem£t
(
loÿl_fÜm©
, 0, (local_format));

653 
	`mem£t
(
loÿl_¿‹
, 0, (local_rate));

655 if((
couÁ
 < 0è|| (couÁ > 
TW5864_PHY_VD_CHAN_NUMBER
)) {

656 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈcouÁ %d ov”æow\n", 
couÁ
);

657  -
EINVAL
;

659 
	`TW_DBG
(
TW_DBG_INFO
, "nÜm %d, couÁ %d,‡dju¡ %d\n", 
nÜm
, 
couÁ
, 
adju¡
);

660 
i
 = 0; i < 
couÁ
; i++)

662 if((
chn
[
i
] >ğ
TW5864_PHY_VD_CHAN_NUMBER
) || (chn[i] < 0))

664 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈnumb” %d ov”æow\n", 
chn
[
i
]);

665  -
EINVAL
;

667 
loÿl_chn
[
i
] = 
chn
[i];

668 
loÿl_fÜm©
[
i
] = 
fÜm©
[i];

669 
loÿl_¿‹
[
i
] = 
¿‹
[i];

670 
chª_mask
 |ğ1<<
loÿl_chn
[
i
];

673 
j
 = 0;

674 ; 
i
 < 
TW_MAX_VI
; i++)

676 (
chª_mask
&(1 << 
j
)è&& (j < 
TW_MAX_VI
))

677 
j
++;

678 
loÿl_chn
[
i
] = 
j
++;

679 
loÿl_fÜm©
[
i
] = 
TW_VIDEO_SIZE_D1
;

680 
loÿl_¿‹
[
i
] = 0;

683 
s32R‘
 = 
	`cb_»sŞve_g½
(
loÿl_chn
, 
loÿl_fÜm©
, 
loÿl_¿‹
, 
loÿl_g½
, 
couÁ
, 
TW_MAX_GRP
);

684 if(
s32R‘
){

685 
	`TW_DBG
(
TW_DBG_ERR
, "Unableo fix group\n");

686  
s32R‘
;

689 
šv®id
 = 
couÁ
;

690 
i
 = 0; i < 
TW_MAX_GRP
; i++)

692 
lo¡
 +ğ
	`cb_»sŞve_outäame
(&
loÿl_g½
[
i
], 
nÜm
, 0);

693 
s32R‘
 = 
	`cb_»sŞve_m­
(&
loÿl_g½
[
i
], 
nÜm
, 0);

694 if(
s32R‘
){

695 
	`TW_DBG
(
TW_DBG_ERR
, "Unableo fix map\n");

696  -
EINVAL
;

698 
j
 = 0; j < 
TW_CHN_NO
; j++)

700 if(
loÿl_g½
[
i
].
tÙ®
 < (
j
 + 1))

702 
loÿl_g½
[
i
].
š_£Ëù
[
j
] = 
loÿl_chn
[
šv®id
++];

703 
loÿl_g½
[
i
].
š_m­
[
j
] = 0x0;

704 
loÿl_g½
[
i
].
š_¿‹
[
j
] = 0x0;

705 
loÿl_g½
[
i
].
out_¿‹
[
j
] = 0x0;

706 
loÿl_g½
[
i
].
š_fmt
[
j
] = 
TW_VIDEO_SIZE_D1
;

709 
loÿl_g½
[
i
].
g½_id
 = i;

712 if(
lo¡
 < 0)

716 
	`memıy
(
vgroup
, 
loÿl_g½
, (
VGROUP_S
è* 
TW_MAX_GRP
);

718 if(
lo¡
 && !
adju¡
)

720 
	`TW_DBG
(
TW_DBG_ERR
, "Too many frame in one bus\n");

722  
lo¡
;

727 
	}
}

737 
	$´ev›w_»sŞve_g½
(*
š_chÆ
, *
š_fmt
, *
š_äm
,

738 
VGROUP_S
 *
vg½
, 
tÙ®
, 
g½út
)

740 
cif
[
TW_MAX_VI
], 
d1
[TW_MAX_VI], 
qcif
[TW_MAX_VI];

741 
cif_út
 = 0, 
d1_út
 = 0, 
qcif_út
 = 0;

742 
i
,
j
,
k
;

743 
ÿ·b™y
 = 0;

746 if(!
š_chÆ
 || !
š_fmt
 || !
š_äm
 || !
vg½
 || (
tÙ®
 > 
TW_MAX_VI
)

747 || (
tÙ®
 < 0è|| (
g½út
 > 
TW_MAX_GRP
) || (grpcnt < 0))

752 
i
 = 0; i < 
tÙ®
; i++)

754 
š_fmt
[
i
])

756 
TW_VIDEO_SIZE_D1
:

757 
d1
[
d1_út
] = 
š_chÆ
[
i
];

758 
d1
[
d1_út
] <<= 16;

759 
d1
[
d1_út
] |ğ
š_äm
[
i
];

760 
d1_út
++;

761 
ÿ·b™y
 += 8;

763 
TW_VIDEO_SIZE_CIF
:

764 
cif
[
cif_út
] = 
š_chÆ
[
i
];

765 
cif
[
cif_út
] <<= 16;

766 
cif
[
cif_út
] |ğ
š_äm
[
i
];

767 
cif_út
++;

768 
ÿ·b™y
 += 4;

770 
TW_VIDEO_SIZE_QCIF
:

771 
qcif
[
qcif_út
] = 
š_chÆ
[
i
];

772 
qcif
[
qcif_út
] <<= 16;

773 
qcif
[
qcif_út
] |ğ
š_äm
[
i
];

774 
qcif_út
++;

775 
ÿ·b™y
 += 1;

783 if((
d1_út
 =ğ1è&& (
cif_út
 == 4))

785 
i
 = 0; i < 
g½út
; i++)

787 
vg½
[
i
].
š_£Ëù
[0] = 
cif
[i]>>16;

788 
vg½
[
i
].
š_¿‹
[0] = 
cif
[i] & 0xffff;

789 
vg½
[
i
].
š_fmt
[0] = 
TW_VIDEO_SIZE_CIF
;

790 
vg½
[
i
].
tÙ®
 = 1;

791 if(
d1_út
 && (
i
 == 0))

793 
vg½
[
i
].
š_£Ëù
[2] = 
d1
[i]>>16;

794 
vg½
[
i
].
š_¿‹
[2] = 
d1
[i] & 0xffff;

795 
vg½
[
i
].
š_fmt
[2] = 
TW_VIDEO_SIZE_D1
;

796 
vg½
[
i
].
tÙ®
 = 2;

799 
vg½
[0].
mode
 = 
MODE_NONE
;

805 if(((
cif_út
 =ğ9è|| (cif_úˆ=ğ10)è&& !
d1_út
 && !
qcif_út
)

807 
j
 = 0;

808 
i
 = 0; i < 8; i++)

810 if(((
i
 % 
TW_MAX_GRP
) == 0) && (i != 0))

812 
j
++;

814 
vg½
[
i
 % 
TW_MAX_GRP
].
š_£Ëù
[
j
] = 
cif
[i]>>16;

815 
vg½
[
i
 % 
TW_MAX_GRP
].
š_¿‹
[
j
] = 
cif
[i] & 0xffff;

816 
vg½
[
i
 % 
TW_MAX_GRP
].
š_fmt
[
j
] = 
TW_VIDEO_SIZE_CIF
;

817 
vg½
[
i
 % 
TW_MAX_GRP
].
tÙ®
 = 2;

821 
j
 = 0; 
i
 < 
tÙ®
; i++, j++)

823 
vg½
[0].
š_£Ëù
[2 + 
j
] = 
cif
[
i
]>>16;

824 
vg½
[0].
š_¿‹
[2 + 
j
] = 
cif
[
i
] & 0xffff;

825 
vg½
[0].
š_fmt
[2 + 
j
] = 
TW_VIDEO_SIZE_CIF
;

826 
vg½
[0].
tÙ®
 += 1;

828 
vg½
[0].
mode
 = 
MODE_NONE
;

834 if(
ÿ·b™y
 > 32)

839 
vg½
[0].
mode
 = 
MODE_D1
;

840 
j
 = 0;

842 
i
 = 0; (˜< 
d1_út
è&& (
j
 < 
TW_MAX_GRP
); i++)

844 
vg½
[
j
].
š_£Ëù
[2] = 
d1
[
i
]>>16;

845 
vg½
[
j
].
š_¿‹
[2] = 
d1
[
i
] & 0xffff;

846 
vg½
[
j
].
š_fmt
[2] = 
TW_VIDEO_SIZE_D1
;

847 
vg½
[
j
].
tÙ®
 += 1;

848 
j
++;

852 
i
 = 0, 
k
 = 0; (˜< 
cif_út
è&& (
j
 < 
TW_MAX_GRP
); i++)

854 if((
k
 % 2 == 0) && (k != 0))

856 
k
 = 0;

857 
j
++;

859 
vg½
[
j
].
š_£Ëù
[
k
] = 
cif
[
i
]>>16;

860 
vg½
[
j
].
š_¿‹
[
k
] = 
cif
[
i
] & 0xffff;

861 
vg½
[
j
].
š_fmt
[
k
] = 
TW_VIDEO_SIZE_CIF
;

862 
vg½
[
j
].
tÙ®
 += 1;

863 
k
++;

868 
i
 = 0, 
k
 = 0; i < 
qcif_út
; i++)

870 if((
k
 % 4 == 0) && (k != 0))

872 
k
 = 0;

873 
j
++;

876 if(
j
 =ğ
TW_MAX_GRP
)

881 
vg½
[
j
].
š_£Ëù
[
k
] = 
qcif
[
i
]>>16;

882 
vg½
[
j
].
š_¿‹
[
k
] = 
qcif
[
i
] & 0xffff;

883 
vg½
[
j
].
š_fmt
[
k
] = 
TW_VIDEO_SIZE_QCIF
;

884 
vg½
[
j
].
tÙ®
 += 1;

885 
k
++;

888 if((
i
 < 
qcif_út
è&& (
j
 =ğ
TW_MAX_GRP
))

890 
k
 = 0; (k < 
TW_CHN_NO
è&& (
i
 < 
qcif_út
); k++)

892 if(
k
 == 2)

896 
vg½
[0].
š_£Ëù
[
k
] = 
qcif
[
i
]>>16;

897 
vg½
[0].
š_¿‹
[
k
] = 
qcif
[
i
] & 0xffff;

898 
vg½
[0].
š_fmt
[
k
] = 
TW_VIDEO_SIZE_QCIF
;

899 
vg½
[0].
tÙ®
 += 1;

900 
i
++;

902 
vg½
[0].
mode
 = 
MODE_NONE
;

905 if(
i
 !ğ
qcif_út
)

911 
	}
}

927 
	$´ev›w_ù¾_ÿlcuÏ‹
(*
chn
, *
fÜm©
, *
¿‹
, 
nÜm
, 
VGROUP_S
 *
vgroup
, 
couÁ
, 
adju¡
)

929 
i
 = 0, 
j
 = 0, 
lo¡
 = 0;

930 
s32R‘
 = 0;

931 
šv®id
 = 0;

932 
VGROUP_S
 
loÿl_g½
[
TW_MAX_GRP
];

933 
loÿl_chn
[
TW_MAX_VI
];

934 
loÿl_fÜm©
[
TW_MAX_VI
];

935 
loÿl_¿‹
[
TW_MAX_VI
];

936 
chª_mask
 = 0;

938 
	`mem£t
(
loÿl_g½
, 0xff, (
VGROUP_S
è* 
TW_MAX_GRP
);

939 
	`mem£t
(
loÿl_chn
, 0, (local_chn));

940 
	`mem£t
(
loÿl_fÜm©
, 0, (local_format));

941 
	`mem£t
(
loÿl_¿‹
, 0, (local_rate));

944 
adju¡
 = 1;

946 
i
 = 0; i < 
couÁ
; i++)

948 if((
chn
[
i
] >= 16) || (chn[i] < 0))

952 
loÿl_chn
[
i
] = 
chn
[i];

953 
loÿl_fÜm©
[
i
] = 
fÜm©
[i];

954 
loÿl_¿‹
[
i
] = 
¿‹
[i];

955 
chª_mask
 |ğ1<<
loÿl_chn
[
i
];

959 
j
 = 0;

960 ; 
i
 < 
TW_MAX_VI
; i++)

962 (
chª_mask
&(1 << 
j
)è&& (j < 
TW_MAX_VI
))

963 
j
++;

964 
loÿl_chn
[
i
] = 
j
++;

965 
loÿl_fÜm©
[
i
] = 
TW_VIDEO_SIZE_D1
;

966 
loÿl_¿‹
[
i
] = 0;

969 
s32R‘
 = 
	`´ev›w_»sŞve_g½
(
loÿl_chn
, 
loÿl_fÜm©
, 
loÿl_¿‹
, 
loÿl_g½
, 
couÁ
, 
TW_MAX_GRP
);

970 if(
s32R‘
){

971  
s32R‘
;

974 
šv®id
 = 
couÁ
;

975 
i
 = 0; i < 
TW_MAX_GRP
; i++)

977 
lo¡
 +ğ
	`cb_»sŞve_outäame
(&
loÿl_g½
[
i
], 
nÜm
, 1);

978 
s32R‘
 = 
	`cb_»sŞve_m­
(&
loÿl_g½
[
i
], 
nÜm
, 1);

979 if(
s32R‘
){

982 
loÿl_g½
[
i
].
g½_id
 = i;

983 
j
 = 0; j < 
TW_CHN_NO
; j++)

985 if(
loÿl_g½
[
i
].
š_£Ëù
[
j
] == -1)

987 
loÿl_g½
[
i
].
š_£Ëù
[
j
] = 
loÿl_chn
[
šv®id
++];

988 
loÿl_g½
[
i
].
š_m­
[
j
] = 0x0;

989 
loÿl_g½
[
i
].
š_¿‹
[
j
] = 0x0;

990 
loÿl_g½
[
i
].
out_¿‹
[
j
] = 0x0;

991 
loÿl_g½
[
i
].
š_fmt
[
j
] = 
TW_VIDEO_SIZE_QCIF
;

996 if(
lo¡
 < 0)

1001 if(
lo¡
 && !
adju¡
)

1003  
lo¡
;

1006 
	`memıy
(
vgroup
, 
loÿl_g½
, (
VGROUP_S
è* 
TW_MAX_GRP
);

1009 
	}
}

	@../../tw5864/tw5864/chip_bus_scheduler.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
tw_roÙ_bus_t
 
	groÙ_bus
;

4 
ty³_bus_t
 
	gtw_ho¡_bus
;

5 
ty³_bus_t
 
	gtw_pci_bus
;

7 
	$»gi¡”_node_š™_com¶‘e
(
tw_»gi¡”_node_t
 *
node
)

9 if(
node
 !ğ
NULL
){

10 
	`š™_com¶‘iÚ
(&
node
->
wa™_¡İ
);

12 
	}
}

14 
	$»gi¡”_node_wa™_com¶‘e
(
tw_»gi¡”_node_t
 *
node
)

16 if(
node
 !ğ
NULL
){

17 
	`wa™_fÜ_com¶‘iÚ
(&
node
->
wa™_¡İ
);

19 
	}
}

21 
	$»gi¡”_node_com¶‘e_dÚe
(
tw_»gi¡”_node_t
 *
node
)

23 if(
node
 !ğ
NULL
){

24 
	`com¶‘e_®l
(&
node
->
wa™_¡İ
);

26 
	}
}

28 
tw_»gi¡”_node_İ”©iÚ
 
	gtw_»gi¡”_node_İ
 = {

29 .
š™_com¶‘e
 = 
»gi¡”_node_š™_com¶‘e
,

30 .
	gwa™_com¶‘e
 = 
»gi¡”_node_wa™_com¶‘e
,

31 .
	gcom¶‘e_dÚe
 = 
»gi¡”_node_com¶‘e_dÚe
,

34 
	$š™_»gi¡”_node
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
nÙify_»gi¡”_node_´iv
 
nÙify_´iv
, 
m©ch_»gs™”_node_´iv_id
 
m©ch_id
)

36 if(
node
 !ğ
NULL
){

37 
	`INIT_LIST_HEAD
(&
node
->
li¡
);

38 
node
->
»gi¡”_node_´iv
 = 
´iv
;

39 
node
->
nÙify_´iv
 =‚otify_priv;

40 
node
->
m©ch_id
 = match_id;

41 
node
->
İ
 = &
tw_»gi¡”_node_İ
;

42 
node
->
İ
->
	`š™_com¶‘e
(node);

43 
node
->
İ
->
	`com¶‘e_dÚe
(node);

45 
	}
}

47 
	$»gi¡”_bË_node_»gi¡”_node_što_bË
(
tw_»gi¡”_bË_t
 *
»gi¡”_bË
, 
tw_»gi¡”_node_t
 *
»gi¡”_node
)

49 if((
»gi¡”_bË
!=
NULL
è&& (
»gi¡”_node
!=NULL)){

50 
æags
;

51 
	`¥š_lock_œq§ve
(&
»gi¡”_bË
->
lock
, 
æags
);

52 
	`©omic_šc
(&
»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
);

53 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

54 
»gi¡”_node
->
İ
->
	`š™_com¶‘e
(register_node);

56 
	`li¡_add_
(&
»gi¡”_node
->
li¡
, &
»gi¡”_bË
->
»gi¡”_h—d”
);

57 
	`¥š_uÆock_œq»¡Üe
(&
»gi¡”_bË
->
lock
, 
æags
);

59 
	}
}

61 
	$»gi¡”_bË_node_uÄegi¡”_node_äom_bË
(
tw_»gi¡”_bË_t
 *
»gi¡”_bË
, 
tw_»gi¡”_node_t
 *
±r_»gi¡”_node
)

63 if((
»gi¡”_bË
!=
NULL
è&& (
±r_»gi¡”_node
!=NULL)){

64 if(
	`©omic_»ad
(&
»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
)){

65 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

66 
li¡_h—d
 *
li¡
;

67 
æags
;

68 
	`¥š_lock_œq§ve
(&
»gi¡”_bË
->
lock
, 
æags
);

69 
	`li¡_fÜ_—ch
(
li¡
, &
»gi¡”_bË
->
»gi¡”_h—d”
){

70 
»gi¡”_node
 = 
	`to_g‘_»gi¡”_node
(
li¡
);

71 if(
±r_»gi¡”_node
 =ğ
»gi¡”_node
){

72 
	`¥š_uÆock_œq»¡Üe
(&
»gi¡”_bË
->
lock
, 
æags
);

73 if(
±r_»gi¡”_node
->
nÙify_´iv
 !ğ
NULL
){

74 
±r_»gi¡”_node
->
	`nÙify_´iv
ÕŒ_»gi¡”_node,…Œ_»gi¡”_node->
»gi¡”_node_´iv
, 
NULL
);

76 if(
±r_»gi¡”_node
->
İ
 !ğ
NULL
){

77 
±r_»gi¡”_node
->
İ
->
	`wa™_com¶‘e
(ptr_register_node);

80 
	`¥š_lock_œq§ve
(&
»gi¡”_bË
->
lock
, 
æags
);

81 
	`©omic_dec
(&
»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
);

82 
	`li¡_d–_š™
(&
»gi¡”_node
->
li¡
);

83 
	`¥š_uÆock_œq»¡Üe
(&
»gi¡”_bË
->
lock
, 
æags
);

87 
	`¥š_uÆock_œq»¡Üe
(&
»gi¡”_bË
->
lock
, 
æags
);

90 
	}
}

92 
	$»gi¡”_bË_node_fšd_»gi¡”_node_š_bË
(
tw_»gi¡”_bË_t
 *
»gi¡”_bË
, 
tw_»gi¡”_node_t
 **
±r_»gi¡”_node
, 
¬g_id
)

94 if((
»gi¡”_bË
!=
NULL
è&& (
±r_»gi¡”_node
!=NULL)){

95 *
±r_»gi¡”_node
 = 
NULL
;

96 if(
	`©omic_»ad
(&
»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
)){

97 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

98 
li¡_h—d
 *
li¡
;

99 
æags
;

101 
	`¥š_lock_œq§ve
(&
»gi¡”_bË
->
lock
, 
æags
);

102 
	`li¡_fÜ_—ch
(
li¡
, &
»gi¡”_bË
->
»gi¡”_h—d”
){

103 
»gi¡”_node
 = 
	`to_g‘_»gi¡”_node
(
li¡
);

104 if(
»gi¡”_node
->
m©ch_id
 !ğ
NULL
){

105 if(
»gi¡”_node
->
	`m©ch_id
Ôegi¡”_node,„egi¡”_node->
»gi¡”_node_´iv
, 
¬g_id
è=ğ
TW_OK
){

106 *
±r_»gi¡”_node
 = 
»gi¡”_node
;

111 
	`¥š_uÆock_œq»¡Üe
(&
»gi¡”_bË
->
lock
, 
æags
);

114 
	}
}

116 
	$»gi¡”_bË_node_g‘_cu¼_»gi¡”_node_numb”
(
tw_»gi¡”_bË_t
 *
»gi¡”_bË
)

118 
»t
 = 0;

119 if(
»gi¡”_bË
 !ğ
NULL
){

120 
»t
 = 
	`©omic_»ad
(&
»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
);

122  
»t
;

123 
	}
}

125 
»gi¡”_bË_node_İ”©iÚ
 
	g»gi¡”_bË_node_İ
 = {

126 .
»gi¡”_node_što_bË
 = 
»gi¡”_bË_node_»gi¡”_node_što_bË
,

127 .
	guÄegi¡”_node_äom_bË
 = 
»gi¡”_bË_node_uÄegi¡”_node_äom_bË
,

128 .
	gfšd_»gi¡”_node_š_bË
 = 
»gi¡”_bË_node_fšd_»gi¡”_node_š_bË
,

129 .
	gg‘_cu¼_»gi¡”_node_numb”
 = 
»gi¡”_bË_node_g‘_cu¼_»gi¡”_node_numb”
,

132 
	$š™_»gi¡”_bË_node
(
tw_»gi¡”_bË_t
 *
bË
)

134 if(
bË
 !ğ
NULL
){

135 
	`¥š_lock_š™
(&
bË
->
lock
);

136 
	`INIT_LIST_HEAD
(&
bË
->
»gi¡”_h—d”
);

137 
	`©omic_£t
(&
bË
->
cu¼_»gi¡”_’Œy_numb”
, 0);

138 
bË
->
İ
 = &
»gi¡”_bË_node_İ
;

140 
	}
}

142 
	$g‘_roÙ_bus
(
tw_roÙ_bus_t
 **
±r_roÙ_bus
)

144 *
±r_roÙ_bus
 = &
roÙ_bus
;

145 
	}
}

147 
	$g‘_tw_ho¡_bus
(
ty³_bus_t
 **
±r_ty³_bus
)

149 *
±r_ty³_bus
 = &
tw_ho¡_bus
;

150 
	}
}

152 
	$g‘_tw_pci_bus
(
ty³_bus_t
 **
±r_ty³_bus
)

154 *
±r_ty³_bus
 = &
tw_pci_bus
;

155 
	}
}

157 
	$š™_tw_roÙ_bus
()

159 
	`š™_»gi¡”_bË_node
(&
roÙ_bus
.
roÙ_»gi¡”_bË
);

160 
	`š™_ty³_bus
(&
tw_ho¡_bus
, 
TW_ED_HOST_BUS
);

161 
	`š™_ty³_bus
(&
tw_pci_bus
, 
TW_ED_PCI_BUS
);

162 
	}
}

164 
	$»move_tw_roÙ_bus
()

166 
tw_roÙ_bus_t
 *
roÙ_bus
;

167 
ty³_bus_t
 *
tw_ho¡_bus
;

168 
ty³_bus_t
 *
tw_pci_bus
;

170 
	`g‘_roÙ_bus
(&
roÙ_bus
);

171 
	`g‘_tw_ho¡_bus
(&
tw_ho¡_bus
);

172 
	`g‘_tw_pci_bus
(&
tw_pci_bus
);

174 if(
tw_ho¡_bus
->
ty³_bus_roÙ_»gi¡”_bË
.
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(&tw_host_bus->type_bus_root_register_table) == 0){

175 
tw_ho¡_bus
->
»gi¡”_node
.
İ
->
	`com¶‘e_dÚe
(&tw_host_bus->register_node);

177 
roÙ_bus
->
roÙ_»gi¡”_bË
.
İ
->
	`uÄegi¡”_node_äom_bË
(&roÙ_bus->roÙ_»gi¡”_bË, &
tw_ho¡_bus
->
»gi¡”_node
);

178 if(
tw_pci_bus
->
ty³_bus_roÙ_»gi¡”_bË
.
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(&tw_pci_bus->type_bus_root_register_table) == 0){

179 
tw_pci_bus
->
»gi¡”_node
.
İ
->
	`com¶‘e_dÚe
(&tw_pci_bus->register_node);

181 
roÙ_bus
->
roÙ_»gi¡”_bË
.
İ
->
	`uÄegi¡”_node_äom_bË
(&roÙ_bus->roÙ_»gi¡”_bË, &
tw_pci_bus
->
»gi¡”_node
);

182 
	}
}

184 
	$nÙify_»gi¡”_ty³_bus
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
tw_nÙify_msg
 *
msg
)

186 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

187 
ty³_bus_t
 *
ty³_bus
 = (ty³_bus_t*)
´iv
;

188 
tw_»gi¡”_bË_t
 *
ty³_bus_roÙ_»gi¡”_bË
 = &
ty³_bus
->type_bus_root_register_table;

190 if(
	`©omic_»ad
(&
ty³_bus_roÙ_»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
)){

191 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

192 
li¡_h—d
 *
li¡
;

193 
æags
;

194 
	`¥š_lock_œq§ve
(&
ty³_bus_roÙ_»gi¡”_bË
->
lock
, 
æags
);

195 
	`li¡_fÜ_—ch
(
li¡
, &
ty³_bus_roÙ_»gi¡”_bË
->
»gi¡”_h—d”
){

196 
»gi¡”_node
 = 
	`to_g‘_»gi¡”_node
(
li¡
);

197 
	`¥š_uÆock_œq»¡Üe
(&
ty³_bus_roÙ_»gi¡”_bË
->
lock
, 
æags
);

198 if(
»gi¡”_node
->
nÙify_´iv
 !ğ
NULL
){

199 
»gi¡”_node
->
	`nÙify_´iv
Ôegi¡”_node,„egi¡”_node->
»gi¡”_node_´iv
, 
NULL
);

201 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

202 
»gi¡”_node
->
İ
->
	`wa™_com¶‘e
(register_node);

204 
	`¥š_lock_œq§ve
(&
ty³_bus_roÙ_»gi¡”_bË
->
lock
, 
æags
);

206 
	`¥š_uÆock_œq»¡Üe
(&
ty³_bus_roÙ_»gi¡”_bË
->
lock
, 
æags
);

208 if(
ty³_bus
->
»gi¡”_node
.
İ
 !ğ
NULL
){

209 
ty³_bus
->
»gi¡”_node
.
İ
->
	`wa™_com¶‘e
(&type_bus->register_node);

212 
	}
}

214 
	$m©ch_»gs™”_ty³_bus
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
id
)

216 
»t
 = 
TW_ERR
;

217 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

218 
ty³_bus_t
 *
bus
 = (ty³_bus_t*)
´iv
;

219 if(
bus
->
bus_id
 =ğ
id
){

220 
»t
 = 
TW_OK
;

223  
»t
;

224 
	}
}

226 
	$ty³_bus_š™
(
ty³_bus_t
 *
bus
, 
bus_id
)

228 if(
bus
 !ğ
NULL
){

229 
tw_roÙ_bus_t
 *
roÙBus
;

230 
bus
->
bus_id
 = bus_id;

231 
	`š™_»gi¡”_node
(&
bus
->
»gi¡”_node
, bus, 
nÙify_»gi¡”_ty³_bus
, 
m©ch_»gs™”_ty³_bus
);

232 
	`š™_»gi¡”_bË_node
(&
bus
->
ty³_bus_roÙ_»gi¡”_bË
);

233 
	`g‘_roÙ_bus
(&
roÙBus
);

234 if(
roÙBus
->
roÙ_»gi¡”_bË
.
İ
 !ğ
NULL
){

235 
roÙBus
->
roÙ_»gi¡”_bË
.
İ
->
	`»gi¡”_node_što_bË
(&roÙBus->roÙ_»gi¡”_bË, &
bus
->
»gi¡”_node
);

238 
	}
}

240 
	$ty³_bus_»gi¡”_ch_bus_što_ty³_bus_bË
(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 *
ch_bus
)

242 if((
bus
!=
NULL
è&& (
ch_bus
!=NULL)){

243 
tw_»gi¡”_bË_t
 *
ty³_bus_roÙ_»gi¡”_bË
;

244 
ty³_bus_roÙ_»gi¡”_bË
 = &
bus
->type_bus_root_register_table;

245 if(
ty³_bus_roÙ_»gi¡”_bË
->
İ
 !ğ
NULL
){

246 
ty³_bus_roÙ_»gi¡”_bË
->
İ
->
	`»gi¡”_node_što_bË
Ñy³_bus_roÙ_»gi¡”_bË, &
ch_bus
->
ch_»gi¡”_node
);

249 
	}
}

251 
	$ty³_bus_uÄegi¡”_ch_bus_što_ty³_bus_bË
(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 *
ch_bus
)

253 if((
bus
!=
NULL
è&& (
ch_bus
!=NULL)){

254 
tw_»gi¡”_bË_t
 *
ty³_bus_roÙ_»gi¡”_bË
;

255 
ty³_bus_roÙ_»gi¡”_bË
 = &
bus
->type_bus_root_register_table;

256 if(
ty³_bus_roÙ_»gi¡”_bË
->
İ
 !ğ
NULL
){

257 
ty³_bus_roÙ_»gi¡”_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
Ñy³_bus_roÙ_»gi¡”_bË, &
ch_bus
->
ch_»gi¡”_node
);

259 if(
	`©omic_»ad
(&
ty³_bus_roÙ_»gi¡”_bË
->
cu¼_»gi¡”_’Œy_numb”
) <= 0){

260 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

261 
»gi¡”_node
 = &
bus
->register_node;

262 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

263 
»gi¡”_node
->
İ
->
	`com¶‘e_dÚe
(register_node);

267 
	}
}

269 
	$ty³_bus_fšd_ch_bus_š_ty³_bus_bË
(
ty³_bus_t
 *
bus
, 
tw_ch_bus_t
 **
ch_bus
, 
ch_id
)

271 if(
bus
 !ğ
NULL
){

272 
tw_»gi¡”_bË_t
 *
ty³_bus_roÙ_»gi¡”_bË
;

273 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

274 
ty³_bus_roÙ_»gi¡”_bË
 = &
bus
->type_bus_root_register_table;

275 
ty³_bus_roÙ_»gi¡”_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Ñy³_bus_roÙ_»gi¡”_bË, &
»gi¡”_node
, 
ch_id
);

276 if(
»gi¡”_node
 !ğ
NULL
){

277 *
ch_bus
 = 
	`to_g‘_ch_bus_w™h_ch_»gi¡”_node
(
»gi¡”_node
);

279 *
ch_bus
 = 
NULL
;

282 
	}
}

284 
ty³_bus_İ”©iÚ
 
	gty³_bus_İ
 = {

285 .
š™
 = 
ty³_bus_š™
,

287 .
	g»gi¡”_ch_bus_što_ty³_bus_bË
 = 
ty³_bus_»gi¡”_ch_bus_što_ty³_bus_bË
,

288 .
	guÄegi¡”_ch_bus_što_ty³_bus_bË
 = 
ty³_bus_uÄegi¡”_ch_bus_što_ty³_bus_bË
,

289 .
	gfšd_ch_bus_š_ty³_bus_bË
 = 
ty³_bus_fšd_ch_bus_š_ty³_bus_bË
,

292 
	$š™_ty³_bus
(
ty³_bus_t
 *
bus
, 
bus_id
)

294 if(
bus
 !ğ
NULL
){

295 
bus
->
İ
 = &
ty³_bus_İ
;

296 
bus
->
İ
->
	`š™
(bus, 
bus_id
);

298 
	}
}

300 
	$»move_ty³_bus
(
ty³_bus_t
 *
bus
)

302 if(
bus
 !ğ
NULL
){

303 
tw_roÙ_bus_t
 *
roÙBus
;

304 
	`g‘_roÙ_bus
(&
roÙBus
);

305 
roÙBus
->
roÙ_»gi¡”_bË
.
İ
->
	`uÄegi¡”_node_äom_bË
(&roÙBus->roÙ_»gi¡”_bË, &
bus
->
»gi¡”_node
);

307 
	}
}

309 
	$nÙify_»gi¡”_ch_bus
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
tw_nÙify_msg
 *
msg
)

311 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

314 
	}
}

316 
	$m©ch_»gs™”_ch_bus
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
id
)

318 
»t
 = 
TW_ERR
;

319 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

320 
tw_ch_bus_t
 *
bus
 = (tw_ch_bus_t*)
´iv
;

321 if(
bus
->
ch_id
 =ğ
id
){

322 
»t
 = 
TW_OK
;

325  
»t
;

326 
	}
}

328 
	$ch_bus_š™
(
tw_ch_bus_t
 *
ch_bus
, 
bus_id
, 
ch_id
)

330 if(
ch_bus
 !ğ
NULL
){

331 
ty³_bus_t
 *
ty³_bus
;

333 
ch_bus
->
bus_id
 = bus_id;

334 
ch_bus
->
ch_id
 = chip_id;

335 
	`š™_»gi¡”_node
(&
ch_bus
->
ch_»gi¡”_node
, ch_bus, 
nÙify_»gi¡”_ch_bus
, 
m©ch_»gs™”_ch_bus
);

336 if(
bus_id
 =ğ
TW_ED_HOST_BUS
){

337 
	`g‘_tw_ho¡_bus
(&
ty³_bus
);

338 if(
ty³_bus
->
İ
 !ğ
NULL
){

339 
ty³_bus
->
İ
->
	`»gi¡”_ch_bus_što_ty³_bus_bË
Ñy³_bus, 
ch_bus
);

341 } if(
bus_id
 =ğ
TW_ED_PCI_BUS
){

342 
	`g‘_tw_pci_bus
(&
ty³_bus
);

343 if(
ty³_bus
->
İ
 !ğ
NULL
){

344 
ty³_bus
->
İ
->
	`»gi¡”_ch_bus_što_ty³_bus_bË
Ñy³_bus, 
ch_bus
);

347 
	`´štk
("%s.%d:‚Øsu½pÜˆbus\n", 
__FUNCTION__
, 
__LINE__
);

350 
	}
}

352 
ch_bus_İ”©iÚ
 
	gch_bus_İ
 = {

353 .
š™
 = 
ch_bus_š™
,

356 
	$š™_ch_bus
(
tw_ch_bus_t
 *
ch_bus
, 
bus_id
, 
ch_id
)

358 if(
ch_bus
 !ğ
NULL
){

359 
ch_bus
->
İ
 = &
ch_bus_İ
;

360 
ch_bus
->
İ
->
	`š™
(ch_bus, 
bus_id
, 
ch_id
);

362 
	}
}

364 
	$»move_ch_bus
(
tw_ch_bus_t
 *
ch_bus
, 
bus_id
)

366 
ty³_bus_t
 *
ty³_bus
;

367 
tw_»gi¡”_bË_t
 *
ho¡_ch_bË
;

368 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

369 if(
ch_bus
 =ğ
NULL
){

372 
»gi¡”_node
 = &
ch_bus
->
ch_»gi¡”_node
;

373 if(
bus_id
 =ğ
TW_ED_HOST_BUS
){

374 
	`g‘_tw_ho¡_bus
(&
ty³_bus
);

375 
ho¡_ch_bË
 = &
ty³_bus
->
ty³_bus_roÙ_»gi¡”_bË
;

376 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

377 
»gi¡”_node
->
İ
->
	`com¶‘e_dÚe
(register_node);

379 if(
ho¡_ch_bË
->
İ
 !ğ
NULL
){

380 
ho¡_ch_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
(ho¡_ch_bË, 
»gi¡”_node
);

382 } if(
bus_id
 =ğ
TW_ED_PCI_BUS
){

383 
	`g‘_tw_pci_bus
(&
ty³_bus
);

384 
ho¡_ch_bË
 = &
ty³_bus
->
ty³_bus_roÙ_»gi¡”_bË
;

385 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

386 
»gi¡”_node
->
İ
->
	`com¶‘e_dÚe
(register_node);

388 if(
ho¡_ch_bË
->
İ
 !ğ
NULL
){

389 
ho¡_ch_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
(ho¡_ch_bË, 
»gi¡”_node
);

392 
	`´štk
("%s.%d:ƒ¼ bus_id %d\n", 
__FUNCTION__
, 
__LINE__
, 
bus_id
);

394 
	}
}

396 
	$tw_ed_fsm_š™
(
tw_ed_fsm_t
 *
ed_fsm
)

398 if(
ed_fsm
 !ğ
NULL
){

399 
ed_fsm
->
Ï¡_¡©e
 =ƒd_fsm->
cu¼_¡©e
 = 
TW_ED_UNREGISTER
;

400 
ed_fsm
->
cÚ‹xt
 = 
NULL
;

401 
	`¥š_lock_š™
(&
ed_fsm
->
lock
);

402 
ed_fsm
->
Œªsãr_³ndšg
.
şo£_³ndšg_æag
 = 0;

403 
ed_fsm
->
Œªsãr_³ndšg
.
timeout_³ndšg_æag
 = 0;

404 
ed_fsm
->
Œªsãr_³ndšg
.
su¥’d_³ndšg_æag
 = 0;

405 
ed_fsm
->
Œªsãr_³ndšg
.
»sume_³ndšg_æag
 = 0;

406 
ed_fsm
->
Œªsãr_³ndšg
.
İ’_³ndšg_æag
 = 0;

407 
ed_fsm
->
Œªsãr_³ndšg
.
d–iv”_³ndšg_æag
 = 0;

408 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_¡©e_Œªsãr_æag
 = 0;

409 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
 = 0;

410 
ed_fsm
->
Œªsãr_³ndšg
.
Ãed_sync
 = 0;

411 
ed_fsm
->
Œªsãr_³ndšg
.
»£rve
 = 0;

412 
ed_fsm
->
bË
 = 
NULL
;

414 
	}
}

416 
	$tw_ed_fsm_»£t
(
tw_ed_fsm_t
 *
ed_fsm
)

418 if(
ed_fsm
 !ğ
NULL
){

419 
æags
;

420 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

421 
ed_fsm
->
Œªsãr_³ndšg
.
şo£_³ndšg_æag
 = 0;

422 
ed_fsm
->
Œªsãr_³ndšg
.
timeout_³ndšg_æag
 = 0;

423 
ed_fsm
->
Œªsãr_³ndšg
.
su¥’d_³ndšg_æag
 = 0;

424 
ed_fsm
->
Œªsãr_³ndšg
.
»sume_³ndšg_æag
 = 0;

425 
ed_fsm
->
Œªsãr_³ndšg
.
İ’_³ndšg_æag
 = 0;

426 
ed_fsm
->
Œªsãr_³ndšg
.
d–iv”_³ndšg_æag
 = 0;

427 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_¡©e_Œªsãr_æag
 = 0;

428 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
 = 0;

429 
ed_fsm
->
Œªsãr_³ndšg
.
Ãed_sync
 = 0;

430 
ed_fsm
->
Œªsãr_³ndšg
.
»£rve
 = 0;

431 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

433 
	}
}

435 
	$tw_ed_fsm_»gi¡”_bË
(
tw_ed_fsm_t
 *
ed_fsm
, 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *
fsm_bË
, *
cÚ‹xt
)

437 if(
ed_fsm
 !ğ
NULL
){

438 
æags
;

439 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

440 
ed_fsm
->
cÚ‹xt
 = context;

441 
ed_fsm
->
bË
 = 
fsm_bË
;

442 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

444 
	}
}

446 
	$tw_ed_fsm_uÄegi¡”_bË
(
tw_ed_fsm_t
 *
ed_fsm
)

448 if(
ed_fsm
 !ğ
NULL
){

449 
æags
;

450 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

451 
ed_fsm
->
cÚ‹xt
 = 
NULL
;

452 
ed_fsm
->
bË
 = 
NULL
;

453 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

455 
	}
}

457 
	$tw_ed_fsm_upd©e_Ãed_sync_hook
(
tw_ed_fsm_t
 *
ed_fsm
, 
’
)

459 if(
ed_fsm
 !ğ
NULL
){

460 
æags
;

461 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

462 
ed_fsm
->
Œªsãr_³ndšg
.
Ãed_sync
 = 
’
;

463 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

465 
	}
}

467 
	$tw_ed_fsm_upd©e_’abË_¡©e_Œªsãr
(
tw_ed_fsm_t
 *
ed_fsm
, 
’
)

469 if(
ed_fsm
 !ğ
NULL
){

470 
æags
;

471 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

472 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_¡©e_Œªsãr_æag
 = 
’
;

473 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

475 
	}
}

477 
	$tw_ed_fsm_upd©e_’abË_Œigg”_³ndšg_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, 
’
)

479 if(
ed_fsm
 !ğ
NULL
){

480 
æags
;

482 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

483 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
 = 
’
;

484 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

486 if(
ed_fsm
->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
){

487 if(
ed_fsm
->
Œªsãr_³ndšg
.
İ’_³ndšg_æag
){

488 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_OPEN_EVENT
);

489 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_OPEN_EVENT
);

490 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_OPEN_EVENT
);

492 if(
ed_fsm
->
Œªsãr_³ndšg
.
d–iv”_³ndšg_æag
){

493 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_DELIVER_EVENT
);

494 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_DELIVER_EVENT
);

495 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_DELIVER_EVENT
);

497 if(
ed_fsm
->
Œªsãr_³ndšg
.
su¥’d_³ndšg_æag
){

498 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_SUSPEND_EVENT
);

499 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_SUSPEND_EVENT
);

500 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_SUSPEND_EVENT
);

502 if(
ed_fsm
->
Œªsãr_³ndšg
.
»sume_³ndšg_æag
){

503 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_RESUME_EVENT
);

504 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_RESUME_EVENT
);

505 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_RESUME_EVENT
);

507 if(
ed_fsm
->
Œªsãr_³ndšg
.
timeout_³ndšg_æag
){

508 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_TIMEOUT_EVENT
);

509 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_TIMEOUT_EVENT
);

510 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_TIMEOUT_EVENT
);

512 if(
ed_fsm
->
Œªsãr_³ndšg
.
şo£_³ndšg_æag
){

513 
	`´štk
("\n%s.%d: %d-%d->%d\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_CLOSE_EVENT
);

514 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
TW_ED_CLOSE_EVENT
);

515 
	`´štk
("%s.%d: %d-%d->%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsm),ƒd_fsm->İ->
	`g‘_Ï¡_¡©e
Ód_fsm), 
TW_ED_CLOSE_EVENT
);

517 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

518 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
 = 0;

519 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

522 
	}
}

524 
	$tw_ed_fsm_chªge_¡©e
(
tw_ed_fsm_t
 *
ed_fsm
, 
TW_ED_STATUS
 
¡©e
)

526 if(
ed_fsm
 !ğ
NULL
){

527 
æags
;

528 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

529 
ed_fsm
->
Ï¡_¡©e
 =ƒd_fsm->
cu¼_¡©e
;

530 
ed_fsm
->
cu¼_¡©e
 = 
¡©e
;

531 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

533 
	}
}

535 
	$tw_ed_fsm_»q_fsm_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, 
TW_ED_EVENT
 
ev’t
)

537 if(
ed_fsm
 !ğ
NULL
){

538 
æags
;

539 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

540 
ev’t
){

541 
TW_ED_DELIVER_EVENT
:

542 
ed_fsm
->
Œªsãr_³ndšg
.
d–iv”_³ndšg_æag
 = 1;

544 
TW_ED_TIMEOUT_EVENT
:

545 
ed_fsm
->
Œªsãr_³ndšg
.
timeout_³ndšg_æag
 = 1;

547 
TW_ED_SUSPEND_EVENT
:

548 
ed_fsm
->
Œªsãr_³ndšg
.
su¥’d_³ndšg_æag
 = 1;

550 
TW_ED_RESUME_EVENT
:

551 
ed_fsm
->
Œªsãr_³ndšg
.
»sume_³ndšg_æag
 = 1;

553 
TW_ED_OPEN_EVENT
:

554 
ed_fsm
->
Œªsãr_³ndšg
.
İ’_³ndšg_æag
 = 1;

557 
TW_ED_CLOSE_EVENT
:

558 
ed_fsm
->
Œªsãr_³ndšg
.
şo£_³ndšg_æag
 = 1;

561 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

563 
	}
}

565 
	$tw_ed_fsm_ack_fsm_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, 
TW_ED_EVENT
 
ev’t
)

567 if(
ed_fsm
 !ğ
NULL
){

568 
æags
;

569 
	`¥š_lock_œq§ve
(&
ed_fsm
->
lock
, 
æags
);

570 
ed_fsm
->
Œªsãr_³ndšg
.
’abË_¡©e_Œªsãr_æag
 = 0;

571 
ev’t
){

572 
TW_ED_DELIVER_EVENT
:

573 
ed_fsm
->
Œªsãr_³ndšg
.
d–iv”_³ndšg_æag
 = 0;

575 
TW_ED_TIMEOUT_EVENT
:

576 
ed_fsm
->
Œªsãr_³ndšg
.
timeout_³ndšg_æag
 = 0;

578 
TW_ED_SUSPEND_EVENT
:

579 
ed_fsm
->
Œªsãr_³ndšg
.
su¥’d_³ndšg_æag
 = 0;

581 
TW_ED_RESUME_EVENT
:

582 
ed_fsm
->
Œªsãr_³ndšg
.
»sume_³ndšg_æag
 = 0;

584 
TW_ED_OPEN_EVENT
:

585 
ed_fsm
->
Œªsãr_³ndšg
.
İ’_³ndšg_æag
 = 0;

588 
TW_ED_CLOSE_EVENT
:

589 
ed_fsm
->
Œªsãr_³ndšg
.
şo£_³ndšg_æag
 = 0;

592 
	`¥š_uÆock_œq»¡Üe
(&
ed_fsm
->
lock
, 
æags
);

594 
	}
}

596 
	$tw_ed_fsm_g’_fsm_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, 
TW_ED_EVENT
 
ev’t
)

598 
»t
 = 
TW_ERR
;

599 if(
ed_fsm
 !ğ
NULL
){

600 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
ev’t
);

601 if(
ed_fsm
->
Œªsãr_³ndšg
.
’abË_¡©e_Œªsãr_æag
){

602 
»t
 = 
ed_fsm
->
İ
->
	`Œªsãr
Ód_fsm, 
ev’t
);

605  
»t
;

606 
	}
}

608 
	$tw_ed_fsm_Œªsãr
(
tw_ed_fsm_t
 *
ed_fsm
, 
TW_ED_EVENT
 
ev’t
)

610 
»t
 = 
TW_ERR
;

612 if(
ed_fsm
 !ğ
NULL
){

613 
fsm_Œªsãr_aùiÚ
 
aùiÚ
 = 
NULL
;

614 
fsm_Œªsãr_aùiÚ
 
sync_hook
 = 
NULL
;

615 
Ï¡_¡©e
, 
cu¼_¡©e
;

617 
ed_fsm
->
İ
->
	`ack_fsm_ev’t
Ód_fsm, 
ev’t
);

618 
cu¼_¡©e
 = 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm);

619 if(
ed_fsm
->
bË
 !ğ
NULL
){

620 
aùiÚ
 = 
ed_fsm
->
bË
->aùiÚ[
cu¼_¡©e
][
ev’t
];

621 
sync_hook
 = 
ed_fsm
->
bË
->sync_hook;

624 if(
aùiÚ
 !ğ
NULL
){

625 
»t
 = 
	`aùiÚ
(
ed_fsm
,ƒd_fsm->
cÚ‹xt
);

626 if(
ed_fsm
->
Œªsãr_³ndšg
.
Ãed_sync
){

627 
ed_fsm
->
İ
->
	`upd©e_Ãed_sync_hook
(ed_fsm, 0);

628 
cu¼_¡©e
 = 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm);

629 
Ï¡_¡©e
 = 
ed_fsm
->
İ
->
	`g‘_Ï¡_¡©e
(ed_fsm);

630 if((
sync_hook
!=
NULL
è&& (
cu¼_¡©e
==
TW_ED_IDLE
è&& ((
Ï¡_¡©e
==
TW_ED_SUSPEND
)||Öa¡_¡©e==
TW_ED_TRANSFERING
))){

631 
»t
 = 
	`sync_hook
(
ed_fsm
,ƒd_fsm->
cÚ‹xt
);

636  
»t
;

637 
	}
}

639 
	$tw_ed_fsm_g‘_cu¼_¡©e
(
tw_ed_fsm_t
 *
ed_fsm
)

641 if(
ed_fsm
 !ğ
NULL
){

642  
ed_fsm
->
cu¼_¡©e
;

644  
TW_ED_UNREGISTER
;

646 
	}
}

648 
	$tw_ed_fsm_g‘_Ï¡_¡©e
(
tw_ed_fsm_t
 *
ed_fsm
)

650 if(
ed_fsm
 !ğ
NULL
){

651  
ed_fsm
->
Ï¡_¡©e
;

653  
TW_ED_UNREGISTER
;

655 
	}
}

657 
tw_ed_fsm_İ”©iÚ
 
	gtw_ed_fsm_İ
 ={

658 .
š™
 = 
tw_ed_fsm_š™
,

659 .
	g»£t
 = 
tw_ed_fsm_»£t
,

660 .
	g»gi¡”_bË
 = 
tw_ed_fsm_»gi¡”_bË
,

661 .
	guÄegi¡”_bË
 = 
tw_ed_fsm_uÄegi¡”_bË
,

662 .
	gupd©e_Ãed_sync_hook
 = 
tw_ed_fsm_upd©e_Ãed_sync_hook
,

663 .
	gupd©e_’abË_¡©e_Œªsãr
 = 
tw_ed_fsm_upd©e_’abË_¡©e_Œªsãr
,

664 .
	gupd©e_’abË_Œigg”_³ndšg_ev’t
 = 
tw_ed_fsm_upd©e_’abË_Œigg”_³ndšg_ev’t
,

665 .
	gchªge_¡©e
 = 
tw_ed_fsm_chªge_¡©e
,

666 .
	g»q_fsm_ev’t
 = 
tw_ed_fsm_»q_fsm_ev’t
,

667 .
	gack_fsm_ev’t
 = 
tw_ed_fsm_ack_fsm_ev’t
,

668 .
	gg’_fsm_ev’t
 = 
tw_ed_fsm_g’_fsm_ev’t
,

669 .
	gŒªsãr
 = 
tw_ed_fsm_Œªsãr
,

670 .
	gg‘_cu¼_¡©e
 = 
tw_ed_fsm_g‘_cu¼_¡©e
,

671 .
	gg‘_Ï¡_¡©e
 = 
tw_ed_fsm_g‘_Ï¡_¡©e
,

674 
	$š™_ed_fsm
(
tw_ed_fsm_t
 *
ed_fsm
, 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *
fsm_bË
, *
cÚ‹xt
)

676 if(
ed_fsm
 !ğ
NULL
){

677 
ed_fsm
->
İ
 = &
tw_ed_fsm_İ
;

678 
ed_fsm
->
İ
->
	`š™
(ed_fsm);

679 
ed_fsm
->
İ
->
	`»gi¡”_bË
Ód_fsm, 
fsm_bË
, 
cÚ‹xt
);

681 
	}
}

683 
	$driv”_Œigg”_³ndšg_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
’
)

685 if(
ed_tcb
 !ğ
NULL
){

686 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

687 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm, 
’
);

689 
	}
}

691 
	$driv”_g’_şo£_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

693 if(
ed_tcb
 !ğ
NULL
){

694 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

695 
æags
;

696 
	`loÿl_œq_§ve
(
æags
);

697 if(
ÿn_Œªsãr
){

698 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

699 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_CLOSE_EVENT
);

701 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_CLOSE_EVENT
);

702 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

704 
	`loÿl_œq_»¡Üe
(
æags
);

706 
	}
}

708 
	$driv”_g’_timeout_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

710 if(
ed_tcb
 !ğ
NULL
){

711 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

712 
æags
;

713 
	`loÿl_œq_§ve
(
æags
);

714 if(
ÿn_Œªsãr
){

715 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

716 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_TIMEOUT_EVENT
);

718 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_TIMEOUT_EVENT
);

719 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

721 
	`loÿl_œq_»¡Üe
(
æags
);

723 
	}
}

725 
	$driv”_g’_su¥’d_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

727 if(
ed_tcb
 !ğ
NULL
){

728 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

729 
æags
;

730 
	`loÿl_œq_§ve
(
æags
);

731 if(
ÿn_Œªsãr
){

732 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

733 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_SUSPEND_EVENT
);

735 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_SUSPEND_EVENT
);

736 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

738 
	`loÿl_œq_»¡Üe
(
æags
);

740 
	}
}

742 
	$driv”_g’_»sume_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

744 if(
ed_tcb
 !ğ
NULL
){

745 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

746 
æags
;

747 
	`loÿl_œq_§ve
(
æags
);

748 if(
ÿn_Œªsãr
){

749 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

750 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_RESUME_EVENT
);

752 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_RESUME_EVENT
);

753 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

755 
	`loÿl_œq_»¡Üe
(
æags
);

757 
	}
}

759 
	$driv”_g’_İ’_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

761 if(
ed_tcb
 !ğ
NULL
){

762 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

763 
æags
;

764 
	`loÿl_œq_§ve
(
æags
);

765 if(
ÿn_Œªsãr
){

766 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

767 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_OPEN_EVENT
);

769 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_OPEN_EVENT
);

770 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

772 
	`loÿl_œq_»¡Üe
(
æags
);

774 
	}
}

776 
	$driv”_g’_d–iv”_ev’t
(
ed_tcb_t
 *
ed_tcb
, 
ÿn_Œªsãr
)

778 if(
ed_tcb
 !ğ
NULL
){

779 
tw_ed_fsm_t
 *
ed_fsm
 = &
ed_tcb
->ed_fsm;

780 
æags
;

781 
	`loÿl_œq_§ve
(
æags
);

782 if(
ÿn_Œªsãr
){

783 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

784 
ed_fsm
->
İ
->
	`g’_fsm_ev’t
Ód_fsm, 
TW_ED_DELIVER_EVENT
);

786 
ed_fsm
->
İ
->
	`»q_fsm_ev’t
Ód_fsm, 
TW_ED_DELIVER_EVENT
);

787 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
Ód_fsm,ƒd_fsm->
Œªsãr_³ndšg
.
’abË_Œigg”_³ndšg_æag
);

789 
	`loÿl_œq_»¡Üe
(
æags
);

791 
	}
}

793 
	$š™_cÚŒŞ_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

795 if(
id
 !ğ
NULL
){

796 
id
->
bus_id
 = (bus_id)&0xf;

797 
id
->
ch_id
 = (chip_id)&0xf;

798 
id
->
ty³_id
 = 
TW_ED_CONTROL
;

799 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

800 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

802 
	}
}

804 
	$š™_video_’code_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

806 if(
id
 !ğ
NULL
){

807 
id
->
bus_id
 = (bus_id)&0xf;

808 
id
->
ch_id
 = (chip_id)&0xf;

809 
id
->
ty³_id
 = 
TW_ED_VIDEO_ENCODE_IN
;

810 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

811 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

813 
	}
}

815 
	$š™_video_’code_´ev›w_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

817 if(
id
 !ğ
NULL
){

818 
id
->
bus_id
 = (bus_id)&0xf;

819 
id
->
ch_id
 = (chip_id)&0xf;

820 
id
->
ty³_id
 = 
TW_ED_VIDEO_PREVIEW_IN
;

821 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

822 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

824 
	}
}

826 
	$š™_video_’code_osd_out_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

828 if(
id
 !ğ
NULL
){

829 
id
->
bus_id
 = (bus_id)&0xf;

830 
id
->
ch_id
 = (chip_id)&0xf;

831 
id
->
ty³_id
 = 
TW_ED_VIDEO_ENCODE_OSD_OUT
;

832 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

833 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

835 
	}
}

837 
	$š™_video_decode_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

839 if(
id
 !ğ
NULL
){

840 
id
->
bus_id
 = (bus_id)&0xf;

841 
id
->
ch_id
 = (chip_id)&0xf;

842 
id
->
ty³_id
 = 
TW_ED_VIDEO_DECODE_OUT
;

843 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

844 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

846 
	}
}

848 
	$š™_video_decode_´ev›w_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

850 if(
id
 !ğ
NULL
){

851 
id
->
bus_id
 = (bus_id)&0xf;

852 
id
->
ch_id
 = (chip_id)&0xf;

853 
id
->
ty³_id
 = 
TW_ED_VIDEO_PREVIEW_OUT
;

854 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

855 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

857 
	}
}

859 
	$š™_video_decode_osg_out_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
)

861 if(
id
 !ğ
NULL
){

862 
id
->
bus_id
 = (bus_id)&0xf;

863 
id
->
ch_id
 = (chip_id)&0xf;

864 
id
->
ty³_id
 = 
TW_ED_VIDEO_DECODE_OSG_OUT
;

865 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

866 
id
->
logic_chª_id
 = (logic_chan_id)&0x3ff;

868 
	}
}

870 
	$š™_audio_’code_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
)

872 if(
id
 !ğ
NULL
){

873 
id
->
bus_id
 = (bus_id)&0xf;

874 
id
->
ch_id
 = (chip_id)&0xf;

875 
id
->
ty³_id
 = 
TW_ED_AUDIO_ENCODE_IN
;

876 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

877 
id
->
logic_chª_id
 = 0;

879 
	}
}

881 
	$š™_audio_decode_ed
(
ed_id
 *
id
, 
bus_id
, 
ch_id
, 
group_chª_id
)

883 if(
id
 !ğ
NULL
){

884 
id
->
bus_id
 = (bus_id)&0xf;

885 
id
->
ch_id
 = (chip_id)&0xf;

886 
id
->
ty³_id
 = 
TW_ED_AUDIO_DECODE_OUT
;

887 
id
->
group_chª_id
 = (group_chan_id)&0x3ff;

888 
id
->
logic_chª_id
 = 0;

890 
	}
}

892 
	$š™_šv®id_ed
(
ed_id
 *
id
)

894 if(
id
 !ğ
NULL
){

895 
id
->
bus_id
 = 
INVALID_TW_ED_BSU_ID
;

896 
id
->
ch_id
 = 0;

897 
id
->
ty³_id
 = 
INVALID_TW_ED_TYPE_ID
;

898 
id
->
group_chª_id
 = 0;

899 
id
->
logic_chª_id
 = 0;

901 
	}
}

903 
	$ed_tcb_š™
(
ed_tcb_t
 *
ed_tcb
, 
bus_id
, 
ch_id
, 
ty³_id
, 
group_chª_id
, 
logic_chª_id
)

905 if(
ed_tcb
 !ğ
NULL
){

906 
ty³_id
){

907 
TW_ED_CONTROL
:

908 
	`š™_cÚŒŞ_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

910 
TW_ED_VIDEO_ENCODE_IN
:

911 
	`š™_video_’code_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

913 
TW_ED_VIDEO_PREVIEW_IN
:

914 
	`š™_video_’code_´ev›w_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

916 
TW_ED_VIDEO_ENCODE_OSD_OUT
:

917 
	`š™_video_’code_osd_out_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

919 
TW_ED_VIDEO_DECODE_OUT
:

920 
	`š™_video_decode_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

922 
TW_ED_VIDEO_PREVIEW_OUT
:

923 
	`š™_video_decode_´ev›w_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

925 
TW_ED_VIDEO_DECODE_OSG_OUT
:

926 
	`š™_video_decode_osg_out_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
, 
logic_chª_id
);

928 
TW_ED_AUDIO_ENCODE_IN
:

929 
	`š™_audio_’code_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
);

931 
TW_ED_AUDIO_DECODE_OUT
:

932 
	`š™_audio_decode_ed
(&
ed_tcb
->
id
, 
bus_id
, 
ch_id
, 
group_chª_id
);

935 
INVALID_TW_ED_TYPE_ID
:

936 
	`š™_šv®id_ed
(&
ed_tcb
->
id
);

939 
	`©omic_£t
(&
ed_tcb
->
¡©e
, 
TW_ED_UNREGISTER
);

941 
	}
}

943 
	$š™_’dpošt_tcb
(
ed_tcb_t
 *
ed_tcb
, 
bus_id
, 
ch_id
, 
ty³_id
, 
group_chª_id
, 
logic_chª_id
, *
´iv
, 
nÙify_»gi¡”_node_´iv
 
nÙify_´iv
, 
m©ch_»gs™”_node_´iv_id
 
m©ch_id
, 
fsm_¡©e_Œªsãr_m©rix_bË_t
 *
fsm_bË
)

945 if(
ed_tcb
 !ğ
NULL
){

946 
	`ed_tcb_š™
(
ed_tcb
, 
bus_id
, 
ch_id
, 
ty³_id
, 
group_chª_id
, 
logic_chª_id
);

947 
	`š™_»gi¡”_node
(&
ed_tcb
->
ed
, 
´iv
, 
nÙify_´iv
, 
m©ch_id
);

948 
	`š™_ed_fsm
(&
ed_tcb
->
ed_fsm
, 
fsm_bË
, 
´iv
);

950 
	}
}

	@../../tw5864/tw5864/config.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#MPB_CMD_REG
 (0xb800)

	)

4 
	#MPB_DATA_REG
 (0xb804)

	)

5 
	#MPB_READ_MODE
 0

	)

6 
	#MPB_WRITE_MODE
 1

	)

9 
	#PLATFORM_FPGA_330


	)

13 
	#PCI_I2C_TIMEOUT
 (30000)

	)

15 
	gtbl_·l_tw2864_commÚ
[] = {

22 
	gtbl_Ásc_tw2864_commÚ
[] = {

29 
	gtbl_·l_tw2864_commÚ2
[] = {

35 
	gtbl_tw2864_Ùh”
[] = {

46 #ifdeà
PLATFORM_FPGA_155


49 #ifdeà
PLATFORM_FPGA_330


55 
	gtbl_·l_tw2865_commÚ
[] = {

62 
	gtbl_Ásc_tw2865_commÚ
[] = {

69 
	gtbl_tw2865_Ùh”1
[] = {

71 #ifdeà
PLATFORM_FPGA_155


74 #ifdeà
PLATFORM_FPGA_330


82 #ifdeà
PLATFORM_FPGA_155


85 #ifdeà
PLATFORM_FPGA_330


91 
	gtbl_tw2866_Ùh”1
[] = {

93 #ifdeà
PLATFORM_FPGA_155


96 #ifdeà
PLATFORM_FPGA_330


104 #ifdeà
PLATFORM_FPGA_155


107 #ifdeà
PLATFORM_FPGA_330


114 
	gtbl_tw2865_Ùh”2
[] = {

120 
	gtbl_tw2865_Ùh”3
[] = {

124 
	gaudio_tw2865_commÚ
[] = {

132 
	gaudio_tbl_·l_tw2865_8KHz
[] = {

136 
	gaudio_tbl_·l_tw2865_16KHz
[] = {

139 
	gaudio_tbl_Ásc_tw2865_8KHz
[] = {

143 
	gaudio_tbl_Ásc_tw2865_16KHz
[] = {

147 
pci_i2c_»ad
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 *
buf
);

148 
	$pci_i2c_muÉi_»ad
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 *
buf
, 
u32
 
couÁ
)

150 
i
 = 0;

151 
u32
 
v®
 = 0;

152 
timeout
 = 
PCI_I2C_TIMEOUT
;

154 
i
 = 0; i < 
couÁ
; i++)

156 
v®
 = (1 << 24è+ ((
devid
 | 0x01è<< 16è+ ((
devâ
 + 
i
) << 8) + 0;

157 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_I2C
, 
v®
);

160 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
) & (0x01000000);

161 }(!
v®
è&& (--
timeout
));

162 if(!
timeout
){

163 
	`TW_DBG
(
TW_DBG_ERR
, "dev 0x%x, fÀ0x%x\n", 
devid
, 
devâ
);

164  -
ETIMEDOUT
;

166 
buf
[
i
] = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
);

169  
TW_OK
;

170 
	}
}

171 
	$pci_i2c_muÉi_wr™e
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 *
buf
, 
u32
 
couÁ
)

173 
i
 = 0;

174 
u32
 
v®
 = 0;

175 
timeout
 = 
PCI_I2C_TIMEOUT
;

177 
i
 = 0; i < 
couÁ
; i++)

179 
v®
 = (1 << 24è+ ((
devid
 & 0xãè<< 16è+ ((
devâ
 + 
i
è<< 8è+ 
buf
[i];

180 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_I2C
, 
v®
);

182 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
) & (0x01000000);

183 }(!
v®
è&& (--
timeout
));

184 if(!
timeout
){

185 
	`TW_DBG
(
TW_DBG_ERR
, "dev 0x%x, fÀ0x%x, 0x%x\n", 
devid
, 
devâ
, 
buf
[
i
]);

186  -
ETIMEDOUT
;

190  
TW_OK
;

191 
	}
}

192 
	$pci_i2c_»ad
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 *
buf
)

194 
u32
 
v®
 = 0;

195 
timeout
 = 
PCI_I2C_TIMEOUT
;

197 
v®
 = (1 << 24è+ ((
devid
 | 0x01è<< 16è+ (
devâ
 << 8) + 0;

199 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_I2C
, 
v®
);

201 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
) & (0x01000000);

202 }(!
v®
è&& (--
timeout
));

203 if(!
timeout
){

204 
	`TW_DBG
(
TW_DBG_ERR
, "dev 0x%x, fÀ0x%x\n", 
devid
, 
devâ
);

205  -
ETIMEDOUT
;

208 *
buf
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
);

210  
TW_OK
;

211 
	}
}

212 
	$pci_i2c_wr™e
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 
devâ
, u8 
buf
)

214 
u32
 
v®
 = 0;

215 
timeout
 = 
PCI_I2C_TIMEOUT
;

217 
v®
 = (1 << 24è+ ((
devid
 & 0xãè<< 16è+ (
devâ
 << 8è+ 
buf
;

218 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_I2C
, 
v®
);

220 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
) & (0x01000000);

221 }(!
v®
è&& (--
timeout
));

222 if(!
timeout
){

223 
	`TW_DBG
(
TW_DBG_ERR
, "dev 0x%x, fÀ0x%x, 0x%x\n", 
devid
, 
devâ
, 
buf
);

224  -
ETIMEDOUT
;

227  
TW_OK
;

228 
	}
}

229 
	$pci_i2c_wsÿ‰”
(
dvm_ch_t
 *
ch
, 
u8
 
devid
, u8 *
buf
, 
u32
 
couÁ
)

231 
i
 = 0;

232 
u32
 
v®
 = 0;

233 
timeout
 = 
PCI_I2C_TIMEOUT
;

235 
i
 = 0; i < 
couÁ
; i++)

237 
v®
 = (1 << 24è+ ((
devid
 & 0xãè<< 16è+ (
buf
[
i
 * 2+ 0] << 8) + buf[i * 2 +1];

238 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_I2C
, 
v®
);

240 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_I2C
) & (0x01000000);

241 }(!
v®
è&& (--
timeout
));

242 if(!
timeout
){

243 
	`TW_DBG
(
TW_DBG_ERR
, "dev 0x%x, fÀ0x%x, 0x%x\n", 
devid
, 
buf
[
i
 * 2], buf[i * 2 + 1]);

244  -
ETIMEDOUT
;

248  
TW_OK
;

249 
	}
}

251 
	$pci_š™_tw2864
(
dvm_ch_t
 *
ch
)

253 
u32
 
v®
;

254 
u32
 
ch
;

256 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MCU_IIC_CONF
);

257 
v®
 |= 0x01;

258 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MCU_IIC_CONF
, 
v®
);

259 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
I2C_PHASE_SHIFT
, 0x01);

260 
ch
 = 0 ; ch < 4 ; ch++)

262 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x56 , 
ch
 * 0x10 , 
tbl_·l_tw2864_commÚ
 , 16);

264 #ifdeà
PLATFORM_FPGA_155


265 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x56 , 
tbl_tw2864_Ùh”
 ,22);

267 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x56 , 
tbl_tw2864_Ùh”
 ,23);

269 
	`pci_i2c_wr™e
(
ch
, 0x56, 0xcf, 0x83);

270 
	`pci_i2c_wr™e
(
ch
, 0x56, 0xe0, 0x00);

272 
ch
 = 0 ; ch < 4 ; ch++)

274 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x54 , 
ch
 * 0x10 , 
tbl_·l_tw2864_commÚ
 , 16);

276 #ifdeà
PLATFORM_FPGA_155


277 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x54 , 
tbl_tw2864_Ùh”
 ,22);

279 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x54 , 
tbl_tw2864_Ùh”
 ,23);

281 
	`pci_i2c_wr™e
(
ch
, 0x54, 0xcf, 0x83);

282 
	`pci_i2c_wr™e
(
ch
, 0x54, 0xe0, 0x04);

284 
ch
 = 0 ; ch < 4 ; ch++)

286 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x52 , 
ch
 * 0x10 , 
tbl_·l_tw2864_commÚ
 , 16);

288 #ifdeà
PLATFORM_FPGA_155


289 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x52 , 
tbl_tw2864_Ùh”
 ,22);

291 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x52 , 
tbl_tw2864_Ùh”
 ,23);

293 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xcf, 0x83);

294 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xe0, 0x08);

296 
ch
 = 0 ; ch < 4 ; ch++)

298 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x52 , 
ch
 * 0x10 , 
tbl_·l_tw2864_commÚ
 , 16);

300 #ifdeà
PLATFORM_FPGA_155


301 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x52 , 
tbl_tw2864_Ùh”
 ,22);

303 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x52 , 
tbl_tw2864_Ùh”
 ,23);

305 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xcf, 0x83);

306 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xe0, 0x08);

307 
	}
}

309 
	$pci_š™_tw2865
(
dvm_ch_t
 *
ch
)

311 
u32
 
v®
;

312 
u32
 
ch
;

314 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MCU_IIC_CONF
);

315 
v®
 |= 0x01;

316 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MCU_IIC_CONF
, 
v®
);

317 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
I2C_PHASE_SHIFT
, 0x01);

319 
ch
 = 0 ; ch < 4 ; ch++)

321 
	`pci_i2c_muÉi_wr™e
(
ch
, 0x50, 
ch
 * 0x10, 
tbl_·l_tw2865_commÚ
, 16);

323 #ifdeà
PLATFORM_FPGA_155


324 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x50 , 
tbl_tw2865_Ùh”1
 , 16);

326 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x50 , 
tbl_tw2865_Ùh”1
 , 18);

328 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x50 , 0xd0 , 
audio_tw2865_commÚ
 , 20);

329 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x50 , 
tbl_tw2865_Ùh”2
 , 6);

330 
	`pci_i2c_muÉi_wr™e
(
ch
 , 0x50 , 0xf0 , 
audio_tbl_·l_tw2865_8KHz
 , 6);

331 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x50 , 
tbl_tw2865_Ùh”3
 , 3);

332 
	`pci_i2c_wr™e
(
ch
, 0x50, 0xe0, 0x10);

333 
	}
}

335 
	$pci_š™_tw2866
(
dvm_ch_t
 *
ch
, 
u8
 
iic
)

337 
u32
 
ch
;

339 
ch
 = 0 ; ch < 4 ; ch++)

341 
	`pci_i2c_muÉi_wr™e
(
ch
, 
iic
, 
ch
 * 0x10, 
tbl_·l_tw2865_commÚ
, 16);

343 #ifdeà
PLATFORM_FPGA_155


344 
	`pci_i2c_wsÿ‰”
(
ch
 , 
iic
, 
tbl_tw2866_Ùh”1
 , 17);

346 
	`pci_i2c_wsÿ‰”
(
ch
 , 
iic
 , 
tbl_tw2866_Ùh”1
 , (tbl_tw2866_other1)>>1);

348 
	`pci_i2c_muÉi_wr™e
(
ch
 , 
iic
 , 0xd0 , 
audio_tw2865_commÚ
 , 20);

349 
	`pci_i2c_wsÿ‰”
(
ch
 , 0x5 , 
tbl_tw2865_Ùh”2
 , 6);

350 
	`pci_i2c_muÉi_wr™e
(
ch
 , 
iic
 , 0xf0 , 
audio_tbl_·l_tw2865_8KHz
 , 6);

351 
	`pci_i2c_wsÿ‰”
(
ch
 , 
iic
 , 
tbl_tw2865_Ùh”3
 , 3);

352 
	`pci_i2c_wr™e
(
ch
, 
iic
, 0xe0, 0x10);

353 #ifdeà
TW5864_ASIC_NEW


354 
	`pci_i2c_wr™e
(
ch
, 
iic
, 0x60, 0x15);

355 
	`pci_i2c_wr™e
(
ch
, 
iic
, 0x61, 0x3);

357 
	}
}

360 
	$pci_š™_ad
(
dvm_ch_t
 *
ch
)

362 #ifdeà
FPGA_330_5864_TESTING


363 
	`pci_š™_tw2864
(
ch
);

364 
	`pci_š™_tw2865
(
ch
);

366 
	`pci_š™_tw2866
(
ch
, 0x52);

367 
	`pci_š™_tw2866
(
ch
, 0x54);

368 
	`pci_š™_tw2866
(
ch
, 0x56);

371 #iâdeà
PLATFORM_FPGA_155


373 if(
ch
->
ch_id
 == 0) {

374 
	`pci_i2c_wr™e
(
ch
, 0x50, 0x9f, 0x07);

375 
	`pci_i2c_wr™e
(
ch
, 0x52, 0x9f, 0x07);

376 
	`pci_i2c_wr™e
(
ch
, 0x54, 0x9f, 0x07);

377 
	`pci_i2c_wr™e
(
ch
, 0x56, 0x9f, 0x07);

381 
	}
}

385 
	$mpb_İ”©iÚ
(
dvm_ch_t
 *
ch
, 
u32
 
addr
,u32 *
d©a
,u32 
mode
)

387 
u32
 
»g_v®ue
;

388 
u32
 
timeout
 = 1000;

390 
mode
)

392 
MPB_READ_MODE
:

393 (
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MPB_CMD_REG
)>>31è&& (
timeout
--));

394 if(!
timeout
) {

395 
	`TW_DBG
(
TW_DBG_ERR
, "»ad‡dd¸0x%03ximeout\n", 
addr
);

397 
»g_v®ue
 = ((1<<25)|(
mode
<<24)|(
addr
 << 2));

399 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MPB_CMD_REG
, 
»g_v®ue
);

400 
timeout
 = 1000;

401 ((
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MPB_CMD_REG
))>>31è&& (
timeout
--));

402 if(!
timeout
) {

403 
	`TW_DBG
(
TW_DBG_ERR
, "»ad‡dd¸0x%03ximeout\n", 
addr
);

405 *
d©a
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MPB_DATA_REG
);

407 
MPB_WRITE_MODE
:

408 (
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MPB_CMD_REG
)>>31è&& (
timeout
--));

409 if(!
timeout
) {

410 
	`TW_DBG
(
TW_DBG_ERR
, "wr™add¸0x%03ximeout\n", 
addr
);

412 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MPB_DATA_REG
, *
d©a
);

413 
»g_v®ue
 = ((1<<25)|(
mode
<<24)|(
addr
 << 2));

415 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MPB_CMD_REG
, 
»g_v®ue
);

418 
	}
}

420 
	$mpb_wr™e
(
dvm_ch_t
 *
ch
, 
u32
 
addr
,u32 
d©a
)

422 #ifdeà
PLATFORM_FPGA_155


426 
	`mpb_İ”©iÚ
(
ch
, 
addr
,&
d©a
,
MPB_WRITE_MODE
);

427 
	}
}

429 
u32
 
	$mpb_»ad
(
dvm_ch_t
 *
ch
, 
u32
 
addr
)

431 
u32
 
d©a
;

433 
	`mpb_İ”©iÚ
(
ch
, 
addr
,&
d©a
,
MPB_READ_MODE
);

434  
d©a
;

435 
	}
}

	@../../tw5864/tw5864/ddr_burst_interface.c

1 
	~<tw5864/dvm_commÚ.h
>

3 #undeà
DDR_BURST_INTERFACE_DEBUG


5 
	$ddr_bur¡_š‹rçû_»g_š™
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

7 if(
bur¡_š‹rçû
 !ğ
NULL
){

8 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
v®ue
 = 0;

9 
bur¡_š‹rçû
->
acûss_·ge_mode_»g_off£t
 = 
MPI_ACCESS_PAGE_MODE_REG_OFFSET
;

10 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
v®ue
 = 0;

11 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
 = 
MPI_CMD_STATUS_REG_OFFSET
;

12 
bur¡_š‹rçû
->
ddr_ba£_addr_»g_v®ue
.
v®ue
 = 0;

13 
bur¡_š‹rçû
->
bur¡_ddr_addr_»g_off£t
 = 
MPI_BURST_DDR_ADDR_REG_OFFSET
;

14 
bur¡_š‹rçû
->
¤am_ba£_addr_»g_v®ue
.
v®ue
 = 0;

15 
bur¡_š‹rçû
->
bur¡_¤am_addr_»g_off£t
 = 
MPI_BURST_SRAM_ADDR_REG_OFFSET
;

17 
	}
}

19 
	$ddr_bur¡_š‹rçû_»g_»£t
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

21 if(
bur¡_š‹rçû
 !ğ
NULL
){

22 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
v®ue
 = 0;

23 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
v®ue
 = 0;

24 
bur¡_š‹rçû
->
ddr_ba£_addr_»g_v®ue
.
v®ue
 = 0;

25 
bur¡_š‹rçû
->
¤am_ba£_addr_»g_v®ue
.
v®ue
 = 0;

27 
	}
}

29 
	$ddr_bur¡_š‹rçû_»g_g‘_·ge_mode_»g
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
)

31 if((
bur¡_š‹rçû
!=
NULL
è&& (
ch
!=NULL)){

32 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, bur¡_š‹rçû->
acûss_·ge_mode_»g_off£t
);

34 
	}
}

36 
	$ddr_bur¡_š‹rçû_»g_upd©e_·ge_mode_»g
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
)

38 if((
bur¡_š‹rçû
!=
NULL
è&& (
ch
!=NULL)){

39 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
acûss_·ge_mode_»g_off£t
, bur¡_š‹rçû->
·ge_mode_»g_v®ue
.
v®ue
);

40 #ifdeà 
DDR_BURST_INTERFACE_DEBUG


41 
	`´štk
("%s.%d:%x=0x%08x\n", 
__FUNCTION__
, 
__LINE__
, 
bur¡_š‹rçû
->
acûss_·ge_mode_»g_off£t
, 
ch
->
io_İ
->
	`ch_»ad32
(ch, bur¡_š‹rçû->
·ge_mode_»g_v®ue
.
v®ue
));

44 
	}
}

46 
	$ddr_bur¡_š‹rçû_»g_g‘_bur¡_š‹rçû_·¿m
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
)

48 if((
bur¡_š‹rçû
!=
NULL
è&& (
ch
!=NULL)){

49 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, bur¡_š‹rçû->
bur¡_cmd_¡©us_»g_off£t
);

50 
bur¡_š‹rçû
->
ddr_ba£_addr_»g_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, bur¡_š‹rçû->
bur¡_ddr_addr_»g_off£t
);

51 
bur¡_š‹rçû
->
¤am_ba£_addr_»g_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, bur¡_š‹rçû->
bur¡_¤am_addr_»g_off£t
);

53 
	}
}

55 
	$ddr_bur¡_š‹rçû_»g_upd©e_bur¡_š‹rçû_·¿m
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
)

57 if((
bur¡_š‹rçû
!=
NULL
è&& (
ch
!=NULL)){

58 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
bur¡_ddr_addr_»g_off£t
, bur¡_š‹rçû->
ddr_ba£_addr_»g_v®ue
.
v®ue
);

59 #ifdeà 
DDR_BURST_INTERFACE_DEBUG


60 
	`´štk
("%s.%d:%x=0x%08x\n", 
__FUNCTION__
, 
__LINE__
, 
bur¡_š‹rçû
->
bur¡_ddr_addr_»g_off£t
, 
ch
->
io_İ
->
	`ch_»ad32
(chip, burst_interface->burst_ddr_addr_reg_offset));

62 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
bur¡_¤am_addr_»g_off£t
, bur¡_š‹rçû->
¤am_ba£_addr_»g_v®ue
.
v®ue
);

63 #ifdeà 
DDR_BURST_INTERFACE_DEBUG


64 
	`´štk
("%s.%d:%x=0x%08x\n", 
__FUNCTION__
, 
__LINE__
, 
bur¡_š‹rçû
->
bur¡_¤am_addr_»g_off£t
, 
ch
->
io_İ
->
	`ch_»ad32
(chip, burst_interface->burst_sram_addr_reg_offset));

66 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
, bur¡_š‹rçû->
cmd_¡©us_»g_v®ue
.
v®ue
);

67 #ifdeà 
DDR_BURST_INTERFACE_DEBUG


68 
	`´štk
("%s.%d:%x=0x%08x\n", 
__FUNCTION__
, 
__LINE__
, 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
, 
ch
->
io_İ
->
	`ch_»ad32
(chip, burst_interface->burst_cmd_status_reg_offset));

70 
bur¡_š‹rçû
->
İ
->
	`¡¬t_ddr_bur¡
(burst_interface);

71 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
, bur¡_š‹rçû->
cmd_¡©us_»g_v®ue
.
v®ue
);

72 #ifdeà 
DDR_BURST_INTERFACE_DEBUG


73 
	`´štk
("%s.%d:%x=0x%08x\n", 
__FUNCTION__
, 
__LINE__
, 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
, 
ch
->
io_İ
->
	`ch_»ad32
(chip, burst_interface->burst_cmd_status_reg_offset));

76 
	}
}

78 
	$ddr_bur¡_š‹rçû_»g_’abË_acûss_¤am_block
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

80 if(
bur¡_š‹rçû
 !ğ
NULL
){

81 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
bur¡_mode_’
 = 1;

83 
	}
}

85 
	$ddr_bur¡_š‹rçû_»g_’abË_acûss_ddr_block
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

87 if(
bur¡_š‹rçû
 !ğ
NULL
){

88 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
bur¡_mode_’
 = 0;

90 
	}
}

92 
	$ddr_bur¡_š‹rçû_»g_£Ëù_ddr_A
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

94 if(
bur¡_š‹rçû
 !ğ
NULL
){

95 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
ddr_a_b_£Ëù
 = 0;

97 
	}
}

99 
	$ddr_bur¡_š‹rçû_»g_£Ëù_ddr_B
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

101 if(
bur¡_š‹rçû
 !ğ
NULL
){

102 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
ddr_a_b_£Ëù
 = 1;

104 
	}
}

106 
	$ddr_bur¡_š‹rçû_»g_’abË_»ad_4
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

108 if(
bur¡_š‹rçû
 !ğ
NULL
){

109 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
mpi_bur¡_»ad_4_’abË
 = 1;

111 
	}
}

113 
	$ddr_bur¡_š‹rçû_»g_di§bË_»ad_4
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

115 if(
bur¡_š‹rçû
 !ğ
NULL
){

116 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
mpi_bur¡_»ad_4_’abË
 = 0;

118 
	}
}

120 
	$ddr_bur¡_š‹rçû_»g_£t_ddr_·ge_numb”
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
·ge_id
)

122 if(
bur¡_š‹rçû
 !ğ
NULL
){

123 
bur¡_š‹rçû
->
·ge_mode_»g_v®ue
.
b™_v®ue
.
·ge_id
 = (page_id&0xff);

125 
	}
}

127 
	$ddr_bur¡_š‹rçû_»g_£t_ddr_bur¡_·¿m
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
bur¡_Ën
, 
dœ
)

129 if(
bur¡_š‹rçû
 !ğ
NULL
){

130 if(
dœ
 =ğ
TW_READ
){

131 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
bur¡_dœ
 = 0;

133 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
bur¡_dœ
 = 1;

135 
bur¡_Ën
 += 3;

136 
bur¡_Ën
 >>= 2;

137 
bur¡_Ën
 <<= 2;

138 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
bur¡_Ën
 = burst_len;

140 
	}
}

142 
	$ddr_bur¡_š‹rçû_»g_¡¬t_ddr_bur¡
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

144 if(
bur¡_š‹rçû
 !ğ
NULL
){

145 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
bur¡_Œigg”
 = 1;

147 
	}
}

149 
	$ddr_bur¡_š‹rçû_»g_št_’abË
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
ddr_sšgË_acûss_”r_št_’abË
, 
ddr_bur¡_acûss_”r_št_’abË
, 
bur¡_’d_št_’abË
)

151 if(
bur¡_š‹rçû
 !ğ
NULL
){

152 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_sšgË_acûss_”r_št_’abË
 = (ddr_single_access_err_int_enable&0x1);

153 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_acûss_”r_št_’abË
 = (ddr_burst_access_err_int_enable&0x1);

154 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
bur¡_’d_št_’abË
 = (burst_end_int_enable&0x1);

156 
	}
}

158 
	$ddr_bur¡_š‹rçû_»g_g‘_sšgË_acûss_”r_æag
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

160  
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_sšgË_acûss_”r_æag
;

161 
	}
}

163 
	$ddr_bur¡_š‹rçû_»g_g‘_bur¡_acûss_”r_æag
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

165  
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_”r_æag
;

166 
	}
}

168 
	$ddr_bur¡_š‹rçû_»g_g‘_bur¡_busy_æag
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

170  
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_busy_æag
;

171 
	}
}

173 
	$ddr_bur¡_š‹rçû_»g_g‘_bur¡_’d_æag
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

175  
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_’d_æag
;

176 
	}
}

178 
	$ddr_bur¡_š‹rçû_»g_ş—r_bur¡_’d_æag
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

180 if(
bur¡_š‹rçû
 !ğ
NULL
){

181 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_’d_æag
 = 1;

183 
	}
}

185 
	$ddr_bur¡_š‹rçû_»g_£t_bur¡_ddr_addr
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
u32
 
addr_off£t
)

187 if(
bur¡_š‹rçû
 !ğ
NULL
){

188 
bur¡_š‹rçû
->
ddr_ba£_addr_»g_v®ue
.
b™_v®ue
.
ddr_ba£_addr
 = 
addr_off£t
&0x0fffffff;

190 
	}
}

192 
	$ddr_bur¡_š‹rçû_»g_£t_bur¡_¤am_addr
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
u32
 
addr_off£t
)

194 if(
bur¡_š‹rçû
 !ğ
NULL
){

195 
bur¡_š‹rçû
->
¤am_ba£_addr_»g_v®ue
.
b™_v®ue
.
¤am_ba£_addr
 = 
addr_off£t
&0x0000ffff;

197 
	}
}

199 
	$ddr_bur¡_š‹rçû_»g_pio_ho¡_to_¤am_wr™e
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 *
ho¡_’d_addr
, 
Ën
)

201 
»t
 = 0;

202 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

203 
dvm_ch_t
 *
ch
;

204 
u32
 
d´am_·ge_ba£
;

205 
i
;

206 
æags
;

207 
	`loÿl_œq_§ve
(
æags
);

208 
ch
 = 
bur¡_š‹rçû
->chip;

209 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

210 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

211 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

213 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

214 
»t
 = 
Ën
;

215 
Ën
 += 3;

216 
Ën
 >>= 2;

217 
i
=0; i<
Ën
; i++){

218 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
d´am_·ge_ba£
, 
ho¡_’d_addr
[
i
]);

219 
d´am_·ge_ba£
 += 4;

221 
	`loÿl_œq_»¡Üe
(
æags
);

223  
»t
;

224 
	}
}

226 
	$ddr_bur¡_š‹rçû_»g_dma_ho¡_to_¤am_wr™e
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
dma_addr_t
 
ho¡_’d_addr
, 
Ën
)

228 
»t
 = 0;

229 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

230 
dvm_ch_t
 *
ch
;

231 
dma_addr_t
 
¤c
, 
de¡
;

232 
æags
;

233 
	`loÿl_œq_§ve
(
æags
);

234 
ch
 = 
bur¡_š‹rçû
->chip;

235 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

236 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

237 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

239 
de¡
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

240 
de¡
 +ğ
ch
->
·_»gs
;

241 
¤c
 = 
ho¡_’d_addr
;

242 
»t
 = 
Ën
;

243 
Ën
 += 3;

244 
Ën
 >>= 2;

245 
Ën
 <<= 2;

246 
	`åga_dma_»ûive
((
u32
)
¤c
, (u32)
de¡
, 
Ën
);

247 
	`loÿl_œq_»¡Üe
(
æags
);

249  
»t
;

250 
	}
}

252 
	$ddr_bur¡_š‹rçû_»g_pio_ho¡_to_¤am_»ad
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 *
ho¡_’d_addr
, 
Ën
)

254 
»t
 = 0;

255 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

256 
dvm_ch_t
 *
ch
;

257 
u32
 
d´am_·ge_ba£
;

258 
i
;

259 
æags
;

260 
	`loÿl_œq_§ve
(
æags
);

261 
ch
 = 
bur¡_š‹rçû
->chip;

262 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

263 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

264 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

266 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

267 
»t
 = 
Ën
;

268 
Ën
 += 3;

269 
Ën
 >>= 2;

270 
i
=0; i<
Ën
; i++){

271 
ho¡_’d_addr
[
i
] = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
d´am_·ge_ba£
);

272 
d´am_·ge_ba£
 += 4;

274 
	`loÿl_œq_»¡Üe
(
æags
);

276  
»t
;

277 
	}
}

279 
	$ddr_bur¡_š‹rçû_»g_dma_ho¡_to_¤am_»ad
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
dma_addr_t
 
ho¡_’d_addr
, 
Ën
)

281 
»t
=0;

282 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

283 
dvm_ch_t
 *
ch
;

284 
dma_addr_t
 
¤c
, 
de¡
;

285 
æags
;

286 
	`loÿl_œq_§ve
(
æags
);

287 
ch
 = 
bur¡_š‹rçû
->chip;

288 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

289 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

290 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

292 
¤c
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

293 
¤c
 +ğ
ch
->
·_»gs
;

294 
de¡
 = 
ho¡_’d_addr
;

295 
»t
 = 
Ën
;

296 
Ën
 += 3;

297 
Ën
 >>= 2;

298 
Ën
 <<= 2;

299 
	`åga_dma_»ûive
((
u32
)
¤c
, (u32)
de¡
, 
Ën
);

300 
	`loÿl_œq_»¡Üe
(
æags
);

307  
»t
;

308 
	}
}

310 
	$ddr_bur¡_š‹rçû_»g_¡¬t_block_Œªsãr_äom_¤am_to_ddr
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 
ddr_’d_addr
, 
·ge_id
, 
Ën
, 
ddr_ch_a_Ü_b
)

312 
couÁ
, 
esÿ³
;

314 
couÁ
 = 
esÿ³
 = 0;

315 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

316 
dvm_ch_t
 *
ch
;

317 
u32
 
d´am_·ge_ba£
;

318 
æags
;

319 
	`loÿl_œq_§ve
(
æags
);

320 
ch
 = 
bur¡_š‹rçû
->chip;

321 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

322 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

323 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

325 
couÁ
 = 
esÿ³
 = 0;

326 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

327 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_busy_æag
(burst_interface)){

329 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

330 
couÁ
++;

331 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

332 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

333 
esÿ³
 = 1;

338 if(!
esÿ³
){

339 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_·ge_numb”
(bur¡_š‹rçû, 
·ge_id
);

340 if(
DDR_CHIP_B
 =ğ
ddr_ch_a_Ü_b
){

341 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_B
(burst_interface);

343 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_A
(burst_interface);

345 #ifdeà 
POWERPC_PLATFORM


346 #ifdeà 
POWERPC_PCI_PLATFORM


347 
bur¡_š‹rçû
->
İ
->
	`’abË_»ad_4
(burst_interface);

350 #ifdeà
ARM_PLATFORM


351 
bur¡_š‹rçû
->
İ
->
	`di§bË_»ad_4
(burst_interface);

354 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

356 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_off£t
(dpram_page);

357 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_¤am_addr
(bur¡_š‹rçû, 
d´am_·ge_ba£
);

358 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_ddr_addr
(bur¡_š‹rçû, 
ddr_’d_addr
);

359 
bur¡_š‹rçû
->
İ
->
	`št_’abË
(burst_interface, 0, 0, 0);

360 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_bur¡_·¿m
(bur¡_š‹rçû, 
Ën
, 
TW_WRITE
);

361 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

363 
couÁ
 = 
esÿ³
 = 0;

364 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

365 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_’d_æag
(burst_interface) == 0){

367 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

368 
couÁ
++;

369 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

370 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

371 
esÿ³
 = 1;

376 if(
esÿ³
 == 0){

377 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_’d_æag
(burst_interface);

378 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

381 
	`loÿl_œq_»¡Üe
(
æags
);

382 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

384  
esÿ³
;

385 
	}
}

387 
	$ddr_bur¡_š‹rçû_»g_¡¬t_nÚblock_Œªsãr_äom_¤am_to_ddr
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 
ddr_’d_addr
, 
·ge_id
, 
Ën
, 
ddr_ch_a_Ü_b
)

389 
couÁ
, 
esÿ³
;

391 
couÁ
 = 
esÿ³
 = 0;

392 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

393 
dvm_ch_t
 *
ch
;

394 
u32
 
d´am_·ge_ba£
;

395 
æags
;

396 
couÁ
, 
esÿ³
;

398 
	`loÿl_œq_§ve
(
æags
);

399 
ch
 = 
bur¡_š‹rçû
->chip;

400 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

401 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

402 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

404 
couÁ
 = 
esÿ³
 = 0;

405 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

406 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_busy_æag
(burst_interface)){

408 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

409 
couÁ
++;

410 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

411 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

412 
esÿ³
 = 1;

417 if(!
esÿ³
){

418 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_·ge_numb”
(bur¡_š‹rçû, 
·ge_id
);

419 if(
DDR_CHIP_B
 =ğ
ddr_ch_a_Ü_b
){

420 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_B
(burst_interface);

422 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_A
(burst_interface);

424 #ifdeà 
POWERPC_PLATFORM


425 #ifdeà 
POWERPC_PCI_PLATFORM


426 
bur¡_š‹rçû
->
İ
->
	`’abË_»ad_4
(burst_interface);

429 #ifdeà
ARM_PLATFORM


430 
bur¡_š‹rçû
->
İ
->
	`di§bË_»ad_4
(burst_interface);

433 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

435 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_off£t
(dpram_page);

436 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_¤am_addr
(bur¡_š‹rçû, 
d´am_·ge_ba£
);

437 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_ddr_addr
(bur¡_š‹rçû, 
ddr_’d_addr
);

438 
bur¡_š‹rçû
->
İ
->
	`št_’abË
(burst_interface, 0, 0, 1);

439 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_bur¡_·¿m
(bur¡_š‹rçû, 
Ën
, 
TW_WRITE
);

440 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

442 
	`loÿl_œq_»¡Üe
(
æags
);

444  
esÿ³
;

445 
	}
}

447 
	$ddr_bur¡_š‹rçû_»g_¡¬t_block_Œªsãr_äom_ddr_to_¤am
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 
ddr_’d_addr
, 
·ge_id
, 
Ën
, 
ddr_ch_a_Ü_b
)

449 
couÁ
, 
esÿ³
;

453 
couÁ
 = 
esÿ³
 = 0;

454 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

455 
dvm_ch_t
 *
ch
;

456 
u32
 
d´am_·ge_ba£
;

457 
æags
;

459 
	`loÿl_œq_§ve
(
æags
);

460 
ch
 = 
bur¡_š‹rçû
->chip;

461 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

462 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

463 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

464 
couÁ
 = 
esÿ³
 = 0;

465 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

466 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_busy_æag
(burst_interface)){

468 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

469 
couÁ
++;

470 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

471 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

472 
esÿ³
 = 1;

477 if(!
esÿ³
){

478 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_·ge_numb”
(bur¡_š‹rçû, 
·ge_id
);

479 if(
DDR_CHIP_B
 =ğ
ddr_ch_a_Ü_b
){

480 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_B
(burst_interface);

482 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_A
(burst_interface);

484 #ifdeà 
POWERPC_PLATFORM


485 #ifdeà 
POWERPC_PCI_PLATFORM


486 
bur¡_š‹rçû
->
İ
->
	`’abË_»ad_4
(burst_interface);

489 #ifdeà
ARM_PLATFORM


490 
bur¡_š‹rçû
->
İ
->
	`di§bË_»ad_4
(burst_interface);

493 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

495 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_off£t
(dpram_page);

496 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_¤am_addr
(bur¡_š‹rçû, 
d´am_·ge_ba£
);

497 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_ddr_addr
(bur¡_š‹rçû, 
ddr_’d_addr
);

498 
bur¡_š‹rçû
->
İ
->
	`št_’abË
(burst_interface, 0, 0, 0);

499 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_bur¡_·¿m
(bur¡_š‹rçû, 
Ën
, 
TW_READ
);

500 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

501 
couÁ
 = 
esÿ³
 = 0;

502 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

503 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_’d_æag
(burst_interface) == 0){

505 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

506 
couÁ
++;

507 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

508 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

509 
esÿ³
 = 1;

514 if(
esÿ³
 == 0){

515 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_’d_æag
(burst_interface);

516 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

519 
	`loÿl_œq_»¡Üe
(
æags
);

520 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

522  
esÿ³
;

523 
	}
}

525 
	$ddr_bur¡_š‹rçû_»g_¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
d´am_·ge_node_t
 *
d´am_·ge
, 
u32
 
ddr_’d_addr
, 
·ge_id
, 
Ën
, 
ddr_ch_a_Ü_b
)

527 
couÁ
, 
esÿ³
;

529 
couÁ
 = 
esÿ³
 = 0;

530 if((
bur¡_š‹rçû
!=
NULL
è&& (
d´am_·ge
!=NULL)){

531 
dvm_ch_t
 *
ch
;

532 
u32
 
d´am_·ge_ba£
;

533 
æags
;

534 
	`loÿl_œq_§ve
(
æags
);

535 
ch
 = 
bur¡_š‹rçû
->chip;

536 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

537 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

538 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

541 
couÁ
 = 
esÿ³
 = 0;

542 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

543 
bur¡_š‹rçû
->
cmd_¡©us_»g_v®ue
.
b™_v®ue
.
ddr_bur¡_busy_æag
 || bur¡_š‹rçû->cmd_¡©us_»g_v®ue.b™_v®ue.
ddr_sšgË_acûss_busy_æag
){

545 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

546 
couÁ
++;

547 if(
couÁ
 > 
BURST_INTERFACE_CHECKUP_TIMEOUT
){

548 
	`´štk
("%s.%d: cª'ˆacûs bur¡ iÁ”çû\n", 
__FUNCTION__
, 
__LINE__
);

549 
esÿ³
 = 1;

554 if(!
esÿ³
){

555 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_·ge_numb”
(bur¡_š‹rçû, 
·ge_id
);

556 if(
DDR_CHIP_B
 =ğ
ddr_ch_a_Ü_b
){

557 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_B
(burst_interface);

559 
bur¡_š‹rçû
->
İ
->
	`£Ëù_ddr_A
(burst_interface);

561 #ifdeà 
POWERPC_PLATFORM


562 #ifdeà 
POWERPC_PCI_PLATFORM


563 
bur¡_š‹rçû
->
İ
->
	`’abË_»ad_4
(burst_interface);

566 #ifdeà
ARM_PLATFORM


567 
bur¡_š‹rçû
->
İ
->
	`di§bË_»ad_4
(burst_interface);

570 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

572 
d´am_·ge_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_off£t
(dpram_page);

573 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_¤am_addr
(bur¡_š‹rçû, 
d´am_·ge_ba£
);

574 
bur¡_š‹rçû
->
İ
->
	`£t_bur¡_ddr_addr
(bur¡_š‹rçû, 
ddr_’d_addr
);

575 
bur¡_š‹rçû
->
İ
->
	`št_’abË
(burst_interface, 0, 0, 1);

576 
bur¡_š‹rçû
->
İ
->
	`£t_ddr_bur¡_·¿m
(bur¡_š‹rçû, 
Ën
, 
TW_READ
);

577 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

579 
	`loÿl_œq_»¡Üe
(
æags
);

581  
esÿ³
;

582 
	}
}

584 
	$ddr_bur¡_š‹rçû_»g_ş—r_bur¡_dÚe
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
)

586 if(
bur¡_š‹rçû
 !ğ
NULL
){

587 
dvm_ch_t
 *
ch
;

588 
æags
;

589 
	`loÿl_œq_§ve
(
æags
);

590 
ch
 = 
bur¡_š‹rçû
->chip;

591 
bur¡_š‹rçû
->
İ
->
	`g‘_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

592 
bur¡_š‹rçû
->
İ
->
	`’abË_acûss_¤am_block
(burst_interface);

593 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

595 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

596 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_’d_æag
(burst_interface);

597 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
bur¡_š‹rçû
->
bur¡_cmd_¡©us_»g_off£t
, bur¡_š‹rçû->
cmd_¡©us_»g_v®ue
.
v®ue
);

598 
bur¡_š‹rçû
->
İ
->
	`g‘_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

599 
	`loÿl_œq_»¡Üe
(
æags
);

601 
	}
}

603 
ddr_bur¡_š‹rçû_»g_İ”©iÚ
 
	gddr_bur¡_š‹rçû_»g_İ
 = {

604 .
š™
 = 
ddr_bur¡_š‹rçû_»g_š™
,

605 .
	g»£t
 = 
ddr_bur¡_š‹rçû_»g_»£t
,

606 .
	gg‘_·ge_mode_»g
 = 
ddr_bur¡_š‹rçû_»g_g‘_·ge_mode_»g
,

607 .
	gupd©e_·ge_mode_»g
 = 
ddr_bur¡_š‹rçû_»g_upd©e_·ge_mode_»g
,

608 .
	gg‘_bur¡_š‹rçû_·¿m
 = 
ddr_bur¡_š‹rçû_»g_g‘_bur¡_š‹rçû_·¿m
,

609 .
	gupd©e_bur¡_š‹rçû_·¿m
 = 
ddr_bur¡_š‹rçû_»g_upd©e_bur¡_š‹rçû_·¿m
,

611 .
	g’abË_acûss_¤am_block
 = 
ddr_bur¡_š‹rçû_»g_’abË_acûss_¤am_block
,

612 .
	g’abË_acûss_ddr_block
 = 
ddr_bur¡_š‹rçû_»g_’abË_acûss_ddr_block
,

613 .
	g£Ëù_ddr_A
 = 
ddr_bur¡_š‹rçû_»g_£Ëù_ddr_A
,

614 .
	g£Ëù_ddr_B
 = 
ddr_bur¡_š‹rçû_»g_£Ëù_ddr_B
,

615 .
	g’abË_»ad_4
 = 
ddr_bur¡_š‹rçû_»g_’abË_»ad_4
,

616 .
	gdi§bË_»ad_4
 = 
ddr_bur¡_š‹rçû_»g_di§bË_»ad_4
,

617 .
	g£t_ddr_·ge_numb”
 = 
ddr_bur¡_š‹rçû_»g_£t_ddr_·ge_numb”
,

619 .
	g£t_ddr_bur¡_·¿m
 = 
ddr_bur¡_š‹rçû_»g_£t_ddr_bur¡_·¿m
,

620 .
	g¡¬t_ddr_bur¡
 = 
ddr_bur¡_š‹rçû_»g_¡¬t_ddr_bur¡
,

621 .
	gšt_’abË
 = 
ddr_bur¡_š‹rçû_»g_št_’abË
,

622 .
	gg‘_sšgË_acûss_”r_æag
 = 
ddr_bur¡_š‹rçû_»g_g‘_sšgË_acûss_”r_æag
,

623 .
	gg‘_bur¡_acûss_”r_æag
 = 
ddr_bur¡_š‹rçû_»g_g‘_bur¡_acûss_”r_æag
,

624 .
	gg‘_bur¡_busy_æag
 = 
ddr_bur¡_š‹rçû_»g_g‘_bur¡_busy_æag
,

625 .
	gg‘_bur¡_’d_æag
 = 
ddr_bur¡_š‹rçû_»g_g‘_bur¡_’d_æag
,

626 .
	gş—r_bur¡_’d_æag
 = 
ddr_bur¡_š‹rçû_»g_ş—r_bur¡_’d_æag
,

627 .
	g£t_bur¡_ddr_addr
 = 
ddr_bur¡_š‹rçû_»g_£t_bur¡_ddr_addr
,

628 .
	g£t_bur¡_¤am_addr
 = 
ddr_bur¡_š‹rçû_»g_£t_bur¡_¤am_addr
,

630 .
	gpio_ho¡_to_¤am_wr™e
 = 
ddr_bur¡_š‹rçû_»g_pio_ho¡_to_¤am_wr™e
,

631 .
	gdma_ho¡_to_¤am_wr™e
 = 
ddr_bur¡_š‹rçû_»g_dma_ho¡_to_¤am_wr™e
,

632 .
	gpio_ho¡_to_¤am_»ad
 = 
ddr_bur¡_š‹rçû_»g_pio_ho¡_to_¤am_»ad
,

633 .
	gdma_ho¡_to_¤am_»ad
 = 
ddr_bur¡_š‹rçû_»g_dma_ho¡_to_¤am_»ad
,

635 .
	g¡¬t_block_Œªsãr_äom_¤am_to_ddr
 = 
ddr_bur¡_š‹rçû_»g_¡¬t_block_Œªsãr_äom_¤am_to_ddr
,

636 .
	g¡¬t_nÚblock_Œªsãr_äom_¤am_to_ddr
 = 
ddr_bur¡_š‹rçû_»g_¡¬t_nÚblock_Œªsãr_äom_¤am_to_ddr
,

637 .
	g¡¬t_block_Œªsãr_äom_ddr_to_¤am
 = 
ddr_bur¡_š‹rçû_»g_¡¬t_block_Œªsãr_äom_ddr_to_¤am
,

638 .
	g¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
 = 
ddr_bur¡_š‹rçû_»g_¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
,

639 .
	gş—r_bur¡_dÚe
 = 
ddr_bur¡_š‹rçû_»g_ş—r_bur¡_dÚe
,

642 
	$š™_ddr_bur¡_š‹rçû_t
(
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
, 
dvm_ch_t
 *
ch
)

644 if(
bur¡_š‹rçû
 !ğ
NULL
){

645 
bur¡_š‹rçû
->
İ
 = &
ddr_bur¡_š‹rçû_»g_İ
;

646 
bur¡_š‹rçû
->
ch
 = chip;

647 
bur¡_š‹rçû
->
İ
->
	`š™
(burst_interface);

648 
bur¡_š‹rçû
->
İ
->
	`upd©e_·ge_mode_»g
(bur¡_š‹rçû, 
ch
);

649 
bur¡_š‹rçû
->
İ
->
	`upd©e_bur¡_š‹rçû_·¿m
(bur¡_š‹rçû, 
ch
);

651 
	}
}

653 
u32
 
	$d´am_pg«_node_g‘_·ge_ba£
(
d´am_·ge_node_t
 *
d´am_·ge
)

655  (
d´am_·ge
->
d´am_ba£
 + d´am_·ge->
d´am_·ge_ba£_off£t
);

656 
	}
}

658 
u32
 
	$d´am_·ge_node_g‘_·ge_off£t
(
d´am_·ge_node_t
 *
d´am_·ge
)

660  
d´am_·ge
->
d´am_·ge_ba£_off£t
;

661 
	}
}

663 
	$d´am_·ge_node_g‘_·ge_size
(
d´am_·ge_node_t
 *
d´am_·ge
)

665  
d´am_·ge
->
·ge_size
;

666 
	}
}

668 
d´am_·ge_node_İ”©iÚ
 
	gd´am_·ge_node_İ
 = {

669 .
g‘_·ge_ba£
 = 
d´am_pg«_node_g‘_·ge_ba£
,

670 .
	gg‘_·ge_off£t
 = 
d´am_·ge_node_g‘_·ge_off£t
,

671 .
	gg‘_·ge_size
 = 
d´am_·ge_node_g‘_·ge_size
,

674 
	$d´am_·ge_»sourû_mªage_š™
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
)

676 if(
d´am_·ge_»sourû
){

677 
d´am_·ge_node_t
 *
d´am
;

678 
u32
 
·ge_off£t
;

679 
i
;

680 
d´am
 = 
d´am_·ge_»sourû
->dpram;

681 
d´am_·ge_»sourû
->
d´am_numb”
 = 
DPRAM_PAGE_NUMBER
;

682 
d´am_·ge_»sourû
->
cu¼_u£d_d´am_šdex
 = 0;

683 
	`©omic_£t
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
, d´am_·ge_»sourû->
d´am_numb”
);

684 
	`¥š_lock_š™
(&
d´am_·ge_»sourû
->
lock
);

685 
·ge_off£t
 = 
DPRAM_PAGE_SIZE
;

686 
i
=0; i<
d´am_·ge_»sourû
->
d´am_numb”
; i++){

687 
d´am
->
d´am_ba£
 = 
MPI_DPRAM_BASE_OFFSET
;

688 
d´am
->
d´am_·ge_ba£_off£t
 = 
i
*
·ge_off£t
;

689 
d´am
->
·ge_size
 = 
·ge_off£t
;

690 
d´am
->
İ
 = &
d´am_·ge_node_İ
;

691 
d´am
++;

694 
	}
}

696 
	$d´am_·ge_»sourû_mªage_g‘_d´am_·ge
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

698 if((
d´am_·ge_»sourû
!=
NULL
è&& (
±r_d´am_·ge
!=NULL)){

699 
æags
;

700 
	`¥š_lock_œq§ve
(&
d´am_·ge_»sourû
->
lock
, 
æags
);

701 *
±r_d´am_·ge
 = 
NULL
;

702 if(
	`©omic_»ad
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
)){

703 
	`©omic_dec
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
);

704 *
±r_d´am_·ge
 = &
d´am_·ge_»sourû
->
d´am
[d´am_·ge_»sourû->
cu¼_u£d_d´am_šdex
];

705 
d´am_·ge_»sourû
->
cu¼_u£d_d´am_šdex
++;

706 if(
d´am_·ge_»sourû
->
cu¼_u£d_d´am_šdex
 >ğd´am_·ge_»sourû->
d´am_numb”
){

707 
d´am_·ge_»sourû
->
cu¼_u£d_d´am_šdex
 = 0;

710 
	`¥š_uÆock_œq»¡Üe
(&
d´am_·ge_»sourû
->
lock
, 
æags
);

712 
	}
}

714 
	$d´am_·ge_»sourû_mªage_put_d´am_·ge
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

716 if((
d´am_·ge_»sourû
!=
NULL
è&& (
±r_d´am_·ge
!=NULL)){

717 
æags
;

718 
	`¥š_lock_œq§ve
(&
d´am_·ge_»sourû
->
lock
, 
æags
);

719 if(*
±r_d´am_·ge
 !ğ
NULL
){

720 *
±r_d´am_·ge
 = 
NULL
;

721 
	`©omic_šc
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
);

722 if(
	`©omic_»ad
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
è> d´am_·ge_»sourû->
d´am_numb”
){

723 
	`©omic_£t
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
, d´am_·ge_»sourû->
d´am_numb”
);

726 
	`¥š_uÆock_œq»¡Üe
(&
d´am_·ge_»sourû
->
lock
, 
æags
);

728 
	}
}

730 
	$d´am_·ge_»sourû_mªage_g‘_ÿn_u£_»sourû_numb”
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
)

732  
	`©omic_»ad
(&
d´am_·ge_»sourû
->
cu¼_ÿn_u£_d´am_·ge_numb”
);

733 
	}
}

735 
d´am_·ge_»sourû_mªage_İ”©iÚ
 
	gd´am_·ge_»sourû_mªage_İ
 = {

736 .
š™
 = 
d´am_·ge_»sourû_mªage_š™
,

737 .
	gg‘_d´am_·ge
 = 
d´am_·ge_»sourû_mªage_g‘_d´am_·ge
,

738 .
	gput_d´am_·ge
 = 
d´am_·ge_»sourû_mªage_put_d´am_·ge
,

739 .
	gg‘_ÿn_u£_»sourû_numb”
 = 
d´am_·ge_»sourû_mªage_g‘_ÿn_u£_»sourû_numb”
,

742 
	$š™_d´am_·ge_»sourû_mªage
(
d´am_·ge_»sourû_mªage_t
 *
d´am_·ge_»sourû
)

744 if(
d´am_·ge_»sourû
 !ğ
NULL
){

745 
d´am_·ge_»sourû
->
İ
 = &
d´am_·ge_»sourû_mªage_İ
;

746 
d´am_·ge_»sourû
->
İ
->
	`š™
(dpram_page_resource);

748 
	}
}

750 
	$ddr_video_b™¡»am_buf_node_g‘_buf_id
(
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am
)

752  
video_b™¡»am
->
buf_id
;

753 
	}
}

755 
	$ddr_video_b™¡»am_buf_node_g‘_buf_š_ch_a_Ü_b
(
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am
)

757  
video_b™¡»am
->
ch_a_Ü_b
;

758 
	}
}

760 
	$ddr_video_b™¡»am_buf_node_g‘_·ge_id
(
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am
)

762  
video_b™¡»am
->
ddr_phy_·ge_id
;

763 
	}
}

765 
u32
 
	$ddr_video_b™¡»am_buf_node_g‘_buf_ba£_off£t
(
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am
)

767  
video_b™¡»am
->
buf_ba£_off£t
;

768 
	}
}

770 
ddr_video_b™¡»am_buf_node_İ”©iÚ
 
	gddr_video_b™¡»am_buf_node_İ
 = {

771 .
g‘_buf_id
 = 
ddr_video_b™¡»am_buf_node_g‘_buf_id
,

772 .
	gg‘_buf_š_ch_a_Ü_b
 = 
ddr_video_b™¡»am_buf_node_g‘_buf_š_ch_a_Ü_b
,

773 .
	gg‘_·ge_id
 = 
ddr_video_b™¡»am_buf_node_g‘_·ge_id
,

774 .
	gg‘_buf_ba£_off£t
 = 
ddr_video_b™¡»am_buf_node_g‘_buf_ba£_off£t
,

777 
	$m­_ddr_·ge_id_äom_buf_id
(
buf_id
)

779 
·ge_id
;

780 
buf_id
){

782 
·ge_id
 = 12;

785 
·ge_id
 = 28;

788 
·ge_id
 = 44;

791 
·ge_id
 = 60;

794 
·ge_id
 = 13;

797 
·ge_id
 = 29;

800 
·ge_id
 = 45;

803 
·ge_id
 = 61;

806  
·ge_id
;

807 
	}
}

809 
	$ddr_video_b™¡»am_»sourû_mªage_š™
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
)

811 if(
video_b™¡»am_»sourû
 !ğ
NULL
){

812 
ddr_video_b™¡»am_buf_node_t
 *
ddr_buf_£ùiÚ
;

813 
i
;

815 
ddr_buf_£ùiÚ
 = 
video_b™¡»am_»sourû
->ddr_buf_section;

816 
video_b™¡»am_»sourû
->
ddr_buf_£ùiÚ_numb”
 = 
VIDEO_BITSTREAM_DDR_SECTION_NUMBER
;

817 
video_b™¡»am_»sourû
->
cu¼_u£d_ddr_buf_£ùiÚ_šdex
 = 0;

818 
	`©omic_£t
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
, video_b™¡»am_»sourû->
ddr_buf_£ùiÚ_numb”
);

819 
	`¥š_lock_š™
(&
video_b™¡»am_»sourû
->
lock
);

820 
i
=0; i<
video_b™¡»am_»sourû
->
ddr_buf_£ùiÚ_numb”
; i++){

821 
ddr_buf_£ùiÚ
->
buf_id
 = 
i
;

822 
ddr_buf_£ùiÚ
->
ch_a_Ü_b
 = 
DDR_CHIP_B
;

823 
ddr_buf_£ùiÚ
->
ddr_phy_·ge_id
 = 
	`m­_ddr_·ge_id_äom_buf_id
(
i
);

824 
ddr_buf_£ùiÚ
->
buf_ba£_off£t
 = ddr_buf_£ùiÚ->
ddr_phy_·ge_id
<<19;

825 
ddr_buf_£ùiÚ
->
İ
 = &
ddr_video_b™¡»am_buf_node_İ
;

826 
ddr_buf_£ùiÚ
++;

829 
	}
}

831 
	$ddr_video_b™¡»am_»sourû_mªage_g‘_video_b™¡»am
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
, 
ddr_video_b™¡»am_buf_node_t
 **
±r_video_b™¡»am
)

833 if((
video_b™¡»am_»sourû
!=
NULL
è&& (
±r_video_b™¡»am
!=NULL)){

834 
æags
;

835 
	`¥š_lock_œq§ve
(&
video_b™¡»am_»sourû
->
lock
, 
æags
);

836 *
±r_video_b™¡»am
 = 
NULL
;

837 if(
	`©omic_»ad
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
)){

838 
	`©omic_dec
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
);

839 *
±r_video_b™¡»am
 = &
video_b™¡»am_»sourû
->
ddr_buf_£ùiÚ
[video_b™¡»am_»sourû->
cu¼_u£d_ddr_buf_£ùiÚ_šdex
];

840 
video_b™¡»am_»sourû
->
cu¼_u£d_ddr_buf_£ùiÚ_šdex
++;

841 if(
video_b™¡»am_»sourû
->
cu¼_u£d_ddr_buf_£ùiÚ_šdex
 >ğvideo_b™¡»am_»sourû->
ddr_buf_£ùiÚ_numb”
){

842 
video_b™¡»am_»sourû
->
cu¼_u£d_ddr_buf_£ùiÚ_šdex
 = 0;

845 
	`¥š_uÆock_œq»¡Üe
(&
video_b™¡»am_»sourû
->
lock
, 
æags
);

847 
	}
}

849 
	$ddr_video_b™¡»am_»sourû_mªage_put_video_b™¡»am
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
, 
ddr_video_b™¡»am_buf_node_t
 **
±r_video_b™¡»am
)

851 if((
video_b™¡»am_»sourû
!=
NULL
è&& (
±r_video_b™¡»am
!=NULL)){

852 
æags
;

853 
	`¥š_lock_œq§ve
(&
video_b™¡»am_»sourû
->
lock
, 
æags
);

854 if(*
±r_video_b™¡»am
 !ğ
NULL
){

855 *
±r_video_b™¡»am
 = 
NULL
;

856 
	`©omic_šc
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
);

857 if(
	`©omic_»ad
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
è> video_b™¡»am_»sourû->
ddr_buf_£ùiÚ_numb”
){

858 
	`©omic_£t
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
, video_b™¡»am_»sourû->
ddr_buf_£ùiÚ_numb”
);

861 
	`¥š_uÆock_œq»¡Üe
(&
video_b™¡»am_»sourû
->
lock
, 
æags
);

863 
	}
}

865 
	$ddr_video_b™¡»am_»sourû_mªage_g‘_ÿn_u£_»sourû_numb”
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
)

867  
	`©omic_»ad
(&
video_b™¡»am_»sourû
->
cu¼_ÿn_u£_ddr_buf_£ùiÚ_numb”
);

868 
	}
}

870 
ddr_video_b™¡»am_»sourû_mªage_İ”©iÚ
 
	gddr_video_b™¡»am_»sourû_mªage_İ
 = {

871 .
š™
 = 
ddr_video_b™¡»am_»sourû_mªage_š™
,

872 .
	gg‘_video_b™¡»am
 = 
ddr_video_b™¡»am_»sourû_mªage_g‘_video_b™¡»am
,

873 .
	gput_video_b™¡»am
 = 
ddr_video_b™¡»am_»sourû_mªage_put_video_b™¡»am
,

874 .
	gg‘_ÿn_u£_»sourû_numb”
 = 
ddr_video_b™¡»am_»sourû_mªage_g‘_ÿn_u£_»sourû_numb”
,

877 
	$š™_ddr_video_b™¡»am_»sourû_mªage
(
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
)

879 if(
video_b™¡»am_»sourû
 !ğ
NULL
){

880 
video_b™¡»am_»sourû
->
İ
 = &
ddr_video_b™¡»am_»sourû_mªage_İ
;

881 
video_b™¡»am_»sourû
->
İ
->
	`š™
(video_bitstream_resource);

883 
	}
}

885 
	$š™_d´am_»que¡_£rviû_tcb
(
d´am_»que¡_t
 *
»que¡_tcb
)

887 if(
»que¡_tcb
 !ğ
NULL
){

888 
tcb_node_t
 *
node
 = &
»que¡_tcb
->
»que¡_node
;

889 
»que¡_tcb
->
ty³
 = 
DPRAM_BLOCK_TRANSFER_REQUEST
;

890 
»que¡_tcb
->
cÚ‹xt
 = 
NULL
;

891 
»que¡_tcb
->
»q_ÿÎback
 = 
NULL
;

892 
node
->
İ
 = &
tcb_node_İ
;

893 
node
->
İ
->
	`š™
(node);

894 
node
->
İ
->
	`£t_´iv
Òode, 
»que¡_tcb
);

896 
	}
}

898 
	$d´am_»que¡_queue_š™
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

900 if(
»que¡_queue
 !ğ
NULL
){

901 
tcb_node_queue_t
 *
»que¡_queue_node
 = &
»que¡_queue
->request_queue;

902 
»que¡_queue
->
cu¼_£rviû_»q
 = 
NULL
;

903 
	`¥š_lock_š™
(&
»que¡_queue
->
lock
);

904 
»que¡_queue_node
->
İ
 = &
tcb_node_queue_İ
;

905 
»que¡_queue_node
->
İ
->
	`š™
(request_queue_node);

907 
	}
}

909 
	$d´am_»que¡_queue_g‘_queue_cu¼_’Œy_numb”
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

911 if(
»que¡_queue
 !ğ
NULL
) {

912 
tcb_node_queue_t
 *
»que¡_queue_node
 = &
»que¡_queue
->request_queue;

913  
»que¡_queue_node
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(request_queue_node);

917 
	}
}

919 
	$d´am_»que¡_queue_put_£rviû_»que¡_što_queue
(
d´am_»que¡_queue_t
 *
»que¡_queue
, 
d´am_»que¡_t
 *
»que¡
)

921 if((
»que¡_queue
!=
NULL
è&& (
»que¡
!=NULL)){

922 
tcb_node_queue_t
 *
»que¡_queue_node
 = &
»que¡_queue
->request_queue;

923 
»que¡_queue_node
->
İ
->
	`put
Ôeque¡_queue_node, &
»que¡
->
»que¡_node
);

924 
»que¡_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(request_queue);

926 
	}
}

928 
	$d´am_»que¡_queue_put_£rviû_»que¡_što_queue_h—d”
(
d´am_»que¡_queue_t
 *
»que¡_queue
, 
d´am_»que¡_t
 *
»que¡
)

930 if((
»que¡_queue
!=
NULL
è&& (
»que¡
!=NULL)){

931 
tcb_node_queue_t
 *
»que¡_queue_node
 = &
»que¡_queue
->request_queue;

932 
»que¡_queue_node
->
İ
->
	`put_h—d”
Ôeque¡_queue_node, &
»que¡
->
»que¡_node
);

933 
»que¡_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(request_queue);

935 
	}
}

937 
	$d´am_»que¡_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

939 if(
»que¡_queue
 !ğ
NULL
){

940 
tcb_node_queue_t
 *
»que¡_queue_node
 = &
»que¡_queue
->request_queue;

941 if(
»que¡_queue
->
cu¼_£rviû_»q
 =ğ
NULL
){

942 if(
»que¡_queue_node
->
İ
 !ğ
NULL
){

943 
tcb_node_t
 *
‹mp_node
;

944 
»que¡_queue_node
->
İ
->
	`Œy_g‘
Ôeque¡_queue_node, &
‹mp_node
);

945 if(
‹mp_node
 !ğ
NULL
){

946 
»que¡_queue
->
cu¼_£rviû_»q
 = 
	`to_g‘_d´am_»que¡_w™h_»que¡_node
(
‹mp_node
);

951 
	}
}

953 
	$d´am_»que¡_queue_»Ëa£_cu¼_cÚsum”
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

955 if(
»que¡_queue
 !ğ
NULL
){

956 
æags
;

957 
	`¥š_lock_œq§ve
(&
»que¡_queue
->
lock
, 
æags
);

958 
»que¡_queue
->
cu¼_£rviû_»q
 = 
NULL
;

959 
	`¥š_uÆock_œq»¡Üe
(&
»que¡_queue
->
lock
, 
æags
);

961 
	}
}

963 
	$d´am_»que¡_queue_Œigg”_ch_³ndšg_£rviû_»que¡
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

965 if(
»que¡_queue
 !ğ
NULL
){

966 
d´am_»que¡_t
 *
cu¼_»que¡
;

967 
æags
;

968 
cu¼_’Œy_numb”
;

970 
	`¥š_lock_œq§ve
(&
»que¡_queue
->
lock
, 
æags
);

971 
cu¼_’Œy_numb”
 = 
»que¡_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(request_queue);

972 if((
cu¼_’Œy_numb”
==0è&& (
»que¡_queue
->
cu¼_£rviû_»q
==
NULL
)){

973 
	`¥š_uÆock_œq»¡Üe
(&
»que¡_queue
->
lock
, 
æags
);

975 } if(
»que¡_queue
->
cu¼_£rviû_»q
 !ğ
NULL
){

976 
	`¥š_uÆock_œq»¡Üe
(&
»que¡_queue
->
lock
, 
æags
);

979 
»que¡_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(request_queue);

980 
cu¼_»que¡
 = 
»que¡_queue
->
cu¼_£rviû_»q
;

981 
	`¥š_uÆock_œq»¡Üe
(&
»que¡_queue
->
lock
, 
æags
);

982 if(
cu¼_»que¡
 !ğ
NULL
){

983 
cu¼_»que¡
->
	`»q_ÿÎback
(cu¼_»que¡, cu¼_»que¡->
cÚ‹xt
);

986 
	}
}

988 
d´am_»que¡_queue_İ”©iÚ
 
	gd´am_»que¡_queue_İ
 = {

989 .
š™
 = 
d´am_»que¡_queue_š™
,

990 .
	gg‘_queue_cu¼_’Œy_numb”
 = 
d´am_»que¡_queue_g‘_queue_cu¼_’Œy_numb”
,

991 .
	gput_£rviû_»que¡_što_queue
 = 
d´am_»que¡_queue_put_£rviû_»que¡_što_queue
,

992 .
	gput_£rviû_»que¡_što_queue_h—d”
 = 
d´am_»que¡_queue_put_£rviû_»que¡_što_queue_h—d”
,

993 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
d´am_»que¡_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

994 .
	g»Ëa£_cu¼_cÚsum”
 = 
d´am_»que¡_queue_»Ëa£_cu¼_cÚsum”
,

995 .
	gŒigg”_ch_³ndšg_£rviû_»que¡
 = 
d´am_»que¡_queue_Œigg”_ch_³ndšg_£rviû_»que¡
,

998 
	$š™_d´am_»que¡_queue
(
d´am_»que¡_queue_t
 *
»que¡_queue
)

1000 if(
»que¡_queue
 !ğ
NULL
){

1001 
»que¡_queue
->
İ
 = &
d´am_»que¡_queue_İ
;

1002 
»que¡_queue
->
İ
->
	`š™
(request_queue);

1004 
	}
}

1006 
	$d´am_cÚŒŞ_š™
(
d´am_cÚŒŞ_t
 *
d´am
, 
dvm_ch_t
 *
ch
)

1008 
d´am
->
ch
 = chip;

1009 
	`¥š_lock_š™
(&
d´am
->
lock
);

1010 
	`©omic_£t
(&
d´am
->
bus_¡©e
, 
BUS_IDLE
);

1011 
	`š™_ddr_bur¡_š‹rçû_t
(&
d´am
->
bur¡_š‹rçû
, d´am->
ch
);

1012 
	`š™_d´am_»que¡_queue
(&
d´am
->
»que¡_queue
);

1013 
	`š™_d´am_·ge_»sourû_mªage
(&
d´am
->
d´am_»sourû
);

1014 
	`š™_ddr_video_b™¡»am_»sourû_mªage
(&
d´am
->
video_b™¡»am_»sourû
);

1015 
	}
}

1017 
	$d´am_cÚŒŞ_is_ÿn_subm™_h264_’code_£rviû_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
ddr_video_b™¡»am_buf_node_t
 **
±r_video_b™¡»am_buf
)

1019 
»t
 = 0;

1020 if(
d´am
 !ğ
NULL
){

1021 
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
;

1022 
æags
;

1023 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1024 
video_b™¡»am_»sourû
 = &
d´am
->video_bitstream_resource;

1025 
»t
 = 
video_b™¡»am_»sourû
->
İ
->
	`g‘_ÿn_u£_»sourû_numb”
(video_bitstream_resource);

1026 
video_b™¡»am_»sourû
->
İ
->
	`g‘_video_b™¡»am
(video_b™¡»am_»sourû, 
±r_video_b™¡»am_buf
);

1027 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1029  
»t
;

1030 
	}
}

1032 
	$d´am_cÚŒŞ_»Ëa£_h264_ddr_·ge_»sourû
(
d´am_cÚŒŞ_t
 *
d´am
, 
ddr_video_b™¡»am_buf_node_t
 **
±r_video_b™¡»am_buf
)

1034 if(
d´am
 !ğ
NULL
){

1035 
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
;

1036 
æags
;

1037 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1038 
video_b™¡»am_»sourû
 = &
d´am
->video_bitstream_resource;

1039 
video_b™¡»am_»sourû
->
İ
->
	`put_video_b™¡»am
(video_b™¡»am_»sourû, 
±r_video_b™¡»am_buf
);

1040 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1042 
	}
}

1044 
	$d´am_cÚŒŞ_is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

1046 
»t
 = 0;

1047 if(
d´am
 !ğ
NULL
){

1048 
d´am_·ge_»sourû_mªage_t
 *
d´am_»sourû
;

1049 
æags
;

1050 
bus_¡©e
;

1051 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1052 
bus_¡©e
 = 
	`©omic_»ad
(&
d´am
->bus_state);

1053 if(!(
bus_¡©e
&
DDR_END_BUS_BUSY
)){

1054 
d´am_»sourû
 = &
d´am
->dpram_resource;

1055 
»t
 = 
d´am_»sourû
->
İ
->
	`g‘_ÿn_u£_»sourû_numb”
(dpram_resource);

1056 if(
»t
){

1057 
bus_¡©e
 |ğ
DDR_END_BUS_BUSY
;

1058 
	`©omic_£t
(&
d´am
->
bus_¡©e
, bus_state);

1059 
d´am_»sourû
->
İ
->
	`g‘_d´am_·ge
(d´am_»sourû, 
±r_d´am_·ge
);

1062 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1064  
»t
;

1065 
	}
}

1067 
	$d´am_cÚŒŞ_nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

1069 if((
d´am
!=
NULL
è&& (
±r_d´am_·ge
!=NULL)){

1070 
d´am_·ge_»sourû_mªage_t
 *
d´am_»sourû
;

1071 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1072 
æags
;

1073 
bus_¡©e
;

1074 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1075 
d´am_»sourû
 = &
d´am
->dpram_resource;

1076 
d´am_»sourû
->
İ
->
	`put_d´am_·ge
(d´am_»sourû, 
±r_d´am_·ge
);

1077 
bus_¡©e
 = 
	`©omic_»ad
(&
d´am
->bus_state);

1078 
bus_¡©e
 &ğ~
DDR_END_BUS_BUSY
;

1079 
	`©omic_£t
(&
d´am
->
bus_¡©e
, bus_state);

1080 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1081 
»que¡_queue
 = &
d´am
->request_queue;

1082 
»que¡_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(request_queue);

1083 
»que¡_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(request_queue);

1085 
	}
}

1087 
	$d´am_cÚŒŞ_is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

1089 
»t
 = 0;

1090 if(
d´am
 !ğ
NULL
){

1091 
d´am_·ge_»sourû_mªage_t
 *
d´am_»sourû
;

1092 
æags
;

1093 
bus_¡©e
;

1094 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1095 
bus_¡©e
 = 
	`©omic_»ad
(&
d´am
->bus_state);

1096 if(!(
bus_¡©e
&
DDR_END_BUS_BUSY
)){

1097 
d´am_»sourû
 = &
d´am
->dpram_resource;

1098 
»t
 = 
d´am_»sourû
->
İ
->
	`g‘_ÿn_u£_»sourû_numb”
(dpram_resource);

1099 if(
»t
){

1100 
bus_¡©e
 |ğ
DDR_END_BUS_BUSY
;

1101 
	`©omic_£t
(&
d´am
->
bus_¡©e
, bus_state);

1102 
d´am_»sourû
->
İ
->
	`g‘_d´am_·ge
(d´am_»sourû, 
±r_d´am_·ge
);

1105 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1107  
»t
;

1108 
	}
}

1110 
	$d´am_cÚŒŞ_nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
d´am_·ge_node_t
 **
±r_d´am_·ge
)

1112 if((
d´am
!=
NULL
è&& (
±r_d´am_·ge
!=NULL)){

1113 
d´am_·ge_»sourû_mªage_t
 *
d´am_»sourû
;

1114 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1115 
æags
;

1116 
bus_¡©e
;

1117 
	`¥š_lock_œq§ve
(&
d´am
->
lock
, 
æags
);

1118 
d´am_»sourû
 = &
d´am
->dpram_resource;

1119 
d´am_»sourû
->
İ
->
	`put_d´am_·ge
(d´am_»sourû, 
±r_d´am_·ge
);

1120 
bus_¡©e
 = 
	`©omic_»ad
(&
d´am
->bus_state);

1121 
bus_¡©e
 &ğ~
DDR_END_BUS_BUSY
;

1122 
	`©omic_£t
(&
d´am
->
bus_¡©e
, bus_state);

1123 
	`¥š_uÆock_œq»¡Üe
(&
d´am
->
lock
, 
æags
);

1124 
»que¡_queue
 = &
d´am
->request_queue;

1125 
»que¡_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(request_queue);

1126 
»que¡_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(request_queue);

1128 
	}
}

1130 
	$d´am_cÚŒŞ_subm™_»ad_h264_b™¡»am_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

1132 if((
d´am
!=
NULL
è&& (
h264_logic_’code_chª
!=NULL)){

1133 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1134 
»que¡_queue
 = &
d´am
->request_queue;

1135 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
h264_logic_’code_chª
->
»ad_video_b™¡»am_»q
);

1137 
	}
}

1139 
	$d´am_cÚŒŞ_ack_»ad_h264_b™¡»am_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

1141 if((
d´am
!=
NULL
è&& (
h264_logic_’code_chª
!=NULL)){

1144 
d´am
->
İ
->
	`»Ëa£_h264_ddr_·ge_»sourû
(d´am, &
h264_logic_’code_chª
->
video_b™¡»am_buf
);

1146 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
(d´am, &
h264_logic_’code_chª
->
d´am_·ge
);

1148 
	}
}

1150 
	$d´am_cÚŒŞ_subm™_wr™e_video_’code_osd_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

1152 if((
d´am
!=
NULL
è&& (
»ùªgË
!=NULL)){

1153 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1154 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1156 
»que¡_queue
 = &
d´am
->request_queue;

1157 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

1158 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
osd_d´am_»q
->
osd_d©a_»q
);

1160 
	}
}

1162 
	$d´am_cÚŒŞ_ack_wr™e_video_’code_osd_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

1164 if((
d´am
!=
NULL
è&& (
»ùªgË
!=NULL)){

1166 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1170 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

1171 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
(d´am, &
osd_d´am_»q
->
d´am_·ge
);

1173 
	}
}

1175 
	$d´am_cÚŒŞ_subm™_wr™e_video_’code_osd_©Œ_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
osd_©Œibu‹_»gs_group_t
 *
©Œ_group
)

1177 if((
d´am
!=
NULL
è&& (
©Œ_group
!=NULL)){

1178 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1179 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1181 
»que¡_queue
 = &
d´am
->request_queue;

1182 
osd_d´am_»q
 = &
©Œ_group
->osd_dpram_req;

1183 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
osd_d´am_»q
->
osd_d©a_»q
);

1185 
	}
}

1187 
	$d´am_cÚŒŞ_ack_wr™e_video_’code_osd_©Œ_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
osd_©Œibu‹_»gs_group_t
 *
©Œ_group
)

1189 if((
d´am
!=
NULL
è&& (
©Œ_group
!=NULL)){

1190 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1192 
osd_d´am_»q
 = &
©Œ_group
->osd_dpram_req;

1193 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
(d´am, &
osd_d´am_»q
->
d´am_·ge
);

1195 
	}
}

1197 
	$d´am_cÚŒŞ_subm™_»ad_audio_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_audio_driv”_t
 *
audio_driv”
)

1199 if((
d´am
!=
NULL
è&& (
audio_driv”
!=NULL)){

1200 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1201 
»que¡_queue
 = &
d´am
->request_queue;

1202 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
audio_driv”
->
audio_b™¡»am_»q
);

1205 
	}
}

1207 
	$d´am_cÚŒŞ_ack_»ad_audio_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_audio_driv”_t
 *
audio_driv”
)

1209 if((
d´am
!=
NULL
è&& (
audio_driv”
!=NULL)){

1213 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
(d´am, &
audio_driv”
->
d´am_·ge
);

1215 
	}
}

1217 
	$d´am_cÚŒŞ_subm™_wr™e_audio_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_audio_driv”_t
 *
audio_driv”
)

1219 if((
d´am
!=
NULL
è&& (
audio_driv”
!=NULL)){

1220 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1221 
»que¡_queue
 = &
d´am
->request_queue;

1222 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
audio_driv”
->
audio_b™¡»am_»q
);

1224 
	}
}

1226 
	$d´am_cÚŒŞ_ack_wr™e_audio_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_audio_driv”_t
 *
audio_driv”
)

1228 if((
d´am
!=
NULL
è&& (
audio_driv”
!=NULL)){

1232 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
(d´am, &
audio_driv”
->
d´am_·ge
);

1234 
	}
}

1235 
	$d´am_cÚŒŞ_subm™_»ad_mj³g_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

1237 if((
d´am
!=
NULL
è&& (
j³g_logic_chª
!=NULL)){

1238 
d´am_»que¡_queue_t
 *
»que¡_queue
;

1239 
»que¡_queue
 = &
d´am
->request_queue;

1240 
»que¡_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
Ôeque¡_queue, &
j³g_logic_chª
->
»ad_video_b™¡»am_»q
);

1242 
	}
}

1244 
	$d´am_cÚŒŞ_ack_»ad_mj³g_»q
(
d´am_cÚŒŞ_t
 *
d´am
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

1246 if((
d´am
!=
NULL
è&& (
j³g_logic_chª
!=NULL)){

1250 
d´am
->
İ
->
	`nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
(d´am, &
j³g_logic_chª
->
d´am_·ge
);

1253 
	}
}

1255 
d´am_cÚŒŞ_İ”©iÚ
 
	gd´am_cÚŒŞ_İ
 = {

1256 .
š™
 = 
d´am_cÚŒŞ_š™
,

1257 .
	gis_ÿn_subm™_h264_’code_£rviû_»q
 = 
d´am_cÚŒŞ_is_ÿn_subm™_h264_’code_£rviû_»q
,

1258 .
	g»Ëa£_h264_ddr_·ge_»sourû
 = 
d´am_cÚŒŞ_»Ëa£_h264_ddr_·ge_»sourû
,

1259 .
	gis_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
 = 
d´am_cÚŒŞ_is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
,

1260 .
	gnÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
 = 
d´am_cÚŒŞ_nÙify_’d_move_d©a_äom_d´am_to_ddr_£rviû_»q
,

1261 .
	gis_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
 = 
d´am_cÚŒŞ_is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
,

1262 .
	gnÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
 = 
d´am_cÚŒŞ_nÙify_’d_move_d©a_äom_d´am_to_ho¡_£rviû_»q
,

1263 .
	gsubm™_»ad_h264_b™¡»am_»q
 = 
d´am_cÚŒŞ_subm™_»ad_h264_b™¡»am_»q
,

1264 .
	gack_»ad_h264_b™¡»am_»q
 = 
d´am_cÚŒŞ_ack_»ad_h264_b™¡»am_»q
,

1265 .
	gsubm™_wr™e_video_’code_osd_d©a_»q
 = 
d´am_cÚŒŞ_subm™_wr™e_video_’code_osd_»q
,

1266 .
	gack_wr™e_video_’code_osd_d©a_»q
 = 
d´am_cÚŒŞ_ack_wr™e_video_’code_osd_»q
,

1267 .
	gsubm™_wr™e_video_’code_osd_©Œ_»q
 = 
d´am_cÚŒŞ_subm™_wr™e_video_’code_osd_©Œ_»q
,

1268 .
	gack_wr™e_video_’code_osd_©Œ_»q
 = 
d´am_cÚŒŞ_ack_wr™e_video_’code_osd_©Œ_»q
,

1269 .
	gsubm™_»ad_audio_»q
 = 
d´am_cÚŒŞ_subm™_»ad_audio_»q
,

1270 .
	gack_»ad_audio_»q
 = 
d´am_cÚŒŞ_ack_»ad_audio_»q
,

1271 .
	gsubm™_wr™e_audio_»q
 = 
d´am_cÚŒŞ_subm™_wr™e_audio_»q
,

1272 .
	gack_wr™e_audio_»q
 = 
d´am_cÚŒŞ_ack_wr™e_audio_»q
,

1273 .
	gsubm™_»ad_mj³g_»q
 = 
d´am_cÚŒŞ_subm™_»ad_mj³g_»q
,

1274 .
	gack_»ad_mj³g_»q
 = 
d´am_cÚŒŞ_ack_»ad_mj³g_»q
,

1277 
	$š™_d´am_cÚŒŞ
(
d´am_cÚŒŞ_t
 *
d´am
, 
dvm_ch_t
 *
ch
)

1279 if((
d´am
!=
NULL
è&& (
ch
!=NULL)){

1280 
d´am
->
İ
 = &
d´am_cÚŒŞ_İ
;

1281 
d´am
->
İ
->
	`š™
(d´am, 
ch
);

1283 
	}
}

	@../../tw5864/tw5864/dma.c

1 
	~<tw5864/dvm_commÚ.h
>

5 #ifdef 
ARM_PLATFORM


6 
	$DMA_M2M
(
DMA_PARAM
 *
·¿m
, 
chª
, 
tsz
)

8 
tc
, 
dsz
;

9 
DMA_REG
 *
pDMA
;

11 
tc
 = 
·¿m
->
couÁ
;

12 
dsz
 = 
·¿m
->dsz - 1;

13 ià(
tsz
)

14 
tc
 >>= 2;

15 ià(
chª
 == 3)

16 
pDMA
 = (
DMA_REG
 *)(
S3C24XX_VA_DMA
+0xc0);

17 ià(
chª
 == 2)

18 
pDMA
 = (
DMA_REG
 *)(
S3C24XX_VA_DMA
+0x80);

19 ià(
chª
 == 1)

20 
pDMA
 = (
DMA_REG
 *)(
S3C24XX_VA_DMA
+0x40);

22 
pDMA
 = (
DMA_REG
 *)
S3C24XX_VA_DMA
;

23 
pDMA
->
DISRC
 = 
·¿m
->
¤cAddr
;

24 ià(
·¿m
->
ifSrcAddrChªge
)

25 
pDMA
->
DISRCC
 = 0;

27 
pDMA
->
DISRCC
 = 1;

28 
pDMA
->
DIDST
 = 
·¿m
->
de¡Addr
;

29 ià(
·¿m
->
ifDe¡AddrChªge
)

30 
pDMA
->
DIDSTC
 = 0;

32 
pDMA
->
DIDSTC
 = 1;

33 
pDMA
->
DCON
 = (1<<30)|(
tsz
<<28)|(1<<27)|(1<<22)|(
dsz
<<20)|(
tc
);

34 
pDMA
->
DMASKTRIG
 = 3;

35 (
pDMA
->
DSTAT
)&0x00300000);

36 
	}
}

39 
µc_dma_m2m
(
u32
 
¤c
, u32 
de¡
, u32 
Ën
);

40 
	$åga_dma_»ûive
(
u32
 
¤c
, u32 
de¡
, u32 
Ën
)

42 #ifdef 
ARM_PLATFORM


43 
DMA_PARAM
 
·¿m
;

45 
·¿m
.
¤cAddr
 = 
¤c
;

46 
·¿m
.
ifSrcAddrChªge
 = 1;

47 
·¿m
.
de¡Addr
 = 
de¡
;

48 
·¿m
.
ifDe¡AddrChªge
 = 1;

49 
·¿m
.
couÁ
 = (
Ën
+3)>>2;

50 
·¿m
.
dsz
 = 3;

51 
	`DMA_M2M
(&
·¿m
, 2, 0);

53 #ifdef 
POWERPC_PLATFORM


54 
Ën
 += 3;

55 
Ën
 >>= 2;

56 
Ën
 <<= 2;

57 
	`µc_dma_m2m
(
¤c
, 
de¡
, 
Ën
);

59 
	}
}

	@../../tw5864/tw5864/dvm_new_buf.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$tcb_node_š™
(
tcb_node_t
 *
node
)

5 if(
node
 !ğ
NULL
){

6 
	`INIT_LIST_HEAD
(&
node
->
li¡
);

7 
	`©omic_£t
(&
node
->
»f_couÁ
, 0);

8 if(
node
->
İ
 !ğ
NULL
){

9 
node
->
İ
->
	`upd©e_¡©e
Òode, 
TCB_IDLE_STATE
);

12 
	}
}

14 
	$tcb_node_£t_´iv
(
tcb_node_t
 *
node
, *
´iv
)

16 if(
node
 !ğ
NULL
){

17 
node
->
tcb_´iv
 = 
´iv
;

19 
	}
}

21 
	$tcb_node_»ã»nû
(
tcb_node_t
 *
¤c_node
,cb_node_ˆ**
de¡_node
)

23 if((
¤c_node
!=
NULL
è&& (
de¡_node
!=NULL)){

24 
	`©omic_šc
(&
¤c_node
->
»f_couÁ
);

25 *
de¡_node
 = 
¤c_node
;

27 
	}
}

29 
	$tcb_node_»Ëa£
(
tcb_node_t
 *
node
, 
tcb_node_poŞ_t
 *
poŞ
)

31 if((
node
!=
NULL
è&& (
poŞ
!=NULL)){

32 if(
	`©omic_»ad
(&
node
->
»f_couÁ
) > 1){

33 
	`©omic_dec
(&
node
->
»f_couÁ
);

35 
	`©omic_£t
(&
node
->
»f_couÁ
, 0);

36 if(
poŞ
->
İ
 !ğ
NULL
){

37 
poŞ
->
İ
->
	`put
ÕoŞ, 
node
);

39 
	`´štk
("%s.%d:…oŞ->İ i nuÎ\n", 
__FUNCTION__
, 
__LINE__
);

43 
	}
}

45 
	$tcb_node_upd©e_¡©e
(
tcb_node_t
 *
node
, 
¡©e
)

47 if(
node
 !ğ
NULL
){

48 
node
->
¡©e
 = state;

50 
	}
}

52 
tcb_node_İ”©iÚ
 
	gtcb_node_İ
 = {

53 .
š™
 = 
tcb_node_š™
,

54 .
	g£t_´iv
 = 
tcb_node_£t_´iv
,

55 .
	g»ã»nû
 = 
tcb_node_»ã»nû
,

56 .
	g»Ëa£
 = 
tcb_node_»Ëa£
,

57 .
	gupd©e_¡©e
 = 
tcb_node_upd©e_¡©e
,

60 
	$tcb_node_poŞ_š™
(
tcb_node_poŞ_t
 *
poŞ
, 
’Œy_numb”
)

62 if(
poŞ
 !ğ
NULL
){

63 
	`INIT_LIST_HEAD
(&
poŞ
->
poŞ_h—d”
);

64 
	`š™_wa™queue_h—d
(&
poŞ
->
wa™
);

65 
	`¥š_lock_š™
(&
poŞ
->
lock
);

66 
	`©omic_£t
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
, 0);

67 
poŞ
->
poŞ_’Œy_numb”
 = 
’Œy_numb”
;

69 
	}
}

71 
	$tcb_node_poŞ_»Ëa£
(
tcb_node_poŞ_t
 *
poŞ
)

73 if(
poŞ
 !ğ
NULL
){

74 
æags
;

75 
agaš
:

76 
	`¥š_lock_œq§ve
(&
poŞ
->
lock
, 
æags
);

77 if(
poŞ
->
poŞ_’Œy_numb”
 !ğ
	`©omic_»ad
(&poŞ->
cu¼_poŞ_’Œy_numb”
)){

78 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

79 
	`wa™_ev’t
(
poŞ
->
wa™
, (poŞ->
poŞ_’Œy_numb”
 =ğ
	`©omic_»ad
(&poŞ->
cu¼_poŞ_’Œy_numb”
)));

80 
agaš
;

82 
	`INIT_LIST_HEAD
(&
poŞ
->
poŞ_h—d”
);

83 
poŞ
->
poŞ_’Œy_numb”
 = 0;

84 
	`©omic_£t
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
, 0);

85 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

88 
	}
}

90 
	$tcb_node_poŞ_g‘
(
tcb_node_poŞ_t
 *
poŞ
, 
tcb_node_t
 **
node
)

92 if(
poŞ
!=
NULL
 && 
node
!=NULL){

93 
æags
;

94 
agaš
:

95 
	`¥š_lock_œq§ve
(&
poŞ
->
lock
, 
æags
);

96 if(
	`©omic_»ad
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
) > 0){

97 
	`©omic_dec
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
);

98 *
node
 = 
	`li¡_’Œy
(
poŞ
->
poŞ_h—d”
.
Ãxt
, 
tcb_node_t
, 
li¡
);

99 
	`li¡_d–_š™
(&((*
node
)->
li¡
));

100 
	`©omic_šc
(&((*
node
)->
»f_couÁ
));

101 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

103 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

104 
	`wa™_ev’t
(
poŞ
->
wa™
, 
	`©omic_»ad
(&poŞ->
cu¼_poŞ_’Œy_numb”
));

105 
agaš
;

108 
	}
}

110 
	$tcb_node_poŞ_Œy_g‘
(
tcb_node_poŞ_t
 *
poŞ
, 
tcb_node_t
 **
node
)

112 if(
poŞ
!=
NULL
 && 
node
!=NULL){

113 
æags
;

114 
	`¥š_lock_œq§ve
(&
poŞ
->
lock
, 
æags
);

115 if(
	`©omic_»ad
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
) > 0){

116 
	`©omic_dec
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
);

117 *
node
 = 
	`li¡_’Œy
(
poŞ
->
poŞ_h—d”
.
Ãxt
, 
tcb_node_t
, 
li¡
);

118 
	`li¡_d–_š™
(&((*
node
)->
li¡
));

119 
	`©omic_šc
(&((*
node
)->
»f_couÁ
));

121 *
node
 = 
NULL
;

123 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

125 
	}
}

127 
	$tcb_node_poŞ_put
(
tcb_node_poŞ_t
 *
poŞ
, 
tcb_node_t
 *
node
)

129 if(
poŞ
!=
NULL
 && 
node
!=NULL){

130 
æags
;

131 
	`¥š_lock_œq§ve
(&
poŞ
->
lock
, 
æags
);

132 
node
->
İ
->
	`š™
(node);

133 
	`li¡_add_
(&
node
->
li¡
, &
poŞ
->
poŞ_h—d”
);

134 
	`©omic_šc
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
);

135 if(
	`©omic_»ad
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
) == 1){

136 
	`wake_up
(&
poŞ
->
wa™
);

138 
	`¥š_uÆock_œq»¡Üe
(&
poŞ
->
lock
, 
æags
);

140 
	}
}

142 
	$tcb_node_poŞ_g‘_cu¼_poŞ_’Œy_numb”
(
tcb_node_poŞ_t
 *
poŞ
)

144 if(
poŞ
 !ğ
NULL
){

145  
	`©omic_»ad
(&
poŞ
->
cu¼_poŞ_’Œy_numb”
);

149 
	}
}

151 
tcb_poŞ_İ”©iÚ
 
	gtcb_node_poŞ_İ
 = {

152 .
š™
 = 
tcb_node_poŞ_š™
,

153 .
	g»Ëa£
 = 
tcb_node_poŞ_»Ëa£
,

155 .
	gg‘
 = 
tcb_node_poŞ_g‘
,

156 .
	gŒy_g‘
 = 
tcb_node_poŞ_Œy_g‘
,

157 .
	gput
 = 
tcb_node_poŞ_put
,

159 .
	gg‘_cu¼_poŞ_’Œy_numb”
 = 
tcb_node_poŞ_g‘_cu¼_poŞ_’Œy_numb”
,

162 
	$tcb_node_queue_g‘_queue_cu¼_’Œy_numb”
(
tcb_node_queue_t
 *
tcb_queue
)

164 if(
tcb_queue
 !ğ
NULL
){

165  
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

169 
	}
}

171 
	$tcb_node_queue_š™
(
tcb_node_queue_t
 *
tcb_queue
)

173 if(
tcb_queue
 !ğ
NULL
){

174 
	`¥š_lock_š™
(&
tcb_queue
->
lock
);

175 
	`INIT_LIST_HEAD
(&
tcb_queue
->
queue_h—d”
);

176 
	`š™_wa™queue_h—d
(&
tcb_queue
->
wa™
);

177 
	`©omic_£t
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
, 0);

179 
	}
}

181 
	$tcb_node_queue_put
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 *
tcb_node
)

183 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

184 
æags
;

185 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

186 
	`li¡_add_
(&
tcb_node
->
li¡
, &
tcb_queue
->
queue_h—d”
);

187 
	`©omic_šc
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

188 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
) == 1){

189 
	`wake_up
(&
tcb_queue
->
wa™
);

191 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

193 
	}
}

195 
	$tcb_node_queue_put_h—d”
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 *
tcb_node
)

197 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

198 
æags
;

199 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

200 
	`li¡_add
(&
tcb_node
->
li¡
, &
tcb_queue
->
queue_h—d”
);

201 
	`©omic_šc
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

202 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
) == 1){

203 
	`wake_up
(&
tcb_queue
->
wa™
);

205 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

207 
	}
}

209 
	$tcb_node_queue_g‘
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 **
tcb_node
)

211 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

212 
æags
;

213 
agaš
:

214 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

215 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
)){

216 
	`©omic_dec
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

217 *
tcb_node
 = 
	`li¡_’Œy
(
tcb_queue
->
queue_h—d”
.
Ãxt
, 
tcb_node_t
, 
li¡
);

218 
	`li¡_d–_š™
(&(*
tcb_node
)->
li¡
);

219 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

221 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

222 
	`wa™_ev’t
(
tcb_queue
->
wa™
, 
	`©omic_»ad
(&tcb_queue->
cu¼_queue_’Œy_numb”
));

223 
agaš
;

226 
	`´štk
("\n%s.%d**©‹ÁiÚ**\n", 
__FUNCTION__
, 
__LINE__
);

228 
	}
}

230 
	$tcb_node_queue_g‘_”
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 **
tcb_node
)

232 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

233 
æags
;

234 
agaš
:

235 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

236 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
)){

237 
	`©omic_dec
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

238 *
tcb_node
 = 
	`li¡_’Œy
(
tcb_queue
->
queue_h—d”
.
´ev
, 
tcb_node_t
, 
li¡
);

239 
	`li¡_d–_š™
(&(*
tcb_node
)->
li¡
);

240 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

242 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

243 
	`wa™_ev’t
(
tcb_queue
->
wa™
, 
	`©omic_»ad
(&tcb_queue->
cu¼_queue_’Œy_numb”
));

244 
agaš
;

247 
	}
}

249 
	$tcb_node_queue_Œy_g‘
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 **
tcb_node
)

251 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

252 
æags
;

253 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

254 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
)){

255 
	`©omic_dec
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

256 *
tcb_node
 = 
	`li¡_’Œy
(
tcb_queue
->
queue_h—d”
.
Ãxt
, 
tcb_node_t
, 
li¡
);

257 
	`li¡_d–_š™
(&(*
tcb_node
)->
li¡
);

259 *
tcb_node
 = 
NULL
;

261 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

263 
	}
}

265 
	$tcb_node_queue_Œy_g‘_”
(
tcb_node_queue_t
 *
tcb_queue
, 
tcb_node_t
 **
tcb_node
)

267 if((
tcb_queue
!=
NULL
è&& (
tcb_node
!=NULL)){

268 
æags
;

269 
	`¥š_lock_œq§ve
(&
tcb_queue
->
lock
, 
æags
);

270 if(
	`©omic_»ad
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
)){

271 
	`©omic_dec
(&
tcb_queue
->
cu¼_queue_’Œy_numb”
);

272 *
tcb_node
 = 
	`li¡_’Œy
(
tcb_queue
->
queue_h—d”
.
´ev
, 
tcb_node_t
, 
li¡
);

273 
	`li¡_d–_š™
(&(*
tcb_node
)->
li¡
);

275 *
tcb_node
 = 
NULL
;

277 
	`¥š_uÆock_œq»¡Üe
(&
tcb_queue
->
lock
, 
æags
);

279 
	}
}

281 
tcb_node_queue_İ”©iÚ
 
	gtcb_node_queue_İ
 = {

282 .
g‘_queue_cu¼_’Œy_numb”
 = 
tcb_node_queue_g‘_queue_cu¼_’Œy_numb”
,

284 .
	gš™
 = 
tcb_node_queue_š™
,

285 .
	gput
 = 
tcb_node_queue_put
,

286 .
	gput_h—d”
 = 
tcb_node_queue_put_h—d”
,

287 .
	gg‘
 = 
tcb_node_queue_g‘
,

288 .
	gg‘_”
 = 
tcb_node_queue_g‘_”
,

289 .
	gŒy_g‘
 = 
tcb_node_queue_Œy_g‘
,

290 .
	gŒy_g‘_”
 = 
tcb_node_queue_Œy_g‘_”
,

	@../../tw5864/tw5864/dvm_rc.c

1 
	~<tw5864/dvm_commÚ.h
>

5 
	gRC_DEFAULT_NONTEXTURE_BITS
[12] =

23 
	grqp_bË
[
QP_LOOKUP_TABLE_STEP
]=

40 
cbr_upd©e_¿‹_cÚŒŞ
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
);

41 
cbr_upd©e_rho_·¿m‘”s
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
);

42 
cbr_e¡im©e_b™_budg‘
(
boŞ—n
 
štŸlizeB™Budg‘FÏg
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
, 
tw_h264_logic_’code_chª_t
 *
’cod”
);

43 
cbr_ÿlcuÏ‹_quªt_·¿m‘”
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
);

44 
tw_rc_driv”_İ
 
	gcbr_driv”_İ
;

45 
tw_rc_driv”_İ
 
	gvbr_driv”_İ
;

46 
tw_rc_driv”_İ
 
	grc_driv”_İ
;

48 
	$dvm_cbr_rc_š™
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

50 
tw_cbr_rc_·¿m_t
 *
rc_šfo
;

51 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

52 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

53 
i
, 
num_mbs
;

54 
rg‘_b™¿‹
, 
rg‘_ås
, 
rg‘_key_äame_š‹rv®s
;

56 
rc_šfo
 = &
’cod”
->
rc_driv”
.
cbr
.
rc_·¿m
;

57 
’code_´İ”ty
 = &
’cod”
->encode_property;

58 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

59 
rg‘_b™¿‹
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_b™¿‹
(encode_property);

60 
rg‘_ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

61 
rg‘_key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

62 
rc_šfo
->
b_æag_upd©e
 = 0;

63 
num_mbs
 = 
’code_cÚŒŞ
->
i_mb_x
*’code_cÚŒŞ->
i_mb_y
;

65 
rc_šfo
->
A
 = 
RC_RHO_BITRATE_A
;

66 
rc_šfo
->
nz_couÁ
 = 0;

67 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 = 
num_mbs
*
RC_DEFAULT_NONTEXTURE_BITS
[
rg‘_b™¿‹
/100000 > 10 ? 0: 11-target_bitrate/100000];

68 
rc_šfo
->
š™_rc_wšdow
 =„c_šfo->
rc_wšdow
 = 
	`H264_MEDIAN
(
SMOOTH_WINDOW_MIN_SIZE
, 
SMOOTH_WINDOW_MAX_SIZE
, 
rg‘_key_äame_š‹rv®s
);

71 
i
=
QUANT_SCALE_MIN
; i<(
QUANT_SCALE_MAX
+1); i++ ){

72 
rc_šfo
->
rho_qp_bË
[
i
]=(
rqp_bË
[i]*
num_mbs
)<<1;

73 #ifdeà 
RC_DEBUG


74 
	`´štk
("%d:„c_šfo->rho_qp_bË[%d]=%d\n", 
__LINE__
, 
i
, 
rc_šfo
->
rho_qp_bË
[i]);

79 
rc_šfo
->
b™s_³r_äame
 = (
rg‘_b™¿‹
 + (
rg‘_ås
>>1)) /arget_fps;

80 
rc_šfo
->
tÙ®_b™_d–
 = 0;

83 
rc_šfo
->
mš_äame_b™_budg‘
 = 
rg‘_b™¿‹
/
RC_MIN_BIT_BUDGET_CONST
;

84 
rc_šfo
->
max_äame_b™_budg‘
 = (rc_šfo->
b™s_³r_äame
*5)>>2;

85 
rc_šfo
->
´ev_nÜm_äame_b™s_u£d
 =0;

87 
rc_šfo
->
rho
 = 0;

88 
rc_šfo
->
b™s_u£d_äame
 = 0;

89 
rc_šfo
->
´ev_b™_budg‘
 = 0;

90 
rc_šfo
->
´ev_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

92 
rc_šfo
->
¿tio
 = 1024;

93 
rc_šfo
->
tÙ®_¿tio
 = 1024;

94 
rc_šfo
->
fœ¡_äame_qp
 = 0;

95 
rc_šfo
->
fœ¡_10_max_qp
 = 0;

96 
rc_šfo
->
fœ¡_10_mš_qp
 = 60;

97 #ifdeà 
RC_DEBUG


98 
	`´štk
("bps=%d, fps=%d,‚umb_mb=%d, min_budget=%d, max_budget=%d, bit_per_frame=%d\n",

99 
rg‘_b™¿‹
,

100 
rg‘_ås
,

101 
num_mbs
,

102 
rc_šfo
->
mš_äame_b™_budg‘
,

103 
rc_šfo
->
max_äame_b™_budg‘
,

104 
rc_šfo
->
b™s_³r_äame
);

106 
	}
}

108 
	$dvm264_cbr_upd©e_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_video_äame_tcb_t
 *
video_äame
)

110 
tw_cbr_rc_·¿m_t
 *
rc_šfo
;

111 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

113 
rc_šfo
 = &
’cod”
->
rc_driv”
.
cbr
.
rc_·¿m
;

114 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

115 if((
rc_šfo
->
nz_couÁ
==0) &&

116 (
’code_cÚŒŞ
->
äame_ty³
!=
H264_FRAME_TYPE_I
) &&

117 (
’code_cÚŒŞ
->
äame_ty³
!=
H264_FRAME_TYPE_IDR
)) {

118 
rc_šfo
->
b™s_u£d_äame
 = 0;

119 
rc_šfo
->
´ev_qp
 = 
’code_cÚŒŞ
->
i_cu¼_qp
;

120 
rc_šfo
->
´ev_b™_budg‘
 =„c_šfo->
nÜm_äame_b™_budg‘
;

122 
	`cbr_upd©e_¿‹_cÚŒŞ
(
’cod”
, 
rc_šfo
);

124 #ifdeà 
RC_DEBUG


125 
	`´štk
("qp=%d,…rev_qp=%d,…rev_bit_budget=%d,‚orm_frame_bit_budget=%d,otal_bits_delta=%d\n",

126 
’code_cÚŒŞ
->
i_cu¼_qp
,

127 
rc_šfo
->
´ev_qp
,

128 
rc_šfo
->
´ev_b™_budg‘
,

129 
rc_šfo
->
nÜm_äame_b™_budg‘
,

130 
rc_šfo
->
tÙ®_b™_d–
);

132 
	}
}

134 
	$cbr_upd©e_¿‹_cÚŒŞ
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
)

136 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

137 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

138 
key_äame_š‹rv®s
;

140 
’code_´İ”ty
 = &
’cod”
->encode_property;

141 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

142 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

145 
rc_šfo
->
´ev_nÜm_äame_b™s_u£d
 =„c_šfo->
b™s_u£d_äame
;

148 if(
’code_cÚŒŞ
->
i_äame_£rŸl
) {

149 
rc_šfo
->
tÙ®_b™_d–
 -ğÔc_šfo->
b™s_³r_äame
-rc_šfo->
b™s_u£d_äame
);

151 if(
rc_šfo
->
tÙ®_b™_d–
 < (-rc_šfo->
max_äame_b™_budg‘
)){

152 
rc_šfo
->
tÙ®_b™_d–
 = -rc_šfo->
max_äame_b™_budg‘
;

156 if((
’code_cÚŒŞ
->
äame_ty³
==
H264_FRAME_TYPE_I
è|| (’code_cÚŒŞ->äame_ty³==
H264_FRAME_TYPE_IDR
)){

157 
rc_šfo
->
nz_couÁ
 = 0;

158 
rc_šfo
->
¿tio
 = 1024;

160 
u32
 
i
;

161 
rc_šfo
->
¿tio
ğ(Ôc_šfo->
rho_qp_bË
[„c_šfo->
´ev_qp
]/„c_šfo->
tÙ®_¿tio
)<<10)/„c_šfo->
nz_couÁ
;

162 
rc_šfo
->
¿tio
 = (rc_info->ratio - 1024)>>1;

163 
rc_šfo
->
¿tio
 =rc_info->ratio+1024;

164 
i
 = 
rc_šfo
->
tÙ®_¿tio
 *rc_šfo->
¿tio
;

165 
i
 = i>>10;

166 
rc_šfo
->
tÙ®_¿tio
 = 
i
;

169 
	`cbr_upd©e_rho_·¿m‘”s
(
’cod”
, 
rc_šfo
);

171 
rc_šfo
->
b™s_u£d_äame
=0;

172 
rc_šfo
->
´ev_qp
 = 
’code_cÚŒŞ
->
i_cu¼_qp
;

173 
rc_šfo
->
´ev_b™_budg‘
 =„c_šfo->
nÜm_äame_b™_budg‘
;

174 
	}
}

176 
	$cbr_upd©e_rho_·¿m‘”s
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
)

178 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

179 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

180 
rc_šfo
->
nÜm_äame_b™_budg‘
 = 
	`cbr_e¡im©e_b™_budg‘
(0,„c_šfo, 
’cod”
);

181 
’code_cÚŒŞ
->
i_cu¼_qp
 = 
	`cbr_ÿlcuÏ‹_quªt_·¿m‘”
(
’cod”
, 
rc_šfo
);

182 
	}
}

184 
	$cbr_e¡im©e_b™_budg‘
(
boŞ—n
 
štŸlizeB™Budg‘FÏg
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
, 
tw_h264_logic_’code_chª_t
 *
’cod”
)

186 
cu¼’t_b™_budg‘
;

188 
cu¼’t_b™_budg‘
 = ((
rc_šfo
->
b™s_³r_äame
*rc_šfo->
rc_wšdow
è-rc_šfo->
tÙ®_b™_d–
)/rc_info->rc_window;

189  
	`H264_MEDIAN
(
rc_šfo
->
mš_äame_b™_budg‘
,„c_šfo->
max_äame_b™_budg‘
, 
cu¼’t_b™_budg‘
);

190 
	}
}

192 
	$cbr_ÿlcuÏ‹_quªt_·¿m‘”
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_cbr_rc_·¿m_t
 *
rc_šfo
)

194 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

195 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

196 
key_äame_š‹rv®s
;

197 *
±r_cbr_dqp
, 
dqp
[
QP_LOOKUP_TABLE_STEP
];

198 
qp
, 
i
, 
max_qp_adju¡_down
, 
max_qp_adju¡_up
, 
´ev_qp
, 
cu¼’t_b™_budg‘
;

200 
’code_´İ”ty
 = &
’cod”
->encode_property;

201 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

202 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

203 
±r_cbr_dqp
 = 
dqp
;

205 
cu¼’t_b™_budg‘
 = 
rc_šfo
->
nÜm_äame_b™_budg‘
;

206 
qp
 = 
´ev_qp
 = 
rc_šfo
->prev_qp;

208 if(
rc_šfo
->
nz_couÁ
){

209 
rc_šfo
->
A
 = (Ôc_šfo->
´ev_nÜm_äame_b™s_u£d
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
)<<8)/rc_šfo->
nz_couÁ
;

212 if((
’code_cÚŒŞ
->
äame_ty³
!=
H264_FRAME_TYPE_I
è&& (’code_cÚŒŞ->äame_ty³!=
H264_FRAME_TYPE_IDR
)) {

213 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 =Ôc_šfo->b™s_fÜ_nÚ‹xt_e¡ *(1024+((((
cu¼’t_b™_budg‘
<<10)/rc_šfo->
´ev_nÜm_äame_b™s_u£d
 -1024)*308)>>10)))>>10;

215 
rc_šfo
->
rho
 = ((
cu¼’t_b™_budg‘
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
)<< 8)/rc_šfo->
A
;

216 if((
’code_cÚŒŞ
->
äame_ty³
==
H264_FRAME_TYPE_I
è|| (’code_cÚŒŞ->äame_ty³==
H264_FRAME_TYPE_IDR
)) {

217 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 < 
key_äame_š‹rv®s
){

218 
rc_šfo
->
rho
 = ((
cu¼’t_b™_budg‘
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
è<< 7è/„c_šfo->
A
;

220 ifĞ((
rc_šfo
->
fœ¡_10_max_qp
 -„c_šfo->
fœ¡_10_mš_qp
)<<10è/rc_šfo->
fœ¡_äame_qp
> 
HIGH_TEXT_PERCENT
){

221 
rc_šfo
->
rho
 = ((
cu¼’t_b™_budg‘
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
è* (1024+ (rc_šfo->
tÙ®_¿tio
-1024)*7/8è/rc_šfo->
A
)>>3 ;

223 
rc_šfo
->
rho
 = ((
cu¼’t_b™_budg‘
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
è* (1024+„c_šfo->
tÙ®_¿tio
è/rc_šfo->
A
 )>>4;

225 
rc_šfo
->
tÙ®_¿tio
 = 1024;

229 ifĞ
rc_šfo
->
rho
 >=0 ) {

230 
i
=
QUANT_SCALE_MIN
; i<(
QUANT_SCALE_MAX_ADD1
); i++ ) {

231 
±r_cbr_dqp
[
i
] = 
rc_šfo
->
rho_qp_bË
[i]/rc_šfo->
tÙ®_¿tio
 -rc_šfo->
rho
;

232 if(
±r_cbr_dqp
[
i
] < 0) {

236 
qp
ğ
i
-1;

237 if(
	`ABS
(
±r_cbr_dqp
[
i
]) <…tr_cbr_dqp[i-1]) {

238 
qp
 =
i
;

241 
qp
 = 
QUANT_SCALE_MAX
;

244 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 == 0){

245 
rc_šfo
->
fœ¡_äame_qp
 = 
qp
;

246  
qp
;

249 if(
rc_šfo
->
tÙ®_b™_d–
>rc_šfo->
b™s_³r_äame
*3){

250 
qp
 += 1;

253 
max_qp_adju¡_down
 = (
´ev_qp
*
QUANT_SCALE_MAX
)>>10;

254 if(
max_qp_adju¡_down
 == 0){

255 
max_qp_adju¡_down
=1;

257 
max_qp_adju¡_up
 = (
´ev_qp
*
QUANT_SCALE_MAX
)>>9;

258 if(
max_qp_adju¡_up
 > 10){

259 
max_qp_adju¡_up
=10;

262 if(
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
){

263 if(((
qp
-
´ev_qp
)<<9 ) > (qp*
QUANT_SCALE_MAX
)){

264 
qp
 = 
´ev_qp
+
max_qp_adju¡_up
;

265 } ià(((
qp
-
´ev_qp
)<<10è< -Õ»v_qp*
QUANT_SCALE_MAX
)){

266 
qp
 = 
´ev_qp
-
max_qp_adju¡_down
;

270 if(
´ev_qp
-
qp
 > 2){

271 
qp
 = 
´ev_qp
-2;

272 } if(
´ev_qp
-
qp
 < -2){

273 
qp
 = 
´ev_qp
+2;

275 
qp
 = 
	`H264_MEDIAN
(
QUANT_SCALE_MIN
, 
QUANT_SCALE_MAX
, qp);

277 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 <= 10) {

278 if(
qp
<
rc_šfo
->
fœ¡_10_mš_qp
){

279 
rc_šfo
->
fœ¡_10_mš_qp
 = 
qp
;

281 if(
qp
>
rc_šfo
->
fœ¡_10_max_qp
){

282 
rc_šfo
->
fœ¡_10_max_qp
 = 
qp
;

286 (
qp
);

287 
	}
}

289 
	$dvm264_cbr_upd©e_rc_·¿
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

291 
tw_cbr_rc_·¿m_t
 *
rc_šfo
;

292 
dvm_ch_t
 *
ch
;

293 
u32
 
b™s_u£d_äame
;

294 
u32
 
nÚ_z”o_couÁ
;

295 
u32
 
b™s_fÜ_nÚ‹xt_e¡
;

296 
u32
 
»sidu®_b™s_u£d_äame
;

298 
rc_šfo
 = &
’cod”
->
rc_driv”
.
cbr
.
rc_·¿m
;

299 
ch
 = 
’cod”
->chip;

300 
b™s_u£d_äame
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SLICE_TOTAL_BIT_NUMBER
);

301 
nÚ_z”o_couÁ
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_COEFF_NUMBER
);

302 
»sidu®_b™s_u£d_äame
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
RES_TOTAL_BIT_NUMBER
);

303 
b™s_fÜ_nÚ‹xt_e¡
 = 
b™s_u£d_äame
 - 
»sidu®_b™s_u£d_äame
;

304 
rc_šfo
->
b_æag_upd©e
 = 0;

305 
rc_šfo
->
b™s_u£d_äame
 = bits_used_frame;

306 
rc_šfo
->
nz_couÁ
 = 
nÚ_z”o_couÁ
;

307 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 = bits_for_nontext_est;

308 #ifdeà 
RC_DEBUG


309 
	`´štk
("bits_used_frame = %d,‚on_zero_count = %d, bits_for_nontext_est = %d\n\n",

310 
rc_šfo
->
b™s_u£d_äame
,

311 
rc_šfo
->
nz_couÁ
,

312 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
);

314 
	}
}

316 
	$dvm264_cbr_jump_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

318 
’cod”
->
rc_driv”
.
cbr
.
rc_·¿m
.
b_æag_upd©e
 = 1;

319 #ifdeà 
RC_DEBUG


320 
	`´štk
("%s.%d: chª_%d_%d\n", 
__FUNCTION__
, 
__LINE__
, 
’cod”
->
phy_¦Ù_id
,ƒncod”->
logic_chª_id
);

322 
	}
}

324 
tw_rc_driv”_İ
 
	gcbr_driv”_İ
 =

326 .
š™_rc
 = 
dvm_cbr_rc_š™
,

327 .
	g£t_qp
 = 
dvm264_cbr_upd©e_rc
,

328 .
	gupd©e_rc
 = 
dvm264_cbr_upd©e_rc_·¿
,

329 .
	gjump_rc
 = 
dvm264_cbr_jump_rc
,

332 
	$dvm_vbr_rc_š™
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

334 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
;

335 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

336 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

337 
šdex
, 
i
, 
num_mbs
;

338 
rg‘_b™¿‹
, 
rg‘_ås
, 
rg‘_i_p_¡ride
;

340 
rc_šfo
 = &
’cod”
->
rc_driv”
.
vbr
.
rc_·¿m
;

341 
’code_´İ”ty
 = &
’cod”
->encode_property;

342 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

343 
rg‘_b™¿‹
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_b™¿‹
(encode_property);

344 
rg‘_ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

345 
rg‘_i_p_¡ride
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

347 
rc_šfo
->
b_æag_upd©e
 = 0;

348 
num_mbs
 = 
’code_cÚŒŞ
->
i_mb_x
*’code_cÚŒŞ->
i_mb_y
;

349 
rc_šfo
->
A
 = 
RC_RHO_BITRATE_A
;

350 
rc_šfo
->
nz_couÁ
 = 0;

351 
šdex
 = 
rg‘_b™¿‹
/100000;

352 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 = 
num_mbs
*
RC_DEFAULT_NONTEXTURE_BITS
[
šdex
 > 10 ? 0 : (11-index)];

353 
rc_šfo
->
š™_rc_wšdow
 =„c_šfo->
rc_wšdow
 = 
	`H264_MEDIAN
(
SMOOTH_WINDOW_MIN_SIZE
, 
SMOOTH_WINDOW_MAX_SIZE
, 
rg‘_i_p_¡ride
);

356 
i
=
QUANT_SCALE_MIN
; i<(
QUANT_SCALE_MAX
+1); i++ )

357 
rc_šfo
->
rho_qp_bË
[
i
]=(
rqp_bË
[i]*
num_mbs
)<<1;

360 
rc_šfo
->
b™s_³r_äame
 = (
rg‘_b™¿‹
 + (
rg‘_ås
>>1) ) /arget_fps;

361 
rc_šfo
->
b™s_pF¿me
 =„c_šfo->
b™s_³r_äame
;

362 
rc_šfo
->
tÙ®_b™_d–
 = 0;

365 
rc_šfo
->
mš_äame_b™_budg‘
 = 
rg‘_b™¿‹
/
RC_MIN_BIT_BUDGET_CONST
;

366 
rc_šfo
->
max_äame_b™_budg‘
 = (rc_šfo->
b™s_³r_äame
*5)>>2;

367 
rc_šfo
->
´ev_nÜm_äame_b™s_u£d
 =0;

368 
rc_šfo
->
rho
 = 0;

369 
rc_šfo
->
b™s_u£d_äame
 = 0;

370 
rc_šfo
->
´ev_b™_budg‘
 = 0;

371 
rc_šfo
->
´ev_two_qp
 =„c_šfo->
´ev_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

373 
rc_šfo
->
¿tio
 = 1024;

374 
rc_šfo
->
tÙ®_¿tio
 = 1024;

375 
rc_šfo
->
fœ¡_äame_qp
 = 0;

376 
rc_šfo
->
fœ¡_10_max_qp
 = 0;

377 
rc_šfo
->
fœ¡_10_mš_qp
 = 
QUANT_SCALE_MAX
;

379 
rc_šfo
->
Ëak_bufãr
 = 0;

380 
rc_šfo
->
´e_sknum
 = 0;

381 if(
rg‘_b™¿‹
<=250000){

382 
rc_šfo
->
bufãr_th»shŞd
 = (rc_šfo->
b™s_³r_äame
<<1);

383 
rc_šfo
->
rg‘_š™_qp
 = 40;

384 } if(
rg‘_b™¿‹
<=500000){

385 
rc_šfo
->
bufãr_th»shŞd
 = (rc_šfo->
b™s_³r_äame
<<1);

386 
rc_šfo
->
rg‘_š™_qp
 = 36;

387 } if(
rg‘_b™¿‹
<=1000000){

388 
rc_šfo
->
bufãr_th»shŞd
 = (rc_šfo->
b™s_³r_äame
<<2);

389 
rc_šfo
->
rg‘_š™_qp
 = 32;

390 } if(
rg‘_b™¿‹
<=2000000){

391 
rc_šfo
->
bufãr_th»shŞd
 = (rc_šfo->
b™s_³r_äame
<<3);

392 
rc_šfo
->
rg‘_š™_qp
 = 26;

394 
rc_šfo
->
bufãr_th»shŞd
 = (rc_šfo->
b™s_³r_äame
<<4);

395 
rc_šfo
->
rg‘_š™_qp
 = 20;

397 #ifdeà 
RC_DEBUG


398 
	`´štk
("%s.%d: chª_%d_%d\n", 
__FUNCTION__
, 
__LINE__
, 
’cod”
->
phy_¦Ù_id
,ƒncod”->
logic_chª_id
);

400 
	}
}

402 
	$vbr_e¡im©e_b™_budg‘
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
)

404 
cu¼’t_b™_budg‘
;

406 
cu¼’t_b™_budg‘
 = 
rc_šfo
->
b™s_pF¿me
 -„c_šfo->
tÙ®_b™_d–
/rc_šfo->
rc_wšdow
;

407 
rc_šfo
->
rc_wšdow
--;

408 if(
rc_šfo
->
rc_wšdow
==0){

409 
rc_šfo
->
rc_wšdow
 =„c_šfo->
š™_rc_wšdow
;

411  
	`H264_MEDIAN
(
rc_šfo
->
mš_äame_b™_budg‘
,„c_šfo->
max_äame_b™_budg‘
, 
cu¼’t_b™_budg‘
);

412 
	}
}

414 
	$vbr_ÿlcuÏ‹_quªt_·¿m‘”
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
)

416 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

417 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

418 
key_äame_š‹rv®s
;

419 *
±r_cbr_dqp
, 
dqp
[
QP_LOOKUP_TABLE_STEP
];

420 
qp
, 
i
, 
max_qp_adju¡_down
, 
max_qp_adju¡_up
, 
´ev_qp
, 
cu¼’t_b™_budg‘
;

421 
Şd_A
;

423 
’code_´İ”ty
 = &
’cod”
->encode_property;

424 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

425 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

426 
cu¼’t_b™_budg‘
 = 
rc_šfo
->
nÜm_äame_b™_budg‘
;

427 
qp
 = 
´ev_qp
 = 
rc_šfo
->prev_qp;

428 
±r_cbr_dqp
 = 
dqp
;

430 
Şd_A
 = 
rc_šfo
->
A
;

431 if(
rc_šfo
->
nz_couÁ
){

432 
rc_šfo
->
A
 = (Ôc_šfo->
´ev_nÜm_äame_b™s_u£d
 -„c_šfo->
b™s_fÜ_nÚ‹xt_e¡
)<<8)/rc_šfo->
nz_couÁ
;

433 if(
rc_šfo
->
A
==0){

434 
rc_šfo
->
A
 = 
Şd_A
;

437 if(
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
) {

438 ià(
rc_šfo
->
´ev_nÜm_äame_b™s_u£d
 != 0) {

439 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 = (rc_šfo->b™s_fÜ_nÚ‹xt_e¡*(1024+((((
cu¼’t_b™_budg‘
<<10)/rc_šfo->
´ev_nÜm_äame_b™s_u£d
 -1024)*308)>>10)))>>10;

440 
cu¼’t_b™_budg‘
 -ğ
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
;

441 
cu¼’t_b™_budg‘
 <<= 8;

442 
rc_šfo
->
rho
 = 
cu¼’t_b™_budg‘
/rc_šfo->
A
;

445 
cu¼’t_b™_budg‘
 -ğ
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
;

446 if((
’code_cÚŒŞ
->
i_äame_£rŸl
 < 
key_äame_š‹rv®s
) || (key_frame_intervals <= 1)) {

447 
rc_šfo
->
rho
 = (
cu¼’t_b™_budg‘
<<7)/rc_šfo->
A
;

449 ifĞ((
rc_šfo
->
fœ¡_10_max_qp
 -„c_šfo->
fœ¡_10_mš_qp
)<<10)/rc_šfo->
fœ¡_äame_qp
 > 
HIGH_TEXT_PERCENT
) {

450 
rc_šfo
->
rho
 = (
cu¼’t_b™_budg‘
 * (1024+(Ôc_šfo->
tÙ®_¿tio
-1024)*7>>3)è/„c_šfo->
A
)>>3 ;

452 
rc_šfo
->
rho
 = (
cu¼’t_b™_budg‘
*(1024+rc_šfo->
tÙ®_¿tio
)/rc_šfo->
A
)>>4;

455 
rc_šfo
->
tÙ®_¿tio
 = 1024;

458 ifĞ
rc_šfo
->
rho
 >=0 ) {

459 
i
=
QUANT_SCALE_MIN
; i<(
QUANT_SCALE_MAX_ADD1
); i++ ) {

460 
±r_cbr_dqp
[
i
] = 
rc_šfo
->
rho_qp_bË
[i]/rc_šfo->
tÙ®_¿tio
 -rc_šfo->
rho
;

461 if(
±r_cbr_dqp
[
i
] < 0) {

465 
qp
ğ
i
-1;

466 if(
	`ABS
(
±r_cbr_dqp
[
i
]) <…tr_cbr_dqp[i-1]) {

467 
qp
 =
i
;

470 
qp
 = 
QUANT_SCALE_MAX
;

473 
max_qp_adju¡_down
 = (
´ev_qp
*
QUANT_SCALE_MAX
)>>10;

474 if(
max_qp_adju¡_down
 == 0){

475 
max_qp_adju¡_down
=1;

477 
max_qp_adju¡_up
 = (
´ev_qp
*
QUANT_SCALE_MAX
)>>9;

478 if(
max_qp_adju¡_up
 > 10){

479 
max_qp_adju¡_up
=10;

481 if(
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
){

482 if(((
qp
-
´ev_qp
)<<9 ) > (qp*
QUANT_SCALE_MAX
))

483 
qp
 = 
´ev_qp
+
max_qp_adju¡_up
;

484 ià(((
qp
-
´ev_qp
)<<10è< -Õ»v_qp*
QUANT_SCALE_MAX
))

485 
qp
 = 
´ev_qp
-
max_qp_adju¡_down
;

487 if((
key_äame_š‹rv®s
>2è&& (
’code_cÚŒŞ
->
i_äame_£rŸl
)){

488 
qp
 = 
rc_šfo
->
´ev_two_qp
;

491 if(
qp
 > 
´ev_qp
) {

492 if((
qp
-
´ev_qp
) > 2) {

493 
qp
 = 
´ev_qp
 + 2;

496 if((
´ev_qp
-
qp
) > 2) {

497 
qp
 = 
´ev_qp
 - 2;

500 
qp
 = 
	`H264_MEDIAN
(
QUANT_SCALE_MIN
, 
QUANT_SCALE_MAX
, qp);

502 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 == 0)

503 
rc_šfo
->
fœ¡_äame_qp
 = 
qp
;

504 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 <= 10) {

505 if(
qp
<
rc_šfo
->
fœ¡_10_mš_qp
){

506 
rc_šfo
->
fœ¡_10_mš_qp
 = 
qp
;

508 if(
qp
>
rc_šfo
->
fœ¡_10_max_qp
){

509 
rc_šfo
->
fœ¡_10_max_qp
 = 
qp
;

513 (
qp
);

514 
	}
}

516 
	$vbr_upd©e_rho_·¿m‘”s
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
)

518 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

519 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

521 
rc_šfo
->
nÜm_äame_b™_budg‘
 = 
	`vbr_e¡im©e_b™_budg‘
(
’cod”
,„c_info);

522 
’code_cÚŒŞ
->
i_cu¼_qp
 = 
	`vbr_ÿlcuÏ‹_quªt_·¿m‘”
(
’cod”
, 
rc_šfo
);

523 
	}
}

525 
	$vbr_upd©e_¿‹_cÚŒŞ
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
)

527 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

528 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

529 
key_äame_š‹rv®s
;

531 
’code_´İ”ty
 = &
’cod”
->encode_property;

532 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

533 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

534 
rc_šfo
->
´ev_nÜm_äame_b™s_u£d
 =„c_šfo->
b™s_u£d_äame
;

536 if(
’code_cÚŒŞ
->
i_äame_£rŸl
) {

537 
rc_šfo
->
tÙ®_b™_d–
 -ğÔc_šfo->
b™s_pF¿me
-rc_šfo->
b™s_u£d_äame
);

540 if(
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
) {

541 
rc_šfo
->
¿tio
ğ(Ôc_šfo->
rho_qp_bË
[„c_šfo->
´ev_qp
]/rc_šfo->
tÙ®_¿tio
)<<10)/rc_šfo->
nz_couÁ
;

542 
rc_šfo
->
¿tio
 = (rc_info->ratio>>1) + 512;

543 
rc_šfo
->
tÙ®_¿tio
 = (rc_šfo->tÙ®_¿tio*rc_šfo->
¿tio
)>>10;

545 if(
key_äame_š‹rv®s
 > 1){

546 
rc_šfo
->
nz_couÁ
 = 0;

548 
rc_šfo
->
¿tio
 = 1024;

550 
	`vbr_upd©e_rho_·¿m‘”s
(
’cod”
, 
rc_šfo
);

551 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 > 2)

552 
rc_šfo
->
´ev_two_qp
 =„c_šfo->
´ev_qp
;

553 
rc_šfo
->
b™s_u£d_äame
=0;

554 
rc_šfo
->
´ev_b™_budg‘
 =„c_šfo->
nÜm_äame_b™_budg‘
;

555 
	}
}

558 
	$dvm264_vbr_upd©e_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_video_äame_tcb_t
 *
video_äame
)

560 
tw_rc_driv”_t
 *
rc_driv”
;

561 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
;

562 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

563 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

564 
key_äame_š‹rv®s
;

566 
rc_driv”
 = &
’cod”
->rc_driver;

567 
rc_šfo
 = &
rc_driv”
->
vbr
.
rc_·¿m
;

568 
’code_´İ”ty
 = &
’cod”
->encode_property;

569 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

570 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

571 if(
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
){

574 
rc_šfo
->
´ev_qp
 = 
’code_cÚŒŞ
->
i_cu¼_qp
;

575 if((
rc_šfo
->
nz_couÁ
==0è&& (
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
)) {

576 
rc_šfo
->
b™s_u£d_äame
 = 0;

577 
rc_šfo
->
´ev_b™_budg‘
 =„c_šfo->
nÜm_äame_b™_budg‘
;

579 if(
rc_šfo
->
b_æag_upd©e
 == 0) {

580 
	`vbr_upd©e_¿‹_cÚŒŞ
(
’cod”
, 
rc_šfo
);

583 if(
rc_driv”
->
is_rc_image_Ëv–_´iÜ™y
){

584 
difãrQp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
Óncode_´İ”tyè- 
’code_cÚŒŞ
->
i_cu¼_qp
;

585 if(
difãrQp
<0){

586 if((
’code_cÚŒŞ
->
i_äame_£rŸl
-
rc_šfo
->
´e_sknum
)>1){

587 
rc_šfo
->
´e_sknum
 = 
’code_cÚŒŞ
->
i_äame_£rŸl
;

588 
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
 = 0;

590 if(
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_P
){

591 
rc_šfo
->
b™s_pF¿me
 +ğrc_šfo->
nÜm_äame_b™_budg‘
/rc_šfo->
š™_rc_wšdow
;

592 
rc_šfo
->
b™s_u£d_äame
 =„c_šfo->
b™s_pF¿me
;

593 
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
 = 1;

595 
rc_šfo
->
´e_sknum
 = 
’code_cÚŒŞ
->
i_äame_£rŸl
;

596 
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
 = 0;

600 
rc_šfo
->
´e_sknum
 = 
’code_cÚŒŞ
->
i_äame_£rŸl
;

601 
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
 = 0;

604 
	}
}

606 
	$dvm264_vbr_po¡_´oûss
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
)

608 
tw_rc_driv”_t
 *
rc_driv”
;

609 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

610 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

611 
key_äame_š‹rv®s
;

612 
com³n§‹_v®ue
;

614 
rc_driv”
 = &
’cod”
->rc_driver;

615 
’code_´İ”ty
 = &
’cod”
->encode_property;

616 
key_äame_š‹rv®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

617 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

619 
rc_šfo
->
Ëak_bufãr
 +ğÔc_šfo->
b™s_u£d_äame
 -„c_šfo->
b™s_pF¿me
);

620 if((
’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_IDR
è&& (’code_cÚŒŞ->äame_ty³ =ğ
H264_FRAME_TYPE_I
)){

621 
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
 = 0;

623 if(
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
 == 0){

624 if(
rc_driv”
->
is_rc_image_Ëv–_´iÜ™y
 ||„c_driv”->
is_rc_image_smoÙhly_´iÜ™y
){

625 if(
rc_šfo
->
Ëak_bufãr
 >ğrc_šfo->
bufãr_th»shŞd
){

626 
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
 = (
rc_šfo
->
Ëak_bufãr
/rc_šfo->
b™s_pF¿me
)+1;

627 
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
 = 
	`H264_MIN
(
key_äame_š‹rv®s
-
’code_cÚŒŞ
->
i_p_¡ride
-1,„c_driver->discard_frame_number_by_level);

628 
rc_šfo
->
b™s_pF¿me
 -ğ
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
*rc_šfo->b™s_pF¿me/rc_šfo->
š™_rc_wšdow
;

629 } if((-
rc_šfo
->
Ëak_bufãr
è>ğrc_šfo->
bufãr_th»shŞd
){

630 
com³n§‹_v®ue
 = ((-
rc_šfo
->
Ëak_bufãr
)/rc_šfo->
b™s_pF¿me
)+1;

631 
com³n§‹_v®ue
 = 
	`H264_MIN
(
rc_šfo
->
rc_wšdow
, compensate_value);

632 
rc_šfo
->
b™s_pF¿me
 +ğ
com³n§‹_v®ue
*rc_šfo->b™s_pF¿me/rc_šfo->
š™_rc_wšdow
;

636 if(
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
){

637 
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
 = 
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
;

638 
rc_šfo
->
Ëak_bufãr
 -ğÔc_šfo->
b™s_pF¿me
*
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
);

639 
rc_šfo
->
rc_wšdow
 = (Ôc_šfo->rc_wšdow>
’code_cÚŒŞ
->
i_disÿrd_äame_numb”
è? (rc_šfo->rc_wšdow-’code_cÚŒŞ->i_disÿrd_äame_numb”è: (rc_šfo->
š™_rc_wšdow
));

642 
	}
}

644 
	$dvm264_vbr_upd©e_rc_·¿
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

646 
tw_vbr_rc_¡ruù_t
 *
rc_šfo
;

647 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

648 
dvm_ch_t
 *
ch
;

649 
u32
 
b™s_u£d_äame
;

650 
u32
 
nÚ_z”o_couÁ
;

651 
u32
 
b™s_fÜ_nÚ‹xt_e¡
;

652 
u32
 
»sidu®_b™s_u£d_äame
;

654 
rc_šfo
 = &
’cod”
->
rc_driv”
.
vbr
.
rc_·¿m
;

655 
ch
 = 
’cod”
->chip;

656 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

657 
b™s_u£d_äame
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SLICE_TOTAL_BIT_NUMBER
);

659 
nÚ_z”o_couÁ
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_COEFF_NUMBER
);

661 
»sidu®_b™s_u£d_äame
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
RES_TOTAL_BIT_NUMBER
);

663 
b™s_fÜ_nÚ‹xt_e¡
 = 
b™s_u£d_äame
 - 
»sidu®_b™s_u£d_äame
;

664 #ifdeà 
RC_DEBUG


665 
	`´štk
("%s.%d: chª_%d_%d, %d, %d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
’cod”
->
phy_¦Ù_id
,ƒncod”->
logic_chª_id
, 
b™s_u£d_äame
, 
nÚ_z”o_couÁ
, 
»sidu®_b™s_u£d_äame
);

667 ià(!
b™s_u£d_äame
 || !
b™s_fÜ_nÚ‹xt_e¡
) {

668 
rc_šfo
->
b_æag_upd©e
 = 1;

671 
rc_šfo
->
b™s_u£d_äame
 = bits_used_frame;

672 
rc_šfo
->
nz_couÁ
 = 
nÚ_z”o_couÁ
;

673 
rc_šfo
->
b™s_fÜ_nÚ‹xt_e¡
 = bits_for_nontext_est;

674 
rc_šfo
->
b_æag_upd©e
 = 0;

675 if(
’code_cÚŒŞ
->
i_äame_£rŸl
 > 
SMOOTH_WINDOW_MAX_SIZE
){

676 
	`dvm264_vbr_po¡_´oûss
(
’cod”
, 
rc_šfo
);

678 
	}
}

680 
	$dvm264_vbr_jump_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

682 
’cod”
->
rc_driv”
.
vbr
.
rc_·¿m
.
b_æag_upd©e
 = 1;

683 #ifdeà 
RC_DEBUG


684 
	`´štk
("%s.%d: chª_%d_%d\n", 
__FUNCTION__
, 
__LINE__
, 
’cod”
->
phy_¦Ù_id
,ƒncod”->
logic_chª_id
);

686 
	}
}

688 
tw_rc_driv”_İ
 
	gvbr_driv”_İ
 =

690 .
š™_rc
 = 
dvm_vbr_rc_š™
,

691 .
	g£t_qp
 = 
dvm264_vbr_upd©e_rc
,

692 .
	gupd©e_rc
 = 
dvm264_vbr_upd©e_rc_·¿
,

693 .
	gjump_rc
 = 
dvm264_vbr_jump_rc
,

696 
	$dvm_rc_š™
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

698 
tw_rc_driv”_t
 *
rc_driv”
;

700 
rc_driv”
 = &
’cod”
->rc_driver;

701 
rc_driv”
->
disÿrd_äame_numb”_by_Ëv–
 = 0;

704 
rc_driv”
->
rc_İ
 = &
rc_driv”_İ
;

705 
rc_driv”
->
cbr
.
rc_İ
 = &
cbr_driv”_İ
;

706 
rc_driv”
->
cbr
.
rc_İ
->
	`š™_rc
(
’cod”
);

707 
rc_driv”
->
vbr
.
rc_İ
 = &
vbr_driv”_İ
;

708 
rc_driv”
->
vbr
.
rc_İ
->
	`š™_rc
(
’cod”
);

709 
	}
}

711 
	$dvm264_upd©e_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
tw_video_äame_tcb_t
 *
video_äame
)

713 
tw_rc_driv”_t
 *
rc_driv”
;

714 
tw_cbr_driv”_t
 *
cbr_driv”
;

715 
tw_vbr_driv”_t
 *
vbr_driv”
;

716 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

717 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

719 
rc_driv”
 = &
’cod”
->rc_driver;

720 
’code_´İ”ty
 = &
’cod”
->encode_property;

721 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

722 
’code_´İ”ty
->
İ
->
	`g‘_rcTy³
(encode_property)){

723 
TW_H264_CBR
:

724 
cbr_driv”
 = &
rc_driv”
->
cbr
;

725 if(
cbr_driv”
->
rc_İ
->
£t_qp
 !ğ
NULL
){

726 
cbr_driv”
->
rc_İ
->
	`£t_qp
(
’cod”
, 
video_äame
);

728 
’code_cÚŒŞ
->
i_cu¼_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

731 
TW_H264_VBR
:

732 
vbr_driv”
 = &
rc_driv”
->
vbr
;

733 if(
vbr_driv”
->
rc_İ
->
£t_qp
 !ğ
NULL
){

734 
vbr_driv”
->
rc_İ
->
	`£t_qp
(
’cod”
, 
video_äame
);

736 
’code_cÚŒŞ
->
i_cu¼_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

740 
’code_cÚŒŞ
->
i_cu¼_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

743 
	}
}

745 
	$dvm264_jump_rc
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

747 
tw_rc_driv”_t
 *
rc_driv”
;

748 
tw_cbr_driv”_t
 *
cbr_driv”
;

749 
tw_vbr_driv”_t
 *
vbr_driv”
;

751 
rc_driv”
 = &
’cod”
->rc_driver;

752 
cbr_driv”
 = &
rc_driv”
->
cbr
;

753 
vbr_driv”
 = &
rc_driv”
->
vbr
;

754 
cbr_driv”
->
rc_İ
->
	`jump_rc
(
’cod”
);

755 
vbr_driv”
->
rc_İ
->
	`jump_rc
(
’cod”
);

756 
	}
}

758 
	$dvm264_upd©e_rc_·¿
(
tw_h264_logic_’code_chª_t
 *
’cod”
)

760 
tw_rc_driv”_t
 *
rc_driv”
;

761 
tw_cbr_driv”_t
 *
cbr_driv”
;

762 
tw_vbr_driv”_t
 *
vbr_driv”
;

763 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

764 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

766 
rc_driv”
 = &
’cod”
->rc_driver;

767 
’code_´İ”ty
 = &
’cod”
->encode_property;

768 
’code_cÚŒŞ
 = &
’cod”
->encode_control;

769 
cbr_driv”
 = &
rc_driv”
->
cbr
;

770 
vbr_driv”
 = &
rc_driv”
->
vbr
;

771 
’code_´İ”ty
->
İ
->
	`g‘_rcTy³
(encode_property)){

772 
TW_H264_CBR
:

773 if(
cbr_driv”
->
rc_İ
->
upd©e_rc
 !ğ
NULL
){

774 
cbr_driv”
->
rc_İ
->
	`upd©e_rc
(
’cod”
);

776 
cbr_driv”
->
rc_İ
->
	`jump_rc
(
’cod”
);

779 
TW_H264_VBR
:

780 if(
vbr_driv”
->
rc_İ
->
upd©e_rc
 !ğ
NULL
){

781 
vbr_driv”
->
rc_İ
->
	`upd©e_rc
(
’cod”
);

783 
vbr_driv”
->
rc_İ
->
	`jump_rc
(
’cod”
);

787 
rc_driv”
->
rc_İ
->
	`jump_rc
(
’cod”
);

790 
	}
}

792 
tw_rc_driv”_İ
 
	grc_driv”_İ
 =

794 .
š™_rc
 = 
dvm_rc_š™
,

795 .
	g£t_qp
 = 
dvm264_upd©e_rc
,

796 .
	gupd©e_rc
 = 
dvm264_upd©e_rc_·¿
,

797 .
	gjump_rc
 = 
dvm264_jump_rc
,

800 
	$š™_rc_driv”
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

802 if(
h264_logic_’code_chª
 !ğ
NULL
){

803 
tw_rc_driv”_t
 *
rc_driv”
 = &
h264_logic_’code_chª
->rc_driver;

804 
rc_driv”
->
rc_İ
 = &
rc_driv”_İ
;

805 
rc_driv”
->
rc_İ
->
	`š™_rc
(
h264_logic_’code_chª
);

807 
	}
}

	@../../tw5864/tw5864/frame.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#FPGA_DATA_BASE
 (0x80000)

	)

4 
	#FPGA_DATA_END
 (0x100000)

	)

5 
	#WDELAYTIME
 (40)

	)

8 
	$Wr™e_OÃ_F¿me_To_DDR_D1_F¿me
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
u16
 
F¿meIdx
, u16 
chªÃl
,
u8
 *
buf
, 
u32
 *
Ën
)

10 
dvm_ch_t
 *
ch
;

11 
u32
 
i
,
j
,
k
;

12 
u32
 
tmpDDR
;

13 
u8
 *
lše
, *
lše1
, *
lše2
;

14 
u8
 *
¤cBufY
,*
¤cBufU
,*
¤cBufV
;

15 
u16
 
·geIdxY
, 
·geIdxUV
;

16 
u32
 
d©aTemp
;

17 
u32
 
‹mp
;

18 
u32
 
width
,
height
;

19 
ch
 = 
’cod”
->chip;

20 
width
 = 704;

21 
height
 = 576;

23 
F¿meIdx
)

26 
·geIdxY
 = 4000;

27 
·geIdxUV
 = 0xc;

30 
·geIdxY
 = 4002;

31 
·geIdxUV
 = 0xd;

34 
·geIdxY
 = 4004;

35 
·geIdxUV
 = 0xe;

38 
·geIdxY
 = 4006;

39 
·geIdxUV
 = 0xf;

42 
·geIdxY
 = 2;

43 
·geIdxUV
 = 0x9;

46 
·geIdxY
 = 4;

47 
·geIdxUV
 = 0xa;

50 
·geIdxY
 = 6;

51 
·geIdxUV
 = 0xb;

54 
·geIdxY
 = 0;

55 
·geIdxUV
 =0x8;

58 
chªÃl
)

61 
·geIdxY
 +=16;

62 
·geIdxUV
 +=16;

65 
·geIdxY
 +=32;

66 
·geIdxUV
 +=32;

69 
·geIdxY
 +=48;

70 
·geIdxUV
 +=48;

73 
·geIdxY
 +=64;

74 
·geIdxUV
 +=64;

77 
·geIdxY
 +=80;

78 
·geIdxUV
 +=80;

81 
·geIdxY
 +=96;

82 
·geIdxUV
 +=96;

85 
·geIdxY
 +=112;

86 
·geIdxUV
 +=112;

89 
·geIdxY
 +=128;

90 
·geIdxUV
 +=128;

93 
·geIdxY
 +=144;

94 
·geIdxUV
 +=144;

97 
·geIdxY
 +=160;

98 
·geIdxUV
 +=160;

101 
·geIdxY
 +=176;

102 
·geIdxUV
 +=176;

105 
·geIdxY
 +=192;

106 
·geIdxUV
 +=192;

109 
·geIdxY
 +=208;

110 
·geIdxUV
 +=208;

113 
·geIdxY
 +=224;

114 
·geIdxUV
 +=224;

117 
·geIdxY
 +=240;

118 
·geIdxUV
 +=240;

123 
	`´štk
("downLßd ddr[Y=%d, UV=%d] d©a\r\n", 
·geIdxY
, 
·geIdxUV
);

124 
‹mp
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MODE
);

125 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 1);

126 *
Ën
 = 0;

127 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxY
);

129 
k
=0;k<=(
width
>>8);k++)

131 
¤cBufY
 = 
buf
;

132 
tmpDDR
 = 
FPGA_DATA_BASE
+0x40000*
k
;

133 if(
tmpDDR
 =ğ(
FPGA_DATA_END
))

135 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, (
·geIdxY
+1));

136 
tmpDDR
 = 
FPGA_DATA_BASE
;

138 
j
=0;j<
height
;j++)

140 
lše
 = 
¤cBufY
+256*
k
;

141 if((
width
-256*
k
)>256)

143 
i
=0;i<256;i+=4)

145 
d©aTemp
 = 
lše
[
i
+3];

146 
d©aTemp
 <<= 8;

147 
d©aTemp
 |ğ
lše
[
i
+2];

148 
d©aTemp
 <<= 8;

149 
d©aTemp
 |ğ
lše
[
i
+1];

150 
d©aTemp
 <<= 8;

151 
d©aTemp
 |ğ
lše
[
i
];

152 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
tmpDDR
, 
d©aTemp
);

154 
tmpDDR
 += 4;

155 *
Ën
 += 4;

157 
¤cBufY
 +ğ
width
;

161 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxY
+1);

162 
tmpDDR
 = 
FPGA_DATA_BASE
+256*
j
;

163 
i
=0;i<(
width
-256*
k
);i+=4)

165 
d©aTemp
 = 
lše
[
i
+3];

166 
d©aTemp
 <<= 8;

167 
d©aTemp
 |ğ
lše
[
i
+2];

168 
d©aTemp
 <<= 8;

169 
d©aTemp
 |ğ
lše
[
i
+1];

170 
d©aTemp
 <<= 8;

171 
d©aTemp
 |ğ
lše
[
i
];

172 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
tmpDDR
, 
d©aTemp
);

174 
tmpDDR
 += 4;

175 *
Ën
 += 4;

177 
¤cBufY
 +ğ
width
;

186 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
);

187 
k
=0;k<=(
width
>>8);k++)

189 
¤cBufU
 = 
buf
 + 
height
*
width
;

190 
¤cBufV
 = 
¤cBufU
 + ((
height
*
width
)>>2);

191 
tmpDDR
 = 
FPGA_DATA_BASE
+0x20000*
k
;

192 
j
=0;j<(
height
>>1);j++)

194 
lše1
 = 
¤cBufU
+128*
k
;

195 
lše2
 = 
¤cBufV
+128*
k
;

196 if((
width
-256*
k
)>256)

198 
i
=0;i<128;i+=2)

200 
d©aTemp
 = 
lše2
[
i
+1];

201 
d©aTemp
 <<= 8;

202 
d©aTemp
 |ğ
lše1
[
i
+1];

203 
d©aTemp
 <<= 8;

204 
d©aTemp
 |ğ
lše2
[
i
];

205 
d©aTemp
 <<= 8;

206 
d©aTemp
 |ğ
lše1
[
i
];

208 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
tmpDDR
, 
d©aTemp
);

209 
tmpDDR
 += 4;

210 *
Ën
 += 4;

212 
¤cBufU
 +ğ(
width
>>1);

213 
¤cBufV
 +ğ(
width
>>1);

217 
tmpDDR
 = 
FPGA_DATA_BASE
+0x20000*
k
+256*
j
;

218 
i
=0;i<((
width
>>1)-128*
k
);i+=2)

220 
d©aTemp
 = 
lše2
[
i
+1];

221 
d©aTemp
 <<= 8;

222 
d©aTemp
 |ğ
lše1
[
i
+1];

223 
d©aTemp
 <<= 8;

224 
d©aTemp
 |ğ
lše2
[
i
];

225 
d©aTemp
 <<= 8;

226 
d©aTemp
 |ğ
lše1
[
i
];

227 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
tmpDDR
, 
d©aTemp
);

229 
tmpDDR
 += 4;

230 *
Ën
 += 4;

232 
¤cBufU
 +ğ(
width
>>1);

233 
¤cBufV
 +ğ(
width
>>1);

237 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 
‹mp
);

238 
	}
}

240 
	$New_R—d_OÃ_F¿me_äom_DDR
(
tw_h264_logic_’code_chª_t
* 
’cod”
,
u16
 
F¿meIdx
, u16 
chªÃl
,
u8
 *
buf
, 
u32
 *
Ën
)

243 
dvm_ch_t
 *
ch
;

244 
u32
 
i
,
j
;

245 
u16
 
·geIdxY
, 
·geIdxUV
;

246 
u32
 
tmpDDR
;

247 
u8
 *
lše0
, *
lše1
, *
lše2
, *
lše3
;

248 
u8
 *
lše4
, *
lše5
, *
lše6
, *
lše7
;

249 
u8
 *
¤cBufY
,*
¤cBufU
,*
¤cBufV
;

250 
u32
 
d©aTemp
;

251 
u32
 
off£t
;

252 
u32
 
‹mp
;

253 
u32
 
width
, 
height
;

254 
ch
 = 
’cod”
->chip;

255 
width
 = 704;

256 
height
 = 576;

257 
	`´štk
("0x%p,w%d,h%d\n",
ch
->
»gs
,
width
,
height
);

258 
F¿meIdx
)

261 
·geIdxY
 = 0x4000;

262 
·geIdxUV
 = 0x0c;

265 
·geIdxY
 = 0x4002;

266 
·geIdxUV
 = 0x0d;

269 
·geIdxY
 = 0x4004;

270 
·geIdxUV
 = 0x0e;

273 
·geIdxY
 = 0x4006;

274 
·geIdxUV
 = 0x0f;

277 
·geIdxY
 = 2;

278 
·geIdxUV
 = 9;

281 
·geIdxY
 = 4;

282 
·geIdxUV
 = 10;

285 
·geIdxY
 = 6;

286 
·geIdxUV
 = 11;

289 
·geIdxY
 = 0;

290 
·geIdxUV
 = 8;

293 
chªÃl
)

296 
·geIdxY
 +=16;

297 
·geIdxUV
 +=16;

300 
·geIdxY
 +=32;

301 
·geIdxUV
 +=32;

304 
·geIdxY
 +=48;

305 
·geIdxUV
 +=48;

309 
	`´štk
("R—dback ddr[Y=%d, UV=%d] d©a\r\n", 
·geIdxY
, 
·geIdxUV
);

313 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxY
);

314 
	`md–ay
(
WDELAYTIME
);

315 
tmpDDR
 = 0;

316 
	`md–ay
(
WDELAYTIME
);

317 
¤cBufY
 = 
buf
;

318 
¤cBufU
 = 
¤cBufY
 + 
width
*
height
;

319 
¤cBufV
 = 
¤cBufU
 +(
width
*(
height
>>2));

321 
off£t
 = 
width
<<2;

322 
i
 = 0; 
j
 = 0;

323 
i
=0; i<(
height
>>2); i++)

325 
lše0
 = 
¤cBufY
;

326 
lše1
 = 
lše0
 + 
width
;

327 
lše2
 = 
lše1
 + 
width
;

328 
lše3
 = 
lše2
 + 
width
;

329 
j
=0; j<
width
; j++)

331 
d©aTemp
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
FPGA_DATA_BASE
 + 
tmpDDR
);

332 
lše3
[
j
] = (
u8
)(
d©aTemp
&0xff);

333 
lše2
[
j
] = (
u8
)((
d©aTemp
>>8)&0xff);

334 
lše1
[
j
] = (
u8
)((
d©aTemp
>>16)&0xff);

335 
lše0
[
j
] = (
u8
)((
d©aTemp
>>24)&0xff);

336 
tmpDDR
 += 4;

338 
¤cBufY
 +ğ
off£t
;

339 
tmpDDR
 +ğ(0x400 - 
width
);

340 if(
tmpDDR
 =ğ
FPGA_DATA_END
)

343 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, (
u32
)(
·geIdxY
+1));

344 
	`md–ay
(
WDELAYTIME
);

345 
tmpDDR
 = 0;

346 
	`md–ay
(
WDELAYTIME
);

350 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
);

351 
	`md–ay
(
WDELAYTIME
);

352 
tmpDDR
 = 0;

353 
	`md–ay
(
WDELAYTIME
);

354 
height
 >>= 3;

355 
off£t
 = 
width
<<1;

356 
width
 >>= 1;

357 
i
=0; i<
height
; i++)

359 
lše0
 = 
¤cBufU
;

360 
lše1
 = 
lše0
 + 
width
;

361 
lše2
 = 
lše1
 + 
width
;

362 
lše3
 = 
lše2
 + 
width
;

364 
lše4
 = 
¤cBufV
;

365 
lše5
 = 
lše4
 + 
width
;

366 
lše6
 = 
lše5
 + 
width
;

367 
lše7
 = 
lše6
 + 
width
;

369 
j
=0; j<
width
; j++)

371 
d©aTemp
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
FPGA_DATA_BASE
 + 
tmpDDR
);

372 
lše3
[
j
] = (
u8
)(
d©aTemp
&0xff);

373 
lše2
[
j
] = (
u8
)((
d©aTemp
>>8)&0xff);

374 
lše1
[
j
] = (
u8
)((
d©aTemp
>>16)&0xff);

375 
lše0
[
j
] = (
u8
)((
d©aTemp
>>24)&0xff);

376 
tmpDDR
++;

377 *
Ën
 += 4;

378 
d©aTemp
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
FPGA_DATA_BASE
 + 
tmpDDR
);

379 
lše7
[
j
] = (
u8
)(
d©aTemp
&0xff);

380 
lše6
[
j
] = (
u8
)((
d©aTemp
>>8)&0xff);

381 
lše5
[
j
] = (
u8
)((
d©aTemp
>>16)&0xff);

382 
lše4
[
j
] = (
u8
)((
d©aTemp
>>24)&0xff);

383 
tmpDDR
 += 4;

385 
¤cBufU
 +ğ
off£t
;

386 
¤cBufV
 +ğ
off£t
;

387 
tmpDDR
 +=(0x400-(
width
<<1));

390 
	}
}

392 
	$tw5864_»ad_j³g_yuv
(
dvm_ch_t
 *
ch
, 
·ge
, 
fÜm©
, *
buf
, 
isB
)

394 
u32
 
i
,
j
,
k
;

395 
u16
 
·geIdxY
, 
·geIdxUV
;

396 
u8
 *
¤c
, *
d¡
, *
d©aba£
;

397 
u8
 *
¤cBufY
,*
¤cBufU
,*
¤cBufV
;

398 
u32
 
off£t
, 
yuv_off£t
, 
uv_¡ride
;

399 
u32
 
width
, 
height
;

400 
width
 = 720;

401 
height
 = 576;

403 
·geIdxY
 = 
·ge
;

404 
·geIdxUV
 = 
·geIdxY
 + 1;

405 
	`´štk
("R—dback ddr[Y=%d, UV=%d] d©¨0x%p\n", 
·geIdxY
, 
·geIdxUV
, 
buf
);

406 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxY
 | (
isB
<<14));

407 
	`md–ay
(
WDELAYTIME
);

408 
¤cBufY
 = 
buf
;

409 
¤cBufU
 = 
¤cBufY
 + 
width
*
height
;

410 
¤cBufV
 = 
¤cBufU
 +(
width
*(
height
>>2));

412 
	`´štk
("................Y\n");

413 
off£t
 = 0;

414 
d¡
 = 
¤cBufY
;

415 
d©aba£
 = 
ch
->
»gs
 + 0x80000;

416 
i
 = 0; i < 36; i++)

418 
j
 = 0; j < 16; j++)

420 
k
 = 0; k < 6; k++)

422 
yuv_off£t
 = ((
i
 * 16 * 6 * 128è+ (
j
 * 128è+ (
k
 * 128 * 16));

423 
¤c
 = 
d©aba£
 + 
yuv_off£t
;

425 if(
k
 < 5){

426 
	`memıy
(
d¡
, 
¤c
, 128);

427 
d¡
 += 128;

428 
off£t
 += 128;

429 if(
off£t
 == 0x80000){

431 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

434 
	`memıy
(
d¡
, 
¤c
, 80);

435 
d¡
 += 80;

436 
off£t
 += 128;

437 if(
off£t
 == 0x80000){

439 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

445 
	`´štk
("................UV ,off£ˆ0x%08x\n", 
off£t
);

447 
uv_¡ride
 = 0;

448 
¤c
 = 
d©aba£
 + 
off£t
;

449 
i
 = 0; i < ((
width
*
height
) >> 2); i++)

451 *
¤cBufU
++ = *
¤c
++;

453 *
¤cBufV
++ = *
¤c
++;

455 
off£t
 += 2;

456 
uv_¡ride
++;

457 if(
uv_¡ride
 =ğ(
width
>>1)){

458 
¤c
 += 80;

459 
off£t
 += 80;

460 
uv_¡ride
 = 0;

462 if(
off£t
 == 0x80000){

463 
¤c
 = 
ch
->
»gs
 + 0x80000;

464 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

469 
	}
}

471 
	$tw5864_wr™e_j³g_yuv
(
dvm_ch_t
 *
ch
, 
·ge
, 
fÜm©
, *
buf
, 
isB
)

473 
u32
 
i
,
j
,
k
;

474 
u16
 
·geIdxY
, 
·geIdxUV
;

475 
u8
 *
¤c
, *
d¡
;

476 
u8
 *
¤cBufY
,*
¤cBufU
,*
¤cBufV
;

477 
u32
 
off£t
;

478 
u32
 
width
, 
height
;

479 
width
 = 720;

480 
height
 = 576;

482 
·geIdxY
 = 
·ge
;

483 
·geIdxUV
 = 
·geIdxY
 + 1;

484 
	`´štk
("wr™ddr[Y=%d, UV=%d] d©¨0x%p\n", 
·geIdxY
, 
·geIdxUV
, 
buf
);

485 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxY
 | (
isB
<<14));

486 
	`md–ay
(
WDELAYTIME
);

487 
¤cBufY
 = 
buf
;

488 
¤cBufU
 = 
¤cBufY
 + 
width
*
height
;

489 
¤cBufV
 = 
¤cBufU
 +(
width
*(
height
>>2));

491 
	`´štk
("................Y\n");

492 
off£t
 = 0;

493 
¤c
 = 
¤cBufY
;

494 
d¡
 = 
ch
->
»gs
 + 0x80000;

495 
i
 = 0; (˜< 
height
/16); i++)

497 
j
 = 0; j < 16; j++)

499 
k
 = 0; k < 6; k++)

501 
¤c
 = 
¤cBufY
 + ((
i
 * 16 * 6 * 128è+ (
j
 * 128è+ (
k
 * 128 * 16));

502 if(
k
 < 5){

503 
	`memıy
(
d¡
, 
¤c
, 128);

504 
d¡
 += 128;

505 
off£t
 += 128;

506 if(
off£t
 == 0x80000){

507 
d¡
 = 
ch
->
»gs
 + 0x80000;

508 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

511 
	`memıy
(
d¡
, 
¤c
, 80);

512 
d¡
 += 128;

513 
off£t
 += 128;

514 if(
off£t
 == 0x80000){

515 
d¡
 = 
ch
->
»gs
 + 0x80000;

516 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

522 
	`´štk
("................UV\n");

524 
i
 = 0; i < ((
width
*
height
) >> 2); i++)

526 *
d¡
++ = *
¤cBufU
++;

528 *
d¡
++ = *
¤cBufV
++;

530 
off£t
 += 2;

531 if(
off£t
 == 0x80000){

532 
d¡
 = 
ch
->
»gs
 + 0x80000;

533 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
·geIdxUV
|(
isB
<<14));

538 
	}
}

	@../../tw5864/tw5864/golomb.c

1 
	~<tw5864/dvm_commÚ.h
>

3 cÚ¡ 
__u8
 
	gff_log2_b
[256]={

14 cÚ¡ 
__u8
 
	gff_gŞomb_vlc_Ën
[512]={

33 cÚ¡ 
__u8
 
	gff_ue_gŞomb_vlc_code
[512]={

52 cÚ¡ 
__s8
 
	gff_£_gŞomb_vlc_code
[512]={

	@../../tw5864/tw5864/proc_entry.c

1 
	~<lšux/š™.h
>

2 
	~<lšux/moduË.h
>

3 
	~<lšux/d–ay.h
>

4 
	~<lšux/”ºo.h
>

5 
	~<lšux/fs.h
>

6 
	~<lšux/k”Ãl.h
>

7 
	~<lšux/sched.h
>

8 
	~<lšux/mu‹x.h
>

9 
	~<lšux/£q_fe.h
>

11 
	~<tw5864/dvm_commÚ.h
>

13 
	#MODULE_ENTRY
 "twÎ"

	)

15 
´oc_dœ_’Œy
 *
	gs_dœ_’Œy
 = 
NULL
, *
	gmes§ge_’Œy
;

17 #ifdeà
MESSAGE_LOG


18 
mes§ge_´iv‹
 *
	gmes§ge_log
 = 
NULL
;

20 
	$show_´oc_’Œy_šfo
(*
cÚ‹xt
)

22 
´oc_dœ_’Œy
 *
’Œy
 = (´oc_dœ_’Œy *)
cÚ‹xt
;

24 if(
’Œy
 && (’Œy->
subdœ
 =ğ
NULL
)) {

25 
	`´štk
 ("%s,", 
’Œy
->
Çme
);

27 
	}
}

29 
touch_—ch_´oc_’Œy
(
´oc_dœ_’Œy
 *
roÙ
, (*
â
)(*))

31 if(
roÙ
) {

32 if(
â
) {

33 
	`â
(
roÙ
);

35 
	`touch_—ch_´oc_’Œy
(
roÙ
->
subdœ
, 
â
);

36 
	`touch_—ch_´oc_’Œy
(
roÙ
->
Ãxt
, 
â
);

38 
	}
}

40 
	$msg_İ’
(
šode
 * inode, 
fe
 * file)

42 
fe
->
´iv©e_d©a
 = 
mes§ge_log
;

45 
	}
}

47 
	$msg_»Ëa£
(
šode
 * inode, 
fe
 * file)

50 
	}
}

52 
ssize_t
 
	$msg_»ad
(
fe
 *fe, 
__u£r
 *
buf
,

53 
size_t
 
couÁ
, 
loff_t
 *
µos
)

55 
u32
 
i
 = 0;

56 
c
;

57 
”rÜ
 = 0;

58 
mes§ge_´iv‹
 *
p
;

60 
p
 = (
mes§ge_´iv‹
 *)
fe
->
´iv©e_d©a
;

62 ià((
fe
->
f_æags
 & 
O_NONBLOCK
è&& !(
p
->
’d
 -…->
¡¬t
))

63  -
EAGAIN
;

65 
”rÜ
 = 
	`wa™_ev’t_š‹¼u±ibË
(
p
->
wa™
, (p->
¡¬t
 -…->
’d
));

66 if(
”rÜ
) {

67 
msg_out
;

69 
i
 = 0;

70 
	`¥š_lock_œq
(&
p
->
lock
);

71 !
”rÜ
 && (
p
->
¡¬t
 !ğp->
’d
è&& 
i
 < 
couÁ
) {

72 if((
p
->
’d
 <…->
¡¬t
è&& (p->¡¬ˆ=ğ(
MESSAGE_LEN
 - (MESSAGE_LEN>>8)))) {

73 
p
->
¡¬t
 = 0;

75 
c
 = 
p
->
buf
[p->
¡¬t
&(
MESSAGE_LEN
 - 1)];

76 
p
->
¡¬t
++;

77 
	`¥š_uÆock_œq
(&
p
->
lock
);

78 
”rÜ
 = 
	`__put_u£r
(
c
,
buf
);

79 
buf
++;

80 
i
++;

81 
	`cÚd_»sched
();

82 
	`¥š_lock_œq
(&
p
->
lock
);

84 
	`¥š_uÆock_œq
(&
p
->
lock
);

85 ià(!
”rÜ
)

86 
”rÜ
 = 
i
;

87 
msg_out
:

88  
”rÜ
;

89 
	}
}

91 
	$msg_pŞl
(
fe
 *fe, 
pŞl_bË
 *
wa™
)

93 
mes§ge_´iv‹
 *
p
;

95 
p
 = (
mes§ge_´iv‹
 *)
fe
->
´iv©e_d©a
;

97 
	`pŞl_wa™
(
fe
, &
p
->
wa™
, wait);

98 ià(
p
->
’d
 !ğp->
¡¬t
)

99  
POLLIN
 | 
POLLRDNORM
;

102 
	}
}

105 cÚ¡ 
fe_İ”©iÚs
 
	g´oc_mes§ges_İ”©iÚs
 = {

106 .
»ad
 = 
msg_»ad
,

107 .
	gpŞl
 = 
msg_pŞl
,

108 .
	gİ’
 = 
msg_İ’
,

109 .
	g»Ëa£
 = 
msg_»Ëa£
,

112 
touch_—ch_´oc_’Œy
(
´oc_dœ_’Œy
 *
roÙ
, (*
â
)(*)){

113 
	}
}

114 
	$show_´oc_’Œy_šfo
(*
cÚ‹xt
){

115 
	}
}

117 
	$tw_moduË_»gi¡”
(
dvm_ch_t
 *
ch
, 
tw_´oc_»gi¡”_s
 *
»g
)

119 if(!
ch
 || !
»g
)

121  -
EINVAL
;

124 if(!
ch
->
´oc_’Œy
){

125 
	`TW_DBG
(
TW_DBG_INFO
, "ü—‹…roø’Œy /´oc/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
);

126 
ch
->
´oc_’Œy
 = 
	`´oc_mkdœ
(ch->
Çme
, 
s_dœ_’Œy
);

128 if(
»g
->
’Œy
){

129  -
EPERM
;

131 
»g
->
’Œy
 = 
	`ü—‹_´oc_’Œy
Ôeg->
Çme
, 0644, 
ch
->
´oc_’Œy
);

132 if(!
»g
->
’Œy
)

134 
	`TW_DBG
(
TW_DBG_ERR
, "ü—‹ /´oc/%s/%s/% ®»ady faed\n", 
MODULE_ENTRY
, 
ch
->
Çme
, 
»g
->name);

135  -
EPERM
;

138 
»g
->
’Œy
->
»ad_´oc
 =„eg->
»ad
;

139 
»g
->
’Œy
->
wr™e_´oc
 =„eg->
wr™e
;

140 
»g
->
’Œy
->
d©a
 =„eg->
´iv©e
;

141 
	`TW_DBG
(
TW_DBG_INFO
, "ü—‹…roø’Œy /´oc/%s/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
, 
»g
->name);

144 
	}
}

146 
EXPORT_SYMBOL_GPL
(
tw_moduË_»gi¡”
);

148 
	$tw_moduË_uÄegi¡”
(
dvm_ch_t
 *
ch
, 
tw_´oc_»gi¡”_s
 *
»g
)

151 if(!
ch
 || !
»g
)

153  -
EINVAL
;

156 if(!
»g
->
’Œy
)

161 
	`»move_´oc_’Œy
(
»g
->
Çme
, 
ch
->
´oc_’Œy
);

162 
	`TW_DBG
(
TW_DBG_INFO
, "»mov´oø’Œy /´oc/%s/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
, 
»g
->name);

163 
	`´štk
("»mov´oø’Œy /´oc/%s/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
, 
»g
->name);

164 
»g
->
’Œy
 = 
NULL
;

166 if(!
ch
->
´oc_’Œy
->
subdœ
){

167 
	`TW_DBG
(
TW_DBG_INFO
, "»mov´oø’Œy /´oc/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
);

168 
	`´štk
("»mov´oø’Œy /´oc/%s/%s\n", 
MODULE_ENTRY
, 
ch
->
Çme
);

169 
	`»move_´oc_’Œy
(
ch
->
Çme
, 
s_dœ_’Œy
);

173 
	}
}

174 
EXPORT_SYMBOL_GPL
(
tw_moduË_uÄegi¡”
);

176 
	$´oc_moduË_š™
()

178 #ifdeà
MESSAGE_LOG


179 
mes§ge_´iv‹
 *
p
;

182 
s_dœ_’Œy
 = 
	`´oc_mkdœ
(
MODULE_ENTRY
, 
NULL
);

183 if(!
s_dœ_’Œy
)

185  -
EINVAL
;

188 
s_dœ_’Œy
->
owÃr
 = 
THIS_MODULE
;

189 #ifdeà
MESSAGE_LOG


190 
p
 = (
mes§ge_´iv‹
 *)
	`km®loc
((mes§ge_´iv‹), 
GFP_KERNEL
);

191 if(
p
) {

192 
p
->
buf
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
MESSAGE_LEN
));

193 if(
p
->
buf
) {

194 
p
->
buf_Ën
 = 
MESSAGE_LEN
;

195 
p
->
¡¬t
 = 0;

196 
p
->
’d
 = 0;

197 
	`¥š_lock_š™
(&
p
->
lock
);

198 
	`š™_wa™queue_h—d
(&
p
->
wa™
);

199 
mes§ge_’Œy
 = 
	`ü—‹_´oc_’Œy
("mes§ges", 0644, 
s_dœ_’Œy
);

200 
mes§ge_’Œy
->
´oc_fİs
 = &
´oc_mes§ges_İ”©iÚs
;

201 
mes§ge_’Œy
->
d©a
 = 
p
;

202 
mes§ge_log
 = 
p
;

204 
mes§ge_log
 = 
NULL
;

207 
mes§ge_log
 = 
NULL
;

212 
	}
}

214 
	$´oc_moduË_»Ëa£
()

217 if(
s_dœ_’Œy
) {

218 if(
s_dœ_’Œy
->
subdœ
) {

219 
	`´štk
("unrelease mode:");

220 
	`touch_—ch_´oc_’Œy
(
s_dœ_’Œy
->
subdœ
, 
show_´oc_’Œy_šfo
);

221 
	`´štk
("\n");

223 #ifdeà
MESSAGE_LOG


224 
mes§ge_´iv‹
 *
p
;

225 if(
mes§ge_’Œy
) {

226 
p
 = 
mes§ge_’Œy
->
d©a
;

227 if(
p
) {

228 if(
p
->
buf
) {

229 
	`ä“_·ges
(()
p
->
buf
, 
	`g‘_Üd”
(
MESSAGE_LEN
));

230 
	`»move_´oc_’Œy
("mes§ges", 
s_dœ_’Œy
);

231 
mes§ge_log
 = 
NULL
;

233 
	`kä“
(
p
);

235 
mes§ge_’Œy
 = 
NULL
;

238 
s_dœ_’Œy
 = 
NULL
;

239 
	`»move_´oc_’Œy
(
MODULE_ENTRY
, 
NULL
);

243 
	}
}

245 
fe
 *
	$tw_k”Ãl_fe_İ’
(*
Çme
)

247 
fe
 *
å_fe
;

249 
å_fe
 = 
	`fp_İ’
(
Çme
, 
O_CREAT
 | 
O_RDWR
, 655);

250 if(
	`IS_ERR
(
å_fe
))

252 
	`´štk
("İ’ f\"%s\" fad, %d\n", 
Çme
, ()
å_fe
);

253  
NULL
;

256  
å_fe
;

257 
	}
}

259 
	$tw_k”Ãl_fe_şo£
(
fe
 *
å_fe
)

261 if(
å_fe
)

263 
	`fp_şo£
(
å_fe
, 
NULL
);

265 
	}
}

267 
	$©oi
(*
¡r
)

269 *
p
;

270 
v®
 = 0;

272 if(!
¡r
){

276 
p
 = 
¡r
;

277 *
p
){

278 
v®
 <<= 4;

279 *
p
){

281 
v®
 |ğ*
p
 - '0';

284 
v®
 |ğ*
p
 - 'A';

287 
v®
 |ğ*
p
 - 'a' + 0xa;

291 
p
++;

294  
v®
;

295 
	}
}

297 #ifdeà
ARM_PLATFORM


299 
	#is¥aû
(
c
è((cè=ğ' ')

	)

300 *
	$k¡ºdup
(cÚ¡ *
s
, 
size_t
 
max
, 
gå_t
 
gå
)

302 
size_t
 
Ën
;

303 *
buf
;

305 ià(!
s
)

306  
NULL
;

308 
Ën
 = 
	`¡ºËn
(
s
, 
max
);

309 
buf
 = 
	`km®loc_Œack_ÿÎ”
(
Ën
+1, 
gå
);

310 ià(
buf
) {

311 
	`memıy
(
buf
, 
s
, 
Ën
);

312 
buf
[
Ën
] = '\0';

314  
buf
;

315 
	}
}

317 cÚ¡ *
	$sk_£p
(cÚ¡ *
ı
)

319 *
ı
 && 
	`is¥aû
(*cp))

320 
ı
++;

322  
ı
;

323 
	}
}

325 cÚ¡ *
	$sk_¬g
(cÚ¡ *
ı
)

327 *
ı
 && !
	`is¥aû
(*cp))

328 
ı
++;

330  
ı
;

331 
	}
}

333 
	$couÁ_¬gc
(cÚ¡ *
¡r
)

335 
couÁ
 = 0;

337 *
¡r
) {

338 
¡r
 = 
	`sk_£p
(str);

339 ià(*
¡r
) {

340 
couÁ
++;

341 
¡r
 = 
	`sk_¬g
(str);

345  
couÁ
;

346 
	}
}

349 
	$¬gv_ä“
(**
¬gv
)

351 **
p
;

352 
p
 = 
¬gv
; *p;…++)

353 
	`kä“
(*
p
);

355 
	`kä“
(
¬gv
);

356 
	}
}

358 **
	$¬gv_¥l™
(
gå_t
 
gå
, cÚ¡ *
¡r
, *
¬gı
)

360 
¬gc
 = 
	`couÁ_¬gc
(
¡r
);

361 **
¬gv
 = 
	`kz®loc
((*¬gvè* (
¬gc
+1), 
gå
);

362 **
¬gvp
;

364 ià(
¬gv
 =ğ
NULL
)

365 
out
;

367 ià(
¬gı
)

368 *
¬gı
 = 
¬gc
;

370 
¬gvp
 = 
¬gv
;

372 *
¡r
) {

373 
¡r
 = 
	`sk_£p
(str);

375 ià(*
¡r
) {

376 cÚ¡ *
p
 = 
¡r
;

377 *
t
;

379 
¡r
 = 
	`sk_¬g
(str);

381 
t
 = 
	`k¡ºdup
(
p
, 
¡r
-p, 
gå
);

382 ià(
t
 =ğ
NULL
)

383 
ç
;

384 *
¬gvp
++ = 
t
;

387 *
¬gvp
 = 
NULL
;

389 
out
:

390  
¬gv
;

392 
ç
:

393 
	`¬gv_ä“
(
¬gv
);

394  
NULL
;

395 
	}
}

	@../../tw5864/tw5864/tw_audio_buf.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$tw_audio_·ck‘_£ùiÚ_š™
(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
id
)

5 if((
audio_·ck‘_£ùiÚ
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

6 
tcb_node_t
 *
node
;

7 
	`©omic_£t
(&
audio_·ck‘_£ùiÚ
->
»f_couÁ
, 0);

8 
node
 = &
audio_·ck‘_£ùiÚ
->
·ck‘_node
;

9 
node
->
İ
 = &
tcb_node_İ
;

10 
node
->
İ
->
	`š™
(node);

11 
node
->
İ
->
	`£t_´iv
Òode, 
audio_·ck‘_£ùiÚ
);

12 
	`¥š_lock_š™
(&
audio_·ck‘_£ùiÚ
->
lock
);

13 
audio_·ck‘_£ùiÚ
->
id
 = id;

14 
audio_·ck‘_£ùiÚ
->
£ùiÚ_size
 = 
AUDIO_SECTION_SIZE
;

15 
audio_·ck‘_£ùiÚ
->
·ylßd_Ën
 = 0;

16 
audio_·ck‘_£ùiÚ
->
§m¶e_¿‹
 = 
TW_AUDIO_8000
;

17 
audio_·ck‘_£ùiÚ
->
ty³
 = 
TW_AUDIO_PCM
;

18 
audio_·ck‘_£ùiÚ
->
b™_wide
 = 
TW_AUDIO_16BIT
;

19 
audio_·ck‘_£ùiÚ
->
cÚsum”_off£t
 = 0;

20 
audio_·ck‘_£ùiÚ
->
äameS”Ÿl
 = 0;

21 
audio_·ck‘_£ùiÚ
->
d©a
 = 
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
+×udio_·ck‘_£ùiÚ->
£ùiÚ_size
*
id
);

22 
audio_·ck‘_£ùiÚ
->
dma_addr
 = 0;

23 
	`š™_tw_audio_desütÜ
(&
audio_·ck‘_£ùiÚ
->
desütÜ
, &audio_·ck‘_£ùiÚ->
d©a
[audio_·ck‘_£ùiÚ->
£ùiÚ_size
-(
audio_£ùiÚ_desütÜ_t
)]);

25 
	}
}

27 
	$tw_audio_·ck‘_£ùiÚ_»£t
(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
)

29 if(
audio_·ck‘_£ùiÚ
 !ğ
NULL
){

30 
	`©omic_£t
(&
audio_·ck‘_£ùiÚ
->
»f_couÁ
, 0);

31 
audio_·ck‘_£ùiÚ
->
·ylßd_Ën
 = 0;

32 
audio_·ck‘_£ùiÚ
->
cÚsum”_off£t
 = 0;

33 
audio_·ck‘_£ùiÚ
->
£ùiÚ_size
 = 
AUDIO_SECTION_SIZE
;

34 
audio_·ck‘_£ùiÚ
->
§m¶e_¿‹
 = 
TW_AUDIO_8000
;

35 
audio_·ck‘_£ùiÚ
->
ty³
 = 
TW_AUDIO_PCM
;

36 
audio_·ck‘_£ùiÚ
->
b™_wide
 = 
TW_AUDIO_16BIT
;

37 
audio_·ck‘_£ùiÚ
->
äameS”Ÿl
 = 0;

38 
	`š™_tw_audio_desütÜ
(&
audio_·ck‘_£ùiÚ
->
desütÜ
, &audio_·ck‘_£ùiÚ->
d©a
[audio_·ck‘_£ùiÚ->
£ùiÚ_size
-(
audio_£ùiÚ_desütÜ_t
)]);

40 
	}
}

42 
	$tw_audio_·ck‘_£ùiÚ_»Ëa£
(
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

44 if((
±r_audio_·ck‘_£ùiÚ
!=
NULL
)){

45 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
 = *
±r_audio_·ck‘_£ùiÚ
;

46 
æags
;

48 if(
audio_chª_buf_poŞ
 =ğ
NULL
){

49 
audio_chª_buf_poŞ
 = 
audio_·ck‘_£ùiÚ
->audio_chan_buf_pool;

51 
	`¥š_lock_œq§ve
(&
audio_·ck‘_£ùiÚ
->
lock
, 
æags
);

52 if(
	`©omic_»ad
(&
audio_·ck‘_£ùiÚ
->
»f_couÁ
) > 1){

53 
	`©omic_dec
(&
audio_·ck‘_£ùiÚ
->
»f_couÁ
);

55 
tcb_node_t
 *
node
;

56 if(
audio_·ck‘_£ùiÚ
->
İ
 !ğ
NULL
){

57 
audio_·ck‘_£ùiÚ
->
İ
->
	`»£t
(audio_packet_section);

59 
node
 = &
audio_·ck‘_£ùiÚ
->
·ck‘_node
;

60 if(
node
->
İ
 !ğ
NULL
){

61 
node
->
İ
->
	`»Ëa£
Òode, &
audio_chª_buf_poŞ
->
poŞ_node
);

64 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

65 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_£ùiÚ
->
lock
, 
æags
);

67 
	}
}

69 
	$tw_audio_·ck‘_£ùiÚ_»ã»nû
(
tw_audio_·ck‘_£ùiÚ_t
 *
¤c_audio_·ck‘_£ùiÚ
,w_audio_·ck‘_£ùiÚ_ˆ**
de¡_audio_·ck‘_£ùiÚ
)

71 if((
¤c_audio_·ck‘_£ùiÚ
!=
NULL
è&& (
de¡_audio_·ck‘_£ùiÚ
!=NULL)){

72 
æags
;

73 
	`¥š_lock_œq§ve
(&
¤c_audio_·ck‘_£ùiÚ
->
lock
, 
æags
);

74 
	`©omic_šc
(&
¤c_audio_·ck‘_£ùiÚ
->
»f_couÁ
);

75 *
de¡_audio_·ck‘_£ùiÚ
 = 
¤c_audio_·ck‘_£ùiÚ
;

76 
	`¥š_uÆock_œq»¡Üe
(&
¤c_audio_·ck‘_£ùiÚ
->
lock
, 
æags
);

78 
	}
}

80 
	$tw_audio_·ck‘_£ùiÚ_dma_m­
(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

82 if(
audio_·ck‘_£ùiÚ
 !ğ
NULL
) {

83 if(
audio_·ck‘_£ùiÚ
->
d©a
 !ğ
NULL
) {

84 
audio_·ck‘_£ùiÚ
->
dma_addr
 = 
	`dma_m­_sšgË
(
NULL
,‡udio_·ck‘_£ùiÚ->
d©a
,‡udio_·ck‘_£ùiÚ->
£ùiÚ_size
, 
dœeùiÚ
);

85 ià(
audio_·ck‘_£ùiÚ
->
dma_addr
 == 0){

86 
	`´štk
("%s.%dƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

90 
	}
}

92 
	$tw_audio_·ck‘_£ùiÚ_dma_unm­
(
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

94 if(
audio_·ck‘_£ùiÚ
 !ğ
NULL
) {

95 ià(
audio_·ck‘_£ùiÚ
->
dma_addr
 != 0) {

96 
	`dma_unm­_sšgË
(
NULL
, 
audio_·ck‘_£ùiÚ
->
dma_addr
,‡udio_·ck‘_£ùiÚ->
£ùiÚ_size
, 
dœeùiÚ
);

97 
audio_·ck‘_£ùiÚ
->
dma_addr
 = 0;

100 
	}
}

102 
size_t
 
	$tw_audio_·ck‘_£ùiÚ_subm™
(
tw_audio_·ck‘_£ùiÚ_t
 *
äame
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

104 
tw_äame_h—d”_t
 
__u£r
 *
äame_h—d”_±r
;

105 
tw_äame_h—d”_t
 
tw_äame_h—d
;

106 
tw_audio_äame_·d_t
 *
audio_äame_·d_±r
;

107 
tw_audio_äame_·d_t
 
audio_äame_·d
;

108 
size_t
 
buf_size
;

109 
loff_t
 
buf_off£t
;

111 
buf_size
 = 
couÁ
;

112 
buf_off£t
 = 0;

113 if((
äame
!=
NULL
è&& (
buf_size
>=((
tw_äame_h—d”_t
)+(
tw_audio_äame_·d_t
)+äame->
·ylßd_Ën
))){

114 
äame_h—d”_±r
 = (
tw_äame_h—d”_t
*)
d©a
;

115 
buf_size
 -ğ(
tw_äame_h—d”_t
);

116 
buf_off£t
 +ğ(
tw_äame_h—d”_t
);

118 
	`mem£t
(&
tw_äame_h—d
, 0, (
tw_äame_h—d”_t
));

119 
tw_äame_h—d
.
codecTy³
 = 
TW_AUDIO_CODEC_TYPE
;

120 
tw_äame_h—d
.
¡»amTy³
 = 
ma¡”OrSubFÏg
;

121 
tw_äame_h—d
.
äameS”Ÿl
 = 
äame
->frameSerial;

122 
tw_äame_h—d
.
äameTy³
 = 
AUDIO_FRAME_TYPE
;

123 
tw_äame_h—d
.
timeSmp
 = 
äame
->
time¡amp
;

124 
tw_äame_h—d
.
·ylßd_off£t
 = (
tw_äame_h—d”_t
);

125 
tw_äame_h—d
.
·ylßdL’
 = 0;

127 
audio_äame_·d_±r
 = (
tw_audio_äame_·d_t
*)
äame_h—d”_±r
->
·d
;

128 
buf_size
 -ğ(
tw_audio_äame_·d_t
);

129 
buf_off£t
 +ğ(
tw_audio_äame_·d_t
);

130 
tw_äame_h—d
.
·ylßdL’
 +ğ(
tw_audio_äame_·d_t
);

132 
	`mem£t
(&
audio_äame_·d
, 0, (
tw_audio_äame_·d_t
));

133 
audio_äame_·d
.
ty³
 = 
äame
->type;

134 
audio_äame_·d
.
b™_wide
 = 
äame
->bit_wide;

135 
audio_äame_·d
.
§m¶e_¿‹
 = 
äame
->sample_rate;

136 
audio_äame_·d
.
b™_¿‹
 = 0;

137 
audio_äame_·d
.
äame_off£t
 = (
tw_audio_äame_·d_t
);

138 
	`cİy_to_u£r
(
audio_äame_·d_±r
->
Çl
, 
äame
->
d©a
, f¿me->
·ylßd_Ën
);

139 
audio_äame_·d
.
äame_size
 = 
äame
->
·ylßd_Ën
;

140 
tw_äame_h—d
.
·ylßdL’
 +ğ
audio_äame_·d
.
äame_size
;

141 
buf_size
 -ğ
audio_äame_·d
.
äame_size
;

142 
buf_off£t
 +ğ
audio_äame_·d
.
äame_size
;

144 
	`cİy_to_u£r
(
äame_h—d”_±r
->
·d
, (*)&
audio_äame_·d
, (
tw_audio_äame_·d_t
));

145 
	`cİy_to_u£r
(
äame_h—d”_±r
, &
tw_äame_h—d
, (
tw_äame_h—d”_t
));

148 *
µos
 +ğ
buf_off£t
;

149  (
size_t
)
buf_off£t
;

150 
	}
}

152 
tw_audio_·ck‘_£ùiÚ_İ”©iÚ
 
	gtw_audio_·ck‘_£ùiÚ_İ
 = {

153 .
š™
 = 
tw_audio_·ck‘_£ùiÚ_š™
,

154 .
	g»£t
 = 
tw_audio_·ck‘_£ùiÚ_»£t
,

155 .
	g»Ëa£
 = 
tw_audio_·ck‘_£ùiÚ_»Ëa£
,

156 .
	g»ã»nû
 = 
tw_audio_·ck‘_£ùiÚ_»ã»nû
,

158 .
	gdma_m­
 = 
tw_audio_·ck‘_£ùiÚ_dma_m­
,

159 .
	gdma_unm­
 = 
tw_audio_·ck‘_£ùiÚ_dma_unm­
,

161 .
	gsubm™
 = 
tw_audio_·ck‘_£ùiÚ_subm™
,

164 
	$tw_audio_·ck‘_queue_g‘
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

166 if((
audio_·ck‘_queue
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

167 
tcb_node_queue_t
 *
node_queue
;

168 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

169 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

170 if(
node_queue
->
İ
 !ğ
NULL
){

171 
tcb_node_t
 *
‹mp_node
;

172 
node_queue
->
İ
->
	`g‘
Òode_queue, &
‹mp_node
);

173 if(
‹mp_node
 !ğ
NULL
){

174 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

178 
	}
}

180 
	$tw_audio_·ck‘_queue_Œy_g‘
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

182 if((
audio_·ck‘_queue
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

183 
tcb_node_queue_t
 *
node_queue
;

184 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

185 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

186 if(
node_queue
->
İ
 !ğ
NULL
){

187 
tcb_node_t
 *
‹mp_node
;

188 
node_queue
->
İ
->
	`Œy_g‘
Òode_queue, &
‹mp_node
);

189 if(
‹mp_node
 !ğ
NULL
){

190 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

194 
	}
}

196 
	$tw_audio_·ck‘_queue_g‘_”
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

198 if((
audio_·ck‘_queue
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

199 
tcb_node_queue_t
 *
node_queue
;

200 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

201 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

202 if(
node_queue
->
İ
 !ğ
NULL
){

203 
tcb_node_t
 *
‹mp_node
;

204 
node_queue
->
İ
->
	`g‘_”
Òode_queue, &
‹mp_node
);

205 if(
‹mp_node
 !ğ
NULL
){

206 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

210 
	}
}

212 
	$tw_audio_·ck‘_queue_Œy_g‘_”
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

214 if((
audio_·ck‘_queue
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

215 
tcb_node_queue_t
 *
node_queue
;

216 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

217 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

218 if(
node_queue
->
İ
 !ğ
NULL
){

219 
tcb_node_t
 *
‹mp_node
;

220 
node_queue
->
İ
->
	`Œy_g‘_”
Òode_queue, &
‹mp_node
);

221 if(
‹mp_node
 !ğ
NULL
){

222 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

226 
	}
}

228 
	$tw_audio_·ck‘_queue_put
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
)

230 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_·ck‘_£ùiÚ
!=NULL)){

231 
tcb_node_queue_t
 *
node_queue
;

232 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

233 if(
node_queue
->
İ
 !ğ
NULL
){

234 
node_queue
->
İ
->
	`put
Òode_queue, &
audio_·ck‘_£ùiÚ
->
·ck‘_node
);

237 
	}
}

239 
	$tw_audio_·ck‘_queue_put_h—d”
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
)

241 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_·ck‘_£ùiÚ
!=NULL)){

242 
tcb_node_queue_t
 *
node_queue
;

243 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

244 if(
node_queue
->
İ
 !ğ
NULL
){

245 
node_queue
->
İ
->
	`put_h—d”
Òode_queue, &
audio_·ck‘_£ùiÚ
->
·ck‘_node
);

248 
	}
}

250 
	$tw_audio_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

252 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

253 
æags
;

254 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

255 if(
audio_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
){

256 if(
audio_chª_buf_poŞ
->
İ
 !ğ
NULL
){

257 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

258 
audio_chª_buf_poŞ
->
İ
->
	`g‘_audio_£ùiÚ_tcb
×udio_chª_buf_poŞ, &
audio_·ck‘_queue
->
cu¼_´oduûr
);

262 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

265 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

267 
	}
}

269 
	$tw_audio_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

271 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

272 
æags
;

273 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

274 if(
audio_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
){

275 if(
audio_chª_buf_poŞ
->
İ
 !ğ
NULL
){

276 
audio_chª_buf_poŞ
->
İ
->
	`Œy_g‘_audio_£ùiÚ_tcb
×udio_chª_buf_poŞ, &
audio_·ck‘_queue
->
cu¼_´oduûr
);

282 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

284 
	}
}

286 
	$tw_audio_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

288 if(
audio_·ck‘_queue
 !ğ
NULL
){

289 
æags
;

290 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

291 if(
audio_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

293 if(
audio_·ck‘_queue
->
İ
 !ğ
NULL
){

294 
audio_·ck‘_queue
->
İ
->
	`put
×udio_·ck‘_queue,‡udio_·ck‘_queue->
cu¼_´oduûr
);

296 
	`tw_audio_·ck‘_queue_put
(
audio_·ck‘_queue
,‡udio_·ck‘_queue->
cu¼_´oduûr
);

298 
audio_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

300 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

302 
	}
}

304 
	$tw_audio_·ck‘_queue_»Ëa£_cu¼_´oduûr
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

306 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

307 
æags
;

308 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

309 if(
audio_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

311 if(
audio_·ck‘_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

312 
audio_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&audio_·ck‘_queue->cu¼_´oduûr, 
audio_chª_buf_poŞ
);

314 
	`tw_audio_·ck‘_£ùiÚ_»Ëa£
(&
audio_·ck‘_queue
->
cu¼_´oduûr
, 
audio_chª_buf_poŞ
);

317 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

319 
	}
}

321 
	$tw_audio_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

323 if(
audio_·ck‘_queue
 !ğ
NULL
){

324 
æags
;

325 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

326 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

327 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

328 if(
audio_·ck‘_queue
->
İ
 !ğ
NULL
){

329 
audio_·ck‘_queue
->
İ
->
	`g‘
×udio_·ck‘_queue, &audio_·ck‘_queue->
cu¼_cÚsum”
);

331 
	`tw_audio_·ck‘_queue_g‘
(
audio_·ck‘_queue
, &audio_·ck‘_queue->
cu¼_cÚsum”
);

333 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

335 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

337 
	}
}

339 
	$tw_audio_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

341 if(
audio_·ck‘_queue
 !ğ
NULL
){

342 
æags
;

343 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

344 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

345 if(
audio_·ck‘_queue
->
İ
 !ğ
NULL
){

346 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘
×udio_·ck‘_queue, &audio_·ck‘_queue->
cu¼_cÚsum”
);

348 
	`tw_audio_·ck‘_queue_Œy_g‘
(
audio_·ck‘_queue
, &audio_·ck‘_queue->
cu¼_cÚsum”
);

351 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

353 
	}
}

355 
	$tw_audio_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

357 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

358 
æags
;

359 
	`¥š_lock_œq§ve
(&
audio_·ck‘_queue
->
lock
, 
æags
);

360 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

361 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

362 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&audio_·ck‘_queue->cu¼_cÚsum”, 
audio_chª_buf_poŞ
);

364 
	`tw_audio_·ck‘_£ùiÚ_»Ëa£
(&
audio_·ck‘_queue
->
cu¼_cÚsum”
, 
audio_chª_buf_poŞ
);

367 
	`¥š_uÆock_œq»¡Üe
(&
audio_·ck‘_queue
->
lock
, 
æags
);

369 
	}
}

371 
	$tw_audio_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

373 
’Œy_numb”
 = 0;

374 if(
audio_·ck‘_queue
 !ğ
NULL
){

375 
tcb_node_queue_t
 *
node_queue
;

376 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

377 if(
node_queue
->
İ
 !ğ
NULL
){

378 
’Œy_numb”
 = 
node_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(node_queue);

381  
’Œy_numb”
;

382 
	}
}

384 
	$tw_audio_·ck‘_queue_»Ëa£
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

386 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

387 
	`»move_tw_audio_·ck‘_queue
(
audio_·ck‘_queue
, 
audio_chª_buf_poŞ
);

389 
	}
}

391 
	$tw_audio_·ck‘_queue_š™
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

393 if(
audio_·ck‘_queue
 !ğ
NULL
){

394 
tcb_node_queue_t
 *
node_queue
;

395 
audio_·ck‘_queue
->
¡¬t_time¡amp
 = 0;

396 
audio_·ck‘_queue
->
tÙ®_du¿tiÚ
 = 0;

397 
node_queue
 = &
audio_·ck‘_queue
->
queue_node
;

398 
node_queue
->
İ
 = &
tcb_node_queue_İ
;

399 
node_queue
->
İ
->
	`š™
(node_queue);

400 
audio_·ck‘_queue
->
cu¼_cÚsum”
 = 
NULL
;

401 
audio_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

402 
	`¥š_lock_š™
(&
audio_·ck‘_queue
->
lock
);

404 
	}
}

406 
tw_audio_·ck‘_queue_İ”©iÚ
 
	gtw_audio_·ck‘_queue_İ
 = {

407 .
g‘
 = 
tw_audio_·ck‘_queue_g‘
,

408 .
	gŒy_g‘
 = 
tw_audio_·ck‘_queue_Œy_g‘
,

409 .
	gg‘_”
 = 
tw_audio_·ck‘_queue_g‘_”
,

410 .
	gŒy_g‘_”
 = 
tw_audio_·ck‘_queue_Œy_g‘_”
,

411 .
	gput
 = 
tw_audio_·ck‘_queue_put
,

412 .
	gput_h—d”
 = 
tw_audio_·ck‘_queue_put_h—d”
,

414 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_audio_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
,

415 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_audio_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

416 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_audio_·ck‘_queue_put_cu¼_´oduûr_što_queue
,

417 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_audio_·ck‘_queue_»Ëa£_cu¼_´oduûr
,

418 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_audio_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
,

419 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_audio_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

420 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_audio_·ck‘_queue_»Ëa£_cu¼_cÚsum”
,

422 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_audio_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
,

423 .
	g»Ëa£
 = 
tw_audio_·ck‘_queue_»Ëa£
,

424 .
	gš™
 = 
tw_audio_·ck‘_queue_š™
,

427 
	$š™_tw_audio_·ck‘_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
)

429 if(
audio_·ck‘_queue
 !ğ
NULL
){

430 
audio_·ck‘_queue
->
İ
 = &
tw_audio_·ck‘_queue_İ
;

431 
audio_·ck‘_queue
->
İ
->
	`š™
(audio_packet_queue);

433 
	}
}

435 
	$»move_tw_audio_·ck‘_queue
(
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
, 
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

437 if((
audio_·ck‘_queue
!=
NULL
è&& (
audio_chª_buf_poŞ
!=NULL)){

438 if(
audio_·ck‘_queue
->
İ
 !ğ
NULL
){

439 
audio_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(audio_packet_queue);

440 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, 
audio_chª_buf_poŞ
);

441 
audio_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(audio_packet_queue)){

442 
audio_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

443 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

446 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, 
audio_chª_buf_poŞ
);

449 
	`tw_audio_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
audio_·ck‘_queue
);

450 
	`tw_audio_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
audio_·ck‘_queue
, 
audio_chª_buf_poŞ
);

451 
	`tw_audio_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
audio_·ck‘_queue
)){

452 
	`tw_audio_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
audio_·ck‘_queue
);

453 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

456 
	`tw_audio_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
audio_·ck‘_queue
, 
audio_chª_buf_poŞ
);

460 
	}
}

463 
	$ü—‹_tw_audio_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
buf_Ën
)

465 
»t
 = 
TW_ERR
;

466 if(
audio_chª_buf_poŞ
 !ğ
NULL
){

467 
tcb_node_poŞ_t
 *
node_poŞ
;

468 
tw_audio_·ck‘_£ùiÚ_t
 *
±r_audio_£ùiÚ_tcb
;

469 
i
;

471 
audio_chª_buf_poŞ
->
audio_bufãr_’Œy_Üd”
 = 
	`g‘_Üd”
(
buf_Ën
);

472 
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
 = (
u8
*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,‡udio_chª_buf_poŞ->
audio_bufãr_’Œy_Üd”
);

473 if(
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
 =ğ
NULL
) {

474 
audio_chª_buf_poŞ
->
audio_bufãr_’Œy_Üd”
 = 0;

475 
	`´štk
("ÿn'ˆ®loø%d…age fÜ‡udiØbuàpoŞ\n", 
audio_chª_buf_poŞ
->
audio_bufãr_’Œy_Üd”
);

476  
»t
;

479 
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_numb”
 = (
buf_Ën
/
AUDIO_SECTION_SIZE
);

480 
node_poŞ
 = &
audio_chª_buf_poŞ
->
poŞ_node
;

481 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

482 
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
 = (
tw_audio_·ck‘_£ùiÚ_t
*)
	`km®loc
(Ñw_audio_·ck‘_£ùiÚ_t)*audio_chª_buf_poŞ->
audio_£ùiÚ_tcb_numb”
, 
GFP_KERNEL
);

483 if(
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
 =ğ
NULL
){

484 
	`ä“_·ges
(()
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
,‡udio_chª_buf_poŞ->
audio_bufãr_’Œy_Üd”
);

485 
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
 = 
NULL
;

486 
audio_chª_buf_poŞ
->
audio_bufãr_’Œy_Üd”
 = 0;

487 
	`´štk
("can't‡lloc‡udio buf sectioncb\n");

488  
»t
;

490 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_numb”
);

491 
i
=0; i<
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_numb”
; i++){

492 
±r_audio_£ùiÚ_tcb
 = &
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
[
i
];

493 
±r_audio_£ùiÚ_tcb
->
İ
 = &
tw_audio_·ck‘_£ùiÚ_İ
;

494 
±r_audio_£ùiÚ_tcb
->
audio_chª_buf_poŞ
 =‡udio_chan_buf_pool;

495 
±r_audio_£ùiÚ_tcb
->
İ
->
	`š™
ÕŒ_audio_£ùiÚ_tcb, 
audio_chª_buf_poŞ
, 
i
);

496 
±r_audio_£ùiÚ_tcb
->
İ
->
	`»Ëa£
(&±r_audio_£ùiÚ_tcb, 
audio_chª_buf_poŞ
);

498 
»t
 = 
TW_OK
;

500  
»t
;

501 
	}
}

503 
	$»Ëa£_tw_audio_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

505 if(
audio_chª_buf_poŞ
 !ğ
NULL
){

506 
tcb_node_poŞ_t
 *
poŞ_node
;

507 
poŞ_node
 = &
audio_chª_buf_poŞ
->pool_node;

508 if(
poŞ_node
->
İ
 !ğ
NULL
){

509 
poŞ_node
->
İ
->
	`»Ëa£
(pool_node);

511 if(
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
 !ğ
NULL
){

512 
	`kä“
(
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
);

513 
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_ÿche
 = 
NULL
;

515 
audio_chª_buf_poŞ
->
audio_£ùiÚ_tcb_numb”
 = 0;

517 if(
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
 !ğ
NULL
){

518 
	`ä“_·ges
(()
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
,‡udio_chª_buf_poŞ->
audio_bufãr_’Œy_Üd”
);

519 
audio_chª_buf_poŞ
->
audio_bufãr_ÿche
 = 
NULL
;

521 
audio_chª_buf_poŞ
->
audio_bufãr_’Œy_Üd”
 = 0;

523 
	}
}

525 
	$tw_audio_chª_buf_poŞ_g‘_audio_£ùiÚ_tcb
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

527 if((
audio_chª_buf_poŞ
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

528 
tcb_node_poŞ_t
 *
poŞ_node
 = &
audio_chª_buf_poŞ
->pool_node;

529 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

530 if(
poŞ_node
->
İ
 !ğ
NULL
){

531 
tcb_node_t
 *
‹mp_node
;

532 
poŞ_node
->
İ
->
	`g‘
ÕoŞ_node, &
‹mp_node
);

533 if(
‹mp_node
 !ğ
NULL
){

534 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

535 
	`©omic_šc
(&((*
±r_audio_·ck‘_£ùiÚ
)->
»f_couÁ
));

539 
	}
}

541 
	$tw_audio_chª_buf_poŞ_Œy_g‘_audio_£ùiÚ_tcb
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
tw_audio_·ck‘_£ùiÚ_t
 **
±r_audio_·ck‘_£ùiÚ
)

543 if((
audio_chª_buf_poŞ
!=
NULL
è&& (
±r_audio_·ck‘_£ùiÚ
!=NULL)){

544 
tcb_node_poŞ_t
 *
poŞ_node
 = &
audio_chª_buf_poŞ
->pool_node;

545 *
±r_audio_·ck‘_£ùiÚ
 = 
NULL
;

546 if(
poŞ_node
->
İ
 !ğ
NULL
){

547 
tcb_node_t
 *
‹mp_node
;

548 
poŞ_node
->
İ
->
	`Œy_g‘
ÕoŞ_node, &
‹mp_node
);

549 if(
‹mp_node
 !ğ
NULL
){

550 *
±r_audio_·ck‘_£ùiÚ
 = 
	`to_g‘_tw_audio_·ck‘_£ùiÚ
(
‹mp_node
);

551 
	`©omic_šc
(&((*
±r_audio_·ck‘_£ùiÚ
)->
»f_couÁ
));

555 
	}
}

557 
	$tw_audio_chª_buf_poŞ_put_audio_£ùiÚ_tcb
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
, 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_·ck‘_£ùiÚ
)

559 if((
audio_chª_buf_poŞ
!=
NULL
è&& (
audio_·ck‘_£ùiÚ
!=NULL)){

560 
tcb_node_poŞ_t
 *
poŞ_node
 = &
audio_chª_buf_poŞ
->pool_node;

561 if(
poŞ_node
->
İ
 !ğ
NULL
){

562 
poŞ_node
->
İ
->
	`put
ÕoŞ_node, &
audio_·ck‘_£ùiÚ
->
·ck‘_node
);

565 
	}
}

567 
	$tw_audio_chª_buf_poŞ_g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

569 
’Œy_numb”
 = 0;

570 if(
audio_chª_buf_poŞ
!=
NULL
){

571 
tcb_node_poŞ_t
 *
poŞ_node
 = &
audio_chª_buf_poŞ
->pool_node;

572 if(
poŞ_node
->
İ
 !ğ
NULL
){

573 
’Œy_numb”
 = 
poŞ_node
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(pool_node);

576  
’Œy_numb”
;

577 
	}
}

579 
tw_audio_chª_buf_poŞ_İ”©iÚ
 
	gtw_audio_chª_buf_poŞ_İ
 = {

580 .
ü—‹
 = 
ü—‹_tw_audio_poŞ
,

581 .
	g»Ëa£
 = 
»Ëa£_tw_audio_poŞ
,

583 .
	gg‘_audio_£ùiÚ_tcb
 = 
tw_audio_chª_buf_poŞ_g‘_audio_£ùiÚ_tcb
,

584 .
	gŒy_g‘_audio_£ùiÚ_tcb
 = 
tw_audio_chª_buf_poŞ_Œy_g‘_audio_£ùiÚ_tcb
,

585 .
	gput_audio_£ùiÚ_tcb
 = 
tw_audio_chª_buf_poŞ_put_audio_£ùiÚ_tcb
,

586 .
	gg‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
 = 
tw_audio_chª_buf_poŞ_g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
,

589 
	$š™_audio_chª_buf_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

591 
»t
 = 
TW_ERR
;

592 if(
audio_chª_buf_poŞ
 !ğ
NULL
){

593 
audio_chª_buf_poŞ
->
İ
 = &
tw_audio_chª_buf_poŞ_İ
;

594 
»t
 = 
audio_chª_buf_poŞ
->
İ
->
	`ü—‹
×udio_chª_buf_poŞ, 
AUDIO_CHAN_BUF_POOL_LEN
);

596  
»t
;

597 
	}
}

599 
	$»move_audio_chª_buf_poŞ
(
tw_audio_chª_buf_poŞ_t
 *
audio_chª_buf_poŞ
)

601 if(
audio_chª_buf_poŞ
 !ğ
NULL
){

602 if(
audio_chª_buf_poŞ
->
İ
 !ğ
NULL
){

603 
	`´štk
("%s.%d: %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_chª_buf_poŞ
->
İ
->
	`g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
(audio_chan_buf_pool));

604 
audio_chª_buf_poŞ
->
İ
->
	`»Ëa£
(audio_chan_buf_pool);

606 
	`»Ëa£_tw_audio_poŞ
(
audio_chª_buf_poŞ
);

609 
	}
}

	@../../tw5864/tw5864/tw_audio_chan_driver.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

5 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

6 
ed_tcb_t
 *
ed_tcb
;

7 
dvm_ch_t
 *
ch
;

8 
tw_audio_driv”_t
 *
audio_driv”
;

10 
ed_fsm
->
İ
->
	`»£t
(ed_fsm);

11 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

12 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

13 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
)){

14 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 0);

15 
ch
 = 
audio_driv”
->
ch_audio
->chip;

16 
ch
->
	`ch_şo£
(chip);

17 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

19 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

21  
TW_OK
;

22 
	}
}

24 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

26  
TW_OK
;

27 
	}
}

29 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

31  
TW_OK
;

32 
	}
}

34 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

36  
TW_OK
;

37 
	}
}

39 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

41 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

42 
ed_tcb_t
 *
ed_tcb
;

43 
tw_audio_driv”_t
 *
audio_driv”
;

44 
dvm_ch_t
 *
ch
;

46 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

47 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

48 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

49 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
) == 0){

50 
ed_tcb
->
ed
.
İ
->
	`š™_com¶‘e
(&ed_tcb->ed);

51 
ch
 = 
audio_driv”
->
ch_audio
->chip;

52 
ch
->
	`ch_İ’
(chip);

53 
audio_driv”
->
i_äame_£rŸl
 = 0;

54 
audio_driv”
->
disÿrd_numb”
 = 0;

55 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 1);

56 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

58 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

60  
TW_OK
;

61 
	}
}

63 
	$audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

65  
TW_OK
;

66 
	}
}

68 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

70 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

71 
ch_audio_t
 *
ch_audio
;

72 
tw_audio_driv”_t
 *
audio_driv”
;

73 
ed_tcb_t
 *
ed_tcb
;

75 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

76 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

77 
ch_audio
 = 
audio_driv”
->chip_audio;

78 
ch_audio
->
İ
->
	`upd©e_’abË_audio_chª
(ch_audio, 
audio_driv”
->
audio_logic_chª_id
, 
AUDIO_DISABLE
);

79 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_UNREGISTER
);

80 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

82  
TW_OK
;

83 
	}
}

85 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

87  
TW_OK
;

88 
	}
}

90 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

92 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

93 
tw_audio_driv”_t
 *
audio_driv”
;

94 
ed_tcb_t
 *
ed_tcb
;

96 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

97 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

98 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

99 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

101  
TW_OK
;

102 
	}
}

104 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

106 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

107 
tw_audio_driv”_t
 *
audio_driv”
;

108 
ed_tcb_t
 *
ed_tcb
;

110 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

111 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

112 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

113 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

115  
TW_OK
;

116 
	}
}

118 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

120 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

121 
tw_audio_driv”_t
 *
audio_driv”
;

123 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

124 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

125 if(
ed_fsm
->
bË
 !ğ
NULL
){

126 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

127 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm,ƒd_fsm->
cÚ‹xt
);

129 
	`´štk
("%s.%d, %d‚Ø»gi¡”‡udiØfsm sync_hook\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

132 
	`´štk
("%s.%d, %d‡udiØfsmabË i nuÎ\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

134 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

136  
TW_OK
;

137 
	}
}

139 
	$audio_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

141  
TW_OK
;

142 
	}
}

144 
	$audio_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

146 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

147 
tw_audio_driv”_t
 *
audio_driv”
;

148 
ed_tcb_t
 *
ed_tcb
;

150 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

151 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

152 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

153 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

154 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

156  
TW_OK
;

157 
	}
}

159 
	$audio_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

161  
TW_OK
;

162 
	}
}

164 
	$audio_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

166 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

167 
tw_audio_driv”_t
 *
audio_driv”
;

169 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

170 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

171 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

173  
TW_OK
;

174 
	}
}

176 
	$audio_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

178  
TW_OK
;

179 
	}
}

181 
	$audio_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

183  
TW_OK
;

184 
	}
}

186 
	$audio_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

188 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

189 
ch_audio_t
 *
ch_audio
;

190 
ch_audio_’code_t
 *
audio_’code
;

191 
dvm_ch_t
 *
ch
;

192 
tw_audio_driv”_t
 *
audio_chª_driv”
;

193 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
;

194 
tw_audio_chª_buf_poŞ_t
 *
audio_buf_poŞ
;

195 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
;

196 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

197 
d´am_»que¡_t
 *
»ad_audio_b™¡»am_»q
;

199 
audio_chª_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

200 
ch_audio
 = 
audio_chª_driv”
->chip_audio;

201 
ch
 = 
ch_audio
->chip;

202 
audio_’code
 = &
ch_audio
->audio_encode;

203 
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

204 
audio_buf_poŞ
 = &
audio_chª_driv”
->audio_buf_pool;

205 
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

206 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_h—d”_±r
×udio_£ùiÚ_·¿m, 
ch_audio
);

207 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_”_±r
×udio_£ùiÚ_·¿m, 
ch_audio
);

208 if(
audio_£ùiÚ_·¿m
->
İ
->
	`queue_ÿ·c™y
(audio_section_param)){

209 if(
audio_£ùiÚ_·¿m
->
disÿrd_numb”
 > 0){

210 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

211 
audio_£ùiÚ_·¿m
->
disÿrd_numb”
--;

212 
audio_’code
->
İ
->
	`£t_fšish_rd_±r
×udio_’code, 
audio_£ùiÚ_·¿m
->İ->
	`g‘_upd©e_fšish_id
×udio_£ùiÚ_·¿m), 
ch
);

214 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_STANDBY
);

215 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_cu¼_£ùiÚ_off£t
×udio_£ùiÚ_·¿m, 
ch_audio
);

216 
»ad_audio_b™¡»am_»q
 = &
audio_chª_driv”
->
audio_b™¡»am_»q
;

217 
	`š™_subm™_»cv_audio_b™¡»am_£rviû
(
»ad_audio_b™¡»am_»q
, 
audio_chª_driv”
);

218 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

219 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_»ad_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

224  
TW_OK
;

225 
	}
}

227 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

229 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

230 
tw_audio_driv”_t
 *
audio_driv”
;

231 
ed_tcb_t
 *
ed_tcb
;

233 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

234 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

235 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

236 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

238  
TW_OK
;

239 
	}
}

241 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

243  
TW_OK
;

244 
	}
}

246 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

248 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

249 
tw_audio_driv”_t
 *
audio_driv”
;

250 
ed_tcb_t
 *
ed_tcb
;

252 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

253 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

254 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

255 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

257  
TW_OK
;

258 
	}
}

260 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

262 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

263 
tw_audio_driv”_t
 *
audio_driv”
;

264 
ed_tcb_t
 *
ed_tcb
;

266 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

267 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

268 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

269 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

271  
TW_OK
;

272 
	}
}

274 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

276  
TW_OK
;

277 
	}
}

279 
	$audio_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

281 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

282 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_RUNNING
);

284  
TW_OK
;

285 
	}
}

287 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

289 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

290 
tw_audio_driv”_t
 *
audio_driv”
;

291 
ed_tcb_t
 *
ed_tcb
;

293 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

294 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

295 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

296 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

297 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

298 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

300  
TW_OK
;

301 
	}
}

303 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

305  
TW_OK
;

306 
	}
}

308 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

310  
TW_OK
;

311 
	}
}

313 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

315 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

316 
tw_audio_driv”_t
 *
audio_driv”
;

317 
ed_tcb_t
 *
ed_tcb
;

319 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

320 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

321 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

322 if(
ed_fsm
->
bË
 !ğ
NULL
){

323 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

324 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm, 
cÚ‹xt
);

327 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

329 
	`driv”_Œigg”_³ndšg_ev’t
(
ed_tcb
, 1);

331  
TW_OK
;

332 
	}
}

334 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

336  
TW_OK
;

337 
	}
}

339 
	$audio_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

341  
TW_OK
;

342 
	}
}

344 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

346 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

347 
tw_audio_driv”_t
 *
audio_driv”
;

348 
ed_tcb_t
 *
ed_tcb
;

350 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

351 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

352 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

353 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

355  
TW_OK
;

356 
	}
}

358 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

360  
TW_OK
;

361 
	}
}

363 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

365 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

366 
tw_audio_driv”_t
 *
audio_driv”
;

367 
ed_tcb_t
 *
ed_tcb
;

369 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

370 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

371 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

372 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

374  
TW_OK
;

375 
	}
}

377 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

379 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

380 
tw_audio_driv”_t
 *
audio_driv”
;

381 
ed_tcb_t
 *
ed_tcb
;

383 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

384 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

385 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

386 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

388  
TW_OK
;

389 
	}
}

391 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

393  
TW_OK
;

394 
	}
}

396 
	$audio_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

398 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

399 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_TRANSFERING
);

401  
TW_OK
;

402 
	}
}

404 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

406 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

407 
tw_audio_driv”_t
 *
audio_driv”
;

408 
ed_tcb_t
 *
ed_tcb
;

410 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

411 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

412 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

413 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

415  
TW_OK
;

416 
	}
}

418 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

420  
TW_OK
;

421 
	}
}

423 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

425 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

426 
tw_audio_driv”_t
 *
audio_driv”
;

427 
ed_tcb_t
 *
ed_tcb
;

429 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

430 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

431 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

432 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

434  
TW_OK
;

435 
	}
}

437 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

439 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

440 
tw_audio_driv”_t
 *
audio_driv”
;

441 
ed_tcb_t
 *
ed_tcb
;

443 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

444 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

445 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

446 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

448  
TW_OK
;

449 
	}
}

451 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

453  
TW_OK
;

454 
	}
}

456 
	$audio_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

458 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

459 
ed_tcb_t
 *
ed_tcb
;

461 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

462 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

463 
	`driv”_Œigg”_³ndšg_ev’t
(
ed_tcb
, 1);

465  
TW_OK
;

466 
	}
}

468 
	$audio_’code_driv”_sync_hook
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

470 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

471 
ed_tcb_t
 *
ed_tcb
;

472 
tw_audio_driv”_t
 *
audio_driv”
;

473 
ch_audio_t
 *
ch_audio
;

474 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

475 
ch_audio_’code_t
 *
audio_’code
;

477 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

478 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

479 
ch_audio
 = 
audio_driv”
->chip_audio;

480 
audio_’code
 = &
ch_audio
->audio_encode;

481 
cÚfig_·¿m
 = &
audio_’code
->config_param;

482 
	`»£t_tw5864_audio_’code_chª
(
audio_driv”
);

483 
cÚfig_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_§m¶e_¿‹
(config_param));

484 
cÚfig_·¿m
->
İ
->
	`upd©e_b™_wide
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_b™_wide
(config_param));

485 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_ty³
(config_param));

486 
ch_audio
->
İ
->
	`upd©e_’abË_audio_chª
(ch_audio, 
audio_driv”
->
audio_logic_chª_id
, 
AUDIO_ENABLE
);

488  
TW_OK
;

489 
	}
}

491 
fsm_¡©e_Œªsãr_m©rix_bË_t
 
	gaudio_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
 = {

492 .
aùiÚ
 = {

494 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
,

495 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
,

496 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
,

497 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
,

498 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
,

499 
audio_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t


502 
audio_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
,

503 
audio_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
,

504 
audio_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
,

505 
audio_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
,

506 
audio_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
,

507 
audio_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t


510 
audio_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
,

511 
audio_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
,

512 
audio_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
,

513 
audio_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
,

514 
audio_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
,

515 
audio_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t


518 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
,

519 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
,

520 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
,

521 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
,

522 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
,

523 
audio_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t


526 
audio_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
,

527 
audio_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
,

528 
audio_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
,

529 
audio_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
,

530 
audio_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
,

531 
audio_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t


534 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
,

535 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
,

536 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
,

537 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
,

538 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
,

539 
audio_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t


542 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
,

543 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
,

544 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
,

545 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
,

546 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
,

547 
audio_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t


550 .
	gsync_hook
 = 
audio_’code_driv”_sync_hook
,

553 
	$tw_audio_’code_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
ed_tcb
)

555 
tw_audio_driv”_t
 *
audio_driv”
;

556 
»t
 = 
TW_ERR
;

557 if(
ed_tcb
 !ğ
NULL
){

558 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

559 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
)){

560  
»t
;

563 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

564 
»t
 = 
TW_OK
;

566  
»t
;

567 
	}
}

569 
	$tw_audio_’code_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
ed_tcb
)

571 
tw_audio_driv”_t
 *
audio_driv”
;

572 
»t
 = 
TW_ERR
;

573 if(
ed_tcb
 !ğ
NULL
){

574 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

575 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

576 
ed_tcb
->
ed
.
İ
->
	`wa™_com¶‘e
(&ed_tcb->ed);

577 
	`»move_tw_audio_·ck‘_queue
(&
audio_driv”
->
audio_·ck‘_queue
, &audio_driv”->
audio_buf_poŞ
);

578 
»t
 = 
TW_OK
;

580  
»t
;

581 
	}
}

583 
	$tw_audio_’code_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
ed_tcb
)

585 if(
ed_tcb
 !ğ
NULL
){

588 
	}
}

590 
	$tw_audio_’code_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
ed_tcb
)

592 if(
ed_tcb
 !ğ
NULL
){

595 
	}
}

597 
	$tw_audio_’code_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
ed_tcb
, 
cmd
, 
¬g
)

599 
tw_audio_driv”_t
 *
audio_driv”
;

600 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

601 
tw_ch_audio_·¿m
 
audio_·¿m
;

602 
ch_audio_’code_t
 *
audio_’code
;

603 
»t
 = 
TW_OK
, 
sync_æag
 = 0;

605 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

606 if(
ed_tcb
) {

607 
cmd
) {

608 
TW_CHIP_AUDIO_ENCODE_PARAM_SET
:

609 
	`cİy_äom_u£r
(&
audio_·¿m
, (*)
¬g
, (
tw_ch_audio_·¿m
));

610 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

611 
audio_’code
 = &
audio_driv”
->
ch_audio
->audio_encode;

612 
cÚfig_·¿m
 = &
audio_’code
->config_param;

613 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
) {

614 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_b™_wide
(cÚfig_·¿m, 
audio_·¿m
.
i_b™_wide
);

615 
sync_æag
 = 1;

617 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
) {

618 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
(cÚfig_·¿m, 
audio_·¿m
.
i_§m¶e_¿‹
);

619 
sync_æag
 = 1;

621 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
) {

622 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
audio_·¿m
.
e_audio_ty³
);

623 
sync_æag
 = 1;

625 if(
sync_æag
){

626 
ed_tcb
->
ed_fsm
.
İ
->
	`upd©e_Ãed_sync_hook
(&ed_tcb->ed_fsm, 1);

628 if(
»t
) {

629 
	`TW_DBG
(
TW_DBG_ERR
, "audioƒncoder…arameter isƒrror\n");

630 
»t
 = -
EINVAL
;

633 
TW_CHIP_AUDIO_ENCODE_PARAM_GET
:

634 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

635 
audio_’code
 = &
audio_driv”
->
ch_audio
->audio_encode;

636 
cÚfig_·¿m
 = &
audio_’code
->config_param;

637 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
) {

638 
audio_·¿m
.
i_b™_wide
 = 
cÚfig_·¿m
->
İ
->
	`g‘_b™_wide
(config_param);

640 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
) {

641 
audio_·¿m
.
i_§m¶e_¿‹
 = 
cÚfig_·¿m
->
İ
->
	`g‘_§m¶e_¿‹
(config_param);

643 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_ENCODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
) {

644 
audio_·¿m
.
e_audio_ty³
 = 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param);

646 
	`cİy_to_u£r
((*)
¬g
, &
audio_·¿m
, (
tw_ch_audio_·¿m
));

647 
»t
 = 
TW_OK
;

649 
TW_LOGIC_CHAN_ENABLE_SET
:

650 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

651 
	`TW_DBG
(
TW_DBG_INFO
, "»sumaudiØchªÃÈ%d\n", 
audio_driv”
->
audio_logic_chª_id
);

652 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

653 
»t
 = 
TW_OK
;

655 
TW_LOGIC_CHAN_DISABLE_SET
:

656 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

657 
	`TW_DBG
(
TW_DBG_INFO
, "su¥’d‡udiØchªÃÈ%d\n", 
audio_driv”
->
audio_logic_chª_id
);

658 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 1);

659 
»t
 = 
TW_OK
;

662 
	`TW_DBG
(
TW_DBG_ERR
, "bad command\n");

663 
»t
 = -
EBADRQC
;

668  
»t
;

669 
	}
}

671 
	$tw_audio_’code_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
ed_tcb
)

673 
»t
 = 
TW_ED_UNREGISTER
;

674 if(
ed_tcb
 !ğ
NULL
){

675 
»t
 = 
ed_tcb
->
ed_fsm
.
İ
->
	`g‘_cu¼_¡©e
(&ed_tcb->ed_fsm);

677  
»t
;

678 
	}
}

680 
tw_hcd_š‹rçû_İ”©iÚ
 
	gtw_audio_’code_hcd_š‹rçû_İ
 = {

681 .
İ’
 = 
tw_audio_’code_hcd_š‹rçû_İ’
,

682 .
	gşo£
 = 
tw_audio_’code_hcd_š‹rçû_şo£
,

683 .
	gsu¥’d
 = 
tw_audio_’code_hcd_š‹rçû_su¥’d
,

684 .
	g»sume
 = 
tw_audio_’code_hcd_š‹rçû_»sume
,

685 .
	gioùl
 = 
tw_audio_’code_hcd_š‹rçû_ioùl
,

686 .
	gg‘_¡©e
 = 
tw_audio_’code_hcd_š‹rçû_g‘_¡©e
,

689 
	$audio_’code_£ùiÚ_·¿m_š™
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

691 if(
audio_£ùiÚ_·¿m
 !ğ
NULL
) {

692 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

693 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

694 
audio_£ùiÚ_·¿m
->
Ï¡_audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

695 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

696 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 = 0;

697 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

698 
audio_£ùiÚ_·¿m
->
disÿrd_numb”
 = 
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
;

700 
	}
}

702 
	$audio_’code_£ùiÚ_·¿m_upd©e_h—d”_±r
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

704 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

705 
ch_audio_’code_t
 *
audio_’code
;

706 
tw_audio_driv”_t
 *
audio_driv”
;

707 
chª_id
;

708 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

709 
chª_id
 = 
audio_driv”
->
audio_logic_chª_id
;

710 
audio_’code
 = &
ch_audio
->audio_encode;

711 if(
audio_’code
->
İ
 !ğ
NULL
){

712 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
audio_’code
->
İ
->
	`g‘_audio_’code_chª_wr_±r
×udio_’code, 
chª_id
, &audio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
, &audio_£ùiÚ_·¿m->
£ùiÚ_queue_size
);

714 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

715 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

716 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

719 
	}
}

721 
	$audio_’code_£ùiÚ_·¿m_upd©e_”_±r
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

723 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

724 
ch_audio_’code_t
 *
audio_’code
;

725 
tw_audio_driv”_t
 *
audio_driv”
;

726 
chª_id
;

728 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

729 
chª_id
 = 
audio_driv”
->
audio_logic_chª_id
;

730 
audio_’code
 = &
ch_audio
->audio_encode;

731 if(
audio_’code
->
İ
 !ğ
NULL
) {

732 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
audio_’code
->
İ
->
	`g‘_audio_’code_chª_rd_±r
×udio_’code, 
chª_id
, &audio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_”_±r_ext_æag
, &audio_£ùiÚ_·¿m->
£ùiÚ_queue_size
);

734 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

735 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 = 0;

736 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

739 
	}
}

741 
	$audio_’code_£ùiÚ_·¿m_queue_ÿ·c™y
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

743 
»t
 = 0;

744 if(
audio_£ùiÚ_·¿m
 !ğ
NULL
) {

745 if(
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 > 0) {

746 
tw_audio_driv”_t
 *
audio_driv”
;

747 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

748 if(
	`©omic_»ad
(&
audio_driv”
->
audio_sync_disÿrd_numb”
) > 0){

749 
	`©omic_dec
(&
audio_driv”
->
audio_sync_disÿrd_numb”
);

751 
»t
 = 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 +‡udio_£ùiÚ_·¿m->
£ùiÚ_queue_size
 -‡udio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_”_±r
;

752 
»t
 %ğ
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
;

753 if(
»t
 == 0){

754 if(
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 !ğaudio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
){

755 
»t
 = 1;

757 } ià(
»t
 < 2){

758 
»t
 = 0;

760 
»t
 = 1;

764 
	`´štk
("%s.%d: queusizi 0\n", 
__FILE__
, 
__LINE__
);

767  
»t
;

768 
	}
}

770 
	$audio_’code_£ùiÚ_·¿m_upd©e_cu¼_£ùiÚ_off£t
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

772 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

773 
tw_audio_driv”_t
 *
audio_driv”
;

774 
ch_audio_’code_t
 *
audio_’code
;

775 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

776 
audio_pcm_’code_d©a_addr_t
 *
pcm_audio_d©a_ba£
;

777 
audio_adpcm_’code_d©a_addr_t
 *
adpcm_audio_d©a_ba£
;

778 
chª_id
;

780 if(
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 > 0) {

781 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

782 
chª_id
 = 
audio_driv”
->
audio_logic_chª_id
;

783 
audio_’code
 = &
ch_audio
->audio_encode;

784 
cÚfig_·¿m
 = &
audio_’code
->config_param;

785 if(
cÚfig_·¿m
->
İ
!ğ
NULL
){

786 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

787 
TW_AUDIO_PCM
:

788 
pcm_audio_d©a_ba£
 = &
audio_’code
->pcm_audio_data_base;

789 if(
pcm_audio_d©a_ba£
->
İ
 !ğ
NULL
) {

790 
pcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_pcm_ty³
(pcm_audio_data_base);

791 
pcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_chª_id
Õcm_audio_d©a_ba£, 
chª_id
);

792 
pcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_id
Õcm_audio_d©a_ba£, 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
);

793 
pcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_off£t
(pcm_audio_data_base, 0);

794 
audio_£ùiÚ_·¿m
->
·ge_id
 = 
pcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_·ge_id
(pcm_audio_data_base);

795 
audio_£ùiÚ_·¿m
->
ch_a_Ü_b
 = 
pcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_š_ch_a_Ü_b
(pcm_audio_data_base);

796 
audio_£ùiÚ_·¿m
->
ddr_’d_addr
 = 
pcm_audio_d©a_ba£
->
İ
->
	`g‘_pcm_’code_d©a_addr_š_ddr_’d_off£t
(pcm_audio_data_base);

799 
TW_AUDIO_ADPCM_32K
:

800 
adpcm_audio_d©a_ba£
 = &
audio_’code
->adpcm_audio_data_base;

801 if(
adpcm_audio_d©a_ba£
->
İ
 !ğ
NULL
) {

802 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_chª_id
×dpcm_audio_d©a_ba£, 
chª_id
);

803 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_adpcm_ty³
(adpcm_audio_data_base);

804 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_id
×dpcm_audio_d©a_ba£, 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
);

805 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_off£t
(adpcm_audio_data_base, 0);

806 
audio_£ùiÚ_·¿m
->
·ge_id
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_·ge_id
(adpcm_audio_data_base);

807 
audio_£ùiÚ_·¿m
->
ch_a_Ü_b
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_š_ch_a_Ü_b
(adpcm_audio_data_base);

808 
audio_£ùiÚ_·¿m
->
ddr_’d_addr
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_adpcm_’code_d©a_addr_š_ddr_’d_off£t
(adpcm_audio_data_base);

812 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

818 
	}
}

820 
	$audio_’code_£ùiÚ_·¿m_g‘_upd©e_fšish_id
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

822 
tw_audio_driv”_t
 *
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

823  
audio_driv”
->
audio_logic_chª_id
;

824 
	}
}

826 
audio_£ùiÚ_±r_šfo_İ”©iÚ
 
	gaudio_’code_£ùiÚ_·¿m_İ
 = {

827 .
š™
 = 
audio_’code_£ùiÚ_·¿m_š™
,

828 .
	gupd©e_h—d”_±r
 = 
audio_’code_£ùiÚ_·¿m_upd©e_h—d”_±r
,

829 .
	gupd©e_”_±r
 = 
audio_’code_£ùiÚ_·¿m_upd©e_”_±r
,

830 .
	gqueue_ÿ·c™y
 = 
audio_’code_£ùiÚ_·¿m_queue_ÿ·c™y
,

831 .
	gupd©e_cu¼_£ùiÚ_off£t
 = 
audio_’code_£ùiÚ_·¿m_upd©e_cu¼_£ùiÚ_off£t
,

832 .
	gg‘_upd©e_fšish_id
 = 
audio_’code_£ùiÚ_·¿m_g‘_upd©e_fšish_id
,

835 
	$audio_’code_chª_driv”_£ùiÚ_š™
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

837 if(
audio_£ùiÚ_·¿m
 !ğ
NULL
){

838 
audio_£ùiÚ_·¿m
->
İ
 = &
audio_’code_£ùiÚ_·¿m_İ
;

839 
audio_£ùiÚ_·¿m
->
İ
->
	`š™
(audio_section_param);

841 
	}
}

843 
	$»£t_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
)

845 if(
audio_driv”
 !ğ
NULL
){

846 
	`audio_’code_chª_driv”_£ùiÚ_š™
(&
audio_driv”
->
audio_£ùiÚ_·¿m
);

847 
audio_driv”
->
time¡amp
.
İ
->
	`»£t
(&audio_driver->timestamp);

848 
	`©omic_£t
(&
audio_driv”
->
audio_sync_disÿrd_numb”
, 20);

850 
	}
}

852 
	$š™_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
, 
ch_audio_t
 *
ch_audio
, 
bus_id
, 
ch_id
, 
group_chª_id
)

854 
ed_tcb_t
 *
ed
;

855 
»t
 = 
TW_ERR
;

856 if(
audio_driv”
 !ğ
NULL
){

857 
	`š™_tw5864_’code_time¡amp
(&
audio_driv”
->
time¡amp
);

858 
»t
 = 
	`š™_audio_chª_buf_poŞ
(&
audio_driv”
->
audio_buf_poŞ
);

859 
	`š™_tw_audio_·ck‘_queue
(&
audio_driv”
->
audio_·ck‘_queue
);

860 
audio_driv”
->
ty³
 = 
TW_AUDIO_ENCODE
;

861 
ed
 = &
audio_driv”
->
audio_ed
;

862 
ed
->
İ
 = &
tw_audio_’code_hcd_š‹rçû_İ
;

863 
	`š™_’dpošt_tcb
(
ed
, 
bus_id
, 
ch_id
, 
TW_ED_AUDIO_ENCODE_IN
, 
group_chª_id
, 0, 
audio_driv”
, 
NULL
, NULL, &
audio_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
);

864 
audio_driv”
->
audio_logic_chª_id
 = 
group_chª_id
;

865 
audio_driv”
->
ch_audio
 = chip_audio;

866 
audio_driv”
->
tw_deviû_chª
 = 
NULL
;

867 
	`š™_d´am_»que¡_£rviû_tcb
(&
audio_driv”
->
audio_b™¡»am_»q
);

868 
	`»£t_tw5864_audio_’code_chª
(
audio_driv”
);

869 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 0);

871  
»t
;

872 
	}
}

874 
	$»move_tw5864_audio_’code_chª
(
tw_audio_driv”_t
 *
audio_driv”
)

876 if(
audio_driv”
 !ğ
NULL
){

877 
ed_tcb_t
 *
ed
;

878 
ed
 = &
audio_driv”
->
audio_ed
;

879 
ed
->
İ
->
	`şo£
(ed);

880 
	`»move_audio_chª_buf_poŞ
(&
audio_driv”
->
audio_buf_poŞ
);

882 
	}
}

884 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

886 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

887 
ed_tcb_t
 *
ed_tcb
;

888 
dvm_ch_t
 *
ch
;

889 
tw_audio_driv”_t
 *
audio_driv”
;

890 
ch_audio_t
 *
ch_audio
;

892 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

893 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

894 
ch_audio
 = 
audio_driv”
->chip_audio;

895 
ch_audio
->
İ
->
	`upd©e_’abË_audio_chª
(ch_audio, 
audio_driv”
->
audio_logic_chª_id
, 
AUDIO_DISABLE
);

896 
ed_fsm
->
İ
->
	`»£t
(ed_fsm);

897 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
)){

898 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 0);

899 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

900 
ch
 = 
audio_driv”
->
ch_audio
->chip;

901 
ch
->
	`ch_şo£
(chip);

903 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

905  
TW_OK
;

906 
	}
}

908 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

910  
TW_OK
;

911 
	}
}

913 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

915  
TW_OK
;

916 
	}
}

918 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

920  
TW_OK
;

921 
	}
}

923 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

925 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

926 
ed_tcb_t
 *
ed_tcb
;

927 
tw_audio_driv”_t
 *
audio_driv”
;

928 
dvm_ch_t
 *
ch
;

930 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

931 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

932 
ch
 = 
audio_driv”
->
ch_audio
->chip;

933 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
) == 0){

934 
ed_tcb
->
ed
.
İ
->
	`š™_com¶‘e
(&ed_tcb->ed);

935 
ch
->
	`ch_İ’
(chip);

936 
	`»£t_tw5864_audio_decode_chª
(
audio_driv”
);

937 
audio_driv”
->
i_äame_£rŸl
 = 0;

938 
audio_driv”
->
disÿrd_numb”
 = 0;

939 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 1);

940 
ed_fsm
->
İ
->
	`»£t
(ed_fsm);

941 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

943 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

944 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

946  
TW_OK
;

947 
	}
}

949 
	$audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

951 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

952 
ed_tcb_t
 *
ed_tcb
;

953 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

954 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

956  
TW_OK
;

957 
	}
}

959 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

961 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

962 
ed_tcb_t
 *
ed_tcb
;

963 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

964 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_UNREGISTER
);

965 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

967  
TW_OK
;

968 
	}
}

970 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

972  
TW_OK
;

973 
	}
}

975 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

977  
TW_OK
;

978 
	}
}

980 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

982  
TW_OK
;

983 
	}
}

985 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

987 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

988 
tw_audio_driv”_t
 *
audio_driv”
;

990 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

991 
	`´štk
("%s.%d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

992 if(
ed_fsm
->
bË
 !ğ
NULL
){

993 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

994 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm,ƒd_fsm->
cÚ‹xt
);

996 
	`´štk
("%s.%d, %d‚Ø»gi¡”‡udiØfsm sync_hook\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

999 
	`´štk
("%s.%d, %d‡udiØfsmabË i nuÎ\n", 
__FUNCTION__
, 
__LINE__
, 
audio_driv”
->
audio_logic_chª_id
);

1001 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

1004  
TW_OK
;

1005 
	}
}

1007 
	$audio_decode_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1009 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1010 
ed_tcb_t
 *
ed_tcb
;

1011 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1012 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

1014  
TW_OK
;

1015 
	}
}

1017 
	$audio_decode_driv”_š_idË_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1019 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1020 
ed_tcb_t
 *
ed_tcb
;

1021 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1022 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

1023 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

1025  
TW_OK
;

1026 
	}
}

1028 
	$audio_decode_driv”_š_idË_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1030  
TW_OK
;

1031 
	}
}

1033 
	$audio_decode_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1035 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1036 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

1038  
TW_OK
;

1039 
	}
}

1041 
	$audio_decode_driv”_š_idË_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1043  
TW_OK
;

1044 
	}
}

1046 
	$audio_decode_driv”_š_idË_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1048  
TW_OK
;

1049 
	}
}

1051 
	$audio_decode_driv”_š_idË_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1053 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1054 
ch_audio_t
 *
ch_audio
;

1055 
dvm_ch_t
 *
ch
;

1056 
tw_audio_driv”_t
 *
audio_chª_driv”
;

1057 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
;

1058 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
;

1059 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

1060 
d´am_»que¡_t
 *
£nd_audio_b™¡»am_»q
;

1062 
audio_chª_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

1063 
ch_audio
 = 
audio_chª_driv”
->chip_audio;

1064 
ch
 = 
ch_audio
->chip;

1065 
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

1066 
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

1067 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_h—d”_±r
×udio_£ùiÚ_·¿m, 
ch_audio
);

1068 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_”_±r
×udio_£ùiÚ_·¿m, 
ch_audio
);

1069 if(
audio_£ùiÚ_·¿m
->
İ
->
	`queue_ÿ·c™y
(audio_section_param)){

1070 
audio_£ùiÚ_·¿m
->
İ
->
	`upd©e_cu¼_£ùiÚ_off£t
×udio_£ùiÚ_·¿m, 
ch_audio
);

1071 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_STANDBY
);

1072 
£nd_audio_b™¡»am_»q
 = &
audio_chª_driv”
->
audio_b™¡»am_»q
;

1073 
	`š™_subm™_£nd_audio_b™¡»am_£rviû
(
£nd_audio_b™¡»am_»q
, 
audio_chª_driv”
);

1074 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

1075 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_wr™e_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

1078  
TW_OK
;

1079 
	}
}

1081 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1083 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1084 
ed_tcb_t
 *
ed_tcb
;

1085 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1086 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

1088  
TW_OK
;

1089 
	}
}

1091 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1093  
TW_OK
;

1094 
	}
}

1096 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1098 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1099 
ed_tcb_t
 *
ed_tcb
;

1100 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1101 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

1103  
TW_OK
;

1104 
	}
}

1106 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1108 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1109 
ed_tcb_t
 *
ed_tcb
;

1110 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1111 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

1113  
TW_OK
;

1114 
	}
}

1116 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1118  
TW_OK
;

1119 
	}
}

1121 
	$audio_decode_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1123 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1124 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_RUNNING
);

1126  
TW_OK
;

1127 
	}
}

1129 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1131 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1132 
ed_tcb_t
 *
ed_tcb
;

1133 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1134 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

1135 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

1137  
TW_OK
;

1138 
	}
}

1140 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1142  
TW_OK
;

1143 
	}
}

1145 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1147  
TW_OK
;

1148 
	}
}

1150 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1152 
	`´štk
("%s,%d\n", 
__FUNCTION__
, 
__LINE__
);

1153 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1154 if(
ed_fsm
->
bË
 !ğ
NULL
){

1155 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

1156 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm, 
cÚ‹xt
);

1159 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

1161  
TW_OK
;

1162 
	}
}

1164 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1166  
TW_OK
;

1167 
	}
}

1169 
	$audio_decode_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1171  
TW_OK
;

1172 
	}
}

1174 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1176 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1177 
ed_tcb_t
 *
ed_tcb
;

1178 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1179 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

1181  
TW_OK
;

1182 
	}
}

1184 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1186  
TW_OK
;

1187 
	}
}

1189 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1191 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1192 
ed_tcb_t
 *
ed_tcb
;

1193 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1194 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

1196  
TW_OK
;

1197 
	}
}

1199 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1201 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1202 
ed_tcb_t
 *
ed_tcb
;

1203 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1204 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

1206  
TW_OK
;

1207 
	}
}

1209 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1211  
TW_OK
;

1212 
	}
}

1214 
	$audio_decode_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1216 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1217 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_TRANSFERING
);

1219  
TW_OK
;

1220 
	}
}

1222 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1224 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1225 
ed_tcb_t
 *
ed_tcb
;

1226 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1227 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

1229  
TW_OK
;

1230 
	}
}

1232 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1234  
TW_OK
;

1235 
	}
}

1237 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1239 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1240 
ed_tcb_t
 *
ed_tcb
;

1241 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1242 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

1244  
TW_OK
;

1245 
	}
}

1247 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1249 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1250 
ed_tcb_t
 *
ed_tcb
;

1251 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1252 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

1254  
TW_OK
;

1255 
	}
}

1257 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1259  
TW_OK
;

1260 
	}
}

1262 
	$audio_decode_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1264 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1265 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

1266 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

1268  
TW_OK
;

1269 
	}
}

1271 
	$audio_decode_driv”_sync_hook
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

1273 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

1274 
ed_tcb_t
 *
ed_tcb
;

1275 
tw_audio_driv”_t
 *
audio_driv”
;

1276 
ch_audio_t
 *
ch_audio
;

1277 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1278 
ch_audio_decode_t
 *
audio_decode
;

1280 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

1281 
audio_driv”
 = (
tw_audio_driv”_t
*)
cÚ‹xt
;

1282 
ch_audio
 = 
audio_driv”
->chip_audio;

1283 
audio_decode
 = &
ch_audio
->audio_decode;

1284 
cÚfig_·¿m
 = &
audio_decode
->config_param;

1285 
	`»£t_tw5864_audio_decode_chª
(
audio_driv”
);

1286 
cÚfig_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_§m¶e_¿‹
(config_param));

1287 
cÚfig_·¿m
->
İ
->
	`upd©e_b™_wide
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_b™_wide
(config_param));

1288 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, cÚfig_·¿m->İ->
	`g‘_ty³
(config_param));

1289 
ch_audio
->
İ
->
	`upd©e_’abË_audio_chª
(ch_audio, 
audio_driv”
->
audio_logic_chª_id
, 
AUDIO_ENABLE
);

1291  
TW_OK
;

1292 
	}
}

1294 
fsm_¡©e_Œªsãr_m©rix_bË_t
 
	gaudio_decode_driv”_fsm_¡©e_Œªsãr_m©rix_bË
 = {

1295 .
aùiÚ
 = {

1297 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
,

1298 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
,

1299 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
,

1300 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
,

1301 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
,

1302 
audio_decode_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t


1305 
audio_decode_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
,

1306 
audio_decode_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
,

1307 
audio_decode_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
,

1308 
audio_decode_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
,

1309 
audio_decode_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
,

1310 
audio_decode_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t


1313 
audio_decode_driv”_š_idË_¡©e_»cv_şo£_ev’t
,

1314 
audio_decode_driv”_š_idË_¡©e_»cv_timeout_ev’t
,

1315 
audio_decode_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
,

1316 
audio_decode_driv”_š_idË_¡©e_»cv_»sume_ev’t
,

1317 
audio_decode_driv”_š_idË_¡©e_»cv_İ’_ev’t
,

1318 
audio_decode_driv”_š_idË_¡©e_»cv_d–iv”_ev’t


1321 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
,

1322 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
,

1323 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
,

1324 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
,

1325 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
,

1326 
audio_decode_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t


1329 
audio_decode_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
,

1330 
audio_decode_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
,

1331 
audio_decode_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
,

1332 
audio_decode_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
,

1333 
audio_decode_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
,

1334 
audio_decode_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t


1337 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
,

1338 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
,

1339 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
,

1340 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
,

1341 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
,

1342 
audio_decode_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t


1345 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
,

1346 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
,

1347 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
,

1348 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
,

1349 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
,

1350 
audio_decode_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t


1353 .
	gsync_hook
 = 
audio_decode_driv”_sync_hook
,

1356 
	$tw_audio_decode_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
ed_tcb
)

1358 
tw_audio_driv”_t
 *
audio_driv”
;

1359 
»t
 = 
TW_ERR
;

1360 if(
ed_tcb
 !ğ
NULL
){

1361 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1362 if(
	`©omic_»ad
(&
audio_driv”
->
İ’ed_æag
)){

1363  
»t
;

1365 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

1366 
»t
 = 
TW_OK
;

1368  
»t
;

1369 
	}
}

1371 
	$tw_audio_decode_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
ed_tcb
)

1373 
tw_audio_driv”_t
 *
audio_driv”
;

1374 
»t
 = 
TW_ERR
;

1375 if(
ed_tcb
 !ğ
NULL
){

1376 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1377 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

1378 
ed_tcb
->
ed
.
İ
->
	`wa™_com¶‘e
(&ed_tcb->ed);

1379 
	`»move_tw_audio_·ck‘_queue
(&
audio_driv”
->
audio_·ck‘_queue
, &audio_driv”->
audio_buf_poŞ
);

1380 
»t
 = 
TW_OK
;

1382  
»t
;

1383 
	}
}

1385 
	$tw_audio_decode_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
ed_tcb
)

1387 if(
ed_tcb
 !ğ
NULL
){

1390 
	}
}

1392 
	$tw_audio_decode_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
ed_tcb
)

1394 if(
ed_tcb
 !ğ
NULL
){

1397 
	}
}

1399 
	$tw_audio_decode_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
ed_tcb
, 
cmd
, 
¬g
)

1401 
tw_audio_driv”_t
 *
audio_driv”
;

1402 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1403 
tw_ch_audio_·¿m
 
audio_·¿m
;

1404 
ch_audio_decode_t
 *
audio_decode
;

1405 
»t
 = 0;

1407 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

1408 if(
ed_tcb
 && 
¬g
) {

1409 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1410 
cmd
) {

1411 
TW_CHIP_AUDIO_DECODE_PARAM_SET
:

1412 
	`cİy_äom_u£r
(&
audio_·¿m
, (*)
¬g
, (
tw_ch_audio_·¿m
));

1413 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1414 
audio_decode
 = &
audio_driv”
->
ch_audio
->audio_decode;

1415 
cÚfig_·¿m
 = &
audio_decode
->config_param;

1416 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
) {

1417 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_b™_wide
(cÚfig_·¿m, 
audio_·¿m
.
i_b™_wide
);

1419 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
) {

1420 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
(cÚfig_·¿m, 
audio_·¿m
.
i_§m¶e_¿‹
);

1422 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
) {

1423 
»t
 |ğ
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
audio_·¿m
.
e_audio_ty³
);

1425 if(
»t
) {

1426 
	`TW_DBG
(
TW_DBG_ERR
, "audioƒncoder…arameter isƒrror\n");

1427 
»t
 = -
EINVAL
;

1430 
TW_CHIP_AUDIO_DECODE_PARAM_GET
:

1431 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1432 
audio_decode
 = &
audio_driv”
->
ch_audio
->audio_decode;

1433 
cÚfig_·¿m
 = &
audio_decode
->config_param;

1434 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_BIT_WIDE_MASK
) {

1435 
audio_·¿m
.
i_b™_wide
 = 
cÚfig_·¿m
->
İ
->
	`g‘_b™_wide
(config_param);

1437 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_SAMPLE_RATE_MASK
) {

1438 
audio_·¿m
.
i_§m¶e_¿‹
 = 
cÚfig_·¿m
->
İ
->
	`g‘_§m¶e_¿‹
(config_param);

1440 if(
audio_·¿m
.
chªge_mask_æag
 & 
TW_CHIP_AUDIO_DECODE_PARAM_ENABLE_CHANGE_ENCODE_TYPE_MASK
) {

1441 
audio_·¿m
.
e_audio_ty³
 = 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param);

1443 
	`cİy_to_u£r
((*)
¬g
, &
audio_·¿m
, (
tw_ch_audio_·¿m
));

1444 
»t
 = 
TW_OK
;

1446 
TW_LOGIC_CHAN_ENABLE_SET
:

1447 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1448 
	`TW_DBG
(
TW_DBG_INFO
, "»sumaudiØchªÃÈ%d\n", 
audio_driv”
->
audio_logic_chª_id
);

1449 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

1450 
»t
 = 
TW_OK
;

1452 
TW_LOGIC_CHAN_DISABLE_SET
:

1453 
audio_driv”
 = 
	`to_tw_audio_chª_driv”_w™h_audio_ed
(
ed_tcb
);

1454 
	`TW_DBG
(
TW_DBG_INFO
, "su¥’d‡udiØchªÃÈ%d\n", 
audio_driv”
->
audio_logic_chª_id
);

1455 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 1);

1456 
»t
 = 
TW_OK
;

1459 
»t
 = -
EBADRQC
;

1464  
»t
;

1465 
	}
}

1467 
	$tw_audio_decode_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
ed_tcb
)

1469 
»t
 = 
TW_ED_UNREGISTER
;

1470 if(
ed_tcb
 !ğ
NULL
){

1471 
»t
 = 
	`©omic_»ad
(&
ed_tcb
->
¡©e
);

1473  
»t
;

1474 
	}
}

1476 
tw_hcd_š‹rçû_İ”©iÚ
 
	gtw_audio_decode_hcd_š‹rçû_İ
 = {

1477 .
İ’
 = 
tw_audio_decode_hcd_š‹rçû_İ’
,

1478 .
	gşo£
 = 
tw_audio_decode_hcd_š‹rçû_şo£
,

1479 .
	gsu¥’d
 = 
tw_audio_decode_hcd_š‹rçû_su¥’d
,

1480 .
	g»sume
 = 
tw_audio_decode_hcd_š‹rçû_»sume
,

1481 .
	gioùl
 = 
tw_audio_decode_hcd_š‹rçû_ioùl
,

1482 .
	gg‘_¡©e
 = 
tw_audio_decode_hcd_š‹rçû_g‘_¡©e
,

1485 
	$audio_decode_£ùiÚ_·¿m_š™
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

1487 if(
audio_£ùiÚ_·¿m
 !ğ
NULL
) {

1488 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1489 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

1490 
audio_£ùiÚ_·¿m
->
Ï¡_audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

1491 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1492 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 = 0;

1493 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

1494 
audio_£ùiÚ_·¿m
->
disÿrd_numb”
 = 0;

1496 
	}
}

1498 
	$audio_decode_£ùiÚ_·¿m_upd©e_h—d”_±r
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

1500 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

1501 
ch_audio_decode_t
 *
audio_decode
;

1502 
tw_audio_driv”_t
 *
audio_driv”
;

1504 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

1505 
audio_decode
 = &
ch_audio
->audio_decode;

1506 if(
audio_decode
->
İ
 !ğ
NULL
){

1507 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
audio_decode
->
İ
->
	`g‘_audio_decode_chª_wr_±r
×udio_decode, 
audio_driv”
->
audio_logic_chª_id
, &audio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
, &audio_£ùiÚ_·¿m->
£ùiÚ_queue_size
);

1509 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1510 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
 = 0;

1511 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

1514 
	}
}

1516 
	$audio_decode_£ùiÚ_·¿m_upd©e_”_±r
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

1518 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

1519 
ch_audio_decode_t
 *
audio_decode
;

1520 
tw_audio_driv”_t
 *
audio_driv”
;

1522 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

1523 
audio_decode
 = &
ch_audio
->audio_decode;

1524 if(
audio_decode
->
İ
 !ğ
NULL
){

1525 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
audio_decode
->
İ
->
	`g‘_audio_decode_chª_rd_±r
×udio_decode, 
audio_driv”
->
audio_logic_chª_id
, &audio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_”_±r_ext_æag
, &audio_£ùiÚ_·¿m->
£ùiÚ_queue_size
);

1527 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1528 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 = 0;

1529 
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 = 0;

1532 
	}
}

1534 
	$audio_decode_£ùiÚ_·¿m_queue_ÿ·c™y
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

1536 
»t
 = 0;

1537 if(
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
 > 0){

1538 
tw_audio_driv”_t
 *
audio_driv”
;

1539 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

1540 if(
	`©omic_»ad
(&
audio_driv”
->
audio_sync_disÿrd_numb”
) > 0){

1541 
	`©omic_dec
(&
audio_driv”
->
audio_sync_disÿrd_numb”
);

1543 
»t
 = 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r
 +‡udio_£ùiÚ_·¿m->
£ùiÚ_queue_size
 -‡udio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r
 - 1;

1544 
»t
 %ğ
audio_£ùiÚ_·¿m
->
£ùiÚ_queue_size
;

1545 if(
»t
 == 0){

1546 if(
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_”_±r_ext_æag
 =ğaudio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
){

1547 
»t
 = 1;

1552  
»t
;

1553 
	}
}

1555 
	$audio_decode_£ùiÚ_·¿m_upd©e_cu¼_£ùiÚ_off£t
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
, 
ch_audio_t
 *
ch_audio
)

1557 if((
audio_£ùiÚ_·¿m
!=
NULL
è&& (
ch_audio
!=NULL)){

1558 
tw_audio_driv”_t
 *
audio_driv”
;

1559 
ch_audio_decode_t
 *
audio_decode
;

1560 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1561 
audio_decode_d©a_addr_t
 *
adpcm_audio_d©a_ba£
;

1562 
chª_id
;

1564 if(
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
 !ğ
INVALID_TW_AUDIO_SECTION_ID
){

1565 
audio_driv”
 = 
	`to_g‘_audio_chª_driv”_w™h_audio_£ùiÚ
(
audio_£ùiÚ_·¿m
);

1566 
chª_id
 = 
audio_driv”
->
audio_logic_chª_id
-
TW_AUDIO_OUT_SPEAKER_ID
;

1567 
audio_decode
 = &
ch_audio
->audio_decode;

1568 
cÚfig_·¿m
 = &
audio_decode
->config_param;

1569 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

1570 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1571 
TW_AUDIO_PCM
:

1572 
TW_AUDIO_ADPCM_32K
:

1573 
adpcm_audio_d©a_ba£
 = &
audio_decode
->
audio_d©a_ba£
;

1574 if(
adpcm_audio_d©a_ba£
->
İ
 !ğ
NULL
){

1575 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_chª_id
×dpcm_audio_d©a_ba£, 
chª_id
);

1576 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_decode_ty³
(adpcm_audio_data_base);

1577 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_id
×dpcm_audio_d©a_ba£, 
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r
);

1578 
adpcm_audio_d©a_ba£
->
İ
->
	`£t_»g_b™_£ùiÚ_off£t
(adpcm_audio_data_base, 0);

1579 
audio_£ùiÚ_·¿m
->
·ge_id
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_·ge_id
(adpcm_audio_data_base);

1580 
audio_£ùiÚ_·¿m
->
ch_a_Ü_b
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_buf_š_ch_a_Ü_b
(adpcm_audio_data_base);

1581 
audio_£ùiÚ_·¿m
->
ddr_’d_addr
 = 
adpcm_audio_d©a_ba£
->
İ
->
	`g‘_adpcm_decode_d©a_addr_š_ddr_’d_off£t
(adpcm_audio_data_base);

1585 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1591 
	}
}

1593 
	$audio_decode_£ùiÚ_·¿m_g‘_upd©e_fšish_id
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

1595  ((
audio_£ùiÚ_·¿m
->
audio_£ùiÚ_queue_h—d”_±r_ext_æag
<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_OUT_CHAN_SECTION_NUMBER
)))|audio_£ùiÚ_·¿m->
audio_£ùiÚ_queue_h—d”_±r
);

1596 
	}
}

1598 
audio_£ùiÚ_±r_šfo_İ”©iÚ
 
	gaudio_decode_£ùiÚ_·¿m_İ
 = {

1599 .
š™
 = 
audio_decode_£ùiÚ_·¿m_š™
,

1600 .
	gupd©e_h—d”_±r
 = 
audio_decode_£ùiÚ_·¿m_upd©e_h—d”_±r
,

1601 .
	gupd©e_”_±r
 = 
audio_decode_£ùiÚ_·¿m_upd©e_”_±r
,

1602 .
	gqueue_ÿ·c™y
 = 
audio_decode_£ùiÚ_·¿m_queue_ÿ·c™y
,

1603 .
	gupd©e_cu¼_£ùiÚ_off£t
 = 
audio_decode_£ùiÚ_·¿m_upd©e_cu¼_£ùiÚ_off£t
,

1604 .
	gg‘_upd©e_fšish_id
 = 
audio_decode_£ùiÚ_·¿m_g‘_upd©e_fšish_id
,

1607 
	$audio_decode_chª_driv”_£ùiÚ_š™
(
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
)

1609 if(
audio_£ùiÚ_·¿m
 !ğ
NULL
){

1610 
audio_£ùiÚ_·¿m
->
İ
 = &
audio_decode_£ùiÚ_·¿m_İ
;

1611 
audio_£ùiÚ_·¿m
->
İ
->
	`š™
(audio_section_param);

1613 
	}
}

1615 
	$»£t_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
)

1617 if(
audio_driv”
 !ğ
NULL
){

1618 
audio_driv”
->
time¡amp
.
İ
->
	`»£t
(&audio_driver->timestamp);

1619 
	`audio_decode_chª_driv”_£ùiÚ_š™
(&
audio_driv”
->
audio_£ùiÚ_·¿m
);

1620 
	`©omic_£t
(&
audio_driv”
->
audio_sync_disÿrd_numb”
, 0);

1622 
	}
}

1624 
	$š™_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
, 
ch_audio_t
 *
ch_audio
, 
bus_id
, 
ch_id
, 
group_chª_id
)

1626 
ed_tcb_t
 *
ed
;

1627 
»t
 = 
TW_ERR
;

1628 if(
audio_driv”
 !ğ
NULL
){

1629 
	`š™_tw5864_’code_time¡amp
(&
audio_driv”
->
time¡amp
);

1630 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 0);

1631 
»t
 = 
	`š™_audio_chª_buf_poŞ
(&
audio_driv”
->
audio_buf_poŞ
);

1632 if(
»t
 =ğ
TW_OK
){

1633 
ed
 = &
audio_driv”
->
audio_ed
;

1634 
	`š™_tw_audio_·ck‘_queue
(&
audio_driv”
->
audio_·ck‘_queue
);

1635 
	`audio_decode_chª_driv”_£ùiÚ_š™
(&
audio_driv”
->
audio_£ùiÚ_·¿m
);

1636 
ed
->
İ
 = &
tw_audio_decode_hcd_š‹rçû_İ
;

1637 
audio_driv”
->
ty³
 = 
TW_AUDIO_DECODE
;

1638 
	`š™_’dpošt_tcb
(&
audio_driv”
->
audio_ed
, 
bus_id
, 
ch_id
, 
TW_ED_AUDIO_DECODE_OUT
, 
group_chª_id
, 0,‡udio_driv”, 
NULL
, NULL, &
audio_decode_driv”_fsm_¡©e_Œªsãr_m©rix_bË
);

1639 
audio_driv”
->
audio_logic_chª_id
 = 
group_chª_id
;

1640 
audio_driv”
->
ch_audio
 = chip_audio;

1641 
audio_driv”
->
tw_deviû_chª
 = 
NULL
;

1643 
	`š™_d´am_»que¡_£rviû_tcb
(&
audio_driv”
->
audio_b™¡»am_»q
);

1644 
	`»£t_tw5864_audio_decode_chª
(
audio_driv”
);

1645 
audio_driv”
->
i_äame_£rŸl
 = 0;

1646 
audio_driv”
->
disÿrd_numb”
 = 0;

1647 
	`©omic_£t
(&
audio_driv”
->
İ’ed_æag
, 0);

1649  
»t
;

1650 
	}
}

1652 
	$»move_tw5864_audio_decode_chª
(
tw_audio_driv”_t
 *
audio_driv”
)

1654 if(
audio_driv”
 !ğ
NULL
){

1655 
ed_tcb_t
 *
ed
;

1657 
ed
 = &
audio_driv”
->
audio_ed
;

1658 if(
ed
 &&ƒd->
İ
) {

1659 
ed
->
İ
->
	`şo£
(ed);

1662 
	`»move_tw_audio_·ck‘_queue
(&
audio_driv”
->
audio_·ck‘_queue
, &audio_driv”->
audio_buf_poŞ
);

1663 
	`»move_audio_chª_buf_poŞ
(&
audio_driv”
->
audio_buf_poŞ
);

1665 
	}
}

	@../../tw5864/tw5864/tw_audio_iop.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
tw_audio_cÚfig_desütÜ_t
 
	gdeçuÉ_audio_’code_cÚfig_desütÜ
 = {

4 .
ty³
 = 
TW_AUDIO_ADPCM_32K
,

6 .
	g§m¶e_¿‹
 = 
TW_AUDIO_8000
,

7 .
	gb™_wide
 = 
TW_AUDIO_16BIT
,

10 
tw_audio_cÚfig_desütÜ_t
 
	gdeçuÉ_audio_decode_cÚfig_desütÜ
 = {

11 .
ty³
 = 
TW_AUDIO_ADPCM_32K
,

13 .
	g§m¶e_¿‹
 = 
TW_AUDIO_8000
,

14 .
	gb™_wide
 = 
TW_AUDIO_16BIT
,

17 
	$g‘_pow”_ba£
(
u32
 
v®ue
)

19 
pos™iÚ
, 
numb”
;

20 
pos™iÚ
 = 
numb”
 = 0;

21 
v®ue
){

22 if(
v®ue
&1){

23 
numb”
++;

25 
pos™iÚ
++;

26 
v®ue
 >>= 1;

28 if(
numb”
==1){

29 
pos™iÚ
--;

31  
pos™iÚ
;

32 
	}
}

37 
	$audio_£ùiÚ_desütÜ_š™_audio_desütÜ
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, *
desütÜ_addr
)

39 if(
desütÜ_addr
 !ğ
NULL
){

40 
audio_desütÜ
->
desütÜ
 = (
audio_£ùiÚ_desütÜ_t
*)
desütÜ_addr
;

42 
audio_desütÜ
->
desütÜ
 = 
NULL
;

44 
	}
}

46 
u32
 
	$audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_time¡amp
(
tw_audio_desütÜ_t
 *
audio_desütÜ
)

48 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

49  
audio_desütÜ
->
desütÜ
->
time¡amp
;

53 
	}
}

55 
	$audio_£ùiÚ_desütÜ_£t_audio_desütÜ_time¡amp
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, 
u32
 
time¡amp
)

57 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

58 
audio_desütÜ
->
desütÜ
->
time¡amp
 =imestamp;

60 
	}
}

62 
	$audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_§m¶e_¿‹
(
tw_audio_desütÜ_t
 *
audio_desütÜ
)

64 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

65  
audio_desütÜ
->
desütÜ
->
§m¶e_¿‹
;

67  
TW_AUDIO_8000
;

69 
	}
}

71 
	$audio_£ùiÚ_desütÜ_£t_audio_desütÜ_§m¶e_¿‹
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, 
§m¶e_¿‹
)

73 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

74 
audio_desütÜ
->
desütÜ
->
§m¶e_¿‹
 = sample_rate;

76 
	}
}

78 
	$audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_ty³
(
tw_audio_desütÜ_t
 *
audio_desütÜ
)

80 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

81  
audio_desütÜ
->
desütÜ
->
ty³
;

83  
TW_AUDIO_ADPCM_32K
;

85 
	}
}

87 
	$audio_£ùiÚ_desütÜ_£t_audio_desütÜ_ty³
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, 
ty³
)

89 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

90 
audio_desütÜ
->
desütÜ
->
ty³
=ype;

92 
	}
}

94 
	$audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_b™_wide
(
tw_audio_desütÜ_t
 *
audio_desütÜ
)

96 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

97  
audio_desütÜ
->
desütÜ
->
b™_wide
;

99  
TW_AUDIO_16BIT
;

101 
	}
}

103 
	$audio_£ùiÚ_desütÜ_£t_audio_desütÜ_b™_wide
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, 
b™_wide
)

105 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

106 
audio_desütÜ
->
desütÜ
->
b™_wide
 = bit_wide;

108 
	}
}

110 
u32
 
	$audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_v®id_Ën
(
tw_audio_desütÜ_t
 *
audio_desütÜ
)

112 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

113  
audio_desütÜ
->
desütÜ
->
v®id_Ën
;

117 
	}
}

119 
	$audio_£ùiÚ_desütÜ_£t_audio_desütÜ_v®id_Ën
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, 
u32
 
v®id_Ën
)

121 if(
audio_desütÜ
->
desütÜ
 !ğ
NULL
){

122 
audio_desütÜ
->
desütÜ
->
v®id_Ën
 = valid_len;

124 
	}
}

126 
tw_audio_£ùiÚ_desütÜ_İ”©iÚ
 
	gaudio_£ùiÚ_desütÜ_İ
 = {

127 .
š™_audio_desütÜ
 = 
audio_£ùiÚ_desütÜ_š™_audio_desütÜ
,

128 .
	gg‘_audio_desütÜ_time¡amp
 = 
audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_time¡amp
,

129 .
	g£t_audio_desütÜ_time¡amp
 = 
audio_£ùiÚ_desütÜ_£t_audio_desütÜ_time¡amp
,

130 .
	gg‘_audio_desütÜ_§m¶e_¿‹
 = 
audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_§m¶e_¿‹
,

131 .
	g£t_audio_desütÜ_§m¶e_¿‹
 = 
audio_£ùiÚ_desütÜ_£t_audio_desütÜ_§m¶e_¿‹
,

132 .
	gg‘_audio_desütÜ_ty³
 = 
audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_ty³
,

133 .
	g£t_audio_desütÜ_ty³
 = 
audio_£ùiÚ_desütÜ_£t_audio_desütÜ_ty³
,

134 .
	gg‘_audio_desütÜ_b™_wide
 = 
audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_b™_wide
,

135 .
	g£t_audio_desütÜ_b™_wide
 = 
audio_£ùiÚ_desütÜ_£t_audio_desütÜ_b™_wide
,

136 .
	gg‘_audio_desütÜ_v®id_Ën
 = 
audio_£ùiÚ_desütÜ_g‘_audio_desütÜ_v®id_Ën
,

137 .
	g£t_audio_desütÜ_v®id_Ën
 = 
audio_£ùiÚ_desütÜ_£t_audio_desütÜ_v®id_Ën
,

140 
	$š™_tw_audio_desütÜ
(
tw_audio_desütÜ_t
 *
audio_desütÜ
, *
audio_desütÜ_addr
)

142 if(
audio_desütÜ
 !ğ
NULL
){

143 
audio_desütÜ
->
İ
 = &
audio_£ùiÚ_desütÜ_İ
;

144 
audio_desütÜ
->
İ
->
	`š™_audio_desütÜ
×udio_desütÜ, 
audio_desütÜ_addr
);

146 
	}
}

152 
	$audio_’code_cÚfig_·¿m_upd©e_š™
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
, 
tw_audio_cÚfig_desütÜ_t
 *
·¿m
)

154 if(
·¿m
 =ğ
NULL
){

155 
·¿m
 = &
deçuÉ_audio_’code_cÚfig_desütÜ
;

157 if(
’code_audio_·¿m
->
İ
 !ğ
NULL
){

158 
’code_audio_·¿m
->
İ
->
	`upd©e_b™_wide
Óncode_audio_·¿m, 
·¿m
->
b™_wide
);

159 
’code_audio_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
Óncode_audio_·¿m,
·¿m
->
§m¶e_¿‹
);

160 
’code_audio_·¿m
->
İ
->
	`upd©e_ty³
Óncode_audio_·¿m, 
·¿m
->
ty³
);

162 
’code_audio_·¿m
->
´İ”ty
.
ty³
 = 
·¿m
->type;

163 
’code_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
 = 
·¿m
->sample_rate;

164 
’code_audio_·¿m
->
´İ”ty
.
b™_wide
 = 
·¿m
->bit_wide;

166 
	}
}

168 
	$audio_’code_cÚfig_·¿m_upd©e_upd©e_§m¶e_¿‹
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
, 
§m¶e_¿‹
)

170 
ch_audio_’code_t
 *
audio_’code
;

171 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

172 if((
§m¶e_¿‹
!=
TW_AUDIO_8000
è&& (§m¶e_¿‹!=
TW_AUDIO_16000
)){

173 
	`TW_DBG
(
TW_DBG_ERR
, "only support 8K, 16K\n");

174  
TW_ERR
;

176 
’code_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
 = sample_rate;

177 
audio_’code
 = 
	`to_g‘_ch_audio_’code_w™h_´İ”ty
(
’code_audio_·¿m
);

178 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

179 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

180 
audio_cÚŒŞ
->
İ
->
	`upd©e_audio_§m¶e_¿‹
×udio_cÚŒŞ, 
§m¶e_¿‹
);

182  
TW_OK
;

183 
	}
}

185 
	$audio_’code_cÚfig_·¿m_upd©e_g‘_§m¶e_¿‹
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
)

187  
’code_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
;

188 
	}
}

190 
	$audio_’code_cÚfig_·¿m_upd©e_upd©e_b™_wide
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
, 
b™_wide
)

192 
ch_audio_’code_t
 *
audio_’code
;

193 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

194 if((
b™_wide
!=
TW_AUDIO_16BIT
è&& (b™_wide!=
TW_AUDIO_8BIT
)){

195 
	`TW_DBG
(
TW_DBG_ERR
, "only support 8bit or 16bit\n");

196  
TW_ERR
;

198 
’code_audio_·¿m
->
´İ”ty
.
b™_wide
 = bit_wide;

199 
audio_’code
 = 
	`to_g‘_ch_audio_’code_w™h_´İ”ty
(
’code_audio_·¿m
);

200 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

201 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

202 
audio_cÚŒŞ
->
İ
->
	`upd©e_b™_wide
×udio_cÚŒŞ, 
b™_wide
);

204  
TW_OK
;

205 
	}
}

207 
	$audio_’code_cÚfig_·¿m_upd©e_g‘_b™_wide
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
)

209  
’code_audio_·¿m
->
´İ”ty
.
b™_wide
;

210 
	}
}

212 
	$audio_’code_cÚfig_·¿m_upd©e_upd©e_ty³
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
, 
ty³
)

214 
ch_audio_’code_t
 *
audio_’code
;

215 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

216 if((
ty³
 !ğ
TW_AUDIO_ADPCM_32K
è&& (ty³ !ğ
TW_AUDIO_PCM
)){

217 
	`TW_DBG
(
TW_DBG_ERR
, "only support TW_AUDIO_ADPCM_32K‡nd TW_AUDIO_PCM\n");

218  
TW_ERR
;

220 
’code_audio_·¿m
->
´İ”ty
.
ty³
 =ype;

221 
audio_’code
 = 
	`to_g‘_ch_audio_’code_w™h_´İ”ty
(
’code_audio_·¿m
);

222 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

223 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

224 
audio_cÚŒŞ
->
İ
->
	`upd©e_audio_ty³
×udio_cÚŒŞ, 
ty³
);

226  
TW_OK
;

227 
	}
}

229 
	$audio_’code_cÚfig_·¿m_upd©e_g‘_ty³
(
tw_audio_·¿m_t
 *
’code_audio_·¿m
)

231  
’code_audio_·¿m
->
´İ”ty
.
ty³
;

232 
	}
}

234 
audio_´İ”ty_upd©e_İ”©iÚ
 
	gaudio_’code_cÚfig_·¿m_upd©e_İ
 = {

235 .
š™
 = 
audio_’code_cÚfig_·¿m_upd©e_š™
,

236 .
	gupd©e_§m¶e_¿‹
 = 
audio_’code_cÚfig_·¿m_upd©e_upd©e_§m¶e_¿‹
,

237 .
	gg‘_§m¶e_¿‹
 = 
audio_’code_cÚfig_·¿m_upd©e_g‘_§m¶e_¿‹
,

238 .
	gupd©e_b™_wide
 = 
audio_’code_cÚfig_·¿m_upd©e_upd©e_b™_wide
,

239 .
	gg‘_b™_wide
 = 
audio_’code_cÚfig_·¿m_upd©e_g‘_b™_wide
,

240 .
	gupd©e_ty³
 = 
audio_’code_cÚfig_·¿m_upd©e_upd©e_ty³
,

241 .
	gg‘_ty³
 = 
audio_’code_cÚfig_·¿m_upd©e_g‘_ty³
,

244 
	$š™_audio_’code_´İ”ty
(
tw_audio_·¿m_t
 *
audio_’code_·¿m
, 
tw_audio_cÚfig_desütÜ_t
 *
cÚfig
)

246 if(
audio_’code_·¿m
 !ğ
NULL
){

247 
audio_’code_·¿m
->
İ
 = &
audio_’code_cÚfig_·¿m_upd©e_İ
;

248 
audio_’code_·¿m
->
İ
->
	`š™
×udio_’code_·¿m, 
cÚfig
);

250 
	}
}

255 
	$audio_decode_cÚfig_·¿m_upd©e_š™
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
, 
tw_audio_cÚfig_desütÜ_t
 *
·¿m
)

257 if(
·¿m
 =ğ
NULL
){

258 
·¿m
 = &
deçuÉ_audio_decode_cÚfig_desütÜ
;

260 if(
decode_audio_·¿m
->
İ
 !ğ
NULL
){

261 
decode_audio_·¿m
->
İ
->
	`upd©e_b™_wide
(decode_audio_·¿m, ()
·¿m
->
b™_wide
);

262 
decode_audio_·¿m
->
İ
->
	`upd©e_§m¶e_¿‹
(decode_audio_·¿m, ()
·¿m
->
§m¶e_¿‹
);

263 
decode_audio_·¿m
->
İ
->
	`upd©e_ty³
(decode_audio_·¿m, ()
·¿m
->
ty³
);

265 
decode_audio_·¿m
->
´İ”ty
.
ty³
 = 
·¿m
->type;

266 
decode_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
 = 
·¿m
->sample_rate;

267 
decode_audio_·¿m
->
´İ”ty
.
b™_wide
 = 
·¿m
->bit_wide;

269 
	}
}

271 
	$audio_decode_cÚfig_·¿m_upd©e_upd©e_§m¶e_¿‹
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
, 
§m¶e_¿‹
)

273 if((
§m¶e_¿‹
!=
TW_AUDIO_8000
è&& (§m¶e_¿‹!=
TW_AUDIO_16000
)){

274 
	`TW_DBG
(
TW_DBG_ERR
, "only support 8K, 16K\n");

275  
TW_ERR
;

277 if(
decode_audio_·¿m
 =ğ
NULL
){

278  
TW_ERR
;

280 
decode_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
 = sample_rate;

281  
TW_OK
;

282 
	}
}

284 
	$audio_decode_cÚfig_·¿m_upd©e_g‘_§m¶e_¿‹
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
)

286  
decode_audio_·¿m
->
´İ”ty
.
§m¶e_¿‹
;

287 
	}
}

289 
	$audio_decode_cÚfig_·¿m_upd©e_upd©e_b™_wide
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
, 
b™_wide
)

291 
ch_audio_decode_t
 *
audio_decode
;

292 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
;

293 if((
b™_wide
!=
TW_AUDIO_16BIT
è&& (b™_wide!=
TW_AUDIO_8BIT
)){

294 
	`TW_DBG
(
TW_DBG_ERR
, "only support 8bit or 16bit\n");

295  
TW_ERR
;

297 
decode_audio_·¿m
->
´İ”ty
.
b™_wide
 = bit_wide;

298 
audio_decode
 = 
	`to_g‘_ch_audio_decode_w™h_´İ”ty
(
decode_audio_·¿m
);

299 
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

300 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

301 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_b™_wide
×udio_cÚŒŞ, 
TW_AUDIO_OUT_SPEAKER_ID
, 
b™_wide
);

302 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_b™_wide
×udio_cÚŒŞ, 
TW_AUDIO_OUT_PLAYBACK_ID
, 
b™_wide
);

304  
TW_OK
;

305 
	}
}

307 
	$audio_decode_cÚfig_·¿m_upd©e_g‘_b™_wide
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
)

309  
decode_audio_·¿m
->
´İ”ty
.
b™_wide
;

310 
	}
}

312 
	$audio_decode_cÚfig_·¿m_upd©e_upd©e_ty³
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
, 
ty³
)

314 if((
ty³
 !ğ
TW_AUDIO_ADPCM_32K
è&& (ty³ !ğ
TW_AUDIO_PCM
)){

315 
	`TW_DBG
(
TW_DBG_ERR
, "only support TW_AUDIO_ADPCM_32K‡nd TW_AUDIO_PCM\n");

316  
TW_ERR
;

318 
decode_audio_·¿m
->
´İ”ty
.
ty³
 =ype;

319  
TW_OK
;

320 
	}
}

322 
	$audio_decode_cÚfig_·¿m_upd©e_g‘_ty³
(
tw_audio_·¿m_t
 *
decode_audio_·¿m
)

324  
decode_audio_·¿m
->
´İ”ty
.
ty³
;

325 
	}
}

327 
audio_´İ”ty_upd©e_İ”©iÚ
 
	gaudio_decode_cÚfig_·¿m_upd©e_İ
 = {

328 .
š™
 = 
audio_decode_cÚfig_·¿m_upd©e_š™
,

329 .
	gupd©e_§m¶e_¿‹
 = 
audio_decode_cÚfig_·¿m_upd©e_upd©e_§m¶e_¿‹
,

330 .
	gg‘_§m¶e_¿‹
 = 
audio_decode_cÚfig_·¿m_upd©e_g‘_§m¶e_¿‹
,

331 .
	gupd©e_b™_wide
 = 
audio_decode_cÚfig_·¿m_upd©e_upd©e_b™_wide
,

332 .
	gg‘_b™_wide
 = 
audio_decode_cÚfig_·¿m_upd©e_g‘_b™_wide
,

333 .
	gupd©e_ty³
 = 
audio_decode_cÚfig_·¿m_upd©e_upd©e_ty³
,

334 .
	gg‘_ty³
 = 
audio_decode_cÚfig_·¿m_upd©e_g‘_ty³
,

337 
	$š™_audio_decode_´İ”ty
(
tw_audio_·¿m_t
 *
audio_decode_·¿m
, 
tw_audio_cÚfig_desütÜ_t
 *
cÚfig
)

339 if(
audio_decode_·¿m
 !ğ
NULL
){

340 
audio_decode_·¿m
->
İ
 = &
audio_decode_cÚfig_·¿m_upd©e_İ
;

341 
audio_decode_·¿m
->
İ
->
	`š™
×udio_decode_·¿m, 
cÚfig
);

343 
	}
}

349 
	$audio_’abË_g‘_adpcm_decode_¡©e
(
audio_’abË_cÚŒŞ_t
 *
audio_’
)

351  
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_decode_’abË
;

352 
	}
}

354 
	$audio_’abË_upd©e_’abË_adpcm_decode
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
)

356 if(
’
 =ğ
AUDIO_DISABLE
){

357 
ch_audio_t
 *
ch_aduio
 = 
	`to_g‘_ch_audio_w™h_audio_’abË
(
audio_’
);

358 
ch_audio_decode_t
 *
audio_decode
 = &
ch_aduio
->audio_decode;

359 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

360 if((
audio_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_’abË
 =ğ
AUDIO_DISABLE
) &&

361 (
audio_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_’abË
 =ğ
AUDIO_DISABLE
)){

362 
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_decode_’abË
 = 
AUDIO_DISABLE
;

365 
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_decode_’abË
 = 
AUDIO_ENABLE
;

367 
	}
}

369 
	$audio_’abË_£t_’abË_adpcm_decode
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
, 
dvm_ch_t
 *
ch
)

371 if(
audio_’
->
İ
 !ğ
NULL
){

372 
audio_’
->
İ
->
	`upd©e_’abË_adpcm_decode
×udio_’, 
’
);

374 
	`audio_’abË_upd©e_’abË_adpcm_decode
(
audio_’
, 
’
);

376 if(
ch
 !ğ
NULL
){

377 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
audio_’
->
»g_off£t
,‡udio_’->
v®ue
.value);

379 
	}
}

381 
	$audio_’abË_g‘_pcm_’code_¡©e
(
audio_’abË_cÚŒŞ_t
 *
audio_’
)

383  
audio_’
->
v®ue
.
b™_v®ue
.
pcm_’code_’abË
;

384 
	}
}

386 
	$audio_’abË_upd©e_’abË_pcm_’code
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
)

388 
ch_audio_t
 *
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_’abË
(
audio_’
);

389 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

390 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

392 if(
’
 =ğ
AUDIO_DISABLE
){

393 if((
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª0_’
 =ğ
AUDIO_DISABLE
) &&

394 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª1_’
 =ğ
AUDIO_DISABLE
) &&

395 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª2_’
 =ğ
AUDIO_DISABLE
) &&

396 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª3_’
 =ğ
AUDIO_DISABLE
) &&

397 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª4_’
 =ğ
AUDIO_DISABLE
) &&

398 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª5_’
 =ğ
AUDIO_DISABLE
) &&

399 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª6_’
 =ğ
AUDIO_DISABLE
) &&

400 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª7_’
 =ğ
AUDIO_DISABLE
) &&

401 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª8_’
 =ğ
AUDIO_DISABLE
) &&

402 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª9_’
 =ğ
AUDIO_DISABLE
) &&

403 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª10_’
 =ğ
AUDIO_DISABLE
) &&

404 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª11_’
 =ğ
AUDIO_DISABLE
) &&

405 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª12_’
 =ğ
AUDIO_DISABLE
) &&

406 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª13_’
 =ğ
AUDIO_DISABLE
) &&

407 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª14_’
 =ğ
AUDIO_DISABLE
) &&

408 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_chª15_’
 =ğ
AUDIO_DISABLE
) &&

409 (
audio_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
¥—k”_’
 =ğ
AUDIO_DISABLE
)){

410 
audio_’
->
v®ue
.
b™_v®ue
.
pcm_’code_’abË
 = 
AUDIO_DISABLE
;

411 
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_’code_’abË
 = 
AUDIO_DISABLE
;

414 
audio_’
->
v®ue
.
b™_v®ue
.
pcm_’code_’abË
 = 
AUDIO_ENABLE
;

416 
	}
}

418 
	$audio_’abË_£t_’abË_pcm_’code
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
, 
dvm_ch_t
 *
ch
)

420 if(
audio_’
->
İ
 !ğ
NULL
){

421 
audio_’
->
İ
->
	`upd©e_’abË_pcm_’code
×udio_’, 
’
);

423 
	`audio_’abË_upd©e_’abË_pcm_’code
(
audio_’
, 
’
);

425 if(
ch
 !ğ
NULL
){

426 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
audio_’
->
»g_off£t
,‡udio_’->
v®ue
.value);

428 
	}
}

430 
	$audio_’abË_g‘_adpcm_’code_¡©e
(
audio_’abË_cÚŒŞ_t
 *
audio_’
)

432  
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_’code_’abË
;

433 
	}
}

435 
	$audio_’abË_upd©e_’abË_adpcm_’code
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
)

437 
ch_audio_t
 *
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_’abË
(
audio_’
);

438 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

439 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

441 if(
’
 =ğ
AUDIO_DISABLE
){

442 if((
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª0_’
 =ğ
AUDIO_DISABLE
) &&

443 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª1_’
 =ğ
AUDIO_DISABLE
) &&

444 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª2_’
 =ğ
AUDIO_DISABLE
) &&

445 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª3_’
 =ğ
AUDIO_DISABLE
) &&

446 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª4_’
 =ğ
AUDIO_DISABLE
) &&

447 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª5_’
 =ğ
AUDIO_DISABLE
) &&

448 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª6_’
 =ğ
AUDIO_DISABLE
) &&

449 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª7_’
 =ğ
AUDIO_DISABLE
) &&

450 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª8_’
 =ğ
AUDIO_DISABLE
) &&

451 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª9_’
 =ğ
AUDIO_DISABLE
) &&

452 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª10_’
 =ğ
AUDIO_DISABLE
) &&

453 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª11_’
 =ğ
AUDIO_DISABLE
) &&

454 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª12_’
 =ğ
AUDIO_DISABLE
) &&

455 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª13_’
 =ğ
AUDIO_DISABLE
) &&

456 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª14_’
 =ğ
AUDIO_DISABLE
) &&

457 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
audio_chª15_’
 =ğ
AUDIO_DISABLE
) &&

458 (
audio_cÚŒŞ
->
adpcm_v®ue
.
b™_v®ue
.
¥—k”_’
 =ğ
AUDIO_DISABLE
)){

459 
audio_’
->
v®ue
.
b™_v®ue
.
pcm_’code_’abË
 = 
AUDIO_DISABLE
;

460 
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_’code_’abË
 = 
AUDIO_DISABLE
;

463 
audio_’
->
v®ue
.
b™_v®ue
.
adpcm_’code_’abË
 = 
AUDIO_ENABLE
;

465 
	}
}

467 
	$audio_’abË_£t_’abË_adpcm_’code
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
’
, 
dvm_ch_t
 *
ch
)

469 if(
audio_’
->
İ
 !ğ
NULL
){

470 
audio_’
->
İ
->
	`upd©e_’abË_adpcm_’code
×udio_’, 
’
);

472 
	`audio_’abË_upd©e_’abË_adpcm_’code
(
audio_’
, 
’
);

474 if(
ch
 !ğ
NULL
){

475 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
audio_’
->
»g_off£t
,‡udio_’->
v®ue
.value);

477 
	}
}

479 
	$audio_’abË_š™_’abË_cÚŒŞ_»g
(
audio_’abË_cÚŒŞ_t
 *
audio_’
)

481 
audio_’
->
»g_off£t
 = 
AUDIO_EN_CONTROL_REG
;

482 
audio_’
->
v®ue
.value = 0;

483 
	}
}

485 
	$audio_’abË_g‘_’abË_cÚŒŞ_·¿m
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
dvm_ch_t
 *
ch
)

487 if(
ch
 !ğ
NULL
){

490 
	}
}

492 
	$audio_’abË_£t_’abË_cÚŒŞ_·¿m
(
audio_’abË_cÚŒŞ_t
 *
audio_’
, 
dvm_ch_t
 *
ch
)

494 if(
ch
 !ğ
NULL
){

495 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
audio_’
->
»g_off£t
,‡udio_’->
v®ue
.value);

497 
	}
}

499 
audio_’abË_cÚŒŞ_İ”©iÚ
 
	gaudio_’abË_İ
 = {

500 .
g‘_adpcm_decode_¡©e
 = 
audio_’abË_g‘_adpcm_decode_¡©e
,

501 .
	gupd©e_’abË_adpcm_decode
 = 
audio_’abË_upd©e_’abË_adpcm_decode
,

502 .
	g£t_’abË_adpcm_decode
 = 
audio_’abË_£t_’abË_adpcm_decode
,

504 .
	gg‘_pcm_’code_¡©e
 = 
audio_’abË_g‘_pcm_’code_¡©e
,

505 .
	gupd©e_’abË_pcm_’code
 = 
audio_’abË_upd©e_’abË_pcm_’code
,

506 .
	g£t_’abË_pcm_’code
 = 
audio_’abË_£t_’abË_pcm_’code
,

508 .
	gg‘_adpcm_’code_¡©e
 = 
audio_’abË_g‘_adpcm_’code_¡©e
,

509 .
	gupd©e_’abË_adpcm_’code
 = 
audio_’abË_upd©e_’abË_adpcm_’code
,

510 .
	g£t_’abË_adpcm_’code
 = 
audio_’abË_£t_’abË_adpcm_’code
,

512 .
	gš™
 = 
audio_’abË_š™_’abË_cÚŒŞ_»g
,

513 .
	gg‘_’abË_cÚŒŞ_·¿m
 = 
audio_’abË_g‘_’abË_cÚŒŞ_·¿m
,

514 .
	g£t_’abË_cÚŒŞ_·¿m
 = 
audio_’abË_£t_’abË_cÚŒŞ_·¿m
,

517 
	$š™_audio_’abË_cÚŒŞ
(
audio_’abË_cÚŒŞ_t
 *
audio_’
)

519 
audio_’
->
İ
 = &
audio_’abË_İ
;

520 
audio_’
->
İ
->
	`š™
(audio_en);

521 
	}
}

526 
	$audio_pcm_’code_wr_rd_±r_š™
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
)

528 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
v®ue
 = 0;

529 
pcm_’code_±r
->
ch0_ch7_wr_±r_»g_off£t
 = 
PCM_ENCODE_WR_PTR_CH0_CH7_REG
;

530 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
v®ue
 = 0;

531 
pcm_’code_±r
->
ch8_ch15_wr_±r_»g_off£t
 = 
PCM_ENCODE_WR_PTR_CH8_CH15_REG
;

532 
pcm_’code_±r
->
ch16_wr_±r_v®ue
.
v®ue
 = 0;

533 
pcm_’code_±r
->
ch16_wr_±r_»g_off£t
 = 
PCM_ENCODE_WR_PTR_CH16_REG
;

534 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
v®ue
 = 0;

535 
pcm_’code_±r
->
ch0_ch7_rd_±r_»g_off£t
 = 
PCM_ENCODE_RD_PTR_CH0_CH7_REG
;

536 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
v®ue
 = 0;

537 
pcm_’code_±r
->
ch8_ch15_rd_±r_»g_off£t
 = 
PCM_ENCODE_RD_PTR_CH8_CH15_REG
;

538 
pcm_’code_±r
->
ch16_rd_±r_v®ue
.
v®ue
 = 0;

539 
pcm_’code_±r
->
ch16_rd_±r_»g_off£t
 = 
PCM_ENCODE_RD_PTR_CH16_REG
;

540 
pcm_’code_±r
->
rd_fšish_numb”_»g_off£t
 = 
HOST_BLOCK_RD_PCM_FINISH_REG
;

541 
pcm_’code_±r
->
£ùiÚ_numb”
 = 
AUDIO_IN_PCM_CHAN_SECTION_NUMBER
;

542 
	}
}

544 
	$audio_pcm_’code_wr_rd_±r_g‘_pcm_wr_rd_±r
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
, 
dvm_ch_t
 *
ch
)

546 if(
ch
 !ğ
NULL
){

547 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch0_ch7_wr_±r_»g_off£t
);

548 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch8_ch15_wr_±r_»g_off£t
);

549 
pcm_’code_±r
->
ch16_wr_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch16_wr_±r_»g_off£t
);

551 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch0_ch7_rd_±r_»g_off£t
);

552 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch8_ch15_rd_±r_»g_off£t
);

553 
pcm_’code_±r
->
ch16_rd_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,…cm_’code_±r->
ch16_rd_±r_»g_off£t
);

555 
	}
}

557 
	$audio_pcm_’code_wr_rd_±r_g‘_chª_wr_±r
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
, 
chª_id
, *
ext_æag
)

559 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

560 
chª_id
){

561 
TW_AUDIO_IN_CHAN0_ID
:

562 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª0_±r
;

564 
TW_AUDIO_IN_CHAN1_ID
:

565 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª1_±r
;

567 
TW_AUDIO_IN_CHAN2_ID
:

568 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª2_±r
;

570 
TW_AUDIO_IN_CHAN3_ID
:

571 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª3_±r
;

573 
TW_AUDIO_IN_CHAN4_ID
:

574 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª4_±r
;

576 
TW_AUDIO_IN_CHAN5_ID
:

577 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª5_±r
;

579 
TW_AUDIO_IN_CHAN6_ID
:

580 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª6_±r
;

582 
TW_AUDIO_IN_CHAN7_ID
:

583 
»t
 = 
pcm_’code_±r
->
ch0_ch7_wr_±r_v®ue
.
b™_v®ue
.
audio_chª7_±r
;

585 
TW_AUDIO_IN_CHAN8_ID
:

586 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª08_±r
;

588 
TW_AUDIO_IN_CHAN9_ID
:

589 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª09_±r
;

591 
TW_AUDIO_IN_CHAN10_ID
:

592 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª10_±r
;

594 
TW_AUDIO_IN_CHAN11_ID
:

595 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª11_±r
;

597 
TW_AUDIO_IN_CHAN12_ID
:

598 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª12_±r
;

600 
TW_AUDIO_IN_CHAN13_ID
:

601 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª13_±r
;

603 
TW_AUDIO_IN_CHAN14_ID
:

604 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª14_±r
;

606 
TW_AUDIO_IN_CHAN15_ID
:

607 
»t
 = 
pcm_’code_±r
->
ch8_ch15_wr_±r_v®ue
.
b™_v®ue
.
audio_chª15_±r
;

609 
TW_AUDIO_IN_SPEAKER_ID
:

610 
»t
 = 
pcm_’code_±r
->
ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª16_±r
;

613 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

616 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_PCM_CHAN_SECTION_NUMBER
));

617 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_PCM_CHAN_SECTION_NUMBER
)))-1);

618  
»t
;

619 
	}
}

621 
	$audio_pcm_’code_wr_rd_±r_g‘_chª_rd_±r
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
, 
chª_id
, *
ext_æag
)

623 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

624 
chª_id
){

625 
TW_AUDIO_IN_CHAN0_ID
:

626 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª0_±r
;

628 
TW_AUDIO_IN_CHAN1_ID
:

629 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª1_±r
;

631 
TW_AUDIO_IN_CHAN2_ID
:

632 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª2_±r
;

634 
TW_AUDIO_IN_CHAN3_ID
:

635 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª3_±r
;

637 
TW_AUDIO_IN_CHAN4_ID
:

638 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª4_±r
;

640 
TW_AUDIO_IN_CHAN5_ID
:

641 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª5_±r
;

643 
TW_AUDIO_IN_CHAN6_ID
:

644 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª6_±r
;

646 
TW_AUDIO_IN_CHAN7_ID
:

647 
»t
 = 
pcm_’code_±r
->
ch0_ch7_rd_±r_v®ue
.
b™_v®ue
.
audio_chª7_±r
;

649 
TW_AUDIO_IN_CHAN8_ID
:

650 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª08_±r
;

652 
TW_AUDIO_IN_CHAN9_ID
:

653 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª09_±r
;

655 
TW_AUDIO_IN_CHAN10_ID
:

656 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª10_±r
;

658 
TW_AUDIO_IN_CHAN11_ID
:

659 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª11_±r
;

661 
TW_AUDIO_IN_CHAN12_ID
:

662 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª12_±r
;

664 
TW_AUDIO_IN_CHAN13_ID
:

665 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª13_±r
;

667 
TW_AUDIO_IN_CHAN14_ID
:

668 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª14_±r
;

670 
TW_AUDIO_IN_CHAN15_ID
:

671 
»t
 = 
pcm_’code_±r
->
ch8_ch15_rd_±r_v®ue
.
b™_v®ue
.
audio_chª15_±r
;

673 
TW_AUDIO_IN_SPEAKER_ID
:

674 
»t
 = 
pcm_’code_±r
->
ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª16_±r
;

677 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

680 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_PCM_CHAN_SECTION_NUMBER
));

681 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_PCM_CHAN_SECTION_NUMBER
)))-1);

682  
»t
;

683 
	}
}

685 
	$audio_pcm_’code_wr_rd_g‘_chª_£ùiÚ_numb”
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
)

687  
pcm_’code_±r
->
£ùiÚ_numb”
;

688 
	}
}

690 
	$audio_pcm_’code_wr_rd_±r_£t_rd_fšish_numb”
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
, 
£ùiÚ_id
, 
dvm_ch_t
 *
ch
)

692 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
pcm_’code_±r
->
rd_fšish_numb”_»g_off£t
, 
£ùiÚ_id
);

693 
	}
}

695 
audio_pcm_’code_wr_rd_±r_İ”©iÚ
 
	gaudio_pcm_’code_wr_rd_±r_İ
 = {

696 .
š™
 = 
audio_pcm_’code_wr_rd_±r_š™
,

697 .
	gg‘_pcm_wr_rd_±r
 = 
audio_pcm_’code_wr_rd_±r_g‘_pcm_wr_rd_±r
,

698 .
	gg‘_chª_wr_±r
 = 
audio_pcm_’code_wr_rd_±r_g‘_chª_wr_±r
,

699 .
	gg‘_chª_rd_±r
 = 
audio_pcm_’code_wr_rd_±r_g‘_chª_rd_±r
,

700 .
	gg‘_chª_£ùiÚ_numb”
 = 
audio_pcm_’code_wr_rd_g‘_chª_£ùiÚ_numb”
,

701 .
	g£t_rd_fšish_numb”
 = 
audio_pcm_’code_wr_rd_±r_£t_rd_fšish_numb”
,

704 
	$š™_audio_pcm_’code_±r_cÚŒŞ
(
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_’code_±r
)

706 
pcm_’code_±r
->
İ
 = &
audio_pcm_’code_wr_rd_±r_İ
;

707 
pcm_’code_±r
->
İ
->
	`š™
(pcm_encode_ptr);

708 
	}
}

713 
	$audio_pcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_off£t
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
, 
u32
 
£ùiÚ_off£t
)

715 
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
 = section_offset;

716 
	}
}

718 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

720  
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
;

721 
	}
}

723 
	$audio_pcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_id
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
, 
u32
 
£ùiÚ_id
)

725 
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
 = section_id;

726 
	}
}

728 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_id
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

730  
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
;

731 
	}
}

733 
	$audio_pcm_’code_d©a_addr_£t_»g_b™_chª_id
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
, 
u32
 
chª_id
)

735 
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
chª_id
 = chan_id;

736 
	}
}

738 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_»g_b™_chª_id
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

740  
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
chª_id
;

741 
	}
}

743 
	$audio_pcm_’code_d©a_addr_£t_»g_b™_pcm_ty³
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

745 
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
pcm_ty³
 = 
ADUIO_DATA_ADDR_PCM_ENCODE_TYPE
;

746 
	}
}

748 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_»g_b™_pcm_ty³
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

750  
ADUIO_DATA_ADDR_PCM_ENCODE_TYPE
;

751 
	}
}

753 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

755  
pcm_’code_d©a_addr
->
v®ue
.value;

756 
	}
}

758 
	$audio_pcm_’code_d©a_addr_g‘_buf_·ge_id
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

760  
pcm_’code_d©a_addr
->
buf_·ge_id
;

761 
	}
}

763 
	$audio_pcm_’code_d©a_addr_g‘_buf_š_ch_a_Ü_b
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

765  
pcm_’code_d©a_addr
->
ch_a_Ü_b
;

766 
	}
}

768 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr_š_ho¡_’d_off£t
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

770 
u32
 
ho¡_’d_off£t
;

771 
ho¡_’d_off£t
 = 
DDRBASE
;

772 
ho¡_’d_off£t
 |ğ(
pcm_’code_d©a_addr
->
v®ue
.value<<2);

773  
ho¡_’d_off£t
;

774 
	}
}

776 
u32
 
	$audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr_š_ddr_’d_off£t
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

778 
u32
 
ddr_’d_off£t
;

779 
ddr_’d_off£t
 = (
pcm_’code_d©a_addr
->
buf_·ge_id
<<19);

780 
ddr_’d_off£t
 |ğ(
pcm_’code_d©a_addr
->
v®ue
.value<<2);

781  
ddr_’d_off£t
;

782 
	}
}

784 
	$audio_pcm_’code_d©a_addr_š™
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
, 
·ge_id
, 
ch_a_Ü_b
)

786 
pcm_’code_d©a_addr
->
v®ue
.value = 0;

787 
pcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
pcm_ty³
 = 
ADUIO_DATA_ADDR_PCM_ENCODE_TYPE
;

788 
pcm_’code_d©a_addr
->
buf_·ge_id
 = 
·ge_id
;

789 
pcm_’code_d©a_addr
->
ch_a_Ü_b
 = chip_a_or_b;

790 
	}
}

792 
audio_pcm_’code_d©a_addr_İ”©iÚ
 
	gaudio_pcm_’code_d©a_addr_İ
 = {

793 .
£t_»g_b™_£ùiÚ_off£t
 = 
audio_pcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_off£t
,

794 .
	gg‘_»g_b™_£ùiÚ_off£t
 = 
audio_pcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
,

795 .
	g£t_»g_b™_£ùiÚ_id
 = 
audio_pcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_id
,

796 .
	gg‘_»g_b™_£ùiÚ_id
 = 
audio_pcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_id
,

797 .
	g£t_»g_b™_chª_id
 = 
audio_pcm_’code_d©a_addr_£t_»g_b™_chª_id
,

798 .
	gg‘_»g_b™_chª_id
 = 
audio_pcm_’code_d©a_addr_g‘_»g_b™_chª_id
,

799 .
	g£t_»g_b™_pcm_ty³
 = 
audio_pcm_’code_d©a_addr_£t_»g_b™_pcm_ty³
,

800 .
	gg‘_»g_b™_pcm_ty³
 = 
audio_pcm_’code_d©a_addr_g‘_»g_b™_pcm_ty³
,

801 .
	gg‘_pcm_’code_d©a_addr
 = 
audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr
,

802 .
	gg‘_buf_·ge_id
 = 
audio_pcm_’code_d©a_addr_g‘_buf_·ge_id
,

803 .
	gg‘_buf_š_ch_a_Ü_b
 = 
audio_pcm_’code_d©a_addr_g‘_buf_š_ch_a_Ü_b
,

804 .
	gg‘_pcm_’code_d©a_addr_š_ho¡_’d_off£t
 = 
audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr_š_ho¡_’d_off£t
,

805 .
	gg‘_pcm_’code_d©a_addr_š_ddr_’d_off£t
 = 
audio_pcm_’code_d©a_addr_g‘_pcm_’code_d©a_addr_š_ddr_’d_off£t
,

806 .
	gš™
 = 
audio_pcm_’code_d©a_addr_š™
,

809 
	$š™_audio_pcm_’code_d©a_addr
(
audio_pcm_’code_d©a_addr_t
 *
pcm_’code_d©a_addr
)

811 if(
pcm_’code_d©a_addr
 !ğ
NULL
){

812 
pcm_’code_d©a_addr
->
İ
 = &
audio_pcm_’code_d©a_addr_İ
;

813 
pcm_’code_d©a_addr
->
İ
->
	`š™
Õcm_’code_d©a_addr, 
TW_AUDIO_BUF_PAGE_ID
, 
TW_AUDIO_BUF_OF_DDR_ID
);

815 
	}
}

821 
	$audio_adpcm_’code_wr_rd_±r_š™
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
)

823 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
v®ue
 = 0;

824 
adpcm_’code_±r
->
ch0_ch9_wr_±r_»g_off£t
 = 
ADPCM_ENCODE_WR_PTR_CH0_CH9_REG
;

825 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
v®ue
 = 0;

826 
adpcm_’code_±r
->
ch10_ch16_wr_±r_»g_off£t
 = 
ADPCM_ENCODE_WR_PTR_CH10_CH16_REG
;

828 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
v®ue
 = 0;

829 
adpcm_’code_±r
->
ch0_ch9_rd_±r_»g_off£t
 = 
ADPCM_ENCODE_RD_PTR_CH0_CH9_REG
;

830 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
v®ue
 = 0;

831 
adpcm_’code_±r
->
ch10_ch16_rd_±r_»g_off£t
 = 
ADPCM_ENCODE_RD_PTR_CH10_CH16_REG
;

833 
adpcm_’code_±r
->
rd_fšish_numb”_»g_off£t
 = 
HOST_BLOCK_RD_ADPCM_FINISH_REG
;

834 
adpcm_’code_±r
->
£ùiÚ_numb”
 = 
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
;

835 
	}
}

837 
	$audio_adpcm_’code_wr_rd_±r_g‘_adpcm_wr_rd_±r
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
, 
dvm_ch_t
 *
ch
)

839 if(
ch
 !ğ
NULL
){

840 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,‡dpcm_’code_±r->
ch0_ch9_wr_±r_»g_off£t
);

841 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,‡dpcm_’code_±r->
ch10_ch16_wr_±r_»g_off£t
);

843 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,‡dpcm_’code_±r->
ch0_ch9_rd_±r_»g_off£t
);

844 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch,‡dpcm_’code_±r->
ch10_ch16_rd_±r_»g_off£t
);

846 
	}
}

848 
	$audio_adpcm_’code_wr_rd_±r_g‘_chª_wr_±r
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
, 
chª_id
, *
ext_æag
)

850 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

851 
chª_id
){

852 
TW_AUDIO_IN_CHAN0_ID
:

853 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª0_±r
;

855 
TW_AUDIO_IN_CHAN1_ID
:

856 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª1_±r
;

858 
TW_AUDIO_IN_CHAN2_ID
:

859 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª2_±r
;

861 
TW_AUDIO_IN_CHAN3_ID
:

862 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª3_±r
;

864 
TW_AUDIO_IN_CHAN4_ID
:

865 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª4_±r
;

867 
TW_AUDIO_IN_CHAN5_ID
:

868 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª5_±r
;

870 
TW_AUDIO_IN_CHAN6_ID
:

871 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª6_±r
;

873 
TW_AUDIO_IN_CHAN7_ID
:

874 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª7_±r
;

876 
TW_AUDIO_IN_CHAN8_ID
:

877 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª8_±r
;

879 
TW_AUDIO_IN_CHAN9_ID
:

880 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_wr_±r_v®ue
.
b™_v®ue
.
audio_chª9_±r
;

882 
TW_AUDIO_IN_CHAN10_ID
:

883 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª10_±r
;

885 
TW_AUDIO_IN_CHAN11_ID
:

886 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª11_±r
;

888 
TW_AUDIO_IN_CHAN12_ID
:

889 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª12_±r
;

891 
TW_AUDIO_IN_CHAN13_ID
:

892 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª13_±r
;

894 
TW_AUDIO_IN_CHAN14_ID
:

895 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª14_±r
;

897 
TW_AUDIO_IN_CHAN15_ID
:

898 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª15_±r
;

900 
TW_AUDIO_IN_SPEAKER_ID
:

901 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_wr_±r_v®ue
.
b™_v®ue
.
audio_chª16_±r
;

904 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

907 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
));

908 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
)))-1);

909  
»t
;

910 
	}
}

912 
	$audio_adpcm_’code_wr_rd_±r_g‘_chª_rd_±r
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
, 
chª_id
, *
ext_æag
)

914 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

915 
chª_id
){

916 
TW_AUDIO_IN_CHAN0_ID
:

917 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª0_±r
;

919 
TW_AUDIO_IN_CHAN1_ID
:

920 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª1_±r
;

922 
TW_AUDIO_IN_CHAN2_ID
:

923 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª2_±r
;

925 
TW_AUDIO_IN_CHAN3_ID
:

926 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª3_±r
;

928 
TW_AUDIO_IN_CHAN4_ID
:

929 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª4_±r
;

931 
TW_AUDIO_IN_CHAN5_ID
:

932 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª5_±r
;

934 
TW_AUDIO_IN_CHAN6_ID
:

935 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª6_±r
;

937 
TW_AUDIO_IN_CHAN7_ID
:

938 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª7_±r
;

940 
TW_AUDIO_IN_CHAN8_ID
:

941 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª8_±r
;

943 
TW_AUDIO_IN_CHAN9_ID
:

944 
»t
 = 
adpcm_’code_±r
->
ch0_ch9_rd_±r_v®ue
.
b™_v®ue
.
audio_chª9_±r
;

946 
TW_AUDIO_IN_CHAN10_ID
:

947 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª10_±r
;

949 
TW_AUDIO_IN_CHAN11_ID
:

950 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª11_±r
;

952 
TW_AUDIO_IN_CHAN12_ID
:

953 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª12_±r
;

955 
TW_AUDIO_IN_CHAN13_ID
:

956 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª13_±r
;

958 
TW_AUDIO_IN_CHAN14_ID
:

959 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª14_±r
;

961 
TW_AUDIO_IN_CHAN15_ID
:

962 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª15_±r
;

964 
TW_AUDIO_IN_SPEAKER_ID
:

965 
»t
 = 
adpcm_’code_±r
->
ch10_ch16_rd_±r_v®ue
.
b™_v®ue
.
audio_chª16_±r
;

968 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

971 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
));

972 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_IN_ADPCM_CHAN_SECTION_NUMBER
)))-1);

973  
»t
;

974 
	}
}

976 
	$audio_adpcm_’code_wr_rd_±r_g‘_chª_£ùiÚ_numb”
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
)

978  
adpcm_’code_±r
->
£ùiÚ_numb”
;

979 
	}
}

981 
	$audio_adpcm_’code_wr_rd_±r_£t_rd_fšish_numb”
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
, 
£ùiÚ_id
, 
dvm_ch_t
 *
ch
)

983 if(
ch
 !ğ
NULL
){

984 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
adpcm_’code_±r
->
rd_fšish_numb”_»g_off£t
, 
£ùiÚ_id
);

986 
	}
}

988 
audio_adpcm_’code_wr_rd_±r_İ”©iÚ
 
	gaudio_adpcm_’code_wr_rd_±r_İ
 = {

989 .
š™
 = 
audio_adpcm_’code_wr_rd_±r_š™
,

990 .
	gg‘_adpcm_wr_rd_±r
 = 
audio_adpcm_’code_wr_rd_±r_g‘_adpcm_wr_rd_±r
,

992 .
	gg‘_chª_wr_±r
 = 
audio_adpcm_’code_wr_rd_±r_g‘_chª_wr_±r
,

993 .
	gg‘_chª_rd_±r
 = 
audio_adpcm_’code_wr_rd_±r_g‘_chª_rd_±r
,

994 .
	gg‘_chª_£ùiÚ_numb”
 = 
audio_adpcm_’code_wr_rd_±r_g‘_chª_£ùiÚ_numb”
,

995 .
	g£t_rd_fšish_numb”
 = 
audio_adpcm_’code_wr_rd_±r_£t_rd_fšish_numb”
,

998 
	$š™_audio_adpcm_’code_±r_cÚŒŞ
(
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_’code_±r
)

1000 
adpcm_’code_±r
->
İ
 = &
audio_adpcm_’code_wr_rd_±r_İ
;

1001 
adpcm_’code_±r
->
İ
->
	`š™
(adpcm_encode_ptr);

1002 
	}
}

1007 
	$audio_adpcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_off£t
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
, 
u32
 
£ùiÚ_off£t
)

1009 
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
 = section_offset;

1010 
	}
}

1012 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1014  
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
;

1015 
	}
}

1017 
	$audio_adpcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_id
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
, 
u32
 
£ùiÚ_id
)

1019 
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
 = section_id;

1020 
	}
}

1022 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_id
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1024  
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
;

1025 
	}
}

1027 
	$audio_adpcm_’code_d©a_addr_£t_»g_b™_chª_id
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
, 
u32
 
chª_id
)

1029 
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
chª_id
 = chan_id;

1030 
	}
}

1032 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_»g_b™_chª_id
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1034  
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
;

1035 
	}
}

1037 
	$audio_adpcm_’code_d©a_addr_£t_»g_b™_adpcm_ty³
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1039 
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
adpcm_’code_ty³
 = 
ADUIO_DATA_ADDR_ADPCM_ENCODE_TYPE
;

1040 
	}
}

1042 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_»g_b™_adpcm_ty³
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1044  
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
adpcm_’code_ty³
;

1045 
	}
}

1047 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1049  
adpcm_’code_d©a_addr
->
v®ue
.value;

1050 
	}
}

1052 
	$audio_adpcm_’code_d©a_addr_g‘_buf_·ge_id
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1054  
adpcm_’code_d©a_addr
->
buf_·ge_id
;

1055 
	}
}

1057 
	$audio_adpcm_’code_d©a_addr_g‘_buf_š_ch_a_Ü_b
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1059  
adpcm_’code_d©a_addr
->
ch_a_Ü_b
;

1060 
	}
}

1062 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr_š_ho¡_’d_off£t
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1064 
u32
 
ho¡_’d_off£t
;

1065 
ho¡_’d_off£t
 = 
DDRBASE
;

1066 
ho¡_’d_off£t
 |ğ(
adpcm_’code_d©a_addr
->
v®ue
.value<<2);

1067  
ho¡_’d_off£t
;

1068 
	}
}

1070 
u32
 
	$audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr_š_ddr_’d_off£t
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1072 
u32
 
ddr_’d_off£t
;

1073 
ddr_’d_off£t
 = (
adpcm_’code_d©a_addr
->
buf_·ge_id
<<19);

1074 
ddr_’d_off£t
 |ğ(
adpcm_’code_d©a_addr
->
v®ue
.value<<2);

1075  
ddr_’d_off£t
;

1076 
	}
}

1078 
	$audio_adpcm_’code_d©a_addr_š™
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
, 
·ge_id
, 
ch_a_Ü_b
)

1080 
adpcm_’code_d©a_addr
->
v®ue
.value = 0;

1081 
adpcm_’code_d©a_addr
->
v®ue
.
b™_v®ue
.
adpcm_’code_ty³
 = 
ADUIO_DATA_ADDR_ADPCM_ENCODE_TYPE
;

1082 
adpcm_’code_d©a_addr
->
buf_·ge_id
 = 
·ge_id
;

1083 
adpcm_’code_d©a_addr
->
ch_a_Ü_b
 = chip_a_or_b;

1084 
	}
}

1086 
audio_adpcm_’code_d©a_addr_İ”©iÚ
 
	gaudio_adpcm_’code_d©a_addr_İ
 = {

1087 .
£t_»g_b™_£ùiÚ_off£t
 = 
audio_adpcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_off£t
,

1088 .
	gg‘_»g_b™_£ùiÚ_off£t
 = 
audio_adpcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
,

1089 .
	g£t_»g_b™_£ùiÚ_id
 = 
audio_adpcm_’code_d©a_addr_£t_»g_b™_£ùiÚ_id
,

1090 .
	gg‘_»g_b™_£ùiÚ_id
 = 
audio_adpcm_’code_d©a_addr_g‘_»g_b™_£ùiÚ_id
,

1091 .
	g£t_»g_b™_chª_id
 = 
audio_adpcm_’code_d©a_addr_£t_»g_b™_chª_id
,

1092 .
	gg‘_»g_b™_chª_id
 = 
audio_adpcm_’code_d©a_addr_g‘_»g_b™_chª_id
,

1093 .
	g£t_»g_b™_adpcm_ty³
 = 
audio_adpcm_’code_d©a_addr_£t_»g_b™_adpcm_ty³
,

1094 .
	gg‘_»g_b™_adpcm_ty³
 = 
audio_adpcm_’code_d©a_addr_g‘_»g_b™_adpcm_ty³
,

1095 .
	gg‘_adpcm_’code_d©a_addr
 = 
audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr
,

1096 .
	gg‘_buf_·ge_id
 = 
audio_adpcm_’code_d©a_addr_g‘_buf_·ge_id
,

1097 .
	gg‘_buf_š_ch_a_Ü_b
 = 
audio_adpcm_’code_d©a_addr_g‘_buf_š_ch_a_Ü_b
,

1098 .
	gg‘_adpcm_’code_d©a_addr_š_ho¡_’d_off£t
 = 
audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr_š_ho¡_’d_off£t
,

1099 .
	gg‘_adpcm_’code_d©a_addr_š_ddr_’d_off£t
 = 
audio_adpcm_’code_d©a_addr_g‘_adpcm_’code_d©a_addr_š_ddr_’d_off£t
,

1100 .
	gš™
 = 
audio_adpcm_’code_d©a_addr_š™
,

1103 
	$š™_audio_adpcm_’code_d©a_addr
(
audio_adpcm_’code_d©a_addr_t
 *
adpcm_’code_d©a_addr
)

1105 
adpcm_’code_d©a_addr
->
İ
 = &
audio_adpcm_’code_d©a_addr_İ
;

1106 
adpcm_’code_d©a_addr
->
İ
->
	`š™
×dpcm_’code_d©a_addr, 
TW_AUDIO_BUF_PAGE_ID
, 
TW_AUDIO_BUF_OF_DDR_ID
);

1107 
	}
}

1112 
	$audio_’code_cÚŒŞ_’abË_pcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1114 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1115 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 &ğ~(
AUDIO_DISABLE
<<
chª_id
);

1116 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 |ğ(
AUDIO_ENABLE
<<
chª_id
);

1118 
	}
}

1120 
	$audio_’code_cÚŒŞ_di§bË_pcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1122 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1123 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 &ğ~(
AUDIO_ENABLE
<<
chª_id
);

1124 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 |ğ(
AUDIO_DISABLE
<<
chª_id
);

1126 
	}
}

1128 
	$audio_’code_cÚŒŞ_£t_’abË_pcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
, 
’
, 
dvm_ch_t
 *
ch
)

1130 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1131 if(
’
 =ğ
AUDIO_ENABLE
){

1132 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 &ğ~(
AUDIO_DISABLE
<<
chª_id
);

1133 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 |ğ(
AUDIO_ENABLE
<<
chª_id
);

1135 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 &ğ~(
AUDIO_ENABLE
<<
chª_id
);

1136 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 |ğ(
AUDIO_DISABLE
<<
chª_id
);

1138 if(
ch
 !ğ
NULL
){

1139 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
pcm_»g_off£t
,ƒncode_cÚŒŞ->
pcm_v®ue
.
v®ue
);

1142 
	}
}

1144 
	$audio_’code_cÚŒŞ_g‘_pcm_chª_¡©e
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1146 
»t
 = 
AUDIO_DISABLE
;

1147 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1148 if(
chª_id
>=0){

1149 
»t
 = (((
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
)>>
chª_id
)&0x1);

1151 
	`´štk
("%s.%d: impossibË,ƒ¼ chª_id = %d\n", 
__FILE__
, 
__LINE__
, 
chª_id
);

1154  
»t
;

1155 
	}
}

1157 
	$audio_’code_cÚŒŞ_š™_audio_pcm
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1159 
’code_cÚŒŞ
->
pcm_v®ue
.
v®ue
 = 0;

1160 
’code_cÚŒŞ
->
pcm_»g_off£t
 = 
AUDIO_IN_ORIG_EN_CONTROL_REG
;

1161 
	}
}

1163 
	$audio_’code_cÚŒŞ_’abË_adpcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1165 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1166 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 &ğ~(
AUDIO_DISABLE
<<
chª_id
);

1167 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 |ğ(
AUDIO_ENABLE
<<
chª_id
);

1169 
	}
}

1171 
	$audio_’code_cÚŒŞ_di§bË_adpcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1173 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1174 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 &ğ~(
AUDIO_ENABLE
<<
chª_id
);

1175 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 |ğ(
AUDIO_DISABLE
<<
chª_id
);

1177 
	}
}

1179 
	$audio_’code_cÚŒŞ_£t_’abË_adpcm_chª
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
, 
’
, 
dvm_ch_t
 *
ch
)

1181 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1182 if(
’
 =ğ
AUDIO_ENABLE
){

1183 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 &ğ~(
AUDIO_DISABLE
<<
chª_id
);

1184 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 |ğ(
AUDIO_ENABLE
<<
chª_id
);

1186 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 &ğ~(
AUDIO_ENABLE
<<
chª_id
);

1187 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 |ğ(
AUDIO_DISABLE
<<
chª_id
);

1189 if(
ch
 !ğ
NULL
){

1190 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
adpcm_»g_off£t
,ƒncode_cÚŒŞ->
adpcm_v®ue
.
v®ue
);

1193 
	}
}

1195 
	$audio_’code_cÚŒŞ_g‘_adpcm_chª_¡©e
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
chª_id
)

1197 
»t
 = 
AUDIO_DISABLE
;

1198 if(
chª_id
 <ğ
TW_AUDIO_IN_SPEAKER_ID
){

1199 if(
chª_id
>=0){

1200 
»t
 = (((
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
)>>
chª_id
)&0x1);

1202 
	`´štk
("%s.%d: impossibË,ƒ¼ chª_id = %d\n", 
__FILE__
, 
__LINE__
, 
chª_id
);

1205  
»t
;

1206 
	}
}

1208 
	$audio_’code_cÚŒŞ_š™_audio_adpcm
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1210 
’code_cÚŒŞ
->
adpcm_v®ue
.
v®ue
 = 0;

1211 
’code_cÚŒŞ
->
adpcm_»g_off£t
 = 
AUDIO_IN_ADPCM_EN_CONTROL_REG
;

1212 
	}
}

1214 
	$audio_’code_cÚŒŞ_upd©e_audio_§m¶e_¿‹
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
§m¶e_¿‹
)

1216 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_§m¶e_¿‹
 = 
§m¶e_¿‹
;

1217 
	}
}

1219 
	$audio_’code_cÚŒŞ_g‘_audio_§m¶e_¿‹
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1221  
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_§m¶e_¿‹
;

1222 
	}
}

1224 
	$audio_’code_cÚŒŞ_£t_audio_§m¶e_¿‹
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
§m¶e_¿‹
, 
dvm_ch_t
 *
ch
)

1226 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_§m¶e_¿‹
 = 
§m¶e_¿‹
;

1227 if(
ch
 !ğ
NULL
){

1228 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
pcm_»g_off£t
,ƒncode_cÚŒŞ->
pcm_v®ue
.
v®ue
);

1230 
	}
}

1232 
	$audio_’code_cÚŒŞ_upd©e_audio_ty³
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
audio_ty³
)

1234 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_ty³
 =‡udio_type;

1235 
	}
}

1237 
	$audio_’code_cÚŒŞ_g‘_audio_ty³
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1239  
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_ty³
;

1240 
	}
}

1242 
	$audio_’code_cÚŒŞ_£t_audio_ty³
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
audio_ty³
, 
dvm_ch_t
 *
ch
)

1244 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
audio_ty³
 =‡udio_type;

1245 if(
ch
 !ğ
NULL
){

1246 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
pcm_»g_off£t
,ƒncode_cÚŒŞ->
pcm_v®ue
.
v®ue
);

1248 
	}
}

1250 
	$audio_’code_cÚŒŞ_upd©e_b™_wide
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
b™_wide
)

1252 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
AD_BIT_WIDE
 = 
b™_wide
;

1253 
	}
}

1255 
	$audio_’code_cÚŒŞ_g‘_b™_wide
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1257  
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
AD_BIT_WIDE
;

1258 
	}
}

1260 
	$audio_’code_cÚŒŞ_£t_b™_wide
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
b™_wide
, 
dvm_ch_t
 *
ch
)

1262 
’code_cÚŒŞ
->
pcm_v®ue
.
b™_v®ue
.
AD_BIT_WIDE
 = 
b™_wide
;

1263 if(
ch
 !ğ
NULL
){

1264 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
pcm_»g_off£t
,ƒncode_cÚŒŞ->
pcm_v®ue
.
v®ue
);

1266 
	}
}

1268 
	$audio_’code_cÚŒŞ_£t_audio_·¿m
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

1270 if(
ch
 !ğ
NULL
){

1271 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
pcm_»g_off£t
,ƒncode_cÚŒŞ->
pcm_v®ue
.
v®ue
);

1272 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
’code_cÚŒŞ
->
adpcm_»g_off£t
,ƒncode_cÚŒŞ->
adpcm_v®ue
.
v®ue
);

1274 
	}
}

1276 
	$audio_’code_cÚŒŞ_g‘_audio_·¿m
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

1278 if(
ch
 !ğ
NULL
){

1282 
	}
}

1284 
audio_’code_cÚŒŞ_İ”©iÚ
 
	gaudio_’code_cÚŒŞ_İ
 = {

1285 .
’abË_pcm_chª
 = 
audio_’code_cÚŒŞ_’abË_pcm_chª
,

1286 .
	gdi§bË_pcm_chª
 = 
audio_’code_cÚŒŞ_di§bË_pcm_chª
,

1287 .
	g£t_’abË_pcm_chª
 = 
audio_’code_cÚŒŞ_£t_’abË_pcm_chª
,

1288 .
	gg‘_pcm_chª_¡©e
 = 
audio_’code_cÚŒŞ_g‘_pcm_chª_¡©e
,

1289 .
	gš™_audio_pcm
 = 
audio_’code_cÚŒŞ_š™_audio_pcm
,

1291 .
	g’abË_adpcm_chª
 = 
audio_’code_cÚŒŞ_’abË_adpcm_chª
,

1292 .
	gdi§bË_adpcm_chª
 = 
audio_’code_cÚŒŞ_di§bË_adpcm_chª
,

1293 .
	g£t_’abË_adpcm_chª
 = 
audio_’code_cÚŒŞ_£t_’abË_adpcm_chª
,

1294 .
	gg‘_adpcm_chª_¡©e
 = 
audio_’code_cÚŒŞ_g‘_adpcm_chª_¡©e
,

1295 .
	gš™_audio_adpcm
 = 
audio_’code_cÚŒŞ_š™_audio_adpcm
,

1297 .
	gupd©e_audio_§m¶e_¿‹
 = 
audio_’code_cÚŒŞ_upd©e_audio_§m¶e_¿‹
,

1298 .
	gg‘_audio_§m¶e_¿‹
 = 
audio_’code_cÚŒŞ_g‘_audio_§m¶e_¿‹
,

1299 .
	g£t_audio_§m¶e_¿‹
 = 
audio_’code_cÚŒŞ_£t_audio_§m¶e_¿‹
,

1300 .
	gupd©e_audio_ty³
 = 
audio_’code_cÚŒŞ_upd©e_audio_ty³
,

1301 .
	gg‘_audio_ty³
 = 
audio_’code_cÚŒŞ_g‘_audio_ty³
,

1302 .
	g£t_audio_ty³
 = 
audio_’code_cÚŒŞ_£t_audio_ty³
,

1303 .
	gupd©e_b™_wide
 = 
audio_’code_cÚŒŞ_upd©e_b™_wide
,

1304 .
	gg‘_b™_wide
ğ
audio_’code_cÚŒŞ_g‘_b™_wide
,

1305 .
	g£t_b™_wide
 = 
audio_’code_cÚŒŞ_£t_b™_wide
,

1307 .
	g£t_audio_·¿m
 = 
audio_’code_cÚŒŞ_£t_audio_·¿m
,

1308 .
	gg‘_audio_·¿m
 = 
audio_’code_cÚŒŞ_g‘_audio_·¿m
,

1311 
	$š™_audio_’code_cÚŒŞ
(
audio_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
)

1313 
’code_cÚŒŞ
->
İ
 = &
audio_’code_cÚŒŞ_İ
;

1314 
’code_cÚŒŞ
->
İ
->
	`š™_audio_pcm
(encode_control);

1315 
’code_cÚŒŞ
->
İ
->
	`š™_audio_adpcm
(encode_control);

1316 
	}
}

1321 
	$audio_decode_cÚŒŞ_š™
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
)

1323 
decode_cÚŒŞ
->
v®ue
.value = 0;

1324 
decode_cÚŒŞ
->
»g_off£t
 = 
AUDIO_OUT_CONTROL_REG
;

1325 
	}
}

1327 
	$audio_decode_cÚŒŞ_upd©e_decode_chª_mu‹
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
mu‹
)

1329 
chª_id
){

1330 
TW_AUDIO_OUT_SPEAKER_ID
:

1331 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_mu‹
 = 
mu‹
;

1333 
TW_AUDIO_OUT_PLAYBACK_ID
:

1334 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_mu‹
 = 
mu‹
;

1339 
	}
}

1341 
	$audio_decode_cÚŒŞ_g‘_decode_chª_mu‹
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
)

1343 
»t
 = 
AUDIO_MUTE_ENABLE
;

1344 
chª_id
){

1345 
TW_AUDIO_OUT_SPEAKER_ID
:

1346 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_mu‹
;

1348 
TW_AUDIO_OUT_PLAYBACK_ID
:

1349 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_mu‹
;

1354  
»t
;

1355 
	}
}

1357 
	$audio_decode_cÚŒŞ_£t_decode_chª_mu‹
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
mu‹
, 
dvm_ch_t
 *
ch
)

1359 if(
ch
 !ğ
NULL
){

1360 
chª_id
){

1361 
TW_AUDIO_OUT_SPEAKER_ID
:

1362 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_mu‹
 = 
mu‹
;

1364 
TW_AUDIO_OUT_PLAYBACK_ID
:

1365 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_mu‹
 = 
mu‹
;

1370 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
decode_cÚŒŞ
->
»g_off£t
, decode_cÚŒŞ->
v®ue
.value);

1372 
	}
}

1374 
	$audio_decode_cÚŒŞ_upd©e_decode_chª_b™_wide
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
b™_wide
)

1376 
chª_id
){

1377 
TW_AUDIO_OUT_SPEAKER_ID
:

1378 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_DA_BIT_WIDE
 = 
b™_wide
;

1380 
TW_AUDIO_OUT_PLAYBACK_ID
:

1381 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_DA_BIT_WIDE
 = 
b™_wide
;

1386 
	}
}

1388 
	$audio_decode_cÚŒŞ_g‘_decode_chª_b™_wide
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
)

1390 
»t
 = 
TW_AUDIO_16BIT
;

1391 
chª_id
){

1392 
TW_AUDIO_OUT_SPEAKER_ID
:

1393 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_DA_BIT_WIDE
;

1395 
TW_AUDIO_OUT_PLAYBACK_ID
:

1396 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_DA_BIT_WIDE
;

1401  
»t
;

1402 
	}
}

1404 
	$audio_decode_cÚŒŞ_£t_decode_chª_b™_wide
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
b™_wide
, 
dvm_ch_t
 *
ch
)

1406 if(
ch
 !ğ
NULL
){

1407 
chª_id
){

1408 
TW_AUDIO_OUT_SPEAKER_ID
:

1409 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_DA_BIT_WIDE
 = 
b™_wide
;

1411 
TW_AUDIO_OUT_PLAYBACK_ID
:

1412 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_DA_BIT_WIDE
 = 
b™_wide
;

1417 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
decode_cÚŒŞ
->
»g_off£t
, decode_cÚŒŞ->
v®ue
.value);

1419 
	}
}

1421 
	$audio_decode_cÚŒŞ_upd©e_decode_chª_’abË
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
’abË
)

1423 
chª_id
){

1424 
TW_AUDIO_OUT_SPEAKER_ID
:

1425 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_’abË
 = 
’abË
;

1427 
TW_AUDIO_OUT_PLAYBACK_ID
:

1428 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_’abË
 = 
’abË
;

1433 
	}
}

1435 
	$audio_decode_cÚŒŞ_g‘_decode_chª_’abË
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
)

1437 
»t
 = 
AUDIO_DISABLE
;

1438 
chª_id
){

1439 
TW_AUDIO_OUT_SPEAKER_ID
:

1440 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_’abË
;

1442 
TW_AUDIO_OUT_PLAYBACK_ID
:

1443 
»t
 = 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_’abË
;

1448  
»t
;

1449 
	}
}

1451 
	$audio_decode_cÚŒŞ_£t_decode_chª_’abË
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
chª_id
, 
’abË
, 
dvm_ch_t
 *
ch
)

1453 if(
ch
 !ğ
NULL
){

1454 
chª_id
){

1455 
TW_AUDIO_OUT_SPEAKER_ID
:

1456 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª0_’abË
 = 
’abË
;

1458 
TW_AUDIO_OUT_PLAYBACK_ID
:

1459 
decode_cÚŒŞ
->
v®ue
.
b™_v®ue
.
audio_out_chª1_’abË
 = 
’abË
;

1464 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
decode_cÚŒŞ
->
»g_off£t
, decode_cÚŒŞ->
v®ue
.value);

1466 
	}
}

1468 
	$audio_decode_cÚŒŞ_£t_decode_·¿m
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

1470 if(
ch
 !ğ
NULL
){

1471 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
decode_cÚŒŞ
->
»g_off£t
, decode_cÚŒŞ->
v®ue
.value);

1473 
	}
}

1475 
	$audio_decode_cÚŒŞ_g‘_decode_·¿m
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

1477 if(
ch
 !ğ
NULL
){

1480 
	}
}

1482 
audio_decode_cÚŒŞ_İ”©iÚ
 
	gaudio_decode_cÚŒŞ_İ
 = {

1483 .
š™
 = 
audio_decode_cÚŒŞ_š™
,

1484 .
	gupd©e_decode_chª_mu‹
 = 
audio_decode_cÚŒŞ_upd©e_decode_chª_mu‹
,

1485 .
	gg‘_decode_chª_mu‹
 = 
audio_decode_cÚŒŞ_g‘_decode_chª_mu‹
,

1486 .
	g£t_decode_chª_mu‹
 = 
audio_decode_cÚŒŞ_£t_decode_chª_mu‹
,

1487 .
	gupd©e_decode_chª_b™_wide
 = 
audio_decode_cÚŒŞ_upd©e_decode_chª_b™_wide
,

1488 .
	gg‘_decode_chª_b™_wide
 = 
audio_decode_cÚŒŞ_g‘_decode_chª_b™_wide
,

1489 .
	g£t_decode_chª_b™_wide
 = 
audio_decode_cÚŒŞ_£t_decode_chª_b™_wide
,

1490 .
	gupd©e_decode_chª_’abË
 = 
audio_decode_cÚŒŞ_upd©e_decode_chª_’abË
,

1491 .
	gg‘_decode_chª_’abË
 = 
audio_decode_cÚŒŞ_g‘_decode_chª_’abË
,

1492 .
	g£t_decode_chª_’abË
 = 
audio_decode_cÚŒŞ_£t_decode_chª_’abË
,

1494 .
	g£t_decode_·¿m
 = 
audio_decode_cÚŒŞ_£t_decode_·¿m
,

1495 .
	gg‘_decode_·¿m
 = 
audio_decode_cÚŒŞ_g‘_decode_·¿m
,

1498 
	$š™_audio_decode_cÚŒŞ
(
audio_decode_cÚŒŞ_t
 *
decode_cÚŒŞ
)

1500 
decode_cÚŒŞ
->
İ
 = &
audio_decode_cÚŒŞ_İ
;

1501 
decode_cÚŒŞ
->
İ
->
	`š™
(decode_control);

1502 
	}
}

1507 
	$audio_decode_±r_cÚŒŞ_š™
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
)

1509 
decode_±r
->
wr_rd_v®ue
.
v®ue
 = 0;

1510 
decode_±r
->
wr_rd_»g_off£t
 = 
ADPCM_DECODE_RD_WR_PTR_REG
;

1511 
decode_±r
->
£ùiÚ_numb”
 = 
AUDIO_OUT_CHAN_SECTION_NUMBER
;

1512 
	}
}

1514 
	$audio_decode_±r_cÚŒŞ_g‘_adpcm_wr_rd_±r
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
, 
dvm_ch_t
 *
ch
)

1516 if(
ch
 !ğ
NULL
){

1517 
decode_±r
->
wr_rd_v®ue
.
v®ue
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, decode_±r->
wr_rd_»g_off£t
);

1519 
	}
}

1521 
	$audio_decode_±r_cÚŒŞ_g‘_chª_wr_±r
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
, 
chª_id
, *
ext_æag
)

1523 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1524 
chª_id
){

1525 
TW_AUDIO_OUT_SPEAKER_ID
:

1526 
»t
 = 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª0_wr_±r
;

1528 
TW_AUDIO_OUT_PLAYBACK_ID
:

1529 
»t
 = 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª1_wr_±r
;

1532 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

1535 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_OUT_CHAN_SECTION_NUMBER
));

1536 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_OUT_CHAN_SECTION_NUMBER
)))-1);

1537  
»t
;

1538 
	}
}

1540 
	$audio_decode_±r_cÚŒŞ_g‘_chª_rd_±r
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
, 
chª_id
, *
ext_æag
)

1542 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1543 
chª_id
){

1544 
TW_AUDIO_OUT_SPEAKER_ID
:

1545 
»t
 = 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª0_rd_±r
;

1547 
TW_AUDIO_OUT_PLAYBACK_ID
:

1548 
»t
 = 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª1_rd_±r
;

1551 
	`´štk
("%s.%d:ƒ¼‡udiØchª id %d\n", 
__FUNCTION__
, 
__LINE__
, 
chª_id
);

1554 *
ext_æag
 = 
»t
>>(
	`g‘_pow”_ba£
((
u32
)
AUDIO_OUT_CHAN_SECTION_NUMBER
));

1555 
»t
 &ğ((1<<(
	`g‘_pow”_ba£
((
u32
)
AUDIO_OUT_CHAN_SECTION_NUMBER
)))-1);

1556  
»t
;

1557 
	}
}

1559 
	$audio_decode_±r_cÚŒŞ_g‘_chª_£ùiÚ_numb”
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
)

1561  
decode_±r
->
£ùiÚ_numb”
;

1562 
	}
}

1564 
	$audio_decode_±r_cÚŒŞ_£t_fšish_wr_±r
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
, 
fšish_id
, 
dvm_ch_t
 *
ch
, 
chª_id
)

1566 if(
ch
 !ğ
NULL
){

1567 
fšish_id
++;

1568 if(
fšish_id
 >ğ(
decode_±r
->
£ùiÚ_numb”
<<1)){

1569 
fšish_id
 = 0;

1571 if(
chª_id
 =ğ
TW_AUDIO_OUT_SPEAKER_ID
){

1572 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª0_wr_±r
 = 
fšish_id
;

1574 
decode_±r
->
wr_rd_v®ue
.
b™_v®ue
.
chª1_wr_±r
 = 
fšish_id
;

1576 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
decode_±r
->
wr_rd_»g_off£t
, decode_±r->
wr_rd_v®ue
.
v®ue
);

1578 
	}
}

1580 
audio_decode_±r_cÚŒŞ_İ”©iÚ
 
	gaudio_decode_±r_cÚŒŞ_İ
 = {

1581 .
š™
 = 
audio_decode_±r_cÚŒŞ_š™
,

1582 .
	gg‘_adpcm_wr_rd_±r
 = 
audio_decode_±r_cÚŒŞ_g‘_adpcm_wr_rd_±r
,

1584 .
	gg‘_chª_wr_±r
 = 
audio_decode_±r_cÚŒŞ_g‘_chª_wr_±r
,

1585 .
	gg‘_chª_rd_±r
 = 
audio_decode_±r_cÚŒŞ_g‘_chª_rd_±r
,

1586 .
	gg‘_chª_£ùiÚ_numb”
 = 
audio_decode_±r_cÚŒŞ_g‘_chª_£ùiÚ_numb”
,

1587 .
	g£t_fšish_wr_±r
 = 
audio_decode_±r_cÚŒŞ_£t_fšish_wr_±r
,

1590 
	$š™_audio_decode_±r_cÚŒŞ
(
audio_decode_±r_cÚŒŞ_t
 *
decode_±r
)

1592 
decode_±r
->
İ
 = &
audio_decode_±r_cÚŒŞ_İ
;

1593 
decode_±r
->
İ
->
	`š™
(decode_ptr);

1594 
	}
}

1599 
	$audio_decode_d©a_addr_£t_»g_b™_£ùiÚ_off£t
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
, 
u32
 
£ùiÚ_off£t
)

1601 
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
 = section_offset;

1602 
	}
}

1604 
u32
 
	$audio_decode_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1606  
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_off£t
;

1607 
	}
}

1609 
	$audio_decode_d©a_addr_£t_»g_b™_£ùiÚ_id
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
, 
u32
 
£ùiÚ_id
)

1611 
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
 = section_id;

1612 
	}
}

1614 
u32
 
	$audio_decode_d©a_addr_g‘_»g_b™_£ùiÚ_id
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1616  
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
£ùiÚ_id
;

1617 
	}
}

1619 
	$audio_decode_d©a_addr_£t_»g_b™_chª_id
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
, 
u32
 
chª_id
)

1621 
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
chª_id
 = chan_id;

1622 
	}
}

1624 
u32
 
	$audio_decode_d©a_addr_g‘_»g_b™_chª_id
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1626  
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
chª_id
;

1627 
	}
}

1629 
	$audio_decode_d©a_addr_£t_»g_b™_decode_ty³
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1631 
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
decode_ty³
 = 
AUDIO_DATA_ADDR_ADPCM_DECODE_TYPE
;

1632 
	}
}

1634 
u32
 
	$audio_decode_d©a_addr_g‘_»g_b™_decode_ty³
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1636  
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
decode_ty³
;

1637 
	}
}

1639 
u32
 
	$audio_decode_d©a_addr_g‘_decode_d©a_addr
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1641  
decode_d©a_addr
->
v®ue
.value;

1642 
	}
}

1644 
	$audio_decode_d©a_addr_g‘_buf_·ge_id
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1646  
decode_d©a_addr
->
buf_·ge_id
;

1647 
	}
}

1649 
	$audio_decode_d©a_addr_g‘_buf_š_ch_a_Ü_b
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1651  
decode_d©a_addr
->
ch_a_Ü_b
;

1652 
	}
}

1654 
u32
 
	$audio_decode_d©a_addr_g‘_adpcm_decode_d©a_addr_š_ho¡_’d_off£t
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1656 
u32
 
ho¡_’d_off£t
;

1657 
ho¡_’d_off£t
 = 
DDRBASE
;

1658 
ho¡_’d_off£t
 |ğ(
decode_d©a_addr
->
v®ue
.value<<2);

1659  
ho¡_’d_off£t
;

1660 
	}
}

1662 
u32
 
	$audio_decode_d©a_addr_g‘_adpcm_decode_d©a_addr_š_ddr_’d_off£t
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1664 
u32
 
ddr_’d_off£t
;

1665 
ddr_’d_off£t
 = (
decode_d©a_addr
->
buf_·ge_id
<<19);

1666 
ddr_’d_off£t
 |ğ(
decode_d©a_addr
->
v®ue
.value<<2);

1667  
ddr_’d_off£t
;

1668 
	}
}

1670 
	$audio_decode_d©a_addr_š™
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1672 if(
decode_d©a_addr
 !ğ
NULL
){

1673 
decode_d©a_addr
->
v®ue
.value = 0;

1674 
decode_d©a_addr
->
v®ue
.
b™_v®ue
.
decode_ty³
 = 
AUDIO_DATA_ADDR_ADPCM_DECODE_TYPE
;

1675 
decode_d©a_addr
->
buf_·ge_id
 = 
TW_AUDIO_BUF_PAGE_ID
;

1676 
decode_d©a_addr
->
ch_a_Ü_b
 = 
TW_AUDIO_BUF_OF_DDR_ID
;

1678 
	}
}

1680 
audio_decode_d©a_addr_İ”©iÚ
 
	gaudio_decode_d©a_addr_İ
 = {

1681 .
£t_»g_b™_£ùiÚ_off£t
 = 
audio_decode_d©a_addr_£t_»g_b™_£ùiÚ_off£t
,

1682 .
	gg‘_»g_b™_£ùiÚ_off£t
 = 
audio_decode_d©a_addr_g‘_»g_b™_£ùiÚ_off£t
,

1683 .
	g£t_»g_b™_£ùiÚ_id
 = 
audio_decode_d©a_addr_£t_»g_b™_£ùiÚ_id
,

1684 .
	gg‘_»g_b™_£ùiÚ_id
 = 
audio_decode_d©a_addr_g‘_»g_b™_£ùiÚ_id
,

1685 .
	g£t_»g_b™_chª_id
 = 
audio_decode_d©a_addr_£t_»g_b™_chª_id
,

1686 .
	gg‘_»g_b™_chª_id
 = 
audio_decode_d©a_addr_g‘_»g_b™_chª_id
,

1687 .
	g£t_»g_b™_decode_ty³
 = 
audio_decode_d©a_addr_£t_»g_b™_decode_ty³
,

1688 .
	gg‘_»g_b™_decode_ty³
 = 
audio_decode_d©a_addr_g‘_»g_b™_decode_ty³
,

1689 .
	gg‘_decode_d©a_addr
 = 
audio_decode_d©a_addr_g‘_decode_d©a_addr
,

1690 .
	gg‘_buf_·ge_id
 = 
audio_decode_d©a_addr_g‘_buf_·ge_id
,

1691 .
	gg‘_buf_š_ch_a_Ü_b
 = 
audio_decode_d©a_addr_g‘_buf_š_ch_a_Ü_b
,

1692 .
	gg‘_adpcm_decode_d©a_addr_š_ho¡_’d_off£t
 = 
audio_decode_d©a_addr_g‘_adpcm_decode_d©a_addr_š_ho¡_’d_off£t
,

1693 .
	gg‘_adpcm_decode_d©a_addr_š_ddr_’d_off£t
 = 
audio_decode_d©a_addr_g‘_adpcm_decode_d©a_addr_š_ddr_’d_off£t
,

1694 .
	gš™
 = 
audio_decode_d©a_addr_š™
,

1697 
	$š™_audio_decode_d©a_addr
(
audio_decode_d©a_addr_t
 *
decode_d©a_addr
)

1699 
decode_d©a_addr
->
İ
 = &
audio_decode_d©a_addr_İ
;

1700 
decode_d©a_addr
->
İ
->
	`š™
(decode_data_addr);

1701 
	}
}

1706 
	$ch_audio_’code_š™
(
ch_audio_’code_t
 *
audio_’code
)

1708 if(
audio_’code
 !ğ
NULL
){

1709 
	`š™_audio_’code_´İ”ty
(&
audio_’code
->
cÚfig_·¿m
, &
deçuÉ_audio_’code_cÚfig_desütÜ
);

1710 
	`š™_audio_’code_cÚŒŞ
(&
audio_’code
->
audio_cÚŒŞ
);

1711 
	`š™_audio_pcm_’code_±r_cÚŒŞ
(&
audio_’code
->
pcm_audio_±r
);

1712 
	`š™_audio_pcm_’code_d©a_addr
(&
audio_’code
->
pcm_audio_d©a_ba£
);

1713 
	`š™_audio_adpcm_’code_±r_cÚŒŞ
(&
audio_’code
->
adpcm_audio_±r
);

1714 
	`š™_audio_adpcm_’code_d©a_addr
(&
audio_’code
->
adpcm_audio_d©a_ba£
);

1716 
	}
}

1718 
	$ch_audio_’code_£t_’abË_audio_’code_chª
(
ch_audio_’code_t
 *
audio_’code
, 
chª_id
, 
’abË
, 
dvm_ch_t
 *
ch
)

1720 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

1721 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1722 
ch_audio_t
 *
ch_audio
;

1724 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

1725 
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_’code
(
audio_’code
);

1726 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1727 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

1728 
audio_’abË_cÚŒŞ_t
 *
audio_’abË
 = &
ch_audio
->audio_enable;

1729 if((
audio_’abË
->
İ
!=
NULL
è&& (
cÚfig_·¿m
->op!=NULL)){

1730 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1731 
TW_AUDIO_PCM
:

1732 
audio_’abË
->
İ
->
	`£t_’abË_adpcm_’code
×udio_’abË, 
AUDIO_DISABLE
, 
ch
);

1733 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
, 
ch
);

1734 if(
’abË
 =ğ
AUDIO_ENABLE
){

1735 
audio_’abË
->
İ
->
	`£t_’abË_pcm_’code
×udio_’abË, 
AUDIO_ENABLE
, 
ch
);

1736 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_ENABLE
, 
ch
);

1737 } if(
’abË
 =ğ
AUDIO_DISABLE
){

1738 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
, 
ch
);

1739 
audio_’abË
->
İ
->
	`£t_’abË_pcm_’code
×udio_’abË, 
AUDIO_DISABLE
, 
ch
);

1742 
TW_AUDIO_ADPCM_32K
:

1743 if(
’abË
 =ğ
AUDIO_ENABLE
){

1744 
audio_’abË
->
İ
->
	`£t_’abË_pcm_’code
×udio_’abË, 
AUDIO_ENABLE
, 
ch
);

1745 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_ENABLE
, 
ch
);

1746 
audio_’abË
->
İ
->
	`£t_’abË_adpcm_’code
×udio_’abË, 
AUDIO_ENABLE
, 
ch
);

1747 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_ENABLE
, 
ch
);

1748 } if(
’abË
 =ğ
AUDIO_DISABLE
){

1749 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
, 
ch
);

1750 
audio_’abË
->
İ
->
	`£t_’abË_adpcm_’code
×udio_’abË, 
AUDIO_DISABLE
, 
ch
);

1751 
audio_cÚŒŞ
->
İ
->
	`£t_’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
, 
ch
);

1752 
audio_’abË
->
İ
->
	`£t_’abË_pcm_’code
×udio_’abË, 
AUDIO_DISABLE
, 
ch
);

1756 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1761 
	}
}

1763 
	$ch_audio_’code_upd©e_’abË_audio_’code_chª
(
ch_audio_’code_t
 *
audio_’code
, 
chª_id
, 
’abË
)

1765 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

1766 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1767 
ch_audio_t
 *
ch_audio
;

1769 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

1770 
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_’code
(
audio_’code
);

1771 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1772 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

1773 
audio_’abË_cÚŒŞ_t
 *
audio_’abË
 = &
ch_audio
->audio_enable;

1774 if((
audio_’abË
->
İ
!=
NULL
è&& (
cÚfig_·¿m
->op!=NULL)){

1775 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1776 
TW_AUDIO_PCM
:

1777 
audio_cÚŒŞ
->
İ
->
	`di§bË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
);

1778 
audio_’abË
->
İ
->
	`upd©e_’abË_adpcm_’code
×udio_’abË, 
AUDIO_DISABLE
);

1779 if(
’abË
 =ğ
AUDIO_ENABLE
){

1780 
audio_cÚŒŞ
->
İ
->
	`’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
);

1781 
audio_’abË
->
İ
->
	`upd©e_’abË_pcm_’code
×udio_’abË, 
AUDIO_ENABLE
);

1782 } if(
’abË
 =ğ
AUDIO_DISABLE
){

1783 
audio_cÚŒŞ
->
İ
->
	`di§bË_pcm_chª
×udio_cÚŒŞ, 
chª_id
);

1784 
audio_’abË
->
İ
->
	`upd©e_’abË_pcm_’code
×udio_’abË, 
AUDIO_DISABLE
);

1787 
TW_AUDIO_ADPCM_32K
:

1788 if(
’abË
 =ğ
AUDIO_ENABLE
){

1789 
audio_cÚŒŞ
->
İ
->
	`’abË_pcm_chª
×udio_cÚŒŞ, 
chª_id
);

1790 
audio_’abË
->
İ
->
	`upd©e_’abË_pcm_’code
×udio_’abË, 
AUDIO_ENABLE
);

1791 
audio_cÚŒŞ
->
İ
->
	`’abË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
);

1792 
audio_’abË
->
İ
->
	`upd©e_’abË_adpcm_’code
×udio_’abË, 
AUDIO_ENABLE
);

1793 } if(
’abË
 =ğ
AUDIO_DISABLE
){

1794 
audio_cÚŒŞ
->
İ
->
	`di§bË_adpcm_chª
×udio_cÚŒŞ, 
chª_id
);

1795 
audio_’abË
->
İ
->
	`upd©e_’abË_adpcm_’code
×udio_’abË, 
AUDIO_DISABLE
);

1796 
audio_cÚŒŞ
->
İ
->
	`di§bË_pcm_chª
×udio_cÚŒŞ, 
chª_id
);

1797 
audio_’abË
->
İ
->
	`upd©e_’abË_pcm_’code
×udio_’abË, 
AUDIO_DISABLE
);

1801 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1806 
	}
}

1808 
	$ch_audio_’code_g‘_audio_’code_chª_’abË_¡©e
(
ch_audio_’code_t
 *
audio_’code
, 
chª_id
)

1810 
»t
 = 
AUDIO_DISABLE
;

1811 
audio_’code_cÚŒŞ_t
 *
audio_cÚŒŞ
;

1812 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1814 
audio_cÚŒŞ
 = &
audio_’code
->audio_control;

1815 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1816 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

1817 
ch_audio_t
 *
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_’code
(
audio_’code
);

1818 
audio_’abË_cÚŒŞ_t
 *
audio_’abË
 = &
ch_audio
->audio_enable;

1819 if((
audio_’abË
->
İ
!=
NULL
è&& (
cÚfig_·¿m
->op!=NULL)){

1820 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1821 
TW_AUDIO_PCM
:

1822 
»t
 = 
audio_’abË
->
İ
->
	`g‘_pcm_’code_¡©e
(audio_enable);

1824 
TW_AUDIO_ADPCM_32K
:

1825 
»t
 = 
audio_’abË
->
İ
->
	`g‘_adpcm_’code_¡©e
(audio_enable);

1828 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1833  
»t
;

1834 
	}
}

1836 
	$ch_audio_’code_g‘_audio_’code_chª_rd_±r
(
ch_audio_’code_t
 *
audio_’code
, 
chª_id
, *
ext_æag
, *
queue_size
)

1838 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1839 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1840 
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_audio_±r
;

1841 
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_audio_±r
;

1843 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1844 *
ext_æag
 = 0;

1845 *
queue_size
 = 0;

1846 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

1847 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1848 
TW_AUDIO_PCM
:

1849 
pcm_audio_±r
 = &
audio_’code
->pcm_audio_ptr;

1850 if(
pcm_audio_±r
->
İ
 !ğ
NULL
){

1851 
»t
 = 
pcm_audio_±r
->
İ
->
	`g‘_chª_rd_±r
Õcm_audio_±r, 
chª_id
, 
ext_æag
);

1852 *
queue_size
 = 
pcm_audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(pcm_audio_ptr);

1855 
TW_AUDIO_ADPCM_32K
:

1856 
adpcm_audio_±r
 = &
audio_’code
->adpcm_audio_ptr;

1857 if(
adpcm_audio_±r
->
İ
 !ğ
NULL
){

1858 
»t
 = 
adpcm_audio_±r
->
İ
->
	`g‘_chª_rd_±r
×dpcm_audio_±r, 
chª_id
, 
ext_æag
);

1859 *
queue_size
 = 
adpcm_audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(adpcm_audio_ptr);

1863 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1867  
»t
;

1868 
	}
}

1870 
	$ch_audio_’code_g‘_audio_’code_chª_wr_±r
(
ch_audio_’code_t
 *
audio_’code
, 
chª_id
, *
ext_æag
, *
queue_size
)

1872 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

1873 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1874 
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_audio_±r
;

1875 
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_audio_±r
;

1877 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1878 *
ext_æag
 = 0;

1879 *
queue_size
 = 0;

1880 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

1881 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1882 
TW_AUDIO_PCM
:

1883 
pcm_audio_±r
 = &
audio_’code
->pcm_audio_ptr;

1884 if(
pcm_audio_±r
->
İ
 !ğ
NULL
){

1885 
»t
 = 
pcm_audio_±r
->
İ
->
	`g‘_chª_wr_±r
Õcm_audio_±r, 
chª_id
, 
ext_æag
);

1886 *
queue_size
 = 
pcm_audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(pcm_audio_ptr);

1889 
TW_AUDIO_ADPCM_32K
:

1890 
adpcm_audio_±r
 = &
audio_’code
->adpcm_audio_ptr;

1891 if(
adpcm_audio_±r
->
İ
 !ğ
NULL
){

1892 
»t
 = 
adpcm_audio_±r
->
İ
->
	`g‘_chª_wr_±r
×dpcm_audio_±r, 
chª_id
, 
ext_æag
);

1893 *
queue_size
 = 
adpcm_audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(adpcm_audio_ptr);

1897 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1901  
»t
;

1902 
	}
}

1904 
	$ch_audio_’code_g‘_audio_’code_·¿m
(
ch_audio_’code_t
 *
audio_’code
, 
dvm_ch_t
 *
ch
)

1906 if(
ch
 !ğ
NULL
){

1907 
audio_’code
->
audio_cÚŒŞ
.
İ
->
	`g‘_audio_·¿m
(&audio_’code->audio_cÚŒŞ, 
ch
);

1908 
audio_’code
->
pcm_audio_±r
.
İ
->
	`g‘_pcm_wr_rd_±r
(&audio_’code->pcm_audio_±r, 
ch
);

1909 
audio_’code
->
adpcm_audio_±r
.
İ
->
	`g‘_adpcm_wr_rd_±r
(&audio_’code->adpcm_audio_±r, 
ch
);

1911 
	}
}

1913 
	$ch_audio_’code_£t_audio_’code_·¿m
(
ch_audio_’code_t
 *
audio_’code
, 
dvm_ch_t
 *
ch
)

1915 if(
ch
 !ğ
NULL
){

1916 
audio_’code
->
audio_cÚŒŞ
.
İ
->
	`£t_audio_·¿m
(&audio_’code->audio_cÚŒŞ, 
ch
);

1918 
	}
}

1920 
	$ch_audio_’code_£t_fšish_rd_±r
(
ch_audio_’code_t
 *
audio_’code
, 
fšish_rd_±r
, 
dvm_ch_t
 *
ch
)

1922 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

1923 
audio_pcm_’code_±r_cÚŒŞ_t
 *
pcm_audio_±r
;

1924 
audio_adpcm_’code_±r_cÚŒŞ_t
 *
adpcm_audio_±r
;

1926 
cÚfig_·¿m
 = &
audio_’code
->config_param;

1927 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

1928 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

1929 
TW_AUDIO_PCM
:

1930 
pcm_audio_±r
 = &
audio_’code
->pcm_audio_ptr;

1931 if(
pcm_audio_±r
->
İ
 !ğ
NULL
){

1932 
pcm_audio_±r
->
İ
->
	`£t_rd_fšish_numb”
Õcm_audio_±r, 
fšish_rd_±r
, 
ch
);

1935 
TW_AUDIO_ADPCM_32K
:

1936 
adpcm_audio_±r
 = &
audio_’code
->adpcm_audio_ptr;

1937 if(
adpcm_audio_±r
->
İ
 !ğ
NULL
){

1938 
adpcm_audio_±r
->
İ
->
	`£t_rd_fšish_numb”
×dpcm_audio_±r, 
fšish_rd_±r
, 
ch
);

1942 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

1946 
	}
}

1948 
ch_audio_’code_İ”©iÚ
 
	gch_audio_’code_İ
 = {

1949 .
š™
 = 
ch_audio_’code_š™
,

1951 .
	g£t_’abË_audio_’code_chª
 = 
ch_audio_’code_£t_’abË_audio_’code_chª
,

1952 .
	gupd©e_’abË_audio_’code_chª
 = 
ch_audio_’code_upd©e_’abË_audio_’code_chª
,

1953 .
	gg‘_audio_’code_chª_’abË_¡©e
 = 
ch_audio_’code_g‘_audio_’code_chª_’abË_¡©e
,

1955 .
	gg‘_audio_’code_chª_rd_±r
 = 
ch_audio_’code_g‘_audio_’code_chª_rd_±r
,

1956 .
	gg‘_audio_’code_chª_wr_±r
 = 
ch_audio_’code_g‘_audio_’code_chª_wr_±r
,

1958 .
	gg‘_audio_’code_·¿m
 = 
ch_audio_’code_g‘_audio_’code_·¿m
,

1959 .
	g£t_audio_’code_·¿m
 = 
ch_audio_’code_£t_audio_’code_·¿m
,

1960 .
	g£t_fšish_rd_±r
 = 
ch_audio_’code_£t_fšish_rd_±r
,

1963 
	$š™_ch_audio_’code
(
ch_audio_’code_t
 *
audio_’code
)

1965 
audio_’code
->
İ
 = &
ch_audio_’code_İ
;

1966 
audio_’code
->
İ
->
	`š™
(audio_encode);

1967 
	}
}

1972 
	$ch_audio_decode_š™
(
ch_audio_decode_t
 *
audio_decode
)

1974 
	`š™_audio_decode_´İ”ty
(&
audio_decode
->
cÚfig_·¿m
, &
deçuÉ_audio_decode_cÚfig_desütÜ
);

1975 
	`š™_audio_decode_cÚŒŞ
(&
audio_decode
->
audio_cÚŒŞ
);

1976 
	`š™_audio_decode_±r_cÚŒŞ
(&
audio_decode
->
audio_±r
);

1977 
	`š™_audio_decode_d©a_addr
(&
audio_decode
->
audio_d©a_ba£
);

1978 
	}
}

1980 
	$ch_audio_decode_upd©e_’abË_audio_decode_chª
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, 
’abË
)

1982 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

1983 
ch_audio_t
 *
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_decode
(
audio_decode
);

1984 
audio_’abË_cÚŒŞ_t
 *
audio_’abË
 = &
ch_audio
->audio_enable;

1985 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

1986 if(
’abË
 =ğ
AUDIO_ENABLE
){

1987 
audio_’abË
->
İ
->
	`upd©e_’abË_adpcm_decode
×udio_’abË, 
AUDIO_ENABLE
);

1988 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_’abË
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_ENABLE
);

1990 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_’abË
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
);

1991 
audio_’abË
->
İ
->
	`upd©e_’abË_adpcm_decode
×udio_’abË, 
AUDIO_DISABLE
);

1994 
	}
}

1996 
	$ch_audio_decode_g‘_audio_decode_chª_¡©e
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
)

1998 
»t
 = 
AUDIO_DISABLE
;

1999 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

2000 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

2001 
»t
 = 
audio_cÚŒŞ
->
İ
->
	`g‘_decode_chª_’abË
×udio_cÚŒŞ, 
chª_id
);

2003  
»t
;

2004 
	}
}

2006 
	$ch_audio_decode_£t_’abË_audio_decode_chª
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, 
’abË
, 
dvm_ch_t
 *
ch
)

2008 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

2009 
ch_audio_t
 *
ch_audio
 = 
	`to_g‘_ch_audio_w™h_audio_decode
(
audio_decode
);

2010 
audio_’abË_cÚŒŞ_t
 *
audio_’abË
 = &
ch_audio
->audio_enable;

2012 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

2013 if(
’abË
 =ğ
AUDIO_ENABLE
){

2014 
audio_’abË
->
İ
->
	`£t_’abË_adpcm_decode
×udio_’abË, 
AUDIO_ENABLE
, 
ch
);

2015 
audio_cÚŒŞ
->
İ
->
	`£t_decode_chª_’abË
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_ENABLE
, 
ch
);

2016 }if(
’abË
 =ğ
AUDIO_DISABLE
){

2017 
audio_cÚŒŞ
->
İ
->
	`£t_decode_chª_’abË
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_DISABLE
, 
ch
);

2018 
audio_’abË
->
İ
->
	`£t_’abË_adpcm_decode
×udio_’abË, 
AUDIO_DISABLE
, 
ch
);

2021 
	}
}

2023 
	$ch_audio_decode_upd©e_mu‹_audio_decode_chª
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, 
mu‹
)

2025 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

2026 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

2027 if(
mu‹
 =ğ
AUDIO_MUTE_ENABLE
){

2028 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_mu‹
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_MUTE_ENABLE
);

2030 
audio_cÚŒŞ
->
İ
->
	`upd©e_decode_chª_mu‹
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_MUTE_DISABLE
);

2033 
	}
}

2035 
	$ch_audio_decode_g‘_audio_decode_mu‹_¡©e
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
)

2037 
»t
 = 
AUDIO_MUTE_ENABLE
;

2038 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

2039 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

2040 
»t
 = 
audio_cÚŒŞ
->
İ
->
	`g‘_decode_chª_mu‹
×udio_cÚŒŞ, 
chª_id
);

2042  
»t
;

2043 
	}
}

2045 
	$ch_audio_decode_upd©e_£t_mu‹_audio_decode_chª
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, 
mu‹
, 
dvm_ch_t
 *
ch
)

2047 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;

2048 if(
audio_cÚŒŞ
->
İ
 !ğ
NULL
){

2049 if(
mu‹
 =ğ
AUDIO_MUTE_ENABLE
){

2050 
audio_cÚŒŞ
->
İ
->
	`£t_decode_chª_mu‹
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_MUTE_ENABLE
, 
ch
);

2051 }if(
mu‹
 =ğ
AUDIO_MUTE_DISABLE
){

2052 
audio_cÚŒŞ
->
İ
->
	`£t_decode_chª_mu‹
×udio_cÚŒŞ, 
chª_id
, 
AUDIO_MUTE_DISABLE
, 
ch
);

2055 
	}
}

2057 
	$ch_audio_decode_g‘_audio_decode_chª_rd_±r
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, *
ext_æag
, *
queue_size
)

2059 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

2060 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

2061 
audio_decode_±r_cÚŒŞ_t
 *
audio_±r
;

2063 
cÚfig_·¿m
 = &
audio_decode
->config_param;

2064 *
ext_æag
 = 0;

2065 *
queue_size
 = 0;

2066 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2067 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

2068 
TW_AUDIO_PCM
:

2069 
TW_AUDIO_ADPCM_32K
:

2070 
audio_±r
 = &
audio_decode
->audio_ptr;

2071 if(
audio_±r
->
İ
 !ğ
NULL
){

2072 
»t
 = 
audio_±r
->
İ
->
	`g‘_chª_rd_±r
×udio_±r, 
chª_id
, 
ext_æag
);

2073 *
queue_size
 = 
audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(audio_ptr);

2077 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

2081  
»t
;

2082 
	}
}

2084 
	$ch_audio_decode_g‘_audio_decode_chª_wr_±r
(
ch_audio_decode_t
 *
audio_decode
, 
chª_id
, *
ext_æag
, *
queue_size
)

2086 
»t
 = 
INVALID_TW_AUDIO_SECTION_ID
;

2087 
tw_audio_·¿m_t
 *
cÚfig_·¿m
;

2088 
audio_decode_±r_cÚŒŞ_t
 *
audio_±r
;

2089 
cÚfig_·¿m
 = &
audio_decode
->config_param;

2090 *
ext_æag
 = 0;

2091 *
queue_size
 = 0;

2092 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2093 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param)){

2094 
TW_AUDIO_PCM
:

2095 
TW_AUDIO_ADPCM_32K
:

2096 
audio_±r
 = &
audio_decode
->audio_ptr;

2097 if(
audio_±r
->
İ
 !ğ
NULL
){

2098 
»t
 = 
audio_±r
->
İ
->
	`g‘_chª_wr_±r
×udio_±r, 
chª_id
, 
ext_æag
);

2099 *
queue_size
 = 
audio_±r
->
İ
->
	`g‘_chª_£ùiÚ_numb”
(audio_ptr);

2103 
	`´štk
("%s.%d:‚Øsu½pÜˆ%dy³\n", 
__FUNCTION__
, 
__LINE__
, 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param));

2107  
»t
;

2108 
	}
}

2110 
	$ch_audio_decode_g‘_audio_decode_·¿m
(
ch_audio_decode_t
 *
audio_decode
, 
dvm_ch_t
 *
ch
)

2112 if(
ch
 !ğ
NULL
){

2113 
audio_decode
->
audio_cÚŒŞ
.
İ
->
	`g‘_decode_·¿m
(&audio_decode->audio_cÚŒŞ, 
ch
);

2114 
audio_decode
->
audio_±r
.
İ
->
	`g‘_adpcm_wr_rd_±r
(&audio_decode->audio_±r, 
ch
);

2116 
	}
}

2118 
	$ch_audio_decode_£t_audio_decode_·¿m
(
ch_audio_decode_t
 *
audio_decode
, 
dvm_ch_t
 *
ch
)

2120 if(
ch
 !ğ
NULL
){

2121 
audio_decode_cÚŒŞ_t
 *
audio_cÚŒŞ
 = &
audio_decode
->audio_control;;

2122 
audio_cÚŒŞ
->
İ
->
	`£t_decode_·¿m
×udio_cÚŒŞ, 
ch
);

2124 
	}
}

2126 
ch_audio_decode_İ”©iÚ
 
	gch_audio_decode_İ
 = {

2127 .
š™
 = 
ch_audio_decode_š™
,

2129 .
	gupd©e_’abË_audio_decode_chª
 = 
ch_audio_decode_upd©e_’abË_audio_decode_chª
,

2130 .
	gg‘_audio_decode_chª_’abË_¡©e
 = 
ch_audio_decode_g‘_audio_decode_chª_¡©e
,

2131 .
	g£t_’abË_audio_decode_chª
 = 
ch_audio_decode_£t_’abË_audio_decode_chª
,

2132 .
	gupd©e_mu‹_audio_decode_chª
 = 
ch_audio_decode_upd©e_mu‹_audio_decode_chª
,

2133 .
	gg‘_audio_decode_mu‹_¡©e
 = 
ch_audio_decode_g‘_audio_decode_mu‹_¡©e
,

2134 .
	g£t_mu‹_audio_decode_chª
 = 
ch_audio_decode_upd©e_£t_mu‹_audio_decode_chª
,

2135 .
	gg‘_audio_decode_chª_rd_±r
 = 
ch_audio_decode_g‘_audio_decode_chª_rd_±r
,

2136 .
	gg‘_audio_decode_chª_wr_±r
 = 
ch_audio_decode_g‘_audio_decode_chª_wr_±r
,

2137 .
	gg‘_audio_decode_·¿m
 = 
ch_audio_decode_g‘_audio_decode_·¿m
,

2138 .
	g£t_audio_decode_·¿m
 = 
ch_audio_decode_£t_audio_decode_·¿m
,

2141 
	$š™_ch_audio_decode
(
ch_audio_decode_t
 *
audio_decode
)

2143 
audio_decode
->
İ
 = &
ch_audio_decode_İ
;

2144 
audio_decode
->
İ
->
	`š™
(audio_decode);

2145 
	}
}

2150 
	$ch_audio_š™
(
ch_audio_t
 *
ch_audio
)

2152 
	`š™_audio_’abË_cÚŒŞ
(&
ch_audio
->
audio_’abË
);

2153 
	`š™_ch_audio_’code
(&
ch_audio
->
audio_’code
);

2154 
	`š™_ch_audio_decode
(&
ch_audio
->
audio_decode
);

2155 
	}
}

2157 
	$ch_audio_£t_’code_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
, 
ty³
)

2159 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2160 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_’code
->config_param;

2161 if(
ty³
 !ğ
TW_AUDIO_ADPCM_32K
){

2162 
	`´štk
("%s.%d:y³=%d, wÚly su½pÜˆadpcm mode\n", 
__FUNCTION__
, 
__LINE__
, 
ty³
);

2163 
ty³
 = 
TW_AUDIO_ADPCM_32K
;

2165 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2166 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
ty³
);

2168 
	}
}

2170 
	$ch_audio_upd©e_’code_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
, 
ty³
)

2172 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2173 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_’code
->config_param;

2174 if((
ty³
!=
TW_AUDIO_ADPCM_32K
è&& (ty³!=
TW_AUDIO_PCM
)){

2175 
	`TW_DBG
(
TW_DBG_ERR
, "ty³=%d, wÚly su½pÜˆadpcm‡nd…cm mode\n", 
ty³
);

2176 
ty³
 = 
TW_AUDIO_ADPCM_32K
;

2178 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2179 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
ty³
);

2181 
	}
}

2183 
	$ch_audio_g‘_’code_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
)

2185 
»t
 = 
TW_AUDIO_ADPCM_32K
;

2186 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2187 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_’code
->config_param;

2188 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
) {

2189 
»t
 = 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param);

2191  
»t
;

2192 
	}
}

2194 
	$ch_audio_£t_decode_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
, 
ty³
)

2196 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2197 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_decode
->config_param;

2198 if((
ty³
!=
TW_AUDIO_ADPCM_32K
è&& (ty³!=
TW_AUDIO_PCM
)){

2199 
	`TW_DBG
(
TW_DBG_ERR
, "ty³=%d, wÚly su½pÜˆadpcm‡nd…cm mode\n", 
ty³
);

2200 
ty³
 = 
TW_AUDIO_ADPCM_32K
;

2202 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2203 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
ty³
);

2205 
	}
}

2207 
	$ch_audio_upd©e_decode_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
, 
ty³
)

2209 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2210 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_decode
->config_param;

2211 if((
ty³
!=
TW_AUDIO_ADPCM_32K
è&& (ty³!=
TW_AUDIO_PCM
)){

2212 
	`TW_DBG
(
TW_DBG_ERR
, "ty³=%d, wÚly su½pÜˆadpcm‡nd…cm mode\n", 
ty³
);

2213 
ty³
 = 
TW_AUDIO_ADPCM_32K
;

2215 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2216 
cÚfig_·¿m
->
İ
->
	`upd©e_ty³
(cÚfig_·¿m, 
ty³
);

2218 
	}
}

2220 
	$ch_audio_g‘_decode_audio_chª_ty³
(
ch_audio_t
 *
ch_audio
)

2222 
»t
 = 
TW_AUDIO_ADPCM_32K
;

2223 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2224 
tw_audio_·¿m_t
 *
cÚfig_·¿m
 = &
audio_decode
->config_param;

2225 if(
cÚfig_·¿m
->
İ
 !ğ
NULL
){

2226 
»t
 = 
cÚfig_·¿m
->
İ
->
	`g‘_ty³
(config_param);

2228  
»t
;

2229 
	}
}

2231 
	$ch_audio_£t_’abË_audio_chª
(
ch_audio_t
 *
ch_audio
, 
chª_id
, 
’abË
)

2233 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2234 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2235 if(
audio_’code
->
İ
 !ğ
NULL
){

2236 
audio_’code
->
İ
->
	`£t_’abË_audio_’code_chª
×udio_’code, 
chª_id
, 
’abË
, 
ch_audio
->
ch
);

2238 } if(
chª_id
 < 
TW_AUDIO_CHAN_NUMBER
){

2239 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2240 if(
audio_decode
->
İ
 !ğ
NULL
){

2241 
audio_decode
->
İ
->
	`£t_’abË_audio_decode_chª
×udio_decode, 
chª_id
, 
’abË
, 
ch_audio
->
ch
);

2244 
	}
}

2246 
	$ch_audio_upd©e_’abË_audio_chª
(
ch_audio_t
 *
ch_audio
, 
chª_id
, 
’abË
)

2248 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2249 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2250 if(
audio_’code
->
İ
 !ğ
NULL
){

2251 
audio_’code
->
İ
->
	`upd©e_’abË_audio_’code_chª
×udio_’code, 
chª_id
, 
’abË
);

2253 } if(
chª_id
 < 
TW_AUDIO_CHAN_NUMBER
){

2254 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2255 if(
audio_decode
->
İ
 !ğ
NULL
){

2256 
audio_decode
->
İ
->
	`upd©e_’abË_audio_decode_chª
×udio_decode, 
chª_id
, 
’abË
);

2259 
	}
}

2261 
	$ch_audio_g‘_audio_chª_’abË_¡©e
(
ch_audio_t
 *
ch_audio
, 
chª_id
)

2263 
»t
 = 
AUDIO_DISABLE
;

2264 if(
ch_audio
 !ğ
NULL
){

2265 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2266 
ch_audio_’code_t
 *
audio_’code
 = &
ch_audio
->audio_encode;

2267 if(
audio_’code
->
İ
 !ğ
NULL
){

2268 
»t
 = 
audio_’code
->
İ
->
	`g‘_audio_’code_chª_’abË_¡©e
×udio_’code, 
chª_id
);

2271 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2272 if(
audio_decode
->
İ
 !ğ
NULL
){

2273 
»t
 = 
audio_decode
->
İ
->
	`g‘_audio_decode_chª_’abË_¡©e
×udio_decode, 
chª_id
);

2277  
»t
;

2278 
	}
}

2280 
	$ch_audio_£t_mu‹_audio_chª
(
ch_audio_t
 *
ch_audio
, 
chª_id
, 
mu‹
)

2282 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2284 } if(
chª_id
 < 
TW_AUDIO_CHAN_NUMBER
){

2285 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2286 if(
audio_decode
->
İ
 !ğ
NULL
){

2287 
audio_decode
->
İ
->
	`£t_mu‹_audio_decode_chª
×udio_decode, 
chª_id
, 
mu‹
, 
ch_audio
->
ch
);

2290 
	}
}

2292 
	$ch_audio_upd©e_mu‹_audio_chª
(
ch_audio_t
 *
ch_audio
, 
chª_id
, 
mu‹
)

2294 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2296 } if(
chª_id
 < 
TW_AUDIO_CHAN_NUMBER
){

2297 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2298 if(
audio_decode
->
İ
 !ğ
NULL
){

2299 
audio_decode
->
İ
->
	`upd©e_mu‹_audio_decode_chª
×udio_decode, 
chª_id
, 
mu‹
);

2302 
	}
}

2304 
	$ch_audio_g‘_audio_chª_mu‹_¡©e
(
ch_audio_t
 *
ch_audio
, 
chª_id
)

2306 
»t
 = 
AUDIO_MUTE_ENABLE
;

2307 if(
chª_id
 < 
TW_AUDIO_IN_CHAN_NUMBER
){

2309 } if(
chª_id
 < 
TW_AUDIO_CHAN_NUMBER
){

2310 
ch_audio_decode_t
 *
audio_decode
 = &
ch_audio
->audio_decode;

2311 if(
audio_decode
->
İ
 !ğ
NULL
){

2312 
»t
 = 
audio_decode
->
İ
->
	`g‘_audio_decode_mu‹_¡©e
(&
ch_audio
->audio_decode, 
chª_id
);

2315  
»t
;

2316 
	}
}

2318 
	$ch_audio_g‘_ch_audio_·¿m
(
ch_audio_t
 *
ch_audio
)

2320 
dvm_ch_t
 *
ch
 = 
ch_audio
->chip;

2321 
ch_audio
->
audio_’abË
.
İ
->
	`g‘_’abË_cÚŒŞ_·¿m
(&ch_audio->audio_’abË, 
ch
);

2322 
ch_audio
->
audio_’code
.
İ
->
	`g‘_audio_’code_·¿m
(&ch_audio->audio_’code, 
ch
);

2323 
ch_audio
->
audio_decode
.
İ
->
	`g‘_audio_decode_·¿m
(&ch_audio->audio_decode, 
ch
);

2324 
	}
}

2326 
	$ch_audio_£t_ch_audio_·¿m
(
ch_audio_t
 *
ch_audio
)

2328 
dvm_ch_t
 *
ch
 = 
ch_audio
->chip;

2329 
ch_audio
->
audio_’abË
.
İ
->
	`£t_’abË_cÚŒŞ_·¿m
(&ch_audio->audio_’abË, 
ch
);

2330 
ch_audio
->
audio_’code
.
İ
->
	`£t_audio_’code_·¿m
(&ch_audio->audio_’code, 
ch
);

2331 
ch_audio
->
audio_decode
.
İ
->
	`£t_audio_decode_·¿m
(&ch_audio->audio_decode, 
ch
);

2332 
	}
}

2334 
	$audio_’code_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
(
œq
, *
cÚ‹xt
)

2336 
tw_audio_driv”_t
 *
audio_chª_driv”
 = (tw_audio_driv”_t*)
cÚ‹xt
;

2337 
»t
 = 1;

2338 if(
audio_chª_driv”
 !ğ
NULL
){

2339 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

2340 
dvm_ch_t
 *
ch
 = 
audio_chª_driv”
->
ch_audio
->chip;

2341 
ch_audio_’code_t
 *
audio_’code
 = &
audio_chª_driv”
->
ch_audio
->audio_encode;

2342 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

2343 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

2344 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

2345 
tw_time¡amp_t
 *
time¡amp
 = &
audio_chª_driv”
->timestamp;

2346 
d´am_·ge_node_t
 *
d´am_·ge
;

2347 
audio_£ùiÚ_desütÜ_t
 
desütÜ
;

2348 
u32
 
d´am_ba£
;

2349 
fšish_id
;

2351 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

2352 
d´am_·ge
 = 
audio_chª_driv”
->dpram_page;

2353 
d´am_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

2354 
d´am_ba£
 +ğ
AUDIO_SECTION_SIZE
;

2355 
d´am_ba£
 -ğ(
audio_£ùiÚ_desütÜ_t
);

2356 *((
u32
*)&
desütÜ
èğ
ch
->
io_İ
->
	`ch_»ad32
(ch, 
d´am_ba£
);

2357 
time¡amp
->
İ
->
	`£t_time¡amp
Ñime¡amp, 
desütÜ
.time¡amp, 
__FILE__
);

2359 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
×udio_·ck‘_queue, &
audio_chª_driv”
->
audio_buf_poŞ
);

2360 if(
audio_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

2361 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_£ùiÚ
 = 
audio_·ck‘_queue
->
cu¼_´oduûr
;

2362 
tw_audio_desütÜ_t
 *
audio_desütÜ
 = &
audio_£ùiÚ
->
desütÜ
;

2364 *((
u32
*)
audio_desütÜ
->
desütÜ
) = *((u32*)&descriptor);

2365 
audio_£ùiÚ
->
·ylßd_Ën
 = 
audio_desütÜ
->
İ
->
	`g‘_audio_desütÜ_v®id_Ën
(audio_descriptor);

2366 
audio_£ùiÚ
->
§m¶e_¿‹
 = 
audio_desütÜ
->
İ
->
	`g‘_audio_desütÜ_§m¶e_¿‹
(audio_descriptor);

2367 
audio_£ùiÚ
->
ty³
 = 
audio_desütÜ
->
İ
->
	`g‘_audio_desütÜ_ty³
(audio_descriptor);

2368 
audio_£ùiÚ
->
b™_wide
 = 
audio_desütÜ
->
İ
->
	`g‘_audio_desütÜ_b™_wide
(audio_descriptor);

2369 
audio_£ùiÚ
->
time¡amp
 =ime¡amp->
İ
->
	`g‘_time¡amp
(timestamp);

2370 
audio_£ùiÚ
->
äameS”Ÿl
 = 
audio_chª_driv”
->
i_äame_£rŸl
++;

2372 
audio_£ùiÚ
->
İ
->
	`dma_m­
×udio_£ùiÚ, 
DMA_FROM_DEVICE
);

2373 
audio_£ùiÚ
->
·ylßd_Ën
 = 
	`H264_MIN
(×udio_£ùiÚ->
£ùiÚ_size
-(
ext_h264_Çl_b™¡»am_t
)),‡udio_section->payload_len);

2374 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
audio_chª_driv”
->
d´am_·ge
, 
audio_£ùiÚ
->
dma_addr
+(
ext_h264_Çl_b™¡»am_t
),‡udio_£ùiÚ->
·ylßd_Ën
);

2375 
audio_£ùiÚ
->
İ
->
	`dma_unm­
×udio_£ùiÚ, 
DMA_FROM_DEVICE
);

2376 
audio_£ùiÚ
->
·ylßd_Ën
 = 
	`g’_ext_Çl_audio_h—d”
×udio_£ùiÚ->
d©a
,‡udio_£ùiÚ->
ty³
,‡udio_section->payload_len);

2377 
audio_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(audio_packet_queue);

2379 
audio_chª_driv”
->
disÿrd_numb”
++;

2383 
fšish_id
 = 
audio_£ùiÚ_·¿m
->
İ
->
	`g‘_upd©e_fšish_id
(audio_section_param);

2384 
audio_’code
->
İ
->
	`£t_fšish_rd_±r
×udio_’code, 
fšish_id
, 
ch
);

2387 
	`ch_ä“_œq
(
ch
, 
IRQ_BURST_TYPE_INTR
, 
audio_chª_driv”
);

2388 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

2389 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2391  
»t
;

2392 
	}
}

2394 
	$audio_’code_chª_¡¬t_»ad_b™¡»am
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

2396 
»t
=1;

2397 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

2398 
tw_audio_driv”_t
 *
audio_chª_driv”
 = (tw_audio_driv”_t*)
cÚ‹xt
;

2399 
dvm_ch_t
 *
ch
 = 
audio_chª_driv”
->
ch_audio
->chip;

2400 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

2401 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

2402 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

2404 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2405 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

2406 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

2407 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
audio_chª_driv”
->
d´am_·ge
)){

2408 
	`ch_»que¡_œq
(
ch
, 
IRQ_BURST_TYPE_INTR
, 
audio_’code_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
, "BURST", (*)
audio_chª_driv”
);

2409 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
audio_chª_driv”
->
d´am_·ge
, 
audio_£ùiÚ_·¿m
->
ddr_’d_addr
,‡udio_£ùiÚ_·¿m->
·ge_id
, 
AUDIO_SECTION_SIZE
,‡udio_£ùiÚ_·¿m->
ch_a_Ü_b
);

2410 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2412 
d´am_»que¡_queue_t
 *
»que¡_queue
;

2413 
»que¡_queue
 = &
ch_d´am_cÚŒŞËr
->request_queue;

2414 
»que¡_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(request_queue);

2415 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2416 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2417 
	`´štk
("%s.%d:„‘rigg”\n", 
__FUNCTION__
, 
__LINE__
);

2421  
»t
;

2422 
	}
}

2424 
	$š™_subm™_»cv_audio_b™¡»am_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_audio_driv”_t
 *
audio_chª_driv”
)

2426 if((
d´am_»q
!=
NULL
è|| (
audio_chª_driv”
!=NULL)){

2427 
d´am_»q
->
ty³
 = 
DPRAM_NONBLOCK_TRANSFER_REQUEST
;

2428 
d´am_»q
->
cÚ‹xt
 = (*)
audio_chª_driv”
;

2429 
d´am_»q
->
»q_ÿÎback
 = 
audio_’code_chª_¡¬t_»ad_b™¡»am
;

2431 
	}
}

2433 
	$audio_decode_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
(
œq
, *
cÚ‹xt
)

2435 
tw_audio_driv”_t
 *
audio_chª_driv”
 = (tw_audio_driv”_t*)
cÚ‹xt
;

2436 
»t
 = 0;

2437 if(
audio_chª_driv”
 !ğ
NULL
){

2438 
ch_audio_decode_t
 *
audio_decode
 = &
audio_chª_driv”
->
ch_audio
->audio_decode;

2439 
audio_decode_±r_cÚŒŞ_t
 *
audio_decode_±r
 = &
audio_decode
->
audio_±r
;

2440 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

2441 
dvm_ch_t
 *
ch
 = 
audio_chª_driv”
->
ch_audio
->chip;

2442 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

2443 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

2444 
fšish_id
;

2446 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

2447 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

2448 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

2449 
fšish_id
 = 
audio_£ùiÚ_·¿m
->
İ
->
	`g‘_upd©e_fšish_id
(audio_section_param);

2450 
audio_decode_±r
->
İ
->
	`£t_fšish_wr_±r
×udio_decode_±r, 
fšish_id
, 
ch
, 
audio_chª_driv”
->
audio_logic_chª_id
);

2451 
audio_chª_driv”
->
i_äame_£rŸl
++;

2453 
	`ch_ä“_œq
(
ch
, 
IRQ_BURST_TYPE_INTR
, 
audio_chª_driv”
);

2454 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_wr™e_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

2455 
	`driv”_g’_d–iv”_ev’t
(&
audio_chª_driv”
->
audio_ed
, 1);

2456 
»t
 = 1;

2458  
»t
;

2459 
	}
}

2461 
	$audio_decode_chª_¡¬t_£nd_b™¡»am
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

2463 
»t
=1;

2464 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

2465 
tw_audio_driv”_t
 *
audio_chª_driv”
 = (tw_audio_driv”_t*)
cÚ‹xt
;

2466 
dvm_ch_t
 *
ch
 = 
audio_chª_driv”
->
ch_audio
->chip;

2467 
audio_£ùiÚ_±r_šfo_t
 *
audio_£ùiÚ_·¿m
 = &
audio_chª_driv”
->audio_section_param;

2468 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

2469 
tw_audio_chª_buf_poŞ_t
 *
audio_buf_poŞ
 = &
audio_chª_driv”
->audio_buf_pool;

2470 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

2471 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

2472 
ed_tcb_t
 *
ed_tcb
 = &
audio_chª_driv”
->
audio_ed
;

2474 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

2475 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

2476 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_£ùiÚ
 = 
audio_·ck‘_queue
->
cu¼_cÚsum”
;

2477 
tw_audio_desütÜ_t
 *
audio_decode_desütÜ
 = &
audio_£ùiÚ
->
desütÜ
;

2479 
	`driv”_g’_d–iv”_ev’t
(
ed_tcb
, 1);

2481 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
audio_chª_driv”
->
d´am_·ge
)){

2482 
d´am_·ge_node_t
 *
d´am_·ge
;

2483 
u32
 
d´am_ba£
;

2485 
audio_£ùiÚ
->
·ylßd_Ën
 -ğ(
ext_h264_Çl_b™¡»am_t
);

2486 
audio_£ùiÚ
->
İ
->
	`dma_m­
×udio_£ùiÚ, 
DMA_TO_DEVICE
);

2487 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_wr™e
(bur¡_š‹rçû, 
audio_chª_driv”
->
d´am_·ge
, 
audio_£ùiÚ
->
dma_addr
+(
ext_h264_Çl_b™¡»am_t
),‡udio_£ùiÚ->
·ylßd_Ën
);

2488 
audio_£ùiÚ
->
İ
->
	`dma_unm­
×udio_£ùiÚ, 
DMA_TO_DEVICE
);

2490 
d´am_·ge
 = 
audio_chª_driv”
->dpram_page;

2491 
d´am_ba£
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_ba£
(dpram_page);

2492 
d´am_ba£
 +ğ
audio_£ùiÚ
->
£ùiÚ_size
;

2493 
d´am_ba£
 -ğ(
audio_£ùiÚ_desütÜ_t
);

2494 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_v®id_Ën
×udio_decode_desütÜ, 
audio_£ùiÚ
->
·ylßd_Ën
);

2495 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_§m¶e_¿‹
×udio_decode_desütÜ, 
audio_£ùiÚ
->
§m¶e_¿‹
);

2496 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_ty³
×udio_decode_desütÜ, 
audio_£ùiÚ
->
ty³
);

2497 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_b™_wide
×udio_decode_desütÜ, 
audio_£ùiÚ
->
b™_wide
);

2498 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_time¡amp
×udio_decode_desütÜ, 
audio_£ùiÚ
->
time¡amp
&0xffff);

2499 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
d´am_ba£
, (*((
u32
*)
audio_decode_desütÜ
->
desütÜ
)));

2501 
	`ch_»que¡_œq
(
ch
, 
IRQ_BURST_TYPE_INTR
, 
audio_decode_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
, "BURST", (*)
audio_chª_driv”
);

2502 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_¤am_to_ddr
(bur¡_š‹rçû, 
audio_chª_driv”
->
d´am_·ge
, 
audio_£ùiÚ_·¿m
->
ddr_’d_addr
,‡udio_£ùiÚ_·¿m->
·ge_id
, 
AUDIO_SECTION_SIZE
,‡udio_£ùiÚ_·¿m->
ch_a_Ü_b
);

2503 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, 
audio_buf_poŞ
);

2505 
d´am_»que¡_queue_t
 *
»que¡_queue
;

2506 
»que¡_queue
 = &
ch_d´am_cÚŒŞËr
->request_queue;

2507 
»que¡_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(request_queue);

2508 
audio_chª_driv”
->
disÿrd_numb”
++;

2509 
	`driv”_g’_d–iv”_ev’t
(
ed_tcb
, 1);

2510 
	`driv”_g’_d–iv”_ev’t
(
ed_tcb
, 1);

2511 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

2512 
	`´štk
("%s.%d:„‘rigg”\n", 
__FUNCTION__
, 
__LINE__
);

2514 
	`driv”_g’_d–iv”_ev’t
(
ed_tcb
, 1);

2516 
ed_tcb
->
ed_fsm
.
İ
->
	`chªge_¡©e
(&ed_tcb->ed_fsm, 
TW_ED_IDLE
);

2517 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_audio_»q
(ch_d´am_cÚŒŞËr, 
audio_chª_driv”
);

2520  
»t
;

2521 
	}
}

2523 
	$š™_subm™_£nd_audio_b™¡»am_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_audio_driv”_t
 *
audio_chª_driv”
)

2525 if((
d´am_»q
!=
NULL
è|| (
audio_chª_driv”
!=NULL)){

2526 
d´am_»q
->
ty³
 = 
DPRAM_NONBLOCK_TRANSFER_REQUEST
;

2527 
d´am_»q
->
cÚ‹xt
 = (*)
audio_chª_driv”
;

2528 
d´am_»q
->
»q_ÿÎback
 = 
audio_decode_chª_¡¬t_£nd_b™¡»am
;

2530 
	}
}

2532 
	$ch_audio_´oûss_audio_’code
(
ch_audio_t
 *
ch_audio
)

2534 if(
ch_audio
 !ğ
NULL
) {

2535 
tw_audio_driv”_t
 *
audio_chª_driv”
;

2536 
ed_tcb_t
 *
ed
;

2537 
i
;

2539 
i
=0; i<
TW_AUDIO_IN_CHAN_NUMBER
; i++){

2540 
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio, 
i
, &
audio_chª_driv”
);

2541 if(
audio_chª_driv”
 =ğ
NULL
){

2544 if(
	`©omic_»ad
(&
audio_chª_driv”
->
İ’ed_æag
) == 0){

2547 
ed
 = &
audio_chª_driv”
->
audio_ed
;

2548 if(
ed
->
ed_fsm
.
İ
->
	`g‘_cu¼_¡©e
(&ed->ed_fsmè=ğ
TW_ED_IDLE
){

2549 
	`driv”_g’_d–iv”_ev’t
(
ed
, 1);

2553 
	}
}

2555 
	$ch_audio_´oûss_audio_decode
(
ch_audio_t
 *
ch_audio
)

2557 if(
ch_audio
 !ğ
NULL
){

2558 
tw_audio_driv”_t
 *
audio_chª_driv”
;

2559 
ed_tcb_t
 *
ed
;

2560 
i
;

2562 
i
=
TW_AUDIO_OUT_SPEAKER_ID
; i<=
TW_AUDIO_OUT_PLAYBACK_ID
; i++){

2563 
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio, 
i
, &
audio_chª_driv”
);

2564 if(
audio_chª_driv”
 =ğ
NULL
){

2567 if(
	`©omic_»ad
(&
audio_chª_driv”
->
İ’ed_æag
) == 0){

2570 
ed
 = &
audio_chª_driv”
->
audio_ed
;

2571 if(
ed
->
ed_fsm
.
İ
->
	`g‘_cu¼_¡©e
(&ed->ed_fsmè=ğ
TW_ED_IDLE
){

2572 
	`driv”_g’_d–iv”_ev’t
(
ed
, 1);

2576 
	}
}

2578 
	$ch_audio_g‘_audio_chª_driv”
(
ch_audio_t
 *
ch_audio
, 
chª_id
, 
tw_audio_driv”_t
 **
±r_audio_driv”
)

2580 if((
ch_audio
!=
NULL
è&& (
±r_audio_driv”
!=NULL)){

2581 *
±r_audio_driv”
 = 
NULL
;

2582 if((
chª_id
>=
TW_AUDIO_IN_CHAN0_ID
è&& (chª_id<=
TW_AUDIO_OUT_PLAYBACK_ID
)){

2583 *
±r_audio_driv”
 = &
ch_audio
->
ch
->
audio_chª_driv”
[
chª_id
];

2586 
	}
}

2588 
ch_audio_İ”©iÚ
 
	gch_audio_İ
 = {

2589 .
š™
 = 
ch_audio_š™
,

2591 .
	g£t_’code_audio_chª_ty³
 = 
ch_audio_£t_’code_audio_chª_ty³
,

2592 .
	gupd©e_’code_audio_chª_ty³
 = 
ch_audio_upd©e_’code_audio_chª_ty³
,

2593 .
	gg‘_’code_audio_chª_ty³
 = 
ch_audio_g‘_’code_audio_chª_ty³
,

2595 .
	g£t_decode_audio_chª_ty³
 = 
ch_audio_£t_decode_audio_chª_ty³
,

2596 .
	gupd©e_decode_audio_chª_ty³
 = 
ch_audio_upd©e_decode_audio_chª_ty³
,

2597 .
	gg‘_decode_audio_chª_ty³
 = 
ch_audio_g‘_decode_audio_chª_ty³
,

2599 .
	g£t_’abË_audio_chª
 = 
ch_audio_£t_’abË_audio_chª
,

2600 .
	gupd©e_’abË_audio_chª
 = 
ch_audio_upd©e_’abË_audio_chª
,

2601 .
	gg‘_audio_chª_’abË_¡©e
 = 
ch_audio_g‘_audio_chª_’abË_¡©e
,

2603 .
	g£t_mu‹_audio_chª
 = 
ch_audio_£t_mu‹_audio_chª
,

2604 .
	gupd©e_mu‹_audio_chª
 = 
ch_audio_upd©e_mu‹_audio_chª
,

2605 .
	gg‘_audio_chª_mu‹_¡©e
 = 
ch_audio_g‘_audio_chª_mu‹_¡©e
,

2607 .
	gg‘_ch_audio_·¿m
 = 
ch_audio_g‘_ch_audio_·¿m
,

2608 .
	g£t_ch_audio_·¿m
 = 
ch_audio_£t_ch_audio_·¿m
,

2610 .
	g´oûss_audio_’code
 = 
ch_audio_´oûss_audio_’code
,

2611 .
	g´oûss_audio_decode
 = 
ch_audio_´oûss_audio_decode
,

2612 .
	gg‘_audio_chª_driv”
 = 
ch_audio_g‘_audio_chª_driv”
,

2615 
	$audio_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

2616 
couÁ
, *
eof
, *
d©a
)

2618 
Ën
 = 0, 
i
 = 0;

2619 
ch_audio_t
 *
ch_audio
 = (ch_audio_ˆ*)
d©a
;

2620 
tw_audio_driv”_t
 *
audio_chª_driv”
;

2622 
tw_audio_·¿m_t
 *
audio_’code_·¿m
;

2625 
audio_’code_·¿m
 = &
ch_audio
->
audio_’code
.
cÚfig_·¿m
;

2626 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s\n", "BIT", "RATE", "TYPE");

2627 
audio_’code_·¿m
->
İ
->
	`g‘_b™_wide
(audio_encode_param)) {

2628 
TW_AUDIO_8BIT
:

2629 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "8bit");

2631 
TW_AUDIO_16BIT
:

2632 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "16bit");

2635 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "N/A");

2637 
audio_’code_·¿m
->
İ
->
	`g‘_§m¶e_¿‹
(audio_encode_param)) {

2638 
TW_AUDIO_8000
:

2639 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "8K");

2641 
TW_AUDIO_16000
:

2642 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "16K");

2644 
TW_AUDIO_32000
:

2645 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "32K");

2647 
TW_AUDIO_44100
:

2648 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "44.1K");

2650 
TW_AUDIO_48000
:

2651 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "48K");

2654 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "N/A");

2656 
audio_’code_·¿m
->
İ
->
	`g‘_ty³
(audio_encode_param)) {

2657 
TW_AUDIO_PCM
:

2658 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "PCM");

2660 
TW_AUDIO_ALAW
:

2661 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "ALAW");

2663 
TW_AUDIO_ULAW
:

2664 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "ULAW");

2666 
TW_AUDIO_ADPCM_32K
:

2667 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "ADPCM_32K");

2669 
TW_AUDIO_ADPCM_16K
:

2670 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "ADPCM_16K");

2672 
TW_AUDIO_ADPCM_48K
:

2673 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "ADPCM_48K");

2676 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s ", "N/A");

2678 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "\nchannel state:\n");

2679 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s\n", "logic_id", "type", "encode", "discard", "state", "queue", "pool");

2680 
i
 = 0; i <ğ
TW_AUDIO_OUT_PLAYBACK_ID
; i++) {

2681 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
;

2682 
tw_audio_chª_buf_poŞ_t
 *
audio_buf_poŞ
;

2683 
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio, 
i
, &
audio_chª_driv”
);

2685 if(!
audio_chª_driv”
 || !
	`©omic_»ad
(&audio_chª_driv”->
İ’ed_æag
)) {

2688 
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

2689 
audio_buf_poŞ
 = &
audio_chª_driv”
->audio_buf_pool;

2690 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %8d %8d %8d %8d %8d %8d\n", 
audio_chª_driv”
->
audio_logic_chª_id
,

2691 
audio_chª_driv”
->
ty³
,‡udio_chª_driv”->
i_äame_£rŸl
,

2692 
audio_chª_driv”
->
disÿrd_numb”
,

2693 
audio_chª_driv”
->
audio_ed
.
ed_fsm
.
İ
->
	`g‘_cu¼_¡©e
(&audio_chª_driv”->audio_ed.ed_fsm), 
audio_·ck‘_queue
->İ->
	`g‘_cu¼_queue_’Œy_numb”
(audio_packet_queue),

2694 
audio_buf_poŞ
->
İ
->
	`g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
(audio_buf_pool));

2697  
Ën
;

2698 
	}
}

2700 
	$audio_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

2701 
couÁ
, *
d©a
)

2703 
ch_audio_t
 *
ch_audio
 = (ch_audio_ˆ*)
d©a
;

2704 
tw_audio_driv”_t
 *
audio_chª_driv”
;

2705 
tw_audio_driv”_t
 *
audio_decod”_driv”
;

2706 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
;

2707 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_’code_£ùiÚ
;

2708 
tw_audio_·ck‘_queue_t
 *
audio_decod”_·ck‘_queue
;

2709 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_decod”_£ùiÚ
;

2710 
tw_audio_desütÜ_t
 *
audio_’code_desütÜ
;

2711 
tw_audio_desütÜ_t
 *
audio_decode_desütÜ
;

2712 
dvm_ch_t
 *
ch
;

2713 
u32
 
desc
 = 0;

2714 
u32
 
audio_sm®Ër
 = 0;

2715 
fe
 *
audio_fe
;

2716 
Çme
[128];

2717 
mm_£gm’t_t
 
fs
;

2718 
cmdbuf
[1024];

2719 **
¬gv
;

2720 
¬gc
, 
i
;

2721 
u32
 
loİ
 = 0;

2723 if(
couÁ
 > 1024){

2724 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 1024);

2727 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 
couÁ
);

2729 
¬gv
 = 
	`¬gv_¥l™
(
GFP_KERNEL
, 
cmdbuf
, &
¬gc
);

2730 
i
 = 0; i < (
¬gc
 - 1); i++){

2731 
	`TW_DBG
(
TW_DBG_INFO
, "cmd %d: %s\n", 
i
, 
¬gv
[i]);

2733 if(!
ch_audio
){

2734 
wr™e_»Ëa£
;

2736 if((
¬gc
 > 3è&& (
	`¡rcmp
(
¬gv
[2], "loop") == 0)) {

2737 
loİ
 = 1;

2740 
ch
 = 
ch_audio
->chip;

2742 if(
¬gv
[0] !ğ
NULL
) {

2743 
ed_tcb_t
 *
’cod”_ed
 = 
NULL
;

2744 
ed_tcb_t
 *
decod”_ed
 = 
NULL
;

2745 
	`mem£t
(
Çme
, 0, 128);

2746 
	`¥rštf
(
Çme
, "%s/audio_chn%d.pcm", 
¬gv
[1], 
	`©oi
(argv[0]));

2747 
audio_fe
 = 
	`tw_k”Ãl_fe_İ’
(
Çme
);

2748 
fs
=
	`g‘_fs
();

2749 
	`£t_fs
(
KERNEL_DS
);

2750 
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio, 
	`©oi
(
¬gv
[0]), &
audio_chª_driv”
);

2751 
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio, 
TW_AUDIO_OUT_SPEAKER_ID
, &
audio_decod”_driv”
);

2752 if(!
audio_chª_driv”
 || !
audio_decod”_driv”
) {

2753 
	`TW_DBG
(
TW_DBG_ERR
, "no such driver\n");

2754 
audio_’d
;

2756 
’cod”_ed
 = &
audio_chª_driv”
->
audio_ed
;

2757 
decod”_ed
 = &
audio_decod”_driv”
->
audio_ed
;

2758 if(!
’cod”_ed
->
İ
) {

2759 
	`š™_tw5864_audio_’code_chª
(
audio_chª_driv”
, 
ch_audio
, 1, 0, 0);

2761 if(!
decod”_ed
->
İ
) {

2762 
	`š™_tw5864_audio_decode_chª
(
audio_decod”_driv”
, 
ch_audio
, 1, 0, 
TW_AUDIO_OUT_SPEAKER_ID
);

2764 
’cod”_ed
->
İ
->
	`İ’
(encoder_ed);

2765 
	`driv”_g’_»sume_ev’t
(
’cod”_ed
, 1);

2766 
decod”_ed
->
İ
->
	`İ’
(decoder_ed);

2767 
	`driv”_g’_»sume_ev’t
(
decod”_ed
, 1);

2768 
audio_·ck‘_queue
 = &
audio_chª_driv”
->audio_packet_queue;

2769 
audio_decod”_·ck‘_queue
 = &
audio_decod”_driv”
->
audio_·ck‘_queue
;

2771 
	`scheduË
();

2772 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

2773 
audio_’d
;

2775 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

2776 
audio_’code_£ùiÚ
 = 
audio_·ck‘_queue
->
cu¼_cÚsum”
;

2778 if(
audio_’code_£ùiÚ
){

2779 
audio_fe
->
f_İ
->
	`wr™e
×udio_fe, 
audio_’code_£ùiÚ
->
d©a
 + (
ext_h264_Çl_b™¡»am_t
),‡udio_’code_£ùiÚ->
·ylßd_Ën
 - Óxt_h264_Çl_b™¡»am_t), &×udio_fe->
f_pos
));

2781 if(
loİ
) {

2782 
»Œy
:

2783 
audio_decod”_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
×udio_decod”_·ck‘_queue, &
audio_decod”_driv”
->
audio_buf_poŞ
);

2784 
audio_decod”_£ùiÚ
 = 
audio_decod”_·ck‘_queue
->
cu¼_´oduûr
;

2785 if(
audio_decod”_£ùiÚ
) {

2786 
audio_decod”_£ùiÚ
->
·ylßd_Ën
 = 384;

2787 
audio_’code_desütÜ
 = &
audio_’code_£ùiÚ
->
desütÜ
;

2789 if(
audio_decod”_£ùiÚ
->
cÚsum”_off£t
 == 0) {

2790 
audio_decod”_£ùiÚ
->
§m¶e_¿‹
 = 
audio_’code_desütÜ
->
İ
->
	`g‘_audio_desütÜ_§m¶e_¿‹
(audio_encode_descriptor);

2791 
audio_decod”_£ùiÚ
->
ty³
 = 
audio_’code_desütÜ
->
İ
->
	`g‘_audio_desütÜ_ty³
(audio_encode_descriptor);

2792 
audio_decod”_£ùiÚ
->
b™_wide
 = 
audio_’code_desütÜ
->
İ
->
	`g‘_audio_desütÜ_b™_wide
(audio_encode_descriptor);

2793 
audio_decod”_£ùiÚ
->
time¡amp
 = 
audio_’code_desütÜ
->
İ
->
	`g‘_audio_desütÜ_time¡amp
(audio_encode_descriptor);

2794 
audio_decode_desütÜ
 = &
audio_decod”_£ùiÚ
->
desütÜ
;

2796 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_v®id_Ën
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
·ylßd_Ën
);

2797 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_§m¶e_¿‹
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
§m¶e_¿‹
);

2798 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_ty³
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
ty³
);

2799 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_b™_wide
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
b™_wide
);

2800 if(
audio_’code_£ùiÚ
->
cÚsum”_off£t
) {

2801 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_time¡amp
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
time¡amp
);

2803 
audio_decode_desütÜ
->
İ
->
	`£t_audio_desütÜ_time¡amp
×udio_decode_desütÜ, 
audio_decod”_£ùiÚ
->
time¡amp
 + 0x10);

2805 #ifdeà
ARM_PLATFORM


2806 
desc
 = *(
u32
 *)
audio_decode_desütÜ
->
desütÜ
;

2808 
desc
 = 
	`š_Ë32
((*)
audio_decode_desütÜ
->
desütÜ
);

2810 *((
u32
 *)
audio_decode_desütÜ
->
desütÜ
èğ
desc
;

2813 if(
audio_’code_£ùiÚ
->
cÚsum”_off£t
 == 0) {

2814 
audio_’code_£ùiÚ
->
cÚsum”_off£t
 +ğ(
ext_h264_Çl_b™¡»am_t
);

2816 
audio_sm®Ër
 = 
	`H264_MIN
(
audio_decod”_£ùiÚ
->
·ylßd_Ën
 -‡udio_decod”_£ùiÚ->
cÚsum”_off£t
, 
audio_’code_£ùiÚ
->payload_len -‡udio_encode_section->consumer_offset);

2818 
	`´štk
("(%3d, %3d), (%3d, %3d), sm®Ë¸%3d, %8p\n",
audio_decod”_£ùiÚ
->
·ylßd_Ën
,

2819 
audio_decod”_£ùiÚ
->
cÚsum”_off£t
,

2820 
audio_’code_£ùiÚ
->
·ylßd_Ën
,

2821 
audio_’code_£ùiÚ
->
cÚsum”_off£t
, 
audio_sm®Ër
, 
audio_decod”_£ùiÚ
);

2823 
	`memıy
(
audio_decod”_£ùiÚ
->
d©a
 +‡udio_decod”_£ùiÚ->
cÚsum”_off£t
,

2824 
audio_’code_£ùiÚ
->
d©a
 +‡udio_’code_£ùiÚ->
cÚsum”_off£t
,

2825 
audio_sm®Ër
);

2826 
audio_decod”_£ùiÚ
->
cÚsum”_off£t
 +ğ
audio_sm®Ër
;

2827 
audio_’code_£ùiÚ
->
cÚsum”_off£t
 +ğ
audio_sm®Ër
;

2828 if(
audio_decod”_£ùiÚ
->
cÚsum”_off£t
 =ğaudio_decod”_£ùiÚ->
·ylßd_Ën
) {

2829 
audio_decod”_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(audio_decoder_packet_queue);

2832 if((
audio_’code_£ùiÚ
->
cÚsum”_off£t
 !ğaudio_’code_£ùiÚ->
·ylßd_Ën
)) {

2833 
»Œy
;

2836 
	`memıy
(
audio_decod”_£ùiÚ
->
d©a
, 
audio_£ùiÚ
->d©a,‡udio_decod”_£ùiÚ->
£ùiÚ_size
);

2837 
audio_decod”_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(audio_decoder_packet_queue);

2840 
	`´štk
("%d:audiØdecod” disÿrd\n", 
__LINE__
);

2844 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_chª_driv”
->
audio_buf_poŞ
);

2848 
audio_’d
:

2849 if(
’cod”_ed
) {

2850 
’cod”_ed
->
İ
->
	`şo£
(encoder_ed);

2852 if(
decod”_ed
) {

2853 
decod”_ed
->
İ
->
	`şo£
(decoder_ed);

2855 
	`£t_fs
(
fs
);

2856 
	`tw_k”Ãl_fe_şo£
(
audio_fe
);

2859 
wr™e_»Ëa£
:

2860 
	`¬gv_ä“
(
¬gv
);

2862  
couÁ
;

2863 
	}
}

2865 
	$š™_ch_audio
(
ch_audio_t
 *
ch_audio
, 
dvm_ch_t
 *
ch
, 
bus_id
)

2867 
»t
 = 
TW_ERR
;

2868 if((
ch_audio
!=
NULL
è&& (
ch
!=NULL)){

2869 
tw_´oc_»gi¡”_s
 *
audio_´oc
;

2870 
ch_audio
->
ch
 = chip;

2871 
ch_audio
->
İ
 = &
ch_audio_İ
;

2872 
ch_audio
->
İ
->
	`š™
(chip_audio);

2873 
ch_audio
->
İ
->
	`£t_ch_audio_·¿m
(chip_audio);

2875 
audio_´oc
 = &
ch
->audio_proc;

2876 if(!
audio_´oc
->
’Œy
) {

2877 
	`¡rıy
(
audio_´oc
->
Çme
, "audio");

2878 
audio_´oc
->
»ad
 = 
audio_´oc_»ad
;

2879 
audio_´oc
->
wr™e
 = 
audio_´oc_wr™e
;

2880 
audio_´oc
->
´iv©e
 = 
ch_audio
;

2881 
	`tw_moduË_»gi¡”
(
ch
, 
audio_´oc
);

2883 
»t
 = 
TW_OK
;

2885  
»t
;

2886 
	}
}

2888 
	$»move_ch_audio
(
ch_audio_t
 *
ch_audio
)

2890 if(
ch_audio
 !ğ
NULL
){

2891 
	`tw_moduË_uÄegi¡”
(
ch_audio
->
ch
, &ch_audio->ch->
audio_´oc
);

2892 
ch_audio
->
audio_’abË
.
İ
->
	`upd©e_’abË_pcm_’code
(&ch_audio->audio_’abË, 
AUDIO_DISABLE
);

2893 
ch_audio
->
audio_’abË
.
İ
->
	`upd©e_’abË_adpcm_’code
(&ch_audio->audio_’abË, 
AUDIO_DISABLE
);

2894 
ch_audio
->
audio_’abË
.
İ
->
	`upd©e_’abË_adpcm_decode
(&ch_audio->audio_’abË, 
AUDIO_DISABLE
);

2895 
ch_audio
->
İ
->
	`£t_ch_audio_·¿m
(chip_audio);

2897 
	}
}

	@../../tw5864/tw5864/tw_avSync_device.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
ssize_t
 
	$avSync_deviû_»ad
(
fe
 *fe, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
)

5 
tw5864_avSync_dev_t
 *
dev
;

6 
avSync_äame_queue_t
 *
avSync_äame_queue
;

7 
ssize_t
 
»t
 = 0;

8 
’d_æags
=0;

10 
dev
 = (
tw5864_avSync_dev_t
*)
fe
->
´iv©e_d©a
;

11 ià(
dev
 =ğ
NULL
) {

12 
	`´štk
("[%s]:video_dev i nuÎ\n", 
__FUNCTION__
);

13  -
ENODEV
;

16 
	`down
(&
dev
->
£m
);

17 if(
	`©omic_»ad
(&
dev
->
İ’ed_æags
)) {

18 
avSync_äame_queue
 = &
dev
->avSync_frame_queue;

19 if(
avSync_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

20 
»t
 = 
avSync_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`subm™
×vSync_äame_queue->cu¼_cÚsum”, 
d©a
, 
couÁ
, 
µos
, &
’d_æags
, 
dev
);

22 if(
avSync_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(avSync_frame_queue)){

23 
avSync_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(avSync_frame_queue);

25 if(
avSync_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

26 
»t
 = 
avSync_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`subm™
×vSync_äame_queue->cu¼_cÚsum”, 
d©a
, 
couÁ
, 
µos
, &
’d_æags
, 
dev
);

30 if(
’d_æags
){

31 
avSync_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×vSync_äame_queue, &
dev
->
deviû_buf_poŞ
);

34 
	`´štk
("%s:% havnÙ b“Àİ’ed\n", 
__FUNCTION__
, 
dev
->
Çme
);

36 
	`up
(&
dev
->
£m
);

37  
»t
;

38 
	}
}

40 
	$avSync_deviû_pŞl
(
fe
 *fe, 
pŞl_bË_¡ruù
 *
wa™
)

42 
tw5864_avSync_dev_t
 *
dev
;

43 
mask
 = 0;

45 
dev
 = (
tw5864_avSync_dev_t
*)
fe
->
´iv©e_d©a
;

46 ià(
dev
 =ğ
NULL
) {

47 
	`´štk
("[%s]:video_dev i nuÎ\n", 
__FUNCTION__
);

48  -
ENODEV
;

50 
	`down
(&
dev
->
£m
);

51 if(
	`©omic_»ad
(&
dev
->
İ’ed_æags
)) {

52 
	`pŞl_wa™
(
fe
, &
dev
->
wa™_pŞl
, 
wa™
);

53 if(
dev
->
avSync_äame_queue
.
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(&dev->avSync_frame_queue)){

54 
mask
 = 
POLLIN
 | 
POLLRDNORM
;

57 
	`´štk
("%s:% havnÙ b“Àİ’ed\n", 
__FUNCTION__
, 
dev
->
Çme
);

58 
mask
 = 
POLLOUT
 | 
POLLWRNORM
 | 
POLLIN
 | 
POLLRDNORM
;

60 
	`up
(&
dev
->
£m
);

61  
mask
;

62 
	}
}

64 
	$avSync_deviû_ioùl
(
šode
 *šode, 
fe
 *fe, 
cmd
, 
¬g
)

66 
tw5864_avSync_dev_t
 *
dev
;

67 
»t
 = 0;

69 
dev
 = (
tw5864_avSync_dev_t
*)
fe
->
´iv©e_d©a
;

70 ià(
dev
 =ğ
NULL
) {

71 
	`´štk
("[%s]:video_dev i nuÎ\n", 
__FUNCTION__
);

72  -
ENODEV
;

74 
	`TW_DBG
(
TW_DBG_DEBUG
, "IO_TYPE '%c': NR %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

76 
	`down
(&
dev
->
£m
);

77 if(
	`©omic_»ad
(&
dev
->
İ’ed_æags
)) {

78 
ed_tcb_t
 *
ed
;

79 
cmd
) {

80 
DVM_CODEC_GET_VIDEO_ENCODER_PARAM
:

81 
DVM_CODEC_SET_VIDEO_ENCODER_PARAM
:

82 if(
dev
->
h264_sub_’code_driv”
) {

83 
ed
 = &
dev
->
h264_sub_’code_driv”
->
İ’ed_logic_chª_ed
;

84 
»t
 = 
ed
->
İ
->
	`ioùl
Ód, 
cmd
, 
¬g
);

86 
»t
 = -
ENODEV
;

89 
TW_CHIP_AUDIO_ENCODE_PARAM_SET
:

90 
TW_CHIP_AUDIO_ENCODE_PARAM_GET
:

91 if(
dev
->
audio_’code_driv”
) {

92 
ed
 = &
dev
->
audio_’code_driv”
->
audio_ed
;

93 
»t
 = 
ed
->
İ
->
	`ioùl
Ód, 
cmd
, 
¬g
);

95 
»t
 = -
ENODEV
;

98 
TW_CHIP_AUDIO_DECODE_PARAM_SET
:

99 
TW_CHIP_AUDIO_DECODE_PARAM_GET
:

100 if(
dev
->
audio_decode_driv”
) {

101 
ed
 = &
dev
->
audio_decode_driv”
->
audio_ed
;

102 
»t
 = 
ed
->
İ
->
	`ioùl
Ód, 
cmd
, 
¬g
);

104 
»t
 = -
ENODEV
;

107 
TW_MJPEG_ENCODE_PARAM_SET
:

108 
TW_MJPEG_ENCODE_PARAM_GET
:

109 if(
dev
->
j³g_’code_driv”
) {

110 
ed
 = &
dev
->
j³g_’code_driv”
->
İ’ed_logic_chª_ed
;

111 
»t
 = 
ed
->
İ
->
	`ioùl
Ód, 
cmd
, 
¬g
);

113 
»t
 = -
ENODEV
;

118 
»t
 = 0;

121 
	`´štk
("%s:% havnÙ b“Àİ’ed\n", 
__FUNCTION__
, 
dev
->
Çme
);

123 
	`up
(&
dev
->
£m
);

124  
»t
;

125 
	}
}

127 
	$avSync_deviû_»Ëa£
(
šode
 *šode, 
fe
 *file)

129 
tw5864_avSync_dev_t
 *
dev
;

131 
dev
 = (
tw5864_avSync_dev_t
*)
fe
->
´iv©e_d©a
;

132 ià(
dev
 =ğ
NULL
) {

133 
	`´štk
("[%s]:video_dev i nuÎ\n", 
__FUNCTION__
);

134  -
ENODEV
;

136 
	`down
(&
dev
->
£m
);

137 if(
	`©omic_»ad
(&
dev
->
İ’ed_æags
)){

138 
ed_tcb_t
 *
ed
;

139 if(
dev
->
h264_ma¡”_’code_driv”
 !ğ
NULL
){

140 
ed
 = &
dev
->
h264_ma¡”_’code_driv”
->
İ’ed_logic_chª_ed
;

141 
	`´štk
("\n\n%s.%d: s¹ clo£ ma¡” videØchª_%d\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

142 
ed
->
İ
->
	`şo£
(ed);

143 
	`´štk
("%s.%d: clo£ ma¡” videØchª_%d ov”\n\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

146 if(
dev
->
h264_sub_’code_driv”
 !ğ
NULL
){

147 
ed
 = &
dev
->
h264_sub_’code_driv”
->
İ’ed_logic_chª_ed
;

148 
	`´štk
("\n\n%s.%d: s¹ clo£ sub videØchª_%d\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

149 
ed
->
İ
->
	`şo£
(ed);

150 
	`´štk
("%s.%d: clo£ sub videØchª_%d ov”\n\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

153 if(
dev
->
j³g_’code_driv”
 !ğ
NULL
){

154 
ed
 = &
dev
->
j³g_’code_driv”
->
İ’ed_logic_chª_ed
;

155 
	`´štk
("%s.%d: s¹ clo£ j³g!\n", 
__FUNCTION__
, 
__LINE__
);

156 
ed
->
İ
->
	`şo£
(&
dev
->
j³g_’code_driv”
->
İ’ed_logic_chª_ed
);

157 
	`´štk
("%s,%d:j³g clo£d!\n", 
__FUNCTION__
, 
__LINE__
);

159 if(
dev
->
audio_’code_driv”
 !ğ
NULL
){

160 
ed
 = &
dev
->
audio_’code_driv”
->
audio_ed
;

161 
	`´štk
("\n\n%s.%d: s¹ clo£‡udiØ’codchª_%d\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

162 
ed
->
İ
->
	`şo£
(ed);

163 
	`´štk
("%s.%d: clo£‡udiØ’codchª_%d ov”\n\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

165 if(
dev
->
audio_decode_driv”
 !ğ
NULL
){

166 
ed
 = &
dev
->
audio_decode_driv”
->
audio_ed
;

167 
	`´štk
("\n\n%s.%d: s¹ clo£‡udiØdecodchª_%d\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

168 
ed
->
İ
->
	`şo£
(ed);

169 
	`´štk
("%s.%d: clo£‡udiØdecodchª_%d ov”\n\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

171 
	`´štk
("%s,%d:„–—£‡vSynøäamqueue!\n", 
__FUNCTION__
, 
__LINE__
);

172 
	`»move_avSync_äame_queue
(&
dev
->
avSync_äame_queue
, &dev->
deviû_buf_poŞ
);

173 
fe
->
´iv©e_d©a
 = 
NULL
;

174 
	`©omic_£t
(&
dev
->
İ’ed_æags
, 0);

176 
æags
;

177 
	`loÿl_œq_§ve
(
æags
);

178 
	`´štk
("\n\n<<------%s.%d: clo£ deviû_%d ov”------>>\n", 
__FUNCTION__
, 
__LINE__
, 
dev
->
dev_šode_id
);

179 if(
dev
->
h264_ma¡”_’code_driv”
 !ğ
NULL
){

180 
ed
 = &
dev
->
h264_ma¡”_’code_driv”
->
İ’ed_logic_chª_ed
;

181 
	`´štk
("ma¡” video_·ck‘_poŞ_tcb = %d\n", 
dev
->
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
.
video_·ck‘_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&dev->h264_master_encode_driver->encode_chan_buf_pool.video_packet_pool_tcb));

182 
	`´štk
("ma¡” video_äame_poŞ_tcb = %d\n", 
dev
->
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
.
video_äame_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&dev->h264_master_encode_driver->encode_chan_buf_pool.video_frame_pool_tcb));

183 
	`´štk
("ma¡” s‹ %d\n", 
ed
->
İ
->
	`g‘_¡©e
(ed));

185 if(
dev
->
h264_sub_’code_driv”
 !ğ
NULL
){

186 
ed
 = &
dev
->
h264_sub_’code_driv”
->
İ’ed_logic_chª_ed
;

187 
	`´štk
("sub video_·ck‘_poŞ_tcb = %d\n", 
dev
->
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
.
video_·ck‘_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&dev->h264_sub_encode_driver->encode_chan_buf_pool.video_packet_pool_tcb));

188 
	`´štk
("sub video_äame_poŞ_tcb = %d\n", 
dev
->
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
.
video_äame_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&dev->h264_sub_encode_driver->encode_chan_buf_pool.video_frame_pool_tcb));

189 
	`´štk
("sub s‹ %d\n", 
ed
->
İ
->
	`g‘_¡©e
(ed));

191 if(
dev
->
j³g_’code_driv”
 !ğ
NULL
){

194 if(
dev
->
audio_’code_driv”
 !ğ
NULL
){

195 
	`´štk
("’codaudio_queuğ%d\n", 
dev
->
audio_’code_driv”
->
audio_·ck‘_queue
.
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(&dev->audio_encode_driver->audio_packet_queue));

196 
	`´štk
("’codaudio_·ck‘_poŞ_tcb = %d\n", 
dev
->
audio_’code_driv”
->
audio_buf_poŞ
.
İ
->
	`g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
(&dev->audio_encode_driver->audio_buf_pool));

198 if(
dev
->
audio_decode_driv”
 !ğ
NULL
){

199 
	`´štk
("decodaudio_queuğ%d\n", 
dev
->
audio_decode_driv”
->
audio_·ck‘_queue
.
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(&dev->audio_decode_driver->audio_packet_queue));

200 
	`´štk
("decodaudio_·ck‘_poŞ_tcb = %d\n", 
dev
->
audio_decode_driv”
->
audio_buf_poŞ
.
İ
->
	`g‘_audio_£ùiÚ_tcb_poŞ_’Œy_numb”
(&dev->audio_decode_driver->audio_buf_pool));

202 
	`´štk
("\n");

203 
	`loÿl_œq_»¡Üe
(
æags
);

206 
	`´štk
("%s:% havnÙ b“Àİ’ed\n", 
__FUNCTION__
, 
dev
->
Çme
);

208 
	`up
(&
dev
->
£m
);

210 
	}
}

212 
	$avSync_deviû_İ’
(
šode
 *šode, 
fe
 *file)

214 
tw5864_avSync_dev_t
 *
dev
;

215 
mšÜ
 = 
	`imšÜ
(
šode
);

217 
	`TW_DBG
(
TW_DBG_INFO
, "İ’ mšÜ = %d\n", 
mšÜ
);

218 
	`g‘_tw5864_avSync_deviû
(&
dev
, 
mšÜ
);

219 ià(
dev
 =ğ
NULL
) {

220 
	`TW_DBG
(
TW_DBG_ERR
, "video_dev is‚ull\n");

221  -
ENODEV
;

223 
	`down
(&
dev
->
£m
);

224 if(
	`©omic_»ad
(&
dev
->
İ’ed_æags
)){

225 
	`´štk
("%s:% havb“Àİ’ed\n", 
__FUNCTION__
, 
dev
->
Çme
);

227 
ed_tcb_t
 *
ed
;

228 
	`©omic_£t
(&
dev
->
İ’ed_æags
, 1);

231 if(
dev
->
h264_ma¡”_’code_driv”
 !ğ
NULL
){

232 
ed
 = &
dev
->
h264_ma¡”_’code_driv”
->
İ’ed_logic_chª_ed
;

233 
ed
->
İ
->
	`İ’
(ed);

236 if(
dev
->
h264_sub_’code_driv”
 !ğ
NULL
){

237 
ed
 = &
dev
->
h264_sub_’code_driv”
->
İ’ed_logic_chª_ed
;

238 
ed
->
İ
->
	`İ’
(ed);

241 if(
dev
->
j³g_’code_driv”
 !ğ
NULL
){

242 
ed
 = &
dev
->
j³g_’code_driv”
->
İ’ed_logic_chª_ed
;

243 
ed
->
İ
->
	`İ’
(ed);

245 if(
dev
->
audio_’code_driv”
 !ğ
NULL
){

246 
ed
 = &
dev
->
audio_’code_driv”
->
audio_ed
;

247 
ed
->
İ
->
	`İ’
(ed);

249 if(
dev
->
audio_decode_driv”
 !ğ
NULL
){

250 
ed
 = &
dev
->
audio_decode_driv”
->
audio_ed
;

251 
ed
->
İ
->
	`İ’
(ed);

255 
fe
->
´iv©e_d©a
 = 
dev
;

257 
	`up
(&
dev
->
£m
);

260 
	`TW_DBG
(
TW_DBG_INFO
, "open successful\n");

263 
	}
}

265 
fe_İ”©iÚs
 
	gavSync_deviû_fİs
 =

267 .
owÃr
 = 
THIS_MODULE
,

268 .
	gÎ£ek
 = 
NULL
,

269 .
	g»ad
 = 
avSync_deviû_»ad
,

270 .
	gwr™e
 = 
NULL
,

271 .
	gpŞl
 = 
avSync_deviû_pŞl
,

272 .
	gioùl
 = 
avSync_deviû_ioùl
,

273 .
	gmm­
 = 
NULL
,

274 .
	g»Ëa£
 = 
avSync_deviû_»Ëa£
,

275 .
	gİ’
 = 
avSync_deviû_İ’
,

278 
	$v4l2deviû_»Ëa£
(
video_deviû
 *
vfd
)

280 
	`´štk
("nØsuµÜˆ% İ\n", 
__FUNCTION__
);

281 
	}
}

283 
	$video_deviû_š™
(
tw5864_avSync_dev_t
 *
dev
)

285 
video_deviû
 *
vfd
;

287 
vfd
 = &
dev
->vfd;

288 
	`¡ºıy
(
vfd
->
Çme
, 
dev
->Çme, 
	`¡¾’
(dev->name)+1);

289 
vfd
->
fİs
 = &
avSync_deviû_fİs
;

290 
vfd
->
mšÜ
 = 
dev
->
dev_šode_id
;

291 
vfd
->
»Ëa£
 = 
v4l2deviû_»Ëa£
;

292 #ià
LINUX_VERSION_CODE
 < 
	`KERNEL_VERSION
(2, 6, 28)

293 
vfd
->
ty³
 = 
VID_TYPE_CAPTURE
;

294 
vfd
->
h¬dw¬e
 = 0;

295 
vfd
->
vidioc_qu”yÿp
 = 
NULL
;

296 
vfd
->
vidioc_’um_fmt_ÿp
 = 
NULL
;

297 
vfd
->
vidioc_g_fmt_ÿp
 = 
NULL
;

298 
vfd
->
vidioc_Œy_fmt_ÿp
 = 
NULL
;

299 
vfd
->
vidioc_s_fmt_ÿp
 = 
NULL
;

300 
vfd
->
vidioc_»qbufs
 = 
NULL
;

301 
vfd
->
vidioc_qu”ybuf
 = 
NULL
;

302 
vfd
->
vidioc_qbuf
 = 
NULL
;

303 
vfd
->
vidioc_dqbuf
 = 
NULL
;

304 
vfd
->
vidioc_s_¡d
 = 
NULL
;

305 
vfd
->
vidioc_’um_šput
 = 
NULL
;

306 
vfd
->
vidioc_g_šput
 = 
NULL
;

307 
vfd
->
vidioc_s_šput
 = 
NULL
;

308 
vfd
->
vidioc_qu”yù¾
 = 
NULL
;

309 
vfd
->
vidioc_g_ù¾
 = 
NULL
;

310 
vfd
->
vidioc_s_ù¾
 = 
NULL
;

311 
vfd
->
vidioc_¡»amÚ
 = 
NULL
;

312 
vfd
->
vidioc_¡»amoff
 = 
NULL
;

313 #ifdeà
CONFIG_VIDEO_V4L1_COMPAT


314 
vfd
->
vidiocgmbuf
 = 
NULL
;

317 
vfd
->
væ_ty³
 = 
VFL_TYPE_GRABBER
;

318 
vfd
->
ioùl_İs
 = 
NULL
;

321 
	}
};

323 
	$š™_tw5864_avSync_dev
(
tw5864_avSync_dev_t
 *
dev
, 
bus_id
, 
ch_id
, 
šode_id
, 
id
)

325 
»t
 = 
TW_ERR
;

326 if(
dev
 !ğ
NULL
){

327 
dev
->
bus_id
 = bus_id;

328 
dev
->
ch_id
 = chip_id;

329 
dev
->
dev_šode_id
 = 
šode_id
;

330 
dev
->
id
 = id;

331 
	`¥rštf
(
dev
->
Çme
, "tw5864_avSync_dev_%d", dev->
dev_šode_id
);

332 
	`video_deviû_š™
(
dev
);

333 
	`š™_MUTEX
(&
dev
->
£m
);

334 
	`©omic_£t
(&
dev
->
İ’ed_æags
, 0);

335 
	`š™_wa™queue_h—d
(&
dev
->
wa™_pŞl
);

337 
dev
->
h264_ma¡”_’code_driv”
 = 
NULL
;

338 
dev
->
h264_sub_’code_driv”
 = 
NULL
;

339 
dev
->
j³g_’code_driv”
 = 
NULL
;

340 
dev
->
audio_’code_driv”
 = 
NULL
;

341 
dev
->
audio_decode_driv”
 = 
NULL
;

343 
»t
 = 
	`š™_avSync_äame_buf_poŞ
(&
dev
->
deviû_buf_poŞ
);

344 if(
»t
 =ğ
TW_OK
){

345 
	`š™_avSync_äame_queue
(&
dev
->
avSync_äame_queue
);

346 
	`TW_DBG
(
TW_DBG_DEBUG
, "»gi¡” videØdeviû mšÜ %d\n", 
dev
->
dev_šode_id
);

347 #ifdef 
ARM_PLATFORM


348 
»t
 = 
	`video_»gi¡”_deviû
(&
dev
->
vfd
, 
VFL_TYPE_GRABBER
, dev->
dev_šode_id
);

350 
»t
 = 
	`video_»gi¡”_deviû_šdex
(&
dev
->
vfd
, 
VFL_TYPE_GRABBER
, dev->
dev_šode_id
, dev->dev_inode_id);

352 if(
»t
) {

353 
	`TW_DBG
(
TW_DBG_ERR
, "»gi¡” videØdeviû faed %d\n", 
»t
);

357  
»t
;

358 
	}
}

360 
	$»move_tw5864_avSync_dev
(
tw5864_avSync_dev_t
 *
dev
)

362 if(
dev
 !ğ
NULL
){

363 if(
dev
->
h264_ma¡”_’code_driv”
 !ğ
NULL
){

364 
	`»move_tw5864_h264_’code_chª
(
dev
->
h264_ma¡”_’code_driv”
);

366 if(
dev
->
h264_sub_’code_driv”
 !ğ
NULL
){

367 
	`»move_tw5864_h264_’code_chª
(
dev
->
h264_sub_’code_driv”
);

369 if(
dev
->
j³g_’code_driv”
 !ğ
NULL
){

370 
	`»move_tw5864_j³g_’code_chª
(
dev
->
j³g_’code_driv”
);

372 if(
dev
->
audio_’code_driv”
 !ğ
NULL
){

373 
	`»move_tw5864_audio_’code_chª
(
dev
->
audio_’code_driv”
);

375 
	`»move_avSync_äame_queue
(&
dev
->
avSync_äame_queue
, &dev->
deviû_buf_poŞ
);

376 
	`»move_avSync_äame_buf_poŞ
(&
dev
->
deviû_buf_poŞ
);

377 
	`video_uÄegi¡”_deviû
(&
dev
->
vfd
);

379 
	}
}

381 
	$bšd_av_deviû_ªd_driv”
(
tw5864_avSync_dev_t
 *
tw_deviû_chª
, 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_logic_chª
,w_h264_logic_’code_chª_ˆ*
h264_sub_’code_logic_chª
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
, 
tw_audio_driv”_t
 *
audio_’code_driv”
)

383 if(
tw_deviû_chª
 !ğ
NULL
){

384 
tw_deviû_chª
->
h264_ma¡”_’code_driv”
 = 
h264_ma¡”_’code_logic_chª
;

385 
tw_deviû_chª
->
h264_sub_’code_driv”
 = 
h264_sub_’code_logic_chª
;

386 
tw_deviû_chª
->
j³g_’code_driv”
 = 
j³g_logic_chª
;

387 
tw_deviû_chª
->
audio_’code_driv”
 =‡udio_encode_driver;

389 if(
h264_ma¡”_’code_logic_chª
 !ğ
NULL
){

390 
h264_ma¡”_’code_logic_chª
->
tw_deviû_chª
 =w_device_chan;

392 if(
h264_sub_’code_logic_chª
 !ğ
NULL
){

393 
h264_sub_’code_logic_chª
->
tw_deviû_chª
 =w_device_chan;

395 if(
j³g_logic_chª
){

396 
j³g_logic_chª
->
tw_deviû_chª
 =w_device_chan;

398 if(
audio_’code_driv”
 !ğ
NULL
){

399 
audio_’code_driv”
->
tw_deviû_chª
 =w_device_chan;

401 
	}
}

403 
	$unbšd_av_deviû_ªd_driv”
(
tw5864_avSync_dev_t
 *
tw_deviû_chª
, 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_logic_chª
,w_h264_logic_’code_chª_ˆ*
h264_sub_’code_logic_chª
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
, 
tw_audio_driv”_t
 *
audio_’code_driv”
)

405 if(
tw_deviû_chª
 !ğ
NULL
){

406 
tw_deviû_chª
->
h264_ma¡”_’code_driv”
 = 
NULL
;

407 
tw_deviû_chª
->
h264_sub_’code_driv”
 = 
NULL
;

408 
tw_deviû_chª
->
audio_’code_driv”
 = 
NULL
;

410 if(
h264_ma¡”_’code_logic_chª
 !ğ
NULL
){

411 
h264_ma¡”_’code_logic_chª
->
tw_deviû_chª
 = 
NULL
;

413 if(
h264_sub_’code_logic_chª
 !ğ
NULL
){

414 
h264_sub_’code_logic_chª
->
tw_deviû_chª
 = 
NULL
;

416 if(
j³g_logic_chª
){

417 
j³g_logic_chª
->
tw_deviû_chª
 = 
NULL
;

419 if(
audio_’code_driv”
 !ğ
NULL
){

420 
audio_’code_driv”
->
tw_deviû_chª
 = 
NULL
;

422 
	}
}

	@../../tw5864/tw5864/tw_avSync_device_buf.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$avSync_äame_tcb_š™
(
avSync_äame_tcb_t
 *
äame
)

5 if((
äame
!=
NULL
)){

6 
tcb_node_t
 *
node
 = &
äame
->
äame_node
;

7 
	`¥š_lock_š™
(&
äame
->
lock
);

8 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

9 
node
->
İ
 = &
tcb_node_İ
;

10 
node
->
İ
->
	`š™
(node);

11 
node
->
İ
->
	`£t_´iv
Òode, 
äame
);

12 
äame
->
cu¼_subm™_tcb
 = 
CURR_SUBMIT_IS_264_MASTER_FRAME
;

13 
äame
->
h264_ma¡”_äame
 = 
NULL
;

14 
äame
->
h264_ma¡”_mv_äame
 = 
NULL
;

15 
äame
->
h264_sub_äame
 = 
NULL
;

16 
äame
->
h264_sub_mv_äame
 = 
NULL
;

17 #ifdeà
MJPEG_MODULE


18 
äame
->
j³g_äame
 = 
NULL
;

20 
äame
->
audio_’code_äame
 = 
NULL
;

21 
äame
->
audio_decode_äame
 = 
NULL
;

23 
	}
}

25 
	$avSync_äame_tcb_»£t
(
avSync_äame_tcb_t
 *
äame
)

27 if((
äame
!=
NULL
)){

28 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

29 
äame
->
cu¼_subm™_tcb
 = 
CURR_SUBMIT_IS_264_MASTER_FRAME
;

31 
	}
}

33 
	$avSync_äame_tcb_»Ëa£
(
avSync_äame_tcb_t
 **
±r_äame
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

35 if((*
±r_äame
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

36 
avSync_äame_tcb_t
 *
avSync_äame
 = *
±r_äame
;

37 
æags
;

39 
	`¥š_lock_œq§ve
(&
avSync_äame
->
lock
, 
æags
);

40 if(
	`©omic_»ad
(&
avSync_äame
->
»f_couÁ
) > 1){

41 
	`©omic_dec
(&
avSync_äame
->
»f_couÁ
);

43 
tcb_node_t
 *
node
;

44 if(
avSync_äame
->
İ
 !ğ
NULL
){

45 
avSync_äame
->
İ
->
	`»£t
(avSync_frame);

47 if(
avSync_äame
->
h264_ma¡”_äame
 !ğ
NULL
){

48 
avSync_äame
->
h264_ma¡”_äame
->
İ
->
	`»Ëa£
(&avSync_äame->h264_ma¡”_äame, 
NULL
);

50 if(
avSync_äame
->
h264_ma¡”_mv_äame
 !ğ
NULL
){

51 
avSync_äame
->
h264_ma¡”_mv_äame
->
İ
->
	`»Ëa£
(&avSync_äame->h264_ma¡”_mv_äame, 
NULL
);

53 if(
avSync_äame
->
h264_sub_äame
 !ğ
NULL
){

54 
avSync_äame
->
h264_sub_äame
->
İ
->
	`»Ëa£
(&avSync_äame->h264_sub_äame, 
NULL
);

56 if(
avSync_äame
->
h264_sub_mv_äame
 !ğ
NULL
){

57 
avSync_äame
->
h264_sub_mv_äame
->
İ
->
	`»Ëa£
(&avSync_äame->h264_sub_mv_äame, 
NULL
);

59 #ifdeà
MJPEG_MODULE


60 if(
avSync_äame
->
j³g_äame
 !ğ
NULL
){

61 
avSync_äame
->
j³g_äame
->
İ
->
	`»Ëa£
(&avSync_äame->j³g_äame, 
NULL
);

64 if(
avSync_äame
->
audio_’code_äame
 !ğ
NULL
){

65 
avSync_äame
->
audio_’code_äame
->
İ
->
	`»Ëa£
(&avSync_äame->audio_’code_äame, 
NULL
);

67 if(
avSync_äame
->
audio_decode_äame
 !ğ
NULL
){

68 
avSync_äame
->
audio_decode_äame
->
İ
->
	`»Ëa£
(&avSync_äame->audio_decode_äame, 
NULL
);

70 
node
 = &
avSync_äame
->
äame_node
;

71 if(
node
->
İ
 !ğ
NULL
){

72 
node
->
İ
->
	`»Ëa£
Òode, &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
);

74 *
±r_äame
 = 
NULL
;

76 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame
->
lock
, 
æags
);

78 
	}
}

80 
	$avSync_äame_tcb_»ã»nû
(
avSync_äame_tcb_t
 *
¤c_äame
,‡vSync_äame_tcb_ˆ**
±r_de¡_äame
)

82 if((
¤c_äame
!=
NULL
è&& (
±r_de¡_äame
!=NULL)){

83 
æags
;

85 
	`¥š_lock_œq§ve
(&
¤c_äame
->
lock
, 
æags
);

86 
	`©omic_šc
(&
¤c_äame
->
»f_couÁ
);

87 *
±r_de¡_äame
 = 
¤c_äame
;

88 
	`¥š_uÆock_œq»¡Üe
(&
¤c_äame
->
lock
, 
æags
);

90 
	}
}

92 
size_t
 
	$avSync_äame_tcb_subm™
(
avSync_äame_tcb_t
 *
avSync_äame
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, *
äame_’d
, 
tw5864_avSync_dev_t
 *
dev
)

94 
ssize_t
 
äame_size
 = 0;

95 if((
d©a
!=
NULL
è&& (
couÁ
>0)){

96 
tw_video_äame_tcb_t
 *
h264_ma¡”_äame
 = 
avSync_äame
->h264_master_frame;

97 
tw_video_mv_äame_tcb_t
 *
h264_ma¡”_mv_äame
 = 
avSync_äame
->h264_master_mv_frame;

98 
tw_video_äame_tcb_t
 *
h264_sub_äame
 = 
avSync_äame
->h264_sub_frame;

99 
tw_video_mv_äame_tcb_t
 *
h264_sub_mv_äame
 = 
avSync_äame
->h264_sub_mv_frame;

100 #ifdeà
MJPEG_MODULE


101 
tw_vb_äame_tcb_t
 *
j³g_äame
 = 
avSync_äame
->jpeg_frame;

102 
tw_vb_poŞ_t
 *
j³g_buf_poŞ
;

104 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_’code_äame
 = 
avSync_äame
->audio_encode_frame;

105 
tw_video_chª_buf_poŞ_t
 *
video_’code_chª_buf_poŞ
;

106 
tw_audio_chª_buf_poŞ_t
 *
audio_buf_poŞ
 = &
dev
->
audio_’code_driv”
->audio_buf_pool;

107 
size_t
 
buf_size
;

108 
loff_t
 
buf_off£t
, 
äame_off£t
;

110 *
äame_’d
 = 0;

111 
buf_size
 = 
couÁ
;

112 
buf_off£t
 = 0;

113 if(
h264_ma¡”_äame
 !ğ
NULL
){

114 
video_’code_chª_buf_poŞ
 = &
dev
->
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
;

115 
äame_off£t
 = 0;

116 
h264_ma¡”_äame
->
İ
->
	`subm™
(h264_ma¡”_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_MASTER_BITSTREAM
, 
video_’code_chª_buf_poŞ
);

117 
h264_ma¡”_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->h264_ma¡”_äame, 
video_’code_chª_buf_poŞ
);

118 
buf_size
 -ğ
äame_off£t
;

119 
buf_off£t
 +ğ
äame_off£t
;

121 if(
h264_ma¡”_mv_äame
 !ğ
NULL
){

122 
video_’code_chª_buf_poŞ
 = &
dev
->
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
;

123 
äame_off£t
 = 0;

124 
h264_ma¡”_mv_äame
->
İ
->
	`subm™
(h264_ma¡”_mv_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_MASTER_BITSTREAM
, 
video_’code_chª_buf_poŞ
);

125 
h264_ma¡”_mv_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->h264_ma¡”_mv_äame, 
video_’code_chª_buf_poŞ
);

126 
buf_size
 -ğ
äame_off£t
;

127 
buf_off£t
 +ğ
äame_off£t
;

129 if(
h264_sub_äame
 !ğ
NULL
){

130 
video_’code_chª_buf_poŞ
 = &
dev
->
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
;

131 
äame_off£t
 = 0;

132 
h264_sub_äame
->
İ
->
	`subm™
(h264_sub_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_SUB_BITSTREAM
, 
video_’code_chª_buf_poŞ
);

133 
h264_sub_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->h264_sub_äame, 
video_’code_chª_buf_poŞ
);

134 
buf_size
 -ğ
äame_off£t
;

135 
buf_off£t
 +ğ
äame_off£t
;

137 if(
h264_sub_mv_äame
 !ğ
NULL
){

138 
video_’code_chª_buf_poŞ
 = &
dev
->
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
;

139 
äame_off£t
 = 0;

140 
h264_sub_mv_äame
->
İ
->
	`subm™
(h264_sub_mv_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_SUB_BITSTREAM
, 
video_’code_chª_buf_poŞ
);

141 
h264_sub_mv_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->h264_sub_mv_äame, 
video_’code_chª_buf_poŞ
);

142 
buf_size
 -ğ
äame_off£t
;

143 
buf_off£t
 +ğ
äame_off£t
;

145 #ifdeà
MJPEG_MODULE


146 if(
j³g_äame
 !ğ
NULL
){

147 
j³g_buf_poŞ
 = &
dev
->
j³g_’code_driv”
->
poŞ
;

148 
äame_off£t
 = 0;

149 
j³g_äame
->
İ
->
	`subm™
(j³g_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_MASTER_BITSTREAM
, 
j³g_buf_poŞ
);

150 
j³g_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->j³g_äame, 
j³g_buf_poŞ
);

151 
buf_size
 -ğ
äame_off£t
;

152 
buf_off£t
 +ğ
äame_off£t
;

155 if(
audio_’code_äame
 !ğ
NULL
){

156 
audio_buf_poŞ
 = &
dev
->
audio_’code_driv”
->audio_buf_pool;

157 
äame_off£t
 = 0;

158 
audio_’code_äame
->
İ
->
	`subm™
×udio_’code_äame, &
d©a
[
buf_off£t
], 
buf_size
, &
äame_off£t
, 
TW_MASTER_BITSTREAM
, 
audio_buf_poŞ
);

160 if(
dev
->
audio_’code_driv”
->
audio_logic_chª_id
 =ğ
TW_AUDIO_IN_CHAN0_ID
)

162 
tw_audio_driv”_t
 *
audio_decode_chª_driv”
;

163 
tw_audio_·ck‘_queue_t
 *
audio_decode_·ck‘_queue
;

165 
dev
->
audio_’code_driv”
->
ch_audio
->
İ
->
	`g‘_audio_chª_driv”
(dev->audio_’code_driv”->ch_audio, 
TW_AUDIO_OUT_SPEAKER_ID
, &
audio_decode_chª_driv”
);

166 
audio_decode_·ck‘_queue
 = &
audio_decode_chª_driv”
->
audio_·ck‘_queue
;

167 
audio_decode_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
×udio_decode_·ck‘_queue, &
audio_decode_chª_driv”
->
audio_buf_poŞ
);

168 if(
audio_decode_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

169 
tw_audio_·ck‘_£ùiÚ_t
 *
audio_decode_£ùiÚ
 = 
audio_decode_·ck‘_queue
->
cu¼_´oduûr
;

170 
audio_decode_£ùiÚ
->
·ylßd_Ën
 = 
audio_’code_äame
->payload_len;

171 
audio_decode_£ùiÚ
->
§m¶e_¿‹
 = 
audio_’code_äame
->sample_rate;

172 
audio_decode_£ùiÚ
->
ty³
 = 
audio_’code_äame
->type;

173 
audio_decode_£ùiÚ
->
b™_wide
 = 
audio_’code_äame
->bit_wide;

174 
audio_decode_£ùiÚ
->
time¡amp
 = 
audio_’code_äame
->timestamp;

175 
	`memıy
(
audio_decode_£ùiÚ
->
d©a
, 
audio_’code_äame
->d©a,‡udio_decode_£ùiÚ->
·ylßd_Ën
);

176 
audio_decode_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(audio_decode_packet_queue);

180 
audio_’code_äame
->
İ
->
	`»Ëa£
(&
avSync_äame
->audio_’code_äame, 
audio_buf_poŞ
);

181 
buf_size
 -ğ
äame_off£t
;

182 
buf_off£t
 +ğ
äame_off£t
;

184 *
äame_’d
 = 1;

185 *
µos
 = 
buf_off£t
;

186 
äame_size
 = 
buf_off£t
;

188  
äame_size
;

189 
	}
}

191 
avSync_äame_tcb_İ”©iÚ
 
	gavSync_äame_tcb_İ
 = {

192 .
š™
 = 
avSync_äame_tcb_š™
,

193 .
	g»£t
 = 
avSync_äame_tcb_»£t
,

194 .
	g»Ëa£
 = 
avSync_äame_tcb_»Ëa£
,

195 .
	g»ã»nû
 = 
avSync_äame_tcb_»ã»nû
,

197 .
	gsubm™
 = 
avSync_äame_tcb_subm™
,

200 
	$avSync_äame_queue_g‘
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 **
±r_avSync_äame
)

202 if((
avSync_äame_queue
!=
NULL
è&& (
±r_avSync_äame
!=NULL)){

203 
tcb_node_queue_t
 *
queue
;

204 *
±r_avSync_äame
 = 
NULL
;

205 
queue
 = &
avSync_äame_queue
->
queue_node
;

206 if(
queue
->
İ
 !ğ
NULL
){

207 
tcb_node_t
 *
‹mp_node
;

208 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

209 if(
‹mp_node
 !ğ
NULL
){

210 *
±r_avSync_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

214 
	}
}

216 
	$avSync_äame_queue_Œy_g‘
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 **
±r_avSync_äame
)

218 if((
avSync_äame_queue
!=
NULL
è&& (
±r_avSync_äame
!=NULL)){

219 
tcb_node_queue_t
 *
queue
;

220 *
±r_avSync_äame
 = 
NULL
;

221 
queue
 = &
avSync_äame_queue
->
queue_node
;

222 if(
queue
->
İ
 !ğ
NULL
){

223 
tcb_node_t
 *
‹mp_node
;

224 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

225 if(
‹mp_node
 !ğ
NULL
){

226 *
±r_avSync_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

230 
	}
}

232 
	$avSync_äame_queue_g‘_”
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 **
±r_avSync_äame
)

234 if((
avSync_äame_queue
!=
NULL
è&& (
±r_avSync_äame
!=NULL)){

235 
tcb_node_queue_t
 *
queue
;

236 *
±r_avSync_äame
 = 
NULL
;

237 
queue
 = &
avSync_äame_queue
->
queue_node
;

238 if(
queue
->
İ
 !ğ
NULL
){

239 
tcb_node_t
 *
‹mp_node
;

240 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

241 if(
‹mp_node
 !ğ
NULL
){

242 *
±r_avSync_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

246 
	}
}

248 
	$avSync_äame_queue_Œy_g‘_”
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 **
±r_avSync_äame
)

250 if((
avSync_äame_queue
!=
NULL
è&& (
±r_avSync_äame
!=NULL)){

251 
tcb_node_queue_t
 *
queue
;

252 *
±r_avSync_äame
 = 
NULL
;

253 
queue
 = &
avSync_äame_queue
->
queue_node
;

254 if(
queue
->
İ
 !ğ
NULL
){

255 
tcb_node_t
 *
‹mp_node
;

256 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

257 if(
‹mp_node
 !ğ
NULL
){

258 *
±r_avSync_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

262 
	}
}

264 
	$avSync_äame_queue_put
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 *
avSync_äame
)

266 if((
avSync_äame_queue
!=
NULL
è&& (
avSync_äame
!=NULL)){

267 
tcb_node_queue_t
 *
queue
;

268 
queue
 = &
avSync_äame_queue
->
queue_node
;

269 if(
queue
->
İ
 !ğ
NULL
){

270 
queue
->
İ
->
	`put
(queue, &
avSync_äame
->
äame_node
);

273 
	}
}

275 
	$avSync_äame_queue_put_h—d”
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_tcb_t
 *
avSync_äame
)

277 if((
avSync_äame_queue
!=
NULL
è&& (
avSync_äame
!=NULL)){

278 
tcb_node_queue_t
 *
queue
;

279 
queue
 = &
avSync_äame_queue
->
queue_node
;

280 if(
queue
->
İ
 !ğ
NULL
){

281 
queue
->
İ
->
	`put_h—d”
(queue, &
avSync_äame
->
äame_node
);

284 
	}
}

286 
	$avSync_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

288 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

289 
æags
;

290 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

291 if(
avSync_äame_queue
->
cu¼_´oduûr
 =ğ
NULL
){

292 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

293 if(
video_deviû_buf_poŞ
->
İ
 !ğ
NULL
){

294 
video_deviû_buf_poŞ
->
İ
->
	`g‘_avSync_äame_tcb
(video_deviû_buf_poŞ, &
avSync_äame_queue
->
cu¼_´oduûr
);

296 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

298 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

300 
	}
}

302 
	$avSync_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

304 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

305 
æags
;

306 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

307 if(
avSync_äame_queue
->
cu¼_´oduûr
 =ğ
NULL
){

308 if(
video_deviû_buf_poŞ
->
İ
 !ğ
NULL
){

309 
video_deviû_buf_poŞ
->
İ
->
	`Œy_g‘_avSync_äame_tcb
(video_deviû_buf_poŞ, &
avSync_äame_queue
->
cu¼_´oduûr
);

312 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

314 
	}
}

316 
	$avSync_äame_queue_put_cu¼_´oduûr_što_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

318 if(
avSync_äame_queue
 !ğ
NULL
){

319 
æags
;

320 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

321 if(
avSync_äame_queue
->
cu¼_´oduûr
 !ğ
NULL
){

322 if(
avSync_äame_queue
->
İ
 !ğ
NULL
){

323 
avSync_äame_queue
->
İ
->
	`put
×vSync_äame_queue,‡vSync_äame_queue->
cu¼_´oduûr
);

325 
	`avSync_äame_queue_put
(
avSync_äame_queue
,‡vSync_äame_queue->
cu¼_´oduûr
);

327 
avSync_äame_queue
->
cu¼_´oduûr
 = 
NULL
;

329 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

331 
	}
}

333 
	$avSync_äame_queue_»Ëa£_cu¼_´oduûr
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

335 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

336 
æags
;

337 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

338 if(
avSync_äame_queue
->
cu¼_´oduûr
 !ğ
NULL
){

339 if(
avSync_äame_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

340 
avSync_äame_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&avSync_äame_queue->cu¼_´oduûr, 
video_deviû_buf_poŞ
);

342 
	`avSync_äame_tcb_»Ëa£
(&
avSync_äame_queue
->
cu¼_´oduûr
, 
video_deviû_buf_poŞ
);

345 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

347 
	}
}

349 
	$avSync_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

351 if(
avSync_äame_queue
 !ğ
NULL
){

352 
æags
;

353 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

354 if(
avSync_äame_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

355 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

356 if(
avSync_äame_queue
->
İ
 !ğ
NULL
){

357 
avSync_äame_queue
->
İ
->
	`g‘
×vSync_äame_queue, &avSync_äame_queue->
cu¼_cÚsum”
);

359 
	`avSync_äame_queue_g‘
(
avSync_äame_queue
, &avSync_äame_queue->
cu¼_cÚsum”
);

361 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

363 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

365 
	}
}

367 
	$avSync_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

369 if(
avSync_äame_queue
 !ğ
NULL
){

370 
æags
;

371 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

372 if(
avSync_äame_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

373 if(
avSync_äame_queue
->
İ
 !ğ
NULL
){

374 
avSync_äame_queue
->
İ
->
	`Œy_g‘
×vSync_äame_queue, &avSync_äame_queue->
cu¼_cÚsum”
);

376 
	`avSync_äame_queue_Œy_g‘
(
avSync_äame_queue
, &avSync_äame_queue->
cu¼_cÚsum”
);

379 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

381 
	}
}

383 
	$avSync_äame_queue_»Ëa£_cu¼_cÚsum”
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

385 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

386 
æags
;

387 
	`¥š_lock_œq§ve
(&
avSync_äame_queue
->
lock
, 
æags
);

388 if(
avSync_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

389 if(
avSync_äame_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

390 
avSync_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&avSync_äame_queue->cu¼_cÚsum”, 
video_deviû_buf_poŞ
);

392 
	`avSync_äame_tcb_»Ëa£
(&
avSync_äame_queue
->
cu¼_cÚsum”
, 
video_deviû_buf_poŞ
);

394 
avSync_äame_queue
->
cu¼_cÚsum”
 = 
NULL
;

396 
	`¥š_uÆock_œq»¡Üe
(&
avSync_äame_queue
->
lock
, 
æags
);

398 
	}
}

400 
	$avSync_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

402 
’Œy_numb”
 = 0;

403 if(
avSync_äame_queue
!=
NULL
){

404 
tcb_node_queue_t
 *
queue
;

405 
queue
 = &
avSync_äame_queue
->
queue_node
;

406 if(
queue
->
İ
 !ğ
NULL
){

407 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

410  
’Œy_numb”
;

411 
	}
}

413 
	$avSync_äame_queue_»Ëa£
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

415 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

416 
	`»move_avSync_äame_queue
(
avSync_äame_queue
, 
video_deviû_buf_poŞ
);

418 
	}
}

420 
	$avSync_äame_queue_š™
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

422 if(
avSync_äame_queue
 !ğ
NULL
){

423 
tcb_node_queue_t
 *
queue
;

424 
queue
 = &
avSync_äame_queue
->
queue_node
;

425 
queue
->
İ
 = &
tcb_node_queue_İ
;

426 
queue
->
İ
->
	`š™
(queue);

427 
avSync_äame_queue
->
cu¼_cÚsum”
 = 
NULL
;

428 
avSync_äame_queue
->
cu¼_´oduûr
 = 
NULL
;

429 
avSync_äame_queue
->
¡¬t_time¡amp
 = 0;

430 
avSync_äame_queue
->
tÙ®_du¿tiÚ
 = 0;

431 
	`¥š_lock_š™
(&
avSync_äame_queue
->
lock
);

433 
	}
}

435 
avSync_äame_queue_İ”©iÚ
 
	gavSync_äame_queue_İ
 = {

436 .
g‘
 = 
avSync_äame_queue_g‘
,

437 .
	gŒy_g‘
 = 
avSync_äame_queue_Œy_g‘
,

438 .
	gg‘_”
 = 
avSync_äame_queue_g‘_”
,

439 .
	gŒy_g‘_”
 = 
avSync_äame_queue_Œy_g‘_”
,

440 .
	gput
 = 
avSync_äame_queue_put
,

441 .
	gput_h—d”
 = 
avSync_äame_queue_put_h—d”
,

443 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
avSync_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
,

444 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
avSync_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

445 .
	gput_cu¼_´oduûr_što_queue
 = 
avSync_äame_queue_put_cu¼_´oduûr_što_queue
,

446 .
	g»Ëa£_cu¼_´oduûr
 = 
avSync_äame_queue_»Ëa£_cu¼_´oduûr
,

447 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
avSync_äame_queue_g‘_cu¼_cÚsum”_äom_queue
,

448 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
avSync_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

449 .
	g»Ëa£_cu¼_cÚsum”
 = 
avSync_äame_queue_»Ëa£_cu¼_cÚsum”
,

451 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
avSync_äame_queue_g‘_cu¼_queue_’Œy_numb”
,

452 .
	g»Ëa£
 = 
avSync_äame_queue_»Ëa£
,

453 .
	gš™
 = 
avSync_äame_queue_š™
,

456 
	$š™_avSync_äame_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
)

458 if(
avSync_äame_queue
 !ğ
NULL
){

459 
avSync_äame_queue
->
İ
 = &
avSync_äame_queue_İ
;

460 
avSync_äame_queue
->
İ
->
	`š™
(avSync_frame_queue);

462 
	}
}

464 
	$»move_avSync_äame_queue
(
avSync_äame_queue_t
 *
avSync_äame_queue
, 
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

466 if((
avSync_äame_queue
!=
NULL
è&& (
video_deviû_buf_poŞ
!=NULL)){

467 if(
avSync_äame_queue
->
İ
 !ğ
NULL
){

468 
avSync_äame_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(avSync_frame_queue);

469 
avSync_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×vSync_äame_queue, 
video_deviû_buf_poŞ
);

470 
avSync_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(avSync_frame_queue)){

471 
avSync_äame_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(avSync_frame_queue);

472 if(
avSync_äame_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

475 
avSync_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×vSync_äame_queue, 
video_deviû_buf_poŞ
);

478 
	`avSync_äame_queue_put_cu¼_´oduûr_što_queue
(
avSync_äame_queue
);

479 
	`avSync_äame_queue_»Ëa£_cu¼_cÚsum”
(
avSync_äame_queue
, 
video_deviû_buf_poŞ
);

480 
	`avSync_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
avSync_äame_queue
)){

481 
	`avSync_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
avSync_äame_queue
);

482 if(
avSync_äame_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

485 
	`avSync_äame_queue_»Ëa£_cu¼_cÚsum”
(
avSync_äame_queue
, 
video_deviû_buf_poŞ
);

488 
	`´štk
("avSynøpoŞƒÁry‚umb”: %d\n", 
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&video_device_buf_pool->avSync_frame_pool_node));

490 
	}
}

492 
	$avSync_äame_buf_poŞ_ü—‹
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
buf_size
)

494 
»t
 = 
TW_ERR
;

496 if(
video_deviû_buf_poŞ
 !ğ
NULL
){

497 
tcb_node_poŞ_t
 *
node_poŞ
;

498 
avSync_äame_tcb_t
 *
acSync_äame
;

499 
i
;

500 
video_deviû_buf_poŞ
->
avSync_äame_’Œy_numb”
 = 
buf_size
/
PAGE_SIZE
;

501 
node_poŞ
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

502 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

503 
video_deviû_buf_poŞ
->
avSync_äame_poŞ
 = (
avSync_äame_tcb_t
*)
	`km®loc
(×vSync_äame_tcb_t)*video_deviû_buf_poŞ->
avSync_äame_’Œy_numb”
, 
GFP_KERNEL
);

504 if(
video_deviû_buf_poŞ
->
avSync_äame_poŞ
 =ğ
NULL
){

505 
	`´štk
("%s.%d: cª'ˆavSynøtcb…oŞ\n", 
__FUNCTION__
, 
__LINE__
);

506  
»t
;

508 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
video_deviû_buf_poŞ
->
avSync_äame_’Œy_numb”
);

509 
i
=0; i<
video_deviû_buf_poŞ
->
avSync_äame_’Œy_numb”
; i++){

510 
acSync_äame
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ
[
i
];

511 
acSync_äame
->
İ
 = &
avSync_äame_tcb_İ
;

512 
acSync_äame
->
İ
->
	`š™
(acSync_frame);

513 
acSync_äame
->
İ
->
	`»Ëa£
(&acSync_äame, 
video_deviû_buf_poŞ
);

515 
»t
 = 
TW_OK
;

517  
»t
;

518 
	}
}

520 
	$avSync_äame_buf_poŞ_»Ëa£
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

522 if(
video_deviû_buf_poŞ
 !ğ
NULL
){

523 
tcb_node_poŞ_t
 *
node_poŞ
;

524 
node_poŞ
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

525 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

526 if(
video_deviû_buf_poŞ
->
avSync_äame_poŞ
 !ğ
NULL
){

527 
	`kä“
(
video_deviû_buf_poŞ
->
avSync_äame_poŞ
);

528 
video_deviû_buf_poŞ
->
avSync_äame_poŞ
 = 0;

530 
video_deviû_buf_poŞ
->
avSync_äame_’Œy_numb”
 = 0;

532 
	}
}

534 
	$avSync_äame_buf_poŞ_g‘_avSync_äame_tcb
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 **
±r_äame
)

536 if((
video_deviû_buf_poŞ
!=
NULL
è&& (
±r_äame
!=NULL)){

537 
tcb_node_poŞ_t
 *
poŞ_node
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

538 *
±r_äame
 = 
NULL
;

539 if(
poŞ_node
->
İ
 !ğ
NULL
){

540 
tcb_node_t
 *
‹mp_node
;

541 
poŞ_node
->
İ
->
	`g‘
ÕoŞ_node, &
‹mp_node
);

542 if(
‹mp_node
 !ğ
NULL
){

543 *
±r_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

544 
	`©omic_šc
(&((*
±r_äame
)->
»f_couÁ
));

548 
	}
}

550 
	$avSync_äame_buf_poŞ_Œy_g‘_avSync_äame_tcb
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 **
±r_äame
)

552 if((
video_deviû_buf_poŞ
!=
NULL
è&& (
±r_äame
!=NULL)){

553 
tcb_node_poŞ_t
 *
poŞ_node
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

554 *
±r_äame
 = 
NULL
;

555 if(
poŞ_node
->
İ
 !ğ
NULL
){

556 
tcb_node_t
 *
‹mp_node
;

557 
poŞ_node
->
İ
->
	`Œy_g‘
ÕoŞ_node, &
‹mp_node
);

558 if(
‹mp_node
 !ğ
NULL
){

559 *
±r_äame
 = 
	`to_g‘_avSync_äame_tcb
(
‹mp_node
);

560 
	`©omic_šc
(&((*
±r_äame
)->
»f_couÁ
));

564 
	}
}

566 
	$avSync_äame_buf_poŞ_put_avSync_äame_tcb
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
, 
avSync_äame_tcb_t
 *
äame
)

568 if((
video_deviû_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

569 
tcb_node_poŞ_t
 *
poŞ_node
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

570 if(
poŞ_node
->
İ
 !ğ
NULL
){

571 
poŞ_node
->
İ
->
	`put
ÕoŞ_node, &
äame
->
äame_node
);

574 
	}
}

576 
	$avSync_äame_buf_poŞ_g‘_avSync_äame_tcb_poŞ_’Œy_numb”
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

578 
»t
 = 0;

579 if(
video_deviû_buf_poŞ
 !ğ
NULL
){

580 
tcb_node_poŞ_t
 *
poŞ_node
 = &
video_deviû_buf_poŞ
->
avSync_äame_poŞ_node
;

581 
»t
 = 
poŞ_node
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(pool_node);

583  
»t
;

584 
	}
}

586 
avSync_äame_buf_poŞ_İ”©iÚ
 
	gavSync_äame_buf_poŞ_İ
 = {

587 .
ü—‹
 = 
avSync_äame_buf_poŞ_ü—‹
,

588 .
	g»Ëa£
 = 
avSync_äame_buf_poŞ_»Ëa£
,

590 .
	gg‘_avSync_äame_tcb
 = 
avSync_äame_buf_poŞ_g‘_avSync_äame_tcb
,

591 .
	gŒy_g‘_avSync_äame_tcb
 = 
avSync_äame_buf_poŞ_Œy_g‘_avSync_äame_tcb
,

592 .
	gput_avSync_äame_tcb
 = 
avSync_äame_buf_poŞ_put_avSync_äame_tcb
,

593 .
	gg‘_avSync_äame_tcb_poŞ_’Œy_numb”
 = 
avSync_äame_buf_poŞ_g‘_avSync_äame_tcb_poŞ_’Œy_numb”
,

596 
	$š™_avSync_äame_buf_poŞ
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

598 
»t
 = 
TW_ERR
;

599 if(
video_deviû_buf_poŞ
 !ğ
NULL
){

600 
video_deviû_buf_poŞ
->
İ
 = &
avSync_äame_buf_poŞ_İ
;

601 
»t
 = 
video_deviû_buf_poŞ
->
İ
->
	`ü—‹
(video_deviû_buf_poŞ, 
VIDEO_MASTER_CHAN_BUF_POOL_LEN
);

603  
»t
;

604 
	}
}

606 
	$»move_avSync_äame_buf_poŞ
(
avSync_äame_buf_poŞ_t
 *
video_deviû_buf_poŞ
)

608 if(
video_deviû_buf_poŞ
 !ğ
NULL
){

609 
video_deviû_buf_poŞ
->
İ
->
	`»Ëa£
(video_device_buf_pool);

611 
	}
}

	@../../tw5864/tw5864/tw_char_lib12.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#GB2312_TBL_12X16_LEN
 (196272)

	)

4 
	#ASCII_TBL_12X16_LEN
 (2048)

	)

6 #ifdeà
POWERPC_PLATFORM


7 
	gascii12_6_tbl
[
ASCII_TBL_12X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

139 
	gjtzw12_12_tbl
[
GB2312_TBL_12X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

12410 
	gascii12_6_tbl
[
ASCII_TBL_12X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

12542 
	gjtzw12_12_tbl
[
GB2312_TBL_12X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

24814 
	$g‘_ascii_lib12_addr
(**
addr_±r
, * 
ch¬_id
)

24816 
off£t
;

24817 
off£t
 = *
ch¬_id
;

24818 if(
off£t
 > 127){

24819 *
addr_±r
 = 
NULL
;

24821 *
addr_±r
 = &
ascii12_6_tbl
[
off£t
<<4];

24823 
	}
}

24825 
	$g‘_lib12_addr
(**
addr_±r
, * 
lib16_id
)

24827 *
addr_±r
 = 
NULL
;

24828 if((
lib16_id
[0]>=0xa1) && (lib16_id[0]<=0xf7) && (lib16_id[1]>=0xa0)){

24829 
off£t
;

24830 
off£t
 = 
lib16_id
[0]-0xa1;

24831 
off£t
 *= 94;

24832 
off£t
 +ğ
lib16_id
[1] -0xa1;

24833 *
addr_±r
 = &
jtzw12_12_tbl
[
off£t
*24];

24835 
	}
}

	@../../tw5864/tw5864/tw_char_lib16.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#GB2312_TBL_16X16_LEN
 (261696)

	)

4 
	#ASCII_TBL_16X16_LEN
 (2048)

	)

6 #ifdeà
POWERPC_PLATFORM


7 
	gascii16_8_tbl
[
ASCII_TBL_16X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

138 
	gjtzw16_16_tbl
[
GB2312_TBL_16X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

270 
	gascii16_8_tbl
[
ASCII_TBL_16X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

402 
	gjtzw16_16_tbl
[
GB2312_TBL_16X16_LEN
] 
DATA_SECTION_ALIGN
(4)=

534 
	$g‘_ascii_lib16_addr
(**
addr_±r
, * 
ch¬_id
)

536 
off£t
;

537 
off£t
 = *
ch¬_id
;

538 if(
off£t
 > 127){

539 *
addr_±r
 = 
NULL
;

541 *
addr_±r
 = &
ascii16_8_tbl
[
off£t
<<4];

543 
	}
}

545 
	$g‘_lib16_addr
(**
addr_±r
, * 
lib16_id
)

547 *
addr_±r
 = 
NULL
;

548 if((
lib16_id
[0]>=0xa1) && (lib16_id[0]<=0xf7) && (lib16_id[1]>=0xa0)){

549 
off£t
;

550 
off£t
 = 
lib16_id
[0]-0xa1;

551 
off£t
 *= 94;

552 
off£t
 +ğ
lib16_id
[1] -0xa1;

553 *
addr_±r
 = &
jtzw16_16_tbl
[
off£t
<<5];

555 
	}
}

	@../../tw5864/tw5864/tw_char_lib24.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#GB2312_TBL_24X24_LEN
 (785088)

	)

4 
	#ASCII_TBL_24X12_LEN
 (6144)

	)

6 #ifdeà
POWERPC_PLATFORM


7 
	gascii24_12_tbl
[
ASCII_TBL_24X12_LEN
] 
DATA_SECTION_ALIGN
(4)=

394 
	gjtzw24_24_tbl
[
GB2312_TBL_24X24_LEN
] 
DATA_SECTION_ALIGN
(4)=

49466 
	gascii24_12_tbl
[
ASCII_TBL_24X12_LEN
] 
DATA_SECTION_ALIGN
(4)=

49854 
	gjtzw24_24_tbl
[
GB2312_TBL_24X24_LEN
] 
DATA_SECTION_ALIGN
(4)=

98926 
	$g‘_ascii_lib24_addr
(**
addr_±r
, * 
ch¬_id
)

98928 
off£t
;

98929 
off£t
 = *
ch¬_id
;

98930 if(
off£t
 > 127){

98931 *
addr_±r
 = 
NULL
;

98933 *
addr_±r
 = &
ascii24_12_tbl
[
off£t
*48];

98935 
	}
}

98937 
	$g‘_lib24_addr
(**
addr_±r
, * 
lib16_id
)

98939 *
addr_±r
 = 
NULL
;

98940 if((
lib16_id
[0]>=0xa1) && (lib16_id[0]<=0xf7) && (lib16_id[1]>=0xa0)){

98941 
off£t
;

98942 
off£t
 = 
lib16_id
[0]-0xa1;

98943 
off£t
 *= 94;

98944 
off£t
 +ğ
lib16_id
[1] -0xa1;

98945 *
addr_±r
 = &
jtzw24_24_tbl
[
off£t
*96];

98947 
	}
}

	@../../tw5864/tw5864/tw_chip.c

1 
	~<tw5864/dvm_commÚ.h
>

2 
	~<tw5864/tc_commÚ.h
>

4 #ifdeà 
ARM_PLATFORM


5 
š™_¬m_tim”
();

6 
şo£_¬m_tim”
();

7 #ifdef 
ARM_S3C2410_TW5864_PLATFORM


8 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 
	g¶©fÜm_video_’code_ÿp
[1] = {

10 .
fœ¡_deviû_numb”
 = 0,

11 .
	gvideo_’code_wÜk_mode
 = 
ENCODE_4_D1
,

12 .
	g’code_»g_4
 = (
DEBLOCKINGON
|
INTRAON
|
CMOSON
|
INTERON
|
DDRON
),

13 .
	gåga_sync_ba£_addr
 = 0,

14 .
	gåga_sync_£ùiÚ_Ën
 = 0,

15 .
	gåga_async_ba£_addr
 = 
FPGA0_BASE_ADDR
,

16 .
	gåga_async_£ùiÚ_Ën
 = 
FPGA_ASYNC_SECTION_LEN
,

17 .
	gddr_m­_mode
 = 
DDR_MAP_COMPRESS_DISABLE
,

23 #ifdeà 
POWERPC_PLATFORM


24 
dvm_m­_š™
();

25 
dvm_m­_ex™
();

26 
µc_tim”_š™
();

27 
µc_tim”_ex™
();

28 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 
	g¶©fÜm_video_’code_ÿp
[2] = {

30 .
fœ¡_deviû_numb”
 = 0,

31 .
	gvideo_’code_wÜk_mode
 = 
ENCODE_4_D1
,

32 .
	g’code_»g_4
 = (
DEBLOCKINGON
|
INTRAON
|
CMOSON
|
INTERON
|
DDRON
),

33 .
	gåga_sync_ba£_addr
 = 0,

34 .
	gåga_sync_£ùiÚ_Ën
 = 0,

35 .
	gåga_async_ba£_addr
 = 0,

36 .
	gåga_async_£ùiÚ_Ën
 = 0,

37 .
	gddr_m­_mode
 = 
DDR_MAP_COMPRESS_DISABLE
,

40 .
	gfœ¡_deviû_numb”
 = 16,

41 .
	gvideo_’code_wÜk_mode
 = 
ENCODE_4_D1
,

42 .
	g’code_»g_4
 = (
DEBLOCKINGON
|
INTRAON
|
CMOSON
|
INTERON
|
DDRON
),

43 .
	gåga_sync_ba£_addr
 = 0,

44 .
	gåga_sync_£ùiÚ_Ën
 = 0,

45 .
	gåga_async_ba£_addr
 = 0,

46 .
	gåga_async_£ùiÚ_Ën
 = 0,

47 .
	gddr_m­_mode
 = 
DDR_MAP_COMPRESS_DISABLE
,

52 
	$g‘_tw5864_avSync_deviû
(
tw5864_avSync_dev_t
 **
±r_deviû
, 
šode_id
)

54 
ty³_bus_t
 *
tw_ho¡_bus
;

55 
dvm_ch_t
 *
ch
;

56 
tw_ch_bus_t
 *
ch_bus
;

58 *
±r_deviû
 = 
NULL
;

59 #ifdeà
POWERPC_PCI_PLATFORM


60 
	`g‘_tw_pci_bus
(&
tw_ho¡_bus
);

62 
	`g‘_tw_ho¡_bus
(&
tw_ho¡_bus
);

65 
tw_ho¡_bus
->
İ
->
	`fšd_ch_bus_š_ty³_bus_bË
Ñw_ho¡_bus, &
ch_bus
, (
šode_id
>>4));

66 if(
ch_bus
 !ğ
NULL
){

67 
ch
 = 
	`to_g‘_ch_w™h_ch_bus
(
ch_bus
);

69 *
±r_deviû
 = &
ch
->
av_avSync_deviû_chª
[
šode_id
 & 0xf];

72 
	`´štk
("%s,%d: NØsuch ch!\n", 
__FILE__
, 
__LINE__
);

74 
	}
}

76 
	$ch_»que¡_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
, 
œq_hªdËr_t
 
hªdËr
,

77 cÚ¡ *
âÇme
, *
cÚ‹xt
)

79 
æags
;

80 
ch_œq_aùiÚ
 *
aùiÚ
;

81 
ch_œq_desc
 *
desc
;

83 if(!
ch
 || !
hªdËr
){

84  -
EINVAL
;

87 
desc
 = 
	`ch_œq_to_desc
(
ch
, 
œq
);

88 if(!
desc
){

89  -
EINVAL
;

91 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

92 
aùiÚ
 = &
desc
->action;

93 
aùiÚ
->
hªdËr
 = handler;

94 
aùiÚ
->
œq
 = irq;

95 
aùiÚ
->
Çme
 = 
âÇme
;

96 
aùiÚ
->
cÚ‹xt
 = context;

97 
aùiÚ
->
Ãxt
 = 
NULL
;

99 
desc
->
Çme
 = 
âÇme
;

100 
desc
->
œq_couÁ
 = 0;

101 
desc
->
œqs_unhªdËd
 = 0;

102 
	`©omic_šc
(&
desc
->
d•th
);

103 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

105 
	`ch_’abË_œq
(
ch
, 
œq
);

107  
TW_OK
;

108 
	}
}

110 
	$ch_ä“_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
, *
cÚ‹xt
)

112 
ch_œq_desc
 *
desc
;

113 
ch_œq_aùiÚ
 *
aùiÚ
;

114 
æags
;

116 
desc
 = 
	`ch_œq_to_desc
(
ch
, 
œq
);

117 if(!
desc
){

120 
	`¥š_lock_œq§ve
(&
desc
->
lock
, 
æags
);

121 
aùiÚ
 = &
desc
->action;

123 
aùiÚ
->
hªdËr
 = 
NULL
;

124 
aùiÚ
->
œq
 = irq;

125 
aùiÚ
->
Çme
 = 
NULL
;

126 
aùiÚ
->
cÚ‹xt
 = 
NULL
;

127 
aùiÚ
->
Ãxt
 = 
NULL
;

128 
	`©omic_dec
(&
desc
->
d•th
);

130 
	`¥š_uÆock_œq»¡Üe
(&
desc
->
lock
, 
æags
);

132 
	`ch_di§bË_œq
(
ch
, 
œq
);

135 
	}
}

137 
	$ch_’abË_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
)

139 
tw5864_š‹¼u±_cÚŒŞ_t
 *
œq_ù¾
;

141 if(
ch
 && (
œq
 < 
CHIP_IRQS_NR
)){

142 
œq_ù¾
 = &
ch
->
tw5864_št_cÚŒŞ
;

143 
œq_ù¾
->
sy¡em_İ
->
	`’abË_š‹¼u±_sourû
(œq_ù¾, 
œq
);

145 
	}
}

147 
	$ch_di§bË_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
)

149 
tw5864_š‹¼u±_cÚŒŞ_t
 *
œq_ù¾
;

151 if(
ch
 && (
œq
 < 
CHIP_IRQS_NR
)){

152 
œq_ù¾
 = &
ch
->
tw5864_št_cÚŒŞ
;

153 
œq_ù¾
->
sy¡em_İ
->
	`di§bË_š‹¼u±_sourû
(œq_ù¾, 
œq
);

155 
	}
}

157 
	$ch_ş—r_œq
(
dvm_ch_t
 *
ch
, 
u32
 
œq
)

159 
tw5864_š‹¼u±_cÚŒŞ_t
 *
œq_ù¾
;

161 if(
ch
 && (
œq
 < 
CHIP_IRQS_NR
)){

162 
œq_ù¾
 = &
ch
->
tw5864_št_cÚŒŞ
;

163 
œq_ù¾
->
h¬dw¬e_İ
->
	`ack_š‹¼u±
(œq_ù¾, 
œq
);

165 
	}
}

167 
œq_hªdËr_t
 
	$tw5864_vlc_œq_hªdËr
(
œq
, *
cÚ‹xt
)

169 
dvm_ch_t
 *
ch
;

171 
ch
 = 
cÚ‹xt
;

172 if(
ch
 !ğ
NULL
){

173 if(
ch
->
cu¼_h264_’code_chª
 !ğ
NULL
) {

174 
ch
->
cu¼_h264_’code_chª
->
’code_cÚŒŞ
.
İ
->
	`œq_func
(
œq
, (*)&chip->curr_h264_encode_chan->encode_control);

176 
	`´štk
("no„egister isr curr service chan\n");

181 
	}
}

183 
gpio_pš_£t
(
gpio
, 
boŞ
);

184 
	gs_gpio_pš
 = 0;

185 
œq»tuº_t
 
	$tw5864_tİ_i¤
(
œq
, *
id
)

187 
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
 = (tw5864_š‹¼u±_cÚŒŞ_t*)
id
;

188 
dvm_ch_t
 *
ch
 = 
cÚŒŞ
->chip;

189 
u32
 
ch_œq
 = 0;

190 
ch_œq_desc
 *
desc
;

191 
ch_œq_aùiÚ
 *
aùiÚ
;

192 
æags
;

194 
	`loÿl_œq_§ve
(
æags
);

195 
cÚŒŞ
->
h¬dw¬e_İ
->
	`g‘_š‹¼u±_¡©us
(control);

197 
s_gpio_pš
 = !s_gpio_pin;

199 if(
cÚŒŞ
->
ch_š‹¼u±_¡©us
){

200 
ch_œq
 = 0; ch_œq < 
CHIP_IRQS_NR
; chip_irq++){

201 if(
cÚŒŞ
->
ch_š‹¼u±_¡©us
 & (1 << 
ch_œq
)){

202 
desc
 = 
	`ch_œq_to_desc
(
ch
, 
ch_œq
);

203 
desc
->
œq_couÁ
++;

204 
aùiÚ
 = &
desc
->action;

205 if(
aùiÚ
->
hªdËr
) {

206 if(
aùiÚ
->
	`hªdËr
×ùiÚ->
œq
,‡ùiÚ->
cÚ‹xt
)){

210 
desc
->
œqs_unhªdËd
++;

213 
	`ch_ş—r_œq
(
ch
, 
ch_œq
);

216 
	`loÿl_œq_»¡Üe
(
æags
);

218  
IRQ_HANDLED
;

219 
	}
}

221 
	$tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_š™
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
dvm_ch_t
 *
ch
)

223 
»t
 = 
TW_ERR
;

224 
u32
 
i
;

226 if(
cÚŒŞ
 !ğ
NULL
){

227 
	`¥š_lock_š™
(&
cÚŒŞ
->
lock
);

228 
cÚŒŞ
->
š‹¼u±_sourû
 = 0x00000000;

229 
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 = 0x00000000;

230 
cÚŒŞ
->
š‹¼u±_sourû_as£¹
 = 0xffffffff;

231 
cÚŒŞ
->
ch_š‹¼u±_ouut_as£¹
 = 0x0;

232 
cÚŒŞ
->
ch_š‹¼u±_¡©us
 = 0x00000000;

233 #ifdeà
ARM_PLATFORM


234 
cÚŒŞ
->
ch_œq
 = 
IRQ_FPGA
;

236 #iâdeà
POWERPC_PCI_PLATFORM


237 
cÚŒŞ
->
ch_œq
 = 
	`œq_ü—‹_m­pšg
(
NULL
, 
IRQ_FPGA
);

240 
cÚŒŞ
->
ch
 = chip;

242 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 & 0xffff));

243 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
>>16) & 0xffff));

245 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_ASSERT_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû_as£¹
 & 0xffff));

246 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_ASSERT_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû_as£¹
>>16) & 0xffff));

248 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_OUTPUT_ASSERT_REG
, 
cÚŒŞ
->
ch_š‹¼u±_ouut_as£¹
);

251 
i
 = 0; i < 
CHIP_IRQS_NR
; i++)

253 
ch_œq_desc
 *
desc
 = 
	`ch_œq_to_desc
(
ch
, 
i
);

254 
desc
->
œq
 = 
i
;

255 
desc
->
œq_couÁ
 =0;

256 
desc
->
œqs_unhªdËd
 = 0;

257 
	`¥š_lock_š™
(&
desc
->
lock
);

258 
	`©omic_£t
(&
desc
->
d•th
, 0);

260 
	`mem£t
(&
desc
->
aùiÚ
, 0, (
ch_œq_aùiÚ
));

262 
desc
->
aùiÚ
 = 
NULL
;

264 
desc
->
œq
)

266 
IRQ_VLC_TYPE_INTR
:

267 
desc
->
Çme
 = "VLC";;

268 
IRQ_BURST_TYPE_INTR
:

269 
desc
->
Çme
 = "BURST";;

270 
IRQ_MV_TYPE_INTR
:

271 
desc
->
Çme
 = "MV";;

272 
IRQ_FRONT_END_TYPE_INTR
:

273 
desc
->
Çme
 = "FRONT_END";;

274 
IRQ_JPEG_TYPE_INTR
:

275 
desc
->
Çme
 = "JPEG";;

276 
IRQ_TIMER_TYPE_INTR
:

277 
desc
->
Çme
 = "TIMER";;

278 
IRQ_VLC_DONE_TYPE_INTR
:

279 
desc
->
Çme
 = "VLC_DONE";;

280 
IRQ_AD_SYNC_TYPE_INTR
:

281 
desc
->
Çme
 = "AD_SYNC";;

282 
IRQ_AUDIO_EOF_TYPE_INTR
:

283 
desc
->
Çme
 = "AUDIO";;

284 
IRQ_IIC_DONE_INTR
:

285 
desc
->
Çme
 = "IIC";;

286 
IRQ_AD_EVENT_INTR
:

287 
desc
->
Çme
 = "AD_EVENT";;

289 
desc
->
Çme
 = "UNDEFINE";

291 
	`ch_di§bË_œq
(
ch
, 
i
);

293 #ifdeà
POWERPC_PCI_PLATFORM


294 
»t
 = 
TW_OK
;

296 
	`£t_œq_ty³
(
cÚŒŞ
->
ch_œq
, 
IRQT_LOW
);

297 if(
	`»que¡_œq
(
cÚŒŞ
->
ch_œq
, 
tw5864_tİ_i¤
, 
IRQF_DISABLED
, 
ch
->
Çme
, control) == 0) {

298 #ifdef 
ARM_PLATFORM


299 
	`s3c2410_gpio_puÎup
(
IRQ_FPGA_PIN
, 0);

300 
	`s3c2410_gpio_cfgpš
(
IRQ_FPGA_PIN
, 
IRQ_FPGA_PIN_FN
);

302 
»t
 = 
TW_OK
;

306  
»t
;

307 
	}
}

309 
	$tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_’abË_š‹¼u±_sourû
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
u32
 
sourû
)

311 if((
cÚŒŞ
 !ğ
NULL
è&& (
sourû
 < 
CHIP_IRQS_NR
)){

312 
dvm_ch_t
 *
ch
;

313 
æags
;

314 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

315 
ch
 = 
cÚŒŞ
->chip;

317 
cÚŒŞ
->
š‹¼u±_sourû
 &ğ~(
INTERRUPT_DISABLE
<<
sourû
);

318 
cÚŒŞ
->
š‹¼u±_sourû
 |ğ(
INTERRUPT_ENABLE
<<
sourû
);

319 if(
sourû
 < (
CHIP_IRQS_NR
 / 2)){

320 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_ENABLE_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû
 & 0xffff));

322 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_ENABLE_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû
 >> 16) & 0xffff));

324 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

326 
	}
}

328 
	$tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_di§bË_š‹¼u±_sourû
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
u32
 
sourû
)

330 if((
cÚŒŞ
 !ğ
NULL
è&& (
sourû
 < 
CHIP_IRQS_NR
)){

331 
dvm_ch_t
 *
ch
;

332 
æags
;

333 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

334 
ch
 = 
cÚŒŞ
->chip;

335 
cÚŒŞ
->
š‹¼u±_sourû
 &ğ~(
INTERRUPT_ENABLE
<<
sourû
);

336 
cÚŒŞ
->
š‹¼u±_sourû
 |ğ(
INTERRUPT_DISABLE
<<
sourû
);

337 if(
sourû
 < (
CHIP_IRQS_NR
 / 2)){

338 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_ENABLE_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû
 & 0xffff));

340 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_ENABLE_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû
 >> 16) & 0xffff));

342 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

344 
	}
}

346 
	$tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_£t_š‹¼u±_sourû_edge_Œigg”
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
u32
 
sourû
)

348 if((
cÚŒŞ
 !ğ
NULL
è&& (
sourû
 < 
CHIP_IRQS_NR
)){

349 
dvm_ch_t
 *
ch
;

350 
æags
;

351 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

352 
ch
 = 
cÚŒŞ
->chip;

353 
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 &ğ~(
LEVEL_TRIGGER
<<
sourû
);

354 
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 |ğ(
EDGE_TRIGGER
<<
sourû
);

355 if(
sourû
 < (
CHIP_IRQS_NR
 / 2)){

356 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 & 0xffff));

358 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 >> 16) & 0xffff));

360 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

362 
	}
}

364 
	$tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_£t_š‹¼u±_sourû_Ëv–_Œigg”
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
u32
 
sourû
)

366 if((
cÚŒŞ
 !ğ
NULL
è&& (
sourû
 < 
CHIP_IRQS_NR
)){

367 
dvm_ch_t
 *
ch
;

368 
æags
;

369 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

370 
ch
 = 
cÚŒŞ
->chip;

371 
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 &ğ~(
EDGE_TRIGGER
<<
sourû
);

372 
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 |ğ(
LEVEL_TRIGGER
<<
sourû
);

373 if(
sourû
 < (
CHIP_IRQS_NR
 / 2)){

374 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_L
, (
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 & 0xffff));

376 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_SOURCE_TRIGGER_REG_H
, ((
cÚŒŞ
->
š‹¼u±_sourû_Œigg”_mode
 >> 16) & 0xffff));

378 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

380 
	}
}

382 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_İ”©iÚ
 
	gtw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_İ
 = {

383 .
š™
 = 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_š™
,

384 .
	g’abË_š‹¼u±_sourû
 = 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_’abË_š‹¼u±_sourû
,

385 .
	gdi§bË_š‹¼u±_sourû
 = 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_di§bË_š‹¼u±_sourû
,

386 .
	g£t_š‹¼u±_sourû_edge_Œigg”
 = 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_£t_š‹¼u±_sourû_edge_Œigg”
,

387 .
	g£t_š‹¼u±_sourû_Ëv–_Œigg”
 = 
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_£t_š‹¼u±_sourû_Ëv–_Œigg”
,

390 
	$tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_g‘_š‹¼u±_¡©us
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
)

392 if(
cÚŒŞ
 !ğ
NULL
){

393 
dvm_ch_t
 *
ch
;

394 
æags
;

395 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

396 
ch
 = 
cÚŒŞ
->chip;

397 
cÚŒŞ
->
ch_š‹¼u±_¡©us
 = (
ch
->
io_İ
->
	`ch_»ad32
(ch, 
INTERRUPT_STATUS_REG_L
)) & 0xffff;

398 
cÚŒŞ
->
ch_š‹¼u±_¡©us
 |ğ((
ch
->
io_İ
->
	`ch_»ad32
(ch, 
INTERRUPT_STATUS_REG_H
) & 0xffff) << 16);

399 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

401 
	}
}

403 
	$tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_ack_š‹¼u±
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
u32
 
sourû
)

405 if((
cÚŒŞ
 !ğ
NULL
è&& (
sourû
 < 
CHIP_IRQS_NR
)){

406 
dvm_ch_t
 *
ch
;

407 
æags
;

408 
	`¥š_lock_œq§ve
(&
cÚŒŞ
->
lock
, 
æags
);

409 
ch
 = 
cÚŒŞ
->chip;

410 
cÚŒŞ
->
ch_š‹¼u±_¡©us
 &ğ~(1<<
sourû
);

411 if(
sourû
 < (
CHIP_IRQS_NR
 / 2)){

412 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_CLEAR_REG_L
, (1<<
sourû
));

414 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_CLEAR_REG_H
, (1<<(
sourû
 - 16)));

416 
	`¥š_uÆock_œq»¡Üe
(&
cÚŒŞ
->
lock
, 
æags
);

418 
	}
}

420 
tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_İ”©iÚ
 
	gtw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_İ
 = {

421 .
g‘_š‹¼u±_¡©us
 = 
tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_g‘_š‹¼u±_¡©us
,

422 .
	gack_š‹¼u±
 = 
tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_ack_š‹¼u±
,

425 
	$š™_tw5864_š‹¼u±_cÚŒŞ
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
dvm_ch_t
 *
ch
)

427 
»t
 = 
TW_ERR
;

429 if((
cÚŒŞ
!=
NULL
è&& (
ch
!=NULL)){

430 
cÚŒŞ
->
sy¡em_İ
 = &
tw5864_š‹¼u±_cÚŒŞ_sy¡em_š‹rçû_İ
;

431 
cÚŒŞ
->
h¬dw¬e_İ
 = &
tw5864_š‹¼u±_cÚŒŞ_h¬dw¬e_š‹rçû_İ
;

432 
»t
 = 
cÚŒŞ
->
sy¡em_İ
->
	`š™
(cÚŒŞ, 
ch
);

434  
»t
;

435 
	}
}

437 
	$»move_tw5864_š‹¼u±_cÚŒŞ
(
tw5864_š‹¼u±_cÚŒŞ_t
 *
cÚŒŞ
, 
dvm_ch_t
 *
ch
)

439 if((
cÚŒŞ
!=
NULL
è&& (
ch
!=NULL)){

444 #iâdeà
POWERPC_PCI_PLATFORM


445 
	`ä“_œq
(
cÚŒŞ
->
ch_œq
, control);

448 
	}
}

450 
	$di§bË_ch_št
(
dvm_ch_t
 *
ch
)

452 
	`di§bË_œq
(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
);

453 
	}
}

455 
	$’abË_ch_št
(
dvm_ch_t
 *
ch
)

457 
	`’abË_œq
(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
);

458 
	}
}

460 
	$ch_pŞlšg_sk
(*
cÚ‹xt
)

462 
dvm_ch_t
 *
ch
 = (dvm_ch_t*)
cÚ‹xt
;

463 if(
ch
 !ğ
NULL
){

464 
ch_driv”_t
 *
driv”
;

465 
d©a
;

466 
tw_video_bus_t
 *
video_bus
;

467 
tw_ch_vi_driv”_t
 *
ch_vi_driv”
;

469 
ch
->
ch_audio
.
İ
->
	`g‘_ch_audio_·¿m
(&chip->chip_audio);

470 
ch
->
ch_audio
.
İ
->
	`´oûss_audio_decode
(&chip->chip_audio);

471 
ch
->
ch_audio
.
İ
->
	`´oûss_audio_’code
(&chip->chip_audio);

472 
ch
->
ch_audio
.
İ
->
	`£t_ch_audio_·¿m
(&chip->chip_audio);

475 
d©a
 = 
	`mpb_»ad
(
ch
, 
TW_VI_STANDARD
);

476 
d©a
 >>= 4;

477 
d©a
 &= 0x7;

478 
driv”
 = 
ch
->
ch_driv”
;

479 
ch_vi_driv”
 = 
ch
->chip_vi_driver;

480 
video_bus
 = &
driv”
->video_bus;

483 if(
ch_vi_driv”
->
İ
->
	`g‘_video_¡ªd¬d
(ch_vi_driv”è=ğ
CHIP_VI_STANDARD_AUTO
) {

484 if((
d©a
 =ğ
CHIP_VI_STANDARD_NTSC_M
è|| (d©¨=ğ
CHIP_VI_STANDARD_NTSC443
)) {

486 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_NTSC
) {

487 
	`TW_DBG
(
TW_DBG_INFO
, "changeƒncodero NTSC\n");

488 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d
(ch_vi_driv”, 
d©a
);

489 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d_ext
(ch_vi_driv”, 
CHIP_VI_STANDARD_AUTO
);

493 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_PAL
) {

494 
	`TW_DBG
(
TW_DBG_INFO
, "changeƒncodero PAL\n");

495 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d
(ch_vi_driv”, 
d©a
);

496 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d_ext
(ch_vi_driv”, 
CHIP_VI_STANDARD_AUTO
) ;

499 if((
	`mpb_»ad
(
ch
, 
TW_VI_SYSTEM_VIDEO_STANDARD
) & 0x1) == 0x1){

500 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_PAL
) {

501 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d
(ch_vi_driv”, 
d©a
);

502 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d_ext
(ch_vi_driv”, 
CHIP_VI_STANDARD_AUTO
) ;

505 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_NTSC
) {

506 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d
(ch_vi_driv”, 
d©a
);

507 
ch_vi_driv”
->
İ
->
	`£t_video_¡ªd¬d_ext
(ch_vi_driv”, 
CHIP_VI_STANDARD_AUTO
);

513  
TW_OK
;

514 
	}
}

518 cÚ¡ 
åga_»g_addr
 
	gFÜw¬dQuªtiz©iÚTabË
[
QUANTIZATION_TABLE_LEN
] =

532 cÚ¡ 
åga_»g_addr
 
	gInv”£Quªtiz©iÚTabË
[
QUANTIZATION_TABLE_LEN
] =

546 cÚ¡ 
åga_»g_addr
 
	gvlc_lookup_bË
[
VLC_LOOKUP_TABLE_LEN
] = {

635 
	$Wr™eVLCLookupTabË
(
dvm_ch_t
 *
ch
)

637 
i
;

639 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 0x1);

640 
i
=0; i<
VLC_LOOKUP_TABLE_LEN
; i++){

641 
ch
->
io_İ
->
	`ch_wr™e32
(ch, (
VLC_LOOKUP_TABLE_BASE
+(
i
<<2)), 
vlc_lookup_bË
[i]);

643 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 0x0);

644 
	}
}

646 
	$Wr™eFÜw¬dQuªtiz©iÚTabË
(
dvm_ch_t
 *
ch
)

648 
i
;

650 
i
=0; i<
QUANTIZATION_TABLE_LEN
; i++) {

651 
ch
->
io_İ
->
	`ch_wr™e32
(ch, (
QUANTIZATION
+(
i
<<2)), 
FÜw¬dQuªtiz©iÚTabË
[i]);

653 
	}
}

655 
	$Wr™eInv”£Quªtiz©iÚTabË
(
dvm_ch_t
 *
ch
)

657 
i
;

659 
i
=0; i<
QUANTIZATION_TABLE_LEN
; i++) {

660 
ch
->
io_İ
->
	`ch_wr™e32
(ch, (
QUANTIZATION
+(
i
<<2)), 
Inv”£Quªtiz©iÚTabË
[i]);

662 
	}
}

664 
	$CË¬DDR
(
dvm_ch_t
 *
ch
)

666 
i
, 
j
;

668 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 
DDRON
);

669 
i
=0; i<128; i++) {

670 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
i
);

671 
j
=0; j<0x20000; j++){

672 
ch
->
io_İ
->
	`ch_wr™e32
(ch, (
DDRBASE
+(
j
<<2)), 0x0);

675 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
FRAMERESOLUTION
, 0x2c24);

676 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
WINDOWSIZE
, 
SEARCH_WINDOW_SIZE_VALUE
);

677 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
REFFRAMEINDEX
, 0x2001);

678 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
QP
, 0x1c);

679 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x0);

680 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ORIGINALSEQUENCE
, 0x14c8);

681 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
REFERENCEFRAME
, 0x0440);

682 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

683 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_ID
, 
MB_DELAY_VALUE
 | 
DDR_B_CHIP
);

684 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, (
D1
|
DAON
|
DEBLOCKINGON
|
INTRAON
|
INTERON
|
DDRON
));

685 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DSP_DEBUG_CNTL
, (0x40<<8)|
START_DAC
);

686 
	`´štk
("\nclear ddr over\n");

687 
	}
}

689 
	$ch_h¬dw¬e_»sourû_İ’
(
dvm_ch_t
 *
ch
)

691 if(
	`©omic_»ad
(&
ch
->
İ’_chª_numb”
) >= 0){

692 
	`´štk
("%s, %d\n", 
__FUNCTION__
, 
__LINE__
);

693 if(
	`©omic_»ad
(&
ch
->
İ’_chª_numb”
) == 0){

694 
ch
->
	`ch_£t_v®id
(chip);

696 
	`©omic_šc
(&
ch
->
İ’_chª_numb”
);

698 
	`´štk
("%s.%d: o³n_chª_numb”ƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

701 
	}
}

703 
	$ch_h¬dw¬e_»sourû_şo£
(
dvm_ch_t
 *
ch
)

705 if(
	`©omic_»ad
(&
ch
->
İ’_chª_numb”
) > 0){

706 
	`´štk
("%s, %d\n", 
__FUNCTION__
, 
__LINE__
);

707 
	`©omic_dec
(&
ch
->
İ’_chª_numb”
);

708 if(
	`©omic_»ad
(&
ch
->
İ’_chª_numb”
) == 0){

709 
ch
->
	`ch_£t_šv®id
(chip);

712 
	`´štk
("%s.%d: o³n_chª_numb”ƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

714 
	}
}

716 #ifdeà 
OSD_MODULE


717 
timev®
 
	gs_osd_tv1
;

720 
œq»tuº_t
 
	$tim”_Ú_ch_hªdËr
(
œq
, *
cÚ‹xt
)

722 if(
cÚ‹xt
) {

723 
u32
 
æags
;

724 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
cÚ‹xt
;

726 
æags
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
INTERRUPT_FLAGS_EXT
);

727 if(
æags
 & (1 << 
IRQ_EXT_TIMER_INTR
)) {

728 #ifdeà 
OSD_MODULE


729 
	`check_¹c_time
(&
s_osd_tv1
);

732 
	`Tig”SšgËFœeTim”
();

733 
	`Tig”FÜFœeTim”
();

735 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERRUPT_FLAGS_EXT
, 1 << 
IRQ_EXT_TIMER_INTR
);

739  
IRQ_HANDLED
;

740 
	}
}

742 
	$»gi¡”_Ú_ch_tim”
(
dvm_ch_t
 *
ch
, 
œq_hªdËr_t
 
hªdËr
)

744 if(
ch
 && 
hªdËr
) {

745 if(
	`ch_»que¡_œq
(
ch
, 
IRQ_TIMER_TYPE_INTR
, 
tim”_Ú_ch_hªdËr
, "timer", chip)){

746 
	`´štk
("% ,%d:„egi¡” sy¡emim” faed\n", 
__FUNCTION__
, 
__LINE__
);

749 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_TIMER_CONTROL
, 0x2);

750 
ch
->
	`’abË_tim”
(chip);

752 
	}
}

754 
	$’abË_Ú_ch_tim”
(
dvm_ch_t
 *
ch
)

756 if(
ch
) {

757 
u32
 
v®
;

759 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_MASTER_CONTROL
);

760 
v®
 |ğ(1 << 
IRQ_EXT_TIMER_INTR
);

761 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_MASTER_CONTROL
, 
v®
);

763 
	}
}

765 
	$di§bË_Ú_ch_tim”
(
dvm_ch_t
 *
ch
)

767 if(
ch
) {

768 
u32
 
v®
;

770 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_MASTER_CONTROL
);

771 
v®
 &ğ~(1 << 
IRQ_EXT_TIMER_INTR
);

772 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_MASTER_CONTROL
, 
v®
);

774 
	}
}

776 
	$uÄegi¡”_Ú_ch_tim”
(
dvm_ch_t
 *
ch
)

778 if(
ch
) {

779 
ch
->
	`di§bË_tim”
(chip);

780 
	`ch_ä“_œq
(
ch
, 
IRQ_TIMER_TYPE_INTR
, chip);

782 
	}
}

784 
	$ch_phy_šv®id
(
dvm_ch_t
 *
ch
)

786 
æags
;

787 
u32
 
v®
;

788 
tw_ch_vi_driv”_t
 *
ch_vi_driv”
 = 
ch
->chip_vi_driver;

790 
	`´štk
("%s, %d\n", 
__FUNCTION__
, 
__LINE__
);

791 
	`loÿl_œq_§ve
(
æags
);

792 if(
ch
->
d–‘e_ch_pŞlšg_sk
 !ğ
NULL
){

793 
ch
->
	`d–‘e_ch_pŞlšg_sk
(chip);

795 #ifdeà
USE_ON_CHIP_TIMER


796 if(
ch
->
uÄegi¡”_tim”
) {

797 
ch
->
	`uÄegi¡”_tim”
(chip);

800 #ifdef 
ARM_PLATFORM


801 
	`s3c2410_gpio_cfgpš
(
FPGA_RESET_PIN
, 
FPGA_RESET_PIN_FN
);

802 
	`s3c2410_gpio_puÎup
(
FPGA_RESET_PIN
, 0);

803 
	`s3c2410_gpio_£š
(
FPGA_RESET_PIN
, 
FPGA_RESET_VALID
);

804 
	`ud–ay
(100);

805 if(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
 =ğ
IRQ_EINT0
){

806 
	`__¿w_wr™–
(0x1, 
S3C2410_SRCPND
);

807 
	`__¿w_wr™–
(0x1, 
S3C2410_INTPND
);

808 } if(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
 =ğ
IRQ_EINT1
){

809 
	`__¿w_wr™–
(0x2, 
S3C2410_SRCPND
);

810 
	`__¿w_wr™–
(0x2, 
S3C2410_INTPND
);

812 
	`__¿w_wr™–
(0x4, 
S3C2410_SRCPND
);

813 
	`__¿w_wr™–
(0x4, 
S3C2410_INTPND
);

815 
	`s3c2410_gpio_£š
(
FPGA_RESET_PIN
, 
FPGA_RESET_INVALID
);

817 #iâdeà
FPGA_330_5864_TESTING


818 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x8018, 0xd000 + ((ch->
sys_şock
 << 1) - 1));

819 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x8020, 0x284);

820 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x8024, 0x20);

821 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x801c, 0x0d);

822 
	`md–ay
(5);

824 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_RESET
, 0x00);

825 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_RESET
, 0xe0);

826 
	`md–ay
(1);

827 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_CLOCK
, 0xf0);

828 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_CLOCK_REVERSE
, 0xf0);

831 
	`loÿl_œq_»¡Üe
(
æags
);

832 
	`md–ay
(5);

834 #iâdeà
FPGA_330_5864_TESTING


835 if(
ch
->
sys_şock
 > 110) {

836 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0xa000, 0xc5);

837 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0xa800, 0xc5);

842 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MCU_IIC_CONF
);

843 
v®
 |= 0x01;

844 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MCU_IIC_CONF
, 
v®
);

845 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
I2C_PHASE_SHIFT
, 0x01);

848 if(
ch_vi_driv”
 && ch_vi_driv”->
İ
) {

849 
ch_vi_driv”
->
İ
->
	`»£t
(chip_vi_driver);

853 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x8028, 0x15);

854 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x801c, 0x18);

855 
	`md–ay
(5);

856 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x801c, 0x00);

858 
	}
}

860 
	$ch_phy_v®id
(
dvm_ch_t
 *
ch
)

862 
u32
 
v®
;

863 
ch_driv”_t
 *
driv”
;

864 
tw_video_bus_t
 *
video_bus
;

865 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

866 
tw5864_vj_bus_t
 *
vj_bus
;

869 
	`´štk
("%s, %d\n", 
__FUNCTION__
, 
__LINE__
);

870 
driv”
 = 
ch
->
ch_driv”
;

871 
video_bus
 = &
driv”
->video_bus;

872 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

873 
vj_bus
 = 
video_bus
->
vj_bus_driv”
;

876 
ch
->
	`ch_£t_šv®id
(chip);

877 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0);

878 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, (
DDRON
|
CMOSON
));

879 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRANDMECONTROL
, 0);

880 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_SELECT
, 0);

881 
	`Wr™eFÜw¬dQuªtiz©iÚTabË
(
ch
);

882 
	`Wr™eInv”£Quªtiz©iÚTabË
(
ch
);

883 
	`Wr™eVLCLookupTabË
(
ch
);

884 
	`TW_DBG
(
TW_DBG_INFO
, "\nFPGA v”siÚ: %x:%x, ch_id=%d\n", 
ch
->
io_İ
->
	`ch_»ad32
(ch, 0), ch->io_İ->ch_»ad32(ch, 8), ch->
ch_id
);

887 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
MCU_IIC_CONF
);

888 
v®
 |= 0x01;

889 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MCU_IIC_CONF
, 
v®
);

890 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
I2C_PHASE_SHIFT
, 0x01);

892 
vd_bus
->
İ
->
	`»£t
(vd_bus);

893 
vd_bus
->
İ
->
	`£t_ch_’d_üoss_bus
(vd_bus, 
ch
);

895 
vj_bus
->
İ
->
	`»£t
(vj_bus);

897 if(
ch
->
add_ch_pŞlšg_sk
 !ğ
NULL
){

898 
ch
->
	`add_ch_pŞlšg_sk
(chip);

900 #ifdeà
USE_ON_CHIP_TIMER


901 if(
ch
->
»gi¡”_tim”
) {

902 
ch
->
	`»gi¡”_tim”
(ch, 
tim”_Ú_ch_hªdËr
);

905 #ifdeà
POWERPC_PCI_PLATFORM


907 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
PCI_MASTER_CONTROL
);

908 
v®
 |= (0x7 << 26);

909 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
PCI_MASTER_CONTROL
, 
v®
);

910 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, (1<<13));

911 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, (ch->io_İ->
	`ch_»ad32
(chip, ENABLE_VLC_LOOKUP_TABLE) | 0x2));

913 
	}
}

915 
	$ch_phy_»£t
(
dvm_ch_t
 *
ch
)

917 if(
ch
) {

918 
ch_driv”_t
 *
ch_driv”
 = 
ch
->chip_driver;

919 
tw_ch_ai_driv”_t
 *
ch_ai_driv”
 = 
ch
->chip_ai_driver;

920 
tw_ch_vi_driv”_t
 *
ch_vi_driv”
 = 
ch
->chip_vi_driver;

922 if(
ch_ai_driv”
 && ch_ai_driv”->
İ
) {

923 
ch_ai_driv”
->
İ
->
	`»£t
(chip_ai_driver);

925 if(
ch_vi_driv”
 && ch_vi_driv”->
İ
) {

926 
ch_vi_driv”
->
İ
->
	`»£t
(chip_vi_driver);

928 if(
ch_driv”
 && ch_driv”->
İ
) {

929 
ch_driv”
->
İ
->
	`»£t
(chip_driver);

932 
	}
}

934 
	$add_ch_pŞlšg_sk
(
dvm_ch_t
 *
ch
)

936 if(
ch
 !ğ
NULL
){

937 
	`D–‘eFÜFœeTim”Job
(
ch
->
ch_pŞlšg_timeid
);

938 
ch
->
ch_pŞlšg_timeid
 = 
INVALIDTIMERID
;

939 
ch
->
ch_pŞlšg_timeid
 = 
	`AddFÜFœeTim”Job
(1, 
ch_pŞlšg_sk
, chip);

940 if(
ch
->
ch_pŞlšg_timeid
 =ğ
ADDJOBERROR
){

941 
	`´štk
("%s.%d:‡ddim” hookƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

944 
	}
}

946 
	$d–‘e_ch_pŞlšg_sk
(
dvm_ch_t
 *
ch
)

948 if(
ch
 !ğ
NULL
){

949 
	`D–‘eFÜFœeTim”Job
(
ch
->
ch_pŞlšg_timeid
);

950 
ch
->
ch_pŞlšg_timeid
 = 
INVALIDTIMERID
;

952 
	}
}

954 
	$»gi¡”_cu¼_h264_’code_chª
(
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

956 if((
ch
!=
NULL
è&& (
h264_logic_’code_chª
!=NULL)){

957 
ch
->
vlc_pšg_pÚg_šdex
 = 0;

958 
	`ch_»que¡_œq
(
ch
, 
IRQ_VLC_TYPE_INTR
, 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
İ
->
œq_func
, "VLC", (*)&h264_logic_encode_chan->encode_control);

960 
	}
}

962 
	$uÄegi¡”_cu¼_h264_’code_chª
(
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

964 if((
ch
!=
NULL
è&& (
h264_logic_’code_chª
!=NULL)){

965 
	`ch_ä“_œq
(
ch
, 
IRQ_VLC_TYPE_INTR
, &
h264_logic_’code_chª
->
’code_cÚŒŞ
);

967 
	}
}

969 
	$ch_’code_chª_£rviû_queue_š™
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
)

971 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

972 
tcb_node_queue_t
 *
queue_node
 = &
ch_’code_£rviû_queue
->
£rviû_queue_node
;

973 
	`¥š_lock_š™
(&
ch_’code_£rviû_queue
->
lock
);

974 
	`©omic_£t
(&
ch_’code_£rviû_queue
->
h264_ma¡”_ÿn_»cv_numb”
, 2);

975 
	`©omic_£t
(&
ch_’code_£rviû_queue
->
h264_ddr_ÿche_numb”
, 8);

976 
queue_node
->
İ
 = &
tcb_node_queue_İ
;

977 
queue_node
->
İ
->
	`š™
(queue_node);

978 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

980 
	}
}

982 
	$ch_’code_chª_£rviû_queue_g‘_queue_cu¼_’Œy_numb”
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
)

984 
»t
 = 0;

985 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

986 
tcb_node_queue_t
 *
queue_node
 = &
ch_’code_£rviû_queue
->
£rviû_queue_node
;

987 
»t
 = 
queue_node
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue_node);

989  
»t
;

990 
	}
}

992 
	$ch_’code_chª_£rviû_queue_put_£rviû_»que¡_što_queue
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
, 
’code_chª_£rviû_tcb_t
 *
chª_£rviû_tcb
)

994 if((
ch_’code_£rviû_queue
!=
NULL
è&& (
chª_£rviû_tcb
!=NULL)){

995 
tcb_node_queue_t
 *
queue_node
 = &
ch_’code_£rviû_queue
->
£rviû_queue_node
;

996 
queue_node
->
İ
->
	`put
(queue_node, &
chª_£rviû_tcb
->
£rviû_tcb
);

997 
ch_’code_£rviû_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(chip_encode_service_queue);

999 
	}
}

1001 
	$ch_’code_chª_£rviû_queue_put_£rviû_»que¡_što_queue_h—d”
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
, 
’code_chª_£rviû_tcb_t
 *
chª_£rviû_tcb
)

1003 if((
ch_’code_£rviû_queue
!=
NULL
è&& (
chª_£rviû_tcb
!=NULL)){

1004 
tcb_node_queue_t
 *
queue_node
 = &
ch_’code_£rviû_queue
->
£rviû_queue_node
;

1005 
queue_node
->
İ
->
	`put_h—d”
(queue_node, &
chª_£rviû_tcb
->
£rviû_tcb
);

1006 
ch_’code_£rviû_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(chip_encode_service_queue);

1008 
	}
}

1010 
	$ch_’code_chª_£rviû_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
)

1012 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

1013 
tcb_node_queue_t
 *
queue_node
 = &
ch_’code_£rviû_queue
->
£rviû_queue_node
;

1015 if(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1016 if(
queue_node
->
İ
 !ğ
NULL
){

1017 
tcb_node_t
 *
‹mp_node
;

1018 
queue_node
->
İ
->
	`Œy_g‘
(queue_node, &
‹mp_node
);

1019 if(
‹mp_node
 !ğ
NULL
){

1020 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
	`to_g‘_’code_chª_£rviû_tcb_w™h_£rviû_tcb
(
‹mp_node
);

1025 
	}
}

1027 
	$ch_’code_chª_£rviû_queue_»Ëa£_cu¼_cÚsum”
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
)

1029 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

1030 
æags
;

1031 
	`¥š_lock_œq§ve
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1032 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

1033 
	`¥š_uÆock_œq»¡Üe
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1035 
	}
}

1037 
	$ch_’code_chª_£rviû_queue_Œigg”_ch_³ndšg_£rviû_»que¡
(
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
)

1039 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

1040 
’code_chª_£rviû_tcb_t
 *
cu¼_cÚsum”
;

1041 
cu¼_’Œy_numb”
;

1042 
æags
;

1044 
	`¥š_lock_œq§ve
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1045 
agaš
:

1046 
cu¼_’Œy_numb”
 = 
ch_’code_£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(chip_encode_service_queue);

1047 if((
cu¼_’Œy_numb”
==0è&& (
ch_’code_£rviû_queue
->
cu¼_cÚsum”
==
NULL
)){

1048 
	`¥š_uÆock_œq»¡Üe
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1050 } if(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

1051 
	`¥š_uÆock_œq»¡Üe
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1054 
ch_’code_£rviû_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(chip_encode_service_queue);

1055 
cu¼_cÚsum”
 = 
ch_’code_£rviû_queue
->curr_consumer;

1056 if(
cu¼_cÚsum”
 !ğ
NULL
){

1057 
	`¥š_uÆock_œq»¡Üe
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1058 
cu¼_cÚsum”
->
	`»q_ÿÎback
(cu¼_cÚsum”->
cÚ‹xt
);

1059 
	`¥š_lock_œq§ve
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1060 if(
cu¼_cÚsum”
->
ty³
 =ğ
DVM_CHIP_REQ_FIRST_STRAT_ENCODE_CHAN
){

1061 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

1062 
agaš
;

1065 
	`¥š_uÆock_œq»¡Üe
(&
ch_’code_£rviû_queue
->
lock
, 
æags
);

1067 
	}
}

1069 
ch_’code_chª_£rviû_queue_İ”©iÚ
 
	gch_’code_chª_£rviû_queue_İ
 = {

1070 .
š™
 = 
ch_’code_chª_£rviû_queue_š™
,

1071 .
	gg‘_queue_cu¼_’Œy_numb”
 = 
ch_’code_chª_£rviû_queue_g‘_queue_cu¼_’Œy_numb”
,

1072 .
	gput_£rviû_»que¡_što_queue
 = 
ch_’code_chª_£rviû_queue_put_£rviû_»que¡_što_queue
,

1073 .
	gput_£rviû_»que¡_što_queue_h—d”
 = 
ch_’code_chª_£rviû_queue_put_£rviû_»que¡_što_queue_h—d”
,

1074 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
ch_’code_chª_£rviû_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

1075 .
	g»Ëa£_cu¼_cÚsum”
 = 
ch_’code_chª_£rviû_queue_»Ëa£_cu¼_cÚsum”
,

1076 .
	gŒigg”_ch_³ndšg_£rviû_»que¡
 = 
ch_’code_chª_£rviû_queue_Œigg”_ch_³ndšg_£rviû_»que¡
,

1079 
	$š™_ch_’code_chª_£rviû_queue
(
ch_’code_chª_£rviû_queue_t
 * 
ch_’code_£rviû_queue
)

1081 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

1082 
ch_’code_£rviû_queue
->
İ
 = &
ch_’code_chª_£rviû_queue_İ
;

1083 
ch_’code_£rviû_queue
->
İ
->
	`š™
(chip_encode_service_queue);

1085 
	}
}

1087 
	$»move_ch_’code_chª_£rviû_queue
(
ch_’code_chª_£rviû_queue_t
 * 
ch_’code_£rviû_queue
)

1089 if(
ch_’code_£rviû_queue
 !ğ
NULL
){

1090 if(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

1091 
	`nÙify_»move_’code_chª_£rviû
(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
);

1092 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

1094 
ch_’code_£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(chip_encode_service_queue)){

1095 
ch_’code_£rviû_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(chip_encode_service_queue);

1096 if(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1099 
	`nÙify_»move_’code_chª_£rviû
(
ch_’code_£rviû_queue
->
cu¼_cÚsum”
);

1100 
ch_’code_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

1104 
	}
}

1106 
u32
 
	$tw5864_ho¡_io_ch_»ad32
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1108  
	`__¿w_»adl
((
ch
->
»gs
+
off£t
));

1109 
	}
}

1111 
u16
 
	$tw5864_ho¡_io_ch_»ad16
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1113  
	`__¿w_»adw
((
ch
->
»gs
+
off£t
));

1114 
	}
}

1116 
u8
 
	$tw5864_ho¡_io_ch_»ad8
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1118  
	`__¿w_»adb
((
ch
->
»gs
+
off£t
));

1119 
	}
}

1121 
	$tw5864_ho¡_io_ch_»ad_block
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
Ën
, u32 *
de¡
)

1123 
i
;

1124 
Ën
 += 3;

1125 
Ën
 >>= 2;

1126 
i
=0; i<
Ën
; i++){

1127 
de¡
[
i
] = 
	`__¿w_»adl
((
ch
->
»gs
+
off£t
));

1128 
off£t
 += 4;

1130 
	}
}

1132 
	$tw5864_ho¡_io_ch_wr™e32
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, u32 
v®ue
)

1134 
	`__¿w_wr™–
(
v®ue
, (
ch
->
»gs
+
off£t
));

1136 if(
off£t
 < 0x2000){

1137 
	`´štk
("264: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1138 } if(
off£t
 < 0x3000){

1140 } if(
off£t
 < 0x4000){

1141 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1142 } if(
off£t
 < 0x5000){

1143 
	`´štk
("audio: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1144 } if(
off£t
 < 0x802c){

1145 
	`´štk
("sy¡em_cÚfig: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1146 } if(
off£t
 < 0x8800){

1147 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1148 } if(
off£t
 < 0x8900){

1149 
	`´štk
("IÁ: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1150 } if(
off£t
 < 0x9000){

1151 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1152 } if(
off£t
 < 0x9210){

1153 
	`´štk
("VIF: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1154 } if(
off£t
 < 0xa000){

1155 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1156 } if(
off£t
 < 0xa900){

1157 
	`´štk
("DDR: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1158 } if(
off£t
 < 0xb800){

1159 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1160 } if(
off£t
 < 0xb810){

1161 
	`´štk
("IAR: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1162 } if(
off£t
 < 0xc000){

1163 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1164 } if(
off£t
 < 0xc800){

1165 
	`´štk
("´ev›w: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1166 } if(
off£t
 < 0xc808){

1167 
	`´štk
("MJPEG_C­tu»: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1168 } if(
off£t
 < 0xd000){

1169 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1170 } if(
off£t
 < 0xd100){

1171 
	`´štk
("MJPEG_CÚŒŞ: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1172 } if(
off£t
 < 0xe000){

1173 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1174 } if(
off£t
 < 0xfc00){

1175 
	`´štk
("MÙiÚ_veùÜ: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1176 } if(
off£t
 < 0x18000){

1177 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1178 } if(
off£t
 < 0x18200){

1179 
	`´štk
("PCI_CÚŒŞ_m­: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1180 } if(
off£t
 < 0x80000){

1181 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1182 } if(
off£t
 < 0x88000){

1183 
	`´štk
("ddr_bur¡_m­: %x=0x%x, 0x%x\n", 
off£t
, 
v®ue
, 
	`__¿w_»adl
(
ch
->
»gs
+offset));

1185 
	`´štk
("»£rv” s·û %x\n", 
off£t
);

1188 
	}
}

1190 
	$tw5864_ho¡_io_ch_wr™e16
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
u16
 
v®ue
)

1192 
	`__¿w_wr™ew
(
v®ue
, (
ch
->
»gs
+
off£t
));

1193 
	}
}

1195 
	$tw5864_ho¡_io_ch_wr™e8
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
u8
 
v®ue
)

1197 
	`__¿w_wr™eb
(
v®ue
, (
ch
->
»gs
+
off£t
));

1198 
	}
}

1200 
	$tw5864_ho¡_io_ch_wr™e_block
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
Ën
, u32 *
¤c
)

1202 
i
;

1203 
Ën
 += 3;

1204 
Ën
 >>= 2;

1205 
i
=0; i<
Ën
; i++){

1206 
	`__¿w_wr™–
(
¤c
[
i
], (
ch
->
»gs
+
off£t
));

1207 
off£t
 += 4;

1209 
	}
}

1211 
ch_io_İ”©iÚ
 
	gtw5864_ho¡_io
 = {

1212 .
ch_»ad32
 = 
tw5864_ho¡_io_ch_»ad32
,

1213 .
	gch_»ad16
 = 
tw5864_ho¡_io_ch_»ad16
,

1214 .
	gch_»ad8
 = 
tw5864_ho¡_io_ch_»ad8
,

1215 .
	gch_»ad_block
 = 
tw5864_ho¡_io_ch_»ad_block
,

1216 .
	gch_wr™e32
 = 
tw5864_ho¡_io_ch_wr™e32
,

1217 .
	gch_wr™e16
 = 
tw5864_ho¡_io_ch_wr™e16
,

1218 .
	gch_wr™e8
 = 
tw5864_ho¡_io_ch_wr™e8
,

1219 .
	gch_wr™e_block
 = 
tw5864_ho¡_io_ch_wr™e_block
,

1222 #ifdeà
POWERPC_PLATFORM


1223 
u32
 
	$tw5864_pci_io_ch_»ad32
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1225  
	`š_Ë32
((
ch
->
»gs
+
off£t
));

1226 
	}
}

1228 
u16
 
	$tw5864_pci_io_ch_»ad16
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1230  
	`š_Ë16
((
ch
->
»gs
+
off£t
));

1231 
	}
}

1233 
u8
 
	$tw5864_pci_io_ch_»ad8
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
)

1235  
	`š_8
((
ch
->
»gs
+
off£t
));

1236 
	}
}

1238 
	$tw5864_pci_io_ch_»ad_block
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
Ën
, u32 *
de¡
)

1240 
i
;

1241 
Ën
 += 3;

1242 
Ën
 >>= 2;

1243 
i
=0; i<
Ën
; i++){

1244 
de¡
[
i
] = 
	`š_Ë32
((
ch
->
»gs
+
off£t
));

1245 
off£t
 += 4;

1247 
	}
}

1249 
	$tw5864_pci_io_ch_wr™e32
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, u32 
v®ue
)

1251 
	`out_Ë32
((
ch
->
»gs
+
off£t
), 
v®ue
);

1252 
	}
}

1254 
	$tw5864_pci_io_ch_wr™e16
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
u16
 
v®ue
)

1256 
	`out_Ë16
((
ch
->
»gs
+
off£t
), 
v®ue
);

1257 
	}
}

1259 
	$tw5864_pci_io_ch_wr™e8
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
u8
 
v®ue
)

1261 
	`out_8
((
ch
->
»gs
+
off£t
), 
v®ue
);

1262 
	}
}

1264 
	$tw5864_pci_io_ch_wr™e_block
(
dvm_ch_t
 *
ch
, 
u32
 
off£t
, 
Ën
, u32 *
¤c
)

1266 
i
;

1267 
Ën
 += 3;

1268 
Ën
 >>= 2;

1269 
i
=0; i<
Ën
; i++){

1270 
	`out_Ë32
((
ch
->
»gs
+
off£t
), 
¤c
[
i
]);

1271 
off£t
 += 4;

1273 
	}
}

1275 
ch_io_İ”©iÚ
 
	gtw5864_pci_io
 = {

1276 .
ch_»ad32
 = 
tw5864_pci_io_ch_»ad32
,

1277 .
	gch_»ad16
 = 
tw5864_pci_io_ch_»ad16
,

1278 .
	gch_»ad8
 = 
tw5864_pci_io_ch_»ad8
,

1279 .
	gch_»ad_block
 = 
tw5864_pci_io_ch_»ad_block
,

1280 .
	gch_wr™e32
 = 
tw5864_pci_io_ch_wr™e32
,

1281 .
	gch_wr™e16
 = 
tw5864_pci_io_ch_wr™e16
,

1282 .
	gch_wr™e8
 = 
tw5864_pci_io_ch_wr™e8
,

1283 .
	gch_wr™e_block
 = 
tw5864_pci_io_ch_wr™e_block
,

1287 
	$ch_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

1288 
couÁ
, *
eof
, *
d©a
)

1290 
Ën
 = 0;

1291 
u32
 
i
;

1293 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
d©a
;

1295 
Ën
 +ğ
	`¥rštf
(
·ge
, "bud DATE: %s, TIME: %s\n", 
__DATE__
, 
__TIME__
);

1296 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "deviû‚am\"%s\"\n", 
ch
->
Çme
);

1298 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "\n");

1299 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s\n",

1301 
i
 = 0; i < 
CHIP_IRQS_NR
; i++)

1303 
ch_œq_desc
 *
desc
 = 
	`ch_œq_to_desc
(
ch
, 
i
);

1304 if(
desc
 && desc->
aùiÚ
.
hªdËr
){

1305 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d %8s %8u %8u %8d\n",

1306 
desc
->
œq
, desc->
Çme
, desc->
œq_couÁ
,

1307 
desc
->
œqs_unhªdËd
, 
	`©omic_»ad
(&desc->
d•th
));

1311  
Ën
;

1312 
	}
}

1314 
	$ch_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

1315 
couÁ
, *
d©a_¬g
)

1317 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
d©a_¬g
;

1318 
cmdbuf
[1024];

1319 **
¬gv
;

1320 
¬gc
, 
i
;

1321 
u32
 
v®
 = 0;

1323 if(!
ch
){

1324 
	`TW_DBG
(
TW_DBG_INFO
, "internalƒrror!\n");

1327 if(
couÁ
 > 1024){

1328 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 1024);

1331 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 
couÁ
);

1333 
¬gv
 = 
	`¬gv_¥l™
(
GFP_KERNEL
, 
cmdbuf
, &
¬gc
);

1334 
i
 = 0; i < (
¬gc
 - 1); i++)

1336 
	`TW_DBG
(
TW_DBG_INFO
, "cmd %d: %s\n", 
i
, 
¬gv
[i]);

1338 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "burst") == 0))

1340 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x18004, 0x7c000000);

1341 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
) | 0x2;

1342 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 
v®
);

1344 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "single") == 0))

1346 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x18004, 0x7c000000);

1347 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, ch->io_İ->
	`ch_»ad32
(chip, ENABLE_VLC_LOOKUP_TABLE) | 0x2);

1349 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "h264_burst") == 0))

1351 
ch
->
io_İ
->
	`ch_wr™e32
(ch,
MODE
, 
DDRON
);

1352 1)
	`tw5864_vlc_œq_hªdËr
(0, 
ch
);

1355 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "poweroff") == 0)){

1356 
	`pci_i2c_wr™e
(
ch
, 0x50, 0xce, 0x3f);

1357 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xce, 0x3f);

1358 
	`pci_i2c_wr™e
(
ch
, 0x54, 0xce, 0x3f);

1359 
	`pci_i2c_wr™e
(
ch
, 0x56, 0xce, 0x3f);

1361 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "poweron") == 0)){

1362 
	`pci_i2c_wr™e
(
ch
, 0x50, 0xce, 0x00);

1363 
	`pci_i2c_wr™e
(
ch
, 0x52, 0xce, 0x00);

1364 
	`pci_i2c_wr™e
(
ch
, 0x54, 0xce, 0x00);

1365 
	`pci_i2c_wr™e
(
ch
, 0x56, 0xce, 0x00);

1367 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "mpb_read") == 0)){

1368 
	`´štk
("\Ä—d 0x%08x =ğ>0x%08x\n", 
	`©oi
(
¬gv
[1]), 
	`mpb_»ad
(
ch
,‡toi(argv[1])));

1370 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "mpb_write") == 0)){

1371 
	`mpb_wr™e
(
ch
, 
	`©oi
(
¬gv
[1]),‡toi(argv[2]));

1372 
	`´štk
("\nwr™0x%08x =ğ>0x%08x\n", 
	`©oi
(
¬gv
[1]),‡toi(argv[2]));

1374 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "i2c_read") == 0)){

1375 
u8
 
‹mp
 = 0;

1376 
	`pci_i2c_»ad
(
ch
, 
	`©oi
(
¬gv
[1]),‡toi×rgv[2]), &
‹mp
);

1377 
	`´štk
("\Ä—d 0x%08x, 0x%08x =ğ>0x%x\n", 
	`©oi
(
¬gv
[1]),‡toi×rgv[2]), 
‹mp
);

1379 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "i2c_write") == 0)){

1380 
	`pci_i2c_wr™e
(
ch
, 
	`©oi
(
¬gv
[1]),‡toi(argv[2]),‡toi(argv[3]));

1381 
	`´štk
("\nwr™0x%08x, 0x%08x =ğ>0x%08x\n", 
	`©oi
(
¬gv
[1]),‡toi(argv[2]),‡toi(argv[3]));

1383 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
×rgv[0], "dump"è=ğ0è&& (
¬gc
 > 4)){

1384 
fe
 *
mem_fe
;

1385 
mm_£gm’t_t
 
fs
;

1386 
ab_sw™ch
 = 0;

1387 
u32
 
ddr_¡¬t
, 
size
, 
·ge_id
, 
off£t
, 
·ge_út
, 
Ën
;

1388 *
buff
, *
‹mp_buf
, *
p_buff
;

1389 if((
¬gv
[1][0] == 'A') || (argv[1][0] == 'a')){

1390 
ab_sw™ch
 = 0;

1392 
ab_sw™ch
 = 1;

1394 
‹mp_buf
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(0x80000));

1395 
p_buff
 = 
‹mp_buf
;

1396 
ddr_¡¬t
 = 
	`©oi
(
¬gv
[2]);

1397 
size
 = 
	`©oi
(
¬gv
[3]);

1398 
·ge_id
 = (
ddr_¡¬t
>>19) & 0xff;

1399 
off£t
 = 
ddr_¡¬t
 & 0x0007ffff;

1400 
·ge_út
 = (
size
 / 0x80000);

1401 
	`´štk
("§vdd¸%s: begš 0x%08x siz0x%08x , s¹…agid %d off£ˆ0x%08x...\n", 
ab_sw™ch
?"B":"A", 
ddr_¡¬t
, 
size
, 
·ge_id
, 
off£t
);

1402 
mem_fe
 = 
	`tw_k”Ãl_fe_İ’
(
¬gv
[4]);

1403 
fs
=
	`g‘_fs
();

1404 
	`£t_fs
(
KERNEL_DS
);

1406 
p_buff
 = 
‹mp_buf
;

1407 
‹mp_Ën
 = 0x0;

1408 
‹mp_Ën
 < 0x80000) {

1409 *(
u32
 *)
p_buff
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
‹mp_Ën
);

1410 #ifdeà
POWERPC_PLATFORM


1411 *(
u32
 *)
p_buff
 = 
	`š_Ë32
(p_buff);

1413 
p_buff
 += ();

1414 
‹mp_Ën
 += ();

1416 
mem_fe
->
f_İ
->
	`wr™e
(mem_fe, 
‹mp_buf
, 0x80000, &(mem_fe->
f_pos
));

1419 
i
 = 0; i < 
·ge_út
; i++){

1421 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x30, (
ab_sw™ch
 << 14è| (
·ge_id
 + 
i
));

1422 if(
i
 == 0){

1423 
buff
 = 
ch
->
»gs
 + 0x80000 + 
off£t
;

1424 
Ën
 = 0x80000 - 
off£t
;

1426 
buff
 = 
ch
->
»gs
 + 0x80000;

1427 
Ën
 = 0x80000;

1429 
	`´štk
("--->wr™siz%08x\n", 
Ën
);

1431 
mem_fe
->
f_İ
->
	`wr™e
(mem_fe, 
buff
, 
Ën
, &(mem_fe->
f_pos
));

1433 
Ën
 = (
size
 % 0x80000);

1434 if(
Ën
){

1435 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x30, (
ab_sw™ch
 << 14è| (
·ge_id
 + 
i
));

1436 if(
·ge_út
 == 0){

1437 
buff
 = 
ch
->
»gs
 + 0x80000 + 
off£t
;

1439 
buff
 = 
ch
->
»gs
 + 0x80000;

1441 
	`´štk
("--->wr™siz%08x\n", 
Ën
);

1443 
mem_fe
->
f_İ
->
	`wr™e
(mem_fe, 
buff
, 
Ën
, &(mem_fe->
f_pos
));

1446 
	`£t_fs
(
fs
);

1447 
	`tw_k”Ãl_fe_şo£
(
mem_fe
);

1448 
	`ä“_·ges
(()
‹mp_buf
, 
	`g‘_Üd”
(0x80000));

1451 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "ddr_test") == 0))

1453 
u32
 
p
;

1454 
j
 = 0;

1455 
d©a
 = 0;

1456 
u32
 *
dma_phy
, *
dma_vœ
;

1457 
çed
 = 0, 
”rÜ
 = 0;

1458 
‹¡_æags
 = 0;

1459 
»Œy_út
 = 0;

1460 
·ge_id
 = 0, 
ab_sw™ch
 = 0;

1461 
	#DDR_PIO
 0x0001

	)

1462 
	#DDR_BURST
 0x0002

	)

1463 
	#SRAM_PIO
 0x0004

	)

1464 
	#SRAM_BURST
 0x0008

	)

1467 
i
 = 2; i < 
¬gc
; i++){

1468 if(
	`¡rcmp
(
¬gv
[
i
], "ddr_pio") == 0){

1469 
‹¡_æags
 |ğ
DDR_PIO
;

1471 if(
	`¡rcmp
(
¬gv
[
i
], "ddr_burst") == 0){

1472 
‹¡_æags
 |ğ
DDR_BURST
;

1474 if(
	`¡rcmp
(
¬gv
[
i
], "sram_pio") == 0){

1475 
‹¡_æags
 |ğ
SRAM_PIO
;

1477 if(
	`¡rcmp
(
¬gv
[
i
], "sram_burst") == 0){

1478 
‹¡_æags
 |ğ
SRAM_BURST
;

1482 
i
 = 0;

1484 if(
i
 == 200000) {

1485 
	`´štk
("\b/");

1487 if(
i
 == 400000) {

1488 
	`´štk
("\b-");

1490 if(
i
 == 600000) {

1491 
	`´štk
("\b\\");

1492 
	`scheduË
();

1493 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1494  
couÁ
;

1496 
i
 = 0;

1498 
i
++;

1499 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x9004, ch->io_İ->
	`ch_»ad32
(chip, 0x9004));

1502 
»Œy_út
 = 
	`©oi
(
¬gv
[1]);

1503 
	`´štk
("--->0x%08x<---»Œy %d\n", 
‹¡_æags
, 
»Œy_út
);

1504 
dma_vœ
 = (
u32
 *)
	`__g‘_ä“_·ge
(
GFP_KERNEL
);

1505 if(!
dma_vœ
)

1507 
	`´štk
("no memory!\n");

1508 
ch_wr™e_’d
;

1510 
dma_phy
 = (
u32
 *)
	`vœt_to_phys
(
dma_vœ
);

1511 
	`´štk
("dm¨phy‡dd»ss: 0x%8p\n", 
dma_phy
);

1512 
	`mem£t
(
dma_vœ
, 0, 
PAGE_SIZE
);

1516 if(
·ge_id
 == 128) {

1517 
·ge_id
 = 0;

1518 
ab_sw™ch
 = !ab_switch;

1523 
p
 = 0x80000;

1524 
d©a
 = 0x55aa55aa;

1525 
i
 = 0; i < 0x20000; i++, 
p
 += 4) {

1526 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
p
, 
d©a
);

1527 
d©a
 = ~data;

1529 
p
 = 0x80000;

1530 
d©a
 = 0x55aa55aa;

1531 
i
 = 0; i < 0x20000; i++, 
p
 += 4) {

1532 
ÏbË_0
:

1533 
çed
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
p
);

1534 if(
d©a
 !ğ
çed
) {

1535 
	`´štk
("·g%3d‡dd¸0x%08x ===>0x%08x, 0x%08x\n", 
·ge_id
, 
p
 - 0x80000, 
d©a
, 
çed
);

1536 
”rÜ
 = 1;

1537  
couÁ
;

1540 
d©a
 = ~data;

1541 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1542  
couÁ
;

1545 
j
 = 
d©a
;

1546 
	`scheduË
();

1547 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1548  
couÁ
;

1553 
p
 = 0x80000;

1554 
d©a
 = 0x0;

1555 
i
 = 0; i < 0x20000; i++, 
p
 +ğ4, 
d©a
 += 4) {

1556 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
p
, 
d©a
);

1558 
p
 = 0x80000;

1559 
d©a
 = 0x0;

1560 
i
 = 0; i < 0x20000; i++, 
p
 +ğ4, 
d©a
 += 4) {

1561 
ÏbË_1
:

1562 
çed
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
p
);

1563 if(
d©a
 !ğ
çed
) {

1564 
	`´štk
("·g%3d‡dd¸0x%08x ===>0x%08x, 0x%08x\n", 
·ge_id
, 
p
 - 0x80000, 
d©a
, 
çed
);

1565 
”rÜ
 = 1;

1567  
couÁ
;

1569 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1570  
couÁ
;

1573 
j
 = 
d©a
;

1574 
	`scheduË
();

1575 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

1576  
couÁ
;

1580 if(
‹¡_æags
 & 
DDR_BURST
) {

1581 
út
, 
timeout
, 
p
;

1583 
út
 = 0; cnt < 256; cnt++) {

1585 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x18004, 0x0);

1586 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x101c, 0x0);

1587 #ifdeà
POWERPC_PCI_PLATFORM


1588 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, (0x8000|(
ab_sw™ch
<<14)è| 
·ge_id
);

1590 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, ((
ab_sw™ch
<<14)è| 
·ge_id
);

1592 
timeout
 = 20;

1593 
p
 = 0x84000;

1594 
d©a
 = 0x0;

1595 
j
 = 0; j < 0x800; j += 4){

1596 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
p
 + 
j
, 
d©a
);

1597 
d©a
 = ~data;

1600 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x80004, (
·ge_id
 * 0x80000 + 
út
 * 0x800));

1602 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80008, 0);

1604 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80000, (1 << 17) | (1 << 16) | 0x800);

1606 
	`md–ay
(1);

1607 }(!(
ch
->
io_İ
->
	`ch_»ad32
(ch, 0x80000)è& (1 << 24)è&& (--
timeout
));

1608 if(!
timeout
){

1609 
	`´štk
("burst writeimeout\n");

1612 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80000, (1<<24));

1615 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x18004, 0x1c000000);

1616 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x101c, 0x2);

1619 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 0x80004, (
·ge_id
 * 0x80000 + 
út
 * 0x800));

1621 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80008, 0);

1623 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80000, (1 << 17) | 0x800);

1624 
timeout
 = 20;

1626 
	`md–ay
(1);

1627 }(!(
ch
->
io_İ
->
	`ch_»ad32
(ch, 0x80000è& (1 << 24))è&& --
timeout
);

1628 if(!
timeout
){

1629 
	`´štk
("bur¡„—dimeout, 0x%04x\n", 
ch
->
io_İ
->
	`ch_»ad32
(chip, 0x80000));

1632 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x80000, (1<<24));

1635 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x18004, 0x1c000000);

1636 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x101c, 0x2);

1639 #ifdeà
POWERPC_PCI_PLATFORM


1640 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, (0x8000|(
ab_sw™ch
<<14è| (1<<13)è| 
·ge_id
);

1642 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, ((
ab_sw™ch
<<14è| (1<<13)è| 
·ge_id
);

1644 
	`åga_dma_»ûive
(
ch
->
·_»gs
 + 0x84000, 
dma_phy
, 0x800);

1646 
d©a
 = 0x0;

1647 
j
 = 0; j < 0x200; j++)

1649 
v®
 = 
	`__¿w_»adl
(
dma_vœ
 + 
j
);

1650 if(
v®
 !ğ
d©a
){

1651 
	`´štk
("·g%d, cÁ %d!‡dd¸0x%08x 0x%08x <===> 0x%08x\n", 
·ge_id
, 
út
, (Õage_id<<19è+ (út<<11è+ (
j
<<2)), 
v®
, 
d©a
);

1652 
çed
 = 1;

1653 
”rÜ
 = 1;

1656 
d©a
 = ~data;

1661 
·ge_id
++;

1662 
	`´štk
("% ·g%3d %s\n", 
ab_sw™ch
?"DDRB":"DDRA", 
·ge_id
, 
”rÜ
?"FAILED":"OK");

1663 
”rÜ
 = 0;

1666 
	`ä“_·ge
(()
dma_vœ
);

1667 }if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "ddr_parse") == 0))

1668 
ch_wr™e_’d
:

1669 
	`¬gv_ä“
(
¬gv
);

1671  
couÁ
;

1672 
	}
}

1680 
	$»gi¡”_®l_tc_deviû
(
dvm_ch_t
 *
ch
)

1682 
»t
 = -1;

1684 if(!
ch
)

1685  
»t
;

1688 
	`tw_ch_ai_š™
(
ch
);

1689 
	`tw_ch_vi_š™
(
ch
);

1690 
	`tw_audio_’_š™
(
ch
->
audio_chª_driv”
);

1691 
	`tw_audio_de_š™
(&
ch
->
audio_chª_driv”
[17]);

1692 
	`tw_j³g_’_š™
(
ch
->
j³g_’code_chª
);

1693 
	`tw_videoh264_’_š™
(
ch
->
h264_ma¡”_’code_logic_chª
);

1694 
	`tw_videoh264s_’_š™
(
ch
->
h264_sub_’code_logic_chª
);

1695 
	}
}

1697 
	$tw5864_uÄegi¡”_®l_tc_deviûs
(
dvm_ch_t
 *
ch
)

1699 
	`tw_ch_vi_»move
();

1700 
	`tw_ch_ai_»move
();

1701 
	`tw_audio_’_»move
();

1702 
	`tw_audio_de_»move
();

1703 
	`tw_j³g_’_»move
();

1704 
	`tw_videoh264_’_»move
(
ch
);

1705 
	`tw_videoh264s_’_»move
(
ch
);

1706 
	}
}

1709 
	$»gi¡”_®l_tc_driv”
(
dvm_ch_t
 *
ch
)

1711 
»t
 = -1;

1713 if(
	`tw5864_ch_ai_driv”_š™
(
ch
))

1714  
»t
;

1715 if(
	`tw5864_ch_vi_driv”_š™
(
ch
))

1716 
”r1
;

1717 if(
	`tw5864_audio_’_driv”_š™
(
ch
))

1718 
”r2
;

1719 if(
	`tw5864_audio_de_driv”_š™
(
ch
))

1720 
”r3
;

1721 if(
	`tw5864_video_’_driv”_š™
(
ch
))

1722 
”r4
;

1723 if(
	`tw5864_videosub_’_driv”_š™
(
ch
))

1724 
”r5
;

1725 if(
	`tw5864_j³g_’_driv”_š™
(
ch
))

1726 
”r6
;

1730 
”r6
:

1731 
	`tw5864_videosub_’_driv”_»move
();

1732 
”r5
:

1733 
	`tw5864_video_’_driv”_»move
();

1734 
”r4
:

1735 
	`tw5864_audio_de_driv”_»move
();

1736 
”r3
:

1737 
	`tw5864_audio_’_driv”_»move
();

1738 
”r2
:

1739 
	`tw5864_ch_vi_driv”_»move
();

1740 
”r1
:

1741 
	`tw5864_ch_ai_driv”_»move
();

1744 
	}
}

1746 
	$uÄegi¡”_®l_tc_driv”
()

1748 
	`tw5864_ch_ai_driv”_»move
();

1749 
	`tw5864_ch_vi_driv”_»move
();

1750 
	`tw5864_audio_de_driv”_»move
();

1751 
	`tw5864_audio_’_driv”_»move
();

1752 
	`tw5864_video_’_driv”_»move
();

1753 
	`tw5864_videosub_’_driv”_»move
();

1754 
	`tw5864_j³g_’_driv”_»move
();

1755 
	}
}

1760 
	$tw5864_ch_»move
(
tw_ch_deviû
 * 
tcd
)

1762 
dvm_ch_t
 *
ch
 = 
	`tcd_´iv
(
tcd
);

1764 if(
ch
 =ğ
NULL
){

1768 
	`´štk
("&&&&&&&&&&&„emove ...\n");

1771 if(
ch
->
ch_£t_šv®id
){

1772 
ch
->
	`ch_£t_šv®id
(chip);

1773 
ch
->
ch_£t_šv®id
 = 
NULL
;

1775 if(
ch
->
uÄegi¡”_cu¼_h264_’code_chª
){

1776 
ch
->
	`uÄegi¡”_cu¼_h264_’code_chª
(ch, ch->
cu¼_h264_’code_chª
);

1777 
ch
->
uÄegi¡”_cu¼_h264_’code_chª
 = 
NULL
;

1780 
	`»move_tw5864_š‹¼u±_cÚŒŞ
(&
ch
->
tw5864_št_cÚŒŞ
, chip);

1781 if(
ch
->
»gs
 !ğ
NULL
){

1782 
	`iounm­
(
ch
->
»gs
);

1783 
ch
->
»gs
=
NULL
;

1785 if(
ch
->
»sourû
 !ğ
NULL
){

1786 
	`»Ëa£_»sourû
(
ch
->
»sourû
);

1787 
	`kä“
(
ch
->
»sourû
);

1788 
ch
->
»sourû
 = 
NULL
;

1790 if(
ch
->
sync_»gs
 !ğ
NULL
){

1791 
	`iounm­
(
ch
->
sync_»gs
);

1792 
ch
->
sync_»gs
 = 
NULL
;

1794 if(
ch
->
sync_»sourû
 !ğ
NULL
){

1795 
	`»Ëa£_»sourû
(
ch
->
sync_»sourû
);

1796 
	`kä“
(
ch
->
sync_»sourû
);

1797 
ch
->
sync_»sourû
 = 
NULL
;

1801 
	`»move_ch_bus
(&
ch
->
tw5864_ch_bus
, ch->
bus_id
);

1803 
	`tw_moduË_uÄegi¡”
(
ch
, &ch->
ch_´oc
);

1804 
	`´štk
("befÜtw5864_ch_ex™cd[0x%p]\n",
tcd
);

1805 
	`tc_ch_ex™
(
tcd
);

1806 
	`´štk
("beforec_chip_dev_free\n");

1807 
	`tc_chdev_ä“
(
tcd
);

1808 
	`´štk
("afterc_chip_dev_free\n");

1810 
	}
}

1812 
pci_š™_ad
(
dvm_ch_t
 *);

1813 
	gsys_şk
 = 0;

1814 
moduË_·¿m
(
sys_şk
, , 
S_IRUGO
);

1816 
	$tw5864_ch_š™
(
bus_id
, 
ch_id
)

1818 
dvm_ch_t
 *
ch
;

1820 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

1821 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_logic_chª
;

1822 
tw_h264_logic_’code_chª_t
 *
h264_sub_’code_logic_chª
;

1823 #ifdeà 
MJPEG_MODULE


1824 
tw_j³g_logic_’code_chª_t
 *
j³g_’code_chª
;

1826 
tw_audio_driv”_t
 *
audio_’code_driv”
, *
audio_decode_driv”
;

1828 
tw_´oc_»gi¡”_s
 *
ch_´oc
;

1829 
i
, 
deviû_id
, 
»t
 = 0;

1830 
tw_ch_deviû
 * 
ticd
;

1831 
cmd_¬g
 
d©a
;

1832 
tw_ch_deviû
 *
tcd
;

1834 
tcd
 = 
	`tc_chdev_®loc
((*
ch
));

1835 if(!
tcd
){

1836 
»t
 = -
ENOMEM
;

1837  
»t
;

1839 
ch
 = 
	`tcd_´iv
(
tcd
);

1840 
	`´štk
("-----&&&------>% tcd[0x%p],ch[0x%p]\n",
__FUNCTION__
,
tcd
,
ch
);

1842 if(
	`tc_ch_š™
(
tcd
,
bus_id
,
ch_id
)){

1843 
	`´štk
("tw5864_chip_init failed!\n");

1844 
	`tc_ch_ex™
(
tcd
);

1845 
	`tc_chdev_ä“
(
tcd
);

1846 
»t
 = -
EINVAL
;

1847  
»t
;

1851 
	`¥rštf
(
ch
->
Çme
, "dvm_ch_%d_%d", 
bus_id
, 
ch_id
);

1852 
ch
->
bus_id
 = bus_id;

1853 
ch
->
ch_id
 = chip_id;

1854 #ifdeà
TW5864_ASIC_NEW


1855 
sys_şk
 = 185;

1857 if(
sys_şk
 == 0) {

1858 
	`´štk
("deçuÉ sys_şk = %dM\n", 
DEFAULT_SYS_CLK
);

1859 
ch
->
sys_şock
 = 
DEFAULT_SYS_CLK
;

1861 
ch
->
sys_şock
 = 
sys_şk
;

1863 
	`©omic_£t
(&
ch
->
İ’_chª_numb”
, 0);

1864 
ch
->
video_’code_ÿp
 = &
¶©fÜm_video_’code_ÿp
[ch->
ch_id
];

1865 
video_’code_ÿp
 = 
ch
->video_encode_cap;

1866 
ch
->
fœ¡_deviû_id
 = 
video_’code_ÿp
->
fœ¡_deviû_numb”
;

1868 if(
video_’code_ÿp
->
åga_async_£ùiÚ_Ën
 != 0){

1869 
ch
->
»sourû
 = 
	`»que¡_mem_»giÚ
(
video_’code_ÿp
->
åga_async_ba£_addr
, video_’code_ÿp->
åga_async_£ùiÚ_Ën
, ch->
Çme
);

1870 if(
ch
->
»sourû
 =ğ
NULL
){

1871 
	`´štk
("requeset mem„egionsƒrr\n");

1872 
»Ëa£
;

1874 
ch
->
»gs
 = 
	`iÜem­_noÿche
(
video_’code_ÿp
->
åga_async_ba£_addr
, video_’code_ÿp->
åga_async_£ùiÚ_Ën
);

1875 
ch
->
·_»gs
 = 
video_’code_ÿp
->
åga_async_ba£_addr
;

1877 
ch
->
»gs
 = 
NULL
;

1878 
ch
->
·_»gs
 = 0;

1880 if(
video_’code_ÿp
->
åga_sync_£ùiÚ_Ën
 != 0){

1881 
ch
->
sync_»sourû
 = 
	`»que¡_mem_»giÚ
(
video_’code_ÿp
->
åga_sync_ba£_addr
, video_’code_ÿp->
åga_sync_£ùiÚ_Ën
, ch->
Çme
);

1882 if(
ch
->
sync_»sourû
 =ğ
NULL
){

1883 
	`´štk
("requeset mem„egionsƒrr\n");

1884 
»Ëa£
;

1886 
ch
->
sync_»gs
 = 
	`iÜem­_noÿche
(
video_’code_ÿp
->
åga_sync_ba£_addr
, video_’code_ÿp->
åga_sync_£ùiÚ_Ën
);

1887 
ch
->
·_sync_»gs
 = 
video_’code_ÿp
->
åga_sync_ba£_addr
;

1889 
ch
->
sync_»gs
 = 
NULL
;

1890 
ch
->
·_sync_»gs
 = 0;

1893 
ch
->
ch_İ’
 = 
ch_h¬dw¬e_»sourû_İ’
;

1894 
ch
->
ch_şo£
 = 
ch_h¬dw¬e_»sourû_şo£
;

1895 
ch
->
ch_£t_šv®id
 = 
ch_phy_šv®id
;

1896 
ch
->
ch_£t_v®id
 = 
ch_phy_v®id
;

1897 
ch
->
ch_»£t
 = 
ch_phy_»£t
;

1898 #ifdeà
ARM_PLATFORM


1899 
ch
->
io_İ
 = &
tw5864_ho¡_io
;

1901 #ifdeà
POWERPC_PLATFORM


1902 #ifdeà
POWERPC_PCI_PLATFORM


1903 
ch
->
io_İ
 = &
tw5864_pci_io
;

1907 
ch
->
	`ch_£t_šv®id
(chip);

1908 #ifdeà
POWERPC_PLATFORM


1909 #ifdeà
POWERPC_PCI_PLATFORM


1911 #iâdeà
USER_FILE_IO_REQ


1912 
	`pci_š™_ad
(
ch
);

1916 
ch
->
»gi¡”_tim”
 = 
»gi¡”_Ú_ch_tim”
;

1917 
ch
->
’abË_tim”
 = 
’abË_Ú_ch_tim”
;

1918 
ch
->
di§bË_tim”
 = 
di§bË_Ú_ch_tim”
;

1919 
ch
->
uÄegi¡”_tim”
 = 
uÄegi¡”_Ú_ch_tim”
;

1921 
ch
->
ch_pŞlšg_timeid
 = 
INVALIDTIMERID
;

1922 
ch
->
add_ch_pŞlšg_sk
 =‡dd_chip_polling_task;

1923 
ch
->
d–‘e_ch_pŞlšg_sk
 = delete_chip_polling_task;

1925 
ch_´oc
 = &
ch
->chip_proc;

1926 
ch_´oc
->
’Œy
 = 
NULL
;

1927 if(!
ch_´oc
->
’Œy
) {

1928 
	`¡rıy
(
ch_´oc
->
Çme
, "chip");

1929 
ch_´oc
->
»ad
 = 
ch_´oc_»ad
;

1930 
ch_´oc
->
wr™e
 = 
ch_´oc_wr™e
;

1931 
ch_´oc
->
´iv©e
 = 
ch
;

1932 
	`tw_moduË_»gi¡”
(
ch
, 
ch_´oc
);

1935 
	`š™_ch_bus
(&
ch
->
tw5864_ch_bus
, ch->
bus_id
, ch->
ch_id
);

1936 
	`š™_d´am_cÚŒŞ
(&
ch
->
ch_d´am_cÚŒŞËr
, chip);

1937 if(
	`š™_tw5864_š‹¼u±_cÚŒŞ
(&
ch
->
tw5864_št_cÚŒŞ
, chè!ğ
TW_OK
){

1938 
	`TW_DBG
(
TW_DBG_FATAL
, "irq controler init failed\n");

1939 
»Ëa£
;

1941 
»t
 = 
	`tw5864_ch_driv”_š™
();

1942 if(
»t
 !ğ
TW_OK
){

1943 
	`´štk
("chip driver„egister failed!\n");

1944 
»Ëa£
;

1947 
	`š™_ch_’code_chª_£rviû_queue
(&
ch
->
ch_’code_£rviû_queue
);

1948 
h264_ma¡”_’code_logic_chª
 = 
ch
->h264_master_encode_logic_chan;

1949 
h264_sub_’code_logic_chª
 = 
ch
->h264_sub_encode_logic_chan;

1950 
audio_’code_driv”
 = 
ch
->
audio_chª_driv”
;

1951 #ifdeà 
MJPEG_MODULE


1952 
j³g_’code_chª
 = 
ch
->jpeg_encode_chan;

1955 
deviû_id
 = 
ch
->
fœ¡_deviû_id
;

1958 
	`»gi¡”_®l_tc_deviû
(
ch
);

1959 if(
	`»gi¡”_®l_tc_driv”
(
ch
))

1960 
fix
;

1962 
	`dbg
("j³g dev ba£ <0x%08X> \n",
j³g_’code_chª
);

1964 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++){

1966 
h264_ma¡”_’code_logic_chª
++;

1967 
h264_sub_’code_logic_chª
++;

1968 
audio_’code_driv”
++;

1969 #ifdeà 
MJPEG_MODULE


1970 
j³g_’code_chª
++;

1973 
audio_’code_driv”
 = &
ch
->
audio_chª_driv”
[
TW_AUDIO_IN_SPEAKER_ID
];

1974 
audio_decode_driv”
 = &
ch
->
audio_chª_driv”
[
TW_AUDIO_OUT_SPEAKER_ID
];

1979 
d©a
.
ty³
 = 5;

1980 
d©a
.
chªÃl_idx
 = 0;

1981 
d©a
.
®gÜ™hm
 = 0;

1982 
d©a
.
¡»am
 = 0;

1983 if(
	`ü—‹_£rviû_deviû
(
tcd
,&
d©a
))

1984 
”r
;

1985 
d©a
.
ty³
 = 3;

1986 if(
	`ü—‹_£rviû_deviû
(
tcd
,&
d©a
))

1987 
”r
;

1990 
	`¥š_lock_š™
(&
ch
->
lock
);

1991 
ch
->
vlc_pšg_pÚg_šdex
 = 0;

1992 
ch
->
cu¼_h264_’code_chª
 = 
NULL
;

1993 
ch
->
»gi¡”_cu¼_h264_’code_chª
 =„egister_curr_h264_encode_chan;

1994 
ch
->
uÄegi¡”_cu¼_h264_’code_chª
 = unregister_curr_h264_encode_chan;

1995  
TW_OK
;

1997 
”r
:

1998 
	`»Ëa£_®l_£rviû_deviû_ext
();

1999 
	`uÄegi¡”_®l_tc_driv”
();

2000 
fix
:

2001 
	`tw5864_uÄegi¡”_®l_tc_deviûs
(
ch
);

2002 
´e_»Ëa£
:

2003 
	`tw5864_ch_driv”_»move
();

2004 
»Ëa£
:

2005 
	`´štk
("%s_´obç\n", 
ch
->
Çme
);

2006 
	`tw5864_ch_»move
(
tcd
);

2007  
»t
;

2008 
	}
}

2011 #ifdeà
POWERPC_PLATFORM


2012 #ifdeà
POWERPC_PCI_PLATFORM


2013 
__devš™
 
	$tw5864_pci_´obe
(
pci_dev
 *pci_dev, cÚ¡ 
pci_deviû_id
 *
id
)

2015 
¦Ù
, 
bus_id
, 
devâ
, 
i
;

2016 
ty³_bus_t
 *
tw_pci_bus
;

2017 
tw_ch_bus_t
 *
tw5864_ch_bus
;

2018 
dvm_ch_t
 *
ch
;

2019 
u32
 
ch_id
;

2020 
»t
;

2021 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
¶©fÜm_’code_ÿp
;

2023 
bus_id
 = 
pci_dev
->
bus
->
numb”
;

2024 
devâ
 = 
	`PCI_FUNC
(
pci_dev
->devfn);

2025 
¦Ù
 = 
	`PCI_SLOT
(
pci_dev
->
devâ
);

2026 
ch_id
 = 
¦Ù
 - 14;

2030 if((
¦Ù
 != 0x0e) && (slot != 0x0f)) {

2031 
	`´štk
("¦Ù id %dƒ¼Ü, oÆy suµÜˆ¦Ù 14‡nd 15\n", 
¦Ù
);

2032  -
ENOSYS
;

2035 if(
ch_id
 >= 2) {

2036 
	`´štk
("Úly suµÜˆ2 deviû,hi deviû 0x%08x wÈbignÜe\n", 
pci_dev
->
devâ
);

2037  -
EPERM
;

2040 
¶©fÜm_’code_ÿp
 = &
¶©fÜm_video_’code_ÿp
[
ch_id
];

2041 
¶©fÜm_’code_ÿp
->
åga_async_ba£_addr
 = 
	`pci_»sourû_¡¬t
(
pci_dev
, 0);

2042 
¶©fÜm_’code_ÿp
->
åga_async_£ùiÚ_Ën
 = 
	`pci_»sourû_Ën
(
pci_dev
, 0);

2044 
	`TW_DBG
(
TW_DBG_INFO
, "d‘eùw5864…c˜deviû, bu %d, slÙ %d, fÀ%d, irq %d\n", 
bus_id
, 
¦Ù
, 
devâ
, 
pci_dev
->
œq
);

2045 
i
 = 0; i < 
DEVICE_COUNT_RESOURCE
; i++)

2047 if(
pci_dev
->
»sourû
[
i
].
¡¬t
){

2048 
	`TW_DBG
(
TW_DBG_INFO
, "BAR%d %s Addr 0x%08x, Size 0x%08x\n",

2049 
i
, (
pci_dev
->
»sourû
[i].
æags
 & 
IORESOURCE_IO
) ? "I/O":"MEM",

2050 
	`pci_»sourû_¡¬t
(
pci_dev
, 
i
),

2051 
	`pci_»sourû_Ën
(
pci_dev
, 
i
));

2055 if(
	`tw5864_ch_š™
(
TW_ED_PCI_BUS
, 
ch_id
)){

2056 
	`TW_DBG
(
TW_DBG_FATAL
, "init chip failed\n");

2059 
	`g‘_tw_pci_bus
(&
tw_pci_bus
);

2060 
tw_pci_bus
->
İ
->
	`fšd_ch_bus_š_ty³_bus_bË
Ñw_pci_bus, &
tw5864_ch_bus
, 
ch_id
);

2061 if(
tw5864_ch_bus
 !ğ
NULL
){

2062 
ch
 = 
	`to_g‘_ch_w™h_ch_bus
(
tw5864_ch_bus
);

2064 
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
 = 
pci_dev
->
œq
;

2066 
	`£t_œq_ty³
(
pci_dev
->
œq
, 
IRQT_LOW
);

2067 
»t
 = 
	`»que¡_œq
(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
,

2068 
tw5864_tİ_i¤
, 
IRQF_DISABLED
, 
ch
->
Çme
, &ch->
tw5864_št_cÚŒŞ
);

2069 if(
»t
)

2071 
	`TW_DBG
(
TW_DBG_ERR
, "%s,%d:š¡®Èœq faed!, %d\n", 
__FILE__
, 
__LINE__
, 
»t
);

2073  
»t
;

2076 
	`TW_DBG
(
TW_DBG_ERR
, "NØsuch ch %d\n", 
ch_id
);

2079 
	`pci_£t_ma¡”
(
pci_dev
);

2082 
	}
}

2084 
__devex™
 
	$tw5864_pci_»move
(
pci_dev
 *pci_dev)

2086 
ty³_bus_t
 *
tw_pci_bus
;

2087 
tw_ch_bus_t
 *
tw5864_ch_bus
;

2088 
dvm_ch_t
 *
ch
;

2089 
¦Ù
;

2090 
tw_ch_deviû
 *
tcd
;

2092 
¦Ù
 = 
	`PCI_SLOT
(
pci_dev
->
devâ
);

2093 
¦Ù
 -= 14;

2094 
	`g‘_tw_pci_bus
(&
tw_pci_bus
);

2095 
tw_pci_bus
->
İ
->
	`fšd_ch_bus_š_ty³_bus_bË
Ñw_pci_bus, &
tw5864_ch_bus
, 
¦Ù
);

2096 if(
tw5864_ch_bus
 !ğ
NULL
){

2097 
ch
 = 
	`to_g‘_ch_w™h_ch_bus
(
tw5864_ch_bus
);

2098 
	`ä“_œq
(
ch
->
tw5864_št_cÚŒŞ
.
ch_œq
, &chip->tw5864_int_control);

2100 
tcd
 = 
	`´iv_2_tcd
((*)
ch
);

2101 
	`´štk
("tcd = %°\n",
tcd
);

2102 
	`»Ëa£_®l_£rviû_deviû_ext
();

2103 
	`uÄegi¡”_®l_tc_driv”
();

2104 
	`tw5864_uÄegi¡”_®l_tc_deviûs
(
ch
);

2105 
	`tw5864_ch_driv”_»move
();

2106 
	`tw5864_ch_»move
(
tcd
);

2108 
	}
}

2110 
pci_deviû_id
 
	gtw5864_pci_tbl
[] 
	g__š™d©a
 = {

2112 .
v’dÜ
 = 
PCI_VENDOR_ID_TW5864
,

2113 .
	gdeviû
 = 
PCI_DEVICE_ID_TW5864
,

2114 .
	gsubv’dÜ
 = 
PCI_ANY_ID
,

2115 .
	gsubdeviû
 = 
PCI_ANY_ID
,

2116 .
	gşass
 = 0,

2117 .
	gşass_mask
 = 0,

2118 .
	gdriv”_d©a
 = 0,

2121 .
	gv’dÜ
 = 0x10ee,

2122 .
	gdeviû
 = 0x0300,

2123 .
	gsubv’dÜ
 = 
PCI_ANY_ID
,

2124 .
	gsubdeviû
 = 
PCI_ANY_ID
,

2125 .
	gşass
 = 0,

2126 .
	gşass_mask
 = 0,

2127 .
	gdriv”_d©a
 = 0,

2131 
pci_driv”
 
	gtw5864_pci_driv”
 = {

2132 .
Çme
 = "TW5864",

2133 .
	gid_bË
 = 
tw5864_pci_tbl
,

2134 .
	g´obe
 = 
tw5864_pci_´obe
,

2135 .
	g»move
 = 
tw5864_pci_»move
,

2140 
__š™
 
	$tw5864_š™
()

2142 
	`tw_cÜe_š™
();

2146 
	`´oc_moduË_š™
();

2147 
	`š™_tw_roÙ_bus
();

2148 #ifdef 
ARM_PLATFORM


2149 
	`š™_¬m_tim”
();

2151 #ifdeà 
POWERPC_PLATFORM


2152 
	`dvm_m­_š™
();

2154 
	`¡¬t_dvm_kth»ad
();

2155 #ifdeà
POWERPC_PCI_PLATFORM


2156 ià(
	`pci_»gi¡”_driv”
(&
tw5864_pci_driv”
)) {

2157 
	`¡İ_dvm_kth»ad
();

2158 
	`dvm_m­_ex™
();

2159 
	`»move_tw_roÙ_bus
();

2160 
	`´štk
("Faild„egister…ci driver!\n");

2161  -
ENODEV
;

2164 
	`tw5864_ch_š™
(1, 0);

2169 
	}
}

2171 
__ex™
 
	$tw5864_ex™
()

2173 
tw_ch_deviû
 *
tcd
;

2174 #iâdeà
POWERPC_PCI_PLATFORM


2175 
ty³_bus_t
 *
tw_ho¡_bus
;

2176 
tw_ch_bus_t
 *
tw5864_ch_bus
;

2177 
dvm_ch_t
 *
ch
;

2181 #ifdef 
ARM_PLATFORM


2182 
	`şo£_¬m_tim”
();

2184 #ifdeà 
POWERPC_PLATFORM


2185 
	`dvm_m­_ex™
();

2187 #ifdeà
POWERPC_PCI_PLATFORM


2188 
	`pci_uÄegi¡”_driv”
(&
tw5864_pci_driv”
);

2190 
	`g‘_tw_ho¡_bus
(&
tw_ho¡_bus
);

2191 
tw_ho¡_bus
->
İ
->
	`fšd_ch_bus_š_ty³_bus_bË
Ñw_ho¡_bus, &
tw5864_ch_bus
, 0);

2192 if(
tw5864_ch_bus
 !ğ
NULL
){

2193 
ch
 = 
	`to_g‘_ch_w™h_ch_bus
(
tw5864_ch_bus
);

2195 
tcd
 = 
	`´iv_2_tcd
((*)
ch
);

2196 
	`´štk
("tcd = %°\n",
tcd
);

2197 
	`»Ëa£_®l_£rviû_deviû_ext
();

2198 
	`uÄegi¡”_®l_tc_driv”
();

2199 
	`tw5864_uÄegi¡”_®l_tc_deviûs
(
ch
);

2200 
	`tw5864_ch_driv”_»move
();

2201 
	`tw5864_ch_»move
(
tcd
);

2204 
	`¡İ_dvm_kth»ad
();

2206 
	`»move_tw_roÙ_bus
();

2207 
	`´oc_moduË_»Ëa£
();

2209 
	`tw_cÜe_ex™
();

2211 
	}
}

2213 
moduË_š™
(
tw5864_š™
);

2214 
moduË_ex™
(
tw5864_ex™
);

2216 
MODULE_DESCRIPTION
("DVMicro h264 chip driver");

2217 
MODULE_AUTHOR
("tang shang chang,ƒmail:tang.sc@163.com");

2218 
MODULE_LICENSE
("GPL");

	@../../tw5864/tw5864/tw_chip_ai.c

1 
	~<tw5864/dvm_commÚ.h
>

2 
	~<tw5864/tc_commÚ.h
>

5 cÚ¡ 
	gch_h¬dw¬e_§m¶e_256fs
[
TW_AUDIO_RESERVED
][6] = {

14 
	$ch_ai_driv”_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
İ’ed_ed
)

16 
»t
 = 
TW_ERR
;

18 if(
İ’ed_ed
) {

19 
tw_ch_ai_driv”_t
 *
driv”
;

21 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

22 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
)){

24 
TW_ED_UNREGISTER
:

25 
TW_ED_CLOSED
:

26 
İ’ed_ed
->
ed
.
İ
->
	`š™_com¶‘e
(&opened_ed->ed);

27 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 1);

28 
»t
 = 0;

30 
TW_ED_IDLE
:

31 
TW_ED_STANDBY
:

32 
TW_ED_SUSPEND
:

33 
TW_ED_RUNNING
:

34 
»t
 = -
EBUSY
;

35 
	`TW_DBG
(
TW_DBG_ERR
, "chip vi driver have been opened\n");

40  
»t
;

41 
	}
}

43 
	$ch_ai_driv”_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
İ’ed_ed
)

45 
»t
 = 
TW_ERR
;

47 if(
İ’ed_ed
) {

48 
tw_ch_ai_driv”_t
 *
driv”
;

50 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

51 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
)){

53 
TW_ED_UNREGISTER
:

54 
TW_ED_CLOSED
:

55 
»t
 = 0;

56 
	`TW_DBG
(
TW_DBG_INFO
, "chip control have been close\n");

58 
TW_ED_IDLE
:

59 
TW_ED_STANDBY
:

60 
TW_ED_SUSPEND
:

61 
TW_ED_RUNNING
:

62 if(
İ’ed_ed
->
ed
.
İ
 !ğ
NULL
){

63 
	`©omic_£t
(&
İ’ed_ed
->
¡©e
, 
TW_ED_CLOSED
);

64 
İ’ed_ed
->
ed
.
İ
->
	`com¶‘e_dÚe
(&opened_ed->ed);

65 
	`TW_DBG
(
TW_DBG_INFO
, "control complete doen\n");

66 
»t
 = 0;

68 
	`TW_DBG
(
TW_DBG_FATAL
, "control‚ode have‚ot inital!\n");

69 
»t
 = -
EACCES
;

71 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

76  
»t
;

77 
	}
}

79 
	$ch_ai_driv”_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
İ’ed_ed
)

81 if(
İ’ed_ed
) {

82 
tw_ch_ai_driv”_t
 *
driv”
;

84 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

85 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

87 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

93 
	}
}

95 
	$ch_ai_driv”_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
İ’ed_ed
)

97 if(
İ’ed_ed
) {

98 
tw_ch_ai_driv”_t
 *
driv”
;

100 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

101 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

103 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

109 
	}
}

111 
	$ch_ai_driv”_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
İ’ed_ed
, 
cmd
, 
¬g
)

113 
»t
 = 
TW_ERR
;

115 if(
İ’ed_ed
) {

116 
tw_ch_ai_driv”_t
 *
driv”
;

117 
tw_ch_ai_sys
 
ai_sys
, *
sys_p
;

118 
tw_ch_ai_´İ”ty
 
ai_chn_´İ”ty
, *
chn_p
;

119 
AI_CH_VOLUME
 
audio_vŞume
;

121 
sys_p
 = &
ai_sys
;

122 
chn_p
 = &
ai_chn_´İ”ty
;

123 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

125 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

127 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

128  -
EPERM
;

131 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

132 
cmd
) {

133 
TW_AI_SET_AUDIO_SYS_PARM
:

134 
	`cİy_äom_u£r
(
sys_p
, (*)
¬g
, (
tw_ch_ai_sys
));

135 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_CLOCK_MODE
) {

136 
»t
 = 
driv”
->
İ
->
	`£t_şock_mode
(driv”, 
sys_p
->
şock_mode
);

137 if(
»t
) {

140 
»t
 = 
TW_OK
;

142 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_SYNC_MODE
) {

143 
»t
 = 
driv”
->
İ
->
	`£t_sync_mode
(driv”, 
sys_p
->
şock_mode
);

144 if(
»t
) {

147 
»t
 = 
TW_OK
;

149 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_SAMPLE_RATE
) {

150 
»t
 = 
driv”
->
İ
->
	`£t_§m¶e_¿‹
(driv”, 
sys_p
->
şock_mode
);

151 if(
»t
) {

154 
»t
 = 
TW_OK
;

156 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_BITS
) {

157 
»t
 = 
driv”
->
İ
->
	`£t_b™s
(driv”, 
sys_p
->
şock_mode
);

158 if(
»t
) {

161 
»t
 = 
TW_OK
;

164 
TW_AI_GET_AUDIO_SYS_PARM
:

165 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_CLOCK_MODE
) {

166 
sys_p
->
şock_mode
 = 
driv”
->
İ
->
	`g‘_şock_mode
(driver);

168 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_SYNC_MODE
) {

169 
sys_p
->
şock_mode
 = 
driv”
->
İ
->
	`g‘_sync_mode
(driver);

171 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_SAMPLE_RATE
) {

172 
sys_p
->
şock_mode
 = 
driv”
->
İ
->
	`g‘_§m¶e_¿‹
(driver);

174 if(
sys_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_BITS
) {

175 
sys_p
->
şock_mode
 = 
driv”
->
İ
->
	`g‘_b™s
(driver);

177 if(
sys_p
->
chªgemask
) {

178 
	`cİy_to_u£r
((*)
¬g
, 
sys_p
, (
tw_ch_ai_sys
));

180 
»t
 = 
TW_OK
;

182 
TW_AI_SET_AUDIO_GAIN
:

183 
	`cİy_äom_u£r
(&
audio_vŞume
, (*)
¬g
, (
AI_CH_VOLUME
));

184 
chn_p
->
chªgemask
 |ğ
TW_CHIP_AI_CHANGEMASK_GAIN
;

185 
chn_p
->
chªÃl
 = 
audio_vŞume
.
u32ChªÃl
;

186 
chn_p
->
gaš
 = 
audio_vŞume
.
u32VŞume
;

187 if(
chn_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_GAIN
) {

188 
tw_ch_ai_cÚfig_´İ”ty_t
 *
ai_cÚfig
;

189 if(
chn_p
->
chªÃl
 < 
TW_AI_MAX_CHNL
) {

190 
ai_cÚfig
 = &
driv”
->
audio_´İ”ty
[
chn_p
->
chªÃl
];

191 
»t
 = 
ai_cÚfig
->
İ
->
	`£t_gaš
(&ai_cÚfig->
audio_´İ”ty
, 
chn_p
->
gaš
);

192 if(
»t
) {

196 
	`TW_DBG
(
TW_DBG_ERR
, "audiØchªÆnumb” %d ov”æow\n", 
chn_p
->
chªÃl
);

197 
»t
 = -
EINVAL
;

201 
TW_AI_GET_AUDIO_CHN_PARM
:

202 
	`cİy_äom_u£r
(
chn_p
, (*)
¬g
, (
tw_ch_ai_´İ”ty
));

203 if(
chn_p
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_GAIN
) {

204 
tw_ch_ai_cÚfig_´İ”ty_t
 *
ai_cÚfig
;

205 if(
chn_p
->
chªÃl
 < 
TW_AI_MAX_CHNL
) {

206 
ai_cÚfig
 = &
driv”
->
audio_´İ”ty
[
chn_p
->
chªÃl
];

207 
chn_p
->
gaš
 = 
ai_cÚfig
->
İ
->
	`g‘_gaš
(&ai_cÚfig->
audio_´İ”ty
);

208 
	`cİy_to_u£r
((*)
¬g
, 
chn_p
, (
tw_ch_ai_´İ”ty
));

209 
»t
 = 
TW_OK
;

211 
	`TW_DBG
(
TW_DBG_ERR
, "audiØchªÆnumb” %d ov”æow\n", 
chn_p
->
chªÃl
);

212 
»t
 = -
EINVAL
;

217 
»t
 = -
EBADRQC
;

218 
	`TW_DBG
(
TW_DBG_ERR
, "No such command!\n");

223  
»t
;

224 
	}
}

226 
	$ch_ai_driv”_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
İ’ed_ed
)

228 
»t
 = 
TW_ED_UNREGISTER
;

230 if(
İ’ed_ed
 !ğ
NULL
){

231 
»t
 = 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
);

234  
»t
;

235 
	}
}

237 
hcd_š‹rçû_İ”©iÚ
 
	gch_ai_driv”_hcd_š‹rçû_İ
 = {

238 .
İ’
 = 
ch_ai_driv”_hcd_š‹rçû_İ’
,

239 .
	gşo£
 = 
ch_ai_driv”_hcd_š‹rçû_şo£
,

240 .
	gsu¥’d
 = 
ch_ai_driv”_hcd_š‹rçû_su¥’d
,

241 .
	g»sume
 = 
ch_ai_driv”_hcd_š‹rçû_»sume
,

242 .
	gioùl
 = 
ch_ai_driv”_hcd_š‹rçû_ioùl
,

243 .
	gg‘_¡©e
 = 
ch_ai_driv”_hcd_š‹rçû_g‘_¡©e
,

246 
	$tw_ch_ai_´İ”ty_š™
(
tw_ch_ai_´İ”ty_t
 *
´İ”ty
, 
u32
 
chÆ
)

248 
»t
 = 
TW_ERR
;

249 if(
´İ”ty
) {

250 if(
chÆ
 < 
TW_AI_MAX_CHNL
) {

251 
´İ”ty
->
chªÃl
 = 
chÆ
;

252 
´İ”ty
->
gaš
 = 0;

253 
»t
 = 
TW_OK
;

255 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈnumb” %d ov”æow\n", 
chÆ
);

259  
»t
;

260 
	}
}

262 
	$tw_ch_ai_´İ”ty_»£t
(
tw_ch_ai_´İ”ty_t
 *
´İ”ty
)

264 
»t
 = 
TW_ERR
;

265 if(
´İ”ty
) {

266 
´İ”ty
->
gaš
 = 0;

267 
»t
 = 
TW_OK
;

270  
»t
;

271 
	}
}

273 
u32
 
	$tw_ch_ai_´İ”ty_g‘_gaš
(
tw_ch_ai_´İ”ty_t
 *
´İ”ty
)

275 if(
´İ”ty
) {

276  
´İ”ty
->
gaš
;

279  
TW_ERR
;

280 
	}
}

282 
	$tw_ch_ai_´İ”ty_£t_gaš
(
tw_ch_ai_´İ”ty_t
 *
´İ”ty
, 
u32
 
gaš
)

284 if(
´İ”ty
) {

285 if((
gaš
 >ğ
MIN_AI_GAIN
è&& (gaš <ğ
MAX_AI_GAIN
)) {

286 
´İ”ty
->
gaš
 = gain;

287  
TW_OK
;

289 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆgaš faed, [%d, %d]\n", 
MIN_VI_CONTRAST
, 
MAX_VI_CONTRAST
);

290  -
EINVAL
;

292  
TW_ERR
;

293 
	}
}

295 
	$tw_ch_ai_´İ”ty_upd©e
(
tw_ch_ai_´İ”ty_t
 *
´İ”ty
, 
dvm_ch_t
 *
ch
)

297 if(
´İ”ty
 && 
ch
) {

298 if(
´İ”ty
->
chªgemask
 & 
TW_CHIP_AI_CHANGEMASK_GAIN
) {

299 
u32
 
‹mp
;

300 if(
´İ”ty
->
chªÃl
 < 2) {

301 
‹mp
 = 
	`mpb_»ad
(
ch
, 
TW_AI_GAIN_21
);

302 
‹mp
 &ğ~(0xà<< (4 * 
´İ”ty
->
chªÃl
));

303 
‹mp
 |ğ((
´İ”ty
->
gaš
 & 0xfè<< (4 *…rİ”ty->
chªÃl
));

304 
	`mpb_wr™e
(
ch
, 
TW_AI_GAIN_21
, 
‹mp
);

306 
‹mp
 = 
	`mpb_»ad
(
ch
, 
TW_AI_GAIN_43
);

307 
‹mp
 &ğ~(0xà<< (4 * (
´İ”ty
->
chªÃl
 - 2)));

308 
‹mp
 |ğ((
´İ”ty
->
gaš
 & 0xfè<< (4 * (´İ”ty->
chªÃl
 - 2)));

309 
	`mpb_wr™e
(
ch
, 
TW_AI_GAIN_43
, 
‹mp
);

313  
TW_OK
;

316  
TW_ERR
;

317 
	}
}

319 
tw_ch_ai_´İ”ty_İ”©iÚ
 
	gtw_ch_ai_´İ”ty_İ”©iÚ_İ
 = {

320 .
š™
 = 
tw_ch_ai_´İ”ty_š™
,

321 .
	g»£t
 = 
tw_ch_ai_´İ”ty_»£t
,

322 .
	gg‘_gaš
 = 
tw_ch_ai_´İ”ty_g‘_gaš
,

323 .
	g£t_gaš
 = 
tw_ch_ai_´İ”ty_£t_gaš
,

324 .
	gupd©e
 = 
tw_ch_ai_´İ”ty_upd©e
,

327 
	$ch_ai_driv”_š™
(
tw_ch_ai_driv”_t
 *
driv”
)

329 if(
driv”
) {

330 
i
;

331 
tw_ch_ai_cÚfig_´İ”ty_t
 *
audio_´İ”ty
;

332 
ed_tcb_t
 *
ed
;

334 
ed
 = &
driv”
->
İ’ed_ai_ed
;

335 
audio_´İ”ty
 = 
driv”
->audio_property;

336 
ed
->
İ
 = &
ch_ai_driv”_hcd_š‹rçû_İ
;

337 
i
 = 0; i < 
TW_AI_MAX_CHNL
; i++, 
audio_´İ”ty
++) {

338 
audio_´İ”ty
->
İ
 = &
tw_ch_ai_´İ”ty_İ”©iÚ_İ
;

339 
audio_´İ”ty
->
İ
->
	`š™
(&audio_´İ”ty->audio_´İ”ty, 
i
);

342  
TW_OK
;

345  
TW_ERR
;

346 
	}
}

348 
	$ch_ai_driv”_»Ëa£
(
tw_ch_ai_driv”_t
 *
driv”
)

350 if(
driv”
) {

351 
i
;

352 
tw_ch_ai_cÚfig_´İ”ty_t
 *
audio_´İ”ty
;

354 
audio_´İ”ty
 = 
driv”
->audio_property;

355 
i
 = 0; i < 
TW_AI_MAX_CHNL
; i++, 
audio_´İ”ty
++) {

356 
audio_´İ”ty
->
İ
->
	`»£t
(&audio_property->audio_property);

359 
	}
}

361 
	$ch_ai_driv”_»£t
(
tw_ch_ai_driv”_t
 *
driv”
)

363 if(
driv”
) {

364 
dvm_ch_t
 *
ch
;

366 
ch
 = 
driv”
->chip;

368 
	`mpb_wr™e
(
ch
, 0x62, 0x03);

369 
	`mpb_wr™e
(
ch
, 0x6c, 0xe1);

370 
	`mpb_wr™e
(
ch
, 0x6d, 0x00);

371 
	`mpb_wr™e
(
ch
, 0x64, 0x31);

372 
	`mpb_wr™e
(
ch
, 0x65, 0x75);

373 
	`mpb_wr™e
(
ch
, 0x66, 0xb9);

374 
	`mpb_wr™e
(
ch
, 0x67, 0xfd);

375 
	`mpb_wr™e
(
ch
, 0x68, 0x20);

376 
	`mpb_wr™e
(
ch
, 0x69, 0x64);

377 
	`mpb_wr™e
(
ch
, 0x6a, 0xa8);

378 
	`mpb_wr™e
(
ch
, 0x6b, 0xec);

380  
TW_OK
;

383  
TW_ERR
;

384 
	}
}

386 
	$ch_ai_driv”_g‘_şock_mode
(
tw_ch_ai_driv”_t
 *
driv”
)

388 if(
driv”
) {

389  
driv”
->
şock_mode
;

392  
TW_ERR
;

393 
	}
}

395 
	$ch_ai_driv”_£t_şock_mode
(
tw_ch_ai_driv”_t
 *
driv”
, 
AUDIO_CLOCK_MODE
 
şock_mode
)

397 
»t
 = 
TW_ERR
, 
‹mp
;

399 if(
driv”
) {

400 
şock_mode
) {

401 
AUDIO_CLOCK_SLAVE
:

402 
driv”
->
şock_mode
 = clock_mode;

403 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_CLOCK_MODE
);

404 
‹mp
 &= ~(1 << 5);

405 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_CLOCK_MODE
, 
‹mp
);

406 
»t
 = 
TW_OK
;

408 
AUDIO_CLOCK_MASTER
:

409 
driv”
->
şock_mode
 = clock_mode;

410 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_CLOCK_MODE
);

411 
‹mp
 |= (1 << 5);

412 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_CLOCK_MODE
, 
‹mp
);

413 
»t
 = 
TW_OK
;

416 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆşock mod%d\n", 
şock_mode
);

417 
»t
 = -
EINVAL
;

422  
»t
;

423 
	}
}

425 
	$ch_ai_driv”_g‘_sync_mode
(
tw_ch_ai_driv”_t
 *
driv”
)

427 if(
driv”
) {

428  
driv”
->
sync_mode
;

431  
TW_ERR
;

432 
	}
}

434 
	$ch_ai_driv”_£t_sync_mode
(
tw_ch_ai_driv”_t
 *
driv”
, 
AUDIO_SYNC_MODE
 
sync_mode
)

436 
»t
 = 
TW_ERR
, 
‹mp
;

438 if(
driv”
) {

439 
sync_mode
) {

440 
AUDIO_SYNC_MODE_DSP
:

441 
driv”
->
sync_mode
 = sync_mode;

442 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_SYNC_MODE
);

443 
‹mp
 |= (1 << 6);

444 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SYNC_MODE
, 
‹mp
);

445 
»t
 = 
TW_OK
;

447 
AUDIO_SYNC_MODE_I2S
:

448 
driv”
->
sync_mode
 = sync_mode;

449 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_SYNC_MODE
);

450 
‹mp
 &= ~(1 << 6);

451 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SYNC_MODE
, 
‹mp
);

452 
»t
 = 
TW_OK
;

455 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆsynømod%d\n", 
sync_mode
);

456 
»t
 = -
EINVAL
;

461  
TW_ERR
;

462 
	}
}

464 
	$ch_ai_driv”_g‘_§m¶e_¿‹
(
tw_ch_ai_driv”_t
 *
driv”
)

466 if(
driv”
) {

467  
driv”
->
§m¶e_¿‹
;

470  
TW_ERR
;

471 
	}
}

473 
	$ch_ai_driv”_£t_§m¶e_¿‹
(
tw_ch_ai_driv”_t
 *
driv”
, 
TW_AUDIO_SAMPLE_RATE
 
§m¶e_¿‹
)

475 
»t
 = 
TW_ERR
, 
i
;

477 if(
driv”
) {

478 
§m¶e_¿‹
) {

479 
TW_AUDIO_8000
:

480 
driv”
->
§m¶e_¿‹
 = sample_rate;

481 
i
 = 0; i < 6; i++) {

482 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SAMPLE_RATE
 + 
i
, 
ch_h¬dw¬e_§m¶e_256fs
[
§m¶e_¿‹
][i]);

484 
»t
 = 
TW_OK
;

486 
TW_AUDIO_16000
:

487 
driv”
->
§m¶e_¿‹
 = sample_rate;

488 
i
 = 0; i < 6; i++) {

489 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SAMPLE_RATE
 + 
i
, 
ch_h¬dw¬e_§m¶e_256fs
[
§m¶e_¿‹
][i]);

491 
»t
 = 
TW_OK
;

493 
TW_AUDIO_32000
:

494 
driv”
->
§m¶e_¿‹
 = sample_rate;

495 
i
 = 0; i < 6; i++) {

496 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SAMPLE_RATE
 + 
i
, 
ch_h¬dw¬e_§m¶e_256fs
[
§m¶e_¿‹
][i]);

498 
»t
 = 
TW_OK
;

500 
TW_AUDIO_44100
:

501 
driv”
->
§m¶e_¿‹
 = sample_rate;

502 
i
 = 0; i < 6; i++) {

503 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SAMPLE_RATE
 + 
i
, 
ch_h¬dw¬e_§m¶e_256fs
[
§m¶e_¿‹
][i]);

505 
»t
 = 
TW_OK
;

507 
TW_AUDIO_48000
:

508 
driv”
->
§m¶e_¿‹
 = sample_rate;

509 
i
 = 0; i < 6; i++) {

510 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_SAMPLE_RATE
 + 
i
, 
ch_h¬dw¬e_§m¶e_256fs
[
§m¶e_¿‹
][i]);

512 
»t
 = 
TW_OK
;

515 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆ§m¶¿‹ %d\n", 
§m¶e_¿‹
);

516 
»t
 = -
EINVAL
;

521  
TW_ERR
;

522 
	}
}

524 
	$ch_ai_driv”_g‘_b™s
(
tw_ch_ai_driv”_t
 *
driv”
)

526 if(
driv”
) {

527  
driv”
->
b™s
;

530  
TW_ERR
;

531 
	}
}

533 
	$ch_ai_driv”_£t_b™s
(
tw_ch_ai_driv”_t
 *
driv”
, 
TW_AUDIO_BIT
 
b™s
)

535 
»t
 = 
TW_ERR
, 
‹mp
;

537 if(
driv”
) {

538 
b™s
) {

539 
TW_AUDIO_8BIT
:

540 
driv”
->
b™s
 = bits;

541 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_BITS
);

542 
‹mp
 |= (1 << 2);

543 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_BITS
, 
‹mp
);

544 
»t
 = 
TW_OK
;

546 
TW_AUDIO_16BIT
:

547 
driv”
->
b™s
 = bits;

548 
‹mp
 = 
	`mpb_»ad
(
driv”
->
ch
, 
TW_AI_BITS
);

549 
‹mp
 &= ~(1 << 2);

550 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_AI_BITS
, 
‹mp
);

551 
»t
 = 
TW_OK
;

554 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆb™ %d\n", 
b™s
);

555 
»t
 = -
EINVAL
;

560  
TW_ERR
;

561 
	}
}

563 
tw_ch_ai_İ”©iÚ
 
	gtw_ch_ai_İ”©iÚ_İ
 = {

564 .
š™
 = 
ch_ai_driv”_š™
,

565 .
	g»Ëa£
 = 
ch_ai_driv”_»Ëa£
,

566 .
	g»£t
 = 
ch_ai_driv”_»£t
,

568 .
	gg‘_şock_mode
 = 
ch_ai_driv”_g‘_şock_mode
,

569 .
	g£t_şock_mode
 = 
ch_ai_driv”_£t_şock_mode
,

570 .
	gg‘_sync_mode
 = 
ch_ai_driv”_g‘_sync_mode
,

571 .
	g£t_sync_mode
 = 
ch_ai_driv”_£t_sync_mode
,

572 .
	gg‘_§m¶e_¿‹
ğ
ch_ai_driv”_g‘_§m¶e_¿‹
,

573 .
	g£t_§m¶e_¿‹
ğ
ch_ai_driv”_£t_§m¶e_¿‹
,

574 .
	gg‘_b™s
 = 
ch_ai_driv”_g‘_b™s
,

575 .
	g£t_b™s
 = 
ch_ai_driv”_£t_b™s


578 
	$š™_ch_ai_driv”
(
tw_£rviû_deviû
 *
tsd
, 
dvm_ch_t
 *
ch
)

580 
»t
 = 0;

581 
tw_ch_ai_driv”_t
 *
driv”
;

583 
driv”
 = (
tw_ch_ai_driv”_t
 *)
	`km®loc
(Ñw_ch_ai_driv”_t),
GFP_KERNEL
);

584 if(
driv”
) {

585 if(
ch
) {

586 
driv”
->
ch
 = chip;

587 
driv”
->
İ
 = &
tw_ch_ai_İ”©iÚ_İ
;

588 
ch
->
ch_ai_driv”
 = 
driv”
;

589 
»t
 = 
driv”
->
İ
->
	`š™
(driver);

590 
driv”
->
İ
->
	`»£t
(driver);

591 if(
»t
){

592 
	`TW_DBG
(
TW_DBG_ERR
, "çedØš™‡˜driv” %d!\n", 
»t
);

593  -
ENOMEM
;

595 
	`š™_’dpošt_tcb
(&
driv”
->
İ’ed_ai_ed
, 
ch
->
bus_id
, ch->
ch_id
,

596 
INVALID_TW_ED_TYPE_ID
, 0,

597 0, 
driv”
, 
NULL
,

598 
NULL
, NULL);

599 
tsd
->
³d
 = &
driv”
->
İ’ed_ai_ed
;

600  
TW_OK
;

602 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

603  -
EINVAL
;

606 
	`TW_DBG
(
TW_DBG_ERR
, "nomemory\n");

607  -
ENOMEM
;

610  
TW_ERR
;

611 
	}
}

613 
	$»move_ch_ai_driv”
(
tw_£rviû_deviû
 *
tsd
)

615 
tw_ch_ai_driv”_t
 *
driv”
;

617 if(
tsd
 &&sd->
³d
) {

618 
driv”
 = 
	`to_g‘_ch_ai_driv”_w™h_İ’ed_logic_chª_ed
(
tsd
->
³d
);

619 
driv”
->
İ
->
	`»Ëa£
(driver);

620 
	`kä“
(
driv”
);

621  
TW_OK
;

624  
TW_ERR
;

625 
	}
}

631 
	$tw_ch_ai_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 *
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

633 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

635  
	`š™_ch_ai_driv”
(
tsd
,
ch
);

636 
	}
}

639 
	$tw_ch_ai_driv”_»move
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 *
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

641 
	`´štk
("š %s\n",
__FUNCTION__
);

642 
	`»move_ch_ai_driv”
(
tsd
);

643 
	}
}

646 
tw_dev_id
 
	gtw_ch_ai_dev_id
 =

648 .
•obj
 = {

649 .
v’dÜ_id
 = 
TWELL
,

650 .
	gbus_id
 = 1,

651 .
	gch_id
 = 
TW5864
,

652 .
	gfunc_id
 = (0 << 16) | 0,

653 .
	gty³
 = 
TW_AUDIO_IN
,

654 .
	gkey
 = {0},

656 .
	gv”siÚ
 = 1,

660 
tsd_driv”_İ”©iÚs
 
	gtw_ch_ai_İs
 =

662 .
š™
 = 
tw_ch_ai_driv”_š™
,

663 .
	g»move
 = 
tw_ch_ai_driv”_»move
,

666 
tw_£rviû_driv”
 
	gtw_ch_ai_driv
 =

668 .
driv”
 = {

669 .
Çme
 = "tw5864_audio_input_driv",

671 .
	gdeviû_id
 = {

672 .
tid
 = &
tw_ch_ai_dev_id
,

673 .
	gİs
 = &
tw_ch_ai_İs
,

679 
	$tw5864_ch_ai_driv”_š™
(* 
·¿
)

681 
tw_ch_ai_driv
.
deviû_id
.
·¿
 =…ara;

682  
	`»gi¡”_tc_driv”
(&
tw_ch_ai_driv
);

683 
	}
}

686 
	$tw5864_ch_ai_driv”_»move
()

688 
	`uÄegi¡”_tc_driv”
(&
tw_ch_ai_driv
);

689 
	}
}

	@../../tw5864/tw5864/tw_chip_ao.c

1 
	~<tw5864/dvm_commÚ.h
>

	@../../tw5864/tw5864/tw_chip_driver.c

1 
	~<tw5864/dvm_commÚ.h
>

2 
	~<tw5864/tc_commÚ.h
>

4 
	$ch_driv”_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
)

6 
»t
 = 
TW_ERR
;

8 if(
İ’ed_cÚŒŞ_ed
) {

9 
ch_driv”_t
 *
driv”
;

11 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_cÚŒŞ_ed
);

12 
	`©omic_»ad
(&
İ’ed_cÚŒŞ_ed
->
¡©e
)){

14 
TW_ED_UNREGISTER
:

15 
TW_ED_CLOSED
:

16 
İ’ed_cÚŒŞ_ed
->
ed
.
İ
->
	`š™_com¶‘e
(&opened_control_ed->ed);

17 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 1);

18 
»t
 = 0;

20 
TW_ED_IDLE
:

21 
TW_ED_STANDBY
:

22 
TW_ED_SUSPEND
:

23 
TW_ED_RUNNING
:

24 
»t
 = -
EBUSY
;

25 
	`TW_DBG
(
TW_DBG_ERR
, "chip control have been opened\n");

30  
»t
;

31 
	}
}

33 
	$ch_driv”_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
)

35 
»t
 = 
TW_ERR
;

37 if(
İ’ed_cÚŒŞ_ed
) {

38 
ch_driv”_t
 *
driv”
;

40 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_cÚŒŞ_ed
);

41 
	`©omic_»ad
(&
İ’ed_cÚŒŞ_ed
->
¡©e
)){

43 
TW_ED_UNREGISTER
:

44 
TW_ED_CLOSED
:

45 
»t
 = 0;

46 
	`TW_DBG
(
TW_DBG_INFO
, "chip control have been close\n");

48 
TW_ED_IDLE
:

49 
TW_ED_STANDBY
:

50 
TW_ED_SUSPEND
:

51 
TW_ED_RUNNING
:

52 if(
İ’ed_cÚŒŞ_ed
->
ed
.
İ
 !ğ
NULL
){

53 
	`©omic_£t
(&
İ’ed_cÚŒŞ_ed
->
¡©e
, 
TW_ED_CLOSED
);

54 
İ’ed_cÚŒŞ_ed
->
ed
.
İ
->
	`com¶‘e_dÚe
(&opened_control_ed->ed);

55 
	`TW_DBG
(
TW_DBG_INFO
, "control complete doen\n");

56 
»t
 = 0;

58 
	`TW_DBG
(
TW_DBG_FATAL
, "control‚ode have‚ot inital!\n");

59 
»t
 = -
EACCES
;

61 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

66  
»t
;

67 
	}
}

69 
	$ch_driv”_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
)

71 if(
İ’ed_cÚŒŞ_ed
) {

72 
ch_driv”_t
 *
driv”
;

74 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_cÚŒŞ_ed
);

75 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

77 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

83 
	}
}

85 
	$ch_driv”_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
)

87 if(
İ’ed_cÚŒŞ_ed
) {

88 
ch_driv”_t
 *
driv”
;

90 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_cÚŒŞ_ed
);

91 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

93 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

99 
	}
}

101 
	$ch_driv”_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
, 
cmd
, 
¬g
)

103 
»t
 = 
TW_ERR
;

104 
ch_driv”_t
 *
driv”
;

105 
tw_video_bus_t
 *
video_bus
;

106 
tw_audio_bus_t
 *
audio_bus
;

107 
ch_audio_t
 *
ch_audio_driv”
;

108 
tw_audio_driv”_t
 *
audio_driv”
;

110 if(
İ’ed_cÚŒŞ_ed
) {

111 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_cÚŒŞ_ed
);

112 
video_bus
 = &
driv”
->video_bus;

113 
audio_bus
 = &
driv”
->audio_bus;

115 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

117 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

118  -
EPERM
;

121 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

122 
cmd
) {

123 
TW_CHIP_AUDIO_ENCODE_PARAM_SET
:

124 
TW_CHIP_AUDIO_ENCODE_PARAM_GET
:

125 
TW_CHIP_AUDIO_DECODE_PARAM_SET
:

126 
TW_CHIP_AUDIO_DECODE_PARAM_GET
:

127 
ch_audio_driv”
 = 
audio_bus
->chip_audio_driver;

128 if(
ch_audio_driv”
) {

129 
tw_ch_audio_·¿m
 
audio_·¿m
;

130 
	`cİy_äom_u£r
(&
audio_·¿m
, (*)
¬g
, (
tw_ch_audio_·¿m
));

131 if((
audio_·¿m
.
chªÃl
 >ğ
TW_AUDIO_IN_CHAN0_ID
è&& (audio_·¿m.chªÃÈ<ğ
TW_AUDIO_OUT_PLAYBACK_ID
)) {

132 
ch_audio_driv”
->
İ
->
	`g‘_audio_chª_driv”
(ch_audio_driv”, 
audio_·¿m
.
chªÃl
, &
audio_driv”
);

133 if(
audio_driv”
) {

134 
ed_tcb_t
 *
ed
;

135 
ed
 = &
audio_driv”
->
audio_ed
;

136 
»t
 = 
ed
->
İ
->
	`ioùl
Ód, 
cmd
, 
¬g
);

137 if(
»t
) {

138 
	`TW_DBG
(
TW_DBG_ERR
, "audiØioùÈçed %d\n", 
»t
);

139  
»t
;

142 
	`TW_DBG
(
TW_DBG_FATAL
, "audio driver‚ot installed!\n");

143 
»t
 = -
ENOSYS
;

146 
	`TW_DBG
(
TW_DBG_ERR
, "audiØchªÃÈnumb” %d ov”æow\n", 
audio_·¿m
.
chªÃl
);

147 
»t
 = -
ECHRNG
;

151 
	`TW_DBG
(
TW_DBG_FATAL
, "audio driver‚ot installed!\n");

152 
»t
 = -
ENOSYS
;

155 
TW_VIDEO_BUS_PARAM_SET
:

156 if(
video_bus
 && video_bus->
İ
) {

157 
tw_ch_video_·¿m
 
video_·¿m
;

158 
	`cİy_äom_u£r
(&
video_·¿m
, (*)
¬g
, (
tw_ch_video_·¿m
));

159 if(
video_·¿m
.
chªge_mask_æag
 & 
TW_VIDEO_BUS_PARAM_ENABLE_CHANGE_VIDEO_STANDARD_MASK
) {

160 
»t
 = 
video_bus
->
İ
->
	`£t_video_¡ªd¬d
(video_bus, 
video_·¿m
.
e_video_¡ªd¬d
);

164 
TW_VIDEO_BUS_PARAM_GET
:

165 if(
video_bus
 && video_bus->
İ
) {

166 
tw_ch_video_·¿m
 
video_·¿m
;

167 if(
video_·¿m
.
chªge_mask_æag
 & 
TW_VIDEO_BUS_PARAM_ENABLE_CHANGE_VIDEO_STANDARD_MASK
) {

168 
video_·¿m
.
e_video_¡ªd¬d
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

169 
	`cİy_to_u£r
((*)
¬g
, &
video_·¿m
, (
tw_ch_video_·¿m
));

171 
»t
 = 
TW_OK
;

173 
	`TW_DBG
(
TW_DBG_INFO
, "change_mask_flag‚ot set\n");

174 
»t
 = -
EINVAL
;

179 
TW_CHIP_VD_CONFIG_PARAM_SET
:

180 if(
video_bus
) {

181 
u32
 
chÆ
;

182 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

183 
tw_ch_vd_·¿m
 
vd_·¿m
;

184 
tw_vd_chª_·¿m
 *
vd_chª_·¿m
;

185 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

186 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

187 
vd_chª_m­_šfo_t
 
chª_m­_šfo
[
TW5864_PHY_VD_CHAN_NUMBER
], *
m­_šfo
;

189 
	`cİy_äom_u£r
(&
vd_·¿m
, (*)
¬g
, (
tw_ch_vd_·¿m
));

190 
m­_šfo
 = 
chª_m­_šfo
;

191 if(
vd_·¿m
.
i_vd_chª_numb”
 > 
TW5864_PHY_VD_CHAN_NUMBER
){

192 
	`TW_DBG
(
TW_DBG_ERR
, "chªÆnumb” %d ov”æow\n", 
vd_·¿m
.
i_vd_chª_numb”
);

193 
»t
 = -
EINVAL
;

194  
»t
;

197 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

198 if(
vd_bus
->
İ
->
	`g‘_wÜk_mode
(vd_busè!ğ
TW_CROSS_BUS_UNREALTIME
) {

199 
	`TW_DBG
(
TW_DBG_ERR
, "To change vd…arameter, Only work on TW_CROSS_BUS_UNREALTIME mode!\n");

202 
	`TW_DBG
(
TW_DBG_DEBUG
, "chªg%d chªÃl\n", 
vd_·¿m
.
i_vd_chª_numb”
);

203 
chÆ
 = 0; chÆ < 
vd_·¿m
.
i_vd_chª_numb”
; chÆ++, 
m­_šfo
++) {

204 
vd_chª_·¿m
 = &
vd_·¿m
.vd_chª_·¿m[
chÆ
];

205 
	`TW_DBG
(
TW_DBG_DEBUG
, "ch = %d, fp ğ%2d, mb_width = %2d, mb_heighˆğ%2d\n", 
vd_chª_·¿m
->
i_phy_chª_id
, vd_chª_·¿m->
i_phy_chª_ås
, vd_chª_·¿m->
i_phy_video_width_mb_size
, vd_chª_·¿m->
i_phy_video_height_mb_size
);

206 if(
vd_chª_·¿m
->
i_phy_chª_id
 < 
TW5864_PHY_VD_CHAN_NUMBER
) {

207 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

208 if(
vd_chª_·¿m
->
i_phy_chª_ås
 <ğ
MAX_FRAME_RATE_PAL
) {

209 
m­_šfo
->
ås
 = 
vd_chª_·¿m
->
i_phy_chª_ås
;

211 
	`TW_DBG
(
TW_DBG_ERR
, "å %d ov”æow, [0, %d]\n", 
vd_chª_·¿m
->
i_phy_chª_ås
, 
MAX_FRAME_RATE_PAL
);

212 
»t
 = -
EINVAL
;

213  
»t
;

216 if(
vd_chª_·¿m
->
i_phy_chª_ås
 <ğ
MAX_FRAME_RATE_NTSC
) {

217 
m­_šfo
->
ås
 = 
vd_chª_·¿m
->
i_phy_chª_ås
;

219 
	`TW_DBG
(
TW_DBG_ERR
, "å %d ov”æow, [0, %d]\n", 
vd_chª_·¿m
->
i_phy_chª_ås
, 
MAX_FRAME_RATE_NTSC
);

220 
»t
 = -
EINVAL
;

221  
»t
;

224 
m­_šfo
->
’abË
 = 
vd_chª_·¿m
->
i_phy_chª_’abË
;

225 if(
m­_šfo
->
’abË
) {

226 
m­_šfo
->
phy_¦Ù_id
 = 
vd_chª_·¿m
->
i_phy_chª_id
;

228 
m­_šfo
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

230 
m­_šfo
->
video_size
 = 
	`VIDEO_SIZE_FROM_WIDTH_HEIGHT
(
vd_chª_·¿m
->
i_phy_video_width_mb_size
<<4,

231 
vd_chª_·¿m
->
i_phy_video_height_mb_size
<<4,

232 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

233 if(
m­_šfo
->
video_size
 =ğ
TW_VIDEO_SIZE_USER
) {

234 
	`TW_DBG
(
TW_DBG_ERR
, "channel width or heightƒrror\n");

235 
»t
 = -
EINVAL
;

236  
»t
;

239 
	`TW_DBG
(
TW_DBG_ERR
, "NØsuch chªÃÈ%d\n", 
vd_chª_·¿m
->
i_phy_chª_id
);

240 
»t
 = -
EINVAL
;

241  
»t
;

244 ; 
chÆ
 < 
TW5864_PHY_VD_CHAN_NUMBER
; chÆ++, 
m­_šfo
++) {

245 
m­_šfo
->
ås
 = 0;

246 
m­_šfo
->
’abË
 = 0;

247 
m­_šfo
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

248 
m­_šfo
->
video_size
 = 
TW_VIDEO_SIZE_D1
;

250 
»t
 = 
vd_bus
->
İ
->
	`ÿlcuÏ‹_üoss_bus_m­_bË
(vd_bus, 
chª_m­_šfo
);

251 if(
»t
) {

252 
	`TW_DBG
(
TW_DBG_ERR
, "please check configuration\n");

255 
m­_šfo
 = 
chª_m­_šfo
;

256 if(
video_bus
->
İ
->
	`nÙify_su¥’d_logic_chª
(video_bus)){

257 
	`TW_DBG
(
TW_DBG_FATAL
, "suspend†ogic channel failed\n");

258  -
EBUSY
;

260 
chÆ
 = 0; chÆ < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; chÆ++, 
m­_šfo
++) {

261 
logic_video_¦Ù
 = 
vd_bus
->logic_video_¦Ù + 
m­_šfo
->
m­_logic_¦Ù_id
;

262 
logic_video_¦Ù
->
İ
->
	`£t_m­PhySlÙId
Öogic_video_¦Ù, 
m­_šfo
->
phy_¦Ù_id
);

263 
logic_video_¦Ù
->
İ
->
	`£t_disÿrdTabË
Öogic_video_¦Ù, 
m­_šfo
->
logic_¦Ù_disÿrd_bË
);

264 
logic_video_¦Ù
->
İ
->
	`£t_roundTabËSŒide
Öogic_video_¦Ù, 
m­_šfo
->
roundTabËSŒide
);

265 
logic_video_¦Ù
->
İ
->
	`£t_video_size
Öogic_video_¦Ù, 
m­_šfo
->
video_size
);

266 
logic_video_¦Ù
->
İ
->
	`£t_’abË¦Ù
Öogic_video_¦Ù, 
m­_šfo
->
’abË
);

267 
logic_video_¦Ù
->
İ
->
	`£t_ås
Öogic_video_¦Ù, 
m­_šfo
->
ås
);

268 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 1);

269 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
m­_šfo
->
phy_¦Ù_id
, &
phy_video_¦Ù
);

270 
phy_video_¦Ù
->
İ
->
	`£t_video_size
Õhy_video_¦Ù, 
logic_video_¦Ù
->İ->
	`g‘_video_size
(logic_video_slot));

271 
phy_video_¦Ù
->
İ
->
	`upd©e_m­_logic_¦Ù
Õhy_video_¦Ù, 
logic_video_¦Ù
->
logicSlÙId
,†ogic_video_slot);

273 if(
vd_bus
->
İ
->
	`£t_ch_’d_üoss_bus
(vd_bus, 
	`to_g‘_ch_w™h_ch_üoss_bus
(vd_bus))){

274 
	`TW_DBG
(
TW_DBG_FATAL
, "synco hardware failed\n");

276 if(
video_bus
->
İ
->
	`nÙify_»sume_logic_chª
(video_bus)){

277 
	`TW_DBG
(
TW_DBG_FATAL
, "resume†ogic channel failed\n");

278  -
EBUSY
;

281 if(
video_bus
->
İ
->
	`nÙify_logic_chª_chªge
(video_bus)){

282 
	`TW_DBG
(
TW_DBG_FATAL
, "synco†ogic channel failed\n");

283  -
EBUSY
;

285 
»t
 = 
TW_OK
;

288 
TW_CHIP_VD_CONFIG_PARAM_GET
:

289 if(
video_bus
) {

290 
u32
 
chÆ
;

291 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

292 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

293 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

294 
tw_ch_vd_·¿m
 
vd_·¿m
;

295 
tw_vd_chª_·¿m
 *
vd_chª_·¿m
;

297 
	`cİy_äom_u£r
(&
vd_·¿m
, (*)
¬g
, (
tw_ch_vd_·¿m
));

298 if(
vd_·¿m
.
i_vd_chª_numb”
 > 
TW5864_PHY_VD_CHAN_NUMBER
){

299 
	`TW_DBG
(
TW_DBG_ERR
, "chªÆnumb” %d ov”æow\n", 
vd_·¿m
.
i_vd_chª_numb”
);

300 
»t
 = -
EINVAL
;

303 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

304 
chÆ
 = 0; chÆ < 
vd_·¿m
.
i_vd_chª_numb”
; chnl++) {

305 
vd_chª_·¿m
 = &
vd_·¿m
.vd_chª_·¿m[
chÆ
];

306 if(
vd_chª_·¿m
->
i_phy_chª_id
 < 
TW5864_PHY_VD_CHAN_NUMBER
) {

307 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
vd_chª_·¿m
->
i_phy_chª_id
, &
phy_video_¦Ù
);

308 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

309 
vd_chª_·¿m
->
i_phy_chª_’abË
 = 
logic_video_¦Ù
->
İ
->
	`g‘_’abË¦Ù
(logic_video_slot);

310 
vd_chª_·¿m
->
i_phy_chª_ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

311 
vd_chª_·¿m
->
i_phy_video_width_mb_size
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot),

312 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))>>4;

313 
vd_chª_·¿m
->
i_phy_video_height_mb_size
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot),

314 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))>>4;

316 
	`TW_DBG
(
TW_DBG_ERR
, "NØsuch chªÃÈ%d\n", 
vd_chª_·¿m
->
i_phy_chª_id
);

317 
»t
 = -
EINVAL
;

321 
	`cİy_to_u£r
((*)
¬g
, &
vd_·¿m
, (
tw_ch_vd_·¿m
));

324 
TW_CHIP_VD_CHNL_CONFIG_SET
:

325 if(
video_bus
) {

326 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

327 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

328 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

329 
vd_chª_m­_šfo_t
 
chª_m­_šfo
[
TW5864_PHY_VD_CHAN_NUMBER
], *
m­_šfo
;

330 
tw_vd_chª_·¿m
 
vd_chª_·¿m
;

331 
i
;

333 if(!
¬g
) {

334 
	`TW_DBG
(
TW_DBG_ERR
, "arg‚ull\n");

335 
»t
 = -
EINVAL
;

339 
	`cİy_äom_u£r
(&
vd_chª_·¿m
, (*)
¬g
, (
tw_vd_chª_·¿m
));

340 if(
vd_chª_·¿m
.
i_phy_chª_id
 > 
TW5864_PHY_VD_CHAN_NUMBER
){

341 
	`TW_DBG
(
TW_DBG_ERR
, "chªÆnumb” %d ov”æow\n", 
vd_chª_·¿m
.
i_phy_chª_id
);

342 
»t
 = -
EINVAL
;

346 
m­_šfo
 = 
chª_m­_šfo
;

347 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

348 
m­_šfo
->
phy_¦Ù_id
 = 
vd_chª_·¿m
.
i_phy_chª_id
;

349 
m­_šfo
->
video_size
 = 
	`VIDEO_SIZE_FROM_WIDTH_HEIGHT
(
vd_chª_·¿m
.
i_phy_video_width_mb_size
<<4,

350 
vd_chª_·¿m
.
i_phy_video_height_mb_size
<<4,

351 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

352 if(
m­_šfo
->
video_size
 =ğ
TW_VIDEO_SIZE_USER
) {

353 
	`TW_DBG
(
TW_DBG_ERR
, "channel width or heightƒrror\n");

354 
»t
 = -
EINVAL
;

357 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

358 if(
vd_chª_·¿m
.
i_phy_chª_ås
 <ğ
MAX_FRAME_RATE_PAL
) {

359 
m­_šfo
->
ås
 = 
vd_chª_·¿m
.
i_phy_chª_ås
;

361 
	`TW_DBG
(
TW_DBG_ERR
, "å %d ov”æow, [0, %d]\n", 
vd_chª_·¿m
.
i_phy_chª_ås
, 
MAX_FRAME_RATE_PAL
);

362 
»t
 = -
EINVAL
;

366 if(
vd_chª_·¿m
.
i_phy_chª_ås
 <ğ
MAX_FRAME_RATE_NTSC
) {

367 
m­_šfo
->
ås
 = 
vd_chª_·¿m
.
i_phy_chª_ås
;

369 
	`TW_DBG
(
TW_DBG_ERR
, "å %d ov”æow, [0, %d]\n", 
vd_chª_·¿m
.
i_phy_chª_ås
, 
MAX_FRAME_RATE_NTSC
);

370 
»t
 = -
EINVAL
;

374 
m­_šfo
++;

375 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++) {

376 if(
i
 =ğ
vd_chª_·¿m
.
i_phy_chª_id
) {

379 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
i
, &
phy_video_¦Ù
);

380 if(!
phy_video_¦Ù
) {

381 
	`TW_DBG
(
TW_DBG_ERR
, "uÇbËØfšd…hy_video_¦Ù %d\n", 
i
);

382  -
EFAULT
;

384 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

385 
m­_šfo
->
’abË
 = 
logic_video_¦Ù
->
İ
->
	`g‘_’abË¦Ù
(logic_video_slot);

386 
m­_šfo
->
ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

387 
m­_šfo
->
video_size
 = 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot);

388 
m­_šfo
->
phy_¦Ù_id
 = 
i
;

389 
m­_šfo
++;

392 
»t
 = 
vd_bus
->
İ
->
	`ÿlcuÏ‹_üoss_bus_m­_bË
(vd_bus, 
chª_m­_šfo
);

393 if(
»t
) {

394 
	`TW_DBG
(
TW_DBG_ERR
, "please check configuration\n");

397 
m­_šfo
 = 
chª_m­_šfo
;

398 if(
video_bus
->
İ
->
	`nÙify_su¥’d_logic_chª
(video_bus)){

399 
	`TW_DBG
(
TW_DBG_FATAL
, "suspend†ogic channel failed\n");

400  -
EBUSY
;

402 
i
 = 0; i < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; i++, 
m­_šfo
++) {

403 
logic_video_¦Ù
 = 
vd_bus
->logic_video_¦Ù + 
m­_šfo
->
m­_logic_¦Ù_id
;

404 
logic_video_¦Ù
->
İ
->
	`£t_m­PhySlÙId
Öogic_video_¦Ù, 
m­_šfo
->
phy_¦Ù_id
);

405 
logic_video_¦Ù
->
İ
->
	`£t_disÿrdTabË
Öogic_video_¦Ù, 
m­_šfo
->
logic_¦Ù_disÿrd_bË
);

406 
logic_video_¦Ù
->
İ
->
	`£t_roundTabËSŒide
Öogic_video_¦Ù, 
m­_šfo
->
roundTabËSŒide
);

407 
logic_video_¦Ù
->
İ
->
	`£t_video_size
Öogic_video_¦Ù, 
m­_šfo
->
video_size
);

408 
logic_video_¦Ù
->
İ
->
	`£t_’abË¦Ù
Öogic_video_¦Ù, 
m­_šfo
->
’abË
);

409 
logic_video_¦Ù
->
İ
->
	`£t_ås
Öogic_video_¦Ù, 
m­_šfo
->
ås
);

410 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 1);

411 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
m­_šfo
->
phy_¦Ù_id
, &
phy_video_¦Ù
);

412 
phy_video_¦Ù
->
İ
->
	`£t_video_size
Õhy_video_¦Ù, 
logic_video_¦Ù
->İ->
	`g‘_video_size
(logic_video_slot));

413 
phy_video_¦Ù
->
İ
->
	`upd©e_m­_logic_¦Ù
Õhy_video_¦Ù, 
logic_video_¦Ù
->
logicSlÙId
,†ogic_video_slot);

415 if(
vd_bus
->
İ
->
	`£t_ch_’d_üoss_bus
(vd_bus, 
	`to_g‘_ch_w™h_ch_üoss_bus
(vd_bus))){

416 
	`TW_DBG
(
TW_DBG_FATAL
, "synco hardware failed\n");

418 if(
video_bus
->
İ
->
	`nÙify_»sume_logic_chª
(video_bus)){

419 
	`TW_DBG
(
TW_DBG_FATAL
, "resume†ogic channel failed\n");

420  -
EBUSY
;

423 if(
video_bus
->
İ
->
	`nÙify_logic_chª_chªge
(video_bus)){

424 
	`TW_DBG
(
TW_DBG_FATAL
, "synco†ogic channel failed\n");

425  -
EBUSY
;

427 
»t
 = 
TW_OK
;

430 
TW_CHIP_VD_CHNL_CONFIG_GET
:

431 if(
video_bus
) {

432 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

433 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

434 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

435 
tw_vd_chª_·¿m
 
vd_chª_·¿m
;

437 
	`cİy_äom_u£r
(&
vd_chª_·¿m
, (*)
¬g
, (
tw_vd_chª_·¿m
));

438 if(
vd_chª_·¿m
.
i_phy_chª_id
 > 
TW5864_PHY_VD_CHAN_NUMBER
){

439 
	`TW_DBG
(
TW_DBG_ERR
, "chªÆnumb” %d ov”æow\n", 
vd_chª_·¿m
.
i_phy_chª_id
);

440 
»t
 = -
EINVAL
;

444 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

445 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
vd_chª_·¿m
.
i_phy_chª_id
, &
phy_video_¦Ù
);

446 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

447 
vd_chª_·¿m
.
i_phy_chª_’abË
 = 
logic_video_¦Ù
->
İ
->
	`g‘_’abË¦Ù
(logic_video_slot);

448 
vd_chª_·¿m
.
i_phy_chª_ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

449 
vd_chª_·¿m
.
i_phy_video_width_mb_size
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot),

450 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))>>4;

451 
vd_chª_·¿m
.
i_phy_video_height_mb_size
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot),

452 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))>>4;

453 
vd_chª_·¿m
.
hÜ_»v”£
 = 
logic_video_¦Ù
->hor_reverse;

454 
vd_chª_·¿m
.
v”_»v”£
 = 
logic_video_¦Ù
->ver_reverse;

456 
	`cİy_to_u£r
((*)
¬g
, &
vd_chª_·¿m
, (
tw_vd_chª_·¿m
));

458 
»t
 = 
TW_OK
;

461 
TW_CHIP_VD_WORK_MODE_GET
:

462 if(
video_bus
) {

463 
u32
 
mode
;

464 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

466 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

467 
mode
 = 
vd_bus
->
İ
->
	`g‘_wÜk_mode
(vd_bus);

468 
	`cİy_to_u£r
((*)
¬g
, &
mode
, (
u32
));

469 
»t
 = 
TW_OK
;

471 
»t
 = -
ENOSYS
;

474 
TW_CHIP_VD_WORK_MODE_SET
:

475 if(
video_bus
) {

476 
u32
 
mode
;

477 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

479 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

480 
	`cİy_äom_u£r
(&
mode
, (*)
¬g
, (
u32
));

482 
»t
 = 
vd_bus
->
İ
->
	`upd©e_wÜk_mode
(vd_bus, 
mode
);

483 if(
»t
) {

484 
	`TW_DBG
(
TW_DBG_ERR
, "update work mode failed\n");

486 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

487 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

488 
vd_chª_m­_šfo_t
 
chª_m­_bË
[
TW5864_PHY_VD_CHAN_NUMBER
], *
chª_m­
;

489 
dvm_ch_t
 *
ch
 = 
NULL
;

490 
u32
 
loÿl_ås
 = 0;

491 
i
;

493 
ch
 = 
driv”
->chip;

494 
chª_m­
 = 
chª_m­_bË
;

495 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

496 
loÿl_ås
 = 25;

498 
loÿl_ås
 = 30;

500 
vd_bus
->
İ
->
	`g‘_wÜk_mode
(vd_bus)){

501 
TW_CROSS_BUS_4D1_REALTIME
:

502 
i
=0; i<4; i++, 
chª_m­
++){

503 
chª_m­
->
phy_¦Ù_id
 = 
i
;

504 
chª_m­
->
ås
 = 
loÿl_ås
;

505 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_D1
;

508 ;
i
<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

509 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

512 
TW_CROSS_BUS_8H®fD1_REALTIME
:

513 
i
=0; i<8; i++, 
chª_m­
++){

514 
chª_m­
->
phy_¦Ù_id
 = 
i
;

515 
chª_m­
->
ås
 = 
loÿl_ås
;

516 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_HALF_D1
;

518 ; 
i
 < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

519 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

522 
TW_CROSS_BUS_16CIF_REALTIME
:

523 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

524 
chª_m­
->
phy_¦Ù_id
 = 
i
;

525 
chª_m­
->
ås
 = 
loÿl_ås
;

526 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_CIF
;

530 
TW_CROSS_BUS_UNREALTIME
:

531 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

532 
logic_video_¦Ù
 = &
vd_bus
->logic_video_¦Ù[
i
];

533 
chª_m­
->
phy_¦Ù_id
 = 
logic_video_¦Ù
->
İ
->
	`g‘_m­PhySlÙId
Öogic_video_¦Ù, 
i
);

534 
chª_m­
->
ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

535 
chª_m­
->
’abË
 = 
logic_video_¦Ù
->
İ
->
	`g‘_’abË¦Ù
(logic_video_slot);

536 
chª_m­
->
video_size
 = 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot);

540 if(
vd_bus
->
İ
->
	`ÿlcuÏ‹_üoss_bus_m­_bË
(vd_bus, 
chª_m­_bË
)){

541 
	`TW_DBG
(
TW_DBG_ERR
, "calculate mapable failed,…lease check…arameter!\n");

542  -
EINVAL
;

544 
chª_m­
 = 
chª_m­_bË
;

545 if(
video_bus
->
İ
->
	`nÙify_su¥’d_logic_chª
(video_bus)){

546 
	`TW_DBG
(
TW_DBG_FATAL
, "suspend†ogic channel failed\n");

547  -
EBUSY
;

549 
i
 = 0; i < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; i++, 
chª_m­
++) {

550 if(
chª_m­
->
m­_logic_¦Ù_id
 >ğ
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
) {

551 
	`TW_DBG
(
TW_DBG_ERR
, "logiøchªÃÈnumb” %d ov”æow\n", 
chª_m­
->
m­_logic_¦Ù_id
);

552  -
EINVAL
;

554 
logic_video_¦Ù
 = &
vd_bus
->logic_video_¦Ù[
chª_m­
->
m­_logic_¦Ù_id
];

555 
logic_video_¦Ù
->
İ
->
	`£t_m­PhySlÙId
Öogic_video_¦Ù, 
chª_m­
->
phy_¦Ù_id
);

556 
logic_video_¦Ù
->
İ
->
	`£t_disÿrdTabË
Öogic_video_¦Ù, 
chª_m­
->
logic_¦Ù_disÿrd_bË
);

557 
logic_video_¦Ù
->
İ
->
	`£t_roundTabËSŒide
Öogic_video_¦Ù, 
chª_m­
->
roundTabËSŒide
);

558 
logic_video_¦Ù
->
İ
->
	`£t_video_size
Öogic_video_¦Ù, 
chª_m­
->
video_size
);

559 
logic_video_¦Ù
->
İ
->
	`£t_’abË¦Ù
Öogic_video_¦Ù, 
chª_m­
->
’abË
);

560 
logic_video_¦Ù
->
İ
->
	`£t_ås
Öogic_video_¦Ù, 
chª_m­
->
ås
);

561 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 1);

563 
phy_video_¦Ù
 = &
vd_bus
->phy_video_¦Ù[
chª_m­
->
phy_¦Ù_id
];

564 
phy_video_¦Ù
->
İ
->
	`£t_video_size
Õhy_video_¦Ù, 
logic_video_¦Ù
->İ->
	`g‘_video_size
(logic_video_slot));

565 
phy_video_¦Ù
->
İ
->
	`upd©e_m­_logic_¦Ù
Õhy_video_¦Ù, 
logic_video_¦Ù
->
logicSlÙId
,†ogic_video_slot);

567 if(
vd_bus
->
İ
->
	`£t_ch_’d_üoss_bus
(vd_bus, 
	`to_g‘_ch_w™h_ch_üoss_bus
(vd_bus))){

568 
	`TW_DBG
(
TW_DBG_FATAL
, "synco hardware failed\n");

570 if(
video_bus
->
İ
->
	`nÙify_»sume_logic_chª
(video_bus)){

571 
	`TW_DBG
(
TW_DBG_FATAL
, "resume†ogic channel failed\n");

572  -
EBUSY
;

575 if(
video_bus
->
İ
->
	`nÙify_logic_chª_chªge
(video_bus)){

576 
	`TW_DBG
(
TW_DBG_FATAL
, "synco†ogic channel failed\n");

577  -
EBUSY
;

579 
»t
 = 
TW_OK
;

582 
»t
 = -
ENOSYS
;

585 
TW_CHIP_VIN_CHAN_NUMBER_GET
:

587 
tw_ch_vi_šfo
 
vi_šfo
;

589 
vi_šfo
.
i_vš_ad_chª_numb”
 = 
TW_VI_ON_CHIP_CHNL
;

590 
vi_šfo
.
i_vš_chª_nubm”
 = 
TW5864_PHY_VD_CHAN_NUMBER
;

591 
vi_šfo
.
i_ÿsÿde_vš_ad_chª_numb”
 = 
TW5864_PHY_VD_CHAN_NUMBER
 - 
TW_VI_ON_CHIP_CHNL
;

592 if(
¬g
) {

593 
	`cİy_to_u£r
((*)
¬g
, &
vi_šfo
, (
tw_ch_vi_šfo
));

594 
»t
 = 
TW_OK
;

596 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

597 
»t
 = -
EINVAL
;

601 
TW_CHIP_VOUT_CHAN_NUMBER_GET
:

603 
tw_ch_vo_šfo
 
vo_šfo
;

605 
vo_šfo
.
i_vout_ad_chª_numb”
 = 0;

606 
vo_šfo
.
i_vout_chª_nubm”
 = 0;

607 if(
¬g
) {

608 
	`cİy_to_u£r
((*)
¬g
, &
vo_šfo
, (
tw_ch_vo_šfo
));

609 
»t
 = 
TW_OK
;

611 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

612 
»t
 = -
EINVAL
;

616 
TW_CHIP_AIN_CHAN_NUMBER_GET
:

618 
tw_ch_ai_šfo
 
ai_šfo
;

620 
ai_šfo
.
i_aš_ad_chª_numb”
 = 
TW_VI_ON_CHIP_CHNL
;

621 
ai_šfo
.
i_aš_chª_nubm”
 = 
TW_AUDIO_IN_SPEAKER_ID
 + 1;

622 
ai_šfo
.
i_ÿsÿde_aš_ad_chª_numb”
 = 0;

623 if(
¬g
) {

624 
	`cİy_to_u£r
((*)
¬g
, &
ai_šfo
, (
tw_ch_ai_šfo
));

625 
»t
 = 
TW_OK
;

627 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

628 
»t
 = -
EINVAL
;

632 
TW_CHIP_AOUT_CHAN_NUMBER_GET
:

634 
tw_ch_ao_šfo
 
ao_šfo
;

636 
ao_šfo
.
i_aout_ad_chª_numb”
 = 
TW_AUDIO_OUT_PLAYBACK_ID
 - 
TW_AUDIO_IN_SPEAKER_ID
;

637 
ao_šfo
.
i_aout_chª_nubm”
 = 
TW_AUDIO_OUT_PLAYBACK_ID
 - 
TW_AUDIO_IN_SPEAKER_ID
;

638 if(
¬g
) {

639 
	`cİy_to_u£r
((*)
¬g
, &
ao_šfo
, (
tw_ch_ao_šfo
));

640 
»t
 = 
TW_OK
;

642 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

643 
»t
 = -
EINVAL
;

647 
TW_CHIP_ID_GET
:

648 if(
driv”
) {

649 
dvm_ch_t
 *
ch
;

650 
tw_ch_id_šfo
 
ch_šfo
, *
p_šfo
 = &chip_info;

652 
ch
 = 
driv”
->chip;

653 
p_šfo
->
i_v’dÜ_id
 = 
ch
->
io_İ
->
	`ch_»ad32
(chip, 0x0000);

654 
p_šfo
->
i_v”siÚ_id
 = 
ch
->
io_İ
->
	`ch_»ad32
(chip, 0x0004) & (~0xff);

655 if(
¬g
) {

656 
	`cİy_to_u£r
((*)
¬g
, 
p_šfo
, (
tw_ch_id_šfo
));

659 
»t
 = 
TW_OK
;

661 
TW_CHIP_CONFIG_WRITE_REG
:

662 if(
driv”
) {

663 
tw_»g_cÚf
 
»g
;

664 if(
¬g
) {

665 
__iomem
 *
vaddr
;

666 
u32
 
off£t
;

668 
	`cİy_äom_u£r
(&
»g
, (*)
¬g
, (
tw_»g_cÚf
));

669 
vaddr
 = (*)(
»g
.
addr
 & (~(
PAGE_SIZE
 - 1)));

670 
off£t
 = 
»g
.
addr
 & (
PAGE_SIZE
 - 1);

672 
vaddr
 = 
	`iÜem­
((
u32
 )vaddr, 
PAGE_SIZE
);

673 if(!
vaddr
) {

674 
	`TW_DBG
(
TW_DBG_ERR
, "ioremapƒrror\n");

675 
»t
 = -
EFAULT
;

677 
	`__¿w_wr™–
(
»g
.
v®
, 
vaddr
 + 
off£t
);

678 
	`iounm­
(
vaddr
);

679 
»t
 = 
TW_OK
;

684 
TW_CHIP_CONFIG_READ_REG
:

685 if(
driv”
) {

686 
tw_»g_cÚf
 
»g
;

687 if(
¬g
) {

688 
__iomem
 *
vaddr
;

689 
u32
 
off£t
;

691 
	`cİy_äom_u£r
(&
»g
, (*)
¬g
, (
tw_»g_cÚf
));

692 
vaddr
 = (*)(
»g
.
addr
 & (~(
PAGE_SIZE
 - 1)));

693 
off£t
 = 
»g
.
addr
 & (
PAGE_SIZE
 - 1);

695 
vaddr
 = 
	`iÜem­
((
u32
 )vaddr, 
PAGE_SIZE
);

696 if(!
vaddr
) {

697 
	`TW_DBG
(
TW_DBG_ERR
, "ioremapƒrror\n");

698 
»t
 = -
EFAULT
;

700 
»g
.
v®
 = 
	`__¿w_»adl
(
vaddr
 + 
off£t
);

701 
	`cİy_to_u£r
((*)
¬g
, &
»g
, (
tw_»g_cÚf
));

702 
	`iounm­
(
vaddr
);

703 
»t
 = 
TW_OK
;

708 
TW_CHIP_LOGIC_MAP_TABLE_SET
:

710 
tw_logic_m­_bË_t
 *
m­_bË
;

711 
bË_size
 = (
tw_logic_m­_bË_t
è+ (*
m­_bË
->m­_bËè* (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1);

713 
m­_bË
 = (
tw_logic_m­_bË_t
 *)
	`km®loc
(
bË_size
, 
GFP_KERNEL
);

714 if(!
m­_bË
) {

715 
	`TW_DBG
(
TW_DBG_ERR
, "no memory for mapable\n");

716 
»t
 = -
ENOMEM
;

719 if(
¬g
) {

720 
	`cİy_äom_u£r
(
m­_bË
, (*)
¬g
, (
tw_logic_m­_bË_t
));

721 if((
m­_bË
->
e_bšd_ty³
 >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
) || (map_table->e_bind_type < 0)) {

722 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀe_bšd_ty³ %d\n", 
m­_bË
->
e_bšd_ty³
);

723 
»t
 = -
EINVAL
;

725 if(
m­_bË
->
i_chª_numb”
 > (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1)) {

726 
	`TW_DBG
(
TW_DBG_ERR
, "m·abË chªÃÈnumb” %d ov”æow\n", 
m­_bË
->
i_chª_numb”
);

727 
»t
 = -
EINVAL
;

729 
tw_logic_phy_bË_t
 *
logic_m­_phy
;

732 
	`cİy_äom_u£r
(
m­_bË
, (*)
¬g
, (
tw_logic_m­_bË_t
è+ (*m­_bË->m­_bËè* (m­_bË->
i_chª_numb”
));

733 
logic_m­_phy
 = &
driv”
->logic_map_phy;

734 
logic_m­_phy
->
İ
->
	`upd©e_m­_bË
Öogic_m­_phy, 
m­_bË
->
e_bšd_ty³
, map_table);

736 
»t
 = 
TW_OK
;

738 if(
m­_bË
) {

739 
	`kä“
(
m­_bË
);

742 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

743 
»t
 = -
EINVAL
;

747 
TW_CHIP_LOGIC_MAP_TABLE_GET
:

749 
tw_logic_m­_bË_t
 *
m­_bË
;

750 
bË_size
 = (
tw_logic_m­_bË_t
è+ (*
m­_bË
->m­_bËè* (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1);

752 
m­_bË
 = (
tw_logic_m­_bË_t
 *)
	`km®loc
(
bË_size
, 
GFP_KERNEL
);

753 if(!
m­_bË
) {

754 
	`TW_DBG
(
TW_DBG_ERR
, "no memory for mapable\n");

755 
»t
 = -
ENOMEM
;

758 if(
¬g
) {

759 
	`cİy_äom_u£r
(
m­_bË
, (*)
¬g
, (
tw_logic_m­_bË_t
));

760 if((
m­_bË
->
e_bšd_ty³
 >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
) || (map_table->e_bind_type < 0)) {

761 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀe_bšd_ty³ %d\n", 
m­_bË
->
e_bšd_ty³
);

762 
»t
 = -
EINVAL
;

764 if(
m­_bË
->
i_chª_numb”
 > (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1)) {

765 
	`TW_DBG
(
TW_DBG_ERR
, "m·abË chªÃÈnumb” %d ov”æow\n", 
m­_bË
->
i_chª_numb”
);

766 
»t
 = -
EINVAL
;

768 
tw_logic_phy_bË_t
 *
logic_m­_phy
;

770 
logic_m­_phy
 = &
driv”
->logic_map_phy;

771 
logic_m­_phy
->
İ
->
	`g‘_m­_bË
Öogic_m­_phy, 
m­_bË
->
e_bšd_ty³
, map_table);

772 
	`cİy_to_u£r
((*)
¬g
, 
m­_bË
, (
tw_logic_m­_bË_t
è+ (*m­_bË->m­_bËè* (m­_bË->
i_chª_numb”
));

774 
»t
 = 
TW_OK
;

776 if(
m­_bË
) {

777 
	`kä“
(
m­_bË
);

780 
	`TW_DBG
(
TW_DBG_ERR
, "arg is‚ull\n");

781 
»t
 = -
EINVAL
;

786 
»t
 = -
EBADRQC
;

787 
	`TW_DBG
(
TW_DBG_ERR
, "No such command!\n");

792  
»t
;

793 
	}
}

795 
	$ch_driv”_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
İ’ed_cÚŒŞ_ed
)

797 
»t
 = 
TW_ED_UNREGISTER
;

799 if(
İ’ed_cÚŒŞ_ed
 !ğ
NULL
){

800 
»t
 = 
	`©omic_»ad
(&
İ’ed_cÚŒŞ_ed
->
¡©e
);

803  
»t
;

804 
	}
}

806 
hcd_š‹rçû_İ”©iÚ
 
	gch_driv”_hcd_š‹rçû_İ
 = {

807 .
İ’
 = 
ch_driv”_hcd_š‹rçû_İ’
,

808 .
	gşo£
 = 
ch_driv”_hcd_š‹rçû_şo£
,

809 .
	gsu¥’d
 = 
ch_driv”_hcd_š‹rçû_su¥’d
,

810 .
	g»sume
 = 
ch_driv”_hcd_š‹rçû_»sume
,

811 .
	gioùl
 = 
ch_driv”_hcd_š‹rçû_ioùl
,

812 .
	gg‘_¡©e
 = 
ch_driv”_hcd_š‹rçû_g‘_¡©e
,

815 
	$video_bus_š™
(
tw_video_bus_t
 *
video_bus
, 
dvm_ch_t
 *
ch
)

817 
»t
 = 
TW_ERR
;

819 if(
video_bus
 && 
ch
) {

820 
video_bus
->
vd_bus_driv”
 = &
ch
->
ch_vd_üoss_bus
;

821 
video_bus
->
vj_bus_driv”
 = &
ch
->
ch_vj_bus
;

822 
video_bus
->
İ
->
	`£t_video_¡ªd¬d
(video_bus, 
TW_VIDEO_STANDARD_NTSC
);

827 
»t
 = 
	`š™_tw5864_vd_üoss_bus
(&
ch
->
ch_vd_üoss_bus
, 
TW_CROSS_BUS_UNREALTIME
, 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

828 if(
»t
 !ğ
TW_OK
) {

829 
	`TW_DBG
(
TW_DBG_ERR
, "š™ vd bu ”rÜ 0x%08x\n", 
»t
);

830  
»t
;

833 
»t
 = 
	`š™_tw5864_vj_bus
(&
ch
->
ch_vj_bus
);

834 if(
»t
 !ğ
TW_OK
) {

835 
	`TW_DBG
(
TW_DBG_ERR
, "š™ vj bu ”rÜ 0x%08x\n", 
»t
);

836  
»t
;

839  
TW_OK
;

842  
TW_ERR
;

843 
	}
}

845 
	$video_bus_»Ëa£
(
tw_video_bus_t
 *
video_bus
)

847 if(
video_bus
) {

848 
	`»move_tw5864_vd_üoss_bus
(
video_bus
->
vd_bus_driv”
);

849 
	`»move_tw5864_vj_bus
(
video_bus
->
vj_bus_driv”
);

851 
	}
}

853 
	$video_bus_»£t
(
tw_video_bus_t
 *
video_bus
)

855 if(
video_bus
) {

856 
tw5864_vd_üoss_bus_t
 *
vd_bus_driv”
 = 
video_bus
->vd_bus_driver;

857 
tw5864_vj_bus_t
 *
vj_bus_driv”
 = 
video_bus
->vj_bus_driver;

859 if(
vd_bus_driv”
->
İ
) {

860 
vd_bus_driv”
->
İ
->
	`»£t
(vd_bus_driver);

863 if(
vj_bus_driv”
->
İ
) {

864 
vj_bus_driv”
->
İ
->
	`»£t
(vj_bus_driver);

867  
TW_OK
;

870  
TW_ERR
;

871 
	}
}

873 
	$video_bus_g‘_video_¡ªd¬d
(
tw_video_bus_t
 *
video_bus
)

875 if(
video_bus
) {

876  
video_bus
->
video_·¿m
.
e_video_¡ªd¬d
;

879  
TW_ERR
;

880 
	}
}

882 
	$video_bus_£t_video_¡ªd¬d
(
tw_video_bus_t
 *
video_bus
, 
video_¡ªd¬d
)

884 
»t
 = 
TW_ERR
;

886 if(
video_bus
) {

887 
video_¡ªd¬d
) {

888 
TW_VIDEO_STANDARD_PAL
:

889 
TW_VIDEO_STANDARD_NTSC
:

890 
»t
 = 
TW_OK
;

892 
TW_VIDEO_STANDARD_USER_DEFINE
:

894 
	`TW_DBG
(
TW_DBG_ERR
, "Thi videØ¡ªd¬d '%d'‚Ù suµÜt!\n", 
video_¡ªd¬d
);

895 
»t
 = -
EINVAL
;

898 if(
»t
 =ğ
TW_OK
) {

899 
tw5864_vd_üoss_bus_t
 *
vd_bus_driv”
;

901 
	`TW_DBG
(
TW_DBG_DEBUG
, "upd©videØ¡ªd¬dØ%d\n", 
video_¡ªd¬d
);

902 
video_bus
->
video_·¿m
.
e_video_¡ªd¬d
 = 
video_¡ªd¬d
;

905 
vd_bus_driv”
 = 
video_bus
->vd_bus_driver;

906 if(
vd_bus_driv”
 && vd_bus_driv”->
İ
) {

907 
»t
 = 
vd_bus_driv”
->
İ
->
	`»£t
(vd_bus_driver);

908 if(
»t
) {

909 
	`TW_DBG
(
TW_DBG_ERR
, "»£ˆvd_bu çed %d\n", 
»t
);

915  
»t
;

916 
	}
}

918 
	$video_bus_nÙify_logic_chª_chªge
(
tw_video_bus_t
 *
video_bus
)

920 
i
, 
logic_chª_id
, 
phy_video_ås
;

921 
tw_h264_phy_video_¦Ù_t
 *
phy_h264_¦Ù
;

922 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

923 
tw_j³g_phy_video_¦Ù_t
 *
phy_j³g_¦Ù
;

924 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

925 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

926 
ed_tcb_t
 *
logic_chª_ed
;

928 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

929 
tw_j³g_logic_’code_chª_t
 *
mjpg_logic_’code_chª
;

932 
phy_h264_¦Ù
 = 
video_bus
->
vd_bus_driv”
->
phy_video_¦Ù
;

933 
phy_j³g_¦Ù
 = 
video_bus
->
vj_bus_driv”
->
phy_video_¦Ù
;

934 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
phy_h264_¦Ù
++, 
phy_j³g_¦Ù
++) {

935 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

936 if(
logic_chª_bË
->
İ
) {

937 
phy_video_ås
 = 
phy_h264_¦Ù
->
üoss_bus_logic_video_¦Ù
->
İ
->
	`g‘_ås
(phy_h264_slot->cross_bus_logic_video_slot);

939 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

940 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

941 
logic_chª_id
 |ğ
TW_MASTER_BITSTREAM
;

942 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

943 if(
»gi¡”_node
) {

944 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

945 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_cÚfig
, *
h264_’code_cÚfig
 = &encode_config;

947 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

948 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
logic_chª_ed
);

949 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

950 
’code_cÚŒŞ
 = &
h264_logic_’code_chª
->encode_control;

952 
’code_cÚŒŞ
->
i_üossbus_ås
 = 
phy_video_ås
;

953 
	`mem£t
(
h264_’code_cÚfig
, 0, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

954 
h264_’code_cÚfig
->
videoSnd¬d
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

955 if(
video_bus
->
vd_bus_driv”
->
İ
->
	`g‘_wÜk_mode
(video_bus->vd_bus_driv”è=ğ
TW_CROSS_BUS_UNREALTIME
) {

956 if(
phy_video_ås
 < 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property)) {

957 
h264_’code_cÚfig
->
ås
 = 
phy_video_ås
;

959 
h264_’code_cÚfig
->
ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

962 
h264_’code_cÚfig
->
ås
 = 
phy_video_ås
;

964 
h264_’code_cÚfig
->
’codeSize
 = 
phy_h264_¦Ù
->
İ
->
	`g‘_video_size
(phy_h264_slot);

965 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈ%dƒncodvideØsizchªgedØ%d\n",
h264_logic_’code_chª
->
logic_chª_id
, 
h264_’code_cÚfig
->
’codeSize
);

966 
h264_’code_cÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
 | 
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
 | 
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

967 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, 
h264_’code_cÚfig
);

971 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

972 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

973 
logic_chª_id
 |ğ
TW_SUB_BITSTREAM
;

974 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

975 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

976 if(
»gi¡”_node
) {

977 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

978 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_cÚfig
, *
h264_’code_cÚfig
 = &encode_config;

980 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

981 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
logic_chª_ed
);

982 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

983 
’code_cÚŒŞ
 = &
h264_logic_’code_chª
->encode_control;

985 
’code_cÚŒŞ
->
i_üossbus_ås
 = 
phy_video_ås
;

986 
	`mem£t
(
h264_’code_cÚfig
, 0, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

987 
h264_’code_cÚfig
->
videoSnd¬d
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

988 if(
video_bus
->
vd_bus_driv”
->
İ
->
	`g‘_wÜk_mode
(video_bus->vd_bus_driv”è=ğ
TW_CROSS_BUS_UNREALTIME
) {

989 if(
phy_video_ås
 < 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property)) {

990 
h264_’code_cÚfig
->
ås
 = 
phy_video_ås
;

992 
h264_’code_cÚfig
->
ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

995 
h264_’code_cÚfig
->
ås
 = 
phy_video_ås
;

997 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈ%dƒncodvideØsizchªgedØ%d\n",
h264_logic_’code_chª
->
logic_chª_id
, 
h264_’code_cÚfig
->
’codeSize
);

998 
h264_’code_cÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
 | 
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

999 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, 
h264_’code_cÚfig
);

1004 
logic_chª_id
 = 
phy_j³g_¦Ù
->
phy_¦Ù_id
;

1005 
logic_chª_bË
 = &
phy_j³g_¦Ù
->logic_chan_table;

1006 if(
logic_chª_bË
->
İ
) {

1007 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

1008 if(
»gi¡”_node
) {

1009 
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
;

1010 
tw_mj³g_’code_·¿m_t
 *
j³g_’code_cÚfig
;

1012 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

1013 
mjpg_logic_’code_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_logic_chª_ed
(
logic_chª_ed
);

1014 
’code_´İ”ty
 = &
mjpg_logic_’code_chª
->encode_property;

1015 
j³g_’code_cÚfig
 = &
’code_´İ”ty
->encode_property;

1016 
j³g_’code_cÚfig
->
chªge_mask_æag
 |ğ
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
 | 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
;

1021  
TW_OK
;

1022 
	}
}

1024 
	$video_bus_nÙify_su¥’d_logic_chª
(
tw_video_bus_t
 *
video_bus
)

1026 if(
video_bus
) {

1027 
i
, 
logic_chª_id
;

1028 
tw_h264_phy_video_¦Ù_t
 *
phy_h264_¦Ù
;

1029 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

1030 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

1031 
ed_tcb_t
 *
logic_chª_ed
;

1034 
phy_h264_¦Ù
 = 
video_bus
->
vd_bus_driv”
->
phy_video_¦Ù
;

1035 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
phy_h264_¦Ù
++) {

1036 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

1037 if(
logic_chª_bË
->
İ
) {

1039 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

1040 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

1041 
logic_chª_id
 |ğ
TW_MASTER_BITSTREAM
;

1042 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

1043 if(
»gi¡”_node
) {

1044 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

1048 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

1049 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

1050 
logic_chª_id
 |ğ
TW_SUB_BITSTREAM
;

1051 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

1052 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

1053 if(
»gi¡”_node
) {

1054 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

1060  
TW_OK
;

1063  -
EINVAL
;

1064 
	}
}

1066 
	$video_bus_nÙify_»sume_logic_chª
(
tw_video_bus_t
 *
video_bus
)

1068 if(
video_bus
) {

1069 
i
, 
logic_chª_id
;

1070 
tw_h264_phy_video_¦Ù_t
 *
phy_h264_¦Ù
;

1071 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

1072 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

1073 
ed_tcb_t
 *
logic_chª_ed
;

1076 
phy_h264_¦Ù
 = 
video_bus
->
vd_bus_driv”
->
phy_video_¦Ù
;

1077 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
phy_h264_¦Ù
++) {

1079 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

1080 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

1081 
logic_chª_id
 |ğ
TW_MASTER_BITSTREAM
;

1082 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

1083 if(
logic_chª_bË
->
İ
) {

1084 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

1085 if(
»gi¡”_node
) {

1089 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

1093 
logic_chª_id
 = 
phy_h264_¦Ù
->
phy_¦Ù_id
;

1094 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

1095 
logic_chª_id
 |ğ
TW_SUB_BITSTREAM
;

1096 
logic_chª_bË
 = &
phy_h264_¦Ù
->
İ’ed_logic_chª_bË
;

1097 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

1098 if(
»gi¡”_node
) {

1099 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

1105  
TW_OK
;

1108  -
EINVAL
;

1109 
	}
}

1111 
video_bus_İ”©iÚ
 
	gvideo_bus_İ
 = {

1112 .
š™
 = 
video_bus_š™
,

1113 .
	g»Ëa£
 = 
video_bus_»Ëa£
,

1114 .
	g»£t
 = 
video_bus_»£t
,

1116 .
	gg‘_video_¡ªd¬d
 = 
video_bus_g‘_video_¡ªd¬d
,

1117 .
	g£t_video_¡ªd¬d
 = 
video_bus_£t_video_¡ªd¬d
,

1118 .
	gnÙify_logic_chª_chªge
 = 
video_bus_nÙify_logic_chª_chªge
,

1119 .
	gnÙify_su¥’d_logic_chª
 = 
video_bus_nÙify_su¥’d_logic_chª
,

1120 .
	gnÙify_»sume_logic_chª
 = 
video_bus_nÙify_»sume_logic_chª
,

1123 
	$š™_video_bus
(
tw_video_bus_t
 *
video_bus
, 
dvm_ch_t
 *
ch
)

1125 if(
video_bus
 && 
ch
) {

1126 
video_bus
->
İ
 = &
video_bus_İ
;

1127  
video_bus
->
İ
->
	`š™
(video_bus, 
ch
);

1130  
TW_ERR
;

1131 
	}
}

1133 
	$audio_bus_š™
(
tw_audio_bus_t
 *
audio_bus
, 
dvm_ch_t
 *
ch
)

1135 
»t
 = 
TW_ERR
;

1137 if(
audio_bus
 && 
ch
) {

1138 
audio_bus
->
ch_audio_driv”
 = &
ch
->
ch_audio
;

1140 
»t
 = 
	`š™_ch_audio
(&
ch
->
ch_audio
, ch, ch->
bus_id
);

1141 if(
»t
 !ğ
TW_OK
) {

1142 
	`TW_DBG
(
TW_DBG_ERR
, "š™‡udiØ”rÜ 0x%08x\n", 
»t
);

1143  
»t
;

1146  
TW_OK
;

1149  
TW_ERR
;

1150 
	}
}

1152 
	$audio_bus_»Ëa£
(
tw_audio_bus_t
 *
audio_bus
)

1154 if(
audio_bus
) {

1155 
	`»move_ch_audio
(
audio_bus
->
ch_audio_driv”
);

1157 
	}
}

1159 
	$audio_bus_»£t
(
tw_audio_bus_t
 *
audio_bus
)

1161 if(
audio_bus
) {

1162  
TW_OK
;

1165  
TW_ERR
;

1166 
	}
}

1168 
audio_bus_İ”©iÚ
 
	gaudio_bus_İ
 = {

1169 .
š™
 = 
audio_bus_š™
,

1170 .
	g»Ëa£
 = 
audio_bus_»Ëa£
,

1171 .
	g»£t
 = 
audio_bus_»£t
,

1174 
	$š™_audio_bus
(
tw_audio_bus_t
 *
audio_bus
, 
dvm_ch_t
 *
ch
)

1176 if(
audio_bus
 && 
ch
) {

1177 
audio_bus
->
İ
 = &
audio_bus_İ
;

1178  
audio_bus
->
İ
->
	`š™
×udio_bus, 
ch
);

1181  
TW_ERR
;

1182 
	}
}

1184 
	$tw_logic_phy_m­_bË_š™
(
tw_logic_phy_bË_t
 *
bË
)

1186 if(
bË
) {

1187 
ty³
, 
i
;

1188 
tw_logic_m­_bË_t
 *
logic_lbe
;

1190 
	`¥š_lock_š™
(&
bË
->
lock
);

1191 
ty³
 = 0;y³ < 
LOGIC_MAP_TABLE_BIND_RESERVED
;ype++) {

1192 
logic_lbe
 = (
tw_logic_m­_bË_t
 *)
	`km®loc
((tw_logic_map_table_t)

1193 + (*
logic_lbe
->
m­_bË
è* (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1),

1194 
GFP_KERNEL
);

1195 if(!
logic_lbe
) {

1196 
	`TW_DBG
(
TW_DBG_ERR
, "no memory for†ogic mapable\n");

1197 
”rÜ_»Ëa£
;

1199 
logic_lbe
->
e_bšd_ty³
 = 
ty³
;

1200 
logic_lbe
->
i_chª_numb”
 = 
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1;

1201 
i
 = 0; i < 
logic_lbe
->
i_chª_numb”
; i++) {

1202 
logic_lbe
->
m­_bË
[
i
].
logic_¦Ù_id
 = i;

1203 
logic_lbe
->
m­_bË
[
i
].
phy_¦Ù_id
 = i;

1205 
bË
->
logic_lbe
[
ty³
] =†ogic_talbe;

1208  
TW_OK
;

1210 
”rÜ_»Ëa£
:

1211 if(
bË
->
İ
->
»Ëa£
) {

1212 
bË
->
İ
->
	`»Ëa£
(table);

1215  
TW_ERR
;

1216 
	}
}

1218 
	$tw_logic_phy_m­_bË_»£t
(
tw_logic_phy_bË_t
 *
bË
)

1220 if(
bË
) {

1221 
ty³
, 
i
;

1222 
æags
;

1223 
tw_logic_m­_bË_t
 *
logic_lbe
;

1225 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1226 
ty³
 = 0;y³ < 
LOGIC_MAP_TABLE_BIND_RESERVED
;ype++) {

1227 
logic_lbe
 = 
bË
->logic_lbe[
ty³
];

1228 
logic_lbe
->
e_bšd_ty³
 = 
ty³
;

1229 
logic_lbe
->
i_chª_numb”
 = 
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1;

1230 
i
 = 0; i < 
logic_lbe
->
i_chª_numb”
; i++) {

1231 
logic_lbe
->
m­_bË
[
i
].
logic_¦Ù_id
 = i;

1232 
logic_lbe
->
m­_bË
[
i
].
phy_¦Ù_id
 = i;

1235 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1237  
TW_OK
;

1240  
TW_ERR
;

1241 
	}
}

1243 
	$tw_logic_phy_m­_bË_»Ëa£
(
tw_logic_phy_bË_t
 *
bË
)

1245 if(
bË
) {

1246 
ty³
;

1247 
æags
;

1248 
tw_logic_m­_bË_t
 *
logic_bË
;

1250 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1251 
ty³
 = 0;y³ < 
LOGIC_MAP_TABLE_BIND_RESERVED
;ype++) {

1252 
logic_bË
 = 
bË
->
logic_lbe
[
ty³
];

1253 if(
logic_bË
) {

1254 
	`kä“
(
logic_bË
);

1256 
bË
->
logic_lbe
[
ty³
] = 
NULL
;

1258 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1260  
TW_OK
;

1263  
TW_ERR
;

1264 
	}
}

1266 
	$tw_logic_phy_m­_bË_fšd_logic_by_phy
(
tw_logic_phy_bË_t
 *
bË
, 
LOGIC_MAP_TABLE_TYPE
 
ty³
, 
u32
 
phy_¦Ù_id
, u32 *
logic_¦Ù_id
)

1268 if(
bË
 && 
logic_¦Ù_id
) {

1269 
i
;

1270 
æags
;

1271 
tw_logic_m­_bË_t
 *
logic_bË
;

1273 if((
ty³
 < 0è|| (ty³ >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
)) {

1274 
	`TW_DBG
(
TW_DBG_ERR
, "m­abËy³ %dƒ¼Ü\n", 
ty³
);

1275  -
EINVAL
;

1278 
logic_bË
 = 
bË
->
logic_lbe
[
ty³
];

1279 if(
phy_¦Ù_id
 >ğ
logic_bË
->
i_chª_numb”
) {

1280 
	`TW_DBG
(
TW_DBG_ERR
, "phy slÙ id %d ov”æow\n", 
phy_¦Ù_id
);

1281  -
EINVAL
;

1283 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1284 
i
 = 0; i < 
logic_bË
->
i_chª_numb”
; i++) {

1285 if(
logic_bË
->
m­_bË
[
i
].
phy_¦Ù_id
 ==…hy_slot_id) {

1286 *
logic_¦Ù_id
 = 
logic_bË
->
m­_bË
[
i
].logic_slot_id;

1287 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1288  
TW_OK
;

1291 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1292 
	`TW_DBG
(
TW_DBG_ERR
, "nØsuch…hy_¦Ù_id = %d, iÀbËy³ %d\n", 
phy_¦Ù_id
, 
ty³
);

1293  -
ENODATA
;

1296 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1298  
TW_ERR
;

1299 
	}
}

1301 
	$tw_logic_phy_m­_bË_fšd_phy_by_logic
(
tw_logic_phy_bË_t
 *
bË
, 
LOGIC_MAP_TABLE_TYPE
 
ty³
, 
u32
 
logic_¦Ù_id
, u32 *
phy_¦Ù_id
)

1303 if(
bË
 && 
phy_¦Ù_id
) {

1304 
i
;

1305 
æags
;

1306 
tw_logic_m­_bË_t
 *
logic_bË
;

1308 if((
ty³
 < 0è|| (ty³ >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
)) {

1309 
	`TW_DBG
(
TW_DBG_ERR
, "m­abËy³ %dƒ¼Ü\n", 
ty³
);

1310  -
EINVAL
;

1313 
logic_bË
 = 
bË
->
logic_lbe
[
ty³
];

1314 if(
logic_¦Ù_id
 >ğ
logic_bË
->
i_chª_numb”
) {

1315 
	`TW_DBG
(
TW_DBG_ERR
, "phy slÙ id %d ov”æow\n", 
logic_¦Ù_id
);

1316  -
EINVAL
;

1318 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1319 
i
 = 0; i < 
logic_bË
->
i_chª_numb”
; i++) {

1320 if(
logic_bË
->
m­_bË
[
i
].
logic_¦Ù_id
 ==†ogic_slot_id) {

1321 *
phy_¦Ù_id
 = 
logic_bË
->
m­_bË
[
i
].phy_slot_id;

1322 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1323  
TW_OK
;

1326 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1327 
	`TW_DBG
(
TW_DBG_ERR
, "nØsuch†ogic_¦Ù_id = %d, iÀbËy³ %d\n", 
logic_¦Ù_id
, 
ty³
);

1328  -
ENODATA
;

1331 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1333  
TW_ERR
;

1334 
	}
}

1336 
	$tw_logic_phy_m­_bË_upd©e_m­_bË
(
tw_logic_phy_bË_t
 *
bË
, 
LOGIC_MAP_TABLE_TYPE
 
ty³
, 
tw_logic_m­_bË_t
 *
Ãw_logic_bË
)

1338 if(
bË
 && 
Ãw_logic_bË
) {

1339 
i
, 
j
;

1340 
æags
;

1341 
tw_logic_m­_bË_t
 *
logic_bË
;

1343 if((
ty³
 < 0è|| (ty³ >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
)) {

1344 
	`TW_DBG
(
TW_DBG_ERR
, "m­abËy³ %dƒ¼Ü\n", 
ty³
);

1345  -
EINVAL
;

1347 if(
Ãw_logic_bË
->
i_chª_numb”
 > (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1)) {

1348 
	`TW_DBG
(
TW_DBG_ERR
, "špuˆlogiøchªÃÈnumb” %d ov”æow\n", 
Ãw_logic_bË
->
i_chª_numb”
);

1349  -
EINVAL
;

1352 
i
 = 0; i < 
Ãw_logic_bË
->
i_chª_numb”
; i++) {

1353 
j
 = 0; j < 
Ãw_logic_bË
->
i_chª_numb”
; j++) {

1354 if((
i
 !ğ
j
è&& (
Ãw_logic_bË
->
m­_bË
[i].
logic_¦Ù_id
 ==‚ew_logic_table->map_table[j].logic_slot_id)) {

1355 
	`TW_DBG
(
TW_DBG_ERR
, "»³©†ogic_¦Ù_id %d\n", 
Ãw_logic_bË
->
m­_bË
[
i
].
logic_¦Ù_id
);

1356  -
EINVAL
;

1360 
i
 = 0; i < 
Ãw_logic_bË
->
i_chª_numb”
; i++) {

1361 
j
 = 0; j < 
Ãw_logic_bË
->
i_chª_numb”
; j++) {

1362 if((
i
 !ğ
j
è&& (
Ãw_logic_bË
->
m­_bË
[i].
phy_¦Ù_id
 ==‚ew_logic_table->map_table[j].phy_slot_id)) {

1363 
	`TW_DBG
(
TW_DBG_ERR
, "»³©…hy_¦Ù_id %d\n", 
Ãw_logic_bË
->
m­_bË
[
i
].
phy_¦Ù_id
);

1364  -
EINVAL
;

1369 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1370 
logic_bË
 = 
bË
->
logic_lbe
[
ty³
];

1371 
logic_bË
->
i_chª_numb”
 = 
Ãw_logic_bË
->i_chan_number;

1372 
i
 = 0; i < 
logic_bË
->
i_chª_numb”
; i++) {

1373 
logic_bË
->
m­_bË
[
i
].
logic_¦Ù_id
 = 
Ãw_logic_bË
->map_table[i].logic_slot_id;

1374 
logic_bË
->
m­_bË
[
i
].
phy_¦Ù_id
 = 
Ãw_logic_bË
->map_table[i].phy_slot_id;

1376 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1378  
TW_OK
;

1381 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1383  
TW_ERR
;

1384 
	}
}

1387 
	$tw_logic_phy_m­_bË_g‘_m­_bË
(
tw_logic_phy_bË_t
 *
bË
, 
LOGIC_MAP_TABLE_TYPE
 
ty³
, 
tw_logic_m­_bË_t
 *
Ãw_logic_bË
)

1389 if(
bË
 && 
Ãw_logic_bË
) {

1390 
i
;

1391 
æags
;

1392 
tw_logic_m­_bË_t
 *
logic_bË
;

1394 if((
ty³
 < 0è|| (ty³ >ğ
LOGIC_MAP_TABLE_BIND_RESERVED
)) {

1395 
	`TW_DBG
(
TW_DBG_ERR
, "m­abËy³ %dƒ¼Ü\n", 
ty³
);

1396  -
EINVAL
;

1398 if(
Ãw_logic_bË
->
i_chª_numb”
 > (
	`H264_MAX
(
TW5864_PHY_VD_CHAN_NUMBER
, 
TW_AUDIO_OUT_PLAYBACK_ID
) + 1)) {

1399 
	`TW_DBG
(
TW_DBG_ERR
, "špuˆlogiøchªÃÈnumb” %d ov”æow\n", 
Ãw_logic_bË
->
i_chª_numb”
);

1400  -
EINVAL
;

1403 
	`¥š_lock_œq§ve
(&
bË
->
lock
, 
æags
);

1404 
logic_bË
 = 
bË
->
logic_lbe
[
ty³
];

1405 
logic_bË
->
i_chª_numb”
 = 
Ãw_logic_bË
->i_chan_number;

1406 
i
 = 0; i < 
logic_bË
->
i_chª_numb”
; i++) {

1407 
Ãw_logic_bË
->
m­_bË
[
i
].
logic_¦Ù_id
 = 
logic_bË
->map_table[i].logic_slot_id;

1408 
Ãw_logic_bË
->
m­_bË
[
i
].
phy_¦Ù_id
 = 
logic_bË
->map_table[i].phy_slot_id;

1410 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
lock
, 
æags
);

1412  
TW_OK
;

1415 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1417  
TW_ERR
;

1418 
	}
}

1420 
tw_logic_phy_İ”©iÚ_t
 
	gtw_logic_phy_İ”©iÚ_İs
 = {

1421 .
š™
 = 
tw_logic_phy_m­_bË_š™
,

1422 .
	g»£t
 = 
tw_logic_phy_m­_bË_»£t
,

1423 .
	g»Ëa£
 = 
tw_logic_phy_m­_bË_»Ëa£
,

1425 .
	gfšd_logic_by_phy
 = 
tw_logic_phy_m­_bË_fšd_logic_by_phy
,

1426 .
	gfšd_phy_by_logic
 = 
tw_logic_phy_m­_bË_fšd_phy_by_logic
,

1427 .
	gupd©e_m­_bË
 = 
tw_logic_phy_m­_bË_upd©e_m­_bË
,

1428 .
	gg‘_m­_bË
 = 
tw_logic_phy_m­_bË_g‘_m­_bË
,

1431 
	$ch_driv”_nÙify
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
tw_nÙify_msg
 *
msg
)

1433 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

1436 
	}
}

1438 
	$ch_driv”_m©ch_»gs™”_node_´iv_id
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
id
)

1440 if(
node
 && 
´iv
) {

1441  
TW_OK
;

1444  
TW_ERR
;

1445 
	}
}

1447 
	$ch_driv”_š™
(
ch_driv”_t
 *
driv”
)

1449 
»t
 = 
TW_ERR
;

1451 if(
driv”
) {

1452 
dvm_ch_t
 *
ch
;

1453 
tw_video_bus_t
 *
video_bus
;

1454 
tw_audio_bus_t
 *
audio_bus
;

1455 
tw_logic_phy_bË_t
 *
m­_bË
;

1456 
ed_tcb_t
 *
ed
;

1458 
ch
 = 
driv”
->chip;

1460 
video_bus
 = &
driv”
->video_bus;

1461 
audio_bus
 = &
driv”
->audio_bus;

1462 
ed
 = &
driv”
->
İ’ed_cÚŒŞ_ed
;

1464 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

1465 
	`š™_’dpošt_tcb
(
ed
, 
ch
->
bus_id
, ch->
ch_id
,

1466 
TW_ED_CONTROL
, 0, 0,

1467 
driv”
, 
ch_driv”_nÙify
,

1468 
ch_driv”_m©ch_»gs™”_node_´iv_id
, 
NULL
);

1470 
ed
->
İ
 = &
ch_driv”_hcd_š‹rçû_İ
;

1471 
»t
 = 
	`š™_audio_bus
(
audio_bus
, 
ch
);

1472 if(
»t
 !ğ
TW_OK
) {

1473 
	`TW_DBG
(
TW_DBG_ERR
, "š™‡udiØbu ”rÜ 0x%08x\n", 
»t
);

1474  
»t
;

1477 
»t
 = 
	`š™_video_bus
(
video_bus
, 
ch
);

1478 if(
»t
 !ğ
TW_OK
) {

1479 
	`TW_DBG
(
TW_DBG_ERR
, "š™ videØbu ”rÜ 0x%08x\n", 
»t
);

1480  
»t
;

1482 
m­_bË
 = &
driv”
->
logic_m­_phy
;

1483 
m­_bË
->
İ
 = &
tw_logic_phy_İ”©iÚ_İs
;

1484 
m­_bË
->
İ
->
	`š™
(map_table);

1486  
TW_OK
;

1489  
TW_ERR
;

1490 
	}
}

1492 
	$ch_driv”_»Ëa£
(
ch_driv”_t
 *
driv”
)

1494 if(
driv”
) {

1495 
tw_video_bus_t
 *
video_bus
;

1496 
tw_audio_bus_t
 *
audio_bus
;

1497 
tw_logic_phy_bË_t
 *
m­_bË
;

1499 
video_bus
 = &
driv”
->video_bus;

1500 
audio_bus
 = &
driv”
->audio_bus;

1501 
m­_bË
 = &
driv”
->
logic_m­_phy
;

1503 if(
video_bus
->
İ
) {

1504 
video_bus
->
İ
->
	`»Ëa£
(video_bus);

1506 if(
audio_bus
->
İ
) {

1507 
audio_bus
->
İ
->
	`»Ëa£
(audio_bus);

1509 if(
m­_bË
->
İ
) {

1510 
m­_bË
->
İ
->
	`»Ëa£
(map_table);

1513 
	}
}

1515 
	$ch_driv”_»£t
(
ch_driv”_t
 *
driv”
)

1517 
»t
 = 
TW_ERR
;

1518 if(
driv”
) {

1519 
tw_video_bus_t
 *
video_bus
;

1520 
tw_audio_bus_t
 *
audio_bus
;

1521 
tw_logic_phy_bË_t
 *
m­_bË
;

1523 
video_bus
 = &
driv”
->video_bus;

1524 
audio_bus
 = &
driv”
->audio_bus;

1525 
m­_bË
 = &
driv”
->
logic_m­_phy
;

1527 if(
video_bus
->
İ
) {

1528 
»t
 = 
video_bus
->
İ
->
	`»£t
(video_bus);

1529 if(
»t
) {

1530 
	`TW_DBG
(
TW_DBG_ERR
, "reset video bus failed\n");

1531  
»t
;

1535 if(
audio_bus
->
İ
) {

1536 
»t
 = 
audio_bus
->
İ
->
	`»£t
(audio_bus);

1537 if(
»t
) {

1538 
	`TW_DBG
(
TW_DBG_ERR
, "reset‡udio bus failed\n");

1539  
»t
;

1542 if(
m­_bË
->
İ
) {

1543 
m­_bË
->
İ
->
	`»£t
(map_table);

1547  
»t
;

1548 
	}
}

1550 
ch_driv”_İ”©iÚ
 
	gch_driv”_İ
 = {

1551 .
š™
 = 
ch_driv”_š™
,

1552 .
	g»Ëa£
 = 
ch_driv”_»Ëa£
,

1553 .
	g»£t
 = 
ch_driv”_»£t
,

1556 
	$š™_ch_driv”
(
tw_ch_deviû
 * 
tcd
, 
tw_ch_driv”
 * 
drv
)

1558 
»t
 = 0;

1559 
dvm_ch_t
 *
ch
 = 
	`tcd_´iv
(
tcd
);

1560 
ch_driv”_t
 *
driv”
;

1562 
tc_Œaû
;

1563 
driv”
 = (
ch_driv”_t
 *)
	`km®loc
((ch_driv”_t),
GFP_KERNEL
);

1564 if(
driv”
) {

1565 if(
ch
) {

1566 
driv”
->
ch
 = chip;

1567 
driv”
->
İ
 = &
ch_driv”_İ
;

1568 
ch
->
ch_driv”
 = 
driv”
;

1570 
»t
 = 
driv”
->
İ
->
	`š™
(driver);

1571 if(
»t
){

1572 
	`´štk
("error while init!\n");

1573  -
ENOMEM
;

1575 
tcd
->
³d
 = &
driv”
->
İ’ed_cÚŒŞ_ed
;

1576  
TW_OK
;

1578 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1579  -
EINVAL
;

1582 
	`TW_DBG
(
TW_DBG_ERR
, "no memory\n");

1583  -
ENOMEM
;

1586  
TW_ERR
;

1587 
	}
}

1589 
	$»move_ch_driv”
(
tw_ch_deviû
 * 
tcd
, 
tw_ch_driv”
 * 
drv
)

1591 
ch_driv”_t
 *
driv”
;

1593 if(
tcd
 &&cd->
³d
) {

1594 
driv”
 = 
	`to_g‘_ch_driv”_w™h_İ’ed_logic_chª_ed
(
tcd
->
³d
);

1595 
driv”
->
İ
->
	`»Ëa£
(driver);

1596 
	`kä“
(
driv”
);

1597 
tcd
->
³d
 = 
NULL
;

1599 
	}
}

1616 
	$ch5864_©ch
(
tw_ch_driv”
 *
drv
,
tw_ch_deviû
 *
±cd
)

1618 
tw_dev_bË_id
 *
driv_id
 = &
drv
->
deviû_id
;

1619 
•obj_t
 *
•
 = &
driv_id
->
tid
->
•obj
;

1620 
tcd_driv”_İ”©iÚs
 *
to
 = (tcd_driv”_İ”©iÚ *)
driv_id
->
İs
;

1622 
	`´štk
("--->funùiÚ % ÿÎed\n",
__FUNCTION__
);

1623  
to
->
	`š™
(
±cd
,
drv
);

1624 
	}
}

1626 
	$ch5864_d‘ach
(
tw_ch_driv”
 *
drv
,
tw_ch_deviû
 *
±cd
)

1628 
tw_dev_bË_id
 *
driv_id
 = &
drv
->
deviû_id
;

1629 
•obj_t
 *
•
 = &
driv_id
->
tid
->
•obj
;

1630 
tcd_driv”_İ”©iÚs
 *
tİ
 = (tcd_driv”_İ”©iÚ *)
driv_id
->
İs
;

1632 
	`´štk
("--->funùiÚ % ÿÎed\n",
__FUNCTION__
);

1633 if(!
tİ
->
»move
){

1634 
	`´štk
("chip driv has‚o„move\n");

1635  -
EINVAL
;

1637 
tİ
->
	`»move
(
±cd
,
drv
);

1639 
	}
}

1641 
	$ch5864_commªd
(
tw_ch_deviû
 *
±cd
,
cmd
, *
cmd_¬g
)

1643 
»t
 = 0;

1646  
»t
;

1647 
	}
}

1653 
tw_dev_id
 
	gtw5864_ch_dev_id
 =

1655 .
•obj
 = {

1656 .
v’dÜ_id
 = 
TWELL
,

1657 .
	gbus_id
 = 1,

1658 .
	gch_id
 = 
TW5864
,

1660 .
	gv”siÚ
 = 1,

1664 
tcd_driv”_İ”©iÚs
 
	gtw_5864_ch_İs
 =

1666 .
š™
 = 
š™_ch_driv”
,

1667 .
	g»move
 = 
»move_ch_driv”
,

1670 
tw_ch_driv”
 
	gtw_5864_ch_driv
 =

1672 .
driv”
 = {

1673 .
Çme
 = "tw5864_chip_driv",

1675 .
	gdeviû_id
 = {

1676 .
tid
 = &
tw5864_ch_dev_id
,

1677 .
	gİs
 = &
tw_5864_ch_İs
,

1679 .
	g©ch_ch
 = 
ch5864_©ch
,

1680 .
	gd‘ach_ch
 = 
ch5864_d‘ach
,

1681 .
	gcommªd
 = 
ch5864_commªd
,

1686 
	$tw5864_ch_driv”_š™
()

1688 
•key_t
 
key
 = {0};

1689 
tw_dev_bË_id
 *
bË_id
 = &
tw_5864_ch_driv
.
deviû_id
;

1690 
tw_dev_id
 *
id
 = 
	`kz®loc
((tw_dev_id),
GFP_KERNEL
);

1691 if(!
id
)

1694 
	`make_key
((
•key_t
 *)&
key
,0,0,0,0,0,0);

1695 
	`•obj_š™
(&
id
->
•obj
, 
TWELL
, 1,
TW5864
,0,0,&
key
);

1696 
bË_id
->
tid
 = 
id
;

1697  
	`»gi¡”_ch_driv”
(&
tw_5864_ch_driv
);

1698 
	}
}

1700 
	$tw5864_ch_driv”_»move
()

1702 
	`uÄegi¡”_ch_driv”
(&
tw_5864_ch_driv
);

1703 
	}
}

	@../../tw5864/tw5864/tw_chip_vi.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#TW_VI_EVENT_IRQ
 0

	)

5 
tw_ch_vi_ã©u»_t
 
	gdeçuÉ_vi_ã©u»
 = {

6 .
e_mÙiÚ_mode
 = 
MOTION_TRIGGER_AUTIO
,

7 .
	gi_mÙiÚ_£ns™ive
 = 
CHIP_VI_EVENT_MIN_SENSITIVE
,

8 .
	gi_night_£ns™ive
 = 
CHIP_VI_EVENT_MIN_SENSITIVE
,

9 .
	gi_blšd_£ns™ive
 = 
CHIP_VI_EVENT_MIN_SENSITIVE
,

11 .
	gb_novideo_’abË
 = 
TW_VI_FEATURE_ON
,

12 .
	gb_und”æow_’abË
 = 
TW_VI_FEATURE_OFF
,

13 .
	gb_ov”æow_’abË
 = 
TW_VI_FEATURE_OFF
,

14 .
	gchªge_mask
 = 
TW_VI_FEATURE_ENABLE_CHANGE_MASK_ALL
,

17 
tw_ch_vi_´İ”ty_t
 
	gdeçuÉ_video_´İ”ty
 = {

18 .
u32BrighŠess
 = 
DEFAULT_VI_BRIGHTNESS
,

19 .
	gu32CÚŒa¡
 = 
DEFAULT_VI_CONTRAST
,

20 .
	gu32Hue
 = 
DEFAULT_VI_HUE
,

21 .
	gu32S©u¿tiÚ
 = 
DEFAULT_VI_SATURATION
,

22 .
	gu32Sh¬²ess
 = 
DEFAULT_VI_SHARPNESS
,

23 .
	gu32Mask
 = 0xff,

26 
tw_ch_ev’t_mask
(
tw_ch_vi_driv”_t
 *, 
CHIP_VI_EVENT
, 
u32
 , );

28 
	$ch_vi_driv”_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
İ’ed_ed
)

30 
»t
 = 
TW_ERR
;

32 if(
İ’ed_ed
) {

33 
tw_ch_vi_driv”_t
 *
driv”
;

35 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

36 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
)){

38 
TW_ED_UNREGISTER
:

39 
TW_ED_CLOSED
:

40 if(
İ’ed_ed
->
ed
.
İ
) {

41 
İ’ed_ed
->
ed
.
İ
->
	`š™_com¶‘e
(&opened_ed->ed);

43 
	`TW_DBG
(
TW_DBG_FATAL
, "driver‚ot init\n");

44  -
EPERM
;

46 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 1);

47 
»t
 = 0;

49 
TW_ED_IDLE
:

50 
TW_ED_STANDBY
:

51 
TW_ED_SUSPEND
:

52 
TW_ED_RUNNING
:

53 
»t
 = -
EBUSY
;

54 
	`TW_DBG
(
TW_DBG_ERR
, "chip vi driver have been opened\n");

59  
»t
;

60 
	}
}

62 
	$ch_vi_driv”_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
İ’ed_ed
)

64 
»t
 = 
TW_ERR
;

66 if(
İ’ed_ed
) {

67 
tw_ch_vi_driv”_t
 *
driv”
;

69 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

70 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
)){

72 
TW_ED_UNREGISTER
:

73 
TW_ED_CLOSED
:

74 
»t
 = 0;

75 
	`TW_DBG
(
TW_DBG_INFO
, "chip control have been close\n");

77 
TW_ED_IDLE
:

78 
TW_ED_STANDBY
:

79 
TW_ED_SUSPEND
:

80 
TW_ED_RUNNING
:

81 if(
İ’ed_ed
->
ed
.
İ
 !ğ
NULL
){

82 
	`©omic_£t
(&
İ’ed_ed
->
¡©e
, 
TW_ED_CLOSED
);

83 
İ’ed_ed
->
ed
.
İ
->
	`com¶‘e_dÚe
(&opened_ed->ed);

84 
	`TW_DBG
(
TW_DBG_INFO
, "control complete doen\n");

85 
»t
 = 0;

87 
	`TW_DBG
(
TW_DBG_FATAL
, "control‚ode have‚ot inital!\n");

88 
»t
 = -
EACCES
;

90 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

95  
»t
;

96 
	}
}

98 
	$ch_vi_driv”_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
İ’ed_ed
)

100 if(
İ’ed_ed
) {

101 
tw_ch_vi_driv”_t
 *
driv”
;

103 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

104 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

106 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

112 
	}
}

114 
	$ch_vi_driv”_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
İ’ed_ed
)

116 if(
İ’ed_ed
) {

117 
tw_ch_vi_driv”_t
 *
driv”
;

119 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

120 if(
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

122 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

128 
	}
}

130 
	$ch_vi_driv”_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
İ’ed_ed
, 
cmd
, 
¬g
)

132 
»t
 = 
TW_ERR
;

134 if(
İ’ed_ed
) {

135 
tw_ch_vi_driv”_t
 *
driv”
;

136 
tw_ch_vi_cÚfig_´İ”ty_t
 *
video_´İ”ty
;

137 
tw_ch_vi_´İ”ty_t
 
´İ”ty
, *
p
 = &property;

138 
tw_ch_vi_ã©u»_t
 
ã©u»
, *
rã©u»
, *
pã©u»
 = &feature;

140 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
İ’ed_ed
);

142 if(!
	`©omic_»ad
(&
driv”
->
İ’ed_æag
)) {

143 
	`TW_DBG
(
TW_DBG_ERR
, "device have‚ot opened\n");

144  -
EPERM
;

147 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

148 
cmd
) {

149 
TW_VI_SET_VIDEO_AD_PARM
:

150 
	`cİy_äom_u£r
(
p
, (*)
¬g
, (
tw_ch_vi_´İ”ty_t
));

151 if(
p
->
u32ChªÃl
 >ğ
TW_VI_ON_CHIP_CHNL
) {

152 
	`TW_DBG
(
TW_DBG_ERR
, "v˜chªÃÈov”æow, oÆy suµÜˆTW_VI_MAX_CHNL = %d\n", 
TW_VI_ON_CHIP_CHNL
);

153 
»t
 = -
EINVAL
;

156 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
p
->
u32ChªÃl
];

157 if(
p
->
u32Mask
 & 
MASK_VI_BRIGHTNESS
) {

158 
»t
 = 
video_´İ”ty
->
İ
->
	`£t_brighŠess
(&video_´İ”ty->video_´İ”ty, 
p
->
u32BrighŠess
);

159 if(
»t
) {

163 if(
p
->
u32Mask
 & 
MASK_VI_CONTRAST
) {

164 
»t
 = 
video_´İ”ty
->
İ
->
	`£t_cÚŒa¡
(&video_´İ”ty->video_´İ”ty, 
p
->
u32CÚŒa¡
);

165 if(
»t
) {

169 if(
p
->
u32Mask
 & 
MASK_VI_SATURATION
) {

170 
»t
 = 
video_´İ”ty
->
İ
->
	`£t_§tu¿tiÚ
(&video_´İ”ty->video_´İ”ty, 
p
->
u32S©u¿tiÚ
);

171 if(
»t
) {

175 if(
p
->
u32Mask
 & 
MASK_VI_HUE
) {

176 
»t
 = 
video_´İ”ty
->
İ
->
	`£t_hue
(&video_´İ”ty->video_´İ”ty, 
p
->
u32Hue
);

177 if(
»t
) {

181 if(
p
->
u32Mask
 & 
MASK_VI_SHARPNESS
) {

182 
»t
 = 
video_´İ”ty
->
İ
->
	`£t_sh¬²ess
(&video_´İ”ty->video_´İ”ty, 
p
->
u32Sh¬²ess
);

183 if(
»t
) {

188 
video_´İ”ty
->video_´İ”ty.
u32Mask
 = 
p
->u32Mask;

189 if(
p
->
u32Mask
) {

190 
»t
 = 
video_´İ”ty
->
İ
->
	`upd©e
(
driv”
, video_property);

192 
»t
 = 
TW_OK
;

195 
TW_VI_GET_VIDEO_AD_PARM
:

196 
	`cİy_äom_u£r
(
p
, (*)
¬g
, (
tw_ch_vi_´İ”ty_t
));

197 if(
p
->
u32ChªÃl
 >ğ
TW_VI_ON_CHIP_CHNL
) {

198 
	`TW_DBG
(
TW_DBG_ERR
, "v˜chªÃÈov”æow, oÆy suµÜˆTW_VI_MAX_CHNL = %d\n", 
TW_VI_ON_CHIP_CHNL
);

199 
»t
 = -
EINVAL
;

202 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
p
->
u32ChªÃl
];

203 if(
p
->
u32Mask
 & 
MASK_VI_BRIGHTNESS
) {

204 
p
->
u32BrighŠess
 = 
video_´İ”ty
->
İ
->
	`g‘_brighŠess
(&video_property->video_property);

206 if(
p
->
u32Mask
 & 
MASK_VI_CONTRAST
) {

207 
p
->
u32CÚŒa¡
 = 
video_´İ”ty
->
İ
->
	`g‘_cÚŒa¡
(&video_property->video_property);

209 if(
p
->
u32Mask
 & 
MASK_VI_SATURATION
) {

210 
p
->
u32S©u¿tiÚ
 = 
video_´İ”ty
->
İ
->
	`g‘_§tu¿tiÚ
(&video_property->video_property);

212 if(
p
->
u32Mask
 & 
MASK_VI_HUE
) {

213 
p
->
u32Hue
 = 
video_´İ”ty
->
İ
->
	`g‘_hue
(&video_property->video_property);

215 if(
p
->
u32Mask
 & 
MASK_VI_SHARPNESS
) {

216 
p
->
u32Sh¬²ess
 = 
video_´İ”ty
->
İ
->
	`g‘_sh¬²ess
(&video_property->video_property);

218 if(
p
->
u32Mask
) {

219 
	`cİy_to_u£r
((*)
¬g
, 
p
, (
tw_ch_vi_´İ”ty_t
));

221 
»t
 = 
TW_OK
;

223 
TW_VI_GET_FEATURE
:

224 
	`cİy_äom_u£r
(
pã©u»
, (*)
¬g
, (
tw_ch_vi_ã©u»_t
));

225 if(
pã©u»
->
chªÃl
 < 
TW_VI_MAX_CHNL
) {

226 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
p
->
u32ChªÃl
];

227 
rã©u»
 = &
video_´İ”ty
->
video_ã©u»
;

228 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MODE_MASK
) {

229 
pã©u»
->
e_mÙiÚ_mode
 = 
rã©u»
->e_motion_mode;

231 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MOTION_MASK
) {

232 
pã©u»
->
i_mÙiÚ_£ns™ive
 = 
rã©u»
->i_motion_sensitive;

234 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NIGHT_MASK
) {

235 
pã©u»
->
i_night_£ns™ive
 = 
rã©u»
->i_night_sensitive;

237 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_BLIND_MASK
) {

238 
pã©u»
->
i_blšd_£ns™ive
 = 
rã©u»
->i_blind_sensitive;

240 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NOVIDEO_MASK
) {

241 
pã©u»
->
b_novideo_’abË
 = !!
rã©u»
->b_novideo_enable;

243 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_UNDERFLOW_MASK
) {

244 
pã©u»
->
b_und”æow_’abË
 = !!
rã©u»
->b_underflow_enable;

246 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_OVERFLOW_MASK
) {

247 
pã©u»
->
b_ov”æow_’abË
 = !!
rã©u»
->b_overflow_enable;

250 
	`TW_DBG
(
TW_DBG_ERR
, "channel‚umberƒrror\n");

251 
»t
 = -
EINVAL
;

254 
TW_VI_SET_FEATURE
:

255 
	`cİy_äom_u£r
(
pã©u»
, (*)
¬g
, (
tw_ch_vi_ã©u»_t
));

256 if(
pã©u»
->
chªÃl
 < 
TW_VI_MAX_CHNL
) {

257 
tw_ch_vi_cÚfig_´İ”ty_t
 
´İ”ty
;

259 
	`mem£t
(&
´İ”ty
, 0, (
tw_ch_vi_cÚfig_´İ”ty_t
));

260 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
p
->
u32ChªÃl
];

261 
rã©u»
 = &
´İ”ty
.
video_ã©u»
;

262 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MODE_MASK
) {

263 if((
pã©u»
->
e_mÙiÚ_mode
 >ğ
MOTION_TRIGGER_AUTIO
è|| (pã©u»->e_mÙiÚ_mod< 
MOTION_TRIGGER_RESERVED
)) {

264 
rã©u»
->
e_mÙiÚ_mode
 = 
pã©u»
->e_motion_mode;

266 
»t
 = -
EINVAL
;

267 
	`TW_DBG
(
TW_DBG_ERR
, "bad mÙiÚ mod%d\n", 
pã©u»
->
e_mÙiÚ_mode
);

271 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MOTION_MASK
) {

272 if((
pã©u»
->
i_mÙiÚ_£ns™ive
 >ğ
CHIP_VI_EVENT_MIN_SENSITIVE
è&& (Õã©u»->i_mÙiÚ_£ns™iv<ğ
CHIP_VI_EVENT_MAX_SENSITIVE
))) {

273 
rã©u»
->
i_mÙiÚ_£ns™ive
 = 
pã©u»
->i_motion_sensitive;

275 
»t
 = -
EINVAL
;

276 
	`TW_DBG
(
TW_DBG_ERR
, "bad mÙiÚ s’s™iv%d\n", 
pã©u»
->
i_mÙiÚ_£ns™ive
);

280 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NIGHT_MASK
) {

281 if((
pã©u»
->
i_night_£ns™ive
 >ğ
CHIP_VI_EVENT_MIN_SENSITIVE
è&& (Õã©u»->i_night_£ns™iv<ğ
CHIP_VI_EVENT_MAX_SENSITIVE
))) {

282 
rã©u»
->
i_night_£ns™ive
 = 
pã©u»
->i_night_sensitive;

284 
»t
 = -
EINVAL
;

285 
	`TW_DBG
(
TW_DBG_ERR
, "bad‚ighˆ£ns™iv%d\n", 
pã©u»
->
i_night_£ns™ive
);

289 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_BLIND_MASK
) {

290 if((
pã©u»
->
i_blšd_£ns™ive
 >ğ
CHIP_VI_EVENT_MIN_SENSITIVE
è&& (Õã©u»->i_blšd_£ns™iv<ğ
CHIP_VI_EVENT_MAX_SENSITIVE
))) {

291 
rã©u»
->
i_blšd_£ns™ive
 = 
pã©u»
->i_blind_sensitive;

293 
»t
 = -
EINVAL
;

294 
	`TW_DBG
(
TW_DBG_ERR
, "bad blšd s’s™iv%d\n", 
pã©u»
->
i_blšd_£ns™ive
);

298 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NOVIDEO_MASK
) {

299 
rã©u»
->
b_novideo_’abË
 = !!
pã©u»
->b_novideo_enable;

301 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_UNDERFLOW_MASK
) {

302 
rã©u»
->
b_und”æow_’abË
 = !!
pã©u»
->b_underflow_enable;

304 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_OVERFLOW_MASK
) {

305 
rã©u»
->
b_ov”æow_’abË
 = !!
pã©u»
->b_overflow_enable;

307 
rã©u»
->
chªge_mask
 = 
pã©u»
->change_mask;

308 if(
rã©u»
->
chªge_mask
) {

309 
»t
 = 
video_´İ”ty
->
İ
->
	`upd©e
(
driv”
, &
´İ”ty
);

311 
»t
 = 
TW_OK
;

314 
	`TW_DBG
(
TW_DBG_ERR
, "channel‚umberƒrror\n");

315 
»t
 = -
EINVAL
;

318 
TW_VI_GET_VIDEO_STANDARD
:

319 
»t
 = 
TW_OK
;

321 
TW_VI_SET_VIDEO_TYPE
:{

322 
VI_CH_VIDEOTYPE
 
video_ty³
;

323 
	`cİy_äom_u£r
(&
video_ty³
, (*)
¬g
, (
VI_CH_VIDEOTYPE
));

324 
»t
 = 
driv”
->
İ
->
	`£t_video_¡ªd¬d
(driv”, 
video_ty³
.
eVideoTy³
);

328 
»t
 = -
EBADRQC
;

329 
	`TW_DBG
(
TW_DBG_ERR
, "No such command!\n");

333 
	`TW_DBG
(
TW_DBG_FATAL
, "vi device‚ot init\n");

336  
»t
;

337 
	}
}

339 
	$ch_vi_driv”_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
İ’ed_ed
)

341 
»t
 = 
TW_ED_UNREGISTER
;

343 if(
İ’ed_ed
 !ğ
NULL
){

344 
»t
 = 
	`©omic_»ad
(&
İ’ed_ed
->
¡©e
);

347  
»t
;

348 
	}
}

350 
hcd_š‹rçû_İ”©iÚ
 
	gch_vi_driv”_hcd_š‹rçû_İ
 = {

351 .
İ’
 = 
ch_vi_driv”_hcd_š‹rçû_İ’
,

352 .
	gşo£
 = 
ch_vi_driv”_hcd_š‹rçû_şo£
,

353 .
	gsu¥’d
 = 
ch_vi_driv”_hcd_š‹rçû_su¥’d
,

354 .
	g»sume
 = 
ch_vi_driv”_hcd_š‹rçû_»sume
,

355 .
	gioùl
 = 
ch_vi_driv”_hcd_š‹rçû_ioùl
,

356 .
	gg‘_¡©e
 = 
ch_vi_driv”_hcd_š‹rçû_g‘_¡©e
,

359 
	$tw_ch_vi_´İ”ty_š™
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
chn
)

361 if(
´İ”ty
) {

362 
´İ”ty
->
ch_num
 = 0;

363 
´İ”ty
->
u32ChªÃl
 = 
chn
;

364 
´İ”ty
->
u32BrighŠess
 = 
DEFAULT_VI_BRIGHTNESS
;

365 
´İ”ty
->
u32CÚŒa¡
 = 
DEFAULT_VI_CONTRAST
;

366 
´İ”ty
->
u32S©u¿tiÚ
 = 
DEFAULT_VI_SATURATION
;

367 
´İ”ty
->
u32Hue
 = 
DEFAULT_VI_HUE
;

368 
´İ”ty
->
u32Mask
 = 0;

369 
´İ”ty
->
u32Sh¬²ess
 = 
DEFAULT_VI_SHARPNESS
;

371  
TW_OK
;

374  
TW_ERR
;

375 
	}
}

377 
	$tw_ch_vi_´İ”ty_»£t
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

379 if(
´İ”ty
) {

380 
´İ”ty
->
u32BrighŠess
 = 
DEFAULT_VI_BRIGHTNESS
;

381 
´İ”ty
->
u32CÚŒa¡
 = 
DEFAULT_VI_CONTRAST
;

382 
´İ”ty
->
u32S©u¿tiÚ
 = 
DEFAULT_VI_SATURATION
;

383 
´İ”ty
->
u32Hue
 = 
DEFAULT_VI_HUE
;

384 
´İ”ty
->
u32Mask
 = 0;

385 
´İ”ty
->
u32Sh¬²ess
 = 
DEFAULT_VI_SHARPNESS
;

387  
TW_OK
;

390  
TW_ERR
;

391 
	}
}

393 
u32
 
	$tw_ch_vi_´İ”ty_g‘_brighŠess
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

395 if(
´İ”ty
) {

396  
´İ”ty
->
u32BrighŠess
;

399  
TW_ERR
;

400 
	}
}

402 
	$tw_ch_vi_´İ”ty_£t_brighŠess
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
brighŠess
)

404 if(
´İ”ty
) {

405 if((
brighŠess
 >ğ
MIN_VI_BRIGHNESS
è&& (brighŠes <ğ
MAX_VI_BRIGHNESS
)) {

406 
´İ”ty
->
u32BrighŠess
 = 
brighŠess
;

407  
TW_OK
;

409 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆbrighŠes çed %d, [%d, %d]\n", 
brighŠess
, 
MIN_VI_BRIGHNESS
, 
MAX_VI_BRIGHNESS
);

410  -
EINVAL
;

413  
TW_ERR
;

414 
	}
}

416 
u32
 
	$tw_ch_vi_´İ”ty_g‘_cÚŒa¡
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

418 if(
´İ”ty
) {

419  
´İ”ty
->
u32CÚŒa¡
;

422  
TW_ERR
;

423 
	}
}

425 
	$tw_ch_vi_´İ”ty_£t_cÚŒa¡
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
cÚŒa¡
)

427 if(
´İ”ty
) {

428 if((
cÚŒa¡
 >ğ
MIN_VI_CONTRAST
è&& (cÚŒa¡ <ğ
MAX_VI_CONTRAST
)) {

429 
´İ”ty
->
u32CÚŒa¡
 = 
cÚŒa¡
;

430  
TW_OK
;

432 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆcÚŒa¡ faed %d, [%d, %d]\n", 
cÚŒa¡
, 
MIN_VI_CONTRAST
, 
MAX_VI_CONTRAST
);

433  -
EINVAL
;

436  
TW_ERR
;

437 
	}
}

439 
u32
 
	$tw_ch_vi_´İ”ty_g‘_§tu¿tiÚ
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

441 if(
´İ”ty
) {

442  
´İ”ty
->
u32S©u¿tiÚ
;

445  
TW_ERR
;

446 
	}
}

448 
	$tw_ch_vi_´İ”ty_£t_§tu¿tiÚ
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
§tu¿tiÚ
)

450 if(
´İ”ty
) {

451 if((
§tu¿tiÚ
 >ğ
MIN_VI_SATURATION
è&& (§tu¿tiÚ <ğ
MAX_VI_SATURATION
)) {

452 
´İ”ty
->
u32S©u¿tiÚ
 = 
§tu¿tiÚ
;

453  
TW_OK
;

455 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆ§tu¿tiÚ faed %d, [%d, %d]\n", 
§tu¿tiÚ
, 
MIN_VI_SATURATION
, 
MAX_VI_SATURATION
);

456  -
EINVAL
;

459  
TW_ERR
;

460 
	}
}

462 
u32
 
	$tw_ch_vi_´İ”ty_g‘_hue
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

464 if(
´İ”ty
) {

465  
´İ”ty
->
u32Hue
;

468  
TW_ERR
;

469 
	}
}

471 
	$tw_ch_vi_´İ”ty_£t_hue
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
hue
)

473 if(
´İ”ty
) {

474 if((
hue
 >ğ
MIN_VI_HUE
è&& (hu<ğ
MAX_VI_HUE
)) {

475 
´İ”ty
->
u32Hue
 = 
hue
;

476  
TW_OK
;

478 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆhuçed %d, [%d, %d]\n", 
hue
, 
MIN_VI_HUE
, 
MAX_VI_HUE
);

479  -
EINVAL
;

482  
TW_ERR
;

483 
	}
}

485 
u32
 
	$tw_ch_vi_´İ”ty_g‘_sh¬²ess
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
)

487 if(
´İ”ty
) {

488  
´İ”ty
->
u32Sh¬²ess
;

491  
TW_ERR
;

492 
	}
}

494 
	$tw_ch_vi_´İ”ty_£t_sh¬²ess
(
tw_ch_vi_´İ”ty_t
 *
´İ”ty
, 
u32
 
sh¬²ess
)

496 if(
´İ”ty
) {

497 if((
sh¬²ess
 >ğ
MIN_VI_SHARPNESS
è&& (sh¬²es <ğ
MAX_VI_SHARPNESS
)) {

498 
´İ”ty
->
u32Sh¬²ess
 = 
sh¬²ess
;

499  
TW_OK
;

501 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆsh¬²es çed %d, [%d, %d]\n", 
sh¬²ess
, 
MIN_VI_SHARPNESS
, 
MAX_VI_SHARPNESS
);

502  -
EINVAL
;

505  
TW_ERR
;

506 
	}
}

508 
	$tw_ch_vi_´İ”ty_upd©e
(
tw_ch_vi_driv”_t
 *
driv”
, 
tw_ch_vi_cÚfig_´İ”ty_t
 *
cÚfig
)

510 if(
driv”
 && 
cÚfig
) {

511 
dvm_ch_t
 *
ch
;

512 
u32
 
v®ue
;

513 
tw_ch_vi_ã©u»_t
 *
rã©u»
, *
pã©u»
 = &
cÚfig
->
video_ã©u»
;

514 
tw_ch_vi_´İ”ty_t
 *
´İ”ty
 = &
cÚfig
->
video_´İ”ty
;

516 
ch
 = 
driv”
->chip;

518 if(
´İ”ty
->
u32Mask
 & 
MASK_VI_BRIGHTNESS
) {

520 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_BRIGHNESS
, (´İ”ty->
u32BrighŠess
 - 0x80));

523 if(
´İ”ty
->
u32Mask
 & 
MASK_VI_CONTRAST
) {

525 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_CONTRAST
,…rİ”ty->
u32CÚŒa¡
);

528 if(
´İ”ty
->
u32Mask
 & 
MASK_VI_SATURATION
) {

530 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_SATURATION_U
,…rİ”ty->
u32S©u¿tiÚ
);

531 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_SATURATION_V
,…rİ”ty->
u32S©u¿tiÚ
);

537 if(
´İ”ty
->
u32Mask
 & 
MASK_VI_HUE
) {

539 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_HUE
, (´İ”ty->
u32Hue
 - 0x80));

542 if(
´İ”ty
->
u32Mask
 & 
MASK_VI_SHARPNESS
) {

544 
	`mpb_wr™e
(
ch
, ((
´İ”ty
->
u32ChªÃl
 & 0x3è* 0x10è+ 
TW_VI_SHARPNESS
,…rİ”ty->
u32Sh¬²ess
);

547 
´İ”ty
->
u32Mask
 = 0x0;

549 
rã©u»
 = &
driv”
->
video_´İ”ty
[
pã©u»
->
chªÃl
].
video_ã©u»
;

550 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MODE_MASK
) {

552 
rã©u»
->
e_mÙiÚ_mode
 = 
pã©u»
->e_motion_mode;

553 
v®ue
 = 
	`mpb_»ad
(
ch
, 
	`TW_VI_EVENT_CONTROL
(
´İ”ty
->
u32ChªÃl
));

554 if(
rã©u»
->
e_mÙiÚ_mode
 =ğ
MOTION_TRIGGER_AUTIO
) {

555 
v®ue
 &= ~(0x3<<2);

557 
v®ue
 |= 0x3<<2;

559 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_CONTROL
(
´İ”ty
->
u32ChªÃl
), 
v®ue
);

561 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_MOTION_MASK
) {

562 
rã©u»
->
i_mÙiÚ_£ns™ive
 = 
pã©u»
->i_motion_sensitive;

563 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_MOTION
, 
pã©u»
->
chªÃl
,

564 (
rã©u»
->
i_mÙiÚ_£ns™ive
 < 
CHIP_VI_EVENT_MAX_SENSITIVE
));

566 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_MD_TMPSENS
(
rã©u»
->
chªÃl
),„ã©u»->
i_mÙiÚ_£ns™ive
 << 4);

567 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_MD_FIELD
(
rã©u»
->
chªÃl
),„ã©u»->
i_mÙiÚ_£ns™ive
 & 0xf);

568 
v®ue
 = 
	`mpb_»ad
(
ch
, 
	`TW_VI_EVENT_MD_SPSENS
(
rã©u»
->
chªÃl
));

569 
v®ue
 &= 0x0f;

570 
v®ue
 |ğ(
rã©u»
->
i_mÙiÚ_£ns™ive
 & 0xf)<<4;

571 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_MD_SPSENS
(
rã©u»
->
chªÃl
), 
v®ue
);

573 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NIGHT_MASK
) {

574 
rã©u»
->
i_night_£ns™ive
 = 
pã©u»
->i_night_sensitive;

575 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_NIGHT
, 
pã©u»
->
chªÃl
,

576 (
rã©u»
->
i_night_£ns™ive
 < 
CHIP_VI_EVENT_MAX_SENSITIVE
));

578 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_ND_TMPSENS
(
rã©u»
->
chªÃl
),

579 (
rã©u»
->
i_night_£ns™ive
 << 4) | (rfeature->i_night_sensitive / 4));

581 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_BLIND_MASK
) {

582 
rã©u»
->
i_blšd_£ns™ive
 = 
pã©u»
->i_blind_sensitive;

583 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_BLIND
, 
pã©u»
->
chªÃl
,

584 (
rã©u»
->
i_blšd_£ns™ive
 < 
CHIP_VI_EVENT_MAX_SENSITIVE
));

586 
v®ue
 = 
	`mpb_»ad
(
ch
, 
	`TW_VI_EVENT_MD_SPSENS
(
rã©u»
->
chªÃl
));

587 
v®ue
 &= 0xf0;

588 
v®ue
 |ğ
rã©u»
->
i_blšd_£ns™ive
 & 0xf;

589 
	`mpb_wr™e
(
ch
, 
	`TW_VI_EVENT_MD_SPSENS
(
rã©u»
->
chªÃl
), 
v®ue
);

591 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_NOVIDEO_MASK
) {

592 
rã©u»
->
b_novideo_’abË
 = 
pã©u»
->b_novideo_enable;

593 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_LOST
, 
pã©u»
->
chªÃl
, 
rã©u»
->
b_novideo_’abË
);

595 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_UNDERFLOW_MASK
) {

596 
rã©u»
->
b_und”æow_’abË
 = 
pã©u»
->b_underflow_enable;

597 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_UNDERFLOW
, 
pã©u»
->
chªÃl
, 
rã©u»
->
b_und”æow_’abË
);

599 if(
pã©u»
->
chªge_mask
 & 
TW_VI_FEATURE_ENABLE_CHANGE_OVERFLOW_MASK
) {

600 
rã©u»
->
b_ov”æow_’abË
 = 
pã©u»
->b_overflow_enable;

601 
	`tw_ch_ev’t_mask
(
driv”
, 
CHIP_VI_EVENT_OVERFLOW
, 
pã©u»
->
chªÃl
, 
rã©u»
->
b_ov”æow_’abË
);

603 
rã©u»
->
chªge_mask
 = 0x0;

605  
TW_OK
;

608  
TW_ERR
;

609 
	}
}

611 
tw_ch_vi_´İ”ty_İ”©iÚ
 
	gvideo_´İ”ty_İ
 = {

612 .
š™
 = 
tw_ch_vi_´İ”ty_š™
,

613 .
	g»£t
 = 
tw_ch_vi_´İ”ty_»£t
,

614 .
	gg‘_brighŠess
 = 
tw_ch_vi_´İ”ty_g‘_brighŠess
,

615 .
	g£t_brighŠess
 = 
tw_ch_vi_´İ”ty_£t_brighŠess
,

616 .
	gg‘_cÚŒa¡
 = 
tw_ch_vi_´İ”ty_g‘_cÚŒa¡
,

617 .
	g£t_cÚŒa¡
 = 
tw_ch_vi_´İ”ty_£t_cÚŒa¡
,

618 .
	gg‘_§tu¿tiÚ
 = 
tw_ch_vi_´İ”ty_g‘_§tu¿tiÚ
,

619 .
	g£t_§tu¿tiÚ
 = 
tw_ch_vi_´İ”ty_£t_§tu¿tiÚ
,

620 .
	gg‘_hue
 = 
tw_ch_vi_´İ”ty_g‘_hue
,

621 .
	g£t_hue
 = 
tw_ch_vi_´İ”ty_£t_hue
,

622 .
	gg‘_sh¬²ess
 = 
tw_ch_vi_´İ”ty_g‘_sh¬²ess
,

623 .
	g£t_sh¬²ess
 = 
tw_ch_vi_´İ”ty_£t_sh¬²ess
,

624 .
	gupd©e
 = 
tw_ch_vi_´İ”ty_upd©e
,

627 
	$tw_ch_vi_mÙiÚ_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

629 
»t
 = 
TW_ERR
, 
chªÃl
;

630 
tw_ch_vi_ev’t_t
 *
ev’t
;

631 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

632 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

634 if(
driv”
) {

635 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

636 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

637 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

638 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

639 if(
ã©u»
->
i_mÙiÚ_£ns™ive
 !ğ
CHIP_VI_EVENT_MAX_SENSITIVE
) {

641 
»t
 = 
TW_OK
;

646 
»t
 = -
EINVAL
;

650 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_MOTION_L
, 0xff);

651 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_MOTION_H
, 0xff);

653  
»t
;

654 
	}
}

656 
	$tw_ch_vi_night_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

658 
»t
 = 
TW_ERR
, 
chªÃl
;

659 
tw_ch_vi_ev’t_t
 *
ev’t
;

660 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

661 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

663 if(
driv”
) {

664 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

665 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

666 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

667 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

668 if(
ã©u»
->
i_night_£ns™ive
 !ğ
CHIP_VI_EVENT_MAX_SENSITIVE
) {

670 
»t
 = 
TW_OK
;

675 
»t
 = -
EINVAL
;

679 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_NIGHT_L
, 0xff);

680 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_NIGHT_H
, 0xff);

682  
»t
;

683 
	}
}

685 
	$tw_ch_vi_blšd_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

687 
»t
 = 
TW_ERR
, 
chªÃl
;

688 
tw_ch_vi_ev’t_t
 *
ev’t
;

689 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

690 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

692 if(
driv”
) {

693 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

694 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

695 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

696 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

697 if(
ã©u»
->
i_blšd_£ns™ive
 !ğ
CHIP_VI_EVENT_MAX_SENSITIVE
) {

699 
»t
 = 
TW_OK
;

704 
»t
 = -
EINVAL
;

708 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_BLIND_L
, 0xff);

709 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_BLIND_H
, 0xff);

711  
»t
;

712 
	}
}

714 
	$tw_ch_vi_novideo_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

716 
»t
 = 
TW_ERR
, 
chªÃl
, 
æags
;

717 
tw_ch_vi_ev’t_t
 *
ev’t
;

718 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

719 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

721 if(
driv”
) {

722 
æags
 = (
	`mpb_»ad
(
driv”
->
ch
, 0x388) & 0xff);

723 
æags
 |ğ((
	`mpb_»ad
(
driv”
->
ch
, 0x389) & 0xff) << 8);

724 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

725 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

726 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

727 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

729 if(
ã©u»
->
b_novideo_’abË
) {

730 if(
æags
 & (1 << 
chªÃl
)) {

731 
	`TW_DBG
(
TW_DBG_INFO
, "videØchªÃÈ%d ofæše\n", 
chªÃl
);

733 
	`TW_DBG
(
TW_DBG_INFO
, "videØchªÃÈ%d oÆše\n", 
chªÃl
);

736 
»t
 = 
TW_OK
;

741 
»t
 = -
EINVAL
;

745 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_NOVIDEO_L
, 0xff);

746 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_NOVIDEO_H
, 0xff);

748  
»t
;
	}
}

750 
	$tw_ch_vi_und”æow_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

752 
»t
 = 
TW_ERR
, 
chªÃl
;

753 
tw_ch_vi_ev’t_t
 *
ev’t
;

754 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

755 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

757 if(
driv”
) {

758 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

759 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

760 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

761 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

762 if(
ã©u»
->
b_und”æow_’abË
) {

764 
»t
 = 
TW_OK
;

769 
»t
 = -
EINVAL
;

773 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_UNDERFLOW_L
, 0xff);

774 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_UNDERFLOW_H
, 0xff);

776  
»t
;

777 
	}
}

779 
	$tw_ch_vi_ov”æow_hªdËr
(
u32
 
Ãv’t
, *
cÚ‹xt
)

781 
»t
 = 
TW_ERR
, 
chªÃl
;

782 
tw_ch_vi_ev’t_t
 *
ev’t
;

783 
tw_ch_vi_ã©u»_t
 *
ã©u»
;

784 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

786 if(
driv”
) {

787 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

788 
chªÃl
 = 0; chªÃÈ< 
TW_VI_MAX_CHNL
; channel++) {

789 if(
ev’t
->
ev’t_æags
 & (1 << 
chªÃl
)) {

790 
ã©u»
 = &
driv”
->
video_´İ”ty
[
chªÃl
].
video_ã©u»
;

791 if(
ã©u»
->
b_ov”æow_’abË
) {

793 
»t
 = 
TW_OK
;

798 
»t
 = -
EINVAL
;

802 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_OVERFLOW_L
, 0xff);

803 
	`mpb_wr™e
(
driv”
->
ch
, 
TW_VI_EVENT_OVERFLOW_H
, 0xff);

805  
»t
;

806 
	}
}

808 
	$tw_ch_ev’t_mask
(
tw_ch_vi_driv”_t
 *
driv”
, 
CHIP_VI_EVENT
 
Ãv’t
, 
u32
 
chªÃl
, 
’abË
)

810 
»t
 = 
TW_ERR
;

811 
u32
 
addh
, 
addl
, 
v®ue
;

813 if(!
driv”
 || ((
Ãv’t
 < 
CHIP_VI_EVENT_MOTION
è|| (Ãv’ˆ>ğ
CHIP_VI_EVENT_RESERVED
)è|| (
chªÃl
 >ğ
TW_VI_MAX_CHNL
)) {

814 
	`TW_DBG
(
TW_DBG_ERR
, "inavalid…arameter\n");

815  -
EINVAL
;

818 
Ãv’t
) {

820 
CHIP_VI_EVENT_MOTION
:

821 
addh
 = 
TW_VI_EVENT_MASK_MOTION_H
;

822 
addl
 = 
TW_VI_EVENT_MASK_MOTION_L
;

824 
CHIP_VI_EVENT_BLIND
:

825 
addh
 = 
TW_VI_EVENT_MASK_BLIND_H
;

826 
addl
 = 
TW_VI_EVENT_MASK_BLIND_L
;

828 
CHIP_VI_EVENT_NIGHT
:

829 
addh
 = 
TW_VI_EVENT_MASK_NIGHT_H
;

830 
addl
 = 
TW_VI_EVENT_MASK_NIGHT_L
;

832 
CHIP_VI_EVENT_LOST
:

833 
addh
 = 
TW_VI_EVENT_MASK_NOVIDEO_H
;

834 
addl
 = 
TW_VI_EVENT_MASK_NOVIDEO_L
;

836 
CHIP_VI_EVENT_UNDERFLOW
:

837 
addh
 = 
TW_VI_EVENT_MASK_UNDERFLOW_H
;

838 
addl
 = 
TW_VI_EVENT_MASK_UNDERFLOW_L
;

840 
CHIP_VI_EVENT_OVERFLOW
:

841 
addh
 = 
TW_VI_EVENT_MASK_OVERFLOW_H
;

842 
addl
 = 
TW_VI_EVENT_MASK_OVERFLOW_L
;

846 if(
chªÃl
 < (
TW_VI_MAX_CHNL
>>1)) {

847 
v®ue
 = 
	`mpb_»ad
(
driv”
->
ch
, 
addl
);

848 if(
’abË
) {

849 
v®ue
 |ğ(1 << 
chªÃl
);

851 
v®ue
 &ğ~(1 << 
chªÃl
);

853 
	`mpb_wr™e
(
driv”
->
ch
, 
addl
, 
v®ue
);

855 
v®ue
 = 
	`mpb_»ad
(
driv”
->
ch
, 
addh
);

856 if(
’abË
) {

857 
v®ue
 |ğ(1 <<(
chªÃl
 - (
TW_VI_MAX_CHNL
>>1)));

859 
v®ue
 &ğ~(1 <<(
chªÃl
 - (
TW_VI_MAX_CHNL
>>1)));

861 
	`mpb_wr™e
(
driv”
->
ch
, 
addh
, 
v®ue
);

866  
»t
;

867 
	}
}

869 
	$tw_ch_ev’t_»gi¡”
(
tw_ch_vi_driv”_t
 *
driv”
, 
CHIP_VI_EVENT
 
Ãv’t
, 
ev’t_hªdËr
 
hªdËr
, *
cÚ‹xt
)

871 
»t
 = 
TW_ERR
;

872 
æags
;

873 
tw_vi_ev’t_aùiÚ_t
 *
aùiÚ
;

874 
tw_ch_vi_ev’t_t
 *
ev’t
;

876 if(
driv”
) {

877 if((
Ãv’t
 < 
CHIP_VI_EVENT_MOTION
è|| (Ãv’ˆ> 
CHIP_VI_EVENT_OVERFLOW
)) {

878 
	`TW_DBG
(
TW_DBG_ERR
, "event‚umber overflow\n");

879  -
EINVAL
;

881 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

882 
aùiÚ
 = &
ev’t
->action;

883 
	`¥š_lock_œq§ve
(&
ev’t
->
lock
, 
æags
);

884 if(
aùiÚ
->
cÚ‹xt
 =ğ
NULL
) {

885 
aùiÚ
->
ev’t
 = 
Ãv’t
;

886 
aùiÚ
->
cÚ‹xt
 = context;

887 
aùiÚ
->
hªdËr
 = handler;

888 
aùiÚ
->
Ãxt
 = 
NULL
;

890 
»t
 = 
TW_OK
;

892 
	`TW_DBG
(
TW_DBG_ERR
, "ev’ˆ%d‡Ì—dy„egi¡”\n", 
Ãv’t
);

894 
»t
 = -
ENODEV
;

897 
	`¥š_uÆock_œq»¡Üe
(&
ev’t
->
lock
, 
æags
);

900  
»t
;

901 
	}
}

903 
	$tw_ch_ev’t_uÄegi¡”
(
tw_ch_vi_driv”_t
 *
driv”
, 
CHIP_VI_EVENT
 
Ãv’t
, *
cÚ‹xt
)

905 
»t
 = 
TW_ERR
;

906 
æags
;

907 
tw_vi_ev’t_aùiÚ_t
 *
aùiÚ
;

908 
tw_ch_vi_ev’t_t
 *
ev’t
;

910 if(
driv”
) {

911 if((
Ãv’t
 < 
CHIP_VI_EVENT_MOTION
è|| (Ãv’ˆ> 
CHIP_VI_EVENT_OVERFLOW
)) {

912 
	`TW_DBG
(
TW_DBG_ERR
, "event‚umber overflow\n");

913  -
EINVAL
;

915 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

916 
aùiÚ
 = &
ev’t
->action;

917 
	`¥š_lock_œq§ve
(&
ev’t
->
lock
, 
æags
);

918 if(
aùiÚ
->
cÚ‹xt
 == context) {

919 
aùiÚ
->
cÚ‹xt
 = 
NULL
;

920 
aùiÚ
->
hªdËr
 = 
NULL
;

921 
aùiÚ
->
Ãxt
 = 
NULL
;

923 
»t
 = 
TW_OK
;

925 
	`TW_DBG
(
TW_DBG_ERR
, "ev’ˆ%d‡Ì—dy uÄegi¡”\n", 
Ãv’t
);

927 
»t
 = -
ENODEV
;

930 
	`¥š_uÆock_œq»¡Üe
(&
ev’t
->
lock
, 
æags
);

933  
»t
;

934 
	}
}

936 
	$tw_ch_vi_œq
(
œq
, *
cÚ‹xt
)

938 
u32
 
ev’t_æags
;

939 
æags
;

940 
CHIP_VI_EVENT
 
Ãv’t
;

941 
tw_ch_vi_ev’t_t
 *
ev’t
;

942 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
cÚ‹xt
;

944 if(
driv”
) {

946 
ev’t_æags
 = 
driv”
->
İ
->
	`g‘_video_ev’t
(driver);

947 
Ãv’t
 = 
CHIP_VI_EVENT_MOTION
;‚ev’ˆ< 
CHIP_VI_EVENT_RESERVED
;‚event++) {

948 if(
ev’t_æags
 & (1 << 
Ãv’t
)) {

949 
tw_vi_ev’t_aùiÚ_t
 *
aùiÚ
;

951 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

952 
ev’t
->
couÁ
++;

953 
aùiÚ
 = &
ev’t
->action;

954 
	`¥š_lock_œq§ve
(&
ev’t
->
lock
, 
æags
);

955 
aùiÚ
 &&‡ùiÚ->
hªdËr
) {

956 if(
aùiÚ
->
	`hªdËr
(
ev’t
->ev’t,‡ùiÚ->
cÚ‹xt
)){

957 
ev’t
->
unhªdËd
++;

960 
aùiÚ
 =‡ùiÚ->
Ãxt
;

962 
	`¥š_uÆock_œq»¡Üe
(&
ev’t
->
lock
, 
æags
);

968 
	}
}

970 
	$tw_ch_vi_ev’t_tim”_check
(*
cÚ‹xt
)

972 if(
cÚ‹xt
) {

973  
	`tw_ch_vi_œq
(
IRQ_FRONT_END_TYPE_INTR
, 
cÚ‹xt
);

976  
TW_ERR
;

977 
	}
}

979 
	$vi_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

980 
couÁ
, *
eof
, *
d©a
)

982 
Ën
 = 0, 
i
;

983 
CHIP_VI_EVENT
 
Ãv’t
;

984 
tw_ch_vi_ev’t_t
 *
ev’t
;

985 
tw_ch_vi_cÚfig_´İ”ty_t
 *
video_´İ”ty
;

986 
tw_ch_vi_´İ”ty_t
 *
´İ”ty
;

987 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
d©a
;

989 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "video standard: ");

990 
driv”
->
İ
->
	`g‘_video_¡ªd¬d
(driver)) {

991 
CHIP_VI_STANDARD_NTSC_M
:

992 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "NTSC(M)");

994 
CHIP_VI_STANDARD_PAL_BDGHI
:

995 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "PAL(B,D,G,H,I)");

997 
CHIP_VI_STANDARD_SECAM
:

998 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "SECAM");

1000 
CHIP_VI_STANDARD_NTSC443
:

1001 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "NTSC4.43");

1003 
CHIP_VI_STANDARD_PAL_M
:

1004 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "PAL(M)");

1006 
CHIP_VI_STANDARD_PAL_CN
:

1007 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "PAL(CN)");

1009 
CHIP_VI_STANDARD_PAL_60
:

1010 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "PAL 60");

1012 
CHIP_VI_STANDARD_AUTO
:

1013 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "Auto");

1016 
CHIP_VI_STANDARD_INVALID
:

1017 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%s\n", "Invalid");

1021 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "vi configure\n");

1022 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %12s %12s %12s %12s %12s\n", "ch", "brightness", "contrast", "saturation", "hue", "sharpness");

1023 
i
 = 0; i < 
TW_VI_ON_CHIP_CHNL
; i++) {

1024 
´İ”ty
 = &
driv”
->
video_´İ”ty
[
i
].video_property;

1025 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %12d %12d %12d %12d %12d\n", 
´İ”ty
->
u32ChªÃl
,

1026 
´İ”ty
->
u32BrighŠess
,…rİ”ty->
u32CÚŒa¡
,…rİ”ty->
u32S©u¿tiÚ
,

1027 
´İ”ty
->
u32Hue
,…rİ”ty->
u32Sh¬²ess
);

1029 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "vi feature configure:\n");

1030 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s\n", "ch", "motion", "night",

1032 
i
 = 0; i < 
TW_VI_MAX_CHNL
; i++) {

1033 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
i
];

1034 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %8d %8d %8d %8d %8d %8d\n", 
i
,

1035 
video_´İ”ty
->
video_ã©u»
.
i_mÙiÚ_£ns™ive
,

1036 
video_´İ”ty
->
video_ã©u»
.
i_night_£ns™ive
,

1037 
video_´İ”ty
->
video_ã©u»
.
i_blšd_£ns™ive
,

1038 
video_´İ”ty
->
video_ã©u»
.
b_novideo_’abË
,

1039 
video_´İ”ty
->
video_ã©u»
.
b_und”æow_’abË
,

1040 
video_´İ”ty
->
video_ã©u»
.
b_ov”æow_’abË
);

1042 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "event status:\n%10s :%8s %8s\n", "event", "happened", "unhandled");

1043 
Ãv’t
 = 
CHIP_VI_EVENT_MOTION
;‚ev’ˆ< 
CHIP_VI_EVENT_RESERVED
;‚event++) {

1044 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

1045 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%10  :%8d %8d\n", 
ev’t
->
Çme
,ƒv’t->
couÁ
,ƒv’t->
unhªdËd
);

1048  
Ën
;

1049 
	}
}

1051 
	$vi_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

1052 
couÁ
, *
d©a
)

1054 
tw_ch_vi_driv”_t
 *
driv”
 = (tw_ch_vi_driv”_ˆ*)
d©a
;

1056 if(
driv”
) {

1057 
	`TW_DBG
(
TW_DBG_ERR
, "vi driver uninitial\n");

1060  
couÁ
;

1061 
	}
}

1063 
	$ch_vi_driv”_š™
(
tw_ch_vi_driv”_t
 *
driv”
)

1065 
»t
 = 
TW_ERR
;

1067 if(
driv”
) {

1068 
i
;

1069 
tw_ch_vi_cÚfig_´İ”ty_t
 *
video_´İ”ty
;

1070 
tw_ch_vi_ã©u»_t
 *
video_ã©u»
;

1071 
tw_ch_vi_ev’t_t
 *
ev’t
;

1072 
CHIP_VI_EVENT
 
Ãv’t
;

1073 
ed_tcb_t
 *
ed
;

1074 
tw_´oc_»gi¡”_s
 *
vi_´oc
;

1076 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

1077 
ed
 = &
driv”
->
İ’ed_vi_ed
;

1078 
vi_´oc
 = &
driv”
->vi_proc;

1079 
ed
->
İ
 = &
ch_vi_driv”_hcd_š‹rçû_İ
;

1080 
i
 = 0; i < 
TW_VI_MAX_CHNL
; i++, 
video_´İ”ty
++) {

1081 
video_´İ”ty
 = &
driv”
->video_´İ”ty[
i
];

1082 
video_ã©u»
 = &
video_´İ”ty
->video_feature;

1083 
video_´İ”ty
->
İ
 = &
video_´İ”ty_İ
;

1084 
video_´İ”ty
->
İ
->
	`š™
(&video_´İ”ty->video_´İ”ty, 
i
);

1085 
	`memıy
(
video_ã©u»
, &
deçuÉ_vi_ã©u»
, (
tw_ch_vi_ã©u»_t
));

1086 
	`memıy
(&
video_´İ”ty
->video_´İ”ty, &
deçuÉ_video_´İ”ty
, (
tw_ch_vi_´İ”ty_t
));

1087 
video_´İ”ty
->video_´İ”ty.
u32ChªÃl
 = 
i
;

1088 
video_ã©u»
->
chªÃl
 = 
i
;

1089 
video_´İ”ty
->
İ
->
	`upd©e
(
driv”
, video_property);

1091 if(
driv”
->
İ
) {

1092 
driv”
->
İ
->
	`£t_video_¡ªd¬d
(driv”, 
DEFAULT_VI_STANDARD
);

1094 
	`TW_DBG
(
TW_DBG_INFO
, "not supporthis operation, set video standard failed\n");

1097 
Ãv’t
 = 
CHIP_VI_EVENT_MOTION
;‚ev’ˆ< 
CHIP_VI_EVENT_RESERVED
;‚event++) {

1098 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

1099 
ev’t
->
couÁ
 = 0;

1100 
ev’t
->
unhªdËd
 = 0;

1101 
ev’t
->ev’ˆğ
Ãv’t
;

1102 
	`mem£t
(&
ev’t
->
aùiÚ
, 0, (
tw_vi_ev’t_aùiÚ_t
));

1103 
	`¥š_lock_š™
(&
ev’t
->
lock
);

1104 
Ãv’t
) {

1105 
CHIP_VI_EVENT_MOTION
:

1106 
ev’t
->
Çme
 = "motion";

1107 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_MOTION
, 
tw_ch_vi_mÙiÚ_hªdËr
, driver);

1109 
CHIP_VI_EVENT_BLIND
:

1110 
ev’t
->
Çme
 = "blind";

1111 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_BLIND
, 
tw_ch_vi_blšd_hªdËr
, driver);

1113 
CHIP_VI_EVENT_NIGHT
:

1114 
ev’t
->
Çme
 = "night";

1115 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_NIGHT
, 
tw_ch_vi_night_hªdËr
, driver);

1117 
CHIP_VI_EVENT_LOST
:

1118 
ev’t
->
Çme
 = "vlost";

1119 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_LOST
, 
tw_ch_vi_novideo_hªdËr
, driver);

1121 
CHIP_VI_EVENT_UNDERFLOW
:

1122 
ev’t
->
Çme
 = "underflow";

1123 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_UNDERFLOW
, 
tw_ch_vi_und”æow_hªdËr
, driver);

1125 
CHIP_VI_EVENT_OVERFLOW
:

1126 
ev’t
->
Çme
 = "overflow";

1127 
»t
 = 
	`tw_ch_ev’t_»gi¡”
(
driv”
, 
CHIP_VI_EVENT_OVERFLOW
, 
tw_ch_vi_ov”æow_hªdËr
, driver);

1130 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀev’ˆ%d\n", 
Ãv’t
);

1131 
»t
 = -
EPERM
;

1134 if(
»t
) {

1135 
	`TW_DBG
(
TW_DBG_ERR
, "»gi¡”ƒv’ˆhªdË¸çed %d\n", 
»t
);

1136  
»t
;

1140 
	`¡rıy
(
vi_´oc
->
Çme
, "vi");

1141 
vi_´oc
->
»ad
 = 
vi_´oc_»ad
;

1142 
vi_´oc
->
wr™e
 = 
vi_´oc_wr™e
;

1143 
vi_´oc
->
´iv©e
 = 
driv”
;

1144 
vi_´oc
->
’Œy
 = 
NULL
;

1145 
	`tw_moduË_»gi¡”
(
driv”
->
ch
, 
vi_´oc
);

1147 #ià
TW_VI_EVENT_IRQ


1148 
»t
 = 
	`ch_»que¡_œq
(
driv”
->
ch
, 
IRQ_FRONT_END_TYPE_INTR
, 
tw_ch_vi_œq
, "vi_event", (*)driver);

1149 if(
»t
) {

1150 
	`TW_DBG
(
TW_DBG_ERR
, "»gi¡” irq faed, %d\n", 
»t
);

1152 
driv”
->
ev’t_tim”
 = 
INVALIDTIMERID
;

1154 
driv”
->
ev’t_tim”
 = 
	`AddFÜFœeTim”Job
(
TIMER_40MS
, 
tw_ch_vi_ev’t_tim”_check
, driver);

1155 if(
driv”
->
ev’t_tim”
 =ğ
ADDJOBERROR
) {

1156 
	`TW_DBG
(
TW_DBG_ERR
, "addimerƒrror!\n");

1157 
driv”
->
ev’t_tim”
 = 
INVALIDTIMERID
;

1161 
»t
 = -
EINVAL
;

1164  
»t
;

1165 
	}
}

1167 
	$ch_vi_driv”_»Ëa£
(
tw_ch_vi_driv”_t
 *
driv”
)

1169 if(
driv”
) {

1170 
CHIP_VI_EVENT
 
Ãv’t
;

1172 
Ãv’t
 = 
CHIP_VI_EVENT_MOTION
;‚ev’ˆ< 
CHIP_VI_EVENT_RESERVED
;‚event++) {

1173 
	`tw_ch_ev’t_uÄegi¡”
(
driv”
, 
Ãv’t
, driver);

1175 #ià
TW_VI_EVENT_IRQ


1176 
	`ch_ä“_œq
(
driv”
->
ch
, 
IRQ_FRONT_END_TYPE_INTR
, driver);

1178 if(
driv”
->
ev’t_tim”
 !ğ
INVALIDTIMERID
) {

1179 
	`D–‘eFÜFœeTim”Job
(
driv”
->
ev’t_tim”
);

1180 
driv”
->
ev’t_tim”
 = 
INVALIDTIMERID
;

1183 
	`tw_moduË_uÄegi¡”
(
driv”
->
ch
, &driv”->
vi_´oc
);

1185  
TW_OK
;

1188  
TW_ERR
;

1189 
	}
}

1191 
	$ch_vi_driv”_»£t
(
tw_ch_vi_driv”_t
 *
driv”
)

1193 if(
driv”
) {

1194 
dvm_ch_t
 *
ch
 = 
driv”
->chip;

1196 
	`mpb_wr™e
(
ch
, 0x41, 0x03);

1197 
	`mpb_wr™e
(
ch
, 0x46, 0x00);

1199 
	`mpb_wr™e
(
ch
, 0xc0, 0x04);

1200 #iâdeà
FPGA_330_5864_TESTING


1201 
	`TW_DBG
(
TW_DBG_INFO
, "cÚfigu» sy¡em clockØ%dMhz\n", 
ch
->
sys_şock
);

1202 
ch
->
sys_şock
) {

1204 
	`´štk
("SYSTEM CLOCK RATE %dMhz NOT SUPPORT!!!\n", 
ch
->
sys_şock
);

1205 
	`BUG
();

1207 #ifdeà
TW5864_ASIC_NEW


1208 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x1);

1209 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x1);

1210 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x1);

1211 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x1);

1212 
	`mpb_wr™e
(
ch
, 0x0eec, 0x1);

1213 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1215 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x0);

1216 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x0);

1217 
	`mpb_wr™e
(
ch
, 0x0ee8, 0xf);

1218 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x0);

1219 
	`mpb_wr™e
(
ch
, 0x0eec, 0x0);

1220 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1224 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x1);

1225 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x1);

1226 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x0);

1227 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x1);

1228 
	`mpb_wr™e
(
ch
, 0x0eec, 0x1);

1229 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1232 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x0);

1233 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x0);

1234 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x1);

1235 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x0);

1236 
	`mpb_wr™e
(
ch
, 0x0eec, 0x0);

1237 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1240 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x1);

1241 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x1);

1242 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x0);

1243 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x1);

1244 
	`mpb_wr™e
(
ch
, 0x0eec, 0x1);

1245 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1248 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x0);

1249 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x0);

1250 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x1);

1251 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x1);

1252 
	`mpb_wr™e
(
ch
, 0x0eec, 0x1);

1253 
	`mpb_wr™e
(
ch
, 0x0eed, 0x0);

1256 
	`mpb_wr™e
(
ch
, 0x0ee6, 0xf);

1257 
	`mpb_wr™e
(
ch
, 0x0ee7, 0xf);

1258 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x0);

1259 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x0);

1260 
	`mpb_wr™e
(
ch
, 0x0eec, 0x0);

1261 
	`mpb_wr™e
(
ch
, 0x0eed, 0x1);

1264 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x3);

1265 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x3);

1266 
	`mpb_wr™e
(
ch
, 0x0ee8, 0xf);

1267 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x3);

1268 
	`mpb_wr™e
(
ch
, 0x0eec, 0x3);

1269 
	`mpb_wr™e
(
ch
, 0x0eed, 0xf);

1273 
	`mpb_wr™e
(
ch
, 0x0ee6, 0x4);

1274 
	`mpb_wr™e
(
ch
, 0x0ee7, 0x4);

1275 
	`mpb_wr™e
(
ch
, 0x0ee8, 0x2);

1276 
	`mpb_wr™e
(
ch
, 0x0eeb, 0x4);

1277 
	`mpb_wr™e
(
ch
, 0x0eec, 0x4);

1278 
	`mpb_wr™e
(
ch
, 0x0eed, 0x2);

1282 
	`mpb_wr™e
(
ch
, 0x03ba, 0x3);

1283 
	`mpb_wr™e
(
ch
, 0x03bb, 0x0);

1287 
driv”
->
İ
->
	`£t_video_¡ªd¬d
(driv”, driv”->İ->
	`g‘_video_¡ªd¬d
(driver));

1289  
TW_OK
;

1292  
TW_ERR
;

1293 
	}
}

1295 
	$ch_vi_driv”_g‘_video_¡ªd¬d
(
tw_ch_vi_driv”_t
 *
driv”
)

1297 if(
driv”
) {

1298  
driv”
->
video_¡ªd¬d
;

1301  -
EINVAL
;

1302 
	}
}

1304 
	$ch_vi_driv”_£t_video_¡ªd¬d
(
tw_ch_vi_driv”_t
 *
driv”
, 
CHIP_VI_STANDARD
 
nÜm
)

1306 
»t
 = 
TW_OK
;

1308 if(
driv”
) {

1309 
u32
 
v®ue
 = 0;

1310 
dvm_ch_t
 *
ch
;

1311 
ch_driv”_t
 *
ch_driv”
 = 
NULL
;

1312 
tw_video_bus_t
 *
video_bus
 = 
NULL
;

1313 
i
 = 0;

1315 
ch
 = 
driv”
->chip;

1316 
ch_driv”
 = 
ch
->chip_driver;

1317 if(
ch_driv”
) {

1318 
video_bus
 = &
ch_driv”
->video_bus;

1321 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆv˜videØ¡ªd¬d %d\n", 
nÜm
);

1322 
i
 = 0; i < 
TW_VI_ON_CHIP_CHNL
; i++) {

1323 
nÜm
) {

1324 
CHIP_VI_STANDARD_AUTO
:

1325 
v®ue
 = 0x07;

1327 
CHIP_VI_STANDARD_NTSC443
:

1328 
v®ue
 = 0x03;

1330 
CHIP_VI_STANDARD_NTSC_M
:

1331 
v®ue
 = 0x00;

1333 
CHIP_VI_STANDARD_PAL_60
:

1334 
v®ue
 = 0x06;

1336 
CHIP_VI_STANDARD_PAL_BDGHI
:

1337 
v®ue
 = 0x01;

1339 
CHIP_VI_STANDARD_PAL_CN
:

1340 
v®ue
 = 0x05;

1342 
CHIP_VI_STANDARD_PAL_M
:

1343 
v®ue
 = 0x04;

1345 
CHIP_VI_STANDARD_SECAM
:

1346 
v®ue
 = 0x02;

1349 
»t
 = -
EINVAL
;

1350 
	`TW_DBG
(
TW_DBG_ERR
, "nÙ suµÜˆvideØ¡ªd¬d %d\n", 
nÜm
);

1351  
»t
;

1353 
	`mpb_wr™e
(
ch
, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1355 
	`pci_i2c_wr™e
(
ch
, 0x52, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1356 
	`pci_i2c_wr™e
(
ch
, 0x54, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1357 
	`pci_i2c_wr™e
(
ch
, 0x56, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1360 
i
 = 0; i < 
TW_VI_ON_CHIP_CHNL
; i++) {

1361 if((
nÜm
 !ğ
CHIP_VI_STANDARD_NTSC443
è&& (nÜm !ğ
CHIP_VI_STANDARD_NTSC_M
è&& (nÜm !ğ
CHIP_VI_STANDARD_SECAM
)) {

1362 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆv˜chªÃÈ%d crİpšgØ720x576\n", 
i
);

1364 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x02, 0x0a);

1365 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x03, 0xd0);

1366 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x04, 0x06);

1367 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x05, 0x20);

1368 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x06, 0x28);

1370 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x07, (0x0<<6) | (0x1<<4) | (0x0<<2) | (0x2<<0));

1371 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x08, 0x12);

1372 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x09, 0x20);

1373 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x0a, 0x0a);

1374 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x0b, 0xd0);

1376 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x07, (0x0<<6) | (0x1<<4) | (0x0<<2) | (0x2<<0));

1377 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x08, 0x12);

1378 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x09, 0x20);

1379 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x0a, 0x0a);

1380 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x0b, 0xd0);

1382 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x07, (0x0<<6) | (0x1<<4) | (0x0<<2) | (0x2<<0));

1383 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x08, 0x12);

1384 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x09, 0x20);

1385 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x0a, 0x0a);

1386 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x0b, 0xd0);

1388 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆv˜chªÃÈ%d crİpšgØ720x480\n", 
i
);

1390 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x02, 0x0f);

1391 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x03, 0xd0);

1392 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x04, 0x06);

1393 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x05, 0xf0);

1394 
	`mpb_wr™e
(
ch
, (
i
<<4) + 0x06, 0x08);

1396 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x07, (0x0<<6) | (0x0<<4) | (0x0<<2) | (0x2<<0));

1397 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x08, 0x12);

1398 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x09, 0xf0);

1399 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x0a, 0x0a);

1400 
	`pci_i2c_wr™e
(
ch
, 0x52, (
i
<<4) + 0x0b, 0xd0);

1402 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x07, (0x0<<6) | (0x0<<4) | (0x0<<2) | (0x2<<0));

1403 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x08, 0x12);

1404 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x09, 0xf0);

1405 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x0a, 0x0a);

1406 
	`pci_i2c_wr™e
(
ch
, 0x54, (
i
<<4) + 0x0b, 0xd0);

1408 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x07, (0x0<<6) | (0x0<<4) | (0x0<<2) | (0x2<<0));

1409 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x08, 0x12);

1410 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x09, 0xf0);

1411 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x0a, 0x0a);

1412 
	`pci_i2c_wr™e
(
ch
, 0x56, (
i
<<4) + 0x0b, 0xd0);

1416 
i
 = 0; i < 
TW_VI_MAX_CHNL
; i++) {

1417 if((
nÜm
 !ğ
CHIP_VI_STANDARD_NTSC443
è&& (nÜm !ğ
CHIP_VI_STANDARD_NTSC_M
)) {

1418 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_IN_WIDTH
(
i
), (720>>2));

1419 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_IN_HEIGHT
(
i
), (576>>3));

1420 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_OUT_WIDTH
(
i
), (720>>3));

1421 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_OUT_HEIGHT
(
i
), (576>>4));

1422 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_VIDEO_STANDARD
, 0x1);

1424 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_IN_WIDTH
(
i
), (720>>2));

1425 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_IN_HEIGHT
(
i
), (480>>3));

1426 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_OUT_WIDTH
(
i
), (720>>3));

1427 
	`mpb_wr™e
(
ch
, 
	`TW_VI_SYSTEM_OUT_HEIGHT
(
i
), (480>>4));

1428 
	`mpb_wr™e
(
ch
, 
TW_VI_SYSTEM_VIDEO_STANDARD
, 0x0);

1431 
nÜm
) {

1433 
CHIP_VI_STANDARD_AUTO
:

1435 
CHIP_VI_STANDARD_NTSC443
:

1436 
CHIP_VI_STANDARD_NTSC_M
:

1437 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_NTSC
) {

1438 
video_bus
->
İ
->
	`£t_video_¡ªd¬d
(video_bus, 
TW_VIDEO_STANDARD_NTSC
);

1441 
CHIP_VI_STANDARD_PAL_60
:

1442 
CHIP_VI_STANDARD_PAL_BDGHI
:

1443 
CHIP_VI_STANDARD_PAL_CN
:

1444 
CHIP_VI_STANDARD_PAL_M
:

1445 
CHIP_VI_STANDARD_SECAM
:

1446 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè!ğ
TW_VIDEO_STANDARD_PAL
) {

1447 
video_bus
->
İ
->
	`£t_video_¡ªd¬d
(video_bus, 
TW_VIDEO_STANDARD_PAL
);

1451 
driv”
->
video_¡ªd¬d
 = 
nÜm
;

1453 
»t
 = -
EINVAL
;

1456  
»t
;

1457 
	}
}

1460 
	$ch_vi_driv”_£t_video_¡ªd¬d_ext
(
tw_ch_vi_driv”_t
 *
driv”
, 
CHIP_VI_STANDARD
 
nÜm
)

1462 if(
driv”
) {

1463 
i
, 
»t
;

1464 
u32
 
v®ue
 = 0;

1465 
dvm_ch_t
 *
ch
;

1466 
ch_driv”_t
 *
ch_driv”
 = 
NULL
;

1468 
ch
 = 
driv”
->chip;

1469 
ch_driv”
 = 
ch
->chip_driver;

1471 
	`TW_DBG
(
TW_DBG_INFO
, "£ˆv˜videØ¡ªd¬d %d\n", 
nÜm
);

1472 
i
 = 0; i < 
TW_VI_ON_CHIP_CHNL
; i++) {

1473 
nÜm
) {

1474 
CHIP_VI_STANDARD_AUTO
:

1475 
v®ue
 = 0x07;

1477 
CHIP_VI_STANDARD_NTSC443
:

1478 
v®ue
 = 0x03;

1480 
CHIP_VI_STANDARD_NTSC_M
:

1481 
v®ue
 = 0x00;

1483 
CHIP_VI_STANDARD_PAL_60
:

1484 
v®ue
 = 0x06;

1486 
CHIP_VI_STANDARD_PAL_BDGHI
:

1487 
v®ue
 = 0x01;

1489 
CHIP_VI_STANDARD_PAL_CN
:

1490 
v®ue
 = 0x05;

1492 
CHIP_VI_STANDARD_PAL_M
:

1493 
v®ue
 = 0x04;

1495 
CHIP_VI_STANDARD_SECAM
:

1496 
v®ue
 = 0x02;

1499 
»t
 = -
EINVAL
;

1500 
	`TW_DBG
(
TW_DBG_ERR
, "nÙ suµÜˆvideØ¡ªd¬d %d\n", 
nÜm
);

1501  
»t
;

1503 
	`mpb_wr™e
(
ch
, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1505 
	`pci_i2c_wr™e
(
ch
, 0x52, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1506 
	`pci_i2c_wr™e
(
ch
, 0x54, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1507 
	`pci_i2c_wr™e
(
ch
, 0x56, 
TW_VI_STANDARD
 + (
i
<<4), 
v®ue
);

1510 
driv”
->
video_¡ªd¬d
 = 
nÜm
;

1512  
TW_OK
;

1515  
TW_ERR
;

1516 
	}
}

1518 
u32
 
	$ch_vi_driv”_g‘_video_ev’t
(
tw_ch_vi_driv”_t
 *
driv”
)

1520 
CHIP_VI_EVENT
 
Ãv’t
;

1521 
u32
 
ev’t_æags
 = 0, 
‹mp
;

1522 
dvm_ch_t
 *
ch
;

1523 
tw_ch_vi_ev’t_t
 *
ev’t
;

1525 if(
driv”
) {

1526 
ch
 = 
driv”
->chip;

1528 
‹mp
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_SUMMARY_L
) & 0xff) |

1529 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_SUMMARY_H
) & 0xf) << 8);

1530 
Ãv’t
 = 
CHIP_VI_EVENT_MOTION
;‚ev’ˆ< 
CHIP_VI_EVENT_RESERVED
;‚event++) {

1531 if(
‹mp
 & 0x3) {

1533 
ev’t_æags
 |ğ(1 << 
Ãv’t
);

1534 
ev’t
 = &
driv”
->
driv”_ev’t
[
Ãv’t
];

1535 
Ãv’t
) {

1536 
CHIP_VI_EVENT_MOTION
:

1537 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_MOTION_L
) & 0xff) |

1538 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_MOTION_H
) & 0xff)<<8);

1540 
CHIP_VI_EVENT_NIGHT
:

1541 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_NIGHT_L
) & 0xff) |

1542 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_NIGHT_H
) & 0xff)<<8);

1544 
CHIP_VI_EVENT_BLIND
:

1545 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_BLIND_L
) & 0xff) |

1546 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_BLIND_H
) & 0xff)<<8);

1548 
CHIP_VI_EVENT_LOST
:

1549 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_NOVIDEO_L
) & 0xff) |

1550 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_NOVIDEO_H
) & 0xff)<<8);

1552 
CHIP_VI_EVENT_UNDERFLOW
:

1553 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_UNDERFLOW_L
) & 0xff) |

1554 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_UNDERFLOW_H
) & 0xff)<<8);

1556 
CHIP_VI_EVENT_OVERFLOW
:

1557 
ev’t
->
ev’t_æags
 = (
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_OVERFLOW_L
) & 0xff) |

1558 ((
	`mpb_»ad
(
ch
, 
TW_VI_EVENT_OVERFLOW_H
) & 0xff)<<8);

1561 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀev’ˆ%d\n", 
Ãv’t
);

1564 
‹mp
 >>= 2;

1568  
ev’t_æags
;

1569 
	}
}

1571 
tw_ch_vi_İ”©iÚ
 
	gtw_ch_vi_İ”©iÚ_İ
 = {

1572 .
š™
 = 
ch_vi_driv”_š™
,

1573 .
	g»Ëa£
 = 
ch_vi_driv”_»Ëa£
,

1574 .
	g»£t
 = 
ch_vi_driv”_»£t
,

1575 .
	gg‘_video_¡ªd¬d
 = 
ch_vi_driv”_g‘_video_¡ªd¬d
,

1576 .
	g£t_video_¡ªd¬d
 = 
ch_vi_driv”_£t_video_¡ªd¬d
,

1577 .
	g£t_video_¡ªd¬d_ext
 = 
ch_vi_driv”_£t_video_¡ªd¬d_ext
,

1578 .
	gg‘_video_ev’t
 = 
ch_vi_driv”_g‘_video_ev’t
,

1581 
	$š™_ch_vi_driv”
(
tw_£rviû_deviû
 *
tsd
, 
dvm_ch_t
 *
ch
)

1583 
»t
 = 0;

1584 
tw_ch_vi_driv”_t
 *
driv”
;

1586 
driv”
 = (
tw_ch_vi_driv”_t
 *)
	`km®loc
(Ñw_ch_vi_driv”_t), 
GFP_KERNEL
);

1587 if(
driv”
) {

1588 if(
ch
) {

1589 
driv”
->
ch
 = chip;

1590 
driv”
->
İ
 = &
tw_ch_vi_İ”©iÚ_İ
;

1591 
ch
->
ch_vi_driv”
 = 
driv”
;

1592 
»t
 = 
driv”
->
İ
->
	`š™
(driver);

1593 
driv”
->
İ
->
	`»£t
(driver);

1594 if(
»t
){

1595 
	`TW_DBG
(
TW_DBG_ERR
, "çedØš™ v˜driv” %d\n", 
»t
);

1596  -
ENOMEM
;

1598 
	`š™_’dpošt_tcb
(&
driv”
->
İ’ed_vi_ed
, 
ch
->
bus_id
, ch->
ch_id
,

1599 
INVALID_TW_ED_TYPE_ID
, 0,

1600 0, 
driv”
, 
NULL
,

1601 
NULL
, NULL);

1602 
tsd
->
³d
 = &
driv”
->
İ’ed_vi_ed
;

1603  
TW_OK
;

1606 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1607  -
EINVAL
;

1610 
	`TW_DBG
(
TW_DBG_ERR
, "no memory\n");

1611  -
ENOMEM
;

1614  
TW_ERR
;

1615 
	}
}

1617 
	$»move_ch_vi_driv”
(
tw_£rviû_deviû
 *
tsd
)

1619 
tw_ch_vi_driv”_t
 *
driv”
;

1620 
»t
 = 
TW_ERR
;

1622 if(
tsd
 &&sd->
³d
) {

1623 
driv”
 = 
	`to_g‘_ch_vi_driv”_w™h_İ’ed_logic_chª_ed
(
tsd
->
³d
);

1624 
»t
 = 
driv”
->
İ
->
	`»Ëa£
(driver);

1625 
	`kä“
(
driv”
);

1628  
»t
;

1629 
	}
}

1630 
	$tw_ch_vi_driv”_š™
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 *
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

1632 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
·¿
;

1634  
	`š™_ch_vi_driv”
(
tsd
,
ch
);

1635 
	}
}

1637 
	$tw_ch_vi_driv”_»move
(
tw_ch_deviû
 *
tcd
,
tw_£rviû_deviû
 *
tsd
,* 
·¿
,
cmd_¬g
 *
¬g
)

1640 
	`»move_ch_vi_driv”
(
tsd
);

1641 
	}
}

1644 
tw_dev_id
 
	gtw_ch_vi_dev_id
 =

1646 .
•obj
 = {

1647 .
v’dÜ_id
 = 
TWELL
,

1648 .
	gbus_id
 = 1,

1649 .
	gch_id
 = 
TW5864
,

1650 .
	gfunc_id
 = (0 << 16) | 0,

1651 .
	gty³
 = 
TW_VIDEO_IN
,

1652 .
	gkey
 = {0},

1654 .
	gv”siÚ
 = 1,

1657 
tsd_driv”_İ”©iÚs
 
	gtw_ch_vi_İs
 =

1659 .
š™
 = 
tw_ch_vi_driv”_š™
,

1660 .
	g»move
 = 
tw_ch_vi_driv”_»move
,

1663 
tw_£rviû_driv”
 
	gtw_ch_vi_driv
 =

1665 .
driv”
 = {

1666 .
Çme
 = "tw5864_video_input_driv",

1668 .
	gdeviû_id
 = {

1669 .
tid
 = &
tw_ch_vi_dev_id
,

1670 .
	gİs
 = &
tw_ch_vi_İs
,

1676 
	$tw5864_ch_vi_driv”_š™
(* 
·¿
)

1678 
tw_ch_vi_driv
.
deviû_id
.
·¿
 =…ara;

1679  
	`»gi¡”_tc_driv”
(&
tw_ch_vi_driv
);

1680 
	}
}

1683 
	$tw5864_ch_vi_driv”_»move
()

1685 
	`uÄegi¡”_tc_driv”
(&
tw_ch_vi_driv
);

1686 
	}
}

	@../../tw5864/tw5864/tw_chip_vo.c

1 
	~<tw5864/dvm_commÚ.h
>

	@../../tw5864/tw5864/tw_decode_sync.c

	@../../tw5864/tw5864/tw_devices_machine.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
tw_kth»ad_msg_queue_t
 
	gtw_msg_queue
;

4 
tw_kth»ad_msg_poŞ_t
 
	gtw_msg_poŞ
;

6 
	$g‘_msg_queue_h—d”
(
tw_kth»ad_msg_queue_t
 **
±r_queue
)

8 *
±r_queue
 = &
tw_msg_queue
;

9 
	}
}

11 
	$g‘_msg_poŞ_h—d”
(
tw_kth»ad_msg_poŞ_t
 **
msg_poŞ
)

13 *
msg_poŞ
 = &
tw_msg_poŞ
;

14 
	}
}

16 
	$tw_kth»ad_msg_š™
(
tw_kth»ad_msg_t
 *
msg
, 
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
)

18 if((
msg
!=
NULL
è&& (
msg_poŞ
!=NULL)){

19 
tcb_node_t
 *
node
 = &
msg
->
msg_node
;

20 
node
->
İ
 = &
tcb_node_İ
;

21 
node
->
İ
->
	`š™
(node);

22 
node
->
İ
->
	`£t_´iv
Òode, 
msg
);

23 
	`©omic_£t
(&
msg
->
»f_couÁ
, 0);

24 
	`¥š_lock_š™
(&
msg
->
lock
);

25 
msg
->
msg_poŞ
 = msg_pool;

26 
msg
->
ch
 = 
NULL
;

27 
msg
->
msg_ty³
 = 
REQ_ALGO_NULL
;

28 
msg
->
msg_cÚ‹xt
 = 
NULL
;

30 
	}
}

32 
	$tw_kth»ad_msg_»£t
(
tw_kth»ad_msg_t
 *
msg
)

34 if(
msg
 !ğ
NULL
){

35 
	`©omic_£t
(&
msg
->
»f_couÁ
, 0);

36 
msg
->
ch
 = 
NULL
;

37 
msg
->
msg_ty³
 = 
REQ_ALGO_NULL
;

38 
msg
->
msg_cÚ‹xt
 = 
NULL
;

40 
	}
}

42 
	$tw_kth»ad_msg_»Ëa£
(
tw_kth»ad_msg_t
 **
±r_msg
)

44 if(
±r_msg
 !ğ
NULL
){

45 
tw_kth»ad_msg_t
 *
msg
 = *
±r_msg
;

46 
æags
;

47 
	`¥š_lock_œq§ve
(&
msg
->
lock
, 
æags
);

48 if(
	`©omic_»ad
(&
msg
->
»f_couÁ
) > 1){

49 
	`©omic_dec
(&
msg
->
»f_couÁ
);

51 
tcb_node_t
 *
node
;

52 if(
msg
->
İ
 !ğ
NULL
){

53 
msg
->
İ
->
	`»£t
(msg);

55 
node
 = &
msg
->
msg_node
;

56 if(
node
->
İ
 !ğ
NULL
){

57 
node
->
İ
->
	`»Ëa£
Òode, &
msg
->
msg_poŞ
->
poŞ_node
);

59 *
±r_msg
 = 
NULL
;

61 
	`¥š_uÆock_œq»¡Üe
(&
msg
->
lock
, 
æags
);

63 
	}
}

65 
	$tw_kth»ad_msg_upd©e_·¿m
(
tw_kth»ad_msg_t
 *
msg
, 
dvm_ch_t
 *
ch
, 
msg_ty³
, *
cÚ‹xt
)

67 if(
msg
 !ğ
NULL
){

68 
msg
->
ch
 = chip;

69 
msg
->
msg_ty³
 = msg_type;

70 
msg
->
msg_cÚ‹xt
 = 
cÚ‹xt
;

72 
	}
}

74 
tw_kth»ad_msg_İ”©iÚ
 
	gtw_kth»ad_msg_İ
 = {

75 .
š™
 = 
tw_kth»ad_msg_š™
,

76 .
	g»£t
 = 
tw_kth»ad_msg_»£t
,

77 .
	g»Ëa£
 = 
tw_kth»ad_msg_»Ëa£
,

78 .
	gupd©e_·¿m
 = 
tw_kth»ad_msg_upd©e_·¿m
,

81 
	$tw_kth»ad_msg_queue_š™
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

83 if(
msg_queue
 !ğ
NULL
){

84 
tcb_node_queue_t
 *
queue
;

85 
queue
 = &
msg_queue
->
queue_node
;

86 
queue
->
İ
 = &
tcb_node_queue_İ
;

87 
queue
->
İ
->
	`š™
(queue);

88 
msg_queue
->
cu¼_cÚsum”
 = 
NULL
;

89 
	`¥š_lock_š™
(&
msg_queue
->
lock
);

91 
	}
}

93 
	$tw_kth»ad_msg_queue_put
(
tw_kth»ad_msg_queue_t
 *
msg_queue
, 
tw_kth»ad_msg_t
 *
msg
)

95 if((
msg_queue
!=
NULL
è&& (
msg
!=NULL)){

96 
tcb_node_queue_t
 *
queue
;

97 
queue
 = &
msg_queue
->
queue_node
;

98 if(
queue
->
İ
 !ğ
NULL
){

99 
queue
->
İ
->
	`put
(queue, &
msg
->
msg_node
);

102 
	}
}

104 
	$tw_kth»ad_msg_queue_g‘
(
tw_kth»ad_msg_queue_t
 *
msg_queue
, 
tw_kth»ad_msg_t
 **
±r_msg
)

106 if((
msg_queue
!=
NULL
è&& (
±r_msg
!=NULL)){

107 
tcb_node_queue_t
 *
queue
;

108 
queue
 = &
msg_queue
->
queue_node
;

109 *
±r_msg
 = 
NULL
;

110 if(
queue
->
İ
 !ğ
NULL
){

111 
tcb_node_t
 *
‹mp_node
;

112 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

113 if(
‹mp_node
 !ğ
NULL
){

114 *
±r_msg
 = 
	`to_g‘_tw_kth»ad_msg
(
‹mp_node
);

118 
	}
}

120 
	$tw_kth»ad_msg_queue_»Ëa£
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

122 if(
msg_queue
 !ğ
NULL
){

123 
msg_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(msg_queue);

124 
msg_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(msg_queue)){

125 
msg_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(msg_queue);

126 if(
msg_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

129 
msg_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(msg_queue);

132 
	}
}

134 
	$tw_kth»ad_msg_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

136 if(
msg_queue
 !ğ
NULL
){

137 
æags
;

138 
	`¥š_lock_œq§ve
(&
msg_queue
->
lock
, 
æags
);

139 if(
msg_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

140 
	`¥š_uÆock_œq»¡Üe
(&
msg_queue
->
lock
, 
æags
);

141 if(
msg_queue
->
İ
 !ğ
NULL
){

142 
msg_queue
->
İ
->
	`g‘
(msg_queue, &msg_queue->
cu¼_cÚsum”
);

144 
	`tw_kth»ad_msg_queue_g‘
(
msg_queue
, &msg_queue->
cu¼_cÚsum”
);

146 
	`¥š_lock_œq§ve
(&
msg_queue
->
lock
, 
æags
);

148 
	`¥š_uÆock_œq»¡Üe
(&
msg_queue
->
lock
, 
æags
);

150 
	}
}

152 
	$tw_kth»ad_msg_queue_»Ëa£_cu¼_cÚsum”
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

154 if(
msg_queue
 !ğ
NULL
){

155 
æags
;

156 
	`¥š_lock_œq§ve
(&
msg_queue
->
lock
, 
æags
);

157 if(
msg_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

158 if(
msg_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

159 
msg_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&msg_queue->curr_consumer);

161 
	`tw_kth»ad_msg_»Ëa£
(&
msg_queue
->
cu¼_cÚsum”
);

164 
	`¥š_uÆock_œq»¡Üe
(&
msg_queue
->
lock
, 
æags
);

166 
	}
}

168 
	$tw_kth»ad_msg_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

170 
»t
 = 0;

171 if(
msg_queue
 !ğ
NULL
){

172 
»t
 = 
msg_queue
->
queue_node
.
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(&msg_queue->queue_node);

174  
»t
;

175 
	}
}

177 
tw_kth»ad_msg_queue_İ”©iÚ
 
	gtw_kth»ad_msg_queue_İ
 =

179 .
š™
 = 
tw_kth»ad_msg_queue_š™
,

180 .
	gput
 = 
tw_kth»ad_msg_queue_put
,

181 .
	gg‘
 = 
tw_kth»ad_msg_queue_g‘
,

182 .
	g»Ëa£
 = 
tw_kth»ad_msg_queue_»Ëa£
,

184 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_kth»ad_msg_queue_g‘_cu¼_cÚsum”_äom_queue
,

185 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_kth»ad_msg_queue_»Ëa£_cu¼_cÚsum”
,

186 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_kth»ad_msg_queue_g‘_cu¼_queue_’Œy_numb”
,

189 
	$š™_tw_kth»ad_msg_queue
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

191 if(
msg_queue
 !ğ
NULL
){

192 
msg_queue
->
İ
 = &
tw_kth»ad_msg_queue_İ
;

193 
msg_queue
->
İ
->
	`š™
(msg_queue);

195 
	}
}

197 
	$»move_tw_kth»ad_msg_queue
(
tw_kth»ad_msg_queue_t
 *
msg_queue
)

199 if(
msg_queue
 !ğ
NULL
){

200 
msg_queue
->
İ
->
	`»Ëa£
(msg_queue);

202 
	}
}

204 
	$tw_kth»ad_msg_poŞ_g‘
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
, 
tw_kth»ad_msg_t
 **
±r_msg
)

206 if((
msg_poŞ
!=
NULL
è&& (
±r_msg
!=NULL)){

207 
tcb_node_poŞ_t
 *
poŞ_node
 = &
msg_poŞ
->pool_node;

208 *
±r_msg
 = 
NULL
;

209 if(
poŞ_node
->
İ
 !ğ
NULL
){

210 
tcb_node_t
 *
‹mp_node
;

211 
poŞ_node
->
İ
->
	`g‘
ÕoŞ_node, &
‹mp_node
);

212 if(
‹mp_node
 !ğ
NULL
){

213 *
±r_msg
 = 
	`to_g‘_tw_kth»ad_msg
(
‹mp_node
);

214 
	`©omic_šc
(&((*
±r_msg
)->
»f_couÁ
));

218 
	}
}

220 
	$tw_kth»ad_msg_poŞ_Œy_g‘
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
, 
tw_kth»ad_msg_t
 **
±r_msg
)

222 if((
msg_poŞ
!=
NULL
è&& (
±r_msg
!=NULL)){

223 
tcb_node_poŞ_t
 *
poŞ_node
 = &
msg_poŞ
->pool_node;

224 *
±r_msg
 = 
NULL
;

225 if(
poŞ_node
->
İ
 !ğ
NULL
){

226 
tcb_node_t
 *
‹mp_node
;

227 
poŞ_node
->
İ
->
	`Œy_g‘
ÕoŞ_node, &
‹mp_node
);

228 if(
‹mp_node
 !ğ
NULL
){

229 *
±r_msg
 = 
	`to_g‘_tw_kth»ad_msg
(
‹mp_node
);

230 
	`©omic_šc
(&((*
±r_msg
)->
»f_couÁ
));

234 
	}
}

236 
	$tw_kth»ad_msg_poŞ_put
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
, 
tw_kth»ad_msg_t
 *
msg
)

238 if((
msg_poŞ
!=
NULL
è&& (
msg
!=NULL)){

239 
tcb_node_poŞ_t
 *
poŞ_node
 = &
msg_poŞ
->pool_node;

240 if(
poŞ_node
->
İ
 !ğ
NULL
){

241 
poŞ_node
->
İ
->
	`put
ÕoŞ_node, &
msg
->
msg_node
);

244 
	}
}

246 
	$tw_kth»ad_msg_poŞ_»Ëa£
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
)

248 if(
msg_poŞ
 !ğ
NULL
){

249 
msg_poŞ
->
poŞ_node
.
İ
->
	`»Ëa£
(&msg_pool->pool_node);

250 if(
msg_poŞ
->
msg_ÿche_poŞ
 !ğ
NULL
){

251 
	`kä“
(
msg_poŞ
->
msg_ÿche_poŞ
);

252 
msg_poŞ
->
msg_ÿche_poŞ
 = 
NULL
;

254 
msg_poŞ
->
msg_’Œy_numb”
 = 0;

256 
	}
}

258 
	$tw_kth»ad_msg_poŞ_š™
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
)

260 
»t
 = -
ENOMEM
;

261 if(
msg_poŞ
 !ğ
NULL
){

262 
tcb_node_poŞ_t
 *
poŞ_node
 = &
msg_poŞ
->pool_node;

263 
tw_kth»ad_msg_t
 *
msg
;

264 
i
;

266 
poŞ_node
->
İ
 = &
tcb_node_poŞ_İ
;

267 
msg_poŞ
->
msg_’Œy_numb”
 = 128;

268 
msg_poŞ
->
msg_ÿche_poŞ
 = (
tw_kth»ad_msg_t
*)
	`km®loc
(Ñw_kth»ad_msg_t)*msg_poŞ->
msg_’Œy_numb”
, 
GFP_KERNEL
);

269 if(
msg_poŞ
->
msg_ÿche_poŞ
 =ğ
NULL
){

270 
	`´štk
("%s.%d: cª'ˆü—‹ msg…oŞ\n", 
__FUNCTION__
, 
__LINE__
);

272 
poŞ_node
->
İ
->
	`š™
ÕoŞ_node, 
msg_poŞ
->
msg_’Œy_numb”
);

273 
i
=0; i<
msg_poŞ
->
msg_’Œy_numb”
; i++) {

274 
msg
 = &
msg_poŞ
->
msg_ÿche_poŞ
[
i
];

275 
msg
->
İ
 = &
tw_kth»ad_msg_İ
;

276 
msg
->
İ
->
	`š™
(msg, 
msg_poŞ
);

277 
msg
->
İ
->
	`»Ëa£
(&msg);

279 
»t
 = 0;

282  
»t
;

283 
	}
}

285 
tw_kth»ad_msg_poŞ_İ”©iÚ
 
	gtw_kth»ad_msg_poŞ_İ
 =

287 .
g‘
 = 
tw_kth»ad_msg_poŞ_g‘
,

288 .
	gŒy_g‘
 = 
tw_kth»ad_msg_poŞ_Œy_g‘
,

289 .
	gput
 = 
tw_kth»ad_msg_poŞ_put
,

290 .
	g»Ëa£
 = 
tw_kth»ad_msg_poŞ_»Ëa£
,

291 .
	gš™
 = 
tw_kth»ad_msg_poŞ_š™
,

294 
	$š™_tw_kth»ad_msg_poŞ
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
)

296 
»t
 = -
ENOMEM
;

297 if(
msg_poŞ
 !ğ
NULL
){

298 
msg_poŞ
->
İ
 = &
tw_kth»ad_msg_poŞ_İ
;

299 
»t
 = 
msg_poŞ
->
İ
->
	`š™
(msg_pool);

301  
»t
;

302 
	}
}

304 
	$»move_tw_kth»ad_msg_poŞ
(
tw_kth»ad_msg_poŞ_t
 *
msg_poŞ
)

306 if(
msg_poŞ
 !ğ
NULL
){

307 
msg_poŞ
->
İ
->
	`»Ëa£
(msg_pool);

309 
	}
}

311 
	$g’_driv”_»q_msg_äom_’code_chª
(
tw_h264_logic_’code_chª_t
 *
’code_chª
, 
msg_ty³
)

313 
tw_kth»ad_msg_poŞ_t
 *
tw_msg_poŞ
;

314 
tw_kth»ad_msg_t
 *
tw_msg
;

315 
»t
 = -1;

317 
	`g‘_msg_poŞ_h—d”
(&
tw_msg_poŞ
);

318 
tw_msg_poŞ
->
İ
->
	`g‘
Ñw_msg_poŞ, &
tw_msg
);

319 if(
tw_msg
!ğ
NULL
) {

320 
tw_kth»ad_msg_queue_t
 *
tw_msg_queue
;

321 
	`g‘_msg_queue_h—d”
(&
tw_msg_queue
);

322 
tw_msg
->
İ
->
	`upd©e_·¿m
Ñw_msg, 
’code_chª
->
ch
, 
msg_ty³
,ƒncode_chan);

323 
tw_msg_queue
->
İ
->
	`put
Ñw_msg_queue, 
tw_msg
);

324 
»t
 = 0;

326  
»t
;

327 
	}
}

329 
	$Œy_g’_driv”_»q_msg_äom_’code_chª
(
tw_h264_logic_’code_chª_t
 *
’code_chª
, 
msg_ty³
)

331 
tw_kth»ad_msg_poŞ_t
 *
tw_msg_poŞ
;

332 
tw_kth»ad_msg_t
 *
tw_msg
;

333 
»t
 = -1;

335 
	`g‘_msg_poŞ_h—d”
(&
tw_msg_poŞ
);

336 
tw_msg_poŞ
->
İ
->
	`Œy_g‘
Ñw_msg_poŞ, &
tw_msg
);

337 if(
tw_msg
!ğ
NULL
) {

338 
tw_kth»ad_msg_queue_t
 *
tw_msg_queue
;

339 
	`g‘_msg_queue_h—d”
(&
tw_msg_queue
);

340 
tw_msg
->
İ
->
	`upd©e_·¿m
Ñw_msg, 
’code_chª
->
ch
, 
msg_ty³
,ƒncode_chan);

341 
tw_msg_queue
->
İ
->
	`put
Ñw_msg_queue, 
tw_msg
);

342 
»t
 = 0;

344  
»t
;

345 
	}
}

347 
	$noblock_g’_dev_¦iûh—d_»q_msg
(*
cÚ‹xt
)

349 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

350 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_ALGO_SLICE_HEAD
) != 0){

351 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] = 
	`AddSšgËFœeTim”Job
(
NONBLOCK_COUNT
, 
noblock_g’_dev_¦iûh—d_»q_msg
,ƒncode_chan);

352 if(
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] =ğ
INVALIDTIMERID
){

353 
	`´štk
("\n\n**************g’ sliûh—d„eq msg fa[%d]***********\n\n", 
__LINE__
);

357 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] = 
INVALIDTIMERID
;

360 
	}
}

362 
	$noblock_g’_dev_avSync_»q_msg
(*
cÚ‹xt
)

364 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

365 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_AV_SYNC
) != 0){

366 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_AV_SYNC
] = 
	`AddSšgËFœeTim”Job
(
NONBLOCK_COUNT
, 
noblock_g’_dev_avSync_»q_msg
,ƒncode_chan);

367 if(
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_AV_SYNC
] =ğ
INVALIDTIMERID
){

368 
	`´štk
("\n\n**************g’‡vSynø»q msg fa[%d]***********\n\n", 
__LINE__
);

372 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_AV_SYNC
] = 
INVALIDTIMERID
;

375 
	}
}

377 
	$noblock_g’_ch_»£t_»q_msg
(*
cÚ‹xt
)

379 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

380 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_ALGO_CHIP_RESET
) != 0){

381 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] = 
	`AddSšgËFœeTim”Job
(
NONBLOCK_COUNT
, 
noblock_g’_ch_»£t_»q_msg
,ƒncode_chan);

382 if(
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] =ğ
INVALIDTIMERID
){

383 
	`´štk
("\n\n**************g’ ch_»£ˆ»q msg fa[%d]***********\n\n", 
__LINE__
);

387 
’code_chª
->
nÚblock_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] = 
INVALIDTIMERID
;

390 
	}
}

392 
	$d–ay_g’_dev_¦iûh—d_»q_msg
(*
cÚ‹xt
)

394 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

395 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] = 
INVALIDTIMERID
;

396 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_ALGO_SLICE_HEAD
) != 0){

397 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_dev_¦iûh—d_»q_msg
,ƒncode_chan);

398 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] =ğ
INVALIDTIMERID
){

399 
	`´štk
("\n\n&&&&&&&&&&&&&g’ d–ay sliûh—d„eq msg fa[%d]***********\n\n", 
__LINE__
);

403 
	}
}

405 
	$d–ay_g’_dev_avSync_»q_msg
(*
cÚ‹xt
)

407 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

408 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_AV_SYNC
] = 
INVALIDTIMERID
;

409 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_AV_SYNC
) != 0){

410 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_AV_SYNC
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_dev_avSync_»q_msg
,ƒncode_chan);

411 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_AV_SYNC
] =ğ
INVALIDTIMERID
){

412 
	`´štk
("\n\n&&&&&&&&&&&&&g’ d–ay‡vSynø»q msg fa[%d]***********\n\n", 
__LINE__
);

416 
	}
}

418 
	$d–ay_g’_ch_»£t_»q_msg
(*
cÚ‹xt
)

420 
tw_h264_logic_’code_chª_t
 *
’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

421 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] = 
INVALIDTIMERID
;

422 if(
	`Œy_g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
REQ_ALGO_CHIP_RESET
) != 0){

423 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_ch_»£t_»q_msg
,ƒncode_chan);

424 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] =ğ
INVALIDTIMERID
){

425 
	`´štk
("\n\n&&&&&&&&&&&&&g’ d–ay ch_»£ˆ»q msg fa[%d]***********\n\n", 
__LINE__
);

429 
	}
}

431 
	$’code_chª_g’_»q_msg
(
tw_h264_logic_’code_chª_t
 *
’code_chª
, 
msg_ty³
, 
block
)

433 
dvm_ch_t
 *
ch
;

434 
»t
 = -1;

436 if((
msg_ty³
>=
INVALID_REQ_ALGO
è|| !
’code_chª
)

437  
»t
;

438 
ch
 = 
’code_chª
->chip;

440 #ifdeà
USE_ON_CHIP_TIMER


441 if(
ch
->
di§bË_tim”
) {

442 
ch
->
	`di§bË_tim”
(chip);

445 
	`di§bË_tim”_št
();

447 if(
block
 =ğ
BLOCK_OP
) {

448 
»t
 = 
	`g’_driv”_»q_msg_äom_’code_chª
(
’code_chª
, 
msg_ty³
);

449 }if(
block
 =ğ
NONBLOCK_OP
) {

450 if(
’code_chª
->
nÚblock_msg_tim”_id
[
msg_ty³
] =ğ
INVALIDTIMERID
){

451 
msg_ty³
){

452 
REQ_ALGO_SLICE_HEAD
:

453 
»t
 = 
	`noblock_g’_dev_¦iûh—d_»q_msg
(
’code_chª
);

455 
REQ_AV_SYNC
:

456 
»t
 = 
	`noblock_g’_dev_avSync_»q_msg
(
’code_chª
);

458 
REQ_ALGO_CHIP_RESET
:

459 
»t
 = 
	`noblock_g’_ch_»£t_»q_msg
(
’code_chª
);

462 
	`´štk
("nØsu½pÜˆmsg %d‚oblock\n", 
msg_ty³
);

466 
	`´štk
("%s:%d-%d, havb“Àaddedim”\n", 
__FUNCTION__
, 
msg_ty³
, 
block
);

469 
»t
 = 0;

470 if(
’code_chª
->
d–ay_msg_tim”_id
[
msg_ty³
] =ğ
INVALIDTIMERID
){

471 
msg_ty³
){

472 
REQ_ALGO_SLICE_HEAD
:

473 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_dev_¦iûh—d_»q_msg
,ƒncode_chan);

474 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_SLICE_HEAD
] =ğ
INVALIDTIMERID
){

475 
	`´štk
("\n\n&&&&&&&&&&&& gen slice_head„eq msg fail&&&&&&&&&&&&\n\n");

478 
REQ_AV_SYNC
:

479 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_AV_SYNC
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_dev_avSync_»q_msg
,ƒncode_chan);

480 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_AV_SYNC
] =ğ
INVALIDTIMERID
){

481 
	`´štk
("\n\n&&&&&&&&&&& gen‡vSync„eq msg fail &&&&&&&&&&&&&&&&\n\n");

484 
REQ_ALGO_CHIP_RESET
:

485 
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
d–ay_g’_ch_»£t_»q_msg
,ƒncode_chan);

486 if(
’code_chª
->
d–ay_msg_tim”_id
[
REQ_ALGO_CHIP_RESET
] =ğ
INVALIDTIMERID
){

487 
	`´štk
("\n\n&&&&&&&&&&&& gen chip_reset„eq msg fail&&&&&&&&&&&&\n\n");

491 
	`´štk
("nØsu½pÜˆmsg %d d–ay\n", 
msg_ty³
);

495 
	`´štk
("%s:%d-%d, havb“Àaddedim”\n", 
__FUNCTION__
, 
msg_ty³
, 
block
);

498 #ifdeà
USE_ON_CHIP_TIMER


499 if(
ch
->
’abË_tim”
) {

500 
ch
->
	`’abË_tim”
(chip);

503 
	`’abË_tim”_št
();

505  
»t
;

506 
	}
}

	@../../tw5864/tw5864/tw_h264_encode.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
tw_h264_’code_cÚfigu¿tiÚ_t
 
	gdeçuÉ_h264_ma¡”_’code_´İ”ty
 = {

4 .
chªgedMask
 = 
TW5864_ENCODE_CONFIG_MASKALL
,

5 .
	gvideoSnd¬d
 = 
TW_VIDEO_STANDARD_PAL
,

7 .
	g’codeSize
 = 
TW_VIDEO_SIZE_CIF
,

8 .
	gwidth
 = 
WIDTH_FRAME_CIF_PAL
,

9 .
	gheight
 = 
HEIGHT_FRAME_CIF_PAL
,

10 .
	gb™¿‹
 = 
DEFAULT_BITRATE_CIFSIZE
,

12 .
	g’codeSize
 = 
TW_VIDEO_SIZE_D1
,

13 .
	gwidth
 = 
WIDTH_FRAME_D1_PAL
,

14 .
	gheight
 = 
HEIGHT_FRAME_D1_PAL
,

15 .
	gb™¿‹
 = 
DEFAULT_BITRATE_D1SIZE
,

17 .
	gås
 = 
DEFAULT_FRAMERATE_PAL
,

18 .
	gkeyF¿meIÁ”v®s
 = 
DEFAULT_I_P_STRIDE
,

19 .
	ggİIÁ”v®s
 = 
DEFAULT_GOP_VALUE
,

20 .
	gimageLev–
 = 0,

21 .
	gqpi
 = 
DEFAULT_QP
,

22 .
	gqµ
 = 
DEFAULT_QP
,

23 .
	gqpb
 = 
DEFAULT_QP
,

25 
tw_h264_’code_ã©u»_·¿m_t
 
	gdeçuÉ_maš_’code_ã©u»
 = {

26 .
b_’abË_deš‹¾aû
 = 
TW_H264_FEATURE_OFF
,

27 .
	gb_’abË_sk
 = 
TW_H264_FEATURE_OFF
,

28 .
	gb_’abË_h®f_pix–
 = 
TW_H264_FEATURE_ON
,

29 .
	gb_’abË_I_4X4
 = 
TW_H264_FEATURE_ON
,

30 .
	gb_’abË_qu¬‹r_pix–
 = 
TW_H264_FEATURE_ON
,

31 .
	gi_mb_d–ay_v®ue
 = 
MB_DELAY_VALUE
,

32 .
	gchªge_mask_æag
 = 0xff,

34 
tw_h264_’code_ã©u»_·¿m_t
 
	gdeçuÉ_sub_’code_ã©u»
 = {

35 .
b_’abË_deš‹¾aû
 = 
TW_H264_FEATURE_OFF
,

36 .
	gb_’abË_sk
 = 
TW_H264_FEATURE_OFF
,

37 .
	gb_’abË_h®f_pix–
 = 
TW_H264_FEATURE_ON
,

38 .
	gb_’abË_I_4X4
 = 
TW_H264_FEATURE_ON
,

39 .
	gb_’abË_qu¬‹r_pix–
 = 
TW_H264_FEATURE_ON
,

40 .
	gi_mb_d–ay_v®ue
 = 
MB_DELAY_VALUE
,

41 .
	gchªge_mask_æag
 = 0xff,

44 
	gs_Úly_i_4x4
 = 0;

46 
tw_h264_’code_rc_t
 
	gdeçuÉ_maš_’code_rc
 = {

47 .
e_image_´iÜ™y
 = 
TW_RC_IMAGE_QUALITY_FIRST
,

48 .
	ge_rc_ty³
 = 
TW_H264_CBR
,

49 .
	gi_deçuÉ_qp
 = 
DEFAULT_QP
,

50 .
	gchªge_mask_æag
 = 0xf,

53 
tw_h264_’code_cÚfigu¿tiÚ_t
 
	gdeçuÉ_h264_sub_’code_´İ”ty
 = {

54 .
chªgedMask
 = 
TW5864_ENCODE_CONFIG_MASKALL
,

55 .
	gvideoSnd¬d
 = 
TW_VIDEO_STANDARD_PAL
,

57 .
	g’codeSize
 = 
TW_VIDEO_SIZE_QCIF
,

58 .
	gwidth
 = 
WIDTH_FRAME_QCIF_PAL
,

59 .
	gheight
 = 
HEIGHT_FRAME_QCIF_PAL
,

60 .
	gb™¿‹
 = 
DEFAULT_BITRATE_QCIFSIZE
,

62 .
	g’codeSize
 = 
TW_VIDEO_SIZE_CIF
,

63 .
	gwidth
 = 
WIDTH_FRAME_CIF_PAL
,

64 .
	gheight
 = 
HEIGHT_FRAME_CIF_PAL
,

65 .
	gb™¿‹
 = 
DEFAULT_BITRATE_CIFSIZE
,

67 .
	gås
 = 
DEFAULT_FRAMERATE_PAL
,

68 .
	gkeyF¿meIÁ”v®s
 = 
DEFAULT_I_P_STRIDE
,

69 .
	ggİIÁ”v®s
 = 
DEFAULT_GOP_VALUE
,

70 .
	gimageLev–
 = 0,

71 .
	gqpi
 = 
DEFAULT_QP
,

72 .
	gqµ
 = 
DEFAULT_QP
,

73 .
	gqpb
 = 
DEFAULT_QP
,

76 
tw_h264_’code_rc_t
 
	gdeçuÉ_sub_’code_rc
 = {

77 .
e_image_´iÜ™y
 = 
TW_RC_IMAGE_QUALITY_FIRST
,

78 .
	ge_rc_ty³
 = 
TW_H264_CBR
,

79 .
	gi_deçuÉ_qp
 = 
DEFAULT_QP
,

80 .
	gchªge_mask_æag
 = 0xf,

83 cÚ¡ 
u32
 
	gdeçuÉ_nÚ»®_time_ås_bË
[
TW5864_PHY_VD_CHAN_NUMBER
]= {

90 cÚ¡ 
u32
 
	gdeçuÉ_nÚ»®_time_fmt_bË
[
TW5864_PHY_VD_CHAN_NUMBER
]= {

91 
TW_VIDEO_SIZE_D1
, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1,

92 
TW_VIDEO_SIZE_D1
, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1,

93 
TW_VIDEO_SIZE_D1
, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1,

94 
TW_VIDEO_SIZE_D1
, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1, TW_VIDEO_SIZE_D1,

97 cÚ¡ 
	gLambda_lookup_bË
[52] =

113 cÚ¡ 
	gIÁ¿4X4_Lambda3
[52] = {

122 
tw_h264_hªdË_u£r_q
(
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_chÆ
, *
Çme
, *
§ve
, 
út
);

124 
tw_h264_§ve_chn
(
tw_h264_logic_’code_chª_t
 *, *);

126 
tw_h264_to_fe
(
fe
 *, 
tw_video_äame_tcb_t
 *);

127 
tw_mv_to_fe
(
fe
 *
mv_fe
, 
tw_video_mv_äame_tcb_t
 *
äame
);

129 
»gi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
);

130 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

132 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

133 
ed_tcb_t
 *
ed_tcb
;

134 
dvm_ch_t
 *
ch
;

135 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

137 
ed_fsm
->
İ
->
	`»£t
(ed_fsm);

138 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

139 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

140 if(
	`©omic_»ad
(&
h264_logic_’code_chª
->
İ’ed_æag
)){

144 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

146 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

148  
TW_OK
;

149 
	}
}

151 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

153  
TW_OK
;

154 
	}
}

156 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

158  
TW_OK
;

159 
	}
}

161 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

163  
TW_OK
;

164 
	}
}

166 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

168 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

169 
ed_tcb_t
 *
ed_tcb
;

170 
dvm_ch_t
 *
ch
;

171 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

173 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

174 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

175 
ch
 = 
h264_logic_’code_chª
->chip;

176 if(
	`©omic_»ad
(&
h264_logic_’code_chª
->
İ’ed_æag
) == 0){

177 
ch
->
	`ch_İ’
(chip);

179 
	`´štk
("%s, %d\n", 
__FUNCTION__
, 
__LINE__
);

180 
	`»gi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

181 
	`š™_’code_chª_£rviû_tcb_w™h_fœ¡_¡¬t
(&
h264_logic_’code_chª
->
’code_»que¡_tcb
);

182 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
Ï¡_jiff›s
 = 
jiff›s
;

183 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

185 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

186 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

188  
TW_OK
;

189 
	}
}

191 
	$h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

193  
TW_OK
;

194 
	}
}

196 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

198 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

199 
ed_tcb_t
 *
ed_tcb
;

200 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

202 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

203 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

204 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

205 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_UNREGISTER
);

206 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

208  
TW_OK
;

209 
	}
}

211 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

213  
TW_OK
;

214 
	}
}

216 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

218 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

219 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

220 
ed_tcb_t
 *
ed_tcb
;

222 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

223 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

224 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

225 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

227  
TW_OK
;

228 
	}
}

230 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

232 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

233 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

234 
ed_tcb_t
 *
ed_tcb
;

236 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

237 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

238 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

239 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

241  
TW_OK
;

242 
	}
}

244 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

246 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

247 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

249 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

250 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

252 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

254 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

256  
TW_OK
;

257 
	}
}

259 
	$h264_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

261  
TW_OK
;

262 
	}
}

264 
	$h264_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

266 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

267 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

268 
ed_tcb_t
 *
ed_tcb
;

270 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

271 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

272 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

273 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

274 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

276  
TW_OK
;

277 
	}
}

279 
	$h264_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

281  
TW_OK
;

282 
	}
}

284 
	$h264_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

286 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

287 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

289 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

290 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

291 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

293  
TW_OK
;

294 
	}
}

296 
	$h264_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

298  
TW_OK
;

299 
	}
}

301 
	$h264_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

303  
TW_OK
;

304 
	}
}

306 
	$h264_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

308 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

309 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

310 
ed_fsm
->
İ
->
	`upd©e_’abË_Œigg”_³ndšg_ev’t
(ed_fsm, 0);

311 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 0);

312 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_STANDBY
);

313 
	`š™_’code_chª_£rviû_tcb_w™h_¡¬t_’code
(&
h264_logic_’code_chª
->
’code_»que¡_tcb
);

315  
TW_OK
;

316 
	}
}

318 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

320 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

321 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

322 
ed_tcb_t
 *
ed_tcb
;

324 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

325 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

326 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

327 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

329  
TW_OK
;

330 
	}
}

332 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

334  
TW_OK
;

335 
	}
}

337 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

339 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

340 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

341 
ed_tcb_t
 *
ed_tcb
;

343 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

344 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

345 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

346 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

348  
TW_OK
;

349 
	}
}

351 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

353 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

354 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

355 
ed_tcb_t
 *
ed_tcb
;

357 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

358 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

359 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

360 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

362  
TW_OK
;

363 
	}
}

365 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

367  
TW_OK
;

368 
	}
}

370 
	$h264_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

372 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

373 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_RUNNING
);

375  
TW_OK
;

376 
	}
}

378 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

380 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

381 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

382 
ed_tcb_t
 *
ed_tcb
;

384 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

385 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

386 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

387 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

388 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

390  
TW_OK
;

391 
	}
}

393 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

395  
TW_OK
;

396 
	}
}

398 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

400  
TW_OK
;

401 
	}
}

403 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

405 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

406 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

407 
ed_tcb_t
 *
ed_tcb
;

409 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

410 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

411 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

412 if(
ed_fsm
->
bË
 !ğ
NULL
){

413 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

414 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm, 
cÚ‹xt
);

417 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

418 
	`driv”_Œigg”_³ndšg_ev’t
(
ed_tcb
, 1);

420  
TW_OK
;

421 
	}
}

423 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

425  
TW_OK
;

426 
	}
}

428 
	$h264_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

430  
TW_OK
;

431 
	}
}

433 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

435 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

436 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

437 
ed_tcb_t
 *
ed_tcb
;

439 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

440 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

441 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

442 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

444  
TW_OK
;

445 
	}
}

447 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

449  
TW_OK
;

450 
	}
}

452 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

454 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

455 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

456 
ed_tcb_t
 *
ed_tcb
;

458 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

459 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

460 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

461 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

463  
TW_OK
;

464 
	}
}

466 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

468 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

469 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

470 
ed_tcb_t
 *
ed_tcb
;

472 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

473 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

474 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

475 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

477  
TW_OK
;

478 
	}
}

480 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

482  
TW_OK
;

483 
	}
}

485 
	$h264_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

487 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

488 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_TRANSFERING
);

490  
TW_OK
;

491 
	}
}

493 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

495 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

496 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

497 
ed_tcb_t
 *
ed_tcb
;

499 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

500 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

501 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

502 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

504  
TW_OK
;

505 
	}
}

507 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

509  
TW_OK
;

510 
	}
}

512 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

514 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

515 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

516 
ed_tcb_t
 *
ed_tcb
;

518 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

519 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

520 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

521 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

523  
TW_OK
;

524 
	}
}

526 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

528 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

529 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

530 
ed_tcb_t
 *
ed_tcb
;

532 
h264_logic_’code_chª
 = (
tw_h264_logic_’code_chª_t
*)
cÚ‹xt
;

533 
	`´štk
("%s.%d, %d.%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

534 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

535 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

537  
TW_OK
;

538 
	}
}

540 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

542  
TW_OK
;

543 
	}
}

545 
	$h264_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

547 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

548 
ed_tcb_t
 *
ed_tcb
;

550 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

551 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

552 
	`driv”_Œigg”_³ndšg_ev’t
(
ed_tcb
, 1);

554  
TW_OK
;

555 
	}
}

557 
	$h264_’code_driv”_sync_hook
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

559  
TW_OK
;

560 
	}
}

562 
fsm_¡©e_Œªsãr_m©rix_bË_t
 
	gh264_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
 = {

563 .
aùiÚ
 = {

565 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
,

566 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
,

567 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
,

568 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
,

569 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
,

570 
h264_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t


573 
h264_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
,

574 
h264_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
,

575 
h264_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
,

576 
h264_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
,

577 
h264_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
,

578 
h264_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t


581 
h264_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
,

582 
h264_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
,

583 
h264_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
,

584 
h264_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
,

585 
h264_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
,

586 
h264_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t


589 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
,

590 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
,

591 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
,

592 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
,

593 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
,

594 
h264_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t


597 
h264_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
,

598 
h264_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
,

599 
h264_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
,

600 
h264_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
,

601 
h264_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
,

602 
h264_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t


605 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
,

606 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
,

607 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
,

608 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
,

609 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
,

610 
h264_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t


613 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
,

614 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
,

615 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
,

616 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
,

617 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
,

618 
h264_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t


621 .
	gsync_hook
 = 
h264_’code_driv”_sync_hook
,

625 
š™_tw5864_h264_phy_video_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *, 
¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
);

627 
	$»gi¡”_logic_’code_chª_što_ma¡”_¦Ù
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
)

629 if((
h264_logic_’code_chª
!=
NULL
è&& (
ma¡”_¦Ù
!=NULL)){

630 
tw_»gi¡”_bË_t
 *
logic_chª_bË
 = &
ma¡”_¦Ù
->logic_chan_table;

631 
ed_tcb_t
 *
logic_chª_ed
 = &
h264_logic_’code_chª
->logic_chan_ed;

632 
tw_»gi¡”_node_t
 *
»gi¡”_node
 = &
logic_chª_ed
->
ed
;

634 
logic_chª_bË
->
İ
->
	`»gi¡”_node_što_bË
Öogic_chª_bË, 
»gi¡”_node
);

635 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_IDLE
);

637 
	}
}

639 
	$fšd_»gi¡”_logic_’code_chª_š_ma¡”_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
, 
logic_chª_id
, 
tw_h264_logic_’code_chª_t
 **
±r_h264_logic_’code_chª
)

641 if((
ma¡”_¦Ù
!=
NULL
è&& (
±r_h264_logic_’code_chª
!=NULL)){

642 
tw_»gi¡”_bË_t
 *
logic_chª_bË
 = &
ma¡”_¦Ù
->logic_chan_table;

643 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

645 *
±r_h264_logic_’code_chª
 = 
NULL
;

646 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

647 if(
»gi¡”_node
 !ğ
NULL
){

648 
ed_tcb_t
 *
logic_chª_ed
;

649 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

650 *
±r_h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_logic_chª_ed
(
logic_chª_ed
);

653 
	}
}

655 
	$uÄegi¡”_logic_’code_chª_što_ma¡”_¦Ù
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
)

657 if((
h264_logic_’code_chª
!=
NULL
è&& (
ma¡”_¦Ù
!=NULL)){

658 
tw_»gi¡”_bË_t
 *
logic_chª_bË
 = &
ma¡”_¦Ù
->logic_chan_table;

659 
ed_tcb_t
 *
logic_chª_ed
 = &
h264_logic_’code_chª
->logic_chan_ed;

660 
tw_»gi¡”_node_t
 *
»gi¡”_node
 = &
logic_chª_ed
->
ed
;

662 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_CLOSED
);

663 
»gi¡”_node
->
İ
->
	`com¶‘e_dÚe
(register_node);

664 
logic_chª_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
Öogic_chª_bË, 
»gi¡”_node
);

665 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_UNREGISTER
);

667 
	}
}

669 
	$»gi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
)

671 if((
h264_logic_’code_chª
!=
NULL
è&& (
ma¡”_¦Ù
!=NULL)){

672 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
 = &
ma¡”_¦Ù
->opened_logic_chan_table;

673 
ed_tcb_t
 *
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

674 
tw_»gi¡”_node_t
 *
»gi¡”_node
 = &
İ’ed_logic_chª_ed
->
ed
;

676 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
İ
->
	`»£t
(&h264_logic_encode_chan->encode_control);

677 
h264_logic_’code_chª
->
rc_driv”
.
rc_İ
->
	`š™_rc
(h264_logic_encode_chan);

678 
	`©omic_£t
(&
h264_logic_’code_chª
->
İ’ed_æag
, 1);

679 
İ’ed_logic_chª_bË
->
İ
->
	`»gi¡”_node_što_bË
(İ’ed_logic_chª_bË, 
»gi¡”_node
);

681 
	}
}

683 
	$fšd_»gi¡”_İ’ed_logic_’code_chª_š_ma¡”_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
, 
logic_chª_id
, 
tw_h264_logic_’code_chª_t
 **
±r_h264_logic_’code_chª
)

685 if((
ma¡”_¦Ù
!=
NULL
è&& (
±r_h264_logic_’code_chª
!=NULL)){

686 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
 = &
ma¡”_¦Ù
->opened_logic_chan_table;

687 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

688 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

690 *
±r_h264_logic_’code_chª
 = 
NULL
;

691 
İ’ed_logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
(İ’ed_logic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

692 if(
»gi¡”_node
 !ğ
NULL
){

693 
İ’ed_logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

694 *
±r_h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
İ’ed_logic_chª_ed
);

697 
	}
}

699 
	$uÄegi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
)

701 if((
h264_logic_’code_chª
!=
NULL
è&& (
ma¡”_¦Ù
!=NULL)){

702 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
 = &
ma¡”_¦Ù
->opened_logic_chan_table;

703 
ed_tcb_t
 *
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

704 
tw_»gi¡”_node_t
 *
»gi¡”_node
 = &
İ’ed_logic_chª_ed
->
ed
;

706 
İ’ed_logic_chª_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
(İ’ed_logic_chª_bË, 
»gi¡”_node
);

707 if(
h264_logic_’code_chª
->
ma¡”_¦Ù
 !ğ
NULL
){

708 
h264_logic_’code_chª
->
ma¡”_¦Ù
->
İ
->
	`’code_uÄegi¡”_nÙify
(h264_logic_encode_chan->master_slot, h264_logic_encode_chan);

710 
	`©omic_£t
(&
İ’ed_logic_chª_ed
->
¡©e
, 
TW_ED_UNREGISTER
);

712 
	}
}

714 
	$tw5864_’code_time¡amp_š™
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
)

716 
	`©omic_£t
(&
tw5864_’code_time¡amp
->
fœ¡_sync
, 1);

717 
tw5864_’code_time¡amp
->
cu¼_tim”_couÁ
 = 0;

718 
tw5864_’code_time¡amp
->
Ï¡_tim”_couÁ
 = 0;

719 
tw5864_’code_time¡amp
->
tÙ®_d–_tim”_couÁ
 = 
	`g‘_tw_sy¡em_tick
();

720 
	}
}

722 
	$tw5864_’code_time¡amp_»£t
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
)

724 
	`©omic_£t
(&
tw5864_’code_time¡amp
->
fœ¡_sync
, 1);

725 
tw5864_’code_time¡amp
->
cu¼_tim”_couÁ
 = 0;

726 
tw5864_’code_time¡amp
->
Ï¡_tim”_couÁ
 = 0;

727 
tw5864_’code_time¡amp
->
tÙ®_d–_tim”_couÁ
 = 
	`g‘_tw_sy¡em_tick
();

728 
	}
}

730 
	$tw5864_’code_time¡amp_£t_time¡amp
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
, 
time¡amp
, *
ÿÎ_â_Çme
)

732 
d–T
;

733 
tw5864_’code_time¡amp
->
cu¼_tim”_couÁ
 = 
time¡amp
;

734 if(
	`©omic_»ad
(&
tw5864_’code_time¡amp
->
fœ¡_sync
)){

735 
	`©omic_£t
(&
tw5864_’code_time¡amp
->
fœ¡_sync
, 0);

736 
d–T
 = 0;

737 
tw5864_’code_time¡amp
->
tÙ®_d–_tim”_couÁ
 = 
	`g‘_tw_sy¡em_tick
();

739 
d–T
 = ((0x10000 + 
tw5864_’code_time¡amp
->
cu¼_tim”_couÁ
 -w5864_’code_time¡amp->
Ï¡_tim”_couÁ
)&0xffff);

741 if(
d–T
 > 1000){

744 
tw5864_’code_time¡amp
->
Ï¡_tim”_couÁ
 =w5864_’code_time¡amp->
cu¼_tim”_couÁ
;

745 
tw5864_’code_time¡amp
->
tÙ®_d–_tim”_couÁ
 +ğ
d–T
;

746 
	}
}

748 
u32
 
	$tw5864_’code_time¡amp_g‘_time¡amp
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
)

750  
tw5864_’code_time¡amp
->
tÙ®_d–_tim”_couÁ
;

751 
	}
}

753 
tw_time¡amp_İ”©iÚ
 
	gtw5864_’code_time¡amp_İ
 = {

754 .
š™
 = 
tw5864_’code_time¡amp_š™
,

755 .
	g»£t
 = 
tw5864_’code_time¡amp_»£t
,

756 .
	g£t_time¡amp
 = 
tw5864_’code_time¡amp_£t_time¡amp
,

757 .
	gg‘_time¡amp
 = 
tw5864_’code_time¡amp_g‘_time¡amp
,

760 
	$š™_tw5864_’code_time¡amp
(
tw_time¡amp_t
 *
tw5864_’code_time¡amp
)

762 
tw5864_’code_time¡amp
->
İ
 = &
tw5864_’code_time¡amp_İ
;

763 
tw5864_’code_time¡amp
->
İ
->
	`š™
(tw5864_encode_timestamp);

764 
	}
}

766 
	$tw_h264_ma¡”_’code_´İ”ty_upd©e_’code_´İ”ty
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
, 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
cÚfig_·¿m
)

768 if(
cÚfig_·¿m
 !ğ
NULL
){

769 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_MASKALL
){

770 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

771 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

772 
æags
;

774 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_´İ”ty
(
’code_´İ”ty
);

775 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

776 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

777 
ruÂšg_·¿m
->
chªgedMask
 |ğ
cÚfig_·¿m
->changedMask;

779 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
){

780 if(
ruÂšg_·¿m
->
videoSnd¬d
 !ğ
cÚfig_·¿m
->videoStandard){

781 
ruÂšg_·¿m
->
videoSnd¬d
 = 
cÚfig_·¿m
->videoStandard;

782 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

783 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
){

784 
ruÂšg_·¿m
->
’codeSize
 = 
cÚfig_·¿m
->encodeSize;

786 
ruÂšg_·¿m
->
videoSnd¬d
){

788 
TW_VIDEO_STANDARD_PAL
:

789 
ruÂšg_·¿m
->
’codeSize
){

790 
TW_VIDEO_SIZE_D1
:

791 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

792 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

794 
TW_VIDEO_SIZE_HALF_D1
:

795 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

796 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>1;

798 
TW_VIDEO_SIZE_CIF
:

799 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

800 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

802 
TW_VIDEO_SIZE_USER
:

803 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_PAL
)){

804 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

806 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

807 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

809 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

810 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

813 
	`´štk
("%s.%d:ƒ¼ƒncodeSiz·¿m\n", 
__FUNCTION__
, 
__LINE__
);

814 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

818 if(
ruÂšg_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

819 
ruÂšg_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

820 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

822 if(
ruÂšg_·¿m
->
ås
 > 
MAX_FRAME_RATE_PAL
){

823 
ruÂšg_·¿m
->
ås
 = 
MAX_FRAME_RATE_PAL
;

824 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

827 
TW_VIDEO_STANDARD_NTSC
:

828 
ruÂšg_·¿m
->
’codeSize
){

829 
TW_VIDEO_SIZE_D1
:

830 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

831 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

833 
TW_VIDEO_SIZE_HALF_D1
:

834 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

835 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
>>1;

837 
TW_VIDEO_SIZE_CIF
:

838 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

839 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

841 
TW_VIDEO_SIZE_USER
:

842 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

843 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

845 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_NTSC
)){

846 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

848 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

849 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

852 
	`´štk
("%s.%d:ƒ¼ƒncodeSiz·¿m\n", 
__FUNCTION__
, 
__LINE__
);

853 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

857 if(
ruÂšg_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

858 
ruÂšg_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

859 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

861 if(
ruÂšg_·¿m
->
ås
 > 
MAX_FRAME_RATE_NTSC
){

862 
ruÂšg_·¿m
->
ås
 = 
MAX_FRAME_RATE_NTSC
;

863 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

866 
TW_VIDEO_STANDARD_USER_DEFINE
:

867 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

868 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

870 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

871 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

873 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

874 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

880 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
){

881 
ruÂšg_·¿m
->
’codeSize
 = 
cÚfig_·¿m
->encodeSize;

882 
ruÂšg_·¿m
->
videoSnd¬d
){

884 
TW_VIDEO_STANDARD_PAL
:

885 
ruÂšg_·¿m
->
’codeSize
){

887 
TW_VIDEO_SIZE_D1
:

888 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

889 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

891 
TW_VIDEO_SIZE_HALF_D1
:

892 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

893 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>1;

895 
TW_VIDEO_SIZE_CIF
:

896 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

897 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

899 
TW_VIDEO_SIZE_USER
:

900 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_PAL
)){

901 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

903 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

904 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

906 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

907 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

911 
TW_VIDEO_STANDARD_NTSC
:

912 
ruÂšg_·¿m
->
’codeSize
){

914 
TW_VIDEO_SIZE_D1
:

915 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

916 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

918 
TW_VIDEO_SIZE_HALF_D1
:

919 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

920 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
>>1;

922 
TW_VIDEO_SIZE_CIF
:

923 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

924 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

926 
TW_VIDEO_SIZE_USER
:

927 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

928 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

930 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_NTSC
)){

931 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

933 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

934 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

938 
TW_VIDEO_STANDARD_USER_DEFINE
:

939 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

940 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

942 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

943 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

945 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

946 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

951 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
){

952 if(
cÚfig_·¿m
->
b™¿‹
 < 
MASTER_MIN_BIT_RATE
){

953 
cÚfig_·¿m
->
b™¿‹
 = 
MASTER_MIN_BIT_RATE
;

955 if(
cÚfig_·¿m
->
b™¿‹
 > 
MASTER_MAX_BIT_RATE
){

956 
cÚfig_·¿m
->
b™¿‹
 = 
MASTER_MAX_BIT_RATE
;

958 
ruÂšg_·¿m
->
b™¿‹
 = 
cÚfig_·¿m
->bitrate;

959 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
;

962 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_FPS_CHANGED
){

963 if(
cÚfig_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

964 
cÚfig_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

966 
ruÂšg_·¿m
->
videoSnd¬d
){

967 
TW_VIDEO_STANDARD_PAL
:

968 if(
cÚfig_·¿m
->
ås
 > 
MAX_FRAME_RATE_PAL
){

969 
cÚfig_·¿m
->
ås
 = 
MAX_FRAME_RATE_PAL
;

973 
TW_VIDEO_STANDARD_NTSC
:

974 if(
cÚfig_·¿m
->
ås
 > 
MAX_FRAME_RATE_NTSC
){

975 
cÚfig_·¿m
->
ås
 = 
MAX_FRAME_RATE_NTSC
;

979 
ruÂšg_·¿m
->
ås
 = 
cÚfig_·¿m
->fps;

980 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

983 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
){

984 
ruÂšg_·¿m
->
keyF¿meIÁ”v®s
 = 
cÚfig_·¿m
->keyFrameIntervals;

985 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
;

988 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
){

989 
ruÂšg_·¿m
->
gİIÁ”v®s
 = 
cÚfig_·¿m
->gopIntervals;

990 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
;

993 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
){

994 
ruÂšg_·¿m
->
imageLev–
 = 
cÚfig_·¿m
->imageLevel;

995 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
;

998 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPI_CHANGED
){

999 
ruÂšg_·¿m
->
qpi
 = 
cÚfig_·¿m
->qpi;

1000 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPI_CHANGED
;

1003 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPP_CHANGED
){

1004 
ruÂšg_·¿m
->
qµ
 = 
cÚfig_·¿m
->qpp;

1005 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPP_CHANGED
;

1008 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPP_CHANGED
){

1009 
ruÂšg_·¿m
->
qpb
 = 
cÚfig_·¿m
->qpb;

1010 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPP_CHANGED
;

1012 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1015 
	}
}

1017 
	$tw_h264_’code_´İ”ty_is_videoSnd¬d_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1019 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1020 
æags
;

1021 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1022 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1023 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1024 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
){

1025 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
;

1026 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1028 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1029  
»t
;

1030 
	}
}

1032 
	$tw_h264_’code_´İ”ty_g‘_videoSnd¬d
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1034  
’code_´İ”ty
->’code_´İ”ty.
videoSnd¬d
;

1035 
	}
}

1037 
	$tw_h264_’code_´İ”ty_is_’codeSize_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1039 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1040 
æags
;

1041 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1042 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1043 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1044 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
){

1045 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1046 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1048 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1049  
»t
;

1050 
	}
}

1052 
	$tw_h264_’code_´İ”ty_g‘_’codeSize
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1054  
’code_´İ”ty
->’code_´İ”ty.
’codeSize
;

1055 
	}
}

1057 
	$tw_h264_’code_´İ”ty_g‘_’codeSize_width
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1059  
’code_´İ”ty
->’code_´İ”ty.
width
;

1060 
	}
}

1062 
	$tw_h264_’code_´İ”ty_g‘_’codeSize_height
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1064  
’code_´İ”ty
->’code_´İ”ty.
height
;

1065 
	}
}

1067 
	$tw_h264_’code_´İ”ty_is_rg‘_b™¿‹_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1069 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1070 
æags
;

1071 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1072 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1073 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1074 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
){

1075 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
;

1076 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1078 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1079  
»t
;

1080 
	}
}

1082 
	$tw_h264_’code_´İ”ty_g‘_rg‘_b™¿‹
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1084  
’code_´İ”ty
->’code_´İ”ty.
b™¿‹
;

1085 
	}
}

1087 
	$tw_h264_’code_´İ”ty_is_rg‘_ås_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1089 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1090 
æags
;

1091 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1092 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1093 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1094 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_FPS_CHANGED
){

1095 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1096 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1098 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1099  
»t
;

1100 
	}
}

1102 
	$tw_h264_’code_´İ”ty_g‘_rg‘_ås
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1104  
’code_´İ”ty
->’code_´İ”ty.
ås
;

1105 
	}
}

1107 
	$tw_h264_’code_´İ”ty_is_keyF¿meIÁ”v®s_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1109 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1110 
æags
;

1111 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1112 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1113 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1114 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
){

1115 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
;

1116 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1118 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1119  
»t
;

1120 
	}
}

1122 
	$tw_h264_’code_´İ”ty_g‘_keyF¿meIÁ”v®s
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1124  
’code_´İ”ty
->’code_´İ”ty.
keyF¿meIÁ”v®s
;

1125 
	}
}

1127 
	$tw_h264_’code_´İ”ty_is_gİIÁ”v®s_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1129 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1130 
æags
;

1131 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1132 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1133 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1134 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
){

1135 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
;

1136 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1138 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1139  
»t
;

1140 
	}
}

1142 
	$tw_h264_’code_´İ”ty_g‘_gİIÁ”v®s
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1144  
’code_´İ”ty
->’code_´İ”ty.
gİIÁ”v®s
;

1145 
	}
}

1147 
	$tw_h264_’code_´İ”ty_is_rcTy³_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1149 
tw_h264_’code_rc_t
 *
ruÂšg_·¿m
;

1150 
æags
;

1151 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1152 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1153 
ruÂšg_·¿m
 = &
’code_´İ”ty
->
’code_rc
;

1154 if(
ruÂšg_·¿m
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
){

1155 
ruÂšg_·¿m
->
chªge_mask_æag
 &ğ~
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
;

1156 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1158 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1159  
»t
;

1160 
	}
}

1162 
	$tw_h264_’code_´İ”ty_g‘_rcTy³
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1164  
’code_´İ”ty
->
’code_rc
.
e_rc_ty³
;

1165 
	}
}

1167 
	$tw_h264_’code_´İ”ty_is_ŸmgeLev–_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1169 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1170 
æags
;

1171 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1172 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1173 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1174 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
){

1175 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
;

1176 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1178 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1179  
»t
;

1180 
	}
}

1182 
	$tw_h264_’code_´İ”ty_g‘_ŸmgeLev–
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1184  
’code_´İ”ty
->’code_´İ”ty.
imageLev–
;

1185 
	}
}

1187 
	$tw_h264_’code_´İ”ty_is_qpi_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1189 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1190 
tw_h264_’code_rc_t
 *
’code_rc
;

1191 
æags
;

1192 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1193 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1194 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1195 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_QPI_CHANGED
){

1196 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_QPI_CHANGED
;

1197 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1199 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1200  
»t
;

1201 
	}
}

1203 
	$tw_h264_’code_´İ”ty_g‘_qpi
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1205  
’code_´İ”ty
->’code_´İ”ty.
qpi
;

1206 
	}
}

1208 
	$tw_h264_’code_´İ”ty_is_qµ_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1210 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1211 
æags
;

1212 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1213 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1214 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1215 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_QPP_CHANGED
){

1216 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_QPP_CHANGED
;

1217 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1219 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1220  
»t
;

1221 
	}
}

1223 
	$tw_h264_’code_´İ”ty_g‘_qµ
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1225  
’code_´İ”ty
->’code_´İ”ty.
qµ
;

1226 
	}
}

1228 
	$tw_h264_’code_´İ”ty_is_qpb_chªged
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1230 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1231 
æags
;

1232 
»t
 = 
TW_ENCODE_PROPERTY_NO_CHANGED
;

1233 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1234 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1235 if(
ruÂšg_·¿m
->
chªgedMask
 & 
TW5864_ENCODE_CONFIG_QPB_CHANGED
){

1236 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_QPB_CHANGED
;

1237 
»t
 = 
TW_ENCODE_PROPERTY_CHANGED
;

1239 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1240  
»t
;

1241 
	}
}

1243 
	$tw_h264_’code_´İ”ty_g‘_qpb
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
)

1245  
’code_´İ”ty
->’code_´İ”ty.
qpb
;

1246 
	}
}

1248 
tw_h264_’code_´İ”ty_İ”©iÚ
 
	gtw_h264_ma¡”_’code_´İ”ty_İ
 = {

1249 .
upd©e_’code_´İ”ty
 = 
tw_h264_ma¡”_’code_´İ”ty_upd©e_’code_´İ”ty
,

1250 .
	gis_videoSnd¬d_chªged
 = 
tw_h264_’code_´İ”ty_is_videoSnd¬d_chªged
,

1251 .
	gg‘_videoSnd¬d
 = 
tw_h264_’code_´İ”ty_g‘_videoSnd¬d
,

1252 .
	gis_’codeSize_chªged
 = 
tw_h264_’code_´İ”ty_is_’codeSize_chªged
,

1253 .
	gg‘_’codeSize
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize
,

1254 .
	gg‘_’codeSize_width
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize_width
,

1255 .
	gg‘_’codeSize_height
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize_height
,

1256 .
	gis_rg‘_b™¿‹_chªged
 = 
tw_h264_’code_´İ”ty_is_rg‘_b™¿‹_chªged
,

1257 .
	gg‘_rg‘_b™¿‹
 = 
tw_h264_’code_´İ”ty_g‘_rg‘_b™¿‹
,

1258 .
	gis_rg‘_ås_chªged
 = 
tw_h264_’code_´İ”ty_is_rg‘_ås_chªged
,

1259 .
	gg‘_rg‘_ås
 = 
tw_h264_’code_´İ”ty_g‘_rg‘_ås
,

1260 .
	gis_keyF¿meIÁ”v®s_chªged
 = 
tw_h264_’code_´İ”ty_is_keyF¿meIÁ”v®s_chªged
,

1261 .
	gg‘_keyF¿meIÁ”v®s
 = 
tw_h264_’code_´İ”ty_g‘_keyF¿meIÁ”v®s
,

1262 .
	gis_gİIÁ”v®s_chªged
 = 
tw_h264_’code_´İ”ty_is_gİIÁ”v®s_chªged
,

1263 .
	gg‘_gİIÁ”v®s
 = 
tw_h264_’code_´İ”ty_g‘_gİIÁ”v®s
,

1264 .
	gis_rcTy³_chªged
 = 
tw_h264_’code_´İ”ty_is_rcTy³_chªged
,

1265 .
	gg‘_rcTy³
 = 
tw_h264_’code_´İ”ty_g‘_rcTy³
,

1266 .
	gis_ŸmgeLev–_chªged
 = 
tw_h264_’code_´İ”ty_is_ŸmgeLev–_chªged
,

1267 .
	gg‘_ŸmgeLev–
 = 
tw_h264_’code_´İ”ty_g‘_ŸmgeLev–
,

1268 .
	gis_qpi_chªged
 = 
tw_h264_’code_´İ”ty_is_qpi_chªged
,

1269 .
	gg‘_qpi
 = 
tw_h264_’code_´İ”ty_g‘_qpi
,

1270 .
	gis_qµ_chªged
 = 
tw_h264_’code_´İ”ty_is_qµ_chªged
,

1271 .
	gg‘_qµ
 = 
tw_h264_’code_´İ”ty_g‘_qµ
,

1272 .
	gis_qpb_chªged
 = 
tw_h264_’code_´İ”ty_is_qpb_chªged
,

1273 .
	gg‘_qpb
 = 
tw_h264_’code_´İ”ty_g‘_qpb
,

1276 
	$tw_h264_’code_ã©u»_š™
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1278 if(
’code_ã©u»
) {

1279 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1281 
ã©u»_·¿m
->
b_’abË_deš‹¾aû
 = 0;

1282 
ã©u»_·¿m
->
b_’abË_h®f_pix–
 = 0;

1283 
ã©u»_·¿m
->
b_’abË_I_4X4
 = 0;

1284 
ã©u»_·¿m
->
b_’abË_qu¬‹r_pix–
 = 0;

1285 
ã©u»_·¿m
->
b_’abË_sk
 = 0;

1286 
ã©u»_·¿m
->
i_mb_d–ay_v®ue
 = 
MB_DELAY_VALUE
;

1287 
ã©u»_·¿m
->
chªge_mask_æag
 = 0x0;

1291 
	}
}

1293 
	$tw_h264_’code_ã©u»_»£t
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1295 if(
’code_ã©u»
) {

1296 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1298 
ã©u»_·¿m
->
b_’abË_deš‹¾aû
 = 0;

1299 
ã©u»_·¿m
->
b_’abË_h®f_pix–
 = 0;

1300 
ã©u»_·¿m
->
b_’abË_I_4X4
 = 0;

1301 
ã©u»_·¿m
->
b_’abË_qu¬‹r_pix–
 = 0;

1302 
ã©u»_·¿m
->
b_’abË_sk
 = 0;

1303 
ã©u»_·¿m
->
i_mb_d–ay_v®ue
 = 
MB_DELAY_VALUE
;

1304 
ã©u»_·¿m
->
chªge_mask_æag
 = 0x0;

1308 
	}
}

1310 
	$tw_h264_’code_ã©u»_g‘_deš‹¾aû
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1312 if(
’code_ã©u»
) {

1313 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1315  
ã©u»_·¿m
->
b_’abË_deš‹¾aû
;

1319 
	}
}

1320 
	$tw_h264_’code_ã©u»_g‘_h®f_pix–
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1322 if(
’code_ã©u»
) {

1323 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1325  
ã©u»_·¿m
->
b_’abË_h®f_pix–
;

1329 
	}
}

1330 
	$tw_h264_’code_ã©u»_g‘_i_4x4
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1332 if(
’code_ã©u»
) {

1333 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1335  
ã©u»_·¿m
->
b_’abË_I_4X4
;

1339 
	}
}

1340 
u32
 
	$tw_h264_’code_ã©u»_g‘_mb_d–ay
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1342 if(
’code_ã©u»
) {

1343 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1345  
ã©u»_·¿m
->
i_mb_d–ay_v®ue
;

1349 
	}
}

1350 
	$tw_h264_’code_ã©u»_g‘_qu¬‹r_pix–
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1352 if(
’code_ã©u»
) {

1353 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1355  
ã©u»_·¿m
->
b_’abË_qu¬‹r_pix–
;

1359 
	}
}

1360 
	$tw_h264_’code_ã©u»_g‘_sk
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
)

1362 if(
’code_ã©u»
) {

1363 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1365  
ã©u»_·¿m
->
b_’abË_sk
;

1369 
	}
}

1370 
	$tw_h264_’code_ã©u»_upd©e_deš‹¾aû
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
’abË
)

1372 if(
’code_ã©u»
) {

1373 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1375 
ã©u»_·¿m
->
b_’abË_deš‹¾aû
 = 
’abË
;

1379 
	}
}

1380 
	$tw_h264_’code_ã©u»_upd©e_h®f_pix–
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
’abË
)

1382 if(
’code_ã©u»
) {

1383 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1385 
ã©u»_·¿m
->
b_’abË_h®f_pix–
 = 
’abË
;

1389 
	}
}

1390 
	$tw_h264_’code_ã©u»_upd©e_i_4x4
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
’abË
)

1392 if(
’code_ã©u»
) {

1393 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1395 
ã©u»_·¿m
->
b_’abË_I_4X4
 = 
’abË
;

1399 
	}
}

1400 
	$tw_h264_’code_ã©u»_upd©e_mb_d–ay
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
u32
 
d–ay
)

1402 if(
’code_ã©u»
) {

1403 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1405 
ã©u»_·¿m
->
i_mb_d–ay_v®ue
 = 
d–ay
;

1409 
	}
}

1410 
	$tw_h264_’code_ã©u»_upd©e_qu¬‹r_pix–
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
’abË
)

1412 if(
’code_ã©u»
) {

1413 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1415 
ã©u»_·¿m
->
b_’abË_qu¬‹r_pix–
 = 
’abË
;

1419 
	}
}

1420 
	$tw_h264_’code_ã©u»_upd©e_sk
(
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
, 
’abË
)

1422 if(
’code_ã©u»
) {

1423 
tw_h264_’code_ã©u»_·¿m_t
 *
ã©u»_·¿m
 = &
’code_ã©u»
->feature_param;

1426 
	`TW_DBG
(
TW_DBG_DEBUG
, "ignor skip mode\n");

1427 
ã©u»_·¿m
->
b_’abË_sk
 = 0;

1431 
	}
}

1433 
tw_h264_’code_ã©u»_İ”©iÚ_t
 
	gtw_h264_’code_ã©u»_İ”©iÚ_İ
 = {

1434 .
š™
 = 
tw_h264_’code_ã©u»_š™
,

1435 .
	g»£t
 = 
tw_h264_’code_ã©u»_»£t
,

1437 .
	gg‘_deš‹¾aû
 = 
tw_h264_’code_ã©u»_g‘_deš‹¾aû
,

1438 .
	gg‘_h®f_pix–
 = 
tw_h264_’code_ã©u»_g‘_h®f_pix–
,

1439 .
	gg‘_i_4x4
 = 
tw_h264_’code_ã©u»_g‘_i_4x4
,

1440 .
	gg‘_mb_d–ay
 = 
tw_h264_’code_ã©u»_g‘_mb_d–ay
,

1441 .
	gg‘_qu¬‹r_pix–
 = 
tw_h264_’code_ã©u»_g‘_qu¬‹r_pix–
,

1442 .
	gg‘_sk
 = 
tw_h264_’code_ã©u»_g‘_sk
,

1444 .
	gupd©e_deš‹¾aû
 = 
tw_h264_’code_ã©u»_upd©e_deš‹¾aû
,

1445 .
	gupd©e_h®f_pix–
 = 
tw_h264_’code_ã©u»_upd©e_h®f_pix–
,

1446 .
	gupd©e_i_4x4
 = 
tw_h264_’code_ã©u»_upd©e_i_4x4
,

1447 .
	gupd©e_mb_d–ay
 = 
tw_h264_’code_ã©u»_upd©e_mb_d–ay
,

1448 .
	gupd©e_qu¬‹r_pix–
 = 
tw_h264_’code_ã©u»_upd©e_qu¬‹r_pix–
,

1449 .
	gupd©e_sk
 = 
tw_h264_’code_ã©u»_upd©e_sk
,

1452 
	$š™_tw5864_h264_ma¡”_’code_´İ”ty
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
, 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
cÚfig_·¿m
)

1454 
tw_h264_’code_ã©u»_·¿m_t
 *
pã©u»
;

1455 
tw_h264_’code_ã©u»_t
 *
´uÂšg_ã©u»
;

1456 
tw_h264_’code_rc_t
 *
p_rc
, *
´uÂšg_rc
;

1457 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_·¿m
;

1459 if(
cÚfig_·¿m
 =ğ
NULL
){

1460 
tw_h264_logic_’code_chª_t
 *
h264_logic_chª
;

1461 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

1462 
dvm_ch_t
 *
ch
;

1463 
ch_driv”_t
 *
ch_driv”
;

1464 
tw_video_bus_t
 *
video_bus
;

1467 
	`memıy
(&
’code_·¿m
, &
deçuÉ_h264_ma¡”_’code_´İ”ty
, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

1468 
h264_logic_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_´İ”ty
(
’code_´İ”ty
);

1469 
ch
 = 
h264_logic_chª
->chip;

1470 
ch_driv”
 = 
ch
->chip_driver;

1471 
video_bus
 = &
ch_driv”
->video_bus;

1473 
cÚfig_·¿m
 = &
’code_·¿m
;

1474 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

1475 
cÚfig_·¿m
->
videoSnd¬d
 = 
TW_VIDEO_STANDARD_PAL
;

1476 }if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_NTSC
){

1477 
cÚfig_·¿m
->
videoSnd¬d
 = 
TW_VIDEO_STANDARD_NTSC
;

1479 
	`TW_DBG
(
TW_DBG_FATAL
, "unknowÀvideØ¡ªd¬d %d\n", 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

1481 
	`TW_DBG
(
TW_DBG_DEBUG
, "š™†ogiøchªÃÈ%dØ%s\n", 
h264_logic_chª
->
logic_chª_id
, (
cÚfig_·¿m
->
videoSnd¬d
 =ğ
TW_VIDEO_STANDARD_PAL
)?"PAL":"NTSC");

1482 
phy_video_¦Ù
 = 
h264_logic_chª
->
ma¡”_¦Ù
;

1483 
cÚfig_·¿m
->
’codeSize
 = 
phy_video_¦Ù
->
İ
->
	`g‘_video_size
(phy_video_slot);

1485 
	`¥š_lock_š™
(&
’code_´İ”ty
->
lock
);

1486 
’code_´İ”ty
->
İ
 = &
tw_h264_ma¡”_’code_´İ”ty_İ
;

1487 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, 
cÚfig_·¿m
);

1489 
´uÂšg_ã©u»
 = &
’code_´İ”ty
->
’code_ã©u»
;

1490 
pã©u»
 = &
deçuÉ_maš_’code_ã©u»
;

1491 
´uÂšg_ã©u»
->
İ
 = &
tw_h264_’code_ã©u»_İ”©iÚ_İ
;

1492 
´uÂšg_ã©u»
->
İ
->
	`š™
(prunning_feature);

1493 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
) {

1494 
´uÂšg_ã©u»
->
İ
->
	`upd©e_deš‹¾aû
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_deš‹¾aû
);

1496 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_SKIP_MASK
) {

1497 
´uÂšg_ã©u»
->
İ
->
	`upd©e_sk
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_sk
);

1499 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_I_4X4_MASK
) {

1500 
´uÂšg_ã©u»
->
İ
->
	`upd©e_i_4x4
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_I_4X4
);

1502 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENABLE_CHANGE_HALF_PIXEL_MASK
) {

1503 
´uÂšg_ã©u»
->
İ
->
	`upd©e_h®f_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_h®f_pix–
);

1505 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_QUARTER_PIXEL_MASK
) {

1506 
´uÂšg_ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_qu¬‹r_pix–
);

1508 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_MB_DELAY_MASK
) {

1509 
´uÂšg_ã©u»
->
İ
->
	`upd©e_mb_d–ay
ÕruÂšg_ã©u», 
pã©u»
->
i_mb_d–ay_v®ue
);

1513 
´uÂšg_rc
 = &
’code_´İ”ty
->
’code_rc
;

1514 
p_rc
 = &
deçuÉ_maš_’code_rc
;

1515 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
) {

1516 if((
p_rc
->
e_image_´iÜ™y
 >ğ
TW_RC_IMAGE_QUALITY_FIRST
è&& (p_rc->e_image_´iÜ™y <ğ
TW_RC_IMAGE_SMOOTH_FIRST
)) {

1517 
´uÂšg_rc
->
e_image_´iÜ™y
 = 
p_rc
->e_image_priority;

1519 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀimage_´iÜ™y %d\n", 
p_rc
->
e_image_´iÜ™y
);

1522 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
) {

1523 if((
p_rc
->
e_rc_ty³
 >ğ
TW_H264_NO_RC
è&& (p_rc->e_rc_ty³ <ğ
TW_H264_VBR
)) {

1524 
´uÂšg_rc
->
e_rc_ty³
 = 
p_rc
->e_rc_type;

1526 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀrc_ty³ %d\n", 
p_rc
->
e_rc_ty³
);

1529 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
) {

1530 if((
p_rc
->
i_deçuÉ_qp
 >ğ
QUANT_SCALE_MIN
è&& (p_rc->i_deçuÉ_q°<ğ
QUANT_SCALE_MAX
)) {

1531 
´uÂšg_rc
->
i_deçuÉ_qp
 = 
p_rc
->i_default_qp;

1533 
	`TW_DBG
(
TW_DBG_ERR
, "deçuÉ_q°%dƒ¼Ü, [%d, %d]\n", 
p_rc
->
i_deçuÉ_qp
, 
QUANT_SCALE_MIN
, 
QUANT_SCALE_MAX
);

1536 
	}
}

1538 
	$tw_h264_sub_’code_´İ”ty_upd©e_’code_´İ”ty
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
, 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
cÚfig_·¿m
)

1540 if(
cÚfig_·¿m
 !ğ
NULL
){

1541 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_MASKALL
){

1542 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
ruÂšg_·¿m
;

1543 
æags
;

1545 
	`¥š_lock_œq§ve
(&
’code_´İ”ty
->
lock
, 
æags
);

1546 
ruÂšg_·¿m
 = &
’code_´İ”ty
->encode_property;

1547 
ruÂšg_·¿m
->
chªgedMask
 |ğ
cÚfig_·¿m
->changedMask;

1549 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
){

1550 if(
ruÂšg_·¿m
->
videoSnd¬d
 !ğ
cÚfig_·¿m
->videoStandard){

1551 
ruÂšg_·¿m
->
videoSnd¬d
 = 
cÚfig_·¿m
->videoStandard;

1552 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1553 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
){

1554 
ruÂšg_·¿m
->
’codeSize
 = 
cÚfig_·¿m
->encodeSize;

1556 
ruÂšg_·¿m
->
videoSnd¬d
){

1557 
TW_VIDEO_STANDARD_PAL
:

1558 
ruÂšg_·¿m
->
’codeSize
){

1559 
TW_VIDEO_SIZE_D1
:

1560 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

1561 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

1563 
TW_VIDEO_SIZE_HALF_D1
:

1564 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

1565 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>1;

1567 
TW_VIDEO_SIZE_CIF
:

1568 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

1569 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

1571 
TW_VIDEO_SIZE_QHALF_D1
:

1572 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
>>1;

1573 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>2;

1575 
TW_VIDEO_SIZE_QCIF
:

1576 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
>>1;

1577 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
>>1;

1579 
TW_VIDEO_SIZE_USER
:

1580 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_PAL
)){

1581 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

1583 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

1584 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

1586 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

1587 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

1590 
	`TW_DBG
(
TW_DBG_ERR
, "errƒncodeSize…aram\n");

1591 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1595 if(
cÚfig_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

1596 
ruÂšg_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

1597 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1599 if(
ruÂšg_·¿m
->
ås
 > 
MAX_FRAME_RATE_PAL
){

1600 
ruÂšg_·¿m
->
ås
 = 
MAX_FRAME_RATE_PAL
;

1601 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1604 
TW_VIDEO_STANDARD_NTSC
:

1605 
ruÂšg_·¿m
->
’codeSize
){

1606 
TW_VIDEO_SIZE_D1
:

1607 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

1608 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

1610 
TW_VIDEO_SIZE_HALF_D1
:

1611 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

1612 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
>>1;

1614 
TW_VIDEO_SIZE_CIF
:

1615 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

1616 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

1618 
TW_VIDEO_SIZE_QHALF_D1
:

1619 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
>>1;

1620 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
>>2;

1622 
TW_VIDEO_SIZE_QCIF
:

1623 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
>>1;

1624 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
>>1;

1626 
TW_VIDEO_SIZE_USER
:

1627 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

1628 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

1630 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_NTSC
)){

1631 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

1633 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

1634 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

1637 
	`TW_DBG
(
TW_DBG_ERR
, "errƒncodeSize…aram\n");

1638 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1642 if(
ruÂšg_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

1643 
ruÂšg_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

1644 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1646 if(
ruÂšg_·¿m
->
ås
 > 
MAX_FRAME_RATE_NTSC
){

1647 
ruÂšg_·¿m
->
ås
 = 
MAX_FRAME_RATE_NTSC
;

1648 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1652 
	`TW_DBG
(
TW_DBG_ERR
, "err videoStandard…aram\n");

1653 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
;

1659 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
){

1660 
ruÂšg_·¿m
->
’codeSize
 = 
cÚfig_·¿m
->encodeSize;

1661 
ruÂšg_·¿m
->
videoSnd¬d
){

1662 
TW_VIDEO_STANDARD_PAL
:

1663 
ruÂšg_·¿m
->
’codeSize
){

1664 
TW_VIDEO_SIZE_D1
:

1665 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

1666 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
;

1668 
TW_VIDEO_SIZE_HALF_D1
:

1669 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
;

1670 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>1;

1672 
TW_VIDEO_SIZE_CIF
:

1673 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

1674 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

1676 
TW_VIDEO_SIZE_QHALF_D1
:

1677 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_PAL
>>1;

1678 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_PAL
>>2;

1680 
TW_VIDEO_SIZE_QCIF
:

1681 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
>>1;

1682 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
>>1;

1684 
TW_VIDEO_SIZE_USER
:

1685 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_PAL
)){

1686 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_CIF_PAL
;

1688 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_PAL
)){

1689 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_PAL
;

1691 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

1692 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

1695 
	`´štk
("%s.%d:ƒ¼ƒncodeSiz·¿m\n", 
__FUNCTION__
, 
__LINE__
);

1696 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1700 
TW_VIDEO_STANDARD_NTSC
:

1701 
ruÂšg_·¿m
->
’codeSize
){

1702 
TW_VIDEO_SIZE_D1
:

1703 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

1704 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
;

1706 
TW_VIDEO_SIZE_HALF_D1
:

1707 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
;

1708 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
>>1;

1710 
TW_VIDEO_SIZE_CIF
:

1711 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

1712 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

1714 
TW_VIDEO_SIZE_QHALF_D1
:

1715 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_D1_NTSC
>>1;

1716 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_D1_NTSC
>>2;

1718 
TW_VIDEO_SIZE_QCIF
:

1719 
ruÂšg_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
>>1;

1720 
ruÂšg_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
>>1;

1722 
TW_VIDEO_SIZE_USER
:

1723 if((
cÚfig_·¿m
->
width
<=0è|| (cÚfig_·¿m->width>=
WIDTH_FRAME_D1_NTSC
)){

1724 
cÚfig_·¿m
->
width
 = 
WIDTH_FRAME_CIF_NTSC
;

1726 if((
cÚfig_·¿m
->
height
<=0è|| (cÚfig_·¿m->height>=
HEIGHT_FRAME_D1_NTSC
)){

1727 
cÚfig_·¿m
->
height
 = 
HEIGHT_FRAME_CIF_NTSC
;

1729 
ruÂšg_·¿m
->
width
 = 
cÚfig_·¿m
->width;

1730 
ruÂšg_·¿m
->
height
 = 
cÚfig_·¿m
->height;

1733 
	`´štk
("%s.%d:ƒ¼ƒncodeSiz·¿m\n", 
__FUNCTION__
, 
__LINE__
);

1734 
ruÂšg_·¿m
->
chªgedMask
 &ğ~
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

1739 
	`´štk
("%s.%d:ƒ¼ video¡ªd¬d…¬am\n", 
__FUNCTION__
, 
__LINE__
);

1740 
ruÂšg_·¿m
->
chªgedMask
 &ğ~(
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
|
TW5864_ENCODE_CONFIG_VIDEO_STANDARD_CHANGED
);

1745 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
){

1746 if(
cÚfig_·¿m
->
b™¿‹
 < 
SUB_MIN_BIT_RATE
){

1747 
cÚfig_·¿m
->
b™¿‹
 = 
SUB_MIN_BIT_RATE
;

1749 if(
cÚfig_·¿m
->
b™¿‹
 > 
SUB_MAX_BIT_RATE
){

1750 
cÚfig_·¿m
->
b™¿‹
 = 
SUB_MAX_BIT_RATE
;

1752 
ruÂšg_·¿m
->
b™¿‹
 = 
cÚfig_·¿m
->bitrate;

1753 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
;

1756 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_FPS_CHANGED
){

1757 if(
cÚfig_·¿m
->
ås
 < 
MIN_FRAME_RATE
){

1758 
cÚfig_·¿m
->
ås
 = 
MIN_FRAME_RATE
;

1760 
ruÂšg_·¿m
->
videoSnd¬d
){

1761 
TW_VIDEO_STANDARD_PAL
:

1762 if(
cÚfig_·¿m
->
ås
 > 
MAX_FRAME_RATE_PAL
){

1763 
cÚfig_·¿m
->
ås
 = 
MAX_FRAME_RATE_PAL
;

1767 
TW_VIDEO_STANDARD_NTSC
:

1768 if(
cÚfig_·¿m
->
ås
 > 
MAX_FRAME_RATE_NTSC
){

1769 
cÚfig_·¿m
->
ås
 = 
MAX_FRAME_RATE_NTSC
;

1773 
ruÂšg_·¿m
->
ås
 = 
cÚfig_·¿m
->fps;

1774 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

1777 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
){

1778 
ruÂšg_·¿m
->
keyF¿meIÁ”v®s
 = 
cÚfig_·¿m
->keyFrameIntervals;

1779 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
;

1782 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
){

1783 
ruÂšg_·¿m
->
gİIÁ”v®s
 = 
cÚfig_·¿m
->gopIntervals;

1784 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
;

1787 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
){

1788 
ruÂšg_·¿m
->
imageLev–
 = 
cÚfig_·¿m
->imageLevel;

1789 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_IMAGE_LEVEL_CHANGED
;

1792 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPI_CHANGED
){

1793 
ruÂšg_·¿m
->
qpi
 = 
cÚfig_·¿m
->qpi;

1794 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPI_CHANGED
;

1797 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPP_CHANGED
){

1798 
ruÂšg_·¿m
->
qµ
 = 
cÚfig_·¿m
->qpp;

1799 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPP_CHANGED
;

1802 if(
cÚfig_·¿m
->
chªgedMask
&
TW5864_ENCODE_CONFIG_QPP_CHANGED
){

1803 
ruÂšg_·¿m
->
qpb
 = 
cÚfig_·¿m
->qpb;

1804 
ruÂšg_·¿m
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPP_CHANGED
;

1807 
	`¥š_uÆock_œq»¡Üe
(&
’code_´İ”ty
->
lock
, 
æags
);

1810 
	}
}

1812 
tw_h264_’code_´İ”ty_İ”©iÚ
 
	gtw_h264_sub_’code_´İ”ty_İ
 = {

1813 .
upd©e_’code_´İ”ty
 = 
tw_h264_sub_’code_´İ”ty_upd©e_’code_´İ”ty
,

1814 .
	gis_videoSnd¬d_chªged
 = 
tw_h264_’code_´İ”ty_is_videoSnd¬d_chªged
,

1815 .
	gg‘_videoSnd¬d
 = 
tw_h264_’code_´İ”ty_g‘_videoSnd¬d
,

1816 .
	gis_’codeSize_chªged
 = 
tw_h264_’code_´İ”ty_is_’codeSize_chªged
,

1817 .
	gg‘_’codeSize
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize
,

1818 .
	gg‘_’codeSize_width
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize_width
,

1819 .
	gg‘_’codeSize_height
 = 
tw_h264_’code_´İ”ty_g‘_’codeSize_height
,

1820 .
	gis_rg‘_b™¿‹_chªged
 = 
tw_h264_’code_´İ”ty_is_rg‘_b™¿‹_chªged
,

1821 .
	gg‘_rg‘_b™¿‹
 = 
tw_h264_’code_´İ”ty_g‘_rg‘_b™¿‹
,

1822 .
	gis_rg‘_ås_chªged
 = 
tw_h264_’code_´İ”ty_is_rg‘_ås_chªged
,

1823 .
	gg‘_rg‘_ås
 = 
tw_h264_’code_´İ”ty_g‘_rg‘_ås
,

1824 .
	gis_keyF¿meIÁ”v®s_chªged
 = 
tw_h264_’code_´İ”ty_is_keyF¿meIÁ”v®s_chªged
,

1825 .
	gg‘_keyF¿meIÁ”v®s
 = 
tw_h264_’code_´İ”ty_g‘_keyF¿meIÁ”v®s
,

1826 .
	gis_gİIÁ”v®s_chªged
 = 
tw_h264_’code_´İ”ty_is_gİIÁ”v®s_chªged
,

1827 .
	gg‘_gİIÁ”v®s
 = 
tw_h264_’code_´İ”ty_g‘_gİIÁ”v®s
,

1828 .
	gis_rcTy³_chªged
 = 
tw_h264_’code_´İ”ty_is_rcTy³_chªged
,

1829 .
	gg‘_rcTy³
 = 
tw_h264_’code_´İ”ty_g‘_rcTy³
,

1830 .
	gis_ŸmgeLev–_chªged
 = 
tw_h264_’code_´İ”ty_is_ŸmgeLev–_chªged
,

1831 .
	gg‘_ŸmgeLev–
 = 
tw_h264_’code_´İ”ty_g‘_ŸmgeLev–
,

1832 .
	gis_qpi_chªged
 = 
tw_h264_’code_´İ”ty_is_qpi_chªged
,

1833 .
	gg‘_qpi
 = 
tw_h264_’code_´İ”ty_g‘_qpi
,

1834 .
	gis_qµ_chªged
 = 
tw_h264_’code_´İ”ty_is_qµ_chªged
,

1835 .
	gg‘_qµ
 = 
tw_h264_’code_´İ”ty_g‘_qµ
,

1836 .
	gis_qpb_chªged
 = 
tw_h264_’code_´İ”ty_is_qpb_chªged
,

1837 .
	gg‘_qpb
 = 
tw_h264_’code_´İ”ty_g‘_qpb
,

1840 
	$š™_tw5864_h264_sub_’code_´İ”ty
(
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
, 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
cÚfig_·¿m
)

1843 
tw_h264_’code_ã©u»_·¿m_t
 *
pã©u»
;

1844 
tw_h264_’code_ã©u»_t
 *
´uÂšg_ã©u»
;

1845 
tw_h264_’code_rc_t
 *
p_rc
, *
´uÂšg_rc
;

1846 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_·¿m
;

1848 if(
cÚfig_·¿m
 =ğ
NULL
){

1849 
tw_h264_logic_’code_chª_t
 *
h264_logic_chª
;

1850 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

1851 
dvm_ch_t
 *
ch
;

1852 
ch_driv”_t
 *
ch_driv”
;

1853 
tw_video_bus_t
 *
video_bus
;

1855 
	`memıy
(&
’code_·¿m
, &
deçuÉ_h264_sub_’code_´İ”ty
, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

1856 
h264_logic_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_´İ”ty
(
’code_´İ”ty
);

1857 
ch
 = 
h264_logic_chª
->chip;

1858 
ch_driv”
 = 
ch
->chip_driver;

1859 
video_bus
 = &
ch_driv”
->video_bus;

1861 
cÚfig_·¿m
 = &
’code_·¿m
;

1862 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

1863 
cÚfig_·¿m
->
videoSnd¬d
 = 
TW_VIDEO_STANDARD_PAL
;

1864 }if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_NTSC
){

1865 
cÚfig_·¿m
->
videoSnd¬d
 = 
TW_VIDEO_STANDARD_NTSC
;

1867 
	`TW_DBG
(
TW_DBG_FATAL
, "unknowÀvideØ¡ªd¬d %d\n", 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

1869 
phy_video_¦Ù
 = 
h264_logic_chª
->
ma¡”_¦Ù
;

1870 
phy_video_¦Ù
->
İ
->
	`g‘_video_size
(phy_video_slot)) {

1872 
TW_VIDEO_SIZE_QCIF
:

1873 
cÚfig_·¿m
->
’codeSize
 = 
TW_VIDEO_SIZE_QCIF
;

1874 
TW_VIDEO_SIZE_D1
:

1875 
cÚfig_·¿m
->
’codeSize
 = 
TW_VIDEO_SIZE_CIF
;

1877 
TW_VIDEO_SIZE_HALF_D1
:

1878 
cÚfig_·¿m
->
’codeSize
 = 
TW_VIDEO_SIZE_CIF
;

1880 
TW_VIDEO_SIZE_CIF
:

1881 
cÚfig_·¿m
->
’codeSize
 = 
TW_VIDEO_SIZE_QCIF
;

1885 
	`¥š_lock_š™
(&
’code_´İ”ty
->
lock
);

1886 
’code_´İ”ty
->
İ
 = &
tw_h264_sub_’code_´İ”ty_İ
;

1887 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, 
cÚfig_·¿m
);

1890 
´uÂšg_ã©u»
 = &
’code_´İ”ty
->
’code_ã©u»
;

1891 
pã©u»
 = &
deçuÉ_sub_’code_ã©u»
;

1892 
´uÂšg_ã©u»
->
İ
 = &
tw_h264_’code_ã©u»_İ”©iÚ_İ
;

1893 
´uÂšg_ã©u»
->
İ
->
	`š™
(prunning_feature);

1894 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
) {

1895 
´uÂšg_ã©u»
->
İ
->
	`upd©e_deš‹¾aû
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_deš‹¾aû
);

1897 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_SKIP_MASK
) {

1898 
´uÂšg_ã©u»
->
İ
->
	`upd©e_sk
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_sk
);

1900 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_I_4X4_MASK
) {

1901 
´uÂšg_ã©u»
->
İ
->
	`upd©e_i_4x4
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_I_4X4
);

1903 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENABLE_CHANGE_HALF_PIXEL_MASK
) {

1904 
´uÂšg_ã©u»
->
İ
->
	`upd©e_h®f_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_h®f_pix–
);

1906 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_QUARTER_PIXEL_MASK
) {

1907 
´uÂšg_ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_qu¬‹r_pix–
);

1909 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_MB_DELAY_MASK
) {

1910 
´uÂšg_ã©u»
->
İ
->
	`upd©e_mb_d–ay
ÕruÂšg_ã©u», 
pã©u»
->
i_mb_d–ay_v®ue
);

1914 
´uÂšg_rc
 = &
’code_´İ”ty
->
’code_rc
;

1915 
p_rc
 = &
deçuÉ_sub_’code_rc
;

1916 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
) {

1917 if((
p_rc
->
e_image_´iÜ™y
 >ğ
TW_RC_IMAGE_QUALITY_FIRST
è&& (p_rc->e_image_´iÜ™y <ğ
TW_RC_IMAGE_SMOOTH_FIRST
)) {

1918 
´uÂšg_rc
->
e_image_´iÜ™y
 = 
p_rc
->e_image_priority;

1920 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀimage_´iÜ™y %d\n", 
p_rc
->
e_image_´iÜ™y
);

1923 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
) {

1924 if((
p_rc
->
e_rc_ty³
 >ğ
TW_H264_NO_RC
è&& (p_rc->e_rc_ty³ <ğ
TW_H264_VBR
)) {

1925 
´uÂšg_rc
->
e_rc_ty³
 = 
p_rc
->e_rc_type;

1927 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀrc_ty³ %d\n", 
p_rc
->
e_rc_ty³
);

1930 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
) {

1931 if((
p_rc
->
i_deçuÉ_qp
 >ğ
QUANT_SCALE_MIN
è&& (p_rc->i_deçuÉ_q°<ğ
QUANT_SCALE_MAX
)) {

1932 
´uÂšg_rc
->
i_deçuÉ_qp
 = 
p_rc
->i_default_qp;

1934 
	`TW_DBG
(
TW_DBG_ERR
, "deçuÉ_q°%dƒ¼Ü, [%d, %d]\n", 
p_rc
->
i_deçuÉ_qp
, 
QUANT_SCALE_MIN
, 
QUANT_SCALE_MAX
);

1937 
	}
}

1939 
	$tw_h264_logic_video_¦Ù_š™
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
logic_¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
)

1941 if(
logic_video_¦Ù
 !ğ
NULL
){

1942 
logic_video_¦Ù
->
logicSlÙId
 = 
logic_¦Ù_id
;

1943 
logic_video_¦Ù
->
m­PhySlÙId
 = 
TW5864_LOGIC_VD_INVALID
;

1944 
logic_video_¦Ù
->
disÿrdTabË
 = 0;

1945 
logic_video_¦Ù
->
roundTabËSŒide
 = 0;

1946 
logic_video_¦Ù
->
video_size
 = video_size;

1947 
logic_video_¦Ù
->
’abËSlÙ
 = 0;

1948 
logic_video_¦Ù
->
¦ÙFps
 = 0;

1949 
logic_video_¦Ù
->
hÜ_»v”£
= 0;

1950 
logic_video_¦Ù
->
v”_»v”£
= 0;

1951 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 0);

1953 
	}
}

1955 
	$tw_h264_logic_video_¦Ù_£t_m­PhySlÙId
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
phy_¦Ù_id
)

1957 if(
logic_video_¦Ù
 !ğ
NULL
) {

1958 
logic_video_¦Ù
->
m­PhySlÙId
 = 
phy_¦Ù_id
;

1960 
	}
}

1962 
	$tw_h264_logic_video_¦Ù_g‘_m­PhySlÙId
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
phy_¦Ù
)

1964 if(
logic_video_¦Ù
)

1966  
logic_video_¦Ù
->
m­PhySlÙId
;

1972 
	}
}

1974 
	$tw_h264_logic_video_¦Ù_£t_disÿrdTabË
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
u32
 
disÿrdTabË
)

1976 if(
logic_video_¦Ù
)

1978 
logic_video_¦Ù
->
disÿrdTabË
 = discardTable;

1982 
	}
}

1984 
u32
 
	$tw_h264_logic_video_¦Ù_g‘_disÿrdTabË
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

1986 if(
logic_video_¦Ù
)

1988  
logic_video_¦Ù
->
disÿrdTabË
;

1994 
	}
}

1996 
	$tw_h264_logic_video_¦Ù_£t_roundTabËSŒide
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
roundTabËSŒide
)

1998 if(
logic_video_¦Ù
)

2000 
logic_video_¦Ù
->
roundTabËSŒide
 =„oundTableStride;

2004 
	}
}

2006 
	$tw_h264_logic_video_¦Ù_g‘_roundTabËSŒide
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2008 if(
logic_video_¦Ù
)

2010  
logic_video_¦Ù
->
roundTabËSŒide
;

2016 
	}
}

2018 
	$tw_h264_logic_video_¦Ù_ş—r_ÃedUpd©eFÏg
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2020 if(
logic_video_¦Ù
)

2022 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 0);

2026 
	}
}

2028 
	$tw_h264_logic_video_¦Ù_g‘_ÃedUpd©eFÏg
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2030 if(
logic_video_¦Ù
)

2032  
	`©omic_»ad
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
);

2038 
	}
}

2040 
	$tw_h264_logic_video_¦Ù_g‘_video_size
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2042 if(
logic_video_¦Ù
) {

2043  
logic_video_¦Ù
->
video_size
;

2046 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

2047  
TW_VIDEO_SIZE_D1
;

2048 
	}
}

2050 
	$tw_h264_logic_video_¦Ù_£t_video_size
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
TW_VIDEO_SIZE
 
video_size
)

2052 if(
logic_video_¦Ù
) {

2053 
logic_video_¦Ù
->
video_size
 = video_size;

2055 
	}
}

2057 
u32
 
	$tw_h264_logic_video_¦Ù_g‘_’abË¦Ù
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2059 if(
logic_video_¦Ù
) {

2060  
logic_video_¦Ù
->
’abËSlÙ
;

2064 
	}
}

2066 
	$tw_h264_logic_video_¦Ù_£t_’abË¦Ù
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
u32
 
’abË
)

2068 if(
logic_video_¦Ù
) {

2069 
logic_video_¦Ù
->
’abËSlÙ
 = 
’abË
;

2071 
	}
}

2073 
u32
 
	$tw_h264_logic_video_¦Ù_g‘_ås
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

2075 if(
logic_video_¦Ù
) {

2076  
logic_video_¦Ù
->
¦ÙFps
;

2080 
	}
}

2082 
	$tw_h264_logic_video_¦Ù_£t_ås
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
u32
 
ås
)

2084 if(
logic_video_¦Ù
) {

2085 
logic_video_¦Ù
->
¦ÙFps
 = 
ås
;

2087 
	}
}

2089 
	$tw_h264_logic_video_¦Ù_£t_ch_’d_logic_video_¦Ù_·¿m
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
dvm_ch_t
 *
ch
)

2092 
	}
}

2094 
u32
 
	$tw_h264_logic_video_¦Ù_g‘_ch_’d_logic_video_¦Ù_·¿m
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
dvm_ch_t
 *
ch
)

2100 
	}
}

2102 
tw_h264_logic_video_¦Ù_İ”©iÚ
 
	gtw_h264_logic_video_¦Ù_İ
 = {

2103 .
š™
 = 
tw_h264_logic_video_¦Ù_š™
,

2104 .
	g£t_m­PhySlÙId
 = 
tw_h264_logic_video_¦Ù_£t_m­PhySlÙId
,

2105 .
	gg‘_m­PhySlÙId
 = 
tw_h264_logic_video_¦Ù_g‘_m­PhySlÙId
,

2106 .
	g£t_disÿrdTabË
 = 
tw_h264_logic_video_¦Ù_£t_disÿrdTabË
,

2107 .
	gg‘_disÿrdTabË
 = 
tw_h264_logic_video_¦Ù_g‘_disÿrdTabË
,

2108 .
	g£t_roundTabËSŒide
 = 
tw_h264_logic_video_¦Ù_£t_roundTabËSŒide
,

2109 .
	gg‘_roundTabËSŒide
 = 
tw_h264_logic_video_¦Ù_g‘_roundTabËSŒide
,

2110 .
	gş—r_ÃedUpd©eFÏg
 = 
tw_h264_logic_video_¦Ù_ş—r_ÃedUpd©eFÏg
,

2111 .
	gg‘_ÃedUpd©eFÏg
 = 
tw_h264_logic_video_¦Ù_g‘_ÃedUpd©eFÏg
,

2112 .
	gg‘_video_size
 = 
tw_h264_logic_video_¦Ù_g‘_video_size
,

2113 .
	g£t_video_size
 = 
tw_h264_logic_video_¦Ù_£t_video_size
,

2114 .
	gg‘_’abË¦Ù
 = 
tw_h264_logic_video_¦Ù_g‘_’abË¦Ù
,

2115 .
	g£t_’abË¦Ù
 = 
tw_h264_logic_video_¦Ù_£t_’abË¦Ù
,

2116 .
	gg‘_ås
 = 
tw_h264_logic_video_¦Ù_g‘_ås
,

2117 .
	g£t_ås
 = 
tw_h264_logic_video_¦Ù_£t_ås
,

2119 .
	g£t_ch_’d_logic_video_¦Ù_·¿m
 = 
tw_h264_logic_video_¦Ù_£t_ch_’d_logic_video_¦Ù_·¿m
,

2120 .
	gg‘_ch_’d_logic_video_¦Ù_·¿m
 = 
tw_h264_logic_video_¦Ù_g‘_ch_’d_logic_video_¦Ù_·¿m
,

2123 
	$cÚfig_£nif_bus
(
tw5864_vd_üoss_bus_t
 *
vd_bus
, 
bus_id
, 
mode
)

2125 
u32
 
v®
 = 0, 
i
 = 0, 
fuÎ_size
 = 0, 
·¹ab_£Ëù
 = 0;

2126 
u32
 
nÜm
;

2127 
dvm_ch_t
 *
ch
;

2128 
ch_driv”_t
 *
driv”
;

2129 
tw_video_bus_t
 *
video_bus
;

2130 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

2131 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2132 
u32
 
‹mp
, 
width_·¹a
, 
width_·¹b
, 
height_·¹a
, 
height_·¹b
;

2134 if((
bus_id
 < 0è|| (bus_id >ğ
TW_MAX_GRP
))

2136 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rgument\n");

2137  -
EINVAL
;

2140 
ch
 = 
	`to_g‘_ch_w™h_ch_üoss_bus
(
vd_bus
);

2141 
driv”
 = 
ch
->
ch_driv”
;

2142 
video_bus
 = &
driv”
->video_bus;

2143 
nÜm
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

2144 
mode
)

2147 
MODE_D1
:

2148 
MODE_HALFD1
:

2149 
‹mp
 = 0x3c;

2150 
width_·¹a
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_D1
, 
nÜm
) - 1;

2151 
width_·¹b
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_D1
, 
nÜm
) - 1;

2152 
height_·¹a
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_D1
, 
nÜm
) - 1;

2153 
height_·¹b
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_HALF_D1
, 
nÜm
) - 1;

2155 
MODE_HALFD1_CIF
:

2156 
MODE_D1_CIF
:

2157 
‹mp
 = 0x2e;

2158 
width_·¹a
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_D1
, 
nÜm
) - 1;

2159 
width_·¹b
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2160 
height_·¹a
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_D1
, 
nÜm
) - 1;

2161 
height_·¹b
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2163 
MODE_CIF
:

2164 
‹mp
 = 0x27;

2165 
width_·¹a
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2166 
width_·¹b
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2167 
height_·¹a
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2168 
height_·¹b
ğ
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
TW_VIDEO_SIZE_CIF
, 
nÜm
) - 1;

2171 if(
bus_id
 < 2){

2172 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_BUS01_MODE
);

2173 if(
bus_id
%2){

2174 
v®
 &= 0xff;

2175 
v®
 |ğ
‹mp
<<8;

2178 
v®
 &= 0xfff00;

2179 
v®
 |ğ
‹mp
;

2181 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_BUS01_MODE
, 
v®
);

2184 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_BUS23_MODE
);

2185 if(
bus_id
%2){

2186 
v®
 &= 0xff;

2187 
v®
 |ğ
‹mp
<<8;

2190 
v®
 &= 0xfff00;

2191 
v®
 |ğ
‹mp
;

2193 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_BUS23_MODE
, 
v®
);

2196 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`SENIF_WIDTH_PARTA
(
bus_id
), 
width_·¹a
);

2197 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`SENIF_WIDTH_PARTB
(
bus_id
), 
width_·¹b
);

2198 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`SENIF_HEIGHT_PARTA
(
bus_id
), 
height_·¹a
);

2199 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`SENIF_HEIGHT_PARTB
(
bus_id
), 
height_·¹b
);

2200 
‹mp
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_HOR_MIR
);

2201 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_VER_MIR
);

2202 
fuÎ_size
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_FULL_FLAGS
);

2203 
·¹ab_£Ëù
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
SENIF_PARTAB_SELECT
);

2204 
phy_video_¦Ù
 = 
vd_bus
->phy_video_slot;

2205 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
phy_video_¦Ù
++) {

2206 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

2207 if(
logic_video_¦Ù
->
hÜ_»v”£
) {

2208 
‹mp
 |ğ(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2210 
‹mp
 &ğ~(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2212 if(
logic_video_¦Ù
->
v”_»v”£
) {

2213 
v®
 |ğ(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2215 
v®
 &ğ~(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2217 if((
logic_video_¦Ù
->
video_size
 =ğ
TW_VIDEO_SIZE_D1
è|| (logic_video_¦Ù->video_siz=ğ
TW_VIDEO_SIZE_CIF
)) {

2218 
fuÎ_size
 |ğ(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2219 
·¹ab_£Ëù
 &ğ~(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2221 
fuÎ_size
 &ğ~(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2222 
·¹ab_£Ëù
 |ğ(1 << 
logic_video_¦Ù
->
logicSlÙId
);

2225 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_HOR_MIR
, 
‹mp
);

2226 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_VER_MIR
, 
v®
);

2227 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_FULL_FLAGS
, 
fuÎ_size
);

2228 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
SENIF_PARTAB_SELECT
, 
·¹ab_£Ëù
);

2230 
	`TW_DBG
(
TW_DBG_INFO
, "£nif: bus%d mod%d, (0x%x, 0x%x, 0x%x, 0x%x),…¬b 0x%08x, fuÎ 0x%08x\n", 
bus_id
, 
mode
,

2231 
width_·¹a
, 
width_·¹b
, 
height_·¹a
, 
height_·¹b
, 
·¹ab_£Ëù
, 
fuÎ_size
);

2234 
	}
}

2236 
	$š™_tw5864_h264_logic_video_¦Ù
(
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
, 
logic_id
, 
TW_VIDEO_SIZE
 
video_size
)

2238 
logic_video_¦Ù
->
İ
 = &
tw_h264_logic_video_¦Ù_İ
;

2239 
logic_video_¦Ù
->
İ
->
	`š™
Öogic_video_¦Ù, 
logic_id
, 
video_size
);

2240 
	}
}

2242 
	$tw5864_vd_üoss_bus_š™
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
TW_CROSS_BUS_WORK_MODE
 
mode
, 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
)

2245 
phy_bus_id
[
TW5864_PHY_VD_CHAN_NUMBER
];

2247 
	`mem£t
(
phy_bus_id
, 0, (è* 
TW5864_PHY_VD_CHAN_NUMBER
);

2249 if(
vd_üoss_bus
 !ğ
NULL
){

2250 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

2251 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2252 
vd_chª_m­_šfo_t
 
chª_m­_bË
[
TW5864_PHY_VD_CHAN_NUMBER
], *
chª_m­
;

2253 
dvm_ch_t
 *
ch
 = 
NULL
;

2254 
TW_VIDEO_SIZE
 
video_size
;

2255 
u32
 
loÿl_ås
 = 0;

2256 
i
;

2258 
ch
 = 
	`to_g‘_ch_w™h_ch_üoss_bus
(
vd_üoss_bus
);

2259 
vd_üoss_bus
->
İ
->
	`upd©e_wÜk_mode
(vd_üoss_bus, 
mode
);

2260 
chª_m­
 = 
chª_m­_bË
;

2261 if(
video_¡ªd¬d
 =ğ
TW_VIDEO_STANDARD_PAL
) {

2262 
loÿl_ås
 = 25;

2264 
loÿl_ås
 = 30;

2266 
vd_üoss_bus
->
İ
->
	`g‘_wÜk_mode
(vd_cross_bus)){

2267 
TW_CROSS_BUS_4D1_REALTIME
:

2268 
video_size
 = 
TW_VIDEO_SIZE_D1
;

2269 
i
=0; i<4; i++, 
chª_m­
++){

2270 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2271 
chª_m­
->
ås
 = 
loÿl_ås
;

2272 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_D1
;

2275 ;
i
<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2276 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

2279 
TW_CROSS_BUS_8H®fD1_REALTIME
:

2280 
video_size
 = 
TW_VIDEO_SIZE_HALF_D1
;

2281 
i
=0; i<8; i++, 
chª_m­
++){

2282 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2283 
chª_m­
->
ås
 = 
loÿl_ås
;

2284 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_HALF_D1
;

2286 ; 
i
 < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2287 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

2290 
TW_CROSS_BUS_16CIF_REALTIME
:

2291 
video_size
 = 
TW_VIDEO_SIZE_CIF
;

2292 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2293 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2294 
chª_m­
->
ås
 = 
loÿl_ås
;

2295 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_CIF
;

2299 
TW_CROSS_BUS_UNREALTIME
:

2300 
video_size
 = 
TW_VIDEO_SIZE_D1
;

2301 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2302 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2303 
chª_m­
->
ås
 = 
deçuÉ_nÚ»®_time_ås_bË
[
i
];

2304 
chª_m­
->
video_size
 = 
deçuÉ_nÚ»®_time_fmt_bË
[
i
];

2309 
phy_video_¦Ù
 = 
vd_üoss_bus
->phy_video_slot;

2310 
logic_video_¦Ù
 = 
vd_üoss_bus
->logic_video_slot;

2311 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++){

2312 
	`š™_tw5864_h264_phy_video_¦Ù
(
phy_video_¦Ù
++, 
i
, 
video_size
);

2313 
	`š™_tw5864_h264_logic_video_¦Ù
(
logic_video_¦Ù
++, 
i
, 
video_size
);

2316 if(
vd_üoss_bus
->
İ
->
	`ÿlcuÏ‹_üoss_bus_m­_bË
(vd_üoss_bus, 
chª_m­_bË
)){

2317 
	`TW_DBG
(
TW_DBG_ERR
, "calculate mapable failed,…lease check…arameter!\n");

2318  -
EINVAL
;

2320 
chª_m­
 = 
chª_m­_bË
;

2321 
i
 = 0; i < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; i++, 
chª_m­
++) {

2322 if(
chª_m­
->
m­_logic_¦Ù_id
 >ğ
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
) {

2323 
	`TW_DBG
(
TW_DBG_ERR
, "logiøchªÃÈnumb” %d ov”æow\n", 
chª_m­
->
m­_logic_¦Ù_id
);

2324  -
TW_ERR
;

2326 
logic_video_¦Ù
 = &
vd_üoss_bus
->logic_video_¦Ù[
chª_m­
->
m­_logic_¦Ù_id
];

2327 
logic_video_¦Ù
->
İ
->
	`£t_m­PhySlÙId
Öogic_video_¦Ù, 
chª_m­
->
phy_¦Ù_id
);

2328 
logic_video_¦Ù
->
İ
->
	`£t_disÿrdTabË
Öogic_video_¦Ù, 
chª_m­
->
logic_¦Ù_disÿrd_bË
);

2329 
logic_video_¦Ù
->
İ
->
	`£t_roundTabËSŒide
Öogic_video_¦Ù, 
chª_m­
->
roundTabËSŒide
);

2330 
logic_video_¦Ù
->
İ
->
	`£t_video_size
Öogic_video_¦Ù, 
chª_m­
->
video_size
);

2331 
logic_video_¦Ù
->
İ
->
	`£t_’abË¦Ù
Öogic_video_¦Ù, 
chª_m­
->
’abË
);

2332 
logic_video_¦Ù
->
İ
->
	`£t_ås
Öogic_video_¦Ù, 
chª_m­
->
ås
);

2333 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 1);

2334 
vd_üoss_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_üoss_bus, 
chª_m­
->
phy_¦Ù_id
, &
phy_video_¦Ù
);

2335 
phy_video_¦Ù
->
İ
->
	`upd©e_m­_logic_¦Ù
Õhy_video_¦Ù, 
logic_video_¦Ù
->
logicSlÙId
,†ogic_video_slot);

2338  
TW_OK
;

2341 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

2343  
TW_ERR
;

2344 
	}
}

2346 
	$tw5864_vd_üoss_bus_g‘_logic_video_¦Ù_by_logic_id
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
logic_¦Ù_id
, 
tw_h264_logic_video_¦Ù_t
 **
±r_logic_video_¦Ù
)

2348 if((
±r_logic_video_¦Ù
!=
NULL
è&& (
logic_¦Ù_id
<
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
)){

2349 *
±r_logic_video_¦Ù
 = &
vd_üoss_bus
->
logic_video_¦Ù
[
logic_¦Ù_id
];

2351 
	}
}

2353 
	$tw5864_vd_üoss_bus_g‘_logic_video_¦Ù_by_phy_id
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
phy_¦Ù_id
, 
tw_h264_logic_video_¦Ù_t
 **
±r_logic_video_¦Ù
)

2355 if(
vd_üoss_bus
) {

2356 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2357 if((
phy_¦Ù_id
 < 0è|| (phy_¦Ù_id >ğ
TW5864_PHY_VD_CHAN_NUMBER
)) {

2358 *
±r_logic_video_¦Ù
 = 
NULL
;

2361 
phy_video_¦Ù
 = &
vd_üoss_bus
->phy_video_¦Ù[
phy_¦Ù_id
];

2362 *
±r_logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

2364 
	}
}

2366 
	$tw5864_vd_üoss_bus_g‘_phy_video_¦Ù_by_logic_id
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
logic_¦Ù_id
, 
tw_h264_phy_video_¦Ù_t
 **
±r_phy_video_¦Ù
)

2368 if((
±r_phy_video_¦Ù
!=
NULL
è&& (
logic_¦Ù_id
<
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
)){

2369 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2370 
i
;

2372 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++){

2373 
phy_video_¦Ù
 = &
vd_üoss_bus
->phy_video_¦Ù[
i
];

2374 if(
phy_video_¦Ù
->
m­_logic_id
 !ğ
TW5864_LOGIC_VD_INVALID
){

2375 if(
phy_video_¦Ù
->
m­_logic_id
 =ğ
logic_¦Ù_id
){

2376 *
±r_phy_video_¦Ù
 = 
phy_video_¦Ù
;

2382 
	}
}

2384 
	$tw5864_vd_üoss_bus_g‘_phy_video_¦Ù_by_phy_id
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
phy_¦Ù_id
, 
tw_h264_phy_video_¦Ù_t
 **
±r_phy_video_¦Ù
)

2386 if((
±r_phy_video_¦Ù
!=
NULL
è&& (
phy_¦Ù_id
<
TW5864_PHY_VD_CHAN_NUMBER
)){

2387 *
±r_phy_video_¦Ù
 = &
vd_üoss_bus
->
phy_video_¦Ù
[
phy_¦Ù_id
];

2389 
	}
}

2392 
	$tw5864_vd_üoss_bus_g‘_wÜk_mode
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
)

2394  
vd_üoss_bus
->
mode
;

2395 
	}
}

2397 
	$tw5864_vd_üoss_bus_upd©e_wÜk_mode
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
TW_CROSS_BUS_WORK_MODE
 
mode
)

2399 if(!
vd_üoss_bus
) {

2400 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

2401  -
EINVAL
;

2404 if((
mode
 < 
TW_CROSS_BUS_4D1_REALTIME
è|| (mod> 
TW_CROSS_BUS_UNREALTIME
)){

2405 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆwÜk mod%d\n", 
mode
);

2406  -
EINVAL
;

2409 
	`TW_DBG
(
TW_DBG_INFO
, "upd©vd bu wÜk mod%d\n", 
mode
);

2410 
vd_üoss_bus
->
mode
 = mode;

2412  
TW_OK
;

2413 
	}
}

2415 
	$tw5864_vd_üoss_bus_ÿlcuÏ‹_üoss_bus_m­_bË
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
vd_chª_m­_šfo_t
 *
chª_m­_šfo
)

2418 
VGROUP_S
 
vgroup
[
TW_MAX_GRP
];

2419 
chn_no
[
TW_MAX_VI
];

2420 
chn_út
 = 0;

2421 
fÜm©
[
TW_MAX_VI
];

2422 
ä©e
[
TW_MAX_VI
];

2423 
nÜm
, 
Ï¡_video_size
;

2424 
i
 = 0, 
j
 = 0, 
cÚsi¡’cy
 = 
TW_TRUE
;

2425 
vd_chª_m­_šfo_t
 *
m­_šfo
;

2426 
dvm_ch_t
 *
ch
;

2427 
ch_driv”_t
 *
driv”
;

2428 
tw_video_bus_t
 *
video_bus
;

2430 if(!
vd_üoss_bus
)

2432 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

2433  
TW_ERR
;

2436 
m­_šfo
 = 
chª_m­_šfo
;

2437 
	`mem£t
(
vgroup
, 0x0, (
VGROUP_S
è* 
TW_MAX_GRP
);

2438 
	`mem£t
(
chn_no
, 0x0, ()*
TW_MAX_VI
);

2439 
	`mem£t
(
fÜm©
, 0x0, ()*
TW_MAX_VI
);

2440 
	`mem£t
(
ä©e
, 0x0, ()*
TW_MAX_VI
);

2442 
i
 = 0; i < 
TW_MAX_GRP
; i++)

2444 
vgroup
[
i
].
g½_id
 = i;

2446 
ch
 = 
	`to_g‘_ch_w™h_ch_üoss_bus
(
vd_üoss_bus
);

2447 
driv”
 = 
ch
->
ch_driv”
;

2448 
video_bus
 = &
driv”
->video_bus;

2449 
nÜm
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

2450 
chn_út
 = 0;

2451 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
m­_šfo
++)

2453 if((
m­_šfo
->
phy_¦Ù_id
 !ğ
TW5864_LOGIC_VD_INVALID
è&& (m­_šfo->
’abË
 !ğ0è&& (m­_šfo->
ås
 != 0)) {

2454 
chn_no
[
chn_út
] = 
m­_šfo
->
phy_¦Ù_id
;

2455 
m­_šfo
->
video_size
) {

2456 
TW_VIDEO_SIZE_D1
:

2457 
TW_VIDEO_SIZE_HALF_D1
:

2458 
TW_VIDEO_SIZE_CIF
:

2461 
TW_VIDEO_SIZE_QCIF
:

2462 
TW_VIDEO_SIZE_USER
:

2463 
m­_šfo
->
video_size
 = 
TW_VIDEO_SIZE_CIF
;

2466 
fÜm©
[
chn_út
] = 
m­_šfo
->
video_size
;

2467 
ä©e
[
chn_út
] = 
m­_šfo
->
ås
;

2468 
chn_út
++;

2472 if(
	`cb_ù¾_ÿlcuÏ‹
(
chn_no
, 
fÜm©
, 
ä©e
, 
nÜm
, 
vgroup
, 
chn_út
, 1))

2474 
	`TW_DBG
(
TW_DBG_ERR
, "Unableo calculate mapable!\n");

2476  -
EINVAL
;

2479 
	`TW_DBG
(
TW_DBG_INFO
, "%8s %8s %8s %8s %8s %8s %8s\n", "phy", "logic",

2481 
m­_šfo
 = 
chª_m­_šfo
;

2482 
i
 = 0; i < 
TW_MAX_GRP
; i++)

2484 
j
 = 0; j < 
TW_CHN_NO
; j++)

2486 
m­_šfo
->
phy_¦Ù_id
 = 
vgroup
[
i
].
š_£Ëù
[
j
];

2487 
m­_šfo
->
m­_logic_¦Ù_id
 = 
i
 * 
TW_CHN_NO
 + 
j
;

2488 
m­_šfo
->
video_size
 = 
vgroup
[
i
].
š_fmt
[
j
];

2489 
m­_šfo
->
ås
 = 
vgroup
[
i
].
out_¿‹
[
j
];

2490 
m­_šfo
->
logic_¦Ù_disÿrd_bË
 = 
vgroup
[
i
].
š_m­
[
j
];

2491 
m­_šfo
->
roundTabËSŒide
 = (
nÜm
 =ğ
TW_VIDEO_STANDARD_PAL
) ?0x18:0x1d;

2492 
m­_šfo
->
’abË
 = (m­_šfo->
ås
 == 0)?0:1;

2493 if(
m­_šfo
->
’abË
) {

2494 if(
cÚsi¡’cy
 =ğ
TW_TRUE
 ) {

2495 if((
i
 =ğ0è&& (
j
 == 0)) {

2496 
Ï¡_video_size
 = 
m­_šfo
->
video_size
;

2498 if(
m­_šfo
->
video_size
 !ğ
Ï¡_video_size
) {

2499 
cÚsi¡’cy
 = 
TW_FALSE
;

2503 
	`TW_DBG
(
TW_DBG_INFO
, "%8d %8d %8d %8d %8d %8d 0x%08x\n", 
m­_šfo
->
phy_¦Ù_id
,

2504 
m­_šfo
->
m­_logic_¦Ù_id
, m­_šfo->
video_size
, m­_šfo->
ås
,

2505 
m­_šfo
->
roundTabËSŒide
, m­_šfo->
’abË
, m­_šfo->
logic_¦Ù_disÿrd_bË
);

2506 
m­_šfo
++;

2508 
vd_üoss_bus
->
bus_mode
[
vgroup
[
i
].
g½_id
] = vgroup[i].
mode
;

2511 if(
cÚsi¡’cy
 =ğ
TW_FALSE
) {

2512 
ch
->
video_’code_ÿp
->
ddr_m­_mode
 = 
DDR_MAP_COMPRESS_DISABLE
;

2513 
	`TW_DBG
(
TW_DBG_INFO
, "change video_encode_work_modeo DDR_MAP_COMPRESS_DISABLE\n");

2515 
ch
->
video_’code_ÿp
->
ddr_m­_mode
 = 
DDR_MAP_COMPRESS_ENABLE
;

2516 
	`TW_DBG
(
TW_DBG_INFO
, "change video_encode_work_modeo DDR_MAP_COMPRESS_ENABLE\n");

2519  
TW_OK
;

2520 
	}
}

2523 
	$tw5864_vd_üoss_bus_­¶y
(
tw5864_vd_üoss_bus_t
 *
bus
, 
dvm_ch_t
 *
ch
)

2525 
i
;

2526 
down§m¶e
 = 0;

2527 
v®id
 = 0;

2528 
fÜm©
 = 0;

2529 
v®
 = 0;

2530 
timeout
 = 0;

2531 
bus_£Ëù
[
TW_MAX_GRP
];

2532 
bus_m­
[
TW_MAX_GRP
];

2533 
ch_driv”_t
 *
driv”
;

2534 
tw_video_bus_t
 *
video_bus
;

2535 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

2536 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2538 if(!
bus
 || !
ch
) {

2539 
	`TW_DBG
(
TW_DBG_ERR
, "NULL…ointer\n");

2540  
TW_ERR
;

2542 
	`TW_DBG
(
TW_DBG_INFO
, "update vd configureo hardware\n");

2543 
driv”
 = 
ch
->
ch_driv”
;

2544 
video_bus
 = &
driv”
->video_bus;

2545 
	`mem£t
(
bus_£Ëù
, 0, (è* 
TW_MAX_GRP
);

2547 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_SWITCH
, 0x0000);

2548 
timeout
 = 100;

2549 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
VD_CHANNEL_SWITCH
è&& (--
timeout
)) {

2550 
	`md–ay
(1);

2552 
	`mem£t
(
bus_m­
, 0, (bus_map));

2553 
i
 = 0; i < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; i++){

2554 
phy_video_¦Ù
 = &
bus
->phy_video_¦Ù[
i
];

2555 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

2556 if(
logic_video_¦Ù
->
logicSlÙId
 >ğ
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
) {

2557 
	`TW_DBG
(
TW_DBG_ERR
, "logic slotƒrror\n");

2558  
TW_ERR
;

2561 if(
logic_video_¦Ù
->
video_size
 !ğ
TW_VIDEO_SIZE_D1
){

2563 
down§m¶e
 |ğ1 << 
phy_video_¦Ù
->
phy_¦Ù_id
;

2566 
logic_video_¦Ù
->
video_size
)

2569 
TW_VIDEO_SIZE_HALF_D1
:

2570 
TW_VIDEO_SIZE_D1
:

2571 
v®
 = 0x00;

2573 
TW_VIDEO_SIZE_CIF
:

2574 
v®
 = 0x03;

2576 
TW_VIDEO_SIZE_QCIF
:

2577 
v®
 = 0x01;

2580 
fÜm©
 |ğ
v®
 << (
phy_video_¦Ù
->
phy_¦Ù_id
 * 2);

2581 if(
logic_video_¦Ù
->
’abËSlÙ
){

2582 
v®id
 |ğ1<<
logic_video_¦Ù
->
m­PhySlÙId
;

2586 
bus_£Ëù
[(
logic_video_¦Ù
->
logicSlÙId
 / 4)] |ğÖogic_video_¦Ù->
m­PhySlÙId
 << 16);

2587 
bus_£Ëù
[(
logic_video_¦Ù
->
logicSlÙId
 / 4)] >>= 4;

2589 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`VD_CHANNEL_LMAP
(((
logic_video_¦Ù
->
logicSlÙId
 / 4è* 4è+ 
bus_m­
[logic_video_¦Ù->logicSlÙId / 4]),logic_video_¦Ù->
disÿrdTabË
);

2590 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`VD_CHANNEL_HMAP
(((
logic_video_¦Ù
->
logicSlÙId
 / 4è* 4è+ 
bus_m­
[logic_video_¦Ù->logicSlÙId / 4]),†ogic_video_¦Ù->
disÿrdTabË
>>16);

2591 
bus_m­
[
logic_video_¦Ù
->
logicSlÙId
 / 4]++;

2594 
i
 = 0; i < 
TW_MAX_GRP
; i++){

2595 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
	`VD_BUS_MAP
(
i
), 
bus_£Ëù
[i]);

2596 
	`cÚfig_£nif_bus
(
bus
, 
i
, bus->
bus_mode
[i]);

2599 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_DOWNSAMPLE
, 
down§m¶e
);

2601 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_FORMAT0
, 
fÜm©
 & 0xffff);

2602 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_FORMAT1
, (
fÜm©
 >> 16) & 0xffff);

2605 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
){

2606 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_BUS_MAX_LINE0
, 0x318);

2607 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_BUS_MAX_LINE1
, 0x318);

2610 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_BUS_MAX_LINE0
, 0x3bd);

2611 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_BUS_MAX_LINE1
, 0x3bd);

2615 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_BUS_MAX_CHANNEL
, 0x0000);

2616 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_INTERLACE
, 0x0000);

2619 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VD_CHANNEL_SWITCH
, 
v®id
);

2621  
TW_OK
;

2622 
	}
}

2624 
	$tw5864_vd_üoss_bus_»£t
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
)

2626 if(
vd_üoss_bus
) {

2627 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

2628 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2629 
vd_chª_m­_šfo_t
 
chª_m­_bË
[
TW5864_PHY_VD_CHAN_NUMBER
], *
chª_m­
;

2630 
dvm_ch_t
 *
ch
 = 
NULL
;

2631 
tw_video_bus_t
 *
video_bus
;

2632 
u32
 
loÿl_ås
 = 0;

2633 
i
,
»t
;

2635 
	`TW_DBG
(
TW_DBG_INFO
, "vd_bu »£ˆtØmod%d\n", 
vd_üoss_bus
->
İ
->
	`g‘_wÜk_mode
(vd_cross_bus));

2636 
ch
 = 
	`to_g‘_ch_w™h_ch_üoss_bus
(
vd_üoss_bus
);

2637 
video_bus
 = &
ch
->
ch_driv”
->video_bus;

2638 
chª_m­
 = 
chª_m­_bË
;

2639 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

2640 
loÿl_ås
 = 25;

2642 
loÿl_ås
 = 30;

2644 
vd_üoss_bus
->
İ
->
	`g‘_wÜk_mode
(vd_cross_bus)){

2645 
TW_CROSS_BUS_4D1_REALTIME
:

2646 
i
=0; i<4; i++, 
chª_m­
++){

2647 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2648 
chª_m­
->
ås
 = 
loÿl_ås
;

2649 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_D1
;

2650 
chª_m­
->
’abË
 = 1;

2653 ;
i
<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2654 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

2657 
TW_CROSS_BUS_8H®fD1_REALTIME
:

2658 
i
=0; i<8; i++, 
chª_m­
++){

2659 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2660 
chª_m­
->
ås
 = 
loÿl_ås
;

2661 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_HALF_D1
;

2662 
chª_m­
->
’abË
 = 1;

2664 ; 
i
 < 
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2665 
chª_m­
->
phy_¦Ù_id
 = 
TW5864_LOGIC_VD_INVALID
;

2668 
TW_CROSS_BUS_16CIF_REALTIME
:

2669 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2670 
chª_m­
->
phy_¦Ù_id
 = 
i
;

2671 
chª_m­
->
ås
 = 
loÿl_ås
;

2672 
chª_m­
->
video_size
 = 
TW_VIDEO_SIZE_CIF
;

2673 
chª_m­
->
’abË
 = 1;

2677 
TW_CROSS_BUS_UNREALTIME
:

2678 
i
=0; i<
TW5864_PHY_VD_CHAN_NUMBER
; i++, 
chª_m­
++){

2679 
logic_video_¦Ù
 = &
vd_üoss_bus
->logic_video_¦Ù[
i
];

2680 
chª_m­
->
phy_¦Ù_id
 = 
logic_video_¦Ù
->
İ
->
	`g‘_m­PhySlÙId
Öogic_video_¦Ù, 
i
);

2681 
chª_m­
->
ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

2682 
chª_m­
->
’abË
 = 
logic_video_¦Ù
->
İ
->
	`g‘_’abË¦Ù
(logic_video_slot);

2683 
chª_m­
->
video_size
 = 
logic_video_¦Ù
->
İ
->
	`g‘_video_size
(logic_video_slot);

2686 if(
vd_üoss_bus
->
İ
->
	`ÿlcuÏ‹_üoss_bus_m­_bË
(vd_üoss_bus, 
chª_m­_bË
)){

2687 
	`TW_DBG
(
TW_DBG_ERR
, "calculate mapable failed,…lease check…arameter!\n");

2688  -
EINVAL
;

2690 
chª_m­
 = 
chª_m­_bË
;

2691 
video_bus
->
İ
->
	`nÙify_su¥’d_logic_chª
(video_bus);

2692 
i
 = 0; i < 
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
; i++, 
chª_m­
++) {

2693 if(
chª_m­
->
m­_logic_¦Ù_id
 >ğ
TW5864_CROSS_BUS_LOGIC_VD_CHAN_NUMBER
) {

2694 
	`TW_DBG
(
TW_DBG_ERR
, "logiøchªÃÈnumb” %d ov”æow\n", 
chª_m­
->
m­_logic_¦Ù_id
);

2695  -
EINVAL
;

2697 
logic_video_¦Ù
 = &
vd_üoss_bus
->logic_video_¦Ù[
chª_m­
->
m­_logic_¦Ù_id
];

2698 
logic_video_¦Ù
->
İ
->
	`£t_m­PhySlÙId
Öogic_video_¦Ù, 
chª_m­
->
phy_¦Ù_id
);

2699 
logic_video_¦Ù
->
İ
->
	`£t_disÿrdTabË
Öogic_video_¦Ù, 
chª_m­
->
logic_¦Ù_disÿrd_bË
);

2700 
logic_video_¦Ù
->
İ
->
	`£t_roundTabËSŒide
Öogic_video_¦Ù, 
chª_m­
->
roundTabËSŒide
);

2701 
logic_video_¦Ù
->
İ
->
	`£t_video_size
Öogic_video_¦Ù, 
chª_m­
->
video_size
);

2702 
logic_video_¦Ù
->
İ
->
	`£t_’abË¦Ù
Öogic_video_¦Ù, 
chª_m­
->
’abË
);

2703 
logic_video_¦Ù
->
İ
->
	`£t_ås
Öogic_video_¦Ù, 
chª_m­
->
ås
);

2704 
	`©omic_£t
(&
logic_video_¦Ù
->
ÃedUpd©eFÏg
, 1);

2705 
vd_üoss_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_üoss_bus, 
chª_m­
->
phy_¦Ù_id
, &
phy_video_¦Ù
);

2706 
phy_video_¦Ù
->
İ
->
	`£t_video_size
Õhy_video_¦Ù, 
logic_video_¦Ù
->İ->
	`g‘_video_size
(logic_video_slot));

2707 
phy_video_¦Ù
->
İ
->
	`upd©e_m­_logic_¦Ù
Õhy_video_¦Ù, 
logic_video_¦Ù
->
logicSlÙId
,†ogic_video_slot);

2709 
vd_üoss_bus
->
İ
->
	`£t_ch_’d_üoss_bus
(vd_üoss_bus, 
ch
);

2710 
video_bus
->
İ
->
	`nÙify_»sume_logic_chª
(video_bus);

2712 
»t
 = 
video_bus
->
İ
->
	`nÙify_logic_chª_chªge
(video_bus);

2714  
»t
;

2717  
TW_ERR
;

2718 
	}
}

2720 
tw5864_vd_üoss_bus_İ”©iÚ
 
	gtw5864_vd_üoss_bus_İ
 = {

2721 .
š™
 = 
tw5864_vd_üoss_bus_š™
,

2722 .
	g»£t
 = 
tw5864_vd_üoss_bus_»£t
,

2723 .
	gg‘_logic_video_¦Ù_by_logic_id
 = 
tw5864_vd_üoss_bus_g‘_logic_video_¦Ù_by_logic_id
,

2724 .
	gg‘_logic_video_¦Ù_by_phy_id
 = 
tw5864_vd_üoss_bus_g‘_logic_video_¦Ù_by_phy_id
,

2725 .
	gg‘_phy_video_¦Ù_by_logic_id
 = 
tw5864_vd_üoss_bus_g‘_phy_video_¦Ù_by_logic_id
,

2726 .
	gg‘_phy_video_¦Ù_by_phy_id
 = 
tw5864_vd_üoss_bus_g‘_phy_video_¦Ù_by_phy_id
,

2727 .
	gg‘_wÜk_mode
 = 
tw5864_vd_üoss_bus_g‘_wÜk_mode
,

2728 .
	gupd©e_wÜk_mode
 = 
tw5864_vd_üoss_bus_upd©e_wÜk_mode
,

2730 .
	gÿlcuÏ‹_üoss_bus_m­_bË
 = 
tw5864_vd_üoss_bus_ÿlcuÏ‹_üoss_bus_m­_bË
,

2731 .
	g£t_ch_’d_üoss_bus
 = 
tw5864_vd_üoss_bus_­¶y
,

2735 
	$š™_tw5864_vd_üoss_bus
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
, 
TW_CROSS_BUS_WORK_MODE
 
mode
, 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
)

2737 if(
vd_üoss_bus
 !ğ
NULL
){

2738 
vd_üoss_bus
->
İ
 = &
tw5864_vd_üoss_bus_İ
;

2739  
vd_üoss_bus
->
İ
->
	`š™
(vd_üoss_bus, 
mode
, 
video_¡ªd¬d
);

2742  
TW_ERR
;

2743 
	}
}

2745 
	$»move_tw5864_vd_üoss_bus
(
tw5864_vd_üoss_bus_t
 *
vd_üoss_bus
)

2748 
	}
}

2750 
	$tw5864_vd_¦Ù_Üig_buf_šfo_š™
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
phy_¦Ù_id
)

2752 
	`©omic_£t
(&
tw_vd_Üig_buf
->
¡İ_check_ad
, 0);

2753 
	`¥š_lock_š™
(&
tw_vd_Üig_buf
->
lock
);

2754 
tw_vd_Üig_buf
->
phy_¦Ù_id
 =…hy_slot_id;

2755 
tw_vd_Üig_buf
->
fœ¡_¡¬t_disÿrd_äame_numb”
 = 
FIRST_START_DISCARD_FRAME_NUMBER
;

2756 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 = 0;

2757 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 =0;

2758 
tw_vd_Üig_buf
->
vd_’code_±r
 = 0;

2760 
	`š™_tw5864_’code_time¡amp
(&
tw_vd_Üig_buf
->
vd_’code_time¡amp
);

2761 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

2762 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 = 0;

2763 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 = 0;

2764 
	}
}

2766 
	$tw5864_vd_¦Ù_Üig_buf_šfo_g‘_vd_ad_phy_±r
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
)

2768 
æags
;

2769 
mask
=0x3;

2770 
shiá_numb”
, 
»t
;

2771 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2772 if(
tw_vd_Üig_buf
->
phy_¦Ù_id
 < 8){

2773 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
AD_ORIG_RAM_BASE
);

2774 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
<<1);

2776 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
AD_CHAN_8_15_ORIG_BASE
);

2777 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
-8)<<1;

2779 
mask
 <<ğ
shiá_numb”
;

2780 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 &ğ
mask
;

2781 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 >>ğ
shiá_numb”
;

2782 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2783 
»t
 = 
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
;

2784  
»t
;

2785 
	}
}

2787 
	$tw5864_vd_¦Ù_Üig_buf_šfo_£t_vd_cu¼_’code_±r
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
)

2789 if((
ch
!=
NULL
è&& (
logic_’code_chª
!=NULL)){

2790 
æags
;

2791 
u32
 
d©a
;

2793 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2794 
d©a
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CHANNEL_ID
);

2795 
d©a
 = (d©¨& (~0xf)è| 
tw_vd_Üig_buf
->
phy_¦Ù_id
;

2796 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_ID
, 
d©a
);

2797 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DSP_CUR_RAM_BASE
, (
tw_vd_Üig_buf
->
vd_’code_±r
<<12));

2798 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2800 
	}
}

2802 
	$tw5864_vd_¦Ù_Üig_buf_šfo_upd©e_vd_’code_±r
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
)

2804 
æags
;

2805 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2806 
tw_vd_Üig_buf
->
vd_’code_±r
++;

2807 
tw_vd_Üig_buf
->
vd_’code_±r
 &= 3;

2808 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2809 
	}
}

2811 
	$tw5864_vd_¦Ù_Üig_buf_šfo_£t_vd_upd©e_Üig_buf_»g
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
)

2813 
mask
=0x3;

2814 
shiá_numb”
;

2815 
æags
;

2816 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2817 if(
tw_vd_Üig_buf
->
phy_¦Ù_id
 < 8){

2818 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_CHAN_CUR_PTR
);

2819 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
<<1);

2821 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_CHAN_8_15_CUR_PTR
);

2822 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
-8)<<1;

2824 
mask
 <<ğ
shiá_numb”
;

2825 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 &ğ~
mask
;

2826 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 |ğ((Ñw_vd_Üig_buf->
vd_’code_±r
+3)&3)<<
shiá_numb”
);

2827 if(
tw_vd_Üig_buf
->
phy_¦Ù_id
 < 8){

2828 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
TOTAL_CHAN_CUR_PTR
, 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
);

2830 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
TOTAL_CHAN_8_15_CUR_PTR
, 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
);

2832 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2833 
	}
}

2835 
	$tw5864_vd_¦Ù_Üig_buf_šfo_vd_Üig_buf_»ady
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
)

2837 
»t
 = 0;

2838 if((
ch
!=
NULL
è&& (
logic_’code_chª
!=NULL)){

2839 
æags
;

2840 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
 = &
logic_’code_chª
->encode_control;

2841 
’code_cÚŒŞ
->
ad_check
++;

2842 
tw_vd_Üig_buf
->
İ
->
	`g‘_vd_ad_phy_±r
Ñw_vd_Üig_buf, 
ch
);

2843 if(
	`©omic_»ad
(&
tw_vd_Üig_buf
->
¡İ_check_ad
) == 0){

2844 if(
tw_vd_Üig_buf
->
vd_’code_±r
 !ğtw_vd_Üig_buf->
vd_Üig_ad_phy_±r
){

2845 
d–
 = 0;

2846 
d–
 = (
tw_vd_Üig_buf
->
vd_Üig_ad_phy_±r
 + 4 -w_vd_Üig_buf->
vd_’code_±r
) & 3;

2847 if(
d–
 == 1) {

2848 
’code_cÚŒŞ
->
ad_d–1
++;

2849 }if(
d–
 == 2) {

2850 
’code_cÚŒŞ
->
ad_d–2
++;

2851 }if(
d–
 == 3) {

2852 
’code_cÚŒŞ
->
ad_d–3
++;

2854 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

2855 if(
tw_vd_Üig_buf
->
fœ¡_¡¬t_disÿrd_äame_numb”
 > 0){

2856 
tw_vd_Üig_buf
->
fœ¡_¡¬t_disÿrd_äame_numb”
--;

2857 
tw_vd_Üig_buf
->
İ
->
	`£t_vd_cu¼_’code_±r
Ñw_vd_Üig_buf, 
ch
, 
logic_’code_chª
);

2858 
tw_vd_Üig_buf
->
İ
->
	`upd©e_vd_’code_±r
(tw_vd_orig_buf);

2859 
tw_vd_Üig_buf
->
İ
->
	`£t_vd_upd©e_Üig_buf_»g
Ñw_vd_Üig_buf, 
ch
);

2860 
	`´štk
("\n%d-%d: %x, %x\n", 
__LINE__
, 
logic_’code_chª
->
logic_chª_id
, 
tw_vd_Üig_buf
->
vd_’code_±r
,w_vd_Üig_buf->
vd_Üig_ad_phy_±r
);

2862 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2863 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 = 
LOGIC_CHAN_NUMBER_MASK
;

2864 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 &ğ~(1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
));

2865 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 = 0;

2866 
tw_vd_Üig_buf
->
İ
->
	`upd©e_time¡amp
Ñw_vd_Üig_buf, 
ch
);

2867 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2868 
	`©omic_£t
(&
tw_vd_Üig_buf
->
¡İ_check_ad
, 1);

2869 
»t
 = 1;

2871 #ifdeà 
OSD_MODULE


2872 #ifdef 
TESTING_TIMESTAMP


2873 
logic_’code_chª
->
’code_osd_’gše
.
İ
->
	`ü—‹_»ùªgË
(&logic_’code_chª->’code_osd_’gše, &logic_’code_chª->’code_osd_’gše.
osd_ruÂšg_·¿m
, 
tw_vd_Üig_buf
->İ->
	`g‘_time¡amp
Ñw_vd_Üig_buf),w_vd_Üig_buf->
vd_’code_±r
, 
’code_cÚŒŞ
->
i_vd_»ã»nû_±r
,ƒncode_cÚŒŞ->
i_ås
,ƒncode_cÚŒŞ->
i_åm
);

2875 
logic_’code_chª
->
’code_osd_’gše
.
İ
->
	`ü—‹_»ùªgË
(&logic_’code_chª->’code_osd_’gše, &logic_’code_chª->’code_osd_’gše.
osd_ruÂšg_·¿m
);

2881 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
++;

2882 if(
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 >= 200){

2883 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

2889 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2890 if((
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 & (1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
)))){

2891 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 &ğ~(1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
));

2892 
»t
 = 1;

2894 #ifdeà 
OSD_MODULE


2895 #ifdef 
TESTING_TIMESTAMP


2896 
logic_’code_chª
->
’code_osd_’gše
.
İ
->
	`ü—‹_»ùªgË
(&logic_’code_chª->’code_osd_’gše, &logic_’code_chª->’code_osd_’gše.
osd_ruÂšg_·¿m
, 
tw_vd_Üig_buf
->İ->
	`g‘_time¡amp
Ñw_vd_Üig_buf),w_vd_Üig_buf->
vd_’code_±r
, 
’code_cÚŒŞ
->
i_vd_»ã»nû_±r
,ƒncode_cÚŒŞ->
i_ås
,ƒncode_cÚŒŞ->
i_åm
);

2898 
logic_’code_chª
->
’code_osd_’gše
.
İ
->
	`ü—‹_»ùªgË
(&logic_’code_chª->’code_osd_’gše, &logic_’code_chª->’code_osd_’gše.
osd_ruÂšg_·¿m
);

2903 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2906  
»t
;

2907 
	}
}

2909 
	$tw5864_vd_¦Ù_Üig_buf_šfo_fœ¡_sync_Üig_buf_šfo
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
)

2911 if((
ch
!=
NULL
)){

2912 
tw_vd_Üig_buf
->
fœ¡_¡¬t_disÿrd_äame_numb”
 = 
FIRST_START_DISCARD_FRAME_NUMBER
;

2913 
tw_vd_Üig_buf
->
vd_’code_time¡amp
.
İ
->
	`»£t
(&tw_vd_orig_buf->vd_encode_timestamp);

2914 
tw_vd_Üig_buf
->
vd_’code_±r
 =w_vd_Üig_buf->
İ
->
	`g‘_vd_ad_phy_±r
Ñw_vd_Üig_buf, 
ch
);

2915 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DSP_CUR_RAM_BASE
, (((
tw_vd_Üig_buf
->
vd_’code_±r
+3)&3)<<12));

2916 
tw_vd_Üig_buf
->
İ
->
	`£t_vd_upd©e_Üig_buf_»g
Ñw_vd_Üig_buf, 
ch
);

2918 
	}
}

2920 
	$tw5864_vd_¦Ù_Üig_buf_šfo_upd©e_time¡amp
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
)

2922 if((
ch
!=
NULL
)){

2923 
tw_time¡amp_t
 *
vd_’code_time¡amp
 = &
tw_vd_Üig_buf
->vd_encode_timestamp;

2924 
video_time¡amp_»g_off£t
;

2925 
video_time¡amp_»g_off£t
 = 
CHAN_VIDEO_TIMESTAMP_BASE
 + 0x10*
tw_vd_Üig_buf
->
phy_¦Ù_id
 + (tw_vd_Üig_buf->
vd_’code_±r
<<2);

2926 
vd_’code_time¡amp
->
İ
->
	`£t_time¡amp
(vd_’code_time¡amp, 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
video_time¡amp_»g_off£t
), 
__FILE__
);

2928 
	}
}

2930 
u32
 
	$tw5864_vd_¦Ù_Üig_buf_šfo_g‘_time¡amp
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
)

2932 
tw_time¡amp_t
 *
vd_’code_time¡amp
 = &
tw_vd_Üig_buf
->vd_encode_timestamp;

2933  
vd_’code_time¡amp
->
İ
->
	`g‘_time¡amp
(vd_encode_timestamp);

2934 
	}
}

2936 
	$tw5864_vd_¦Ù_Üig_buf_šfo_soáw¬e_disÿrd_äame
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
)

2938 if((
ch
!=
NULL
è&& (
logic_’code_chª
!=NULL)){

2939 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

2940 
mask
=0x3;

2941 
shiá_numb”
;

2942 
have_b“n_’coded_chª_numb”
, 
’code_ov”_m­_bË
;

2943 
æags
;

2944 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2945 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 |ğ(1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
));

2946 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 &ğ
LOGIC_CHAN_NUMBER_MASK
;

2947 
have_b“n_’coded_chª_numb”
 = 0;

2948 
’code_ov”_m­_bË
 = 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
;

2949 
’code_ov”_m­_bË
){

2950 if(
’code_ov”_m­_bË
&1){

2951 
have_b“n_’coded_chª_numb”
++;

2953 
’code_ov”_m­_bË
 >>= 1;

2955 
ma¡”_¦Ù
 = 
logic_’code_chª
->master_slot;

2956 if(
have_b“n_’coded_chª_numb”
 =ğ
ma¡”_¦Ù
->
İ’ed_logic_chª_bË
.
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(&master_slot->opened_logic_chan_table)){

2960 if(
tw_vd_Üig_buf
->
phy_¦Ù_id
 < 8){

2961 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_CHAN_CUR_PTR
);

2962 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
<<1);

2964 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
TOTAL_CHAN_8_15_CUR_PTR
);

2965 
shiá_numb”
 = (
tw_vd_Üig_buf
->
phy_¦Ù_id
-8)<<1;

2967 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DSP_CUR_RAM_BASE
, (((
tw_vd_Üig_buf
->
vd_’code_±r
+3)&3)<<12));

2968 
mask
 <<ğ
shiá_numb”
;

2969 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 &ğ~
mask
;

2970 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
 |ğ((Ñw_vd_Üig_buf->
vd_’code_±r
+3)&3)<<
shiá_numb”
);

2971 if(
tw_vd_Üig_buf
->
phy_¦Ù_id
 < 8){

2972 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
TOTAL_CHAN_CUR_PTR
, 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
);

2974 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
TOTAL_CHAN_8_15_CUR_PTR
, 
tw_vd_Üig_buf
->
vd_upd©e_Üig_ad_phy_±r
);

2976 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

2977 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 = 0;

2978 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 = 0;

2979 
	`©omic_£t
(&
tw_vd_Üig_buf
->
¡İ_check_ad
, 0);

2984 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2986 
	}
}

2988 
	$tw5864_vd_¦Ù_Üig_buf_šfo_’code_’dof¦iû_nÙify
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
)

2990 if((
logic_’code_chª
!=
NULL
)){

2991 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

2992 
have_b“n_’coded_chª_numb”
, 
’code_ov”_m­_bË
, 
’Œy_numb”_š_»gi¡”_bË
;

2993 
æags
;

2994 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

2995 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 |ğ(1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
));

2996 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 &ğ
LOGIC_CHAN_NUMBER_MASK
;

2997 
have_b“n_’coded_chª_numb”
 = 0;

2998 
’code_ov”_m­_bË
 = 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
;

2999 
’code_ov”_m­_bË
){

3000 if(
’code_ov”_m­_bË
&1){

3001 
have_b“n_’coded_chª_numb”
++;

3003 
’code_ov”_m­_bË
 >>= 1;

3005 
ma¡”_¦Ù
 = 
logic_’code_chª
->master_slot;

3006 
’Œy_numb”_š_»gi¡”_bË
 = 
ma¡”_¦Ù
->
İ’ed_logic_chª_bË
.
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(&master_slot->opened_logic_chan_table);

3007 if(
have_b“n_’coded_chª_numb”
 =ğ
’Œy_numb”_š_»gi¡”_bË
){

3008 
tw_vd_Üig_buf
->
vd_’code_±r
++;

3009 
tw_vd_Üig_buf
->
vd_’code_±r
 &= 3;

3011 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

3012 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 = 0;

3013 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 = 0;

3014 
	`©omic_£t
(&
tw_vd_Üig_buf
->
¡İ_check_ad
, 0);

3016 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

3018 
	}
}

3020 
	$tw5864_vd_¦Ù_Üig_buf_šfo_’code_uÄegi¡”_nÙify
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
tw_h264_logic_’code_chª_t
 *
logic_’code_chª
)

3022 if((
logic_’code_chª
!=
NULL
)){

3023 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

3024 
have_b“n_’coded_chª_numb”
, 
’code_ov”_m­_bË
, 
’Œy_numb”_š_»gi¡”_bË
;

3025 
æags
;

3026 
	`¥š_lock_œq§ve
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

3027 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 &ğ~(1<<(
logic_’code_chª
->
logic_chª_id
&
VIDEO_LOGIC_MASTER_OR_SUB_MASK
));

3028 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 &ğ
LOGIC_CHAN_NUMBER_MASK
;

3029 
have_b“n_’coded_chª_numb”
 = 0;

3030 
’code_ov”_m­_bË
 = 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
;

3031 
’code_ov”_m­_bË
){

3032 if(
’code_ov”_m­_bË
&1){

3033 
have_b“n_’coded_chª_numb”
++;

3035 
’code_ov”_m­_bË
 >>= 1;

3037 
ma¡”_¦Ù
 = 
logic_’code_chª
->master_slot;

3038 
’Œy_numb”_š_»gi¡”_bË
 = 
ma¡”_¦Ù
->
İ’ed_logic_chª_bË
.
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(&master_slot->opened_logic_chan_table);

3039 if(
have_b“n_’coded_chª_numb”
 =ğ
’Œy_numb”_š_»gi¡”_bË
){

3040 
tw_vd_Üig_buf
->
vd_’code_±r
++;

3041 
tw_vd_Üig_buf
->
vd_’code_±r
 &= 3;

3043 
tw_vd_Üig_buf
->
vd_±r_check_couÁ
 = 0;

3044 
tw_vd_Üig_buf
->
logic_chª_ad_»ady_m­_bË
 = 0;

3045 
tw_vd_Üig_buf
->
logic_chª_’code_ov”_m­_bË
 = 0;

3046 
	`©omic_£t
(&
tw_vd_Üig_buf
->
¡İ_check_ad
, 0);

3048 
	`¥š_uÆock_œq»¡Üe
(&
tw_vd_Üig_buf
->
lock
, 
æags
);

3050 
	}
}

3052 
tw_vd_Üig_buf_šfo_İ”©iÚ
 
	gtw5864_vd_¦Ù_Üig_buf_šfo_İ
 = {

3053 .
š™
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_š™
,

3054 .
	gfœ¡_sync_Üig_buf_šfo
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_fœ¡_sync_Üig_buf_šfo
,

3055 .
	gvd_Üig_buf_»ady
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_vd_Üig_buf_»ady
,

3056 .
	gg‘_vd_ad_phy_±r
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_g‘_vd_ad_phy_±r
,

3057 .
	g£t_vd_upd©e_Üig_buf_»g
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_£t_vd_upd©e_Üig_buf_»g
,

3058 .
	g£t_vd_cu¼_’code_±r
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_£t_vd_cu¼_’code_±r
,

3059 .
	gupd©e_vd_’code_±r
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_upd©e_vd_’code_±r
,

3060 .
	gupd©e_time¡amp
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_upd©e_time¡amp
,

3061 .
	gg‘_time¡amp
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_g‘_time¡amp
,

3062 .
	gsoáw¬e_disÿrd_äame
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_soáw¬e_disÿrd_äame
,

3063 .
	g’code_’dof¦iû_nÙify
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_’code_’dof¦iû_nÙify
,

3064 .
	g’code_uÄegi¡”_nÙify
 = 
tw5864_vd_¦Ù_Üig_buf_šfo_’code_uÄegi¡”_nÙify
,

3067 
	$š™_tw5864_vd_¦Ù_Üig_buf_šfo
(
tw_vd_Üig_buf_šfo_t
 *
tw_vd_Üig_buf
, 
phy_¦Ù_id
)

3069 if(
tw_vd_Üig_buf
 !ğ
NULL
){

3070 
tw_vd_Üig_buf
->
İ
 = &
tw5864_vd_¦Ù_Üig_buf_šfo_İ
;

3071 
tw_vd_Üig_buf
->
İ
->
	`š™
Ñw_vd_Üig_buf, 
phy_¦Ù_id
);

3073 
	}
}

3075 
	$tw5864_h264_logic_’code_chª_mÚ™Ü
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
)

3077 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

3078 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

3079 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

3080 
logic_chª_id
;

3081 
tw_ed_fsm_t
 *
ed_fsm
;

3082 
tw_h264_’code_d–_t
 *
d–
;

3084 #ifdeà
USER_FILE_IO_REQ


3087 
’code_äame_queue
 = &
h264_logic_’code_chª
->encode_frame_queue;

3088 
’code_cÚŒŞ
 = &
h264_logic_’code_chª
->encode_control;

3089 
d–
 = &
’code_cÚŒŞ
->
’code_d–
;

3090 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

3091 
logic_chª_id
 = 
h264_logic_’code_chª
->logic_chan_id;

3092 
ed_fsm
 = &
İ’ed_logic_chª_ed
->ed_fsm;

3093 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm)){

3094 
TW_ED_IDLE
:

3095 if(
phy_video_¦Ù
->
İ
->
	`¦Ù_ad_is_»ady
Õhy_video_¦Ù, 
h264_logic_’code_chª
->
ch
, h264_logic_encode_chan)){

3096 
’code_cÚŒŞ
->
İ
->
	`upd©e_ad_»ady
(encode_control);

3098 if(
’code_cÚŒŞ
->
İ
->
	`g‘_¦iû_h—d_ªd_ad_¡©us
(encode_control)){

3099 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

3102 
TW_ED_SUSPEND
:

3103 if(
phy_video_¦Ù
->
İ
->
	`¦Ù_ad_is_»ady
Õhy_video_¦Ù, 
h264_logic_’code_chª
->
ch
, h264_logic_encode_chan)){

3104 
’code_cÚŒŞ
->
İ
->
	`upd©e_ad_»ady
(encode_control);

3106 if(
’code_cÚŒŞ
->
İ
->
	`g‘_ad_¡©us
(encode_control)){

3107 
phy_video_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
Õhy_video_¦Ù, 
h264_logic_’code_chª
->
ch
, h264_logic_encode_chan);

3111 
TW_ED_UNREGISTER
:

3112 
TW_ED_CLOSED
:

3113 
TW_ED_STANDBY
:

3114 
TW_ED_RUNNING
:

3115 
TW_ED_TRANSFERING
:

3118 
’code_cÚŒŞ
->
i_¡©i¡ic_mšu‹r_couÁ”
++;

3119 
’code_cÚŒŞ
->
i_Œigg”_sync_couÁ”
++;

3120 if(
’code_cÚŒŞ
->
i_Œigg”_sync_couÁ”
 > 
TIMER_200MS
){

3121 
’code_cÚŒŞ
->
i_Œigg”_sync_couÁ”
 = 0;

3122 if(
	`©omic_»ad
(&
h264_logic_’code_chª
->
have_d–iv”_sync_æag
) == 0){

3123 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_AV_SYNC
, 
NONBLOCK_OP
);

3124 
	`©omic_£t
(&
h264_logic_’code_chª
->
have_d–iv”_sync_æag
, 1);

3127 if(
’code_cÚŒŞ
->
i_¡©i¡ic_mšu‹r_couÁ”
 >ğ(
TIMER_1_MINUTE
)){

3128 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
h264_logic_’code_chª
->
ch
->chip_dpram_controller;

3129 
ddr_video_b™¡»am_»sourû_mªage_t
 *
video_b™¡»am_»sourû
 = &
ch_d´am_cÚŒŞËr
->video_bitstream_resource;

3130 
u32
 
£c
;

3131 
’code_cÚŒŞ
->
Ï¡_jiff›s
 = 
jiff›s
 -ƒncode_control->last_jiffies;

3132 
£c
 = 
	`jiff›s_to_m£cs
(
’code_cÚŒŞ
->
Ï¡_jiff›s
) / 1000;

3133 
£c
 = 
’code_cÚŒŞ
->
i_åm
 / sec;

3134 
’code_cÚŒŞ
->
i_cu¼_ås
 =ƒncode_cÚŒŞ->
i_åm
;

3136 
	`TW_DBG
(
TW_DBG_INFO
, "chª_%d_%d: fpm=%d, %dms, %dås\n", 
phy_video_¦Ù
->
phy_¦Ù_id
,

3137 
logic_chª_id
, 
’code_cÚŒŞ
->
i_åm
,

3138 
	`jiff›s_to_m£cs
(
’code_cÚŒŞ
->
Ï¡_jiff›s
), 
£c
);

3139 
	`TW_DBG
(
TW_DBG_INFO
, "%d, (%d, %d, %d, %d, %d), (%d, %d, %x), %d\n", 
__LINE__
, 
’code_cÚŒŞ
->
ad_check
,ƒncode_cÚŒŞ->
ad_d–1
,

3140 
’code_cÚŒŞ
->
ad_d–2
,ƒncode_cÚŒŞ->
ad_d–3
,ƒncode_cÚŒŞ->
ad_»ady
,

3141 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm),

3142 
ed_fsm
->
İ
->
	`g‘_Ï¡_¡©e
(ed_fsm),

3143 *((*)&
ed_fsm
->
Œªsãr_³ndšg
),

3144 
video_b™¡»am_»sourû
->
İ
->
	`g‘_ÿn_u£_»sourû_numb”
(video_bitstream_resource));

3146 
d–
->
max_d–
 = 0;

3147 
d–
->
mš_d–
 = 0;

3148 
’code_cÚŒŞ
->
i_ås
 = 
£c
;

3149 
’code_cÚŒŞ
->
ad_check
 = 0;

3150 
’code_cÚŒŞ
->
ad_d–1
 = 0;

3151 
’code_cÚŒŞ
->
ad_d–2
 = 0;

3152 
’code_cÚŒŞ
->
ad_d–3
 = 0;

3153 
’code_cÚŒŞ
->
ad_»ady
 = 0;

3154 
’code_cÚŒŞ
->
i_åm
 = 0;

3155 
’code_cÚŒŞ
->
i_¡©i¡ic_mšu‹r_couÁ”
 = 0;

3156 
’code_cÚŒŞ
->
Ï¡_jiff›s
 = 
jiff›s
;

3158 
	}
}

3160 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_š™
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
)

3162 if(
deš‹¾aû_cÚŒŞ
) {

3163 
deš‹¾aû_cÚŒŞ
->
Ï¡_æags
 = 
TW_TRUE
;

3164 
deš‹¾aû_cÚŒŞ
->
cu¼_æags
 = 
TW_TRUE
;

3165 
deš‹¾aû_cÚŒŞ
->
’abË
 = 
TW_TRUE
;

3166 
deš‹¾aû_cÚŒŞ
->
£ns™ive
 = 0;

3168  
TW_OK
;

3171  
TW_ERR
;

3172 
	}
}

3174 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_»£t
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
)

3176 if(
deš‹¾aû_cÚŒŞ
) {

3177 
deš‹¾aû_cÚŒŞ
->
Ï¡_æags
 = 
TW_TRUE
;

3178 
deš‹¾aû_cÚŒŞ
->
cu¼_æags
 = 
TW_TRUE
;

3179 
deš‹¾aû_cÚŒŞ
->
’abË
 = 
TW_TRUE
;

3180 
deš‹¾aû_cÚŒŞ
->
£ns™ive
 = 0;

3182  
TW_OK
;

3185  
TW_ERR
;

3186 
	}
}

3187 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_adju¡_£ns™ive
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
, 
u32
 
£ns™ive
)

3189 if(
deš‹¾aû_cÚŒŞ
) {

3190 
deš‹¾aû_cÚŒŞ
->
£ns™ive
 = sensitive;

3192  
TW_OK
;

3195  
TW_ERR
;

3196 
	}
}

3198 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_upd©e
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
)

3200 if(
deš‹¾aû_cÚŒŞ
) {

3201 
deš‹¾aû_cÚŒŞ
->
Ï¡_æags
 = deš‹¾aû_cÚŒŞ->
cu¼_æags
;

3203  
TW_OK
;

3206  
TW_ERR
;

3207 
	}
}

3209 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_d‘eù
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
, 
dvm_ch_t
 *
ch
, 
u32
 
phy_¦Ù_id
)

3211 
»t
 = 
TW_ERR
;

3213 if(
deš‹¾aû_cÚŒŞ
 && 
ch
 && (
phy_¦Ù_id
 < 
TW5864_PHY_VD_CHAN_NUMBER
)) {

3214 
æags
;

3216 
	`loÿl_œq_§ve
(
æags
);

3217 
	`mpb_wr™e
(
ch
, 0x382, 
phy_¦Ù_id
);

3218 if(
	`mpb_»ad
(
ch
, 0x3b8)){

3219 
deš‹¾aû_cÚŒŞ
->
cu¼_æags
 = 
TW_TRUE
;

3220 
deš‹¾aû_cÚŒŞ
->
’abË
 = 
TW_TRUE
;

3222 
deš‹¾aû_cÚŒŞ
->
cu¼_æags
 = 
TW_FALSE
;

3223 
deš‹¾aû_cÚŒŞ
->
’abË
 = 
TW_FALSE
;

3225 
	`loÿl_œq_»¡Üe
(
æags
);

3226 
»t
 = 
TW_OK
;

3228 
	`TW_DBG
(
TW_DBG_ERR
, "invalid…arameter\n");

3231  
»t
;

3232 
	}
}

3233 
	$tw_ad­tive_deš‹¾aû_cÚŒŞ_ischªge
(
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû_cÚŒŞ
)

3235 if(
deš‹¾aû_cÚŒŞ
) {

3236 if(
deš‹¾aû_cÚŒŞ
->
Ï¡_æags
 !ğdeš‹¾aû_cÚŒŞ->
cu¼_æags
){

3238  
TW_TRUE
;

3240  
TW_FALSE
;

3244  
TW_ERR
;

3245 
	}
}

3247 
tw_ad­tive_deš‹¾aû_cÚŒŞ_İ”©iÚ
 
	gtw_ad­tive_deš‹¾aû_cÚŒŞ_İ”©iÚ_İ
 = {

3248 .
š™
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_š™
,

3249 .
	g»£t
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_»£t
,

3251 .
	gadju¡_£ns™ive
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_adju¡_£ns™ive
,

3252 .
	gupd©e
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_upd©e
,

3253 .
	gd‘eù
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_d‘eù
,

3254 .
	gischªge
 = 
tw_ad­tive_deš‹¾aû_cÚŒŞ_ischªge
,

3257 
	$tw5864_h264_phy_video_¦Ù_mÚ™Ü
(*
cÚ‹xt
)

3259 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
 = (tw_h264_phy_video_¦Ù_t*)
cÚ‹xt
;

3260 if(
phy_video_¦Ù
 !ğ
NULL
){

3261 
tw_h264_logic_’code_chª_t
 *
ma¡”_h264_logic_’code_chª
, *
sub_h264_logic_’code_chª
;

3262 
logic_chª_id
;

3263 
u32
 
æags
;

3264 
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû
;

3266 
deš‹¾aû
 = &
phy_video_¦Ù
->deinterlace;

3267 
logic_chª_id
 = 
phy_video_¦Ù
->
phy_¦Ù_id
;

3268 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

3269 
logic_chª_id
 |ğ
TW_MASTER_BITSTREAM
;

3270 
	`fšd_»gi¡”_İ’ed_logic_’code_chª_š_ma¡”_¦Ù
(
phy_video_¦Ù
, 
logic_chª_id
, &
ma¡”_h264_logic_’code_chª
);

3271 if(
ma¡”_h264_logic_’code_chª
 !ğ
NULL
){

3272 
	`tw5864_h264_logic_’code_chª_mÚ™Ü
(
ma¡”_h264_logic_’code_chª
, 
phy_video_¦Ù
);

3273 
æags
 = 
deš‹¾aû
->
İ
->
	`d‘eù
(deš‹¾aû, 
ma¡”_h264_logic_’code_chª
->
ch
, 
phy_video_¦Ù
->
phy_¦Ù_id
);

3274 if(
deš‹¾aû
->
İ
->
	`ischªge
(deinterlace)){

3275 
tw_h264_’code_ã©u»_t
 *
pcÚfig
;

3276 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
 = &
ma¡”_h264_logic_’code_chª
->encode_property;

3278 
pcÚfig
 = &
’code_´İ”ty
->
’code_ã©u»
;

3279 
pcÚfig
->
ã©u»_·¿m
.
chªge_mask_æag
 = 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
;

3280 if(
deš‹¾aû
->
’abË
 =ğ
TW_TRUE
) {

3281 
pcÚfig
->
İ
->
	`upd©e_deš‹¾aû
ÕcÚfig, 
TW_H264_FEATURE_ON
);

3283 
pcÚfig
->
İ
->
	`upd©e_deš‹¾aû
ÕcÚfig, 
TW_H264_FEATURE_OFF
);

3288 
logic_chª_id
 = 
phy_video_¦Ù
->
phy_¦Ù_id
;

3289 
logic_chª_id
 <<ğ
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
;

3290 
logic_chª_id
 |ğ
TW_SUB_BITSTREAM
;

3291 
	`fšd_»gi¡”_İ’ed_logic_’code_chª_š_ma¡”_¦Ù
(
phy_video_¦Ù
, 
logic_chª_id
, &
sub_h264_logic_’code_chª
);

3292 if(
sub_h264_logic_’code_chª
 !ğ
NULL
){

3293 
	`tw5864_h264_logic_’code_chª_mÚ™Ü
(
sub_h264_logic_’code_chª
, 
phy_video_¦Ù
);

3294 if(
deš‹¾aû
->
İ
->
	`ischªge
(deinterlace)){

3295 
tw_h264_’code_ã©u»_t
 *
pcÚfig
;

3296 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
 = &
sub_h264_logic_’code_chª
->encode_property;

3298 
pcÚfig
 = &
’code_´İ”ty
->
’code_ã©u»
;

3299 
pcÚfig
->
ã©u»_·¿m
.
chªge_mask_æag
 = 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
;

3300 if(
deš‹¾aû
->
’abË
 =ğ
TW_TRUE
) {

3301 
pcÚfig
->
İ
->
	`upd©e_deš‹¾aû
ÕcÚfig, 
TW_H264_FEATURE_ON
);

3303 
pcÚfig
->
İ
->
	`upd©e_deš‹¾aû
ÕcÚfig, 
TW_H264_FEATURE_OFF
);

3308 
deš‹¾aû
->
İ
->
	`upd©e
(deinterlace);

3311 
	}
}

3313 
	$¡¬t_’code_chª_mÚ™Ü_hook
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
)

3315 if(
phy_video_¦Ù
 !ğ
NULL
){

3316 
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
 = 
	`AddFÜFœeTim”Job
(
ENCODE_CHAN_MONITOR_COUNTER
, 
tw5864_h264_phy_video_¦Ù_mÚ™Ü
,…hy_video_slot);

3317 if(
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
 =ğ
ADDJOBERROR
){

3318 
	`´štk
("%s.%d:‡ddim” hookƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

3320 
	`´štk
("%s.%d:‡ddim” hook ok…hy_video_¦Ù = %d\n", 
__FUNCTION__
, 
__LINE__
, 
phy_video_¦Ù
->
phy_¦Ù_id
);

3323 
	}
}

3325 
	$d–‘e_’code_chª_mÚ™Ü_hook
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
)

3327 if(
phy_video_¦Ù
 !ğ
NULL
){

3328 if(
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
 !ğ
INVALIDTIMERID
){

3329 
	`D–‘eFÜFœeTim”Job
(
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
);

3330 
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
 = 
INVALIDTIMERID
;

3331 
	`´štk
("%s.%d: d–‘tim” hook ok…hy_video_¦Ù = %d\n", 
__FUNCTION__
, 
__LINE__
, 
phy_video_¦Ù
->
phy_¦Ù_id
);

3334 
	}
}

3336 
	$tw5864_h264_phy_video_¦Ù_š™
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
phy_¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
)

3339 if(
phy_video_¦Ù
 !ğ
NULL
){

3340 
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû
;

3342 
	`©omic_£t
(&
phy_video_¦Ù
->
fœ¡_¡¬t_æag
, 1);

3343 
phy_video_¦Ù
->
phy_¦Ù_id
 =…hy_slot_id;

3344 
phy_video_¦Ù
->
phy_bus_id
 = 
phy_¦Ù_id
 / 4;

3345 
phy_video_¦Ù
->
m­_logic_id
 = 
TW5864_LOGIC_VD_INVALID
;

3346 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
 = 
NULL
;

3347 
phy_video_¦Ù
->
video_size
 = video_size;

3348 
	`š™_tw5864_vd_¦Ù_Üig_buf_šfo
(&
phy_video_¦Ù
->
vd_Üig_buf
, 
phy_¦Ù_id
);

3349 
	`š™_»gi¡”_bË_node
(&
phy_video_¦Ù
->
logic_chª_bË
);

3350 
	`š™_»gi¡”_bË_node
(&
phy_video_¦Ù
->
İ’ed_logic_chª_bË
);

3351 
phy_video_¦Ù
->
’code_chª_mÚ™Ü_timeid
 = 
INVALIDTIMERID
;

3352 
phy_video_¦Ù
->
¡¬t_’code_chª_mÚ™Ü_hook
 = start_encode_chan_monitor_hook;

3353 
phy_video_¦Ù
->
d–‘e_’code_chª_mÚ™Ü_hook
 = delete_encode_chan_monitor_hook;

3355 
deš‹¾aû
 = &
phy_video_¦Ù
->deinterlace;

3356 
deš‹¾aû
->
İ
 = &
tw_ad­tive_deš‹¾aû_cÚŒŞ_İ”©iÚ_İ
;

3357 
deš‹¾aû
->
İ
->
	`š™
(deinterlace);

3359 
	}
}

3361 
	$tw5864_h264_phy_video_¦Ù_»£t
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
)

3363 
tw_ad­tive_deš‹¾aû_cÚŒŞ
 *
deš‹¾aû
;

3365 
deš‹¾aû
 = &
phy_video_¦Ù
->deinterlace;

3366 
deš‹¾aû
->
İ
->
	`»£t
(deinterlace);

3368 
	}
}

3370 
	$tw5864_h264_phy_video_¦Ù_soáw¬e_disÿrd_äam”
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3372 if((
ch
!=
NULL
)){

3373 
tw_vd_Üig_buf_šfo_t
 *
vd_Üig_buf
 = &
phy_video_¦Ù
->vd_orig_buf;

3374 
vd_Üig_buf
->
İ
->
	`soáw¬e_disÿrd_äame
(vd_Üig_buf, 
ch
, 
h264_logic_’code_chª
);

3376 
	}
}

3378 
	$tw5864_h264_phy_video_¦Ù_ad_is_»ady
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3380 
»t
 = 0;

3381 if((
ch
!=
NULL
)){

3382 
tw_vd_Üig_buf_šfo_t
 *
vd_Üig_buf
 = &
phy_video_¦Ù
->vd_orig_buf;

3384 if(
vd_Üig_buf
->
İ
->
	`vd_Üig_buf_»ady
(vd_Üig_buf, 
ch
, 
h264_logic_’code_chª
)){

3385 
»t
 = 1;

3388  
»t
;

3389 
	}
}

3391 
	$tw5864_h264_phy_video_¦Ù_fœ¡_¡¬t
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
)

3393 
	`´štk
("%s.%d:%d\n", 
__FUNCTION__
, 
__LINE__
, 
	`©omic_»ad
(&
phy_video_¦Ù
->
fœ¡_¡¬t_æag
));

3394 if(
	`©omic_»ad
(&
phy_video_¦Ù
->
fœ¡_¡¬t_æag
)){

3395 
tw_vd_Üig_buf_šfo_t
 *
vd_Üig_buf
;

3396 
£Ëù_chª
;

3397 
u32
 
d©a
;

3398 
	`©omic_£t
(&
phy_video_¦Ù
->
fœ¡_¡¬t_æag
, 0);

3400 
£Ëù_chª
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CHANNEL_SELECT
);

3401 
£Ëù_chª
 |ğ(1<<
phy_video_¦Ù
->
phy_¦Ù_id
);

3402 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_SELECT
, 
£Ëù_chª
);

3403 
d©a
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CHANNEL_ID
);

3404 
d©a
 = (d©¨& (~0xf)è| 
phy_video_¦Ù
->
phy_¦Ù_id
;

3405 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_ID
, 
d©a
);

3406 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
REFERENCEFRAME
, 0x0440);

3407 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRANDMECONTROL
, 0x0000);

3408 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
WINDOWSIZE
, 
SEARCH_WINDOW_SIZE_VALUE
);

3409 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

3410 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRA4X4_THRESHOLD_I
, 0x18);

3412 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRA4X4_THRESHOLD_IP
, 0x0);

3413 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x0070);

3414 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ORIGINALSEQUENCE
, 0x0440);

3416 
vd_Üig_buf
 = &
phy_video_¦Ù
->vd_orig_buf;

3417 if(
vd_Üig_buf
->
İ
 !ğ
NULL
){

3418 
vd_Üig_buf
->
İ
->
	`fœ¡_sync_Üig_buf_šfo
(vd_Üig_buf, 
ch
);

3420 
	`tw5864_vd_¦Ù_Üig_buf_šfo_fœ¡_sync_Üig_buf_šfo
(
vd_Üig_buf
, 
ch
);

3422 
ch
->
video_’code_ÿp
->
’code_»g_4
 = (
DEBLOCKINGON
|
INTRAON
|
CMOSON
|
INTERON
|
DDRON
);

3424 
phy_video_¦Ù
->
İ
->
	`g‘_video_size
(phy_video_slot)){

3426 
TW_VIDEO_SIZE_D1
:

3427 
ch
->
video_’code_ÿp
->
’code_»g_4
 |ğ
D1
;

3429 
TW_VIDEO_SIZE_HALF_D1
:

3430 
ch
->
video_’code_ÿp
->
’code_»g_4
 |ğ
HALFD1
;

3432 
TW_VIDEO_SIZE_CIF
:

3433 
ch
->
video_’code_ÿp
->
’code_»g_4
 |ğ
CIF
;

3437 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, ch->
video_’code_ÿp
->
’code_»g_4
);

3438 
phy_video_¦Ù
->
	`¡¬t_’code_chª_mÚ™Ü_hook
(phy_video_slot);

3440 
	}
}

3442 
	$tw5864_h264_phy_video_¦Ù_’d_¡İ
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3444 if((
h264_logic_’code_chª
!=
NULL
)){

3445 
dvm_ch_t
 *
ch
 = 
h264_logic_’code_chª
->chip;

3446 
£Ëù_chª
;

3447 
£Ëù_chª
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CHANNEL_SELECT
);

3448 
£Ëù_chª
 &ğ~(1<<
phy_video_¦Ù
->
phy_¦Ù_id
);

3449 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_SELECT
, 
£Ëù_chª
);

3450 
	`©omic_£t
(&
phy_video_¦Ù
->
fœ¡_¡¬t_æag
, 1);

3452 
	}
}

3454 
	$tw5864_h264_phy_video_¦Ù_£t_¦Ù_’code_±r
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3456 if((
ch
!=
NULL
è&& (
h264_logic_’code_chª
!=NULL)){

3457 
phy_video_¦Ù
->
vd_Üig_buf
.
İ
->
	`£t_vd_cu¼_’code_±r
(&phy_video_¦Ù->vd_Üig_buf, 
ch
, 
h264_logic_’code_chª
);

3459 
	}
}

3461 
u32
 
	$tw5864_h264_phy_video_¦Ù_g‘_time¡amp
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
)

3463 
tw_vd_Üig_buf_šfo_t
 *
vd_Üig_buf
;

3464 
vd_Üig_buf
 = &
phy_video_¦Ù
->vd_orig_buf;

3465  
vd_Üig_buf
->
İ
->
	`g‘_time¡amp
(vd_orig_buf);

3466 
	}
}

3468 
	$tw5864_h264_phy_video_¦Ù_’code_’dof¦iû_nÙify
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3470 if((
h264_logic_’code_chª
!=
NULL
)){

3471 
phy_video_¦Ù
->
vd_Üig_buf
.
İ
->
	`’code_’dof¦iû_nÙify
(&phy_video_¦Ù->vd_Üig_buf, 
h264_logic_’code_chª
);

3473 
	}
}

3475 
	$tw5864_h264_phy_video_¦Ù_’code_uÄegi¡”_nÙify
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3477 if((
h264_logic_’code_chª
!=
NULL
)){

3478 
phy_video_¦Ù
->
vd_Üig_buf
.
İ
->
	`’code_uÄegi¡”_nÙify
(&phy_video_¦Ù->vd_Üig_buf, 
h264_logic_’code_chª
);

3480 
	}
}

3482 
	$tw5864_h264_phy_video_¦Ù_upd©e_m­_logic_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
m­_logic_id
, 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
)

3484 if(
phy_video_¦Ù
 !ğ
NULL
){

3485 
phy_video_¦Ù
->
m­_logic_id
 = map_logic_id;

3486 if(
m­_logic_id
 =ğ
TW5864_LOGIC_VD_INVALID
){

3487 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
 = 
NULL
;

3489 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
 = 
logic_video_¦Ù
;

3492 
	}
}

3494 
	$tw5864_h264_phy_video_¦Ù_g‘_video_size
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
)

3496 if(
phy_video_¦Ù
 !ğ
NULL
){

3497  
phy_video_¦Ù
->
video_size
;

3499  
TW_VIDEO_SIZE_D1
;

3501 
	}
}

3503 
	$tw5864_h264_phy_video_¦Ù_£t_video_size
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
TW_VIDEO_SIZE
 
video_size
)

3505 if(
phy_video_¦Ù
 !ğ
NULL
){

3506 if((
video_size
!=
TW_VIDEO_SIZE_D1
è&& (video_size!=
TW_VIDEO_SIZE_HALF_D1
è&& (video_size!=
TW_VIDEO_SIZE_CIF
)){

3507 
video_size
 = 
TW_VIDEO_SIZE_D1
;

3509 
phy_video_¦Ù
->
video_size
 = video_size;

3511 
	}
}

3513 
	$tw5864_h264_g‘_phy_¦Ù_by_phy_¦Ù_id
(
dvm_ch_t
 *
ch
, 
phy_¦Ù_id
, 
tw_h264_phy_video_¦Ù_t
 **
phy_video_¦Ù
)

3515 if(
ch
 && 
phy_video_¦Ù
 && (
phy_¦Ù_id
 >ğ0è&& (phy_¦Ù_id < 
TW5864_PHY_VD_CHAN_NUMBER
)) {

3516 *
phy_video_¦Ù
 = &
ch
->
ch_driv”
->
video_bus
.
vd_bus_driv”
->phy_video_¦Ù[
phy_¦Ù_id
];

3518 *
phy_video_¦Ù
 = 
NULL
;

3519 
	`TW_DBG
(
TW_DBG_ERR
, "šv®id…hy_¦Ù_id %d\n", 
phy_¦Ù_id
);

3521 
	}
}

3523 
tw_h264_phy_video_¦Ù_İ”©iÚ
 
	gtw5864_h264_phy_video_¦Ù_İ
 = {

3524 .
š™
 = 
tw5864_h264_phy_video_¦Ù_š™
,

3525 .
	g¦Ù_»£t
 = 
tw5864_h264_phy_video_¦Ù_»£t
,

3526 .
	g¦Ù_soáw¬e_disÿrd_äame
 = 
tw5864_h264_phy_video_¦Ù_soáw¬e_disÿrd_äam”
,

3527 .
	g¦Ù_ad_is_»ady
 = 
tw5864_h264_phy_video_¦Ù_ad_is_»ady
,

3528 .
	g¦Ù_fœ¡_¡¬t
 = 
tw5864_h264_phy_video_¦Ù_fœ¡_¡¬t
,

3529 .
	g¦Ù_’d_¡İ
 = 
tw5864_h264_phy_video_¦Ù_’d_¡İ
,

3530 .
	g£t_¦Ù_’code_±r
 = 
tw5864_h264_phy_video_¦Ù_£t_¦Ù_’code_±r
,

3531 .
	gg‘_time¡amp
 = 
tw5864_h264_phy_video_¦Ù_g‘_time¡amp
,

3532 .
	g’code_’dof¦iû_nÙify
 = 
tw5864_h264_phy_video_¦Ù_’code_’dof¦iû_nÙify
,

3533 .
	g’code_uÄegi¡”_nÙify
 = 
tw5864_h264_phy_video_¦Ù_’code_uÄegi¡”_nÙify
,

3534 .
	gupd©e_m­_logic_¦Ù
 = 
tw5864_h264_phy_video_¦Ù_upd©e_m­_logic_¦Ù
,

3535 .
	gg‘_video_size
 = 
tw5864_h264_phy_video_¦Ù_g‘_video_size
,

3536 .
	g£t_video_size
 = 
tw5864_h264_phy_video_¦Ù_£t_video_size
,

3537 .
	gg‘_phy_¦Ù_by_phy_¦Ù_id
 = 
tw5864_h264_g‘_phy_¦Ù_by_phy_¦Ù_id
,

3540 
	$š™_tw5864_h264_phy_video_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
¦Ù_id
, 
TW_VIDEO_SIZE
 
video_size
)

3542 if(
phy_video_¦Ù
 !ğ
NULL
){

3543 
phy_video_¦Ù
->
İ
 = &
tw5864_h264_phy_video_¦Ù_İ
;

3544 
phy_video_¦Ù
->
İ
->
	`š™
Õhy_video_¦Ù, 
¦Ù_id
, 
video_size
);

3546 
	}
}

3548 
	$»move_tw5864_h264_phy_video_¦Ù
(
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

3550 if(
phy_video_¦Ù
 !ğ
NULL
){

3551 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
 = &
phy_video_¦Ù
->opened_logic_chan_table;

3552 if(
İ’ed_logic_chª_bË
->
İ
->
	`g‘_cu¼_»gi¡”_node_numb”
(opened_logic_chan_table) == 0){

3553 
phy_video_¦Ù
->
	`d–‘e_’code_chª_mÚ™Ü_hook
(phy_video_slot);

3554 
phy_video_¦Ù
->
İ
->
	`¦Ù_’d_¡İ
Õhy_video_¦Ù, 
h264_logic_’code_chª
);

3557 
	}
}

3559 
	$tw5864_h264_’code_cÚŒŞ_£t_¥s
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3561 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3562 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3563 
h264_¥s_t
 *
¥s
;

3564 
gİIÁ”v®s
;

3566 
¥s
 = 
h264_’code_cÚŒŞ
->sps;

3567 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3568 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3569 if(
’code_´İ”ty
->
İ
 !ğ
NULL
){

3570 
gİIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_gİIÁ”v®s
(encode_property);

3572 
gİIÁ”v®s
 = 
	`tw_h264_’code_´İ”ty_g‘_gİIÁ”v®s
(
’code_´İ”ty
);

3574 
¥s
->
i_id
 = 0;

3575 
¥s
->
i_´ofe_idc
 = 
PROFILE_BASELINE
;

3576 
¥s
->
i_Ëv–_idc
 = 
DEFAULT_LEVEL_IDC
;

3577 
¥s
->
b_cÚ¡¿št_£t0
 = 0;

3578 
¥s
->
b_cÚ¡¿št_£t1
 = 0;

3579 
¥s
->
b_cÚ¡¿št_£t2
 = 0;

3580 
¥s
->
i_log2_max_äame_num
 = 4;

3581  (1 << 
¥s
->
i_log2_max_äame_num
è< 
gİIÁ”v®s
){

3582 
¥s
->
i_log2_max_äame_num
++;

3584 
¥s
->
i_poc_ty³
 = 0;

3585 ifĞ
¥s
->
i_poc_ty³
 == 0 ){

3586 
¥s
->
i_log2_max_poc_lsb
 = sps->
i_log2_max_äame_num
;

3587 } iàĞ
¥s
->
i_poc_ty³
 == 1 ) {

3588 
i
;

3589 
¥s
->
b_d–_pic_Üd”_®ways_z”o
 = 1;

3590 
¥s
->
i_off£t_fÜ_nÚ_»f_pic
 = 0;

3591 
¥s
->
i_off£t_fÜ_tİ_to_bÙtom_f›ld
 = 0;

3592 
¥s
->
i_num_»f_äames_š_poc_cyşe
 = 0;

3593  
i
 = 0; i < 
¥s
->
i_num_»f_äames_š_poc_cyşe
; i++ ){

3594 
¥s
->
i_off£t_fÜ_»f_äame
[
i
] = 0;

3597 
¥s
->
i_num_»f_äames
 = 1;

3598 
¥s
->
b_g­s_š_äame_num_v®ue_®lowed
 = 0;

3599 
¥s
->
i_mb_width
 = 
h264_’code_cÚŒŞ
->
i_mb_x
;

3600 
¥s
->
i_mb_height
 = 
h264_’code_cÚŒŞ
->
i_mb_y
;

3601 
¥s
->
b_äame_mbs_Úly
 = 1;

3602 
¥s
->
b_mb_ad­tive_äame_f›ld
 = 0;

3603 
¥s
->
b_dœeù8x8_šã»nû
 = 0;

3604 ifĞ
¥s
->
b_äame_mbs_Úly
 == 0){

3605 
¥s
->
b_dœeù8x8_šã»nû
 = 1;

3607 
¥s
->
b_üİ
 = 0;

3608 
¥s
->
b_vui
 = 0;

3609 
	}
}

3611 
	$tw5864_h264_’code_cÚŒŞ_£t_µs
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3613 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3614 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3615 
h264_¥s_t
 *
¥s
 = 
h264_’code_cÚŒŞ
->sps;

3616 
h264_µs_t
 *
µs
 = 
h264_’code_cÚŒŞ
->pps;

3618 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3619 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3620 
µs
->
i_id
 = 0;

3621 
µs
->
i_¥s_id
 = 
¥s
->
i_id
;

3622 
µs
->
b_ÿbac
 = 0;

3623 
µs
->
b_pic_Üd”
 = 0;

3624 
µs
->
i_num_¦iû_groups
 = 1;

3625 
µs
->
i_num_»f_idx_l0_aùive
 = 1;

3626 
µs
->
i_num_»f_idx_l1_aùive
 = 1;

3627 
µs
->
b_weigh‹d_´ed
 = 0;

3628 
µs
->
b_weigh‹d_b»d
 = 0;

3629 
µs
->
i_pic_š™_qp
 = 
DEFAULT_QP
;

3630 
µs
->
i_pic_š™_qs
 =…ps->
i_pic_š™_qp
;

3631 
µs
->
i_chroma_qp_šdex_off£t
 = 0;

3632 
µs
->
b_deblockšg_f‹r_cÚŒŞ
 = 0;

3633 
µs
->
b_cÚ¡¿šed_šŒa_´ed
 = 0;

3634 
µs
->
b_»dundªt_pic_út
 = 0;

3635 
	}
}

3637 
	$tw5864_h264_’code_cÚŒŞ_£t_¦iû_h—d
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3639 
h264_¦iû_h—d”_t
 *
¦iû
 = 
h264_’code_cÚŒŞ
->
¦iû_h—d
;

3640 
h264_¥s_t
 *
¥s
 = 
h264_’code_cÚŒŞ
->sps;

3641 
h264_µs_t
 *
µs
 = 
h264_’code_cÚŒŞ
->pps;

3643 
¦iû
->
¥s
 = sps;

3644 
¦iû
->
µs
 =…ps;

3645 
¦iû
->
i_fœ¡_mb
 = 
h264_’code_cÚŒŞ
->i_first_mb;

3646 
¦iû
->
i_Ï¡_mb
 = 
¥s
->
i_mb_width
 * sps->
i_mb_height
;

3647 
¦iû
->
i_µs_id
 = 
µs
->
i_id
;

3648 
¦iû
->
i_äame_num
 = 
h264_’code_cÚŒŞ
->
i_¦iû_äame_num
;

3649 
¦iû
->
b_f›ld_pic
 = 0;

3650 
¦iû
->
b_bÙtom_f›ld
 = 1;

3651 
¦iû
->
i_poc_lsb
 = 0;

3652 
¦iû
->
i_d–_poc_bÙtom
 = 0;

3653 
¦iû
->
i_d–_poc
[0] = 0;

3654 
¦iû
->
i_d–_poc
[1] = 0;

3655 
¦iû
->
i_»dundªt_pic_út
 = 0;

3656 
¦iû
->
b_num_»f_idx_ov”ride
 = 0;

3657 
¦iû
->
i_num_»f_idx_l0_aùive
 = 1;

3658 
¦iû
->
i_num_»f_idx_l1_aùive
 = 1;

3659 if(
¦iû
->
i_äame_num
<=¦iû->
i_num_»f_idx_l0_aùive
){

3660 
¦iû
->
i_»dundªt_pic_út
 = 1;

3662 
¦iû
->
i_»dundªt_pic_út
 = 0;

3664 
¦iû
->
i_qp_d–
 = (
h264_’code_cÚŒŞ
->
i_cu¼_qp
 - 
µs
->
i_pic_š™_qp
);

3665 
¦iû
->
b_¥_fÜ_swidth
 = 0;

3666 
¦iû
->
i_qs_d–
 = 0;

3667 
¦iû
->
i_di§bË_deblockšg_f‹r_idc
 = 0;

3668 
¦iû
->
i_®pha_c0_off£t
 = 0;

3669 
¦iû
->
i_b‘a_off£t
 = 0;

3670 
	}
}

3672 
	$tw5864_h264_’code_cÚŒŞ_ÿlcuÏ‹_äame_ty³
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3674 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3675 
h264_¦iû_h—d”_t
 *
¦iû_h—d
 = 
h264_’code_cÚŒŞ
->slice_head;

3676 if(
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 == 0) {

3677 
h264_’code_cÚŒŞ
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

3679 if((
h264_’code_cÚŒŞ
->
i_p_¡ride
==0è|| (h264_’code_cÚŒŞ->
b_fÜû_i_äame
)){

3680 
h264_’code_cÚŒŞ
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

3682 
h264_’code_cÚŒŞ
->
äame_ty³
 = 
H264_FRAME_TYPE_P
;

3685 if(
h264_’code_cÚŒŞ
->
äame_ty³
 =ğ
H264_FRAME_TYPE_IDR
){

3686 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 0;

3687 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

3688 
h264_’code_cÚŒŞ
->
i_¦iû_äame_num
 = 0;

3689 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

3691 
h264_’code_cÚŒŞ
->
äame_ty³
) {

3692 
H264_FRAME_TYPE_P
:

3693 
¦iû_h—d
->
i_ty³
 = 
SLICE_TYPE_P
;

3695 
H264_FRAME_TYPE_I
:

3696 
¦iû_h—d
->
i_ty³
 = 
SLICE_TYPE_I
;

3699 
H264_FRAME_TYPE_IDR
:

3700 
¦iû_h—d
->
i_ty³
 = 
SLICE_TYPE_I
;

3701 
h264_’code_cÚŒŞ
->
i_idr_pic_id
++;

3702 
h264_’code_cÚŒŞ
->
i_idr_pic_id
 &= 0xffff;

3703 
¦iû_h—d
->
i_idr_pic_id
 = 
h264_’code_cÚŒŞ
->i_idr_pic_id;

3707 
	}
}

3709 
	$tw5864_h264_’code_cÚŒŞ_g‘_äame_ty³
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3711 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3712  
h264_’code_cÚŒŞ
->
äame_ty³
;

3714  
H264_FRAME_TYPE_IDR
;

3716 
	}
}

3718 
	$tw5864_h264_’code_cÚŒŞ_g’”©Ü_h—d
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_video_äame_tcb_t
 *
äame
)

3720 if((
h264_’code_cÚŒŞ
!=
NULL
è&& (
äame
!=NULL)){

3721 
äame_ty³
;

3722 
äame_ty³
 = 
h264_’code_cÚŒŞ
->
İ
->
	`g‘_äame_ty³
(h264_encode_control);

3723 
äame_ty³
){

3725 
H264_FRAME_TYPE_IDR
:

3726 
	`g’_h264_¥s
(
h264_’code_cÚŒŞ
, 
äame
);

3727 
	`g’_h264_µs
(
h264_’code_cÚŒŞ
, 
äame
);

3728 
	`g’_h264_¦iûh—d
(
h264_’code_cÚŒŞ
, 
äame
, 
H264_FRAME_TYPE_IDR
);

3730 
H264_FRAME_TYPE_I
:

3731 
	`g’_h264_¦iûh—d
(
h264_’code_cÚŒŞ
, 
äame
, 
H264_FRAME_TYPE_I
);

3733 
H264_FRAME_TYPE_P
:

3734 
	`g’_h264_¦iûh—d
(
h264_’code_cÚŒŞ
, 
äame
, 
H264_FRAME_TYPE_P
);

3738 
	}
}

3740 
	$tw5864_h264_’code_cÚŒŞ_fÜû_I_äame
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3742 if(
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
){

3743 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

3745 
	}
}

3747 
	$tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_ok
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3749 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3750 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3751 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3752 
keyF¿meIÁ”v®s
, 
gİIÁ”v®s
;

3754 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3755 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3756 
h264_’code_cÚŒŞ
->
i_äameNumb”
++;

3757 
h264_’code_cÚŒŞ
->
i_äame_£rŸl
++;

3758 
h264_’code_cÚŒŞ
->
i_¦iû_äame_num
++;

3759 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
++;

3760 
h264_’code_cÚŒŞ
->
i_p_¡ride
++;

3761 
keyF¿meIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

3762 
gİIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_gİIÁ”v®s
(encode_property);

3763 if(
h264_’code_cÚŒŞ
->
i_p_¡ride
 >ğ
keyF¿meIÁ”v®s
){

3764 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

3769 if(
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 >ğ
gİIÁ”v®s
){

3770 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

3772 
h264_’code_cÚŒŞ
->
i_vd_»ã»nû_±r
++;

3773 
h264_’code_cÚŒŞ
->
i_vd_»ã»nû_±r
 &= 3;

3775 
	}
}

3777 
	$tw5864_h264_’code_cÚŒŞ_upd©e_©_disÿrd_äame
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3779 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3780 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3781 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3782 
keyF¿meIÁ”v®s
, 
gİIÁ”v®s
;

3784 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3785 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3787 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
++;

3789 
h264_’code_cÚŒŞ
->
i_p_¡ride
++;

3790 if(
’code_´İ”ty
->
İ
 !ğ
NULL
){

3791 
keyF¿meIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

3792 
gİIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_gİIÁ”v®s
(encode_property);

3794 
keyF¿meIÁ”v®s
 = 
	`tw_h264_’code_´İ”ty_g‘_keyF¿meIÁ”v®s
(
’code_´İ”ty
);

3795 
gİIÁ”v®s
 = 
	`tw_h264_’code_´İ”ty_g‘_gİIÁ”v®s
(
’code_´İ”ty
);

3797 if(
h264_’code_cÚŒŞ
->
i_p_¡ride
 >ğ
keyF¿meIÁ”v®s
){

3798 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

3803 if(
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 >ğ
gİIÁ”v®s
){

3804 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

3807 
	}
}

3809 
	$tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_”r
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3811 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3812 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3813 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3814 
keyF¿meIÁ”v®s
, 
gİIÁ”v®s
;

3816 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3817 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3820 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
++;

3821 
h264_’code_cÚŒŞ
->
i_p_¡ride
++;

3822 
keyF¿meIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

3823 
gİIÁ”v®s
 = 
’code_´İ”ty
->
İ
->
	`g‘_gİIÁ”v®s
(encode_property);

3824 if(
h264_’code_cÚŒŞ
->
i_p_¡ride
 >ğ
keyF¿meIÁ”v®s
){

3825 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

3830 if(
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 >ğ
gİIÁ”v®s
){

3831 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

3834 
	}
}

3836 
	$tw5864_h264_’code_cÚŒŞ_upd©e_image_»sŞutiÚ
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3838 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3839 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3840 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

3841 
osd_chª_’gše_t
 *
osd_’gše
;

3842 
i_mb_numb”
;

3844 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3845 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

3846 
osd_’gše
 = &
h264_logic_’code_chª
->
’code_osd_’gše
;

3847 
i_mb_numb”
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize_width
(encode_property);

3849 
h264_’code_cÚŒŞ
->
i_mb_x
 = ((
i_mb_numb”
)>>4);

3850 
i_mb_numb”
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize_height
(encode_property);

3852 
h264_’code_cÚŒŞ
->
i_mb_y
 = ((
i_mb_numb”
)>>4);

3853 
h264_’code_cÚŒŞ
->
i_fœ¡_mb
 = 0;

3854 
h264_’code_cÚŒŞ
->
i_fœ¡_mb_x_ªd_y
 = 0;

3855 
	`TW_DBG
(
TW_DBG_INFO
, "video size changed,„esynco osd\n");

3856 
	`©omic_£t
(&
osd_’gše
->
sync_osd_·¿m
, 1);

3858 
	}
}

3860 
	$tw5864_h264_’code_cÚŒŞ_upd©e_ås_disÿrd_bË
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
u32
 
phy_ås
, u32 
rg‘_ås
)

3862 if(
h264_’code_cÚŒŞ
) {

3863 
u32
 
mask
, 
i
;

3865 
mask
 = 0;

3866 
i
 = 0; i < 
phy_ås
; i++) {

3867 
mask
 |ğ(1 << 
i
);

3870 if((
phy_ås
 =ğ0è|| (
rg‘_ås
 == 0)) {

3871 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 0;

3872 }if(
phy_ås
 < 
rg‘_ås
){

3873 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 
mask
;

3875 
mask
 = 0;

3876 
i
 = 0; i < 
rg‘_ås
; i++) {

3877 
mask
 |ğ(1 << 
i
);

3879 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 
mask
;

3882 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 
	`g‘_b™s_m­
(
phy_ås
, 
rg‘_ås
);

3883 
mask
 = 0;

3884 
i
 = 0; i < 
phy_ås
; i++) {

3885 if(
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 & (1<<
i
)) {

3886 
mask
++;

3890 
	`TW_DBG
(
TW_DBG_INFO
, "phy_fps = %d,arget_fps = %d,able size %d, discardTable = 0x%08x\n",

3891 
phy_ås
, 
rg‘_ås
, 
mask
, 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
);

3893 
	}
}

3895 
	$tw5864_h264_’code_cÚŒŞ_g‘_¦iû_h—d_ªd_ad_¡©us
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3897 
»t
 = 0;

3898 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3899 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3900 
æags
;

3902 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

3903 
	`loÿl_œq_§ve
(
æags
);

3904 
»t
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3905 if((
»t
&
DEV_CAN_SERVICE
) == DEV_CAN_SERVICE){

3906 
h264_’code_cÚŒŞ
->
İ
->
	`ş—r_¦iû_h—d_ªd_ad_¡©us
(h264_encode_control);

3907 
»t
 = 1;

3909 
»t
 = 0;

3911 
	`loÿl_œq_»¡Üe
(
æags
);

3913  
»t
;

3914 
	}
}

3916 
	$tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_ªd_ad_¡©us
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3918 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3919 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 0);

3921 
	}
}

3923 
	$tw5864_h264_’code_cÚŒŞ_upd©e_¦iû_h—d_»ady
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3925 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3926 
æags
;

3927 
»t
;

3928 
	`loÿl_œq_§ve
(
æags
);

3929 
»t
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3930 
»t
 |ğ
SLICEHEAD_IS_READY
;

3931 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 
»t
);

3932 
	`loÿl_œq_»¡Üe
(
æags
);

3934 
	}
}

3936 
	$tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_»ady
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3938 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3939 
æags
;

3940 
»t
;

3941 
	`loÿl_œq_§ve
(
æags
);

3942 
»t
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3943 
»t
 &ğ~
SLICEHEAD_IS_READY
;

3944 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 
»t
);

3945 
	`loÿl_œq_»¡Üe
(
æags
);

3947 
	}
}

3949 
	$tw5864_h264_’code_cÚŒŞ_upd©e_ad_»ady
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3951 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3952 
æags
;

3953 
»t
;

3954 
	`loÿl_œq_§ve
(
æags
);

3955 
»t
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3956 
»t
 |ğ
AD_IS_READY
;

3957 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 
»t
);

3958 
h264_’code_cÚŒŞ
->
ad_»ady
++;

3959 
	`loÿl_œq_»¡Üe
(
æags
);

3961 
	}
}

3963 
	$tw5864_h264_’code_cÚŒŞ_ş—r_ad_»ady
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3965 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3966 
æags
;

3967 
»t
;

3968 
	`loÿl_œq_§ve
(
æags
);

3969 
»t
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3970 
»t
 &ğ~
AD_IS_READY
;

3971 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 
»t
);

3972 
	`loÿl_œq_»¡Üe
(
æags
);

3974 
	}
}

3976 
	$tw5864_h264_’code_cÚŒŞ_g‘_ad_¡©us
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3978 
»t
 = 0, 
¡©us
;

3979 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

3980 
æags
;

3982 
	`loÿl_œq_§ve
(
æags
);

3983 
¡©us
 = 
	`©omic_»ad
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
);

3984 if((
¡©us
&
AD_IS_READY
)){

3985 
»t
 = 1;

3986 
¡©us
 &ğ~
AD_IS_READY
;

3988 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 
¡©us
);

3989 
	`loÿl_œq_»¡Üe
(
æags
);

3991  
»t
;

3992 
	}
}

3994 
	$tw5864_h264_’code_cÚŒŞ_fœ¡_¡¬t
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

3996 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

3997 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

3998 
dvm_ch_t
 *
ch
;

4000 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4001 
ma¡”_¦Ù
 = 
h264_logic_’code_chª
->master_slot;

4002 
ch
 = 
h264_logic_’code_chª
->chip;

4003 if((
ma¡”_¦Ù
!=
NULL
è&& (
ch
!=NULL)){

4004 
ma¡”_¦Ù
->
İ
->
	`¦Ù_fœ¡_¡¬t
(ma¡”_¦Ù, 
ch
);

4005 
h264_’code_cÚŒŞ
->
i_vd_»ã»nû_±r
 = 
ma¡”_¦Ù
->
vd_Üig_buf
.
vd_’code_±r
;

4007 
	}
}

4009 
	$tw5864_h264_’code_cÚŒŞ_¡¬t_’code
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4011 if((
h264_’code_cÚŒŞ
!=
NULL
)){

4012 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4013 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

4014 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

4015 
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
;

4016 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

4017 
dvm_ch_t
 *
ch
;

4018 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

4019 
tw_video_äame_tcb_t
 *
äame
;

4020 
tw_h264_’code_d–_t
 *
d–
;

4021 
’codeSize
, 
video_mode
 = 0;

4022 
tw_ed_fsm_t
 *
ed_fsm
;

4024 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4025 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

4026 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

4027 
’code_ã©u»
 = &
’code_´İ”ty
->encode_feature;

4028 
ma¡”_¦Ù
 = 
h264_logic_’code_chª
->master_slot;

4029 
ch
 = 
h264_logic_’code_chª
->chip;

4030 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

4032 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

4033 
ed_fsm
 = &
İ’ed_logic_chª_ed
->ed_fsm;

4034 if(
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsmè=ğ
TW_ED_STANDBY
){

4035 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

4036 
ma¡”_¦Ù
->
İ
->
	`£t_¦Ù_’code_±r
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

4037 
äame
->
time¡amp
 = 
ma¡”_¦Ù
->
İ
->
	`g‘_time¡amp
(master_slot);

4038 
äame
->
du¿tiÚ
 = 40;

4039 
äame
->
i_cu¼_qp
 = 
h264_’code_cÚŒŞ
->i_curr_qp;

4040 
äame
->
i_mb_x
 = 
h264_’code_cÚŒŞ
->i_mb_x;

4041 
äame
->
i_mb_y
 = 
h264_’code_cÚŒŞ
->i_mb_y;

4042 
äame
->
äame_numb”
 = 
h264_’code_cÚŒŞ
->
i_äame_£rŸl
;

4043 
äame
->
i_log_gİ_v®ue
 = 
h264_’code_cÚŒŞ
->
¥s
->
i_log2_max_äame_num
;

4044 
äame
->
ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

4046 if((
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 & (1<<h264_’code_cÚŒŞ->
i_äame_³r_£cÚd
))

4047 || (
äame
->
äame_ty³
==
H264_FRAME_TYPE_IDR
è|| (äame->äame_ty³==
H264_FRAME_TYPE_I
)){

4048 
h264_Çl_t
 *
Çl
 = &
äame
->nal;

4049 
£n_ty³
=0x4, 
mode_£Ëù
, 
mbd–ay
;

4050 
h—d_v®ue
;

4051 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
 = &
äame
->video_packet_queue;

4052 
tw_video_·ck‘_tcb_t
 *
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

4053 
__u8
 *
h—d_buf_±r
 = 
·ck‘
->
d©a
;

4055 
mode_£Ëù
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CIF_MAP_D1_MODE
);

4056 
ma¡”_¦Ù
->
İ
->
	`g‘_video_size
(master_slot)){

4057 
TW_VIDEO_SIZE_CIF
:

4058 if(
ch
->
video_’code_ÿp
->
ddr_m­_mode
 =ğ
DDR_MAP_COMPRESS_DISABLE
){

4059 
mode_£Ëù
 |= 0x40;

4063 
mode_£Ëù
 &= ~0x40;

4065 
video_mode
 = 0x00;

4067 
TW_VIDEO_SIZE_HALF_D1
:

4068 if(
ch
->
video_’code_ÿp
->
ddr_m­_mode
 =ğ
DDR_MAP_COMPRESS_DISABLE
){

4069 
mode_£Ëù
 |= 0x80;

4073 
mode_£Ëù
 &= ~0x80;

4075 
video_mode
 = 0x03;

4078 
TW_VIDEO_SIZE_D1
:

4079 
video_mode
 = 0x01;

4082 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CIF_MAP_D1_MODE
, 
mode_£Ëù
);

4084 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
FRAMERESOLUTION
, ((
h264_’code_cÚŒŞ
->
i_mb_x
<<8)|h264_’code_cÚŒŞ->
i_mb_y
));

4085 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
REFFRAMEINDEX
, ((
h264_’code_cÚŒŞ
->
i_vd_»ã»nû_±r
<<12)|((h264_encode_control->i_vd_reference_ptr+3)&3)));

4086 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MBADDR
, 
h264_’code_cÚŒŞ
->
i_fœ¡_mb_x_ªd_y
);

4088 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_PARAM
, ( (
MASK_HARDWARE_INSERT_03
|
ENABLE_VLC_FLOWCONTROL
|
ENABLE_INSERT_03
|
h264_’code_cÚŒŞ
->
i_cu¼_qp
) ));

4089 
äame
->
äame_Ën
){

4090 if(
äame
->
äame_Ën
 == 0){

4091 
	`´štk
("\n&&&&&&&&&&&&&&&&&&&&impossibË %d&&&&&&&&&&&&&&&&&&&&&&&\n", 
__LINE__
);

4094 
h—d_v®ue
 = *
h—d_buf_±r
;

4095 
h—d_v®ue
 <<= 8;

4096 
h—d_buf_±r
++;

4097 
äame
->
äame_Ën
--;

4098 if(
äame
->
äame_Ën
 == 0){

4099 
	`´štk
("\n&&&&&&&&&&&&&&&&&&&&impossibË %d&&&&&&&&&&&&&&&&&&&&&&&\n", 
__LINE__
);

4102 
h—d_v®ue
 |ğ*
h—d_buf_±r
;

4103 
h—d_v®ue
 <<= 16;

4104 
h—d_buf_±r
++;

4105 
äame
->
äame_Ën
--;

4106 
h—d_v®ue
 |= 0x8000;

4107 
h—d_v®ue
 |= (16<<8);

4108 #ifdeà
POWERPC_PCI_PLATFORM


4109 
h—d_v®ue
 |= 0x2;

4111 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 
h—d_v®ue
);

4114 if(
Çl
->
i_‹mp_b™®ign_numb”
){

4115 
h—d_v®ue
 = 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
;

4116 
h—d_v®ue
 >>ğ(16-
Çl
->
i_‹mp_b™®ign_numb”
);

4117 
h—d_v®ue
 <<= 16;

4118 
h—d_v®ue
 |= 0x8000;

4119 
h—d_v®ue
 |ğ(
Çl
->
i_‹mp_b™®ign_numb”
<<8);

4120 #ifdeà
POWERPC_PCI_PLATFORM


4121 
h—d_v®ue
 |= 0x2;

4123 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 
h—d_v®ue
);

4127 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_PARAM
, ( (
ENABLE_VLC_FLOWCONTROL
|
ENABLE_INSERT_03
|
h264_’code_cÚŒŞ
->
i_cu¼_qp
) ));

4128 
·ck‘
->
İ
->
	`dma_m­
Õack‘, 
DMA_FROM_DEVICE
);

4130 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
QP
, 
h264_’code_cÚŒŞ
->
i_cu¼_qp
);

4131 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
 = 
Lambda_lookup_bË
[h264_’code_cÚŒŞ->
i_cu¼_qp
];

4132 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
LAMDA
, 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
);

4133 
’codeSize
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize
(encode_property);

4134 
ma¡”_¦Ù
->
İ
->
	`g‘_video_size
(master_slot)){

4136 
TW_VIDEO_SIZE_D1
:

4137 
’codeSize
){

4138 
TW_VIDEO_SIZE_QCIF
:

4139 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4140 
£n_ty³
 = 0xa4;

4142 
£n_ty³
 = 0x1a4;

4145 
TW_VIDEO_SIZE_CIF
:

4146 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4147 
£n_ty³
 = 0x54;

4149 
£n_ty³
 = 0x154;

4152 
TW_VIDEO_SIZE_HALF_D1
:

4153 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4154 
£n_ty³
 = 0x44;

4156 
£n_ty³
 = 0x144;

4160 
TW_VIDEO_SIZE_D1
:

4161 if(
’code_ã©u»
->
İ
->
	`g‘_deš‹¾aû
(encode_feature)){

4162 
£n_ty³
 = 0x6;

4164 
£n_ty³
 = 0x4;

4169 
TW_VIDEO_SIZE_HALF_D1
:

4170 
’codeSize
) {

4172 
TW_VIDEO_SIZE_HALF_D1
:

4173 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4174 
£n_ty³
 = 0x04;

4176 
£n_ty³
 = 0x104;

4179 
TW_VIDEO_SIZE_D1
:

4180 
	`´štk
("%s.%d‚Øsu½pÜt\n", 
__FUNCTION__
, 
__LINE__
);

4182 
TW_VIDEO_SIZE_CIF
:

4183 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4184 
£n_ty³
 = 0x14;

4186 
£n_ty³
 = 0x114;

4189 
TW_VIDEO_SIZE_QCIF
:

4190 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4191 
£n_ty³
 = 0x64;

4193 
£n_ty³
 = 0x164;

4198 
TW_VIDEO_SIZE_CIF
:

4199 
’codeSize
){

4200 
TW_VIDEO_SIZE_QCIF
:

4201 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4202 
£n_ty³
 = 0x54;

4204 
£n_ty³
 = 0x154;

4207 
TW_VIDEO_SIZE_CIF
:

4208 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

4209 
£n_ty³
 = 0x04;

4211 
£n_ty³
 = 0x104;

4215 
TW_VIDEO_SIZE_D1
:

4216 
TW_VIDEO_SIZE_HALF_D1
:

4217 
	`´štk
("%s.%d‚Øsu½pÜt\n", 
__FUNCTION__
, 
__LINE__
);

4222 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERSTART
, 
£n_ty³
);

4223 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, ch->
video_’code_ÿp
->
’code_»g_4
 | (
video_mode
 << 6));

4225 
h264_’code_cÚŒŞ
->
äame_ty³
) {

4226 
H264_FRAME_TYPE_P
:

4227 
mode_£Ëù
 = 0xc;

4228 if(
’code_ã©u»
->
İ
->
	`g‘_sk
(encode_feature)) {

4229 
mode_£Ëù
 |= 0x30;

4231 
mode_£Ëù
 |= 0x40;

4233 if(
’code_ã©u»
->
İ
->
	`g‘_h®f_pix–
(encode_feature)){

4234 
mode_£Ëù
 |= 0x02;

4236 
mode_£Ëù
 &= 0xfd;

4238 if(
’code_ã©u»
->
İ
->
	`g‘_qu¬‹r_pix–
(encode_feature)) {

4239 
mode_£Ëù
 |= 0x03;

4241 
mode_£Ëù
 &= 0xfc;

4243 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

4246 
H264_FRAME_TYPE_IDR
:

4247 
H264_FRAME_TYPE_I
:

4248 if(
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)) {

4249 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MB4X4LAMDA
, 
IÁ¿4X4_Lambda3
[
h264_’code_cÚŒŞ
->
i_cu¼_qp
]);

4250 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0070);

4252 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

4254 
mode_£Ëù
 = 0x8;

4258 
mbd–ay
 = 
’code_ã©u»
->
İ
->
	`g‘_mb_d–ay
(encode_feature);

4259 if(
mbd–ay
 <= 240) {

4260 
mbd–ay
 >>= 4;

4261 
mbd–ay
 <<= 8;

4262 
mbd–ay
 |= (0 << 4);

4264 
mbd–ay
 >>= 7;

4265 
mbd–ay
 <<= 8;

4266 
mbd–ay
 |= (1 << 4);

4268 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_ID
, (
ma¡”_¦Ù
->
phy_¦Ù_id
| 
mbd–ay
 | 
DDR_B_CHIP
));

4269 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRANDMECONTROL
, 
mode_£Ëù
);

4271 if(
ch
->
»gi¡”_cu¼_h264_’code_chª
 !ğ
NULL
){

4272 
ch
->
	`»gi¡”_cu¼_h264_’code_chª
(ch, 
h264_logic_’code_chª
);

4275 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

4276 if(
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsmè=ğ
TW_ED_RUNNING
){

4277 
	`do_g‘timeofday
(&
d–
->
Ï¡_time
);

4278 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x8000);

4279 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x0000);

4280 
h264_’code_cÚŒŞ
->
	`add_’code_timeout_hook
(h264_encode_control);

4282 
ma¡”_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

4283 
video_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(video_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

4284 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4285 
	`´štk
("%s.%d, %d.%d, s‹ƒ¼ %d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

4288 
	`´štk
("%s.%d: soáw¬disÿrd f¿me\n", 
__FUNCTION__
, 
__LINE__
);

4289 
ma¡”_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

4290 
video_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(video_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

4292 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4295 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
++;

4296 if(
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 >ğh264_’code_cÚŒŞ->
i_üossbus_ås
){

4297 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

4300 
	`´štk
("\n%s.%d, s‹ i nÙ sndby, why?????, %d, %d--%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

4303 
	}
}

4305 
	$tw5864_h264_’code_cÚŒŞ_œq_func
(
œq
, *
cÚ‹xt
)

4307 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = (tw_h264_’code_cÚŒŞ_t*)
cÚ‹xt
;

4308 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4309 
dvm_ch_t
 *
ch
;

4310 
»t
=0, 
fÜû_esÿ³
=100;

4312 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4313 
ch
 = 
h264_logic_’code_chª
->chip;

4315 
fÜû_esÿ³
>0) {

4316 
fÜû_esÿ³
--;

4317 
h264_’code_cÚŒŞ
->
İ
->
	`»ad_vlc_·¿m
(h264_’code_cÚŒŞ, 
ch
);

4318 ià(!
h264_’code_cÚŒŞ
->
vlc_¡©us
)

4320 
h264_’code_cÚŒŞ
->
İ
->
	`ÿlcuÏ‹_mov_·¿m
(h264_’code_cÚŒŞ, 
ch
);

4321 
h264_’code_cÚŒŞ
->
İ
->
	`mov_vlc_codšg
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4322 
»t
 = 
h264_’code_cÚŒŞ
->
İ
->
	`ch_pšg_pÚg_upd©e
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4323 ià(
»t
==
VLC_STATUS_OVER
 ||„‘==
VLC_NO_PACKET_BUF
)

4326 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VLC_ENCODER_INTERRUPT
, (1<<
IRQ_VLC_TYPE_INTR
));

4328 if(
»t
 =ğ
VLC_STATUS_OVER
){

4333 
	}
}

4335 
	$tw5864_h264_’code_cÚŒŞ_»ad_vlc_·¿m
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

4337 
h264_’code_cÚŒŞ
->
vlc_¡©us
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
ENCODER_VLC_INTR_STATUS
);

4338 if(
h264_’code_cÚŒŞ
->
vlc_¡©us
&
VLC_OVERFLOW
) {

4339 
h264_’code_cÚŒŞ
->
ov”æow
++;

4340 
h264_’code_cÚŒŞ
->
vlc_¡©us
 &ğ~
VLC_OVERFLOW
;

4341 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_INTR_STATUS
, 
VLC_OVERFLOW
);

4343 
h264_’code_cÚŒŞ
->
vlc_¡©us
 &ğ
VLC_INTR_STATUS_MASK
;

4344 
	}
}

4346 
	$tw5864_h264_’code_cÚŒŞ_ÿlcuÏ‹_mov_·¿m
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

4348 
h264_’code_cÚŒŞ
->
vlc_¡©us
) {

4350 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 = 
VLC_ENCODER_DMA_LEN
;

4352 
VLC_END_SLICE
:

4353 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
ENCODER_VLC_INTR_STATUS
);

4354 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 >>ğ
FPGA_LEN_OFFSET
;

4355 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 &ğ
FPGA_LEN_OFFSET_MASK
;

4356 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 <<= 1;

4359 
	}
}

4361 
	$tw5864_h264_’code_cÚŒŞ_mov_vlc_codšg
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

4363 
tw_video_äame_tcb_t
 *
äame
;

4364 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

4365 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

4366 #ifdef 
USE_POLLING_DMA


4367 
dma_addr_t
 
¤c
, 
de¡
;

4369 
__u32
 
__iomem
 *
¤c
, *
de¡
;

4370 
i
, 
couÁ
;

4373 if(
h264_’code_cÚŒŞ
->
vlcIÁrL’
 == 0){

4376 
äame
 = 
h264_logic_’code_chª
->
’code_äame_queue
.
cu¼_´oduûr
;

4377 if(
äame
 !ğ
NULL
) {

4378 if(
äame
->
äame_is_”r
){

4381 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

4382 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

4383 ià(
·ck‘
 =ğ
NULL
) {

4384 
video_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(video_·ck‘_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

4385 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

4386 ià(
·ck‘
 =ğ
NULL
) {

4387 
äame
->
äame_is_”r
 = 1;

4390 
·ck‘
->
İ
->
	`dma_m­
Õack‘, 
DMA_FROM_DEVICE
);

4393 if(
ch
->
vlc_pšg_pÚg_šdex
){

4394 #ifdef 
USE_POLLING_DMA


4395 #ifdeà
UPM_SYNC_MODE


4396 
¤c
 = 
ch
->
·_sync_»gs
 + 
VLC_ENCODER_PONG
;

4398 
¤c
 = 
ch
->
·_»gs
 + 
VLC_ENCODER_PONG
;

4400 
de¡
 = 
·ck‘
->
dma_addr
;

4401 
	`åga_dma_»ûive
((
u32
)
¤c
, (u32)
de¡
, 
h264_’code_cÚŒŞ
->
vlcIÁrL’
);

4403 #ifdeà
UPM_SYNC_MODE


4404 
¤c
 = (
__u32
 
__iomem
 *)(
ch
->
sync_»gs
 + 
VLC_ENCODER_PONG
);

4406 
¤c
 = (
__u32
 
__iomem
 *)(
ch
->
»gs
 + 
VLC_ENCODER_PONG
);

4408 
de¡
 = (
__u32
 
__iomem
 *)
·ck‘
->
d©a
;

4409 
couÁ
 = (
h264_’code_cÚŒŞ
->
vlcIÁrL’
+3)>>2;

4410 
i
=0; i<
couÁ
; i++){

4411 *
de¡
++ = *
¤c
++;

4415 #ifdef 
USE_POLLING_DMA


4416 #ifdeà
UPM_SYNC_MODE


4417 
¤c
 = 
ch
->
·_sync_»gs
 + 
VLC_ENCODER_PING
;

4419 
¤c
 = 
ch
->
·_»gs
 + 
VLC_ENCODER_PING
;

4421 
de¡
 = 
·ck‘
->
dma_addr
;

4422 
	`åga_dma_»ûive
((
u32
)
¤c
, (u32)
de¡
, 
h264_’code_cÚŒŞ
->
vlcIÁrL’
);

4424 #ifdeà
UPM_SYNC_MODE


4425 
¤c
 = (
__u32
 
__iomem
 *)(
ch
->
sync_»gs
 + 
VLC_ENCODER_PING
);

4427 
¤c
 = (
__u32
 
__iomem
 *)(
ch
->
»gs
 + 
VLC_ENCODER_PING
);

4429 
de¡
 = (
__u32
 
__iomem
 *)
·ck‘
->
d©a
;

4430 
couÁ
 = (
h264_’code_cÚŒŞ
->
vlcIÁrL’
+3)>>2;

4431 
i
=0; i<
couÁ
; i++){

4432 *
de¡
++ = *
¤c
++;

4436 
·ck‘
->
·ylßd_Ën
 = 
h264_’code_cÚŒŞ
->
vlcIÁrL’
;

4437 
äame
->
äame_Ën
 +ğ
h264_’code_cÚŒŞ
->
vlcIÁrL’
;

4439 
	}
}

4441 
	$tw5864_h264_’code_cÚŒŞ_ch_pšg_pÚg_upd©e
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

4443 
tw_video_äame_tcb_t
 *
äame
;

4444 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

4445 
tw_video_·ck‘_tcb_t
 *
·ck‘
 = 
NULL
;

4447 
äame
 = 
h264_logic_’code_chª
->
’code_äame_queue
.
cu¼_´oduûr
;

4448 ià(
äame
 !ğ
NULL
) {

4449 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

4450 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

4451 if(
·ck‘
 !ğ
NULL
){

4452 
·ck‘
->
İ
->
	`dma_unm­
Õack‘, 
DMA_FROM_DEVICE
);

4453 
video_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_packet_queue);

4455 
äame
->
äame_is_”r
 = 1;

4459 
h264_’code_cÚŒŞ
->
vlc_¡©us
){

4461 
h264_’code_cÚŒŞ
->
vlc_¡©us
 &ğ~(1<<
ch
->
vlc_pšg_pÚg_šdex
);

4462 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_INTR_STATUS
, (1<<ch->
vlc_pšg_pÚg_šdex
));

4463 
ch
->
vlc_pšg_pÚg_šdex
++;

4464 
ch
->
vlc_pšg_pÚg_šdex
 &= 1;

4467 
	`´štk
("%d: vløšŒ stu i nuÎ\n", 
h264_logic_’code_chª
->
phy_¦Ù_id
);

4469 
VLC_END_SLICE
:

4470 if((
äame
!=
NULL
è&& (
·ck‘
!=NULL)){

4471 ià(
h264_’code_cÚŒŞ
->
vlcIÁrL’
&3) {

4472 
u32
 *
buf
;

4473 
buf
 = (
u32
*)&
·ck‘
->
d©a
[Õack‘->
·ylßd_Ën
&0xfffffffc)];

4474 #ifdeà 
ARM_PLATFORM


4475 *
buf
 &= 0x0000ffff;

4477 #ifdeà 
POWERPC_PLATFORM


4478 *
buf
 &= 0xffff0000;

4482 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4483  
VLC_STATUS_OVER
;

4486 ià(
h264_’code_cÚŒŞ
->
vlc_¡©us
)

4487  
VLC_STATUS_NEED_PROCESS
;

4489  
VLC_STATUS_NULL
;

4490 
	}
}

4492 
	$tw5864_h264_’code_cÚŒŞ_nÙify
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

4494 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

4495 
tw_video_äame_tcb_t
 *
äame
;

4496 
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
;

4497 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

4498 
tw_h264_’code_d–_t
 *
d–
;

4499 
u32
 
v®
;

4501 
h264_’code_cÚŒŞ
->
	`d–‘e_’code_timeout_hook
(h264_encode_control);

4502 
h264_’code_cÚŒŞ
->
vlc_¡©us
 = 0;

4503 
h264_logic_’code_chª
->
rc_driv”
.
rc_İ
->
	`upd©e_rc
(h264_logic_encode_chan);

4504 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_INTR_STATUS
, 
VLC_INTR_MASK_ALL
);

4505 if(
h264_logic_’code_chª
->
ma¡”_¦Ù
 !ğ
NULL
){

4506 
h264_logic_’code_chª
->
ma¡”_¦Ù
->
İ
->
	`’code_’dof¦iû_nÙify
(h264_logic_encode_chan->master_slot, h264_logic_encode_chan);

4509 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

4510 
	`do_g‘timeofday
(&
d–
->
cu¼_time
);

4511 
v®
 = 
	`timev®_to_ns
(&
d–
->
cu¼_time
è-imev®_to_ns(&d–->
Ï¡_time
);

4512 
v®
 = val / 1000;

4513 if(
d–
->
max_d–
 == 0) {

4514 
d–
->
max_d–
 = 
v®
;

4516 if(
d–
->
mš_d–
 == 0) {

4517 
d–
->
mš_d–
 = 
v®
;

4519 if(
d–
->
max_d–
 < 
v®
) {

4520 
d–
->
max_d–
 = 
v®
;

4522 if(
d–
->
mš_d–
 > 
v®
) {

4523 
d–
->
mš_d–
 = 
v®
;

4525 
d–
->
cur_d–
 = 
v®
;

4527 
’code_äame_queue
 = &
h264_logic_’code_chª
->encode_frame_queue;

4528 
äame
 = 
’code_äame_queue
->
cu¼_´oduûr
;

4529 if(
äame
 !ğ
NULL
){

4530 
ch
->
	`uÄegi¡”_cu¼_h264_’code_chª
(ch, 
h264_logic_’code_chª
);

4531 if(
h264_’code_cÚŒŞ
->
ov”æow
){

4532 
h264_’code_cÚŒŞ
->
ov”æow
 = 0;

4533 
	`´štk
("\n\n%d ov”æow %d\n\n", 
h264_logic_’code_chª
->
phy_¦Ù_id
, 
h264_’code_cÚŒŞ
->
ov”æow
);

4535 if(
äame
->
äame_is_”r
 == 0){

4536 
h264_Çl_t
 *
Çl
;

4538 
Çl
 = &
äame
->nal;

4539 
äame
->
äame_Ën
 -ğ(
Çl
->
¥s_·ysize
 +‚®->
µs_·ysize
);

4540 #ifdeà 
ADD_DVM_NAL_HEAD


4542 
h264_Çl_b™¡»am_t
 *
h264_Çl_¦iû_h—d
;

4543 
DVM_NAL_HEAD
 *
Çl_¦iû_h—d
;

4544 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

4545 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

4546 
æags
;

4547 
»t
;

4549 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

4550 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

4551 
video_·ck‘_queue
->
İ
->
	`Œy_g‘
(video_·ck‘_queue, &
·ck‘
);

4552 if(
·ck‘
 !ğ
NULL
){

4553 
h264_Çl_¦iû_h—d
 = (
h264_Çl_b™¡»am_t
*)&
·ck‘
->
d©a
[
Çl
->
¥s_·ysize
 +‚®->
µs_·ysize
];

4554 
Çl_¦iû_h—d
 = &
h264_Çl_¦iû_h—d
->
h—d
;

4555 
»t
 = 
äame
->
äame_Ën
 - (
DVM_NAL_HEAD
);

4556 
Çl_¦iû_h—d
->
i_Çl_size_0_7
 = (
»t
&0xff);

4557 
Çl_¦iû_h—d
->
i_Çl_size_8_15
 = ((
»t
>>8)&0xff);

4558 
Çl_¦iû_h—d
->
i_Çl_size_16_23
 = ((
»t
>>16)&0xff);

4560 
video_·ck‘_queue
->
İ
->
	`put_h—d”
(video_·ck‘_queue, 
·ck‘
);

4561 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

4565 
h264_’code_cÚŒŞ
->
i_åm
++;

4566 
’code_äame_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(encode_frame_queue);

4567 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_ok
(h264_encode_control);

4569 
’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
Óncode_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

4570 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_”r
(h264_encode_control);

4571 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

4574 
	`´štk
("%d:chª_%d_%d disÿrd\n", 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

4575 
h264_logic_’code_chª
->
rc_driv”
.
rc_İ
->
	`jump_rc
(h264_logic_encode_chan);

4576 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_”r
(h264_encode_control);

4579 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

4580 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

4581 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

4582 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

4584 
ch_’code_£rviû_queue
 = &
ch
->chip_encode_service_queue;

4585 
ch_’code_£rviû_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(chip_encode_service_queue);

4586 
ch_’code_£rviû_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(chip_encode_service_queue);

4589 
	}
}

4591 
	$tw5864_h264_’code_cÚŒŞ_’code_´oûssšg_timeout
(*
cÚ‹xt
)

4593 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = (tw_h264_’code_cÚŒŞ_t*)
cÚ‹xt
;

4594 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4595 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

4596 
dvm_ch_t
 *
ch
;

4597 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

4599 
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
 = 
INVALIDTIMERID
;

4600 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4601 
ch
 = 
h264_logic_’code_chª
->chip;

4602 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

4603 
’code_äame_queue
 = &
h264_logic_’code_chª
->encode_frame_queue;

4604 
’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
Óncode_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

4605 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_”r
(h264_encode_control);

4606 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

4607 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

4610 
	`´štk
("%s.%d:¡©e=%d %d, %x=%x\n", 
__FUNCTION__
, 
__LINE__
, 
İ’ed_logic_chª_ed
->
İ
->
	`g‘_¡©e
(İ’ed_logic_chª_ed), 
h264_logic_’code_chª
->
logic_chª_id
, 
INTERRUPT_STATUS_REG_L
, 
ch
->
io_İ
->
	`ch_»ad32
(chip, INTERRUPT_STATUS_REG_L));

4612 
	}
}

4614 
	$tw5864_h264_’code_cÚŒŞ_´•¬e_’code_»sourû_timeout
(*
cÚ‹xt
)

4616 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

4618 
	}
}

4620 
	$tw5864_h264_’code_d–ay_»¡¬t
(*
cÚ‹xt
)

4622 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = (tw_h264_’code_cÚŒŞ_t*)
cÚ‹xt
;

4623 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4625 
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
 = 
INVALIDTIMERID
;

4626 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4627 
	`h264_logic_’code_chª_d–ay_»¡¬t_’code
(
h264_logic_’code_chª
);

4629 
	}
}

4631 
	$’code_chª_add_’code_timeout_hook
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4633 
h264_’code_cÚŒŞ
->
	`d–‘e_’code_timeout_hook
(h264_encode_control);

4634 
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
 = 
	`AddSšgËFœeTim”Job
(
ENCODE_CHAN_TIMEOUT
, 
tw5864_h264_’code_cÚŒŞ_’code_´oûssšg_timeout
, h264_encode_control);

4635 if(
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
 =ğ
ADDJOBERROR
){

4636 
	`´štk
("%s.%d:‡ddim” hookƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

4638 
	}
}

4640 
	$’code_chª_d–‘e_’code_timeout_hook
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4642 
	`D–‘eSšgËFœeTim”Job
(
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
);

4643 
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
 = 
INVALIDTIMERID
;

4644 
	}
}

4646 
	$’code_chª_add_d–ay_»¡¬t_’code_hook
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4648 
h264_’code_cÚŒŞ
->
	`d–‘e_d–ay_»¡¬t_’code_hook
(h264_encode_control);

4649 
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
 = 
	`AddSšgËFœeTim”Job
(
DELAY_COUNT
, 
tw5864_h264_’code_d–ay_»¡¬t
, h264_encode_control);

4650 if(
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
 =ğ
ADDJOBERROR
){

4651 
	`´štk
("%s.%d:‡ddim” hookƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

4653 
	}
}

4655 
	$’code_chª_d–‘e_d–ay_»¡¬t_’code_hook
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4657 
	`D–‘eSšgËFœeTim”Job
(
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
);

4658 
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
 = 
INVALIDTIMERID
;

4659 
	}
}

4661 
	$tw5864_h264_’code_cÚŒŞ_š™
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4663 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4664 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

4665 
tw_h264_’code_d–_t
 *
d–
;

4666 
couÁ
;

4667 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

4668 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

4670 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4671 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

4672 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 0);

4673 
h264_’code_cÚŒŞ
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

4674 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

4675 
phy_video_¦Ù
 = 
h264_logic_’code_chª
->
ma¡”_¦Ù
;

4676 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

4678 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

4679 
h264_’code_cÚŒŞ
->
i_äame_£rŸl
 = 0;

4680 
h264_’code_cÚŒŞ
->
i_äameNumb”
 = 0;

4681 
h264_’code_cÚŒŞ
->
i_¦iû_äame_num
 = 0;

4682 
h264_’code_cÚŒŞ
->
i_üossbus_ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

4683 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

4684 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

4685 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

4686 
h264_’code_cÚŒŞ
->
i_Œigg”_sync_couÁ”
 = 0;

4687 
h264_’code_cÚŒŞ
->
i_¡©i¡ic_mšu‹r_couÁ”
 = 0;

4688 
h264_’code_cÚŒŞ
->
ad_check
 = 0;

4689 
h264_’code_cÚŒŞ
->
ad_d–1
 = 0;

4690 
h264_’code_cÚŒŞ
->
ad_d–2
 = 0;

4691 
h264_’code_cÚŒŞ
->
ad_d–3
 = 0;

4692 
h264_’code_cÚŒŞ
->
Ï¡_jiff›s
 = 0;

4693 
h264_’code_cÚŒŞ
->
i_cu¼_ås
 = 0;

4694 
h264_’code_cÚŒŞ
->
i_Şd_ås
 = 0;

4695 
h264_’code_cÚŒŞ
->
i_åm
 = 0;

4696 
h264_’code_cÚŒŞ
->
i_ås
 = 0;

4697 
h264_’code_cÚŒŞ
->
ad_»ady
 = 0;

4698 
h264_’code_cÚŒŞ
->
i_Ï¡_idr
 = -
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

4699 
h264_’code_cÚŒŞ
->
i_idr_pic_id
 = 0;

4700 
h264_’code_cÚŒŞ
->
i_cu¼_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

4701 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
 = 
Lambda_lookup_bË
[h264_’code_cÚŒŞ->
i_cu¼_qp
];

4702 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_image_»sŞutiÚ
(h264_encode_control);

4704 
couÁ
 = 
h264_’code_cÚŒŞ
->
i_üossbus_ås
;

4705 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

4706 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 0;

4708 
couÁ
>0){

4709 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 |= 1;

4710 if(
couÁ
 > 1){

4711 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 <<= 1;

4713 
couÁ
--;

4716 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_ås_disÿrd_bË
(h264_’code_cÚŒŞ, h264_’code_cÚŒŞ->
i_üossbus_ås
,

4717 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property));

4720 
h264_’code_cÚŒŞ
->
¥s
 = h264_’code_cÚŒŞ->
¥s_¬¿y
;

4721 
h264_’code_cÚŒŞ
->
µs
 = h264_’code_cÚŒŞ->
µs_¬¿y
;

4722 
h264_’code_cÚŒŞ
->
¦iû_h—d
 = h264_’code_cÚŒŞ->
¦iû_h—d_¬¿y
;

4723 
h264_’code_cÚŒŞ
->
İ
->
	`£t_¥s
(h264_encode_control);

4724 
h264_’code_cÚŒŞ
->
İ
->
	`£t_µs
(h264_encode_control);

4725 
h264_’code_cÚŒŞ
->
İ
->
	`£t_¦iû_h—d
(h264_encode_control);

4727 
h264_’code_cÚŒŞ
->
ov”æow
 = 0;

4728 
h264_’code_cÚŒŞ
->
vlc_¡©us
 = 0;

4729 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 = 0;

4731 
d–
->
max_d–
 = 0;

4732 
d–
->
mš_d–
 = 0;

4733 
	`mem£t
(&
d–
->
cu¼_time
, 0, (
timev®
));

4734 
	`mem£t
(&
d–
->
Ï¡_time
, 0, (
timev®
));

4735 
h264_’code_cÚŒŞ
->
’code_timeout_mÚ™Ü_timeid
 = 
INVALIDTIMERID
;

4736 
h264_’code_cÚŒŞ
->
add_’code_timeout_hook
 = 
’code_chª_add_’code_timeout_hook
;

4737 
h264_’code_cÚŒŞ
->
d–‘e_’code_timeout_hook
 = 
’code_chª_d–‘e_’code_timeout_hook
;

4739 
h264_’code_cÚŒŞ
->
d–ay_»¡¬t_’code_timeid
 = 
INVALIDTIMERID
;

4740 
h264_’code_cÚŒŞ
->
add_d–ay_»¡¬t_’code_hook
 = 
’code_chª_add_d–ay_»¡¬t_’code_hook
;

4741 
h264_’code_cÚŒŞ
->
d–‘e_d–ay_»¡¬t_’code_hook
 = 
’code_chª_d–‘e_d–ay_»¡¬t_’code_hook
;

4742 
	}
}

4744 
	$tw5864_h264_’code_cÚŒŞ_»£t
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4746 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4747 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

4748 
tw_h264_’code_d–_t
 *
d–
;

4749 
couÁ
;

4750 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

4751 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

4753 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4754 
	`TW_DBG
(
TW_DBG_DEBUG
, "»£ˆchªÃÈ%d\n", 
h264_logic_’code_chª
->
logic_chª_id
);

4755 
	`©omic_£t
(&
h264_logic_’code_chª
->
İ’ed_æag
, 0);

4756 
	`©omic_£t
(&
h264_logic_’code_chª
->
have_d–iv”_sync_æag
, 0);

4757 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

4758 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

4759 
	`©omic_£t
(&
h264_’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
, 0);

4760 
phy_video_¦Ù
 = 
h264_logic_’code_chª
->
ma¡”_¦Ù
;

4761 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

4763 
h264_’code_cÚŒŞ
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

4764 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

4765 
h264_’code_cÚŒŞ
->
i_äameNumb”
 = 0;

4766 
h264_’code_cÚŒŞ
->
i_äame_£rŸl
 = 0;

4767 
h264_’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

4768 
h264_’code_cÚŒŞ
->
i_¦iû_äame_num
 = 0;

4769 
h264_’code_cÚŒŞ
->
i_üossbus_ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

4770 
h264_’code_cÚŒŞ
->
i_p_¡ride
 = 0;

4771 
h264_’code_cÚŒŞ
->
i_Œigg”_sync_couÁ”
 = 0;

4772 
h264_’code_cÚŒŞ
->
i_¡©i¡ic_mšu‹r_couÁ”
 = 0;

4773 
h264_’code_cÚŒŞ
->
ad_check
 = 0;

4774 
h264_’code_cÚŒŞ
->
ad_d–1
 = 0;

4775 
h264_’code_cÚŒŞ
->
ad_d–2
 = 0;

4776 
h264_’code_cÚŒŞ
->
ad_d–3
 = 0;

4777 
h264_’code_cÚŒŞ
->
Ï¡_jiff›s
 = 0;

4778 
h264_’code_cÚŒŞ
->
i_cu¼_ås
 = 0;

4779 
h264_’code_cÚŒŞ
->
i_Şd_ås
 = 0;

4780 
h264_’code_cÚŒŞ
->
i_åm
 = 0;

4781 
h264_’code_cÚŒŞ
->
i_ås
 = 0;

4782 
h264_’code_cÚŒŞ
->
ad_»ady
 = 0;

4783 
h264_’code_cÚŒŞ
->
i_Ï¡_idr
 = -
’code_´İ”ty
->
İ
->
	`g‘_keyF¿meIÁ”v®s
(encode_property);

4784 
h264_’code_cÚŒŞ
->
i_idr_pic_id
 = 0;

4785 
h264_’code_cÚŒŞ
->
i_cu¼_qp
 = 
’code_´İ”ty
->
İ
->
	`g‘_qpi
(encode_property);

4786 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
 = 
Lambda_lookup_bË
[h264_’code_cÚŒŞ->
i_cu¼_qp
];

4788 
couÁ
 = 
h264_’code_cÚŒŞ
->
i_üossbus_ås
;

4789 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

4790 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 = 0;

4792 
couÁ
>0){

4793 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 |= 1;

4794 if(
couÁ
 > 1){

4795 
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 <<= 1;

4797 
couÁ
--;

4800 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_ås_disÿrd_bË
(h264_’code_cÚŒŞ, h264_’code_cÚŒŞ->
i_üossbus_ås
,

4801 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property));

4803 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_image_»sŞutiÚ
(h264_encode_control);

4804 
h264_’code_cÚŒŞ
->
ov”æow
 = 0;

4805 
h264_’code_cÚŒŞ
->
vlc_¡©us
 = 0;

4806 
h264_’code_cÚŒŞ
->
vlcIÁrL’
 = 0;

4807 
d–
->
max_d–
 = 0;

4808 
d–
->
mš_d–
 = 0;

4809 
	`mem£t
(&
d–
->
cu¼_time
, 0, (
timev®
));

4810 
	`mem£t
(&
d–
->
Ï¡_time
, 0, (
timev®
));

4811 
h264_’code_cÚŒŞ
->
	`d–‘e_’code_timeout_hook
(h264_encode_control);

4812 
	}
}

4814 
	$tw5864_h264_’code_cÚŒŞ_chª_ÿn_com¶‘e
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4816 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

4817 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4818 
ed_tcb_t
 *
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

4819 if(
İ’ed_logic_chª_ed
->
ed
.
İ
 !ğ
NULL
){

4820 
	`©omic_£t
(&
İ’ed_logic_chª_ed
->
¡©e
, 
TW_ED_CLOSED
);

4821 
İ’ed_logic_chª_ed
->
ed
.
İ
->
	`com¶‘e_dÚe
(&opened_logic_chan_ed->ed);

4822 
	`´štk
("\n****chª_%d_%d: com¶‘e_dÚe, %d*****\n", 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
__LINE__
);

4825 
	}
}

4827 
tw_h264_’code_cÚŒŞ_İ”©iÚ
 
	gtw5864_h264_’code_cÚŒŞ_İ
 = {

4828 .
š™
 = 
tw5864_h264_’code_cÚŒŞ_š™
,

4829 .
	g»£t
 = 
tw5864_h264_’code_cÚŒŞ_»£t
,

4831 .
	g£t_¥s
 = 
tw5864_h264_’code_cÚŒŞ_£t_¥s
,

4832 .
	g£t_µs
 = 
tw5864_h264_’code_cÚŒŞ_£t_µs
,

4833 .
	g£t_¦iû_h—d
 = 
tw5864_h264_’code_cÚŒŞ_£t_¦iû_h—d
,

4834 .
	gg’”©Ü_h—d
 = 
tw5864_h264_’code_cÚŒŞ_g’”©Ü_h—d
,

4836 .
	gÿlcuÏ‹_äame_ty³
 = 
tw5864_h264_’code_cÚŒŞ_ÿlcuÏ‹_äame_ty³
,

4837 .
	gg‘_äame_ty³
 = 
tw5864_h264_’code_cÚŒŞ_g‘_äame_ty³
,

4838 .
	gfÜû_I_äame
 = 
tw5864_h264_’code_cÚŒŞ_fÜû_I_äame
,

4839 .
	gupd©e_©_’code_äame_ok
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_ok
,

4840 .
	gupd©e_©_disÿrd_äame
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_disÿrd_äame
,

4841 .
	gupd©e_©_’code_äame_”r
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_”r
,

4842 .
	gupd©e_image_»sŞutiÚ
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_image_»sŞutiÚ
,

4843 .
	gupd©e_ås_disÿrd_bË
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_ås_disÿrd_bË
,

4845 .
	gg‘_¦iû_h—d_ªd_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_g‘_¦iû_h—d_ªd_ad_¡©us
,

4846 .
	gş—r_¦iû_h—d_ªd_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_ªd_ad_¡©us
,

4847 .
	gupd©e_¦iû_h—d_»ady
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_¦iû_h—d_»ady
,

4848 .
	gş—r_¦iû_h—d_»ady
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_»ady
,

4849 .
	gupd©e_ad_»ady
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_ad_»ady
,

4850 .
	gş—r_ad_»ady
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_ad_»ady
,

4851 .
	gg‘_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_g‘_ad_¡©us
,

4853 .
	gfœ¡_¡¬t
 = 
tw5864_h264_’code_cÚŒŞ_fœ¡_¡¬t
,

4854 .
	g¡¬t_’code
 = 
tw5864_h264_’code_cÚŒŞ_¡¬t_’code
,

4856 .
	gœq_func
 = 
tw5864_h264_’code_cÚŒŞ_œq_func
,

4857 .
	g»ad_vlc_·¿m
 = 
tw5864_h264_’code_cÚŒŞ_»ad_vlc_·¿m
,

4858 .
	gÿlcuÏ‹_mov_·¿m
 = 
tw5864_h264_’code_cÚŒŞ_ÿlcuÏ‹_mov_·¿m
,

4859 .
	gmov_vlc_codšg
 = 
tw5864_h264_’code_cÚŒŞ_mov_vlc_codšg
,

4860 .
	gch_pšg_pÚg_upd©e
 = 
tw5864_h264_’code_cÚŒŞ_ch_pšg_pÚg_upd©e
,

4861 .
	gnÙify
 = 
tw5864_h264_’code_cÚŒŞ_nÙify
,

4863 .
	gchª_ÿn_com¶‘e
 = 
tw5864_h264_’code_cÚŒŞ_chª_ÿn_com¶‘e
,

4866 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_¡¬t_’code
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

4868 if((
h264_’code_cÚŒŞ
!=
NULL
)){

4869 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

4870 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

4871 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

4872 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

4873 
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
;

4874 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

4875 
dvm_ch_t
 *
ch
;

4876 
ch_driv”_t
 *
ch_driv”
;

4877 
tw_video_bus_t
 *
video_bus
;

4878 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

4879 
tw_video_äame_tcb_t
 *
äame
;

4880 
tw_h264_’code_d–_t
 *
d–
;

4881 
’codeSize
,
video_mode
 = 0;

4882 
nÜm
;

4883 
tw_ed_fsm_t
 *
ed_fsm
;

4885 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

4886 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

4887 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

4888 
’code_ã©u»
 = &
’code_´İ”ty
->encode_feature;

4889 
ma¡”_¦Ù
 = 
h264_logic_’code_chª
->master_slot;

4890 
ch
 = 
h264_logic_’code_chª
->chip;

4891 
ch_driv”
 = 
ch
->chip_driver;

4892 
video_bus
 = &
ch_driv”
->video_bus;

4893 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

4894 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

4895 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

4897 
nÜm
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

4898 
ed_fsm
 = &
İ’ed_logic_chª_ed
->ed_fsm;

4899 if(
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsmè=ğ
TW_ED_STANDBY
){

4900 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

4901 
ma¡”_¦Ù
->
İ
->
	`£t_¦Ù_’code_±r
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

4902 
äame
->
time¡amp
 = 
ma¡”_¦Ù
->
İ
->
	`g‘_time¡amp
(master_slot);

4903 
äame
->
du¿tiÚ
 = 40;

4904 
äame
->
i_cu¼_qp
 = 
h264_’code_cÚŒŞ
->i_curr_qp;

4905 
äame
->
i_mb_x
 = 
h264_’code_cÚŒŞ
->i_mb_x;

4906 
äame
->
i_mb_y
 = 
h264_’code_cÚŒŞ
->i_mb_y;

4907 
äame
->
äame_numb”
 = 
h264_’code_cÚŒŞ
->
i_äame_£rŸl
;

4908 
äame
->
i_log_gİ_v®ue
 = 
h264_’code_cÚŒŞ
->
¥s
->
i_log2_max_äame_num
;

4909 
äame
->
ås
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

4911 if((
h264_’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
 & (1<<h264_’code_cÚŒŞ->
i_äame_³r_£cÚd
))

4912 || (
äame
->
äame_ty³
==
H264_FRAME_TYPE_IDR
è|| (äame->äame_ty³==
H264_FRAME_TYPE_I
)){

4913 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_h264_’code_£rviû_»q
(ch_d´am_cÚŒŞËr, &
h264_logic_’code_chª
->
video_b™¡»am_buf
)){

4914 
h264_Çl_t
 *
Çl
 = &
äame
->nal;

4915 
£n_ty³
=0x4, 
mode_£Ëù
,
mbd–ay
;

4916 
h—d_v®ue
;

4917 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
 = &
äame
->video_packet_queue;

4918 
tw_video_·ck‘_tcb_t
 *
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

4919 
__u8
 *
h—d_buf_±r
 = 
·ck‘
->
d©a
;

4920 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
FRAMERESOLUTION
, ((
h264_’code_cÚŒŞ
->
i_mb_x
<<8)|h264_’code_cÚŒŞ->
i_mb_y
));

4921 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
REFFRAMEINDEX
, ((
h264_’code_cÚŒŞ
->
i_vd_»ã»nû_±r
<<12)|((h264_encode_control->i_vd_reference_ptr+3)&3)));

4922 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MBADDR
, 
h264_’code_cÚŒŞ
->
i_fœ¡_mb_x_ªd_y
);

4924 
mode_£Ëù
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
CIF_MAP_D1_MODE
);

4925 
mode_£Ëù
 &= 0xfffffc0;

4926 
mode_£Ëù
 |= 0x100;

4927 
mode_£Ëù
 |ğ(((
h264_logic_’code_chª
->
video_b™¡»am_buf
->
İ
->
	`g‘_buf_id
(h264_logic_encode_chan->video_bitstream_buf))&0x7)<<2);

4928 
ma¡”_¦Ù
->
İ
->
	`g‘_video_size
(master_slot)){

4929 
TW_VIDEO_SIZE_CIF
:

4930 if(
ch
->
video_’code_ÿp
->
ddr_m­_mode
 =ğ
DDR_MAP_COMPRESS_DISABLE
){

4931 
mode_£Ëù
 |= 0x40;

4935 
mode_£Ëù
 &= ~0x40;

4937 
video_mode
 = 0x00;

4939 
TW_VIDEO_SIZE_HALF_D1
:

4940 if(
ch
->
video_’code_ÿp
->
ddr_m­_mode
 =ğ
DDR_MAP_COMPRESS_DISABLE
){

4941 
mode_£Ëù
 |= 0x80;

4945 
mode_£Ëù
 &= ~0x80;

4947 
video_mode
 = 0x03;

4950 
TW_VIDEO_SIZE_D1
:

4951 
video_mode
 = 0x01;

4954 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CIF_MAP_D1_MODE
, 
mode_£Ëù
);

4955 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CDC_VLCS_MASTER_REG
, 
ENABLE_VLC_BITSTREAM_SEND_DDR
);

4956 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_PARAM
, ( (
MASK_HARDWARE_INSERT_03
|
ENABLE_VLC_FLOWCONTROL
|
ENABLE_CDC_VLCS_MAST_R
|
ENABLE_INSERT_03
|
h264_’code_cÚŒŞ
->
i_cu¼_qp
) ));

4958 
äame
->
äame_Ën
){

4959 if(
äame
->
äame_Ën
 == 0){

4960 
	`´štk
("\n&&&&&&&&&&&&&&&&&&&&impossibË %d&&&&&&&&&&&&&&&&&&&&&&&\n", 
__LINE__
);

4963 
h—d_v®ue
 = *
h—d_buf_±r
;

4964 
h—d_v®ue
 <<= 8;

4965 
h—d_buf_±r
++;

4966 
äame
->
äame_Ën
--;

4967 if(
äame
->
äame_Ën
 == 0){

4968 
	`´štk
("\n&&&&&&&&&&&&&&&&&&&&impossibË %d&&&&&&&&&&&&&&&&&&&&&&&\n", 
__LINE__
);

4971 
h—d_v®ue
 |ğ*
h—d_buf_±r
;

4972 
h—d_v®ue
 <<= 16;

4973 
h—d_buf_±r
++;

4974 
äame
->
äame_Ën
--;

4975 
h—d_v®ue
 |= 0x8000;

4976 
h—d_v®ue
 |= (16<<8);

4977 #ifdeà
POWERPC_PCI_PLATFORM


4978 
h—d_v®ue
 |= 0x2;

4980 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 
h—d_v®ue
);

4983 if(
Çl
->
i_‹mp_b™®ign_numb”
){

4984 
h—d_v®ue
 = 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
;

4985 
h—d_v®ue
 >>ğ(16-
Çl
->
i_‹mp_b™®ign_numb”
);

4986 
h—d_v®ue
 <<= 16;

4987 
h—d_v®ue
 |= 0x8000;

4988 
h—d_v®ue
 |ğ(
Çl
->
i_‹mp_b™®ign_numb”
<<8);

4989 #ifdeà
POWERPC_PCI_PLATFORM


4990 
h—d_v®ue
 |= 0x2;

4992 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENABLE_VLC_LOOKUP_TABLE
, 
h—d_v®ue
);

4995 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_PARAM
, ( (
ENABLE_VLC_FLOWCONTROL
|
ENABLE_CDC_VLCS_MAST_R
|
ENABLE_INSERT_03
|
h264_’code_cÚŒŞ
->
i_cu¼_qp
) ));

4997 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
QP
, 
h264_’code_cÚŒŞ
->
i_cu¼_qp
);

4998 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
 = 
Lambda_lookup_bË
[h264_’code_cÚŒŞ->
i_cu¼_qp
];

4999 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
LAMDA
, 
h264_’code_cÚŒŞ
->
i_cu¼_Ïmda
);

5001 if(
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)) {

5002 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MB4X4LAMDA
, 
IÁ¿4X4_Lambda3
[
h264_’code_cÚŒŞ
->
i_cu¼_qp
]);

5003 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0070);

5005 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

5008 
’codeSize
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize
(encode_property);

5009 
ma¡”_¦Ù
->
İ
->
	`g‘_video_size
(master_slot)){

5011 
TW_VIDEO_SIZE_D1
:

5012 
’codeSize
){

5013 
TW_VIDEO_SIZE_QCIF
:

5014 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5015 
£n_ty³
 = 0xa4;

5017 
£n_ty³
 = 0x1a4;

5020 
TW_VIDEO_SIZE_CIF
:

5021 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5022 
£n_ty³
 = 0x54;

5024 
£n_ty³
 = 0x154;

5027 
TW_VIDEO_SIZE_HALF_D1
:

5028 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5029 
£n_ty³
 = 0x44;

5031 
£n_ty³
 = 0x144;

5035 
TW_VIDEO_SIZE_D1
:

5036 if(
’code_ã©u»
->
İ
->
	`g‘_deš‹¾aû
(encode_feature)){

5037 
£n_ty³
 = 0x6;

5039 
£n_ty³
 = 0x4;

5044 
TW_VIDEO_SIZE_HALF_D1
:

5045 
’codeSize
) {

5047 
TW_VIDEO_SIZE_HALF_D1
:

5048 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5049 
£n_ty³
 = 0x04;

5051 
£n_ty³
 = 0x104;

5054 
TW_VIDEO_SIZE_D1
:

5055 
	`´štk
("%s.%d‚Øsu½pÜt\n", 
__FUNCTION__
, 
__LINE__
);

5057 
TW_VIDEO_SIZE_CIF
:

5058 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5059 
£n_ty³
 = 0x14;

5061 
£n_ty³
 = 0x114;

5064 
TW_VIDEO_SIZE_QCIF
:

5065 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5066 
£n_ty³
 = 0x64;

5068 
£n_ty³
 = 0x164;

5073 
TW_VIDEO_SIZE_CIF
:

5074 
’codeSize
){

5075 
TW_VIDEO_SIZE_QCIF
:

5076 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5077 
£n_ty³
 = 0x54;

5079 
£n_ty³
 = 0x154;

5082 
TW_VIDEO_SIZE_CIF
:

5083 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5084 
£n_ty³
 = 0x04;

5086 
£n_ty³
 = 0x104;

5090 
TW_VIDEO_SIZE_D1
:

5091 
TW_VIDEO_SIZE_HALF_D1
:

5092 
	`´štk
("%s.%d‚Øsu½pÜt\n", 
__FUNCTION__
, 
__LINE__
);

5097 
mbd–ay
 = 
’code_ã©u»
->
İ
->
	`g‘_mb_d–ay
(encode_feature);

5098 if(
mbd–ay
 <= 240) {

5099 
mbd–ay
 >>= 4;

5100 
mbd–ay
 &= 0xf;

5101 
mbd–ay
 <<= 8;

5102 
mbd–ay
 |= (0 << 4);

5104 
mbd–ay
 >>= 7;

5105 
mbd–ay
 &= 0xf;

5106 
mbd–ay
 <<= 8;

5107 
mbd–ay
 |= (1 << 4);

5109 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHANNEL_ID
, (
ma¡”_¦Ù
->
phy_¦Ù_id
|
mbd–ay
|
DDR_B_CHIP
));

5110 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTERSTART
, 
£n_ty³
);

5111 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, ch->
video_’code_ÿp
->
’code_»g_4
 | (
video_mode
 << 6));

5113 if(
s_Úly_i_4x4
 == 0) {

5114 if(
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)) {

5115 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MB4X4LAMDA
, 
IÁ¿4X4_Lambda3
[
h264_’code_cÚŒŞ
->
i_cu¼_qp
]);

5116 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0070);

5118 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

5122 
h264_’code_cÚŒŞ
->
äame_ty³
) {

5123 
H264_FRAME_TYPE_P
:

5124 
mode_£Ëù
 = 0x2c;

5125 if(
’code_ã©u»
->
İ
->
	`g‘_sk
(encode_feature)) {

5126 
mode_£Ëù
 |= 0x90;

5128 
mode_£Ëù
 &= ~(0x90);

5130 if(
’code_ã©u»
->
İ
->
	`g‘_h®f_pix–
(encode_feature)){

5131 
mode_£Ëù
 |= 0x02;

5133 
mode_£Ëù
 &= 0xfd;

5135 if(
’code_ã©u»
->
İ
->
	`g‘_qu¬‹r_pix–
(encode_feature)) {

5136 
mode_£Ëù
 |= 0x01;

5138 
mode_£Ëù
 &= 0xfe;

5141 if(
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)) {

5142 if(
s_Úly_i_4x4
 == 0) {

5143 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MB4X4LAMDA
, 
IÁ¿4X4_Lambda3
[
h264_’code_cÚŒŞ
->
i_cu¼_qp
]);

5144 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0070);

5146 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

5149 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

5153 
H264_FRAME_TYPE_IDR
:

5154 
H264_FRAME_TYPE_I
:

5155 
mode_£Ëù
 = 0x8;

5156 if(
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)) {

5157 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MB4X4LAMDA
, 
IÁ¿4X4_Lambda3
[
h264_’code_cÚŒŞ
->
i_cu¼_qp
]);

5158 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0070);

5160 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRAENABLE
, 0x0060);

5165 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
INTRANDMECONTROL
, 
mode_£Ëù
);

5167 if(
ch
->
»gi¡”_cu¼_h264_’code_chª
 !ğ
NULL
){

5168 
ch
->
	`»gi¡”_cu¼_h264_’code_chª
(ch, 
h264_logic_’code_chª
);

5170 
h264_’code_cÚŒŞ
->
	`add_’code_timeout_hook
(h264_encode_control);

5172 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5173 if(
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsmè=ğ
TW_ED_RUNNING
){

5174 
	`do_g‘timeofday
(&
d–
->
Ï¡_time
);

5175 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x8000);

5176 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
CHIPSCOPE
, 0x0000);

5178 
ma¡”_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

5179 
video_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(video_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

5180 
ch
->
	`uÄegi¡”_cu¼_h264_’code_chª
(ch, 
h264_logic_’code_chª
);

5181 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

5182 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5183 
	`´štk
("\n\n%s.%d, %d.%d, s‹ƒ¼ %d\n\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

5187 
	`´štk
("\n\n%s.%d, %d.%d, cª'ˆg‘ vlû, s‹=%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

5188 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5189 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5190 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5191 
	`´štk
("\n\n%s.%d, %d.%d, cª'ˆg‘ vlû, s‹=%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

5192 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_ad_»ady
(h264_encode_control);

5193 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_¦iû_h—d_»ady
(h264_encode_control);

5195 
	`´štk
("\n\n\n\n&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n");

5196 
	`´štk
("%s.%d, %d.%d, cª'ˆg‘ vlû, s‹=%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

5197 
	`´štk
("&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&\n\n\n\n");

5198 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5199 
ma¡”_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

5200 
video_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(video_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

5201 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

5203 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5204 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

5209 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5210 
ma¡”_¦Ù
->
İ
->
	`¦Ù_soáw¬e_disÿrd_äame
(ma¡”_¦Ù, 
ch
, 
h264_logic_’code_chª
);

5211 
video_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(video_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

5212 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, 
ch
);

5214 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5215 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

5218 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
++;

5219 if(
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 >ğh264_’code_cÚŒŞ->
i_üossbus_ås
){

5220 
h264_’code_cÚŒŞ
->
i_äame_³r_£cÚd
 = 0;

5223 
	`´štk
("\n\n%s.%d, s‹ i nÙ sndby, why?????, %d, %d--%d\n\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, 
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
(ed_fsm));

5226 
	}
}

5228 
	$h264_logic_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
(
œq
, *
cÚ‹xt
)

5230 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

5231 
»t
 = 0;

5233 if(
h264_logic_’code_chª
 !ğ
NULL
){

5234 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = &
h264_logic_’code_chª
->
’code_cÚŒŞ
;

5235 
h264_’code_cÚŒŞ
->
İ
->
	`mov_vlc_codšg
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, h264_logic_’code_chª->
ch
);

5236 if(
h264_’code_cÚŒŞ
->
İ
->
	`ch_pšg_pÚg_upd©e
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, h264_logic_’code_chª->
ch
) <= 0){

5237 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

5238 
tw_video_äame_tcb_t
 *
äame
;

5239 
dvm_ch_t
 *
ch
;

5240 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

5241 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

5243 
’code_äame_queue
 = &
h264_logic_’code_chª
->encode_frame_queue;

5244 
äame
 = 
’code_äame_queue
->
cu¼_´oduûr
;

5245 if(
äame
 !ğ
NULL
){

5246 
h264_Çl_t
 *
Çl
;

5248 
Çl
 = &
äame
->nal;

5249 
äame
->
äame_Ën
 -ğ(
Çl
->
¥s_·ysize
 +‚®->
µs_·ysize
);

5250 if(
äame
->
äame_is_”r
 == 0){

5251 #ifdeà 
ADD_DVM_NAL_HEAD


5253 
h264_Çl_b™¡»am_t
 *
h264_Çl_¦iû_h—d
;

5254 
DVM_NAL_HEAD
 *
Çl_¦iû_h—d
;

5255 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

5256 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

5257 
æags
;

5258 
»t
;

5260 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

5261 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

5262 
video_·ck‘_queue
->
İ
->
	`Œy_g‘
(video_·ck‘_queue, &
·ck‘
);

5263 if(
·ck‘
 !ğ
NULL
){

5264 
h264_Çl_¦iû_h—d
 = (
h264_Çl_b™¡»am_t
*)&
·ck‘
->
d©a
[
Çl
->
¥s_·ysize
 +‚®->
µs_·ysize
];

5265 
Çl_¦iû_h—d
 = &
h264_Çl_¦iû_h—d
->
h—d
;

5266 
»t
 = 
äame
->
äame_Ën
 - (
DVM_NAL_HEAD
);

5267 
Çl_¦iû_h—d
->
i_Çl_size_0_7
 = (
»t
&0xff);

5268 
Çl_¦iû_h—d
->
i_Çl_size_8_15
 = ((
»t
>>8)&0xff);

5269 
Çl_¦iû_h—d
->
i_Çl_size_16_23
 = ((
»t
>>16)&0xff);

5271 
video_·ck‘_queue
->
İ
->
	`put_h—d”
(video_·ck‘_queue, 
·ck‘
);

5272 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

5275 
’code_äame_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(encode_frame_queue);

5277 
’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
Óncode_äame_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

5278 
h264_’code_cÚŒŞ
->
b_fÜû_i_äame
 = 1;

5279 
	`´štk
("%d.%d disÿrd\n", 
__LINE__
, 
h264_logic_’code_chª
->
logic_chª_id
);

5283 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

5284 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

5285 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5288 
ch
 = 
h264_logic_’code_chª
->chip;

5289 
	`ch_ä“_œq
(
ch
, 
IRQ_BURST_TYPE_INTR
, 
h264_logic_’code_chª
);

5290 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

5292 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_h264_b™¡»am_»q
(ch_d´am_cÚŒŞËr, 
h264_logic_’code_chª
);

5293 
»t
 = 1;

5296 
	`´štk
("\n%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

5298  
»t
;

5299 
	}
}

5301 
	$h264_logic_chª_¡¬t_»ad_b™¡»am
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

5303 
»t
=1;

5304 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

5305 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

5306 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = &
h264_logic_’code_chª
->
’code_cÚŒŞ
;

5307 
	`ch_»que¡_œq
(
h264_logic_’code_chª
->
ch
, 
IRQ_BURST_TYPE_INTR
, 
h264_logic_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
, "BURST", (*)h264_logic_encode_chan);

5308 
h264_’code_cÚŒŞ
->
İ
->
	`»ad_vlc_·¿m
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
->
ch
);

5310  
»t
;

5311 
	}
}

5313 
	$š™_subm™_»cv_’code_dÚe_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

5315 if((
d´am_»q
!=
NULL
è|| (
h264_logic_’code_chª
!=NULL)){

5316 
d´am_»q
->
ty³
 = 
DPRAM_NONBLOCK_TRANSFER_REQUEST
;

5317 
d´am_»q
->
cÚ‹xt
 = (*)
h264_logic_’code_chª
;

5318 
d´am_»q
->
»q_ÿÎback
 = 
h264_logic_chª_¡¬t_»ad_b™¡»am
;

5320 
	}
}

5322 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_œq_func
(
œq
, *
cÚ‹xt
)

5324 
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
 = (tw_h264_’code_cÚŒŞ_t*)
cÚ‹xt
;

5325 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

5326 
tw_h264_’code_d–_t
 *
d–
;

5327 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

5328 
dvm_ch_t
 *
ch
;

5329 
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am_buf
;

5330 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

5331 
u32
 
v®
;

5333 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

5334 
ch
 = 
h264_logic_’code_chª
->chip;

5336 
d–
 = &
h264_’code_cÚŒŞ
->
’code_d–
;

5337 
	`do_g‘timeofday
(&
d–
->
cu¼_time
);

5338 
v®
 = 
	`timev®_to_ns
(&
d–
->
cu¼_time
è-imev®_to_ns(&d–->
Ï¡_time
);

5339 
v®
 = val / 1000;

5340 if(
d–
->
max_d–
 == 0) {

5341 
d–
->
max_d–
 = 
v®
;

5343 if(
d–
->
mš_d–
 == 0) {

5344 
d–
->
mš_d–
 = 
v®
;

5346 if(
d–
->
max_d–
 < 
v®
) {

5347 
d–
->
max_d–
 = 
v®
;

5349 if(
d–
->
mš_d–
 > 
v®
) {

5350 
d–
->
mš_d–
 = 
v®
;

5352 
d–
->
cur_d–
 = 
v®
;

5354 
video_b™¡»am_buf
 = 
h264_logic_’code_chª
->video_bitstream_buf;

5355 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
ENCODER_VLC_PARAM
);

5356 
v®
 |ğ1<<(
video_b™¡»am_buf
->
İ
->
	`g‘_buf_id
(video_bitstream_buf) + 24);

5357 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_PARAM
, 
v®
);

5360 
h264_’code_cÚŒŞ
->
İ
->
	`nÙify
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
, h264_logic_’code_chª->
ch
);

5361 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

5362 
	`š™_subm™_»cv_’code_dÚe_£rviû
(&
h264_logic_’code_chª
->
»ad_video_b™¡»am_»q
, h264_logic_encode_chan);

5363 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_»ad_h264_b™¡»am_»q
(ch_d´am_cÚŒŞËr, 
h264_logic_’code_chª
);

5366 
	}
}

5368 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_»ad_vlc_·¿m
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

5370 if((
h264_’code_cÚŒŞ
!=
NULL
è&& (
ch
!=NULL)){

5371 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

5372 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

5374 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

5375 
ch_d´am_cÚŒŞËr
 = &
h264_logic_’code_chª
->
ch
->chip_dpram_controller;

5376 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
h264_logic_’code_chª
->
d´am_·ge
)){

5377 
d´am_·ge_node_t
 *
d´am_·ge
 = 
h264_logic_’code_chª
->dpram_page;

5378 
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am_buf
 = 
h264_logic_’code_chª
->video_bitstream_buf;

5379 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

5380 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

5381 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

5382 
tw_video_äame_tcb_t
 *
äame
;

5383 
h264_Çl_t
 *
Çl
;

5385 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

5386 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

5387 
Çl
 = &
äame
->nal;

5388 
bur¡_š‹rçû
->
İ
->
	`¡¬t_block_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
d´am_·ge
, 
video_b™¡»am_buf
->İ->
	`g‘_buf_ba£_off£t
(video_b™¡»am_buf), video_b™¡»am_buf->İ->
	`g‘_·ge_id
(video_b™¡»am_buf), (
ddr_video_b™¡»am_h—d”_t
), video_b™¡»am_buf->İ->
	`g‘_buf_š_ch_a_Ü_b
(video_bitstream_buf));

5389 
Çl
->
¦iû_h—d_buf
 = 
äame
->
video_·ck‘_queue
.
cu¼_´oduûr
->
d©a
;

5390 
bur¡_š‹rçû
->
İ
->
	`pio_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, (
u32
*)
Çl
->
¦iû_h—d_buf
, (
ddr_video_b™¡»am_h—d”_t
));

5392 
h264_’code_cÚŒŞ
->
İ
->
	`ÿlcuÏ‹_mov_·¿m
(h264_’code_cÚŒŞ, 
h264_logic_’code_chª
->
ch
);

5393 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

5394 
video_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`dma_m­
(video_·ck‘_queue->cu¼_´oduûr, 
DMA_FROM_DEVICE
);

5396 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
d´am_·ge
, (
video_b™¡»am_buf
->İ->
	`g‘_buf_ba£_off£t
(video_b™¡»am_buf)+
h264_’code_cÚŒŞ
->
äame_ba£_addr
), video_b™¡»am_buf->İ->
	`g‘_·ge_id
(video_b™¡»am_buf), h264_’code_cÚŒŞ->
£ùiÚ_Ën
, video_b™¡»am_buf->İ->
	`g‘_buf_š_ch_a_Ü_b
(video_bitstream_buf));

5398 
	`´štk
("\n\n[%s.%d]&&&&Ãed‡ddrigg”&&&\n\n", 
__FUNCTION__
, 
__LINE__
);

5401 
	}
}

5403 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_ÿlcuÏ‹_mov_·¿m
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
dvm_ch_t
 *
ch
)

5405 if((
h264_’code_cÚŒŞ
!=
NULL
è&& (
ch
!=NULL)){

5406 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

5407 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

5408 
tw_video_äame_tcb_t
 *
äame
;

5409 
h264_Çl_t
 *
Çl
;

5410 
ddr_video_b™¡»am_h—d”_t
 *
video_b™¡»am_h—d”
;

5411 
d´am_·ge_node_t
 *
d´am_·ge
;

5413 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_cÚŒŞ
(
h264_’code_cÚŒŞ
);

5414 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

5415 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

5416 
Çl
 = &
äame
->nal;

5417 
d´am_·ge
 = 
h264_logic_’code_chª
->dpram_page;

5418 
video_b™¡»am_h—d”
 = (
ddr_video_b™¡»am_h—d”_t
*)
Çl
->
¦iû_h—d_buf
;

5419 
äame
->
äame_Ën
 = 
h264_’code_cÚŒŞ
->
tÙ®_äame_Ën
 = 
video_b™¡»am_h—d”
->
h264_b™¡»am_h—d”
.
Ën
<<1;

5420 
h264_’code_cÚŒŞ
->
äame_ba£_addr
 = 
video_b™¡»am_h—d”
->
h264_b™¡»am_h—d”
.
off£t
<<2;

5421 
h264_’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
 = 0;

5422 
h264_’code_cÚŒŞ
->
£ùiÚ_Ën
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_size
(dpram_page);

5423 
h264_’code_cÚŒŞ
->
£ùiÚ_numb”
 = h264_’code_cÚŒŞ->
tÙ®_äame_Ën
 / h264_’code_cÚŒŞ->
£ùiÚ_Ën
;

5424 
h264_’code_cÚŒŞ
->
”_Ën
 = h264_’code_cÚŒŞ->
tÙ®_äame_Ën
 % h264_’code_cÚŒŞ->
£ùiÚ_Ën
;

5425 if(
h264_’code_cÚŒŞ
->
”_Ën
){

5426 
h264_’code_cÚŒŞ
->
£ùiÚ_numb”
++;

5428 
h264_’code_cÚŒŞ
->
”_Ën
 = h264_’code_cÚŒŞ->
£ùiÚ_Ën
;

5431 
	}
}

5433 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_mov_vlc_codšg
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

5435 if((
h264_’code_cÚŒŞ
!=
NULL
è&& (
h264_logic_’code_chª
!=NULLè&& (
ch
!=NULL)){

5436 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

5437 
tw_video_äame_tcb_t
 *
äame
;

5438 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

5439 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

5440 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

5441 
d´am_·ge_node_t
 *
d´am_·ge
 = 
h264_logic_’code_chª
->dpram_page;

5442 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

5443 
dma_addr_t
 
‹mp_dma_addr
;

5445 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

5446 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

5447 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

5448 if(
äame
 !ğ
NULL
) {

5449 if(
äame
->
äame_is_”r
){

5452 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

5453 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

5454 if(
·ck‘
 =ğ
NULL
) {

5455 
video_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(video_·ck‘_queue, &
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

5456 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

5457 if(
·ck‘
 =ğ
NULL
) {

5458 
äame
->
äame_is_”r
 = 1;

5461 
·ck‘
->
İ
->
	`dma_m­
Õack‘, 
DMA_FROM_DEVICE
);

5464 
‹mp_dma_addr
 = 
·ck‘
->
dma_addr
;

5465 if(
h264_’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
&1){

5466 
‹mp_dma_addr
 +ğ
h264_’code_cÚŒŞ
->
£ùiÚ_Ën
;

5468 if(
h264_’code_cÚŒŞ
->
£ùiÚ_numb”
 > 1){

5469 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, 
‹mp_dma_addr
, 
h264_’code_cÚŒŞ
->
£ùiÚ_Ën
);

5470 
·ck‘
->
·ylßd_Ën
 +ğ
h264_’code_cÚŒŞ
->
£ùiÚ_Ën
;

5472 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, 
‹mp_dma_addr
, 
h264_’code_cÚŒŞ
->
”_Ën
);

5473 
·ck‘
->
·ylßd_Ën
 +ğ
h264_’code_cÚŒŞ
->
”_Ën
;

5477 
	}
}

5479 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_ch_pšg_pÚg_upd©e
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

5481 
»t
 = 0;

5482 if((
h264_’code_cÚŒŞ
!=
NULL
è&& (
h264_logic_’code_chª
!=NULLè&& (
ch
!=NULL)){

5483 
tw_video_äame_tcb_queue_t
 *
video_äame_queue
;

5484 
tw_video_äame_tcb_t
 *
äame
;

5485 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

5486 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

5487 
d´am_·ge_node_t
 *
d´am_·ge
 = 
h264_logic_’code_chª
->dpram_page;

5488 
ddr_video_b™¡»am_buf_node_t
 *
video_b™¡»am_buf
 = 
h264_logic_’code_chª
->video_bitstream_buf;

5489 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

5491 
video_äame_queue
 = &
h264_logic_’code_chª
->
’code_äame_queue
;

5492 
äame
 = 
video_äame_queue
->
cu¼_´oduûr
;

5493 
h264_’code_cÚŒŞ
->
äame_ba£_addr
 +ğh264_’code_cÚŒŞ->
£ùiÚ_Ën
;

5494 
h264_’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
++;

5495 if(!(
h264_’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
&0x1)){

5496 if(
äame
 !ğ
NULL
){

5497 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

5498 if(
video_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

5499 
video_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`dma_unm­
(video_·ck‘_queue->cu¼_´oduûr, 
DMA_FROM_DEVICE
);

5501 
video_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_packet_queue);

5504 
h264_’code_cÚŒŞ
->
£ùiÚ_numb”
--;

5505 
»t
 = 
h264_’code_cÚŒŞ
->
£ùiÚ_numb”
;

5507 if(
»t
 > 1){

5508 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
d´am_·ge
, (
video_b™¡»am_buf
->İ->
	`g‘_buf_ba£_off£t
(video_b™¡»am_buf)+
h264_’code_cÚŒŞ
->
äame_ba£_addr
), video_b™¡»am_buf->İ->
	`g‘_·ge_id
(video_b™¡»am_buf), h264_’code_cÚŒŞ->
£ùiÚ_Ën
, video_b™¡»am_buf->İ->
	`g‘_buf_š_ch_a_Ü_b
(video_bitstream_buf));

5509 } if(
»t
 == 1) {

5510 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
d´am_·ge
, (
video_b™¡»am_buf
->İ->
	`g‘_buf_ba£_off£t
(video_b™¡»am_buf)+
h264_’code_cÚŒŞ
->
äame_ba£_addr
), video_b™¡»am_buf->İ->
	`g‘_·ge_id
(video_b™¡»am_buf), h264_’code_cÚŒŞ->
”_Ën
, video_b™¡»am_buf->İ->
	`g‘_buf_š_ch_a_Ü_b
(video_bitstream_buf));

5512 if(
h264_’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
&0x1){

5513 if(
äame
 !ğ
NULL
){

5514 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

5515 if(
video_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

5516 
video_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`dma_unm­
(video_·ck‘_queue->cu¼_´oduûr, 
DMA_FROM_DEVICE
);

5518 
video_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_packet_queue);

5523  
»t
;

5524 
	}
}

5526 
	$tw5864_h264_’code_cÚŒŞ_through_ddr_nÙify
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
dvm_ch_t
 *
ch
)

5528 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

5529 
tw_video_äame_tcb_t
 *
äame
;

5530 
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
;

5531 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

5533 
h264_’code_cÚŒŞ
->
	`d–‘e_’code_timeout_hook
(h264_encode_control);

5534 
h264_’code_cÚŒŞ
->
vlc_¡©us
 = 0;

5535 
h264_logic_’code_chª
->
rc_driv”
.
rc_İ
->
	`upd©e_rc
(h264_logic_encode_chan);

5536 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ENCODER_VLC_INTR_STATUS
, 
VLC_INTR_MASK_ALL
);

5537 if(
h264_logic_’code_chª
->
ma¡”_¦Ù
 !ğ
NULL
){

5538 
h264_logic_’code_chª
->
ma¡”_¦Ù
->
İ
->
	`’code_’dof¦iû_nÙify
(h264_logic_encode_chan->master_slot, h264_logic_encode_chan);

5541 
’code_äame_queue
 = &
h264_logic_’code_chª
->encode_frame_queue;

5542 
äame
 = 
’code_äame_queue
->
cu¼_´oduûr
;

5543 if(
äame
 !ğ
NULL
){

5544 
h264_’code_cÚŒŞ
->
i_åm
++;

5545 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_ok
(h264_encode_control);

5546 
ch
->
	`uÄegi¡”_cu¼_h264_’code_chª
(ch, 
h264_logic_’code_chª
);

5547 if(
h264_’code_cÚŒŞ
->
ov”æow
){

5548 
h264_’code_cÚŒŞ
->
ov”æow
 = 0;

5549 
	`´štk
("\n\n%d ov”æow %d\n\n", 
h264_logic_’code_chª
->
phy_¦Ù_id
, 
h264_’code_cÚŒŞ
->
ov”æow
);

5552 
h264_logic_’code_chª
->
rc_driv”
.
rc_İ
->
	`jump_rc
(h264_logic_encode_chan);

5553 
h264_’code_cÚŒŞ
->
İ
->
	`upd©e_©_’code_äame_”r
(h264_encode_control);

5556 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

5557 
	`driv”_g’_d–iv”_ev’t
(
İ’ed_logic_chª_ed
, 1);

5558 
ch_’code_£rviû_queue
 = &
ch
->chip_encode_service_queue;

5559 
ch_’code_£rviû_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(chip_encode_service_queue);

5560 
ch_’code_£rviû_queue
->
İ
->
	`Œigg”_ch_³ndšg_£rviû_»que¡
(chip_encode_service_queue);

5562 
	}
}

5564 
tw_h264_’code_cÚŒŞ_İ”©iÚ
 
	gtw5864_h264_’code_cÚŒŞ_through_ddr_İ
 = {

5565 .
š™
 = 
tw5864_h264_’code_cÚŒŞ_š™
,

5566 .
	g»£t
 = 
tw5864_h264_’code_cÚŒŞ_»£t
,

5568 .
	g£t_¥s
 = 
tw5864_h264_’code_cÚŒŞ_£t_¥s
,

5569 .
	g£t_µs
 = 
tw5864_h264_’code_cÚŒŞ_£t_µs
,

5570 .
	g£t_¦iû_h—d
 = 
tw5864_h264_’code_cÚŒŞ_£t_¦iû_h—d
,

5571 .
	gg’”©Ü_h—d
 = 
tw5864_h264_’code_cÚŒŞ_g’”©Ü_h—d
,

5573 .
	gÿlcuÏ‹_äame_ty³
 = 
tw5864_h264_’code_cÚŒŞ_ÿlcuÏ‹_äame_ty³
,

5574 .
	gg‘_äame_ty³
 = 
tw5864_h264_’code_cÚŒŞ_g‘_äame_ty³
,

5575 .
	gfÜû_I_äame
 = 
tw5864_h264_’code_cÚŒŞ_fÜû_I_äame
,

5576 .
	gupd©e_©_’code_äame_ok
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_ok
,

5577 .
	gupd©e_©_disÿrd_äame
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_disÿrd_äame
,

5578 .
	gupd©e_©_’code_äame_”r
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_©_’code_äame_”r
,

5579 .
	gupd©e_image_»sŞutiÚ
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_image_»sŞutiÚ
,

5580 .
	gupd©e_ås_disÿrd_bË
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_ås_disÿrd_bË
,

5582 .
	gg‘_¦iû_h—d_ªd_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_g‘_¦iû_h—d_ªd_ad_¡©us
,

5583 .
	gş—r_¦iû_h—d_ªd_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_ªd_ad_¡©us
,

5584 .
	gupd©e_¦iû_h—d_»ady
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_¦iû_h—d_»ady
,

5585 .
	gş—r_¦iû_h—d_»ady
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_¦iû_h—d_»ady
,

5586 .
	gupd©e_ad_»ady
 = 
tw5864_h264_’code_cÚŒŞ_upd©e_ad_»ady
,

5587 .
	gş—r_ad_»ady
 = 
tw5864_h264_’code_cÚŒŞ_ş—r_ad_»ady
,

5588 .
	gg‘_ad_¡©us
 = 
tw5864_h264_’code_cÚŒŞ_g‘_ad_¡©us
,

5591 .
	gfœ¡_¡¬t
 = 
tw5864_h264_’code_cÚŒŞ_fœ¡_¡¬t
,

5592 .
	g¡¬t_’code
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_¡¬t_’code
,

5594 .
	gœq_func
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_œq_func
,

5595 .
	g»ad_vlc_·¿m
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_»ad_vlc_·¿m
,

5596 .
	gÿlcuÏ‹_mov_·¿m
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_ÿlcuÏ‹_mov_·¿m
,

5597 .
	gmov_vlc_codšg
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_mov_vlc_codšg
,

5598 .
	gch_pšg_pÚg_upd©e
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_ch_pšg_pÚg_upd©e
,

5599 .
	gnÙify
 = 
tw5864_h264_’code_cÚŒŞ_through_ddr_nÙify
,

5601 .
	gchª_ÿn_com¶‘e
 = 
tw5864_h264_’code_cÚŒŞ_chª_ÿn_com¶‘e
,

5604 
	$š™_tw5864_h264_’code_cÚŒŞ
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
, 
»ad_b™¡»am_mode
)

5606 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

5607 if(
»ad_b™¡»am_mode
 =ğ
READ_H264_BITSTREAM_BY_DDR
){

5608 
h264_’code_cÚŒŞ
->
İ
 = &
tw5864_h264_’code_cÚŒŞ_through_ddr_İ
;

5610 
h264_’code_cÚŒŞ
->
İ
 = &
tw5864_h264_’code_cÚŒŞ_İ
;

5612 
h264_’code_cÚŒŞ
->
İ
->
	`š™
(h264_encode_control);

5614 
	}
}

5616 
	$»move_tw5864_h264_’code_cÚŒŞ
(
tw_h264_’code_cÚŒŞ_t
 *
h264_’code_cÚŒŞ
)

5618 if(
h264_’code_cÚŒŞ
 !ğ
NULL
){

5619 
h264_’code_cÚŒŞ
->
	`d–‘e_’code_timeout_hook
(h264_encode_control);

5621 
	}
}

5623 
	$h264_logic_’code_chª_fœ¡_¡¬t
(*
cÚ‹xt
)

5625 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

5626 if(
h264_logic_’code_chª
 !ğ
NULL
){

5627 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
İ
->
	`fœ¡_¡¬t
(&h264_logic_encode_chan->encode_control);

5628 
	`´štk
("%s.%d:%d-%d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
);

5630 
	}
}

5632 
	$h264_logic_’code_chª_¡¬t_’code
(*
cÚ‹xt
)

5634 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
cÚ‹xt
;

5635 if(
h264_logic_’code_chª
 !ğ
NULL
){

5636 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
İ
->
	`¡¬t_’code
(&h264_logic_encode_chan->encode_control);

5638 
	}
}

5640 
	$š™_’code_chª_£rviû_tcb_w™h_nuÎ
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
)

5642 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_»que¡_tcb
(
’code_»que¡_tcb
);

5643 
tcb_node_t
 *
£rviû_tcb
 = &
’code_»que¡_tcb
->service_tcb;

5645 
£rviû_tcb
->
İ
 = &
tcb_node_İ
;

5646 
£rviû_tcb
->
İ
->
	`š™
(service_tcb);

5647 
£rviû_tcb
->
İ
->
	`£t_´iv
(£rviû_tcb, 
’code_»que¡_tcb
);

5648 
’code_»que¡_tcb
->
cÚ‹xt
 = 
h264_logic_’code_chª
;

5649 
’code_»que¡_tcb
->
ty³
 = 
DVM_CHIP_REQ_FIRST_STRAT_ENCODE_CHAN
;

5650 
’code_»que¡_tcb
->
»q_ÿÎback
 = 
h264_logic_’code_chª_fœ¡_¡¬t
;

5651 
	}
}

5653 
	$š™_’code_chª_£rviû_tcb_w™h_fœ¡_¡¬t
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
)

5655 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_»que¡_tcb
(
’code_»que¡_tcb
);

5656 
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
;

5658 
	`š™_’code_chª_£rviû_tcb_w™h_nuÎ
(
’code_»que¡_tcb
);

5659 
ch_’code_£rviû_queue
 = &
h264_logic_’code_chª
->
ch
->chip_encode_service_queue;

5660 
ch_’code_£rviû_queue
->
İ
->
	`put_£rviû_»que¡_što_queue_h—d”
(ch_’code_£rviû_queue, 
’code_»que¡_tcb
);

5661 
	}
}

5663 
	$š™_’code_chª_£rviû_tcb_w™h_¡¬t_’code
(
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
)

5665 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_»que¡_tcb
(
’code_»que¡_tcb
);

5666 
tcb_node_t
 *
£rviû_tcb
 = &
’code_»que¡_tcb
->service_tcb;

5667 
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
;

5669 
£rviû_tcb
->
İ
 = &
tcb_node_İ
;

5670 
£rviû_tcb
->
İ
->
	`š™
(service_tcb);

5671 
£rviû_tcb
->
İ
->
	`£t_´iv
(£rviû_tcb, 
’code_»que¡_tcb
);

5672 
’code_»que¡_tcb
->
cÚ‹xt
 = 
h264_logic_’code_chª
;

5673 
’code_»que¡_tcb
->
ty³
 = 
DVM_CHIP_REQ_START_ENCODE_CHAN
;

5674 
’code_»que¡_tcb
->
»q_ÿÎback
 = 
h264_logic_’code_chª_¡¬t_’code
;

5675 
ch_’code_£rviû_queue
 = &
h264_logic_’code_chª
->
ch
->chip_encode_service_queue;

5676 
ch_’code_£rviû_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
(ch_’code_£rviû_queue, 
’code_»que¡_tcb
);

5677 
	}
}

5679 
	$h264_logic_’code_chª_d–ay_»¡¬t_’code
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

5681 
ch_’code_chª_£rviû_queue_t
 *
ch_’code_£rviû_queue
;

5682 
’code_chª_£rviû_tcb_t
 *
’code_»que¡_tcb
;

5683 
tcb_node_t
 *
£rviû_tcb
;

5684 
dvm_ch_t
 *
ch
;

5686 
	`´štk
("\n=========>%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

5687 
ch
 = 
h264_logic_’code_chª
->chip;

5688 
’code_»que¡_tcb
 = &
h264_logic_’code_chª
->encode_request_tcb;

5689 
£rviû_tcb
 = &
’code_»que¡_tcb
->service_tcb;

5690 
£rviû_tcb
->
İ
 = &
tcb_node_İ
;

5691 
£rviû_tcb
->
İ
->
	`š™
(service_tcb);

5692 
£rviû_tcb
->
İ
->
	`£t_´iv
(£rviû_tcb, 
’code_»que¡_tcb
);

5693 
’code_»que¡_tcb
->
cÚ‹xt
 = 
h264_logic_’code_chª
;

5694 
’code_»que¡_tcb
->
ty³
 = 
DVM_CHIP_REQ_START_ENCODE_CHAN
;

5695 
’code_»que¡_tcb
->
»q_ÿÎback
 = 
h264_logic_’code_chª_¡¬t_’code
;

5696 
ch_’code_£rviû_queue
 = &
ch
->chip_encode_service_queue;

5697 
ch_’code_£rviû_queue
->
İ
->
	`put_£rviû_»que¡_što_queue_h—d”
(ch_’code_£rviû_queue, 
’code_»que¡_tcb
);

5698 
	}
}

5700 
	$h264_’code_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
)

5702 
»t
 = 
TW_ERR
;

5704 if(
İ’ed_logic_chª_ed
 !ğ
NULL
){

5705 
	`driv”_g’_İ’_ev’t
(
İ’ed_logic_chª_ed
, 1);

5706 
»t
 = 
TW_OK
;

5709  
»t
;

5710 
	}
}

5712 
	$h264_’code_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
)

5714 
»t
 = 
TW_ERR
;

5715 if(
İ’ed_logic_chª_ed
 !ğ
NULL
){

5716 
i
;

5717 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
İ’ed_logic_chª_ed
);

5718 
	`´štk
("\n%s.%d: %d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
logic_chª_id
, h264_logic_’code_chª->
ma¡”_¦Ù
->
phy_¦Ù_id
);

5719 
	`driv”_g’_şo£_ev’t
(
İ’ed_logic_chª_ed
, 1);

5720 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
i_¡©i¡ic_mšu‹r_couÁ”
 = 0;

5721 
	`uÄegi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

5722 
	`»move_tw5864_h264_’code_cÚŒŞ
(&
h264_logic_’code_chª
->
’code_cÚŒŞ
);

5723 
	`»move_tw5864_h264_phy_video_¦Ù
(
h264_logic_’code_chª
->
ma¡”_¦Ù
, h264_logic_encode_chan);

5724 
	`»move_tw_video_äame_tcb_queue
(&
h264_logic_’code_chª
->
’code_äame_queue
, &h264_logic_’code_chª->
’code_chª_buf_poŞ
);

5725 #ifdeà 
MV_MODULE


5726 
	`»move_tw_video_mv_äame_tcb_queue
(&
h264_logic_’code_chª
->
’code_mv_äame_queue
, &h264_logic_’code_chª->
’code_chª_buf_poŞ
);

5728 
h264_logic_’code_chª
->
’code_cÚŒŞ
.
İ
->
	`»£t
(&h264_logic_encode_chan->encode_control);

5729 
»t
 = 
TW_OK
;

5730 
i
=0; i<
REQ_MSG_NUMBER
; i++){

5731 
	`D–‘eSšgËFœeTim”Job
(
h264_logic_’code_chª
->
nÚblock_msg_tim”_id
[
i
]);

5732 
h264_logic_’code_chª
->
nÚblock_msg_tim”_id
[
i
] = 
INVALIDTIMERID
;

5733 
	`D–‘eSšgËFœeTim”Job
(
h264_logic_’code_chª
->
d–ay_msg_tim”_id
[
i
]);

5734 
h264_logic_’code_chª
->
d–ay_msg_tim”_id
[
i
] = 
INVALIDTIMERID
;

5736 #ifdeà 
OSD_MODULE


5737 
	`şo£_’code_osd_chª_’gše
(&
h264_logic_’code_chª
->
’code_osd_’gše
);

5739 if(
	`©omic_»ad
(&
h264_logic_’code_chª
->
İ’ed_æag
)){

5740 
dvm_ch_t
 *
ch
;

5741 
	`©omic_£t
(&
h264_logic_’code_chª
->
İ’ed_æag
, 0);

5742 
ch
 = 
h264_logic_’code_chª
->chip;

5743 
ch
->
	`ch_şo£
(chip);

5745 
	`´štk
("\n%s.%d: %d, %d\n\n", 
__FUNCTION__
, 
__LINE__
, 
h264_logic_’code_chª
->
logic_chª_id
, h264_logic_’code_chª->
ma¡”_¦Ù
->
phy_¦Ù_id
);

5747  
»t
;

5748 
	}
}

5750 
	$h264_’code_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
)

5753 
	}
}

5755 
	$h264_’code_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
)

5758 
	}
}

5760 
	$h264_’code_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
, 
cmd
, 
¬g
)

5762 
»t
 = 0;

5763 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
;

5764 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

5765 
tw_h264_’code_cÚfigu¿tiÚ_t
 
’code_cÚfigu¿tiÚ
, *
pcÚfig
 = &encode_configuration;

5766 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

5767 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

5768 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
;

5770 
tw_h264_’code_·¿m
 
’code_·¿m
, *
³ncode_·¿m
 = &encode_param;

5771 
ch_driv”_t
 *
ch_driv”
;

5772 
tw_video_bus_t
 *
video_bus
;

5774 if(!
İ’ed_logic_chª_ed
) {

5775 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

5776  -
EINVAL
;

5779 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

5781 
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_İ’ed_logic_chª_ed
(
İ’ed_logic_chª_ed
);

5782 
’code_´İ”ty
 = &
h264_logic_’code_chª
->encode_property;

5783 
	`mem£t
(
pcÚfig
, 0, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

5784 
ch_driv”
 = 
h264_logic_’code_chª
->
ch
->chip_driver;

5785 
video_bus
 = &
ch_driv”
->video_bus;

5786 
phy_video_¦Ù
 = 
h264_logic_’code_chª
->
ma¡”_¦Ù
;

5787 
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

5788 if(
	`©omic_»ad
(&
h264_logic_’code_chª
->
İ’ed_æag
) == 0){

5789 
	`TW_DBG
(
TW_DBG_ERR
, "channel have‚ot be opend\n");

5790  -
ENODEV
;

5792 
cmd
) {

5793 
DVM_CODEC_GET_VIDEO_ENCODER_PARAM
:

5794 if(!
¬g
) {

5795 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

5796  -
EINVAL
;

5798 
	`cİy_äom_u£r
(
³ncode_·¿m
, (*)
¬g
, (
tw_h264_’code_·¿m
));

5799 
pcÚfig
 = &
’code_´İ”ty
->encode_property;

5800 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_BPS_MASK
) {

5801 
³ncode_·¿m
->
i_bps
 = 
pcÚfig
->
b™¿‹
;

5803 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_FPS_MASK
) {

5804 
³ncode_·¿m
->
i_ås
 = 
pcÚfig
->
ås
;

5806 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_IP_STRIDE_MASK
) {

5807 
³ncode_·¿m
->
i_I_P_¡ride
 = 
pcÚfig
->
keyF¿meIÁ”v®s
;

5809 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_PB_STRIDE_MASK
) {

5810 
³ncode_·¿m
->
i_P_B_¡ride
 = 0;

5812 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_GOP_MASK
) {

5813 
³ncode_·¿m
->
i_gİ_v®ue
 = 
pcÚfig
->
gİIÁ”v®s
;

5815 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_FORCE_I_MASK
) {

5816 
³ncode_·¿m
->
b_fÜû_I_æag
 = 0;

5818 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_WIDTH_MASK
) {

5819 
³ncode_·¿m
->
i_logic_video_width_mb_size
 = 
pcÚfig
->
width
;

5821 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_HEIGHT_MASK
) {

5822 
³ncode_·¿m
->
i_logic_video_height_mb_size
 = 
pcÚfig
->
height
;

5825 
	`cİy_to_u£r
((*)
¬g
, 
³ncode_·¿m
, (
tw_h264_’code_·¿m
));

5827 
DVM_CODEC_SET_VIDEO_ENCODER_PARAM
:

5828 if(!
¬g
) {

5829 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

5830  -
EINVAL
;

5832 
	`cİy_äom_u£r
(
³ncode_·¿m
, (*)
¬g
, (
tw_h264_’code_·¿m
));

5834 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

5835 if((
³ncode_·¿m
->
i_bps
 < 
MASTER_MIN_BIT_RATE
è|| (³ncode_·¿m->i_bp > 
MASTER_MAX_BIT_RATE
)){

5836 
	`TW_DBG
(
TW_DBG_ERR
, "b™¿‹ƒ¼Ü %d [%d, %d]!\n", 
³ncode_·¿m
->
i_bps
,

5837 
MASTER_MIN_BIT_RATE
, 
MASTER_MAX_BIT_RATE
);

5838 
»t
 = -
EINVAL
;

5841 
pcÚfig
->
b™¿‹
 = 
³ncode_·¿m
->
i_bps
;

5842 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
;

5844 if((
³ncode_·¿m
->
i_bps
 < 
SUB_MIN_BIT_RATE
è|| (³ncode_·¿m->i_bp > 
SUB_MAX_BIT_RATE
)){

5845 
	`TW_DBG
(
TW_DBG_ERR
, "b™¿‹ƒ¼Ü %d [%d, %d]!\n", 
³ncode_·¿m
->
i_bps
,

5846 
SUB_MIN_BIT_RATE
, 
SUB_MAX_BIT_RATE
);

5848 
»t
 = -
EINVAL
;

5851 
pcÚfig
->
b™¿‹
 = 
³ncode_·¿m
->
i_bps
;

5852 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_BITRATE_CHANGED
;

5854 if((
³ncode_·¿m
->
i_ås
 < 
MIN_FRAME_RATE
è|| (³ncode_·¿m->i_å > 
MAX_FRAME_RATE_PAL
)) {

5855 
	`TW_DBG
(
TW_DBG_ERR
, "å ”rÜ %d [%d, %d]!\n", 
³ncode_·¿m
->
i_ås
,

5856 
MIN_FRAME_RATE
, 
MAX_FRAME_RATE_PAL
);

5857 
»t
 = -
EINVAL
;

5860 if(
³ncode_·¿m
->
i_ås
 > 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot)) {

5862 
	`TW_DBG
(
TW_DBG_ERR
, "rg‘ fp %d should sm®Èthª v˜å %d\n", 
³ncode_·¿m
->
i_ås
, 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot));

5863 
»t
 = -
EINVAL
;

5866 
pcÚfig
->
ås
 = 
³ncode_·¿m
->
i_ås
;

5867 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_FPS_CHANGED
;

5869 if((
³ncode_·¿m
->
i_gİ_v®ue
 < 
MIN_GOP
è|| (³ncode_·¿m->i_gİ_v®u> 
MAX_GOP
)) {

5870 
	`TW_DBG
(
TW_DBG_ERR
, "gİƒ¼Ü %d [%d, %d]!\n", 
³ncode_·¿m
->
i_gİ_v®ue
,

5871 
MIN_GOP
, 
MAX_GOP
);

5872 
»t
 = -
EINVAL
;

5875 
pcÚfig
->
gİIÁ”v®s
 = 
³ncode_·¿m
->
i_gİ_v®ue
;

5876 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_GOP_INTERVALS_CHANGED
;

5878 if((
³ncode_·¿m
->
i_I_P_¡ride
 < 
MIN_I_P_STRIDE
è|| (³ncode_·¿m->i_I_P_¡rid> 
MAX_I_P_STRIDE
)) {

5879 
	`TW_DBG
(
TW_DBG_ERR
, "key f¿mš‹rv®ƒ¼Ü %d [%d, %d]!\n", 
³ncode_·¿m
->
i_I_P_¡ride
,

5880 
MIN_I_P_STRIDE
, 
MAX_I_P_STRIDE
);

5881 
»t
 = -
EINVAL
;

5884 
pcÚfig
->
keyF¿meIÁ”v®s
 = 
³ncode_·¿m
->
i_I_P_¡ride
;

5885 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_KEYFRAME_INTERVALS_CHANGED
;

5887 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_WIDTH_MASK
) {

5888 if(
³ncode_·¿m
->
chªge_mask_æag
 & 
TW_h264_ENCODER_PARAM_HEIGHT_MASK
) {

5889 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

5890 if((
³ncode_·¿m
->
i_logic_video_height_mb_size
 =ğ0è|| (³ncode_·¿m->i_logic_video_height_mb_siz> 
WIDTH_FRAME_D1_PAL
)) {

5891 
	`TW_DBG
(
TW_DBG_ERR
, "heighˆ(%dè”rÜ‡ˆnÜm PAL\n", 
³ncode_·¿m
->
i_logic_video_height_mb_size
);

5892 
»t
 = -
EINVAL
;

5895 if((
³ncode_·¿m
->
i_logic_video_width_mb_size
 =ğ0è|| (³ncode_·¿m->i_logic_video_width_mb_siz> 
WIDTH_FRAME_D1_PAL
)) {

5896 
	`TW_DBG
(
TW_DBG_ERR
, "width (%dè”rÜ‡ˆnÜm PAL\n", 
³ncode_·¿m
->
i_logic_video_width_mb_size
);

5897 
»t
 = -
EINVAL
;

5901 if((
³ncode_·¿m
->
i_logic_video_height_mb_size
 =ğ0è|| (³ncode_·¿m->i_logic_video_height_mb_siz> 
WIDTH_FRAME_D1_NTSC
)) {

5902 
	`TW_DBG
(
TW_DBG_ERR
, "heighˆ(%dè”rÜ‡ˆnÜm NTSC\n", 
³ncode_·¿m
->
i_logic_video_height_mb_size
);

5903 
»t
 = -
EINVAL
;

5906 if((
³ncode_·¿m
->
i_logic_video_height_mb_size
 =ğ0è|| (³ncode_·¿m->
i_logic_video_width_mb_size
 > 
WIDTH_FRAME_D1_NTSC
)) {

5907 
	`TW_DBG
(
TW_DBG_ERR
, "width (%dè”rÜ‡ˆnÜm NTSC\n", 
³ncode_·¿m
->
i_logic_video_width_mb_size
);

5908 
»t
 = -
EINVAL
;

5912 if(
h264_logic_’code_chª
->
ty³
 =ğ
TW_SUB_BITSTREAM
) {

5913 if((
³ncode_·¿m
->
i_logic_video_width_mb_size
<<4è>=
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VD
, 
phy_video_¦Ù
->
video_size
, 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))) {

5914 
	`TW_DBG
(
TW_DBG_ERR
, "width should smallhan vi\n");

5915 
»t
 = -
EINVAL
;

5918 if((
³ncode_·¿m
->
i_logic_video_height_mb_size
<<4è>=
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VD
, 
phy_video_¦Ù
->
video_size
, 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus))) {

5919 
	`TW_DBG
(
TW_DBG_ERR
, "heigh should smallhan vi\n");

5920 
»t
 = -
EINVAL
;

5924 
	`TW_DBG
(
TW_DBG_INFO
, "chªÃÈ%d, upd©width‡nd heighˆtØ(%d, %d)\n", 
h264_logic_’code_chª
->
logic_chª_id
, 
³ncode_·¿m
->
i_logic_video_width_mb_size
,…’code_·¿m->
i_logic_video_height_mb_size
);

5926 
	`TW_DBG
(
TW_DBG_ERR
, "need set height\n");

5927 
»t
 = -
EINVAL
;

5931 
pcÚfig
->
width
 = 
³ncode_·¿m
->
i_logic_video_width_mb_size
<<4;

5932 
pcÚfig
->
height
 = 
³ncode_·¿m
->
i_logic_video_height_mb_size
<<4;

5933 
pcÚfig
->
’codeSize
 = 
	`VIDEO_SIZE_FROM_WIDTH_HEIGHT
(
³ncode_·¿m
->
i_logic_video_width_mb_size
<<4,

5934 
³ncode_·¿m
->
i_logic_video_height_mb_size
<<4, 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus));

5935 
	`TW_DBG
(
TW_DBG_INFO
, "upd©videØsiz%d, width = %d, heighˆğ%d\n", 
pcÚfig
->
’codeSize
,

5936 
³ncode_·¿m
->
i_logic_video_width_mb_size
,…’code_·¿m->
i_logic_video_height_mb_size
);

5937 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_ENCODE_SIZE_CHANGED
;

5940 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, &
’code_cÚfigu¿tiÚ
);

5942 
TW_LOGIC_CHAN_ENABLE_SET
:

5944 
’code_cÚŒŞ
 = &
h264_logic_’code_chª
->encode_control;

5945 
	`’code_chª_g’_»q_msg
(
h264_logic_’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
NONBLOCK_OP
);

5946 if(
	`©omic_»ad
(&
’code_cÚŒŞ
->
’abË
)) {

5947 
	`TW_DBG
(
TW_DBG_ERR
, "chªÃÈ%d‡Ì—dƒÇbË\n", 
h264_logic_’code_chª
->
logic_chª_id
);

5948 
»t
 = 
TW_OK
;

5950 
	`©omic_£t
(&
’code_cÚŒŞ
->
’abË
, 1);

5952 
	`»gi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

5954 
	`TW_DBG
(
TW_DBG_INFO
, "chªÃÈ%d„eq REQ_ALGO_SLICE_HEAD\n", 
h264_logic_’code_chª
->
logic_chª_id
);

5955 
»t
 = 
TW_OK
;

5958 
	`driv”_g’_»sume_ev’t
(
İ’ed_logic_chª_ed
, 1);

5959 
»t
 = 
TW_OK
;

5962 
TW_LOGIC_CHAN_DISABLE_SET
:

5964 
’code_cÚŒŞ
 = &
h264_logic_’code_chª
->encode_control;

5965 if(
	`©omic_»ad
(&
’code_cÚŒŞ
->
’abË
) == 0) {

5966 
	`TW_DBG
(
TW_DBG_INFO
, "chªÃÈ%d‡Ì—dy di§bËd\n", 
h264_logic_’code_chª
->
logic_chª_id
);

5967 
»t
 = -
EPERM
;

5969 
	`©omic_£t
(&
’code_cÚŒŞ
->
’abË
, 0);

5971 
	`uÄegi¡”_İ’ed_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

5972 
»t
 = 
TW_OK
;

5975 
	`driv”_g’_su¥’d_ev’t
(
İ’ed_logic_chª_ed
, 1);

5976 
»t
 = 
TW_OK
;

5979 
TW_H264_ENCODE_FEATURE_SET
:

5980 if(!
¬g
) {

5981 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

5982  -
EINVAL
;

5984 if(
h264_logic_’code_chª
) {

5985 
tw_h264_’code_ã©u»_·¿m_t
 
h264_ã©u»
, *
pã©u»
 = &h264_feature;

5986 
tw_h264_’code_ã©u»_t
 *
´uÂšg_ã©u»
;

5988 
´uÂšg_ã©u»
 = &
’code_´İ”ty
->
’code_ã©u»
;

5989 
	`cİy_äom_u£r
(
pã©u»
, (*)
¬g
, (
tw_h264_’code_ã©u»_·¿m_t
));

5990 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
) {

5991 
´uÂšg_ã©u»
->
İ
->
	`upd©e_deš‹¾aû
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_deš‹¾aû
);

5993 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_SKIP_MASK
) {

5994 
´uÂšg_ã©u»
->
İ
->
	`upd©e_sk
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_sk
);

5996 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_I_4X4_MASK
) {

5997 
´uÂšg_ã©u»
->
İ
->
	`upd©e_i_4x4
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_I_4X4
);

5999 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENABLE_CHANGE_HALF_PIXEL_MASK
) {

6000 
´uÂšg_ã©u»
->
İ
->
	`upd©e_h®f_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_h®f_pix–
);

6002 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_QUARTER_PIXEL_MASK
) {

6003 
´uÂšg_ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
ÕruÂšg_ã©u», 
pã©u»
->
b_’abË_qu¬‹r_pix–
);

6005 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_MB_DELAY_MASK
) {

6006 if(
pã©u»
->
i_mb_d–ay_v®ue
) {

6007 if((
pã©u»
->
i_mb_d–ay_v®ue
 >ğ
MAX_MB_DELAY
è|| (pã©u»->i_mb_d–ay_v®u< 
MIN_MB_DELAY
)){

6008 
	`TW_DBG
(
TW_DBG_ERR
, "mb_d–ay %dƒ¼Ü, [%d, %d)\n", 
pã©u»
->
i_mb_d–ay_v®ue
, 
MIN_MB_DELAY
, 
MAX_MB_DELAY
);

6009 
»t
 = -
EINVAL
;

6012 
´uÂšg_ã©u»
->
İ
->
	`upd©e_mb_d–ay
ÕruÂšg_ã©u», 
pã©u»
->
i_mb_d–ay_v®ue
);

6014 
	`TW_DBG
(
TW_DBG_ERR
, "mb_d–ay 0x%xƒ¼Ü\n", 
pã©u»
->
i_mb_d–ay_v®ue
);

6015 
»t
 = -
EINVAL
;

6020 
»t
 = 
TW_OK
;

6023 
TW_H264_ENCODE_FEATURE_GET
:

6024 if(!
¬g
) {

6025 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6026  -
EINVAL
;

6028 if(
h264_logic_’code_chª
) {

6029 
tw_h264_’code_ã©u»_·¿m_t
 
h264_ã©u»
, *
pã©u»
 = &h264_feature;

6030 
tw_h264_’code_ã©u»_t
 *
´uÂšg_ã©u»
;

6032 
´uÂšg_ã©u»
 = &
’code_´İ”ty
->
’code_ã©u»
;

6033 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_DEINTERLACE_MASK
) {

6034 
pã©u»
->
b_’abË_deš‹¾aû
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_deš‹¾aû
(prunning_feature);

6036 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_SKIP_MASK
) {

6037 
pã©u»
->
b_’abË_sk
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_sk
(prunning_feature);

6039 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_I_4X4_MASK
) {

6040 
pã©u»
->
b_’abË_I_4X4
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_i_4x4
(prunning_feature);

6042 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENABLE_CHANGE_HALF_PIXEL_MASK
) {

6043 
pã©u»
->
b_’abË_h®f_pix–
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_h®f_pix–
(prunning_feature);

6045 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_QUARTER_PIXEL_MASK
) {

6046 
pã©u»
->
b_’abË_qu¬‹r_pix–
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_qu¬‹r_pix–
(prunning_feature);

6048 if(
pã©u»
->
chªge_mask_æag
 & 
TW_H264_ENCODE_FEATURE_ENABLE_CHANGE_MB_DELAY_MASK
) {

6049 
pã©u»
->
i_mb_d–ay_v®ue
 = 
´uÂšg_ã©u»
->
İ
->
	`g‘_mb_d–ay
(prunning_feature);

6052 
	`cİy_to_u£r
((*)
¬g
, 
pã©u»
, (
tw_h264_’code_ã©u»_·¿m_t
));

6053 
»t
 = 
TW_OK
;

6056 
TW_H264_ENCODE_RC_SET
:

6057 if(!
¬g
) {

6058 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6059  -
EINVAL
;

6061 if(
h264_logic_’code_chª
) {

6062 
tw_h264_’code_rc_t
 
rc
, *
p_rc
 = &rc, *
´uÂšg_rc
;

6064 
´uÂšg_rc
 = &
’code_´İ”ty
->
’code_rc
;

6065 
	`mem£t
(
pcÚfig
, 0, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

6066 
	`cİy_äom_u£r
(
p_rc
, (*)
¬g
, (
tw_h264_’code_rc_t
));

6067 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
 ) {

6068 if((
p_rc
->
e_image_´iÜ™y
 >ğ
TW_RC_IMAGE_QUALITY_FIRST
è&& (p_rc->e_image_´iÜ™y <ğ
TW_RC_IMAGE_SMOOTH_FIRST
)) {

6069 
´uÂšg_rc
->
e_image_´iÜ™y
 = 
p_rc
->e_image_priority;

6070 
´uÂšg_rc
->
chªge_mask_æag
 |ğ
TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
;

6072 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀimage_´iÜ™y %d\n", 
p_rc
->
e_image_´iÜ™y
);

6073 
»t
 = -
EINVAL
;

6076 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
) {

6077 if((
p_rc
->
e_rc_ty³
 >ğ
TW_H264_NO_RC
è&& (p_rc->e_rc_ty³ < 
TW_H264_VBR
)) {

6078 
´uÂšg_rc
->
e_rc_ty³
 = 
p_rc
->e_rc_type;

6079 
´uÂšg_rc
->
chªge_mask_æag
 |ğ
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
;

6081 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀrc_ty³ %d\n", 
p_rc
->
e_rc_ty³
);

6082 
»t
 = -
EINVAL
;

6085 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
) {

6086 
qp_mš
 = 
QUANT_SCALE_MIN
, 
qp_max
 = 
QUANT_SCALE_MAX
;

6087 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
) {

6088 if(
p_rc
->
e_rc_ty³
 =ğ
TW_H264_NO_RC
) {

6089 
qp_mš
 = 12;

6092 if((
p_rc
->
i_deçuÉ_qp
 >ğ
qp_mš
è&& (p_rc->i_deçuÉ_q°<ğ
qp_max
)) {

6093 
´uÂšg_rc
->
i_deçuÉ_qp
 = 
p_rc
->i_default_qp;

6094 
pcÚfig
->
qpi
 = 
p_rc
->
i_deçuÉ_qp
;

6095 
pcÚfig
->
chªgedMask
 |ğ
TW5864_ENCODE_CONFIG_QPI_CHANGED
;

6096 
´uÂšg_rc
->
chªge_mask_æag
 |ğ
TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
;

6098 
	`TW_DBG
(
TW_DBG_ERR
, "deçuÉ_q°%dƒ¼Ü, [%d, %d]\n", 
p_rc
->
i_deçuÉ_qp
, 
qp_mš
, 
qp_max
);

6099 
»t
 = -
EINVAL
;

6102 
’code_´İ”ty
->
İ
->
	`upd©e_’code_´İ”ty
Óncode_´İ”ty, 
pcÚfig
);

6105 
TW_H264_ENCODE_RC_GET
:

6106 if(!
¬g
) {

6107 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6108  -
EINVAL
;

6110 if(
h264_logic_’code_chª
) {

6111 
tw_h264_’code_rc_t
 
rc
, *
p_rc
 = &rc, *
´uÂšg_rc
;

6113 
´uÂšg_rc
 = &
’code_´İ”ty
->
’code_rc
;

6114 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_RC_TYPE_MASK
) {

6115 
p_rc
->
e_rc_ty³
 = 
´uÂšg_rc
->e_rc_type;

6117 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_IMAGE_PRIORITY_MASK
) {

6118 
p_rc
->
e_image_´iÜ™y
 = 
´uÂšg_rc
->e_image_priority;

6120 if(
p_rc
->
chªge_mask_æag
 & 
TW_H264_ENCODE_RC_ENABLE_CHANGE_DEFAULT_QP_MASK
) {

6121 
p_rc
->
i_deçuÉ_qp
 = 
´uÂšg_rc
->i_default_qp;

6124 
»t
 = 
TW_OK
;

6127 
TW_H264_ENCODE_RC_PARAM_SET
:

6128 
TW_H264_ENCODE_RC_PARAM_GET
:

6129 
	`TW_DBG
(
TW_DBG_ERR
, "not support\n");

6130 
»t
 = -
EPERM
;

6132 
TW_H264_ENCODE_CHAN_MAP_GET
:

6133 if(!
¬g
) {

6134 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6135  -
EINVAL
;

6137 if(
h264_logic_’code_chª
){

6138 
tw_h264_chª_m­_šfo
 
m­_šfo
, *
p_m­
 = &map_info;

6140 
p_m­
->
i_phy_chª_id
 = 
h264_logic_’code_chª
->
ma¡”_¦Ù
->
phy_¦Ù_id
;

6141 
p_m­
->
i_logic_chª_id
 = 
h264_logic_’code_chª
->
ma¡”_¦Ù
->
üoss_bus_logic_video_¦Ù
->
logicSlÙId
;

6143 
	`cİy_to_u£r
((*)
¬g
, 
p_m­
, (
tw_h264_chª_m­_šfo
));

6145 
»t
 = 
TW_OK
;

6147 
TW_LOGIC_CHAN_OSD_GET_PARAM
:

6148 if(
¬g
){

6149 
TW_OSD_PARAM
 *
osd_cÚfig_·¿m
;

6151 
osd_cÚfig_·¿m
 = &
h264_logic_’code_chª
->
’code_osd_’gše
.
osd_ruÂšg_·¿m
;

6152 
	`cİy_to_u£r
((*)
¬g
, 
osd_cÚfig_·¿m
, (
TW_OSD_PARAM
));

6154 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6155  -
EINVAL
;

6158 
TW_LOGIC_CHAN_OSD_SET_PARAM
:

6159 if(
¬g
){

6160 
TW_OSD_PARAM
 *
osd_cÚfig_·¿m
, 
cÚfig_·¿m
;

6161 
osd_chª_’gše_t
 *
’gše
;

6162 
u32
 
width
 , 
height
;

6164 
osd_cÚfig_·¿m
 = &
cÚfig_·¿m
;

6165 
	`cİy_äom_u£r
(
osd_cÚfig_·¿m
, (*)
¬g
, (
TW_OSD_PARAM
));

6167 
’gše
 = &
h264_logic_’code_chª
->
’code_osd_’gše
;

6168 
width
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize_width
(encode_property);

6169 
height
 = 
’code_´İ”ty
->
İ
->
	`g‘_’codeSize_height
(encode_property);

6171 
osd_cÚfig_·¿m
->
Çme
[
NAME_LEN
 - 1] = '\0';

6172 if((
osd_cÚfig_·¿m
->
Çme_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->Çme_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6173 
	`TW_DBG
(
TW_DBG_ERR
, "osd‚ame_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6174 
OSD_FAILED
;

6176 if(
osd_cÚfig_·¿m
->
Çme_pos_x
 >ğ
width
) {

6177 
	`TW_DBG
(
TW_DBG_ERR
, "osd‚ame_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
Çme_pos_x
, 
width
);

6178 
OSD_FAILED
;

6180 if(
osd_cÚfig_·¿m
->
Çme_pos_y
 >ğ
height
) {

6181 
	`TW_DBG
(
TW_DBG_ERR
, "osd‚ame_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
Çme_pos_y
, 
height
);

6182 
OSD_FAILED
;

6185 if((
osd_cÚfig_·¿m
->
time_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->time_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6186 
	`TW_DBG
(
TW_DBG_ERR
, "osdime_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6187 
OSD_FAILED
;

6189 if(
osd_cÚfig_·¿m
->
time_pos_x
 >ğ
width
) {

6190 
	`TW_DBG
(
TW_DBG_ERR
, "osdime_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
time_pos_x
, 
width
);

6191 
OSD_FAILED
;

6193 if(
osd_cÚfig_·¿m
->
time_pos_y
 >ğ
height
) {

6194 
	`TW_DBG
(
TW_DBG_ERR
, "osdime_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
time_pos_y
, 
height
);

6195 
OSD_FAILED
;

6198 if((
osd_cÚfig_·¿m
->
sh–‹r1_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->sh–‹r1_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6199 
	`TW_DBG
(
TW_DBG_ERR
, "osd shelter1_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6200 
OSD_FAILED
;

6202 if((
osd_cÚfig_·¿m
->
sh–‹r1_pos_x
 >ğ
width
è|| ((osd_cÚfig_·¿m->sh–‹r1_pos_x + osd_cÚfig_·¿m->
sh–‹r1_width
) >width)

6203 ||(
osd_cÚfig_·¿m
->
sh–‹r1_pos_y
 >ğ
height
è|| ((osd_cÚfig_·¿m->sh–‹r1_pos_y + osd_cÚfig_·¿m->
sh–‹r1_height
) >height)) {

6204 
	`TW_DBG
(
TW_DBG_ERR
, "osd sh–‹r1„egiÚ (%d, %d, %d, %dèov”æow\n", 
osd_cÚfig_·¿m
->
sh–‹r1_pos_x
,

6205 
osd_cÚfig_·¿m
->
sh–‹r1_pos_y
, osd_cÚfig_·¿m->
sh–‹r1_width
, osd_cÚfig_·¿m->
sh–‹r1_height
);

6206 
OSD_FAILED
;

6209 if((
osd_cÚfig_·¿m
->
sh–‹r2_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->sh–‹r2_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6210 
	`TW_DBG
(
TW_DBG_ERR
, "osd shelter2_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6211 
OSD_FAILED
;

6213 if((
osd_cÚfig_·¿m
->
sh–‹r2_pos_x
 >ğ
width
è|| ((osd_cÚfig_·¿m->sh–‹r2_pos_x + osd_cÚfig_·¿m->
sh–‹r2_width
) >width)

6214 ||(
osd_cÚfig_·¿m
->
sh–‹r2_pos_y
 >ğ
height
è|| ((osd_cÚfig_·¿m->sh–‹r2_pos_y + osd_cÚfig_·¿m->
sh–‹r2_height
) >height)) {

6215 
	`TW_DBG
(
TW_DBG_ERR
, "osd sh–‹r2„egiÚ (%d, %d, %d, %dèov”æow\n", 
osd_cÚfig_·¿m
->
sh–‹r2_pos_x
,

6216 
osd_cÚfig_·¿m
->
sh–‹r2_pos_y
, osd_cÚfig_·¿m->
sh–‹r2_width
, osd_cÚfig_·¿m->
sh–‹r2_height
);

6217 
OSD_FAILED
;

6220 
osd_cÚfig_·¿m
->
subt™Ë1
[
SUB_LEN
 - 1] = '\0';

6221 if((
osd_cÚfig_·¿m
->
subt™Ë1_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->subt™Ë1_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6222 
	`TW_DBG
(
TW_DBG_ERR
, "osd subtitle1_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6223 
OSD_FAILED
;

6225 if(
osd_cÚfig_·¿m
->
subt™Ë1_pos_x
 >ğ
width
) {

6226 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë1_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë1_pos_x
, 
width
);

6227 
OSD_FAILED
;

6229 if(
osd_cÚfig_·¿m
->
subt™Ë1_pos_y
 >ğ
height
) {

6230 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë1_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë1_pos_y
, 
height
);

6231 
OSD_FAILED
;

6234 
osd_cÚfig_·¿m
->
subt™Ë2
[
SUB_LEN
 - 1] = '\0';

6235 if((
osd_cÚfig_·¿m
->
subt™Ë2_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->subt™Ë2_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6236 
	`TW_DBG
(
TW_DBG_ERR
, "osd subtitle2_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6237 
OSD_FAILED
;

6239 if(
osd_cÚfig_·¿m
->
subt™Ë2_pos_x
 >ğ
width
) {

6240 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë2_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë2_pos_x
, 
width
);

6241 
OSD_FAILED
;

6243 if(
osd_cÚfig_·¿m
->
subt™Ë2_pos_y
 >ğ
height
) {

6244 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë2_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë2_pos_y
, 
height
);

6245 
OSD_FAILED
;

6248 
osd_cÚfig_·¿m
->
subt™Ë3
[
SUB_LEN
 - 1] = '\0';

6249 if((
osd_cÚfig_·¿m
->
subt™Ë3_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->subt™Ë3_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6250 
	`TW_DBG
(
TW_DBG_ERR
, "osd subtitle3_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6251 
OSD_FAILED
;

6253 if(
osd_cÚfig_·¿m
->
subt™Ë3_pos_x
 >ğ
width
) {

6254 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë3_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë3_pos_x
, 
width
);

6255 
OSD_FAILED
;

6257 if(
osd_cÚfig_·¿m
->
subt™Ë3_pos_y
 >ğ
height
) {

6258 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë3_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë3_pos_y
, 
height
);

6259 
OSD_FAILED
;

6262 
osd_cÚfig_·¿m
->
subt™Ë4
[
SUB_LEN
 - 1] = '\0';

6263 if((
osd_cÚfig_·¿m
->
subt™Ë4_©Œib
 !ğ
OSD_ATTR_DISPLAY_ON
è&& (osd_cÚfig_·¿m->subt™Ë4_©Œib !ğ
OSD_ATTR_DISPLAY_OFF
)){

6264 
	`TW_DBG
(
TW_DBG_ERR
, "osd subtitle4_attribƒrror, only support OSD_ATTR_DISPLAY_ON, OSD_ATTR_DISPLAY_OFF");

6265 
OSD_FAILED
;

6267 if(
osd_cÚfig_·¿m
->
subt™Ë4_pos_x
 >ğ
width
) {

6268 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë4_pos_x %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë4_pos_x
, 
width
);

6269 
OSD_FAILED
;

6271 if(
osd_cÚfig_·¿m
->
subt™Ë4_pos_y
 >ğ
height
) {

6272 
	`TW_DBG
(
TW_DBG_ERR
, "osd subt™Ë4_pos_y %d ov”æow, should sm®Èthª %d\n", 
osd_cÚfig_·¿m
->
subt™Ë4_pos_y
, 
height
);

6273 
OSD_FAILED
;

6275 
’gše
->
İ
->
	`upd©e_’code_osd_´İ”ty
Óngše, 
osd_cÚfig_·¿m
);

6276  
TW_OK
;

6277 
OSD_FAILED
:

6278  -
EINVAL
;

6280 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

6281  -
EINVAL
;

6285  -
ENODEV
;

6288  
»t
;

6289 
	}
}

6291 
	$h264_’code_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
İ’ed_logic_chª_ed
)

6293 
»t
 = 
TW_ED_UNREGISTER
;

6294 if(
İ’ed_logic_chª_ed
 !ğ
NULL
){

6295 
»t
 = 
	`©omic_»ad
(&
İ’ed_logic_chª_ed
->
¡©e
);

6297  
»t
;

6298 
	}
}

6300 
hcd_š‹rçû_İ”©iÚ
 
	gh264_’code_hcd_š‹rçû_İ
 = {

6301 .
İ’
 = 
h264_’code_hcd_š‹rçû_İ’
,

6302 .
	gşo£
 = 
h264_’code_hcd_š‹rçû_şo£
,

6303 .
	gsu¥’d
 = 
h264_’code_hcd_š‹rçû_su¥’d
,

6304 .
	g»sume
 = 
h264_’code_hcd_š‹rçû_»sume
,

6305 .
	gioùl
 = 
h264_’code_hcd_š‹rçû_ioùl
,

6306 .
	gg‘_¡©e
 = 
h264_’code_hcd_š‹rçû_g‘_¡©e
,

6309 
	$h264_logic_’code_chª_driv”_nÙify_my£lf
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
tw_nÙify_msg
 *
msg
)

6311 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

6314 
	}
}

6316 
	$h264_logic_’code_chª_driv”_m©ch_id
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
logic_chª_id
)

6318 
»t
 = 
TW_ERR
;

6319 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

6320 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = (tw_h264_logic_’code_chª_t*)
´iv
;

6321 if(
h264_logic_’code_chª
->
logic_chª_id
 ==†ogic_chan_id){

6322 
»t
 = 
TW_OK
;

6325  
»t
;

6326 
	}
}

6329 
	#li¡_fÜ_—ch_h264
(
logic_chª
, 
h264_´İ”ty
, 
phy_¦Ù
, 
logic_¦Ù
, \

6330 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6331 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£_logic_chª
) \

6332 
logic_chª
 = 
ba£_logic_chª
; \

6333 ((
logic_chª
 - 
ba£_logic_chª
è< 
TW5864_PHY_VD_CHAN_NUMBER
) && (\

6334 (
’code_ã©u»
 = &
logic_chª
->
’code_´İ”ty
.encode_feature), \

6335 (
’code_rc
 = &
logic_chª
->
’code_´İ”ty
.encode_rc), \

6336 (
h264_´İ”ty
 = &
logic_chª
->
’code_´İ”ty
.encode_property), \

6337 (
phy_¦Ù
 = 
logic_chª
->
ma¡”_¦Ù
)) && \

6338 (
phy_¦Ù
) && \

6339 (
logic_¦Ù
 = 
phy_¦Ù
->
üoss_bus_logic_video_¦Ù
, \

6340 (
vd_Üig
 = &
phy_¦Ù
->
vd_Üig_buf
), \

6341 (
’code_cÚŒŞ
 = &
logic_chª
->encode_control), \

6342 (
’code_äame_queue
 = &
logic_chª
->encode_frame_queue), \

6343 (
video_chª_buf_poŞ
 = &
logic_chª
->
’code_chª_buf_poŞ
)è&& (
logic_¦Ù
); \

6344 
logic_chª
++)

	)

6346 
	$h264_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

6347 
couÁ
, *
eof
, *
d©a
)

6349 
Ën
 = 0, 
i
 = 0, 
issub
 = 0;

6350 
dvm_ch_t
 *
ch
;

6351 
tw_h264_logic_’code_chª_t
 *
h264_maš
, *
ba£
;

6352 
tw_h264_logic_’code_chª_t
 *
h264_sub
;

6353 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
h264_cÚfig
;

6355 
tw_vd_Üig_buf_šfo_t
 *
vd_Üig
;

6356 
tw_h264_phy_video_¦Ù_t
 *
phy_¦Ù
;

6357 
tw_h264_logic_video_¦Ù_t
 *
logic_¦Ù
;

6358 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

6359 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

6360 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
;

6361 
tw_h264_’code_ã©u»_t
 *
’code_ã©u»
;

6362 
tw_h264_’code_rc_t
 *
’code_rc
;

6364 
h264_maš
 = (
tw_h264_logic_’code_chª_t
 *)
d©a
;

6365 
h264_sub
 = 
h264_maš
->
ch
->
h264_sub_’code_logic_chª
;

6367 
ch
 = 
h264_maš
->chip;

6368 
ba£
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

6372 
»Œy
:

6374 
Ën
 +ğ
	`¥rštf
(
·ge
+len, "%8s %8s %8s %8s %8s", "=====>ch", "phy", "logic", "type", "read_bitstream_mode\n");

6375 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6376 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6377 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6378 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6381 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %8d %8d %8 %8s\n",
i
++,

6382 
h264_maš
->
phy_¦Ù_id
,

6383 
h264_maš
->
logic_chª_id
,

6384 (
h264_maš
->
ty³
 =ğ
TW_MASTER_BITSTREAM
)?"MAIN":"SUB",

6385 (
h264_maš
->
»ad_b™¡»am_mode
 =ğ
READ_H264_BITSTREAM_BY_DDR
)?"DDR":"RAM");

6387 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s %8s\n", "Dterlace", "SMV", "MVA",

6389 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6390 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6391 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6392 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6395 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d %8d %8d %8d %8d %8d %8d %8d\n",

6396 
’code_ã©u»
->
İ
->
	`g‘_deš‹¾aû
(encode_feature),

6397 
h264_cÚfig
->
’abËSubm™MÙiÚVeùÜ
,

6398 
h264_cÚfig
->
’abËMÙiÚVeùÜAÇly£s
,

6399 
h264_cÚfig
->
’codeSize
,

6400 
h264_cÚfig
->
width
,

6401 
h264_cÚfig
->
height
,

6402 
h264_cÚfig
->
b™¿‹
,

6403 
h264_cÚfig
->
ås
);

6407 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s %8s\n", "I", "gop",

6409 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6410 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6411 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6412 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6415 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d %8d %8d %8d %8d %8d %8d %8d\n",

6416 
h264_cÚfig
->
keyF¿meIÁ”v®s
,

6417 
h264_cÚfig
->
gİIÁ”v®s
,

6418 
h264_cÚfig
->
´i
,

6419 
’code_rc
->
e_rc_ty³
,

6420 
h264_cÚfig
->
imageLev–
,

6421 
h264_cÚfig
->
qpi
,

6422 
h264_cÚfig
->
qµ
,

6423 
h264_cÚfig
->
qpb
);

6427 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "encode feature:\n");

6428 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s\n", "deinterlace", "1/2", "1/4", "i_4x4", "skip", "MBDELAY");

6429 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6430 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6431 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6432 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6435 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8d\n",

6436 
’code_ã©u»
->
İ
->
	`g‘_deš‹¾aû
(encode_feature)? "ON":"OFF",

6437 
’code_ã©u»
->
İ
->
	`g‘_h®f_pix–
(encode_feature)? "ON":"OFF",

6438 
’code_ã©u»
->
İ
->
	`g‘_qu¬‹r_pix–
(encode_feature)? "ON":"OFF",

6439 
’code_ã©u»
->
İ
->
	`g‘_i_4x4
(encode_feature)? "ON":"OFF",

6440 
’code_ã©u»
->
İ
->
	`g‘_sk
(encode_feature)? "ON":"OFF",

6441 
’code_ã©u»
->
İ
->
	`g‘_mb_d–ay
(encode_feature));

6445 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "phy video slot info:\n");

6446 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s", "slot_id", "bus_id", "logic_id", "size", "discard_table", "soft_discard_table\n");

6447 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6448 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6449 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6450 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6453 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d%8d%8d%8d 0x%08x 0x%08x\n",

6454 
phy_¦Ù
->
phy_¦Ù_id
,

6455 
phy_¦Ù
->
phy_bus_id
,

6456 
phy_¦Ù
->
m­_logic_id
,

6457 
phy_¦Ù
->
video_size
,

6458 
logic_¦Ù
->
disÿrdTabË
,

6459 
’code_cÚŒŞ
->
i_soáw¬e_disÿrd_äame_bË
);

6462 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "encoder status:\n");

6463 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s %8s %8s %8s %8s %8s\n", "int", "AD_ready", "BlkCnt", "FrmCnt", "FrmQue", "fps", "slice", "state", "checkad", "max_int", "cur_int", "min_int");

6464 
	`li¡_fÜ_—ch_h264
(
h264_maš
, 
h264_cÚfig
, 
phy_¦Ù
, 
logic_¦Ù
, \

6465 
’code_cÚŒŞ
, 
’code_äame_queue
, 
video_chª_buf_poŞ
, \

6466 
’code_ã©u»
, 
’code_rc
, 
vd_Üig
, 
ba£
){

6467 if(
	`©omic_»ad
(&
h264_maš
->
İ’ed_æag
) == 0){

6470 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %8d %8d %8d %8d %8d %8d %8d %8d %8d %8d %8d\n", 
’code_cÚŒŞ
->
i_åm
,ƒncode_cÚŒŞ->
ad_»ady
,

6471 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_·ck‘_tcb_poŞ_’Œy_numb”
(video_chan_buf_pool),

6472 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_äame_tcb_poŞ_’Œy_numb”
(video_chan_buf_pool),

6473 
’code_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(encode_frame_queue),

6474 
’code_cÚŒŞ
->
i_cu¼_ås
,

6475 
	`©omic_»ad
(&
’code_cÚŒŞ
->
¦iû_h—d_ªd_ad_¡©us
),

6476 
h264_maš
->
İ’ed_logic_chª_ed
.
İ
->
	`g‘_¡©e
(&h264_main->opened_logic_chan_ed),

6477 
	`©omic_»ad
(&
phy_¦Ù
->
vd_Üig_buf
.
¡İ_check_ad
),

6478 
’code_cÚŒŞ
->
’code_d–
.
max_d–
,

6479 
’code_cÚŒŞ
->
’code_d–
.
cur_d–
,

6480 
’code_cÚŒŞ
->
’code_d–
.
mš_d–
);

6482 if(
issub
 == 0) {

6483 
issub
 = 1;

6484 
ba£
 = 
ch
->
h264_sub_’code_logic_chª
;

6485 
»Œy
;

6487 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "s_Úly_i_4x4 = %d\n", 
s_Úly_i_4x4
);

6491  
Ën
;

6492 
	}
}

6493 
	eSTATISTIC_MODE
{

6494 
	mSTATISTIC_MODE_0
 = 0,

6495 
	mSTATISTIC_MODE_1
,

6496 
	mSTATISTIC_MODE_2
,

6497 
	mSTATISTIC_MODE_3
,

6498 
	mSTATISTIC_MODE_4
,

6499 
	mSTATISTIC_MODE_5
,

6500 
	mSTATISTIC_MODE_6
,

6501 
	mSTATISTIC_MODE_7
,

6502 
	mSTATISTIC_MODE_8
,

6503 
	mSTATISTIC_MODE_9
,

6504 
	mSTATISTIC_MODE_10
,

6505 
	mSTATISTIC_MODE_11
,

6506 
	mSTATISTIC_MODE_12
,

6507 
	mSTATISTIC_MODE_13
,

6508 
	mSTATISTIC_MODE_ALL_OFF
,

6512 
STATISTIC_MODE
 
	gs_‹¡_¡©i¡ic
 = 
STATISTIC_MODE_0
;

6513 
tim”_li¡
 
	g¡©i¡ics_tim”
;

6514 
	g¡©i¡ics_tim”_id
 = 
INVALIDTIMERID
;

6515 
	$¡©i¡ics_h264_ã©u»
(*
cÚ‹xt
)

6517 
tw_h264_’code_ã©u»_t
 *
ã©u»
;

6518 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

6519 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”
, *
h264_sub
, *
ba£
, *
logic_chª
;

6520 
tw_h264_’code_ã©u»_·¿m_t
 
ma¡”_’code_ã©u»
, 
sub_’code_ã©u»
;

6521 
max_št
, 
mš_št
, 
cur_št
, 
ås
, 
chªÃl
;

6522 
dvm_ch_t
 *
ch
 = (dvm_ch_ˆ*)
cÚ‹xt
;

6524 
h264_ma¡”
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

6525 
h264_sub
 = 
ch
->
h264_sub_’code_logic_chª
;

6527 
	`mem£t
(&
ma¡”_’code_ã©u»
, 0, (
tw_h264_’code_ã©u»_·¿m_t
));

6528 
	`mem£t
(&
sub_’code_ã©u»
, 0, (
tw_h264_’code_ã©u»_·¿m_t
));

6530 
max_št
 = 0;

6531 
mš_št
 = 79879874;

6532 
chªÃl
 = 0;

6533 
ås
 = 0;

6534 
cur_št
 = 0;

6535 
logic_chª
 = 
h264_ma¡”
; (logic_chª - h264_ma¡”è< 
TW5864_PHY_VD_CHAN_NUMBER
;†ogic_chan++) {

6536 if(
logic_chª
 && 
	`©omic_»ad
(&logic_chª->
İ’ed_æag
) == 0){

6539 
’code_cÚŒŞ
 = &
logic_chª
->encode_control;

6540 
max_št
 = 
	`H264_MAX
(max_št, 
’code_cÚŒŞ
->
’code_d–
.
max_d–
);

6541 
mš_št
 = 
	`H264_MIN
(mš_št, 
’code_cÚŒŞ
->
’code_d–
.
mš_d–
);

6542 
cur_št
 +ğ
’code_cÚŒŞ
->
’code_d–
.
cur_d–
;

6543 
ås
 +ğ
’code_cÚŒŞ
->
i_cu¼_ås
;

6544 
chªÃl
++;

6546 
cur_št
 = cur_šˆ/ 
chªÃl
;

6547 
ås
 = fp / 
chªÃl
;

6548 
	`´štk
("------->mod%d<---------\n", 
s_‹¡_¡©i¡ic
);

6549 
	`´štk
("ma¡”:max %5d, mš %5d ,‡vg %5d, fp %5d\n", 
max_št
, 
mš_št
, 
cur_št
, 
ås
);

6550 
max_št
 = 0;

6551 
mš_št
 = 79879874;

6552 
chªÃl
 = 0;

6553 
ås
 = 0;

6554 
cur_št
 = 0;

6555 
logic_chª
 = 
h264_sub
; (logic_chª - h264_subè< 
TW5864_PHY_VD_CHAN_NUMBER
;†ogic_chan++) {

6556 if(
logic_chª
 && 
	`©omic_»ad
(&logic_chª->
İ’ed_æag
) == 0){

6559 
’code_cÚŒŞ
 = &
logic_chª
->encode_control;

6560 
max_št
 = 
	`H264_MAX
(max_št, 
’code_cÚŒŞ
->
’code_d–
.
max_d–
);

6561 
mš_št
 = 
	`H264_MIN
(mš_št, 
’code_cÚŒŞ
->
’code_d–
.
mš_d–
);

6562 
cur_št
 +ğ
’code_cÚŒŞ
->
’code_d–
.
cur_d–
;

6563 
ås
 +ğ
’code_cÚŒŞ
->
i_cu¼_ås
;

6564 
chªÃl
++;

6566 
cur_št
 = cur_šˆ/ 
chªÃl
;

6567 
ås
 = fp / 
chªÃl
;

6568 
	`´štk
("¦ave:max %5d, mš %5d ,‡vg %5d, fp %5d\n", 
max_št
, 
mš_št
, 
cur_št
, 
ås
);

6570 
s_‹¡_¡©i¡ic
) {

6571 
STATISTIC_MODE_0
:

6572 
s_Úly_i_4x4
 = 0;

6573 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6574 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6575 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6576 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6577 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 0;

6579 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6580 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6581 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6582 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6583 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6585 
STATISTIC_MODE_1
:

6586 
s_Úly_i_4x4
 = 1;

6587 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6588 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6589 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6590 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6591 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 0;

6593 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6594 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6595 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6596 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6597 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6599 
STATISTIC_MODE_2
:

6600 
s_Úly_i_4x4
 = 0;

6601 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6602 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6603 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6604 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6605 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 0;

6607 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6608 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6609 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6610 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6611 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6613 
STATISTIC_MODE_3
:

6614 
s_Úly_i_4x4
 = 1;

6615 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6616 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6617 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6618 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6619 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 0;

6621 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6622 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6623 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6624 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6625 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6627 
STATISTIC_MODE_4
:

6628 
s_Úly_i_4x4
 = 1;

6629 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6630 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6631 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6632 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6633 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6635 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6636 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6637 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6638 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6639 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6641 
STATISTIC_MODE_5
:

6642 
s_Úly_i_4x4
 = 1;

6643 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6644 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6645 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6646 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6647 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6649 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6650 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6651 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6652 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6653 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6655 
STATISTIC_MODE_6
:

6656 
s_Úly_i_4x4
 = 1;

6657 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6658 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6659 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6660 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6661 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6663 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6664 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6665 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6666 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6667 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6669 
STATISTIC_MODE_7
:

6670 
s_Úly_i_4x4
 = 1;

6671 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6672 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6673 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6674 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6675 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6677 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6678 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6679 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6680 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6681 
sub_’code_ã©u»
.
b_’abË_sk
 = 1;

6683 
STATISTIC_MODE_8
:

6684 
s_Úly_i_4x4
 = 1;

6685 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6686 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6687 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6688 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6689 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6691 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6692 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6693 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 0;

6694 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6695 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6697 
STATISTIC_MODE_9
:

6698 
s_Úly_i_4x4
 = 1;

6699 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6700 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6701 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6702 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6703 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6705 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6706 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6707 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6708 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6709 
sub_’code_ã©u»
.
b_’abË_sk
 = 1;

6711 
STATISTIC_MODE_10
:

6712 
s_Úly_i_4x4
 = 0;

6713 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6714 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6715 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6716 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6717 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6719 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6720 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6721 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6722 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6723 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6725 
STATISTIC_MODE_11
:

6726 
s_Úly_i_4x4
 = 0;

6727 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6728 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6729 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6730 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6731 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6733 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 0;

6734 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 0;

6735 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6736 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 0;

6737 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6739 
STATISTIC_MODE_12
:

6740 
s_Úly_i_4x4
 = 0;

6741 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6742 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6743 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6744 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6745 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 1;

6747 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6748 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6749 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6750 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6751 
sub_’code_ã©u»
.
b_’abË_sk
 = 1;

6753 
STATISTIC_MODE_13
:

6754 
s_Úly_i_4x4
 = 0;

6755 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6756 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6757 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6758 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6759 
ma¡”_’code_ã©u»
.
b_’abË_sk
 = 0;

6761 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
 = 1;

6762 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
 = 1;

6763 
sub_’code_ã©u»
.
b_’abË_I_4X4
 = 1;

6764 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 1;

6765 
sub_’code_ã©u»
.
b_’abË_sk
 = 0;

6771 if(
s_‹¡_¡©i¡ic
 > 
STATISTIC_MODE_ALL_OFF
) {

6772 
	`´štk
("all over\n");

6775 
s_‹¡_¡©i¡ic
++;

6776 
ba£
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

6777 
logic_chª
 = 
ba£
; (logic_chª - ba£è< 
TW5864_PHY_VD_CHAN_NUMBER
;†ogic_chan++){

6778 if(
logic_chª
 && 
	`©omic_»ad
(&logic_chª->
İ’ed_æag
) == 0){

6781 
ã©u»
 = &
logic_chª
->
’code_´İ”ty
.
’code_ã©u»
;

6782 
ã©u»
->
İ
->
	`upd©e_deš‹¾aû
(ã©u», 
ma¡”_’code_ã©u»
.
b_’abË_deš‹¾aû
);

6783 
ã©u»
->
İ
->
	`upd©e_sk
(ã©u», 
ma¡”_’code_ã©u»
.
b_’abË_sk
);

6784 
ã©u»
->
İ
->
	`upd©e_i_4x4
(ã©u», 
ma¡”_’code_ã©u»
.
b_’abË_I_4X4
);

6785 
ã©u»
->
İ
->
	`upd©e_h®f_pix–
(ã©u», 
ma¡”_’code_ã©u»
.
b_’abË_h®f_pix–
);

6786 
ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
(ã©u», 
ma¡”_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
);

6788 
ba£
 = 
ch
->
h264_sub_’code_logic_chª
;

6789 
logic_chª
 = 
ba£
; (logic_chª - ba£è< 
TW5864_PHY_VD_CHAN_NUMBER
;†ogic_chan++){

6790 if(
logic_chª
 && 
	`©omic_»ad
(&logic_chª->
İ’ed_æag
) == 0){

6793 
ã©u»
 = &
logic_chª
->
’code_´İ”ty
.
’code_ã©u»
;

6794 
ã©u»
->
İ
->
	`upd©e_deš‹¾aû
(ã©u», 
sub_’code_ã©u»
.
b_’abË_deš‹¾aû
);

6795 
ã©u»
->
İ
->
	`upd©e_sk
(ã©u», 
sub_’code_ã©u»
.
b_’abË_sk
);

6796 
ã©u»
->
İ
->
	`upd©e_i_4x4
(ã©u», 
sub_’code_ã©u»
.
b_’abË_I_4X4
);

6797 
ã©u»
->
İ
->
	`upd©e_h®f_pix–
(ã©u», 
sub_’code_ã©u»
.
b_’abË_h®f_pix–
);

6798 
ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
(ã©u», 
sub_’code_ã©u»
.
b_’abË_qu¬‹r_pix–
);

6802 
¡©i¡ics_tim”
.
funùiÚ
 = 
¡©i¡ics_h264_ã©u»
;

6803 
¡©i¡ics_tim”
.
d©a
 = 
ch
;

6804 
¡©i¡ics_tim”
.
expœes
 = 
jiff›s
 + (1000/
HZ
) * 1000 * 20;

6805 
	`add_tim”
(&
¡©i¡ics_tim”
);

6807 
¡©i¡ics_tim”_id
 = 
	`AddSšgËFœeTim”Job
((
TIMER_1_MINUTE
), 
¡©i¡ics_h264_ã©u»
, 
ch
);

6808 if(
¡©i¡ics_tim”_id
 =ğ
INVALIDTIMERID
) {

6809 
	`´štk
("addimerƒrror\n");

6814 
	}
}

6816 
New_R—d_OÃ_F¿me_äom_DDR
(
tw_h264_logic_’code_chª_t
* 
’cod”
,
u16
 
F¿meIdx
, u16 
chªÃl
,
u8
 *
buf
, 
u32
 *
Ën
);

6817 
	$h264_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

6818 
couÁ
, *
d©a
)

6820 
tw_h264_logic_’code_chª_t
 *
h264
 = (tw_h264_logic_’code_chª_ˆ*)
d©a
;

6821 
cmdbuf
[1024];

6822 **
¬gv
;

6823 
¬gc
, 
i
, 
ch
, 
út
;

6824 
dvm_ch_t
 *
ch
;

6825 *
f’ame
;

6827 
	`mem£t
(
cmdbuf
, 0, 1024);

6828 if(
couÁ
 > 1024){

6829 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 1024);

6832 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 
couÁ
);

6834 
¬gv
 = 
	`¬gv_¥l™
(
GFP_KERNEL
, 
cmdbuf
, &
¬gc
);

6835 
i
 = 0; i < (
¬gc
); i++)

6837 
	`TW_DBG
(
TW_DBG_INFO
, "cmd %d: %s\n", 
i
, 
¬gv
[i]);

6839 
f’ame
 = 
¬gv
[1];

6840 
ch
 = 
h264
->chip;

6842 if(
	`¡rcmp
(
¬gv
[0], "user_yuv") == 0)

6844 if((
¬gv
[1] =ğ
NULL
) || (argv[2] == NULL))

6846 
	`´štk
("no yuv file!\n");

6847 
cmd_’d
;

6849 if(!
¬gv
[3]){

6850 
út
 = 4;

6852 
út
 = 
	`©oi
(
¬gv
[3]);

6854 
	`tw_h264_hªdË_u£r_q
(
ch
, 
h264
, 
f’ame
, 
¬gv
[2], 
út
);

6856 if(
	`¡rcmp
(
¬gv
[0], "read_yuv") == 0)

6858 
u32
 
Ën
, 
size
;

6859 
fe
 *
yuv_fe
 = 
NULL
;

6860 
mm_£gm’t_t
 
fs
;

6861 *
yuv_buf
 = 
NULL
;

6862 if((
¬gv
[1] =ğ
NULL
) || (argv[2] == NULL))

6864 
	`´štk
("no channel id‡nd buffer id\n");

6865 
cmd_’d
;

6867 
ch
 = 
	`©oi
(
¬gv
[1]);

6868 
út
 = 
	`©oi
(
¬gv
[2]);

6870 
yuv_buf
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

6871 
h264
 +ğ
ch
;

6872 
	`New_R—d_OÃ_F¿me_äom_DDR
(
h264
, 
út
, 
ch
, 
yuv_buf
, &
Ën
);

6873 
size
 = 704 * 576 * 3 / 2;

6875 
yuv_fe
 = 
	`fp_İ’
(
¬gv
[3], 
O_RDONLY
, 655);

6876 
fs
=
	`g‘_fs
();

6877 
	`£t_fs
(
KERNEL_DS
);

6878 
Ën
 = 
yuv_fe
->
f_İ
->
	`wr™e
(yuv_fe, 
yuv_buf
, 
size
, &(yuv_fe->
f_pos
));

6879 
	`£t_fs
(
fs
);

6880 if(
yuv_buf
)

6881 
	`ä“_·ges
(()
yuv_buf
, 
	`g‘_Üd”
(
size
));

6882 
	`fp_şo£
(
yuv_fe
, 
NULL
);

6884 if(
	`¡rcmp
(
¬gv
[0], "ch") == 0)

6886 
ch
 = 
	`©oi
(
¬gv
[2]);

6887 
h264
 +ğ
ch
;

6888 
	`tw_h264_§ve_chn
(
h264
, 
¬gv
[1]);

6889 }if(
	`¡rcmp
(
¬gv
[0], "config") == 0){

6890 
tw_h264_’code_ã©u»_·¿m_t
 
’code_ã©u»
;

6891 
tw_h264_’code_ã©u»_t
 *
ã©u»
;

6892 
tw_h264_logic_’code_chª_t
 *
ba£
, *
logic_chª
;

6893 
isÚ
;

6895 if(
	`¡rcmp
(
¬gv
[1], "master") == 0){

6896 
ba£
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

6897 
	`memıy
(&
’code_ã©u»
, &
deçuÉ_maš_’code_ã©u»
, (
tw_h264_’code_ã©u»_·¿m_t
));

6899 
ba£
 = 
ch
->
h264_sub_’code_logic_chª
;

6900 
	`memıy
(&
’code_ã©u»
, &
deçuÉ_sub_’code_ã©u»
, (
tw_h264_’code_ã©u»_·¿m_t
));

6902 
i
 = 2; i < 
¬gc
; i++) {

6903 
isÚ
 = (
	`¡rcmp
(
¬gv
[
i
], "ON") == 0) || (strcmp(argv[i], "on") == 0);

6904 
i
) {

6905 2:
’code_ã©u»
.
b_’abË_deš‹¾aû
 = 
isÚ
; 
	`´štk
("deš‹¿lû=% ", 
¬gv
[2]); ;

6906 3:
’code_ã©u»
.
b_’abË_sk
 = 
isÚ
; 
	`´štk
("sk=% ", 
¬gv
[3]); ;

6907 4:
’code_ã©u»
.
b_’abË_I_4X4
 = 
isÚ
; 
	`´štk
("I_4x4=% ", 
¬gv
[4]); ;

6908 5:
’code_ã©u»
.
b_’abË_h®f_pix–
 = 
isÚ
; 
	`´štk
("1/2pix–=% ", 
¬gv
[5]); ;

6909 6:
’code_ã©u»
.
b_’abË_qu¬‹r_pix–
 = 
isÚ
; 
	`´štk
("1/4pix–=% ", 
¬gv
[6]); ;

6910 7:
s_Úly_i_4x4
 = 
isÚ
;
	`´štk
("Úly_I_4x4=% ", 
¬gv
[7]);;

6915 
	`´štk
("\n");

6917 
logic_chª
 = 
ba£
; (logic_chª - ba£è< 
TW5864_PHY_VD_CHAN_NUMBER
;†ogic_chan++){

6918 if(
logic_chª
 && 
	`©omic_»ad
(&logic_chª->
İ’ed_æag
) == 0){

6921 
ã©u»
 = &
logic_chª
->
’code_´İ”ty
.
’code_ã©u»
;

6922 
ã©u»
->
İ
->
	`upd©e_deš‹¾aû
(ã©u», 
’code_ã©u»
.
b_’abË_deš‹¾aû
);

6923 
ã©u»
->
İ
->
	`upd©e_sk
(ã©u», 
’code_ã©u»
.
b_’abË_sk
);

6924 
ã©u»
->
İ
->
	`upd©e_i_4x4
(ã©u», 
’code_ã©u»
.
b_’abË_I_4X4
);

6925 
ã©u»
->
İ
->
	`upd©e_h®f_pix–
(ã©u», 
’code_ã©u»
.
b_’abË_h®f_pix–
);

6926 
ã©u»
->
İ
->
	`upd©e_qu¬‹r_pix–
(ã©u», 
’code_ã©u»
.
b_’abË_qu¬‹r_pix–
);

6929 if(
	`¡rcmp
(
¬gv
[0], "statistics") == 0) {

6930 
s_‹¡_¡©i¡ic
 = 
STATISTIC_MODE_0
;

6932 
¡©i¡ics_tim”
.
funùiÚ
 = 
¡©i¡ics_h264_ã©u»
;

6933 
¡©i¡ics_tim”
.
d©a
 = 
ch
;

6934 
¡©i¡ics_tim”
.
expœes
 = 
jiff›s
 + (1000/
HZ
) * 1000 * 20;

6935 
	`š™_tim”
(&
¡©i¡ics_tim”
);

6936 
	`add_tim”
(&
¡©i¡ics_tim”
);

6938 
¡©i¡ics_tim”_id
 = 
	`AddSšgËFœeTim”Job
((
TIMER_1_MINUTE
), 
¡©i¡ics_h264_ã©u»
, 
ch
);

6939 if(
¡©i¡ics_tim”_id
 =ğ
INVALIDTIMERID
) {

6940 
	`´štk
("addimerƒrror\n");

6946 
	`´štk
("no such cmd!\n");

6948 
cmd_’d
:

6949 
	`¬gv_ä“
(
¬gv
);

6951  
couÁ
;

6952 
	}
}

6954 
	$š™_tw5864_h264_’code_chª
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
, 
bus_id
, 
ch_id
, 
phy_¦Ù_id
, 
ty³
, 
dvm_ch_t
 *
ch
)

6956 if((
h264_logic_’code_chª
!=
NULL
è&& (
ch
!=NULL)){

6957 
tw5864_vd_üoss_bus_t
 *
ch_vd_üoss_bus
;

6958 
ch_driv”_t
 *
ch_driv”
;

6959 
tw_video_bus_t
 *
video_bus
;

6960 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
’code_cÚfig
, 
’code_·¿m
;

6961 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

6962 
tw_´oc_»gi¡”_s
 *
h264_´oc
;

6963 
buf_size
;

6964 
i
;

6966 
ch_driv”
 = 
ch
->chip_driver;

6967 
video_bus
 = &
ch_driv”
->video_bus;

6968 
h264_logic_’code_chª
->
phy_¦Ù_id
 =…hy_slot_id;

6969 
h264_logic_’code_chª
->
»ad_b™¡»am_mode
 = 
READ_H264_BITSTREAM_BY_DDR
;

6970 
h264_logic_’code_chª
->
ch
 = chip;

6971 
h264_logic_’code_chª
->
tw_deviû_chª
 = 
NULL
;

6972 
ch_vd_üoss_bus
 = &
ch
->chip_vd_cross_bus;

6973 if(
ch_vd_üoss_bus
->
İ
 !ğ
NULL
){

6974 
ch_vd_üoss_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(ch_vd_üoss_bus, 
h264_logic_’code_chª
->
phy_¦Ù_id
, &h264_logic_’code_chª->
ma¡”_¦Ù
);

6976 
	`tw5864_vd_üoss_bus_g‘_phy_video_¦Ù_by_phy_id
(
ch_vd_üoss_bus
, 
h264_logic_’code_chª
->
phy_¦Ù_id
, &h264_logic_’code_chª->
ma¡”_¦Ù
);

6978 if(
ty³
 =ğ
TW_MASTER_BITSTREAM
){

6979 
buf_size
 = 
VIDEO_MASTER_CHAN_BUF_POOL_LEN
;

6980 
h264_logic_’code_chª
->
ty³
 = 
TW_MASTER_BITSTREAM
;

6981 
h264_logic_’code_chª
->
logic_chª_id
 = ((
phy_¦Ù_id
<<
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
)|
TW_MASTER_BITSTREAM
);

6983 
’code_cÚfig
 = &
’code_·¿m
;

6984 
	`memıy
(
’code_cÚfig
, &
deçuÉ_h264_ma¡”_’code_´İ”ty
, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

6985 
’code_cÚfig
->
videoSnd¬d
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

6986 
’code_cÚfig
->
ås
 = (
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
)? 25:30;

6987 
	`š™_tw5864_h264_ma¡”_’code_´İ”ty
(&
h264_logic_’code_chª
->
’code_´İ”ty
, 
NULL
);

6989 
buf_size
 = 
VIDEO_SUB_CHAN_BUF_POOL_LEN
;

6990 
h264_logic_’code_chª
->
ty³
 = 
TW_SUB_BITSTREAM
;

6991 
h264_logic_’code_chª
->
logic_chª_id
 = ((
phy_¦Ù_id
<<
VIDEO_MASTER_OR_SUB_FLAG_LEFT_SHIFT_NUMBER
)|
TW_SUB_BITSTREAM
);

6993 
’code_cÚfig
 = &
’code_·¿m
;

6994 
	`memıy
(
’code_cÚfig
, &
deçuÉ_h264_sub_’code_´İ”ty
, (
tw_h264_’code_cÚfigu¿tiÚ_t
));

6995 
’code_cÚfig
->
videoSnd¬d
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

6996 
’code_cÚfig
->
ås
 = (
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
)? 25:30;

6997 
	`š™_tw5864_h264_sub_’code_´İ”ty
(&
h264_logic_’code_chª
->
’code_´İ”ty
, 
NULL
);

6999 
	`š™_’dpošt_tcb
(&
h264_logic_’code_chª
->
logic_chª_ed
, 
bus_id
, 
ch_id
, 
TW_ED_VIDEO_ENCODE_IN
, h264_logic_’code_chª->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, h264_logic_’code_chª, 
h264_logic_’code_chª_driv”_nÙify_my£lf
, 
h264_logic_’code_chª_driv”_m©ch_id
, &
h264_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
);

7000 
	`š™_’dpošt_tcb
(&
h264_logic_’code_chª
->
İ’ed_logic_chª_ed
, 
bus_id
, 
ch_id
, 
TW_ED_VIDEO_ENCODE_IN
, h264_logic_’code_chª->
phy_¦Ù_id
, h264_logic_’code_chª->
logic_chª_id
, h264_logic_’code_chª, 
h264_logic_’code_chª_driv”_nÙify_my£lf
, 
h264_logic_’code_chª_driv”_m©ch_id
, &
h264_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
);

7001 
i
=0; i<
REQ_MSG_NUMBER
; i++){

7002 
h264_logic_’code_chª
->
nÚblock_msg_tim”_id
[
i
] = 
INVALIDTIMERID
;

7003 
h264_logic_’code_chª
->
d–ay_msg_tim”_id
[
i
] = 
INVALIDTIMERID
;

7005 
	`©omic_£t
(&
h264_logic_’code_chª
->
İ’ed_æag
, 0);

7006 
	`©omic_£t
(&
h264_logic_’code_chª
->
have_d–iv”_sync_æag
, 0);

7008 
	`š™_tw5864_h264_’code_cÚŒŞ
(&
h264_logic_’code_chª
->
’code_cÚŒŞ
, h264_logic_’code_chª->
»ad_b™¡»am_mode
);

7009 
	`š™_rc_driv”
(
h264_logic_’code_chª
);

7010 #ifdeà 
OSD_MODULE


7011 
	`š™_’code_osd_chª_’gše
(&
h264_logic_’code_chª
->
’code_osd_’gše
, h264_logic_’code_chª->
ty³
);

7013 
	`š™_’code_chª_£rviû_tcb_w™h_nuÎ
(&
h264_logic_’code_chª
->
’code_»que¡_tcb
);

7014 
	`š™_d´am_»que¡_£rviû_tcb
(&
h264_logic_’code_chª
->
»ad_video_b™¡»am_»q
);

7015 
h264_logic_’code_chª
->
video_b™¡»am_buf
 = 
NULL
;

7017 
	`š™_tw_video_chª_buf_poŞ
(&
h264_logic_’code_chª
->
’code_chª_buf_poŞ
, 
buf_size
);

7018 
	`š™_tw_video_äame_tcb_queue
(&
h264_logic_’code_chª
->
’code_äame_queue
);

7019 #ifdeà 
MV_MODULE


7020 
	`š™_tw_video_mv_äame_tcb_queue
(&
h264_logic_’code_chª
->
’code_mv_äame_queue
);

7023 
	`»gi¡”_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

7024 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

7025 
İ’ed_logic_chª_ed
->
İ
 = &
h264_’code_hcd_š‹rçû_İ
;

7027 
h264_´oc
 = &
ch
->h264_proc;

7028 if(!
h264_´oc
->
’Œy
) {

7029 
	`¡rıy
(
h264_´oc
->
Çme
, "h264");

7030 
h264_´oc
->
»ad
 = 
h264_´oc_»ad
;

7031 
h264_´oc
->
wr™e
 = 
h264_´oc_wr™e
;

7032 
h264_´oc
->
´iv©e
 = 
ch
->
h264_ma¡”_’code_logic_chª
;

7033 
	`tw_moduË_»gi¡”
(
ch
, 
h264_´oc
);

7036  
TW_OK
;

7039  
TW_ERR
;

7040 
	}
}

7042 
	$»move_tw5864_h264_’code_chª
(
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
)

7044 if(
h264_logic_’code_chª
!=
NULL
){

7045 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

7047 
İ’ed_logic_chª_ed
 = &
h264_logic_’code_chª
->opened_logic_chan_ed;

7048 if(
İ’ed_logic_chª_ed
->
İ
 !ğ
NULL
){

7049 
İ’ed_logic_chª_ed
->
İ
->
	`şo£
(opened_logic_chan_ed);

7051 
	`»move_tw_video_chª_buf_poŞ
(&
h264_logic_’code_chª
->
’code_chª_buf_poŞ
);

7052 #ifdeà 
OSD_MODULE


7053 
	`»move_’code_osd_chª_’gše
(&
h264_logic_’code_chª
->
’code_osd_’gše
);

7055 
	`uÄegi¡”_logic_’code_chª_što_ma¡”_¦Ù
(
h264_logic_’code_chª
, h264_logic_’code_chª->
ma¡”_¦Ù
);

7058 
	`tw_moduË_uÄegi¡”
(
h264_logic_’code_chª
->
ch
, &h264_logic_’code_chª->ch->
h264_´oc
);

7059 
	}
}

7061 
	$nÙify_»move_’code_chª_£rviû
(
’code_chª_£rviû_tcb_t
 *
cu¼_cÚsum”
)

7063 if(
cu¼_cÚsum”
 !ğ
NULL
){

7064 
tw_h264_logic_’code_chª_t
 *
h264_logic_’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_’code_»que¡_tcb
(
cu¼_cÚsum”
);

7065 
	`»move_tw5864_h264_’code_chª
(
h264_logic_’code_chª
);

7067 
	}
}

7070 
Wr™e_OÃ_F¿me_To_DDR_D1_F¿me
(
tw_h264_logic_’code_chª_t
 *
’cod”
, 
u16
 
F¿meIdx
, u16 
chªÃl
,
u8
 *
buf
, 
u32
 *
Ën
);

7071 
	$tw_h264_hªdË_u£r_q
(
dvm_ch_t
 *
ch
, 
tw_h264_logic_’code_chª_t
 *
logic_chÆ
, *
Çme
, *
§ve
, 
út
)

7073 
fe
 *
yuv_fe
 = 
NULL
;

7074 
fe
 *
h264_fe
 = 
NULL
;

7075 
šode
 *šodğ
NULL
;

7076 
šode
 *
h264_šode
 = 
NULL
;

7077 
mm_£gm’t_t
 
fs
;

7078 *
yuv_buf
 = 
NULL
;

7079 
tw_h264_’code_cÚfigu¿tiÚ_t
 *
h264_cÚfig
 = 
NULL
;

7080 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

7081 
tw_video_äame_tcb_t
 *
äame
;

7082 
tw_video_äame_tcb_queue_t
 *
äame_queue
;

7083 
size
;

7084 
Ën
, 
i
;

7085 
u8
 
buf
[12];

7087 if(!
ch
 || !
logic_chÆ
 || !
Çme
)

7089 
	`´štk
("NULL Pointer!\n");

7090  -
EPERM
;

7092 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x9000, 0x0);

7093 
ch
->
io_İ
->
	`ch_wr™e32
(chip, 0x9004, 0x0);

7094 
	`mem£t
(
buf
, 0, 12);

7095 
yuv_fe
 = 
	`fp_İ’
(
Çme
, 
O_RDONLY
, 655);

7096 if(
	`IS_ERR
(
yuv_fe
))

7098 
	`´štk
("İ’ f\"%s\" fad, %d\n", 
Çme
, ()
yuv_fe
);

7099  
	`IS_ERR
(
yuv_fe
);

7102 
šode
=
yuv_fe
->
f_d’Œy
->
d_šode
;

7103 
h264_fe
 = 
	`fp_İ’
(
§ve
, 
O_CREAT
 | 
O_RDWR
 | 
O_SYNC
, 655);

7104 if(
	`IS_ERR
(
h264_fe
))

7106 
	`´štk
("İ’ f\"%s\" fad, %d\n", 
Çme
, ()
h264_fe
);

7107  
	`IS_ERR
(
h264_fe
);

7109 
h264_šode
 = 
h264_fe
->
f_d’Œy
->
d_šode
;

7111 
h264_cÚfig
 = &
logic_chÆ
->
’code_´İ”ty
.encode_property;

7114 
size
 = 704 * 576 * 3 / 2;

7116 
yuv_buf
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

7117 if(!
yuv_buf
)

7119 
q_»Ëa£
;

7122 
fs
=
	`g‘_fs
();

7123 
	`£t_fs
(
KERNEL_DS
);

7124 
i
 = 0; i < 4; i++)

7126 
Ën
 = 
yuv_fe
->
f_İ
->
	`»ad
(yuv_fe, 
yuv_buf
, 
size
, &(yuv_fe->
f_pos
));

7127 if(
Ën
 !ğ
size
)

7129 
	`´štk
("only support YV12, YCbCr420!\n");

7133 
	`Wr™e_OÃ_F¿me_To_DDR_D1_F¿me
(
logic_chÆ
, 
i
, 0, 
yuv_buf
, &
Ën
);

7136 
	`´štk
("»ad fsiz%Îd\n", 
šode
->
i_size
);

7137 
’code_cÚŒŞ
 = &
logic_chÆ
->encode_control;

7144 
’code_cÚŒŞ
 = &
logic_chÆ
->encode_control;

7145 
út
 = 4;

7146 
i
 = 0; i < 
út
; i++)

7150 
äame_queue
 = &
logic_chÆ
->
’code_äame_queue
;

7151 
äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(äame_queue, &
logic_chÆ
->
’code_chª_buf_poŞ
);

7152 if(
äame_queue
->
cu¼_´oduûr
 =ğ
NULL
) {

7153 
	`´štk
("%s,%d: f¿mi nuÎ!\n", 
__FUNCTION__
, 
__LINE__
);

7155 
’code_cÚŒŞ
->
İ
->
	`upd©e_ad_»ady
(encode_control);

7157 if(
’code_cÚŒŞ
->
İ
->
	`g‘_¦iû_h—d_ªd_ad_¡©us
(encode_control)){

7158 
	`š™_’code_chª_£rviû_tcb_w™h_¡¬t_’code
(&
logic_chÆ
->
’code_»que¡_tcb
);

7160 
	`md–ay
(10);

7162 
äame_queue
 = &
logic_chÆ
->
’code_äame_queue
;

7163 !
äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(frame_queue)){

7164 
	`scheduË
();

7165 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

7166 
q_»Ëa£
;

7170 
äame_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(frame_queue);

7171 
äame
 = 
äame_queue
->
cu¼_cÚsum”
;

7172 if(!
äame
->
äame_is_”r
){

7173 
	`tw_h264_to_fe
(
h264_fe
, 
äame
);

7175 
	`´štk
("---------------->wr™%d\n", 
i
);

7176 
äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(äame_queue, &
logic_chÆ
->
’code_chª_buf_poŞ
);

7180 
äame_queue
 = &
logic_chÆ
->
’code_äame_queue
;

7181 
äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(äame_queue, &
logic_chÆ
->
’code_chª_buf_poŞ
);

7183 
äame
 = 
äame_queue
->
cu¼_´oduûr
;

7184 
·ck‘_queue
 = &
äame
->
video_·ck‘_queue
;

7185 
·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
Õack‘_queue, &
logic_chÆ
->
’code_chª_buf_poŞ
);

7186 
·ck‘
 = 
·ck‘_queue
->
cu¼_´oduûr
;

7188 
	`åga_dma_»ûive
(
ch
->
·_»gs
 + 
VLC_ENCODER_PING
, 
·ck‘
->
dma_addr
, 4096);

7189 
Ën
 = 
h264_fe
->
f_İ
->
	`wr™e
(h264_fe, 
·ck‘
->
d©a
, 4096, &(h264_fe->
f_pos
));

7190 
	`åga_dma_»ûive
(
ch
->
·_»gs
 + 
VLC_ENCODER_PONG
, 
·ck‘
->
dma_addr
, 4096);

7191 
i
 = 0; i< 1024; i++)

7192 *(
u16
 *)(
·ck‘
->
d©a
 + 
i
 * 2) = i;

7194 
	`¶©fÜm_ho¡_wr™–
(
	`¶©fÜm_ho¡_»adl
(
ch
->
»gs
 + 0x30) & (~(1 << 13)), chip->regs + 0x30);

7195 
	`¶©fÜm_ho¡_wr™–
(0x0, 
ch
->
»gs
 + 0x18004);

7196 
	`¶©fÜm_ho¡_wr™–
(0x0, 
ch
->
»gs
 + 0x101c);

7198 
	`¶©fÜm_ho¡_wr™–
(
	`¶©fÜm_ho¡_»adl
(
ch
->
»gs
 + 0x30) | (0x8000), chip->regs + 0x30);

7199 
	`åga_dma_»ûive
(
·ck‘
->
dma_addr
, 
ch
->
·_»gs
 + 0x84000, 2048);

7201 
	`¶©fÜm_ho¡_wr™–
(
	`¶©fÜm_ho¡_»adl
(
ch
->
»gs
 + 0x30) | ((1 << 13)), chip->regs + 0x30);

7202 
	`¶©fÜm_ho¡_wr™–
(0x1c000000, 
ch
->
»gs
 + 0x18004);

7203 
	`¶©fÜm_ho¡_wr™–
(0x2, 
ch
->
»gs
 + 0x101c);

7204 
	`mem£t
(
·ck‘
->
d©a
, 0x0, 4096);

7205 
	`åga_dma_»ûive
(
ch
->
·_»gs
 + 0x84000, 
·ck‘
->
dma_addr
, 2048);

7206 
Ën
 = 
h264_fe
->
f_İ
->
	`wr™e
(h264_fe, 
·ck‘
->
d©a
, 2048, &(h264_fe->
f_pos
));

7209 
	`£t_fs
(
fs
);

7210 
q_»Ëa£
:

7211 if(
yuv_buf
)

7212 
	`ä“_·ges
(()
yuv_buf
, 
	`g‘_Üd”
(
size
));

7213 if(!(
	`IS_ERR
(
yuv_fe
)))

7215 
	`fp_şo£
(
yuv_fe
, 
NULL
);

7216 
	`fp_şo£
(
h264_fe
, 
NULL
);

7219 
	}
}

7221 
	$tw_h264_§ve_chn
(
tw_h264_logic_’code_chª_t
 *
logic_chÆ
, *
·th
)

7223 
fe
 *
h264_fe
;

7225 
tw_video_äame_tcb_t
 *
äame
;

7227 
tw_video_äame_tcb_queue_t
 *
äame_queue
;

7229 
chÆ
 = 
logic_chÆ
->
logic_chª_id
;

7230 
Çme
[128];

7234 
	`mem£t
(
Çme
, 0, 128);

7236 
	`¥rštf
(
Çme
, "%s/video_chn_%02d_%02d.h264", 
·th
, 
chÆ
, 
logic_chÆ
->
phy_¦Ù_id
);

7238 
h264_fe
 = 
	`tw_k”Ãl_fe_İ’
(
Çme
);

7239 if(
	`IS_ERR
(
h264_fe
)){

7240  -
EINVAL
;

7246 
äame_queue
 = &
logic_chÆ
->
’code_äame_queue
;

7253 
äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(frame_queue)){

7254 
äame_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(frame_queue);

7255 
äame
 = 
äame_queue
->
cu¼_cÚsum”
;

7256 if(!
äame
->
äame_is_”r
){

7257 
	`tw_h264_to_fe
(
h264_fe
, 
äame
);

7259 
äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(äame_queue, &
logic_chÆ
->
’code_chª_buf_poŞ
);

7263 
sub_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(sub_frame_queue);

7264 
sub_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(sub_frame_queue)) {

7265 
sub_äame
 = 
sub_äame_queue
->
cu¼_cÚsum”
;

7266 if(
sub_äame
){

7267 
	`tw_h264_to_fe
(
sub_fe
, 
sub_äame
);

7268 
sub_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(sub_äame_queue, &
logic_chÆ
->
ch
->
h264_sub_’code_logic_chª
[logic_chÆ->
phy_¦Ù_id
].
’code_chª_buf_poŞ
);

7272 
	`scheduË
();

7273 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

7277 
	`tw_k”Ãl_fe_şo£
(
h264_fe
);

7281 
mm_£gm’t_t
 
fs
;

7282 
fe
 *
h264_sync_fe
;

7283 
Ën
 = 0;

7284 *
bufãr
 = 
NULL
;

7286 
h264_sync_fe
 = 
	`tw_k”Ãl_fe_İ’
("/dev/video0");

7287 
h264_fe
 = 
	`tw_k”Ãl_fe_İ’
("/software/h264_sync.h264");

7289 
bufãr
 = 
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 9);

7291 
fs
=
	`g‘_fs
();

7292 
	`£t_fs
(
KERNEL_DS
);

7294 
Ën
 = 
h264_sync_fe
->
f_İ
->
	`»ad
(h264_sync_fe, 
bufãr
, 0x80000, &(h264_sync_fe->
f_pos
));

7295 if(
Ën
 > 0) {

7296 
h264_fe
->
f_İ
->
	`wr™e
(h264_fe, 
bufãr
, 
Ën
, &(h264_fe->
f_pos
));

7298 
	`scheduË
();

7299 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

7303 
	`£t_fs
(
fs
);

7304 
	`kä“
(
bufãr
);

7305 
	`tw_k”Ãl_fe_şo£
(
h264_sync_fe
);

7306 
	`tw_k”Ãl_fe_şo£
(
h264_fe
);

7313 
	}
}

7317 
	$tw_h264_to_fe
(
fe
 *
h264_fe
, 
tw_video_äame_tcb_t
 *
äame
)

7319 
mm_£gm’t_t
 
fs
;

7320 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

7321 
tw_video_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

7322 
Ën
;

7323 
h264_Çl_t
 *
Çl
;

7326 if(!
h264_fe
 || !
äame
)

7328  -
EINVAL
;

7331 
fs
=
	`g‘_fs
();

7332 
Çl
 = &
äame
->nal;

7333 
	`£t_fs
(
KERNEL_DS
);

7334 
·ck‘_queue
 = &
äame
->
video_·ck‘_queue
;

7335 
·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(packet_queue)){

7336 
·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(packet_queue);

7337 
·ck‘
 = 
·ck‘_queue
->
cu¼_cÚsum”
;

7342 
Ën
 = 
h264_fe
->
f_İ
->
	`wr™e
(h264_fe, 
·ck‘
->
d©a
,…ack‘->
·ylßd_Ën
, &(h264_fe->
f_pos
));

7344 
·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
Õack‘_queue, 
äame
->
video_chª_buf_poŞ
);

7346 
	`£t_fs
(
fs
);

7349 
	}
}

7351 
	$tw_mv_to_fe
(
fe
 *
mv_fe
, 
tw_video_mv_äame_tcb_t
 *
äame
)

7353 
mm_£gm’t_t
 
fs
;

7354 
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
;

7355 
tw_video_mv_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

7356 
Ën
;

7358 if(!
mv_fe
 || !
äame
)

7360  -
EINVAL
;

7363 
fs
=
	`g‘_fs
();

7364 
	`£t_fs
(
KERNEL_DS
);

7366 
·ck‘_queue
 = &
äame
->
mv_queue
;

7367 
·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(packet_queue)){

7368 
·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(packet_queue);

7369 
·ck‘
 = 
·ck‘_queue
->
cu¼_cÚsum”
;

7370 if(
·ck‘
){

7371 
Ën
 = 
mv_fe
->
f_İ
->
	`wr™e
(mv_fe, 
·ck‘
->
d©a
,…ack‘->
mvVeùÜ_Ën
, &(mv_fe->
f_pos
));

7372 
·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
Õack‘_queue, 
äame
->
video_chª_buf_poŞ
);

7376 
	`£t_fs
(
fs
);

7379 
	}
}

	@../../tw5864/tw5864/tw_h264_video_buf.c

1 
	~<tw5864/dvm_commÚ.h
>

4 
	$tw_video_·ck‘_tcb_š™
(
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
id
)

6 if((
video_·ck‘_tcb
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

7 
tcb_node_t
 *
node
 = &
video_·ck‘_tcb
->
·ck‘_node
;

8 
	`¥š_lock_š™
(&
video_·ck‘_tcb
->
lock
);

9 
	`©omic_£t
(&
video_·ck‘_tcb
->
»f_couÁ
, 0);

10 
node
->
İ
 = &
tcb_node_İ
;

11 
node
->
İ
->
	`š™
(node);

12 
node
->
İ
->
	`£t_´iv
Òode, 
video_·ck‘_tcb
);

13 
video_·ck‘_tcb
->
·ck‘_id
 = 
id
;

14 
video_·ck‘_tcb
->
·ck‘_size
 = 
video_chª_buf_poŞ
->
video_·ck‘_bufãr_size
;

15 
video_·ck‘_tcb
->
·ylßd_Ën
 = 0;

16 
video_·ck‘_tcb
->
cÚsum”_Ën
 = 0;

17 
video_·ck‘_tcb
->
d©a
 = &
video_chª_buf_poŞ
->
ÿche_bufãr
[video_chª_buf_poŞ->
video_·ck‘_bufãr_size
*
id
];

18 
video_·ck‘_tcb
->
dma_addr
 = 0;

19 
video_·ck‘_tcb
->
id_of_·ck‘_queue
 = 0;

21 
	}
}

23 
	$tw_video_·ck‘_tcb_»£t
(
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
)

25 if(
video_·ck‘_tcb
!=
NULL
){

26 
	`©omic_£t
(&
video_·ck‘_tcb
->
»f_couÁ
, 0);

27 
video_·ck‘_tcb
->
·ylßd_Ën
 = 0;

28 
video_·ck‘_tcb
->
cÚsum”_Ën
 = 0;

29 
video_·ck‘_tcb
->
dma_addr
 = 0;

30 
video_·ck‘_tcb
->
id_of_·ck‘_queue
 = 0;

32 
	}
}

34 
	$tw_video_·ck‘_tcb_»Ëa£
(
tw_video_·ck‘_tcb_t
 **
±r_video_·ck‘_tcb
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

36 if((*
±r_video_·ck‘_tcb
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

37 
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
 = *
±r_video_·ck‘_tcb
;

38 
æags
;

40 
	`¥š_lock_œq§ve
(&
video_·ck‘_tcb
->
lock
, 
æags
);

41 if(
	`©omic_»ad
(&
video_·ck‘_tcb
->
»f_couÁ
) > 1){

42 
	`©omic_dec
(&
video_·ck‘_tcb
->
»f_couÁ
);

44 
tcb_node_t
 *
node
;

45 if(
video_·ck‘_tcb
->
İ
 !ğ
NULL
){

46 
video_·ck‘_tcb
->
İ
->
	`»£t
(video_packet_tcb);

48 
node
 = &
video_·ck‘_tcb
->
·ck‘_node
;

49 if(
node
->
İ
 !ğ
NULL
){

50 
node
->
İ
->
	`»Ëa£
Òode, &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
);

53 *
±r_video_·ck‘_tcb
 = 
NULL
;

54 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_tcb
->
lock
, 
æags
);

56 
	}
}

58 
	$tw_video_·ck‘_tcb_»ã»nû
(
tw_video_·ck‘_tcb_t
 *
¤c_video_·ck‘_tcb
,w_video_·ck‘_tcb_ˆ**
±r_de¡_video_·ck‘_tcb
)

60 if((
¤c_video_·ck‘_tcb
!=
NULL
è&& (
±r_de¡_video_·ck‘_tcb
!=NULL)){

61 
æags
;

62 
	`¥š_lock_œq§ve
(&
¤c_video_·ck‘_tcb
->
lock
, 
æags
);

63 
	`©omic_šc
(&
¤c_video_·ck‘_tcb
->
»f_couÁ
);

64 *
±r_de¡_video_·ck‘_tcb
 = 
¤c_video_·ck‘_tcb
;

65 
	`¥š_uÆock_œq»¡Üe
(&
¤c_video_·ck‘_tcb
->
lock
, 
æags
);

67 
	}
}

69 
	$tw_video_·ck‘_tcb_dma_m­
(
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

71 if(
video_·ck‘_tcb
 !ğ
NULL
) {

72 if(
video_·ck‘_tcb
->
d©a
 !ğ
NULL
) {

73 
video_·ck‘_tcb
->
dma_addr
 = 
	`dma_m­_sšgË
(
NULL
, video_·ck‘_tcb->
d©a
, video_·ck‘_tcb->
·ck‘_size
, 
dœeùiÚ
);

74 ià(
video_·ck‘_tcb
->
dma_addr
 == 0){

75 
	`´štk
("%s.%dƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

79 
	}
}

81 
	$tw_video_·ck‘_tcb_dma_unm­
(
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

83 if(
video_·ck‘_tcb
 !ğ
NULL
) {

84 ià(
video_·ck‘_tcb
->
dma_addr
 != 0) {

85 
	`dma_unm­_sšgË
(
NULL
, 
video_·ck‘_tcb
->
dma_addr
, video_·ck‘_tcb->
·ck‘_size
, 
dœeùiÚ
);

86 
video_·ck‘_tcb
->
dma_addr
 = 0;

89 
	}
}

91 
size_t
 
	$tw_video_·ck‘_tcb_subm™
(
tw_video_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
h264_Çl_t
 *
Çl
)

93 
loff_t
 
buf_off£t
 = 0;

94 if((
·ck‘
 !ğ
NULL
è&& (
couÁ
>õack‘->
·ylßd_Ën
)){

95 
	`cİy_to_u£r
(
d©a
, 
·ck‘
->d©a,…ack‘->
·ylßd_Ën
);

96 
buf_off£t
 = 
·ck‘
->
·ylßd_Ën
;

98 
	`´štk
("\n\n%s.%d\n\n", 
__FUNCTION__
, 
__LINE__
);

100 *
µos
 +ğ
buf_off£t
;

101  (
size_t
)
buf_off£t
;

102 
	}
}

104 
tw_video_·ck‘_İ”©iÚ
 
	gtw_video_·ck‘_tcb_İ
 = {

105 .
š™
 = 
tw_video_·ck‘_tcb_š™
,

106 .
	g»£t
 = 
tw_video_·ck‘_tcb_»£t
,

107 .
	g»Ëa£
 = 
tw_video_·ck‘_tcb_»Ëa£
,

108 .
	g»ã»nû
 = 
tw_video_·ck‘_tcb_»ã»nû
,

110 .
	gdma_m­
 = 
tw_video_·ck‘_tcb_dma_m­
,

111 .
	gdma_unm­
 = 
tw_video_·ck‘_tcb_dma_unm­
,

113 .
	gsubm™
 = 
tw_video_·ck‘_tcb_subm™
,

116 
	$tw_video_·ck‘_queue_g‘
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 **
±r_video_·ck‘_tcb
)

118 if((
video_·ck‘_queue
!=
NULL
è&& (
±r_video_·ck‘_tcb
!=NULL)){

119 
tcb_node_queue_t
 *
queue
;

120 *
±r_video_·ck‘_tcb
 = 
NULL
;

121 
queue
 = &
video_·ck‘_queue
->
queue_node
;

122 if(
queue
->
İ
 !ğ
NULL
){

123 
tcb_node_t
 *
‹mp_node
;

124 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

125 if(
‹mp_node
 !ğ
NULL
){

126 *
±r_video_·ck‘_tcb
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

130 
	}
}

132 
	$tw_video_·ck‘_queue_Œy_g‘
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 **
±r_video_·ck‘_tcb
)

134 if((
video_·ck‘_queue
!=
NULL
è&& (
±r_video_·ck‘_tcb
!=NULL)){

135 
tcb_node_queue_t
 *
queue
;

136 *
±r_video_·ck‘_tcb
 = 
NULL
;

137 
queue
 = &
video_·ck‘_queue
->
queue_node
;

138 if(
queue
->
İ
 !ğ
NULL
){

139 
tcb_node_t
 *
‹mp_node
;

140 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

141 if(
‹mp_node
 !ğ
NULL
){

142 *
±r_video_·ck‘_tcb
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

146 
	}
}

148 
	$tw_video_·ck‘_queue_g‘_”
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 **
±r_video_·ck‘_tcb
)

150 if((
video_·ck‘_queue
!=
NULL
è&& (
±r_video_·ck‘_tcb
!=NULL)){

151 
tcb_node_queue_t
 *
queue
;

152 *
±r_video_·ck‘_tcb
 = 
NULL
;

153 
queue
 = &
video_·ck‘_queue
->
queue_node
;

154 if(
queue
->
İ
 !ğ
NULL
){

155 
tcb_node_t
 *
‹mp_node
;

156 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

157 if(
‹mp_node
 !ğ
NULL
){

158 *
±r_video_·ck‘_tcb
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

162 
	}
}

164 
	$tw_video_·ck‘_queue_Œy_g‘_”
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 **
±r_video_·ck‘_tcb
)

166 if((
video_·ck‘_queue
!=
NULL
è&& (
±r_video_·ck‘_tcb
!=NULL)){

167 
tcb_node_queue_t
 *
queue
;

168 *
±r_video_·ck‘_tcb
 = 
NULL
;

169 
queue
 = &
video_·ck‘_queue
->
queue_node
;

170 if(
queue
->
İ
 !ğ
NULL
){

171 
tcb_node_t
 *
‹mp_node
;

172 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

173 if(
‹mp_node
 !ğ
NULL
){

174 *
±r_video_·ck‘_tcb
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

178 
	}
}

180 
	$tw_video_·ck‘_queue_put
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
)

182 if((
video_·ck‘_queue
!=
NULL
è&& (
video_·ck‘_tcb
!=NULL)){

183 
tcb_node_queue_t
 *
queue
;

184 
queue
 = &
video_·ck‘_queue
->
queue_node
;

185 if(
queue
->
İ
 !ğ
NULL
){

186 
queue
->
İ
->
	`put
(queue, &
video_·ck‘_tcb
->
·ck‘_node
);

187 
video_·ck‘_tcb
->
id_of_·ck‘_queue
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

190 
	}
}

192 
	$tw_video_·ck‘_queue_put_h—d”
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_·ck‘_tcb_t
 *
video_·ck‘_tcb
)

194 if((
video_·ck‘_queue
!=
NULL
è&& (
video_·ck‘_tcb
!=NULL)){

195 
tcb_node_queue_t
 *
queue
;

196 
queue
 = &
video_·ck‘_queue
->
queue_node
;

197 if(
queue
->
İ
 !ğ
NULL
){

198 
queue
->
İ
->
	`put_h—d”
(queue, &
video_·ck‘_tcb
->
·ck‘_node
);

201 
	}
}

203 
	$tw_video_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

205 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

206 
æags
;

207 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

208 if(
video_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
){

209 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

210 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

211 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_·ck‘_tcb
(video_chª_buf_poŞ, &
video_·ck‘_queue
->
cu¼_´oduûr
);

216 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

218 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

220 
	}
}

222 
	$tw_video_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

224 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

225 
æags
;

226 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

227 if(
video_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
) {

228 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

229 
video_chª_buf_poŞ
->
İ
->
	`Œy_g‘_video_·ck‘_tcb
(video_chª_buf_poŞ, &
video_·ck‘_queue
->
cu¼_´oduûr
);

235 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

237 
	}
}

239 
	$tw_video_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

241 if(
video_·ck‘_queue
 !ğ
NULL
){

242 
æags
;

243 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

244 if(
video_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

246 if(
video_·ck‘_queue
->
İ
 !ğ
NULL
){

247 
video_·ck‘_queue
->
İ
->
	`put
(video_·ck‘_queue, video_·ck‘_queue->
cu¼_´oduûr
);

249 
	`tw_video_·ck‘_queue_put
(
video_·ck‘_queue
, video_·ck‘_queue->
cu¼_´oduûr
);

251 
video_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

253 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

255 
	}
}

257 
	$tw_video_·ck‘_queue_»Ëa£_cu¼_´oduûr
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

259 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

260 
æags
;

261 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

262 if(
video_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

263 if(
video_·ck‘_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

264 
video_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&video_·ck‘_queue->cu¼_´oduûr, 
video_chª_buf_poŞ
);

266 
	`tw_video_·ck‘_tcb_»Ëa£
(&
video_·ck‘_queue
->
cu¼_´oduûr
, 
video_chª_buf_poŞ
);

269 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

271 
	}
}

273 
	$tw_video_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

275 if(
video_·ck‘_queue
 !ğ
NULL
){

276 
æags
;

277 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

278 if(
video_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

279 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

280 if(
video_·ck‘_queue
->
İ
 !ğ
NULL
){

281 
video_·ck‘_queue
->
İ
->
	`g‘
(video_·ck‘_queue, &video_·ck‘_queue->
cu¼_cÚsum”
);

283 
	`tw_video_·ck‘_queue_g‘
(
video_·ck‘_queue
, &video_·ck‘_queue->
cu¼_cÚsum”
);

285 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

287 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

289 
	}
}

291 
	$tw_video_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

293 if(
video_·ck‘_queue
 !ğ
NULL
){

294 
æags
;

295 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

296 if(
video_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

297 if(
video_·ck‘_queue
->
İ
 !ğ
NULL
){

298 
video_·ck‘_queue
->
İ
->
	`Œy_g‘
(video_·ck‘_queue, &video_·ck‘_queue->
cu¼_cÚsum”
);

300 
	`tw_video_·ck‘_queue_Œy_g‘
(
video_·ck‘_queue
, &video_·ck‘_queue->
cu¼_cÚsum”
);

303 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

305 
	}
}

307 
	$tw_video_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

309 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

310 
æags
;

311 
	`¥š_lock_œq§ve
(&
video_·ck‘_queue
->
lock
, 
æags
);

312 if(
video_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

313 if(
video_·ck‘_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

314 
video_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&video_·ck‘_queue->cu¼_cÚsum”, 
video_chª_buf_poŞ
);

316 
	`tw_video_·ck‘_tcb_»Ëa£
(&
video_·ck‘_queue
->
cu¼_cÚsum”
, 
video_chª_buf_poŞ
);

319 
	`¥š_uÆock_œq»¡Üe
(&
video_·ck‘_queue
->
lock
, 
æags
);

321 
	}
}

323 
	$tw_video_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

325 
’Œy_numb”
 = 0;

326 if(
video_·ck‘_queue
!=
NULL
){

327 
tcb_node_queue_t
 *
queue
;

328 
queue
 = &
video_·ck‘_queue
->
queue_node
;

329 if(
queue
->
İ
 !ğ
NULL
){

330 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

333  
’Œy_numb”
;

334 
	}
}

336 
	$tw_video_·ck‘_queue_»Ëa£
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

338 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

339 
	`»move_tw_video_·ck‘_tcb_queue
(
video_·ck‘_queue
, 
video_chª_buf_poŞ
);

341 
	}
}

343 
	$tw_video_·ck‘_queue_š™
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

345 if(
video_·ck‘_queue
 !ğ
NULL
){

346 
tcb_node_queue_t
 *
queue
;

347 
queue
 = &
video_·ck‘_queue
->
queue_node
;

348 
queue
->
İ
 = &
tcb_node_queue_İ
;

349 
queue
->
İ
->
	`š™
(queue);

350 
video_·ck‘_queue
->
cu¼_cÚsum”
 = 
NULL
;

351 
video_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

352 
video_·ck‘_queue
->
¡¬t_time¡amp
 = 0;

353 
video_·ck‘_queue
->
tÙ®_du¿tiÚ
 = 0;

354 
	`¥š_lock_š™
(&
video_·ck‘_queue
->
lock
);

356 
	}
}

358 
tw_video_·ck‘_queue_İ”©iÚ
 
	gtw_video_·ck‘_queue_İ
 = {

359 .
g‘
 = 
tw_video_·ck‘_queue_g‘
,

360 .
	gŒy_g‘
 = 
tw_video_·ck‘_queue_Œy_g‘
,

361 .
	gg‘_”
 = 
tw_video_·ck‘_queue_g‘_”
,

362 .
	gŒy_g‘_”
 = 
tw_video_·ck‘_queue_Œy_g‘_”
,

363 .
	gput
 = 
tw_video_·ck‘_queue_put
,

364 .
	gput_h—d”
 = 
tw_video_·ck‘_queue_put_h—d”
,

366 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
,

367 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

368 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_video_·ck‘_queue_put_cu¼_´oduûr_što_queue
,

369 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_video_·ck‘_queue_»Ëa£_cu¼_´oduûr
,

370 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
,

371 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

372 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_video_·ck‘_queue_»Ëa£_cu¼_cÚsum”
,

374 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_video_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
,

375 .
	g»Ëa£
 = 
tw_video_·ck‘_queue_»Ëa£
,

376 .
	gš™
 = 
tw_video_·ck‘_queue_š™
,

379 
	$š™_tw_video_·ck‘_tcb_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
)

381 if(
video_·ck‘_queue
 !ğ
NULL
){

382 
video_·ck‘_queue
->
İ
 = &
tw_video_·ck‘_queue_İ
;

383 
video_·ck‘_queue
->
İ
->
	`š™
(video_packet_queue);

385 
	}
}

387 
	$»move_tw_video_·ck‘_tcb_queue
(
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

389 if((
video_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

390 if(
video_·ck‘_queue
->
İ
 !ğ
NULL
){

391 
video_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_packet_queue);

392 
video_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_·ck‘_queue, 
video_chª_buf_poŞ
);

393 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_packet_queue)){

394 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_packet_queue);

395 if(
video_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

398 
video_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_·ck‘_queue, 
video_chª_buf_poŞ
);

401 
	`tw_video_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
video_·ck‘_queue
);

402 
	`tw_video_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
video_·ck‘_queue
, 
video_chª_buf_poŞ
);

403 
	`tw_video_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
video_·ck‘_queue
)){

404 
	`tw_video_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
video_·ck‘_queue
);

405 if(
video_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

408 
	`tw_video_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
video_·ck‘_queue
, 
video_chª_buf_poŞ
);

412 
	}
}

414 
	$tw_video_äame_tcb_Çl_š™
(
h264_Çl_t
 *
Çl
)

416 if(
Çl
 !ğ
NULL
){

417 
Çl
->
i_»f_idc
 = 0;

418 
Çl
->
i_ty³
 = 0;

419 
Çl
->
i_‹mp_b™®ign_numb”
 = 0;

420 
Çl
->
i_‹mp_b™®ign_cÚ‹Á
 = 0;

421 
	`mem£t
(
Çl
, 0, (
h264_Çl_t
));

422 
Çl
->
¥s_·ylßd
 =‚®->
µs_·ylßd
 =‚®->
¦iû_·ylßd
 =‚®->
¦iû_h—d_buf
 = 
NULL
;

423 
Çl
->
¥s_·ysize
 =‚®->
µs_·ysize
 =‚®->
¦iû_·ysize
 = 0;

425 
	}
}

427 
	$tw_video_äame_tcb_š™
(
tw_video_äame_tcb_t
 *
äame
)

429 if(
äame
!=
NULL
){

430 
tcb_node_t
 *
node
 = &
äame
->
äame_node
;

431 
node
->
İ
 = &
tcb_node_İ
;

432 
node
->
İ
->
	`š™
(node);

433 
node
->
İ
->
	`£t_´iv
Òode, 
äame
);

435 
	`¥š_lock_š™
(&
äame
->
lock
);

436 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

437 
äame
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

438 
	`tw_video_äame_tcb_Çl_š™
(&
äame
->
Çl
);

439 
äame
->
äame_Ën
 = 0;

440 
äame
->
cÚsum”_äame_off£t
 = 0;

441 
äame
->
time¡amp
 = 0;

442 
äame
->
i_š™_qp
 = 
DEFAULT_QP
;

443 
äame
->
i_cu¼_qp
 = 0;

444 
äame
->
i_mb_x
 = 0;

445 
äame
->
i_mb_y
 = 0;

446 
äame
->
i_log_gİ_v®ue
 = 0;

447 
äame
->
ås
 = 0;

448 
äame
->
äame_numb”
 = 0;

449 
äame
->
äame_is_”r
 = 0;

450 
	`š™_tw_video_·ck‘_tcb_queue
(&
äame
->
video_·ck‘_queue
);

452 
	}
}

454 
	$tw_video_äame_tcb_»£t
(
tw_video_äame_tcb_t
 *
äame
)

456 if(
äame
 !ğ
NULL
){

457 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

458 
äame
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

459 
	`tw_video_äame_tcb_Çl_š™
(&
äame
->
Çl
);

460 
äame
->
äame_Ën
 = 0;

461 
äame
->
cÚsum”_äame_off£t
 = 0;

462 
äame
->
time¡amp
 = 0;

463 
äame
->
i_š™_qp
 = 
DEFAULT_QP
;

464 
äame
->
i_cu¼_qp
 = 0;

465 
äame
->
i_mb_x
 = 0;

466 
äame
->
i_mb_y
 = 0;

467 
äame
->
i_log_gİ_v®ue
 = 0;

468 
äame
->
ås
 = 0;

469 
äame
->
äame_numb”
 = 0;

470 
äame
->
äame_is_”r
 = 0;

472 
	}
}

474 
	$tw_video_äame_tcb_»Ëa£
(
tw_video_äame_tcb_t
 **
±r_äame
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

476 if(
±r_äame
 !ğ
NULL
){

477 
tw_video_äame_tcb_t
 *
äame
 = *
±r_äame
;

478 
æags
;

479 if(
video_chª_buf_poŞ
 =ğ
NULL
){

480 
video_chª_buf_poŞ
 = 
äame
->video_chan_buf_pool;

482 
	`¥š_lock_œq§ve
(&
äame
->
lock
, 
æags
);

483 if(
	`©omic_»ad
(&
äame
->
»f_couÁ
) > 1){

484 
	`©omic_dec
(&
äame
->
»f_couÁ
);

486 
tcb_node_t
 *
node
;

487 if(
äame
->
İ
 !ğ
NULL
){

488 
äame
->
İ
->
	`»£t
(frame);

490 if(
äame
->
video_·ck‘_queue
.
İ
 !ğ
NULL
){

491 
äame
->
video_·ck‘_queue
.
İ
->
	`»Ëa£
(&äame->video_·ck‘_queue, 
video_chª_buf_poŞ
);

493 
	`tw_video_·ck‘_queue_»Ëa£
(&
äame
->
video_·ck‘_queue
, 
video_chª_buf_poŞ
);

495 
node
 = &
äame
->
äame_node
;

496 if(
node
->
İ
 !ğ
NULL
){

497 
node
->
İ
->
	`»Ëa£
Òode, &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
);

500 *
±r_äame
 = 
NULL
;

501 
	`¥š_uÆock_œq»¡Üe
(&
äame
->
lock
, 
æags
);

503 
	}
}

505 
	$tw_video_äame_tcb_»ã»nû
(
tw_video_äame_tcb_t
 *
¤c_äame
,w_video_äame_tcb_ˆ**
±r_de¡_äame
)

507 if((
¤c_äame
!=
NULL
è&& (
±r_de¡_äame
!=NULL)){

508 
æags
;

509 
	`¥š_lock_œq§ve
(&
¤c_äame
->
lock
, 
æags
);

510 
	`©omic_šc
(&
¤c_äame
->
»f_couÁ
);

511 *
±r_de¡_äame
 = 
¤c_äame
;

512 
	`¥š_uÆock_œq»¡Üe
(&
¤c_äame
->
lock
, 
æags
);

514 
	}
}

516 
size_t
 
	$tw_video_äame_tcb_subm™
(
tw_video_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

518 
tw_äame_h—d”_t
 
__u£r
 *
äame_h—d”_±r
;

519 
tw_äame_h—d”_t
 
tw_äame_h—d
;

520 
tw_h264_idr_äame_·d_t
 
__u£r
 *
idr_·d_±r
;

521 
tw_h264_idr_äame_·d_t
 
idr_äame_·d
;

522 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

523 
h264_Çl_t
 *
Çl
;

524 
size_t
 
buf_size
, 
·ck‘_size
;

525 
loff_t
 
buf_off£t
, 
·ck‘_off£t
;

527 
buf_size
 = 
couÁ
;

528 
buf_off£t
 = 0;

529 if(
äame
 !ğ
NULL
){

530 
Çl
 = &
äame
->nal;

531 
äame_h—d”_±r
 = (
tw_äame_h—d”_t
*)
d©a
;

532 
buf_size
 -ğ(
tw_äame_h—d”_t
);

533 
buf_off£t
 +ğ(
tw_äame_h—d”_t
);

534 
	`mem£t
(&
tw_äame_h—d
, 0, (
tw_äame_h—d”_t
));

535 
tw_äame_h—d
.
codecTy³
 = 
TW_VIDEO_H264_CODEC_TYPE
;

536 
tw_äame_h—d
.
¡»amTy³
 = 
ma¡”OrSubFÏg
;

537 
tw_äame_h—d
.
äameS”Ÿl
 = 
äame
->
äame_numb”
;

538 
tw_äame_h—d
.
äameTy³
 = 
äame
->
äame_ty³
;

539 
tw_äame_h—d
.
timeSmp
 = 
äame
->
time¡amp
;

540 
tw_äame_h—d
.
·ylßd_off£t
 = (
tw_äame_h—d”_t
);

541 
tw_äame_h—d
.
·ylßdL’
 = 0;

542 
äame
->
äame_ty³
) {

543 
H264_FRAME_TYPE_IDR
:

544 if(
couÁ
 >ğ((
tw_äame_h—d”_t
)+(
tw_h264_idr_äame_·d_t
)+
äame
->
äame_Ën
)){

545 
idr_·d_±r
 = (
tw_h264_idr_äame_·d_t
*)
äame_h—d”_±r
->
·d
;

546 
buf_size
 -ğ(
tw_h264_idr_äame_·d_t
);

547 
buf_off£t
 +ğ(
tw_h264_idr_äame_·d_t
);

548 
tw_äame_h—d
.
·ylßdL’
 +ğ(
tw_h264_idr_äame_·d_t
);

550 
	`mem£t
(&
idr_äame_·d
, 0, (
tw_h264_idr_äame_·d_t
));

551 
idr_äame_·d
.
ås
 = 
äame
->fps;

552 
idr_äame_·d
.
š™_qp
 = 
äame
->
i_š™_qp
;

553 
idr_äame_·d
.
log2MaxF¿meNumNšus4
 = 
äame
->
i_log_gİ_v®ue
;

554 
idr_äame_·d
.
mb_width_mšus1
 = 
äame
->
i_mb_x
;

555 
idr_äame_·d
.
mb_height_mšus1
 = 
äame
->
i_mb_y
;

556 
idr_äame_·d
.
i_cu¼_qp
 = 
äame
->i_curr_qp;

558 
idr_äame_·d
.
¥s_äame_off£t
 = (
tw_h264_idr_äame_·d_t
);

559 
idr_äame_·d
.
¥s_äame_size
 = 
Çl
->
¥s_·ysize
;

560 
idr_äame_·d
.
µs_äame_off£t
 = idr_äame_·d.
¥s_äame_off£t
 + 
Çl
->
¥s_·ysize
;

561 
idr_äame_·d
.
µs_äame_size
 = 
Çl
->
µs_·ysize
;

562 
idr_äame_·d
.
idr_äame_off£t
 = idr_äame_·d.
µs_äame_off£t
 + 
Çl
->
µs_·ysize
;

563 
idr_äame_·d
.
idr_äame_size
 = 0;

565 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

566 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_packet_queue)){

567 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_packet_queue);

568 
·ck‘_size
 = 
video_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`subm™
(video_·ck‘_queue->cu¼_cÚsum”, &
d©a
[
buf_off£t
], 
buf_size
, &
·ck‘_off£t
, 
Çl
);

569 
video_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_·ck‘_queue, 
video_chª_buf_poŞ
);

570 
buf_size
 -ğ
·ck‘_size
;

571 
buf_off£t
 +ğ
·ck‘_size
;

572 
tw_äame_h—d
.
·ylßdL’
 +ğ
·ck‘_size
;

574 
buf_off£t
 & 3){

575 
	`__put_u£r
(0, &
d©a
[
buf_off£t
]);

576 
buf_size
--;

577 
buf_off£t
++;

578 
idr_äame_·d
.
idr_äame_size
++;

579 
tw_äame_h—d
.
·ylßdL’
++;

581 
idr_äame_·d
.
idr_äame_size
 +ğ
äame
->
äame_Ën
;

582 
	`cİy_to_u£r
(
äame_h—d”_±r
->
·d
, (*)&
idr_äame_·d
, (
tw_h264_idr_äame_·d_t
));

584 
buf_off£t
 = 0;

587 
H264_FRAME_TYPE_I
:

588 
H264_FRAME_TYPE_P
:

589 if(
couÁ
 >ğ((
tw_äame_h—d”_t
)+(
tw_h264_idr_äame_·d_t
)+
äame
->
äame_Ën
)){

590 
video_·ck‘_queue
 = &
äame
->video_packet_queue;

591 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_packet_queue)){

592 
video_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_packet_queue);

593 
·ck‘_size
 = 
video_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`subm™
(video_·ck‘_queue->cu¼_cÚsum”, &
d©a
[
buf_off£t
], 
buf_size
, &
·ck‘_off£t
, 
Çl
);

594 
video_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_·ck‘_queue, 
video_chª_buf_poŞ
);

595 
buf_size
 -ğ
·ck‘_size
;

596 
buf_off£t
 +ğ
·ck‘_size
;

597 
tw_äame_h—d
.
·ylßdL’
 +ğ
·ck‘_size
;

599 
buf_off£t
 & 3){

600 
	`__put_u£r
(0, &
d©a
[
buf_off£t
]);

601 
buf_size
--;

602 
buf_off£t
++;

603 
tw_äame_h—d
.
·ylßdL’
++;

606 
buf_off£t
 = 0;

610 
	`´štk
("%s.%d:ƒ¼ 264 sŒ—my³\n", 
__FUNCTION__
, 
__LINE__
);

613 if(
buf_off£t
){

614 
	`cİy_to_u£r
(
äame_h—d”_±r
, &
tw_äame_h—d
, (
tw_äame_h—d”_t
));

617 *
µos
 +ğ
buf_off£t
;

618  (
size_t
)
buf_off£t
;

619 
	}
}

621 
tw_video_äame_tcb_İ”©iÚ
 
	gtw_video_äame_tcb_İ
 = {

622 .
š™
 = 
tw_video_äame_tcb_š™
,

623 .
	g»£t
 = 
tw_video_äame_tcb_»£t
,

624 .
	g»Ëa£
 = 
tw_video_äame_tcb_»Ëa£
,

625 .
	g»ã»nû
 = 
tw_video_äame_tcb_»ã»nû
,

626 .
	gsubm™
 = 
tw_video_äame_tcb_subm™
,

629 
	$tw_video_äame_queue_g‘
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 **
±r_äame
)

631 if((
video_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

632 
tcb_node_queue_t
 *
queue
;

633 *
±r_äame
 = 
NULL
;

634 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

635 if(
queue
->
İ
 !ğ
NULL
){

636 
tcb_node_t
 *
‹mp_node
;

637 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

638 if(
‹mp_node
 !ğ
NULL
){

639 *
±r_äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

643 
	`´štk
("\n%s.%d**©‹ÁiÚ**\n", 
__FUNCTION__
, 
__LINE__
);

645 
	}
}

647 
	$tw_video_äame_queue_Œy_g‘
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 **
±r_äame
)

649 if((
video_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

650 
tcb_node_queue_t
 *
queue
;

651 *
±r_äame
 = 
NULL
;

652 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

653 if(
queue
->
İ
 !ğ
NULL
){

654 
tcb_node_t
 *
‹mp_node
;

655 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

656 if(
‹mp_node
 !ğ
NULL
){

657 *
±r_äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

661 
	}
}

663 
	$tw_video_äame_queue_g‘_”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 **
±r_äame
)

665 if((
video_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

666 
tcb_node_queue_t
 *
queue
;

667 *
±r_äame
 = 
NULL
;

668 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

669 if(
queue
->
İ
 !ğ
NULL
){

670 
tcb_node_t
 *
‹mp_node
;

671 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

672 if(
‹mp_node
 !ğ
NULL
){

673 *
±r_äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

677 
	}
}

679 
	$tw_video_äame_queue_Œy_g‘_”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 **
±r_äame
)

681 if((
video_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

682 
tcb_node_queue_t
 *
queue
;

683 *
±r_äame
 = 
NULL
;

684 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

685 if(
queue
->
İ
 !ğ
NULL
){

686 
tcb_node_t
 *
‹mp_node
;

687 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

688 if(
‹mp_node
 !ğ
NULL
){

689 *
±r_äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

693 
	}
}

695 
	$tw_video_äame_queue_put
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 *
äame
)

697 if((
video_äame_tcb_queue
!=
NULL
è&& (
äame
!=NULL)){

698 
tcb_node_queue_t
 *
queue
;

699 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

700 if(
queue
->
İ
 !ğ
NULL
){

701 
queue
->
İ
->
	`put
(queue, &
äame
->
äame_node
);

704 
	}
}

706 
	$tw_video_äame_queue_put_h—d”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_äame_tcb_t
 *
äame
)

708 if((
video_äame_tcb_queue
!=
NULL
è&& (
äame
!=NULL)){

709 
tcb_node_queue_t
 *
queue
;

710 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

711 if(
queue
->
İ
 !ğ
NULL
){

712 
queue
->
İ
->
	`put_h—d”
(queue, &
äame
->
äame_node
);

715 
	}
}

717 
	$tw_video_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

719 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

720 
æags
;

721 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

722 if(
video_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

723 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

724 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

725 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_äame_tcb
(video_chª_buf_poŞ, &
video_äame_tcb_queue
->
cu¼_´oduûr
);

727 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

729 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

731 
	}
}

733 
	$tw_video_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

735 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

736 
æags
;

737 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

738 if(
video_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

739 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

740 
video_chª_buf_poŞ
->
İ
->
	`Œy_g‘_video_äame_tcb
(video_chª_buf_poŞ, &
video_äame_tcb_queue
->
cu¼_´oduûr
);

743 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

745 
	}
}

747 
	$tw_video_äame_queue_put_cu¼_´oduûr_što_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

749 if(
video_äame_tcb_queue
 !ğ
NULL
){

750 
æags
;

751 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

752 if(
video_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

753 if(
video_äame_tcb_queue
->
İ
 !ğ
NULL
){

754 
video_äame_tcb_queue
->
İ
->
	`put
(video_äame_tcb_queue, video_äame_tcb_queue->
cu¼_´oduûr
);

756 
	`tw_video_äame_queue_put
(
video_äame_tcb_queue
, video_äame_tcb_queue->
cu¼_´oduûr
);

758 
video_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

760 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

762 
	}
}

764 
	$tw_video_äame_queue_»Ëa£_cu¼_´oduûr
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

766 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

767 
æags
;

768 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

769 if(
video_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

770 if(
video_äame_tcb_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

771 
video_äame_tcb_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&video_äame_tcb_queue->cu¼_´oduûr, 
video_chª_buf_poŞ
);

773 
	`tw_video_äame_tcb_»Ëa£
(&
video_äame_tcb_queue
->
cu¼_´oduûr
, 
video_chª_buf_poŞ
);

776 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

778 
	}
}

780 
	$tw_video_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

782 if(
video_äame_tcb_queue
 !ğ
NULL
){

783 
æags
;

785 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

786 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

787 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

788 if(
video_äame_tcb_queue
->
İ
 !ğ
NULL
){

789 
video_äame_tcb_queue
->
İ
->
	`g‘
(video_äame_tcb_queue, &video_äame_tcb_queue->
cu¼_cÚsum”
);

791 
	`tw_video_äame_queue_g‘
(
video_äame_tcb_queue
, &video_äame_tcb_queue->
cu¼_cÚsum”
);

793 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

795 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

798 
	`´štk
("\n%s.%d**©‹ÁiÚ**\n", 
__FUNCTION__
, 
__LINE__
);

800 
	}
}

802 
	$tw_video_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

804 if(
video_äame_tcb_queue
 !ğ
NULL
){

805 
æags
;

806 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

807 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

808 if(
video_äame_tcb_queue
->
İ
 !ğ
NULL
){

809 
video_äame_tcb_queue
->
İ
->
	`Œy_g‘
(video_äame_tcb_queue, &video_äame_tcb_queue->
cu¼_cÚsum”
);

811 
	`tw_video_äame_queue_Œy_g‘
(
video_äame_tcb_queue
, &video_äame_tcb_queue->
cu¼_cÚsum”
);

814 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

816 
	}
}

818 
	$tw_video_äame_queue_»Ëa£_cu¼_cÚsum”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

820 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

821 
æags
;

822 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

823 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

824 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

825 
video_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&video_äame_tcb_queue->cu¼_cÚsum”, 
video_chª_buf_poŞ
);

827 
	`tw_video_äame_tcb_»Ëa£
(&
video_äame_tcb_queue
->
cu¼_cÚsum”
, 
video_chª_buf_poŞ
);

830 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

832 
	}
}

834 
	$tw_video_äame_queue_put_cu¼_cÚsum”_što_queue_h—d”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

836 if(
video_äame_tcb_queue
 !ğ
NULL
){

837 
æags
;

838 
	`¥š_lock_œq§ve
(&
video_äame_tcb_queue
->
lock
, 
æags
);

839 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

840 if(
video_äame_tcb_queue
->
İ
 !ğ
NULL
){

841 
video_äame_tcb_queue
->
İ
->
	`put_h—d”
(video_äame_tcb_queue, video_äame_tcb_queue->
cu¼_cÚsum”
);

843 
	`tw_video_äame_queue_put_h—d”
(
video_äame_tcb_queue
, video_äame_tcb_queue->
cu¼_cÚsum”
);

845 
video_äame_tcb_queue
->
cu¼_cÚsum”
 = 
NULL
;

847 
	`¥š_uÆock_œq»¡Üe
(&
video_äame_tcb_queue
->
lock
, 
æags
);

849 
	}
}

851 
	$tw_video_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

853 
’Œy_numb”
 = 0;

854 if(
video_äame_tcb_queue
!=
NULL
){

855 
tcb_node_queue_t
 *
queue
;

856 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

857 if(
queue
->
İ
 !ğ
NULL
){

858 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

861  
’Œy_numb”
;

862 
	}
}

864 
	$tw_video_äame_queue_»Ëa£
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

866 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

867 
	`»move_tw_video_äame_tcb_queue
(
video_äame_tcb_queue
, 
video_chª_buf_poŞ
);

869 
	}
}

871 
	$tw_video_äame_queue_š™
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

873 if(
video_äame_tcb_queue
 !ğ
NULL
){

874 
tcb_node_queue_t
 *
queue
;

875 
queue
 = &
video_äame_tcb_queue
->
queue_node
;

876 
queue
->
İ
 = &
tcb_node_queue_İ
;

877 
queue
->
İ
->
	`š™
(queue);

878 
video_äame_tcb_queue
->
cu¼_cÚsum”
 = 
NULL
;

879 
video_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

880 
video_äame_tcb_queue
->
¡¬t_time¡amp
 = 0;

881 
video_äame_tcb_queue
->
tÙ®_du¿tiÚ
 = 0;

882 
	`¥š_lock_š™
(&
video_äame_tcb_queue
->
lock
);

884 
	}
}

886 
tw_video_äame_queue_İ”©iÚ
 
	gtw_video_äame_queue_İ
 = {

887 .
g‘
 = 
tw_video_äame_queue_g‘
,

888 .
	gŒy_g‘
 = 
tw_video_äame_queue_Œy_g‘
,

889 .
	gg‘_”
 = 
tw_video_äame_queue_g‘_”
,

890 .
	gŒy_g‘_”
 = 
tw_video_äame_queue_Œy_g‘_”
,

891 .
	gput
 = 
tw_video_äame_queue_put
,

892 .
	gput_h—d”
 = 
tw_video_äame_queue_put_h—d”
,

894 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
,

895 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

896 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_video_äame_queue_put_cu¼_´oduûr_što_queue
,

897 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_video_äame_queue_»Ëa£_cu¼_´oduûr
,

898 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_äame_queue_g‘_cu¼_cÚsum”_äom_queue
,

899 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

900 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_video_äame_queue_»Ëa£_cu¼_cÚsum”
,

901 .
	gput_cu¼_cÚsum”_što_queue_h—d”
 = 
tw_video_äame_queue_put_cu¼_cÚsum”_što_queue_h—d”
,

903 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_video_äame_queue_g‘_cu¼_queue_’Œy_numb”
,

904 .
	g»Ëa£
 = 
tw_video_äame_queue_»Ëa£
,

905 .
	gš™
 = 
tw_video_äame_queue_š™
,

908 
	$š™_tw_video_äame_tcb_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
)

910 if(
video_äame_tcb_queue
 !ğ
NULL
){

911 
video_äame_tcb_queue
->
İ
 = &
tw_video_äame_queue_İ
;

912 
video_äame_tcb_queue
->
İ
->
	`š™
(video_frame_tcb_queue);

914 
	}
}

916 
	$»move_tw_video_äame_tcb_queue
(
tw_video_äame_tcb_queue_t
 *
video_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

918 if((
video_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

919 if(
video_äame_tcb_queue
->
İ
 !ğ
NULL
){

920 
video_äame_tcb_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_frame_tcb_queue);

921 
video_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_äame_tcb_queue, 
video_chª_buf_poŞ
);

922 
video_äame_tcb_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_frame_tcb_queue)){

923 
video_äame_tcb_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_frame_tcb_queue);

924 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

927 
video_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_äame_tcb_queue, 
video_chª_buf_poŞ
);

930 
	`tw_video_äame_queue_put_cu¼_´oduûr_što_queue
(
video_äame_tcb_queue
);

931 
	`tw_video_äame_queue_»Ëa£_cu¼_cÚsum”
(
video_äame_tcb_queue
, 
video_chª_buf_poŞ
);

932 
	`tw_video_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
video_äame_tcb_queue
)){

933 
	`tw_video_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
video_äame_tcb_queue
);

934 if(
video_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

937 
	`tw_video_äame_queue_»Ëa£_cu¼_cÚsum”
(
video_äame_tcb_queue
, 
video_chª_buf_poŞ
);

941 
	}
}

943 #ifdeà 
MV_MODULE


944 
	$tw_video_mv_·ck‘_tcb_š™
(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
, 
id
)

946 if((
·ck‘
!=
NULL
è&& (
poŞ
!=NULL)){

947 
tcb_node_t
 *
node
 = &
·ck‘
->
mv_·ck‘_node
;

948 
	`¥š_lock_š™
(&
·ck‘
->
lock
);

949 
	`©omic_£t
(&
·ck‘
->
»f_couÁ
, 0);

950 
node
->
İ
 = &
tcb_node_İ
;

951 
node
->
İ
->
	`š™
(node);

952 
node
->
İ
->
	`£t_´iv
Òode, 
·ck‘
);

953 
·ck‘
->
d©a_size
 = 
poŞ
->
mv_·ck‘_bufãr_size
;

954 
·ck‘
->
d©a
 = &
poŞ
->
mv_ÿche_bufãr
[poŞ->
mv_·ck‘_bufãr_size
*
id
];

955 
·ck‘
->
mvVeùÜ_buf
 =…ack‘->
d©a
;

956 
·ck‘
->
mvVeùÜ_Ën
 = 0;

957 
·ck‘
->
dma_addr
 = 0;

959 
	}
}

961 
	$tw_video_mv_·ck‘_tcb_»£t
(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
)

963 if(
·ck‘
!=
NULL
){

964 
·ck‘
->
mvVeùÜ_buf
 =…ack‘->
d©a
;

965 
·ck‘
->
mvVeùÜ_Ën
 = 0;

966 
·ck‘
->
dma_addr
 = 0;

968 
	}
}

970 
	$tw_video_mv_·ck‘_tcb_»Ëa£
(
tw_video_mv_·ck‘_tcb_t
 **
±r_·ck‘
, 
tw_video_chª_buf_poŞ_t
 *
poŞ
)

972 if((*
±r_·ck‘
!=
NULL
è&& (
poŞ
!=NULL)){

973 
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
 = *
±r_·ck‘
;

974 
æags
;

976 
	`¥š_lock_œq§ve
(&
·ck‘
->
lock
, 
æags
);

977 if(
	`©omic_»ad
(&
·ck‘
->
»f_couÁ
) > 1){

978 
	`©omic_dec
(&
·ck‘
->
»f_couÁ
);

980 
tcb_node_t
 *
node
;

981 if(
·ck‘
->
İ
 !ğ
NULL
){

982 
·ck‘
->
İ
->
	`»£t
(packet);

984 
node
 = &
·ck‘
->
mv_·ck‘_node
;

985 if(
node
->
İ
 !ğ
NULL
){

986 
node
->
İ
->
	`»Ëa£
Òode, &
poŞ
->
mv_·ck‘_poŞ_tcb
);

988 *
±r_·ck‘
 = 
NULL
;

990 
	`¥š_uÆock_œq»¡Üe
(&
·ck‘
->
lock
, 
æags
);

992 
	}
}

994 
	$tw_video_mv_·ck‘_tcb_»ã»nû
(
tw_video_mv_·ck‘_tcb_t
 *
¤c_·ck‘
,w_video_mv_·ck‘_tcb_ˆ**
±r_de¡_·ck‘
)

996 if((
¤c_·ck‘
!=
NULL
è&& (
±r_de¡_·ck‘
!=NULL)){

997 
æags
;

999 
	`¥š_lock_œq§ve
(&
¤c_·ck‘
->
lock
, 
æags
);

1000 
	`©omic_šc
(&
¤c_·ck‘
->
»f_couÁ
);

1001 *
±r_de¡_·ck‘
 = 
¤c_·ck‘
;

1002 
	`¥š_uÆock_œq»¡Üe
(&
¤c_·ck‘
->
lock
, 
æags
);

1004 
	}
}

1006 
	$tw_video_mv_·ck‘_tcb_dma_m­
(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

1008 if(
·ck‘
 !ğ
NULL
) {

1009 if(
·ck‘
->
d©a
 !ğ
NULL
) {

1010 
·ck‘
->
dma_addr
 = 
	`dma_m­_sšgË
(
NULL
,…ack‘->
d©a
,…ack‘->
d©a_size
, 
dœeùiÚ
);

1011 ià(
·ck‘
->
dma_addr
 == 0){

1012 
	`´štk
("dma_map_singleƒrr\n");

1016 
	}
}

1018 
	$tw_video_mv_·ck‘_tcb_dma_unm­
(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

1020 if(
·ck‘
 !ğ
NULL
) {

1021 ià(
·ck‘
->
dma_addr
 != 0) {

1022 
	`dma_unm­_sšgË
(
NULL
, 
·ck‘
->
dma_addr
,…ack‘->
d©a_size
, 
dœeùiÚ
);

1023 
·ck‘
->
dma_addr
 = 0;

1026 
	}
}

1028 
size_t
 
	$tw_video_mv_·ck‘_tcb_subm™
(
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
)

1030 
loff_t
 
buf_off£t
 = 0;

1031 if(
·ck‘
 !ğ
NULL
){

1032 
	`cİy_to_u£r
(
d©a
, 
·ck‘
->
mvVeùÜ_buf
,…ack‘->
mvVeùÜ_Ën
);

1033 
buf_off£t
 = 
·ck‘
->
mvVeùÜ_Ën
;

1035 *
µos
 +ğ
buf_off£t
;

1036  (
size_t
)
buf_off£t
;

1037 
	}
}

1039 
tw_video_mv_·ck‘_tcb_İ”©iÚ
 
	gtw_video_mv_·ck‘_tcb_İ
 = {

1040 .
š™
 = 
tw_video_mv_·ck‘_tcb_š™
,

1041 .
	g»£t
 = 
tw_video_mv_·ck‘_tcb_»£t
,

1042 .
	g»Ëa£
 = 
tw_video_mv_·ck‘_tcb_»Ëa£
,

1043 .
	g»ã»nû
 = 
tw_video_mv_·ck‘_tcb_»ã»nû
,

1045 .
	gdma_m­
 = 
tw_video_mv_·ck‘_tcb_dma_m­
,

1046 .
	gdma_unm­
 = 
tw_video_mv_·ck‘_tcb_dma_unm­
,

1048 .
	gsubm™
 = 
tw_video_mv_·ck‘_tcb_subm™
,

1051 
	$tw_video_mv_·ck‘_tcb_queue_g‘
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 **
±r_video_mv_·ck‘_tcb
)

1053 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
±r_video_mv_·ck‘_tcb
!=NULL)){

1054 
tcb_node_queue_t
 *
queue
;

1055 *
±r_video_mv_·ck‘_tcb
 = 
NULL
;

1056 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1057 if(
queue
->
İ
 !ğ
NULL
){

1058 
tcb_node_t
 *
‹mp_node
;

1059 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

1060 if(
‹mp_node
 !ğ
NULL
){

1061 *
±r_video_mv_·ck‘_tcb
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

1065 
	}
}

1067 
	$tw_video_mv_·ck‘_tcb_queue_Œy_g‘
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 **
±r_video_mv_·ck‘_tcb
)

1069 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
±r_video_mv_·ck‘_tcb
!=NULL)){

1070 
tcb_node_queue_t
 *
queue
;

1071 *
±r_video_mv_·ck‘_tcb
 = 
NULL
;

1072 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1073 if(
queue
->
İ
 !ğ
NULL
){

1074 
tcb_node_t
 *
‹mp_node
;

1075 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

1076 if(
‹mp_node
 !ğ
NULL
){

1077 *
±r_video_mv_·ck‘_tcb
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

1081 
	}
}

1083 
	$tw_video_mv_·ck‘_tcb_queue_g‘_”
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 **
±r_video_mv_·ck‘_tcb
)

1085 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
±r_video_mv_·ck‘_tcb
!=NULL)){

1086 
tcb_node_queue_t
 *
queue
;

1087 *
±r_video_mv_·ck‘_tcb
 = 
NULL
;

1088 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1089 if(
queue
->
İ
 !ğ
NULL
){

1090 
tcb_node_t
 *
‹mp_node
;

1091 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

1092 if(
‹mp_node
 !ğ
NULL
){

1093 *
±r_video_mv_·ck‘_tcb
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

1097 
	}
}

1099 
	$tw_video_mv_·ck‘_tcb_queue_Œy_g‘_”
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 **
±r_video_mv_·ck‘_tcb
)

1101 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
±r_video_mv_·ck‘_tcb
!=NULL)){

1102 
tcb_node_queue_t
 *
queue
;

1103 *
±r_video_mv_·ck‘_tcb
 = 
NULL
;

1104 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1105 if(
queue
->
İ
 !ğ
NULL
){

1106 
tcb_node_t
 *
‹mp_node
;

1107 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

1108 if(
‹mp_node
 !ğ
NULL
){

1109 *
±r_video_mv_·ck‘_tcb
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

1113 
	}
}

1115 
	$tw_video_mv_·ck‘_tcb_queue_put
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 *
video_mv_·ck‘_tcb
)

1117 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_mv_·ck‘_tcb
!=NULL)){

1118 
tcb_node_queue_t
 *
queue
;

1119 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1120 if(
queue
->
İ
 !ğ
NULL
){

1121 
queue
->
İ
->
	`put
(queue, &
video_mv_·ck‘_tcb
->
mv_·ck‘_node
);

1124 
	}
}

1126 
	$tw_video_mv_·ck‘_tcb_queue_put_h—d”
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_mv_·ck‘_tcb_t
 *
video_mv_·ck‘_tcb
)

1128 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_mv_·ck‘_tcb
!=NULL)){

1129 
tcb_node_queue_t
 *
queue
;

1130 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1131 if(
queue
->
İ
 !ğ
NULL
){

1132 
queue
->
İ
->
	`put_h—d”
(queue, &
video_mv_·ck‘_tcb
->
mv_·ck‘_node
);

1135 
	}
}

1137 
	$tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1139 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1140 
æags
;

1141 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1142 if(
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

1143 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1144 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

1145 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_mv_·ck‘_tcb
(video_chª_buf_poŞ, &
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
);

1147 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1149 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1151 
	}
}

1153 
	$tw_video_mv_·ck‘_tcb_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1155 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1156 
æags
;

1157 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1158 if(
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

1159 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

1160 
video_chª_buf_poŞ
->
İ
->
	`Œy_g‘_video_mv_·ck‘_tcb
(video_chª_buf_poŞ, &
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
);

1163 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1165 
	}
}

1167 
	$tw_video_mv_·ck‘_tcb_queue_put_cu¼_´oduûr_što_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
)

1169 if(
video_mv_·ck‘_tcb_queue
 !ğ
NULL
){

1170 
æags
;

1171 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1172 if(
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

1173 if(
video_mv_·ck‘_tcb_queue
->
İ
 !ğ
NULL
){

1174 
video_mv_·ck‘_tcb_queue
->
İ
->
	`put
(video_mv_·ck‘_tcb_queue, video_mv_·ck‘_tcb_queue->
cu¼_´oduûr
);

1176 
	`tw_video_mv_·ck‘_tcb_queue_put
(
video_mv_·ck‘_tcb_queue
, video_mv_·ck‘_tcb_queue->
cu¼_´oduûr
);

1178 
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

1180 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1182 
	}
}

1184 
	$tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_´oduûr
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1186 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1187 
æags
;

1188 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1189 if(
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

1190 if(
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

1191 
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&video_mv_·ck‘_tcb_queue->cu¼_´oduûr, 
video_chª_buf_poŞ
);

1193 
	`tw_video_mv_·ck‘_tcb_»Ëa£
(&
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
, 
video_chª_buf_poŞ
);

1196 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1198 
	}
}

1200 
	$tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
)

1202 if(
video_mv_·ck‘_tcb_queue
 !ğ
NULL
){

1203 
æags
;

1204 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1205 if(
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1206 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1207 if(
video_mv_·ck‘_tcb_queue
->
İ
 !ğ
NULL
){

1208 
video_mv_·ck‘_tcb_queue
->
İ
->
	`g‘
(video_mv_·ck‘_tcb_queue, &video_mv_·ck‘_tcb_queue->
cu¼_cÚsum”
);

1210 
	`tw_video_mv_·ck‘_tcb_queue_g‘
(
video_mv_·ck‘_tcb_queue
, &video_mv_·ck‘_tcb_queue->
cu¼_cÚsum”
);

1212 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1214 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1216 
	}
}

1218 
	$tw_video_mv_·ck‘_tcb_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
)

1220 if(
video_mv_·ck‘_tcb_queue
 !ğ
NULL
){

1221 
æags
;

1222 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1223 if(
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1224 if(
video_mv_·ck‘_tcb_queue
->
İ
 !ğ
NULL
){

1225 
video_mv_·ck‘_tcb_queue
->
İ
->
	`Œy_g‘
(video_mv_·ck‘_tcb_queue, &video_mv_·ck‘_tcb_queue->
cu¼_cÚsum”
);

1227 
	`tw_video_mv_·ck‘_tcb_queue_Œy_g‘
(
video_mv_·ck‘_tcb_queue
, &video_mv_·ck‘_tcb_queue->
cu¼_cÚsum”
);

1230 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1232 
	}
}

1234 
	$tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_cÚsum”
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1236 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1237 
æags
;

1238 
	`¥š_lock_œq§ve
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1239 if(
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

1240 if(
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

1241 
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&video_mv_·ck‘_tcb_queue->cu¼_cÚsum”, 
video_chª_buf_poŞ
);

1243 
	`tw_video_mv_·ck‘_tcb_»Ëa£
(&
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
, 
video_chª_buf_poŞ
);

1246 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_·ck‘_tcb_queue
->
lock
, 
æags
);

1248 
	}
}

1250 
	$tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
)

1252 
’Œy_numb”
 = 0;

1253 if(
video_mv_·ck‘_tcb_queue
!=
NULL
){

1254 
tcb_node_queue_t
 *
queue
;

1255 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1256 if(
queue
->
İ
 !ğ
NULL
){

1257 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

1260  
’Œy_numb”
;

1261 
	}
}

1263 
	$tw_video_mv_·ck‘_tcb_queue_»Ëa£
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1265 if((
video_mv_·ck‘_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1266 
	`»move_tw_video_mv_·ck‘_tcb_queue
(
video_mv_·ck‘_tcb_queue
, 
video_chª_buf_poŞ
);

1268 
	}
}

1270 
	$tw_video_mv_·ck‘_tcb_queue_š™
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_tcb_queue
)

1272 if(
video_mv_·ck‘_tcb_queue
 !ğ
NULL
){

1273 
tcb_node_queue_t
 *
queue
;

1274 
queue
 = &
video_mv_·ck‘_tcb_queue
->
queue_node
;

1275 
queue
->
İ
 = &
tcb_node_queue_İ
;

1276 
queue
->
İ
->
	`š™
(queue);

1277 
video_mv_·ck‘_tcb_queue
->
cu¼_cÚsum”
 = 
NULL
;

1278 
video_mv_·ck‘_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

1279 
video_mv_·ck‘_tcb_queue
->
¡¬t_time¡amp
 = 0;

1280 
video_mv_·ck‘_tcb_queue
->
tÙ®_du¿tiÚ
 = 0;

1281 
	`¥š_lock_š™
(&
video_mv_·ck‘_tcb_queue
->
lock
);

1283 
	}
}

1285 
tw_video_mv_·ck‘_tcb_queue_İ”©iÚ
 
	gtw_video_mv_·ck‘_tcb_queue_İ
 = {

1286 .
g‘
 = 
tw_video_mv_·ck‘_tcb_queue_g‘
,

1287 .
	gŒy_g‘
 = 
tw_video_mv_·ck‘_tcb_queue_Œy_g‘
,

1288 .
	gg‘_”
 = 
tw_video_mv_·ck‘_tcb_queue_g‘_”
,

1289 .
	gŒy_g‘_”
 = 
tw_video_mv_·ck‘_tcb_queue_Œy_g‘_”
,

1290 .
	gput
 = 
tw_video_mv_·ck‘_tcb_queue_put
,

1291 .
	gput_h—d”
 = 
tw_video_mv_·ck‘_tcb_queue_put_h—d”
,

1293 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_´oduûr_äom_poŞ
,

1294 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_mv_·ck‘_tcb_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

1295 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_video_mv_·ck‘_tcb_queue_put_cu¼_´oduûr_što_queue
,

1296 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_´oduûr
,

1297 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
,

1298 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_mv_·ck‘_tcb_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

1299 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_cÚsum”
,

1301 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_queue_’Œy_numb”
,

1302 .
	g»Ëa£
 = 
tw_video_mv_·ck‘_tcb_queue_»Ëa£
,

1303 .
	gš™
 = 
tw_video_mv_·ck‘_tcb_queue_š™
,

1306 
	$š™_tw_video_mv_·ck‘_tcb_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_queue
)

1308 if(
video_mv_·ck‘_queue
 !ğ
NULL
){

1309 
video_mv_·ck‘_queue
->
İ
 = &
tw_video_mv_·ck‘_tcb_queue_İ
;

1310 
video_mv_·ck‘_queue
->
İ
->
	`š™
(video_mv_packet_queue);

1312 
	}
}

1314 
	$»move_tw_video_mv_·ck‘_tcb_queue
(
tw_video_mv_·ck‘_tcb_queue_t
 *
video_mv_·ck‘_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1316 if((
video_mv_·ck‘_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1317 if(
video_mv_·ck‘_queue
->
İ
 !ğ
NULL
){

1318 
video_mv_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_mv_packet_queue);

1319 
video_mv_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_mv_·ck‘_queue, 
video_chª_buf_poŞ
);

1320 
video_mv_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_mv_packet_queue)){

1321 
video_mv_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_mv_packet_queue);

1322 if(
video_mv_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1325 
video_mv_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_mv_·ck‘_queue, 
video_chª_buf_poŞ
);

1328 
	`tw_video_mv_·ck‘_tcb_queue_put_cu¼_´oduûr_što_queue
(
video_mv_·ck‘_queue
);

1329 
	`tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_cÚsum”
(
video_mv_·ck‘_queue
, 
video_chª_buf_poŞ
);

1330 
	`tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_queue_’Œy_numb”
(
video_mv_·ck‘_queue
)){

1331 
	`tw_video_mv_·ck‘_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
(
video_mv_·ck‘_queue
);

1332 if(
video_mv_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1335 
	`tw_video_mv_·ck‘_tcb_queue_»Ëa£_cu¼_cÚsum”
(
video_mv_·ck‘_queue
, 
video_chª_buf_poŞ
);

1339 
	}
}

1341 
	$tw_video_mv_äame_tcb_š™
(
tw_video_mv_äame_tcb_t
 *
äame
)

1343 if(
äame
!=
NULL
){

1344 
tcb_node_t
 *
node
 = &
äame
->
mv_äame_node
;

1345 
node
->
İ
 = &
tcb_node_İ
;

1346 
node
->
İ
->
	`š™
(node);

1347 
node
->
İ
->
	`£t_´iv
Òode, 
äame
);

1349 
	`¥š_lock_š™
(&
äame
->
lock
);

1350 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

1351 
	`mem£t
(
äame
->
mvFÏg_buf
, 0, 
MÙiÚVeùÜB™FÏg_BUF_LEN
);

1352 
äame
->
mvFÏg_Ën
 = 0;

1353 
äame
->
mvBuf_·yLßdL’
 = 0;

1354 
äame
->
time¡amp
 = 0;

1355 
äame
->
äame_numb”
 = 0;

1356 
	`š™_tw_video_mv_·ck‘_tcb_queue
(&
äame
->
mv_queue
);

1358 
	}
}

1360 
	$tw_video_mv_äame_tcb_»£t
(
tw_video_mv_äame_tcb_t
 *
äame
)

1362 if(
äame
 !ğ
NULL
){

1363 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

1364 
	`mem£t
(
äame
->
mvFÏg_buf
, 0, 
MÙiÚVeùÜB™FÏg_BUF_LEN
);

1365 
äame
->
mvFÏg_Ën
 = 0;

1366 
äame
->
mvBuf_·yLßdL’
 = 0;

1367 
äame
->
time¡amp
 = 0;

1368 
äame
->
äame_numb”
 = 0;

1370 
	}
}

1372 
	$tw_video_mv_äame_tcb_»Ëa£
(
tw_video_mv_äame_tcb_t
 **
±r_äame
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1374 if((
±r_äame
!=
NULL
)){

1375 
tw_video_mv_äame_tcb_t
 *
äame
 = *
±r_äame
;

1376 
æags
;

1377 if(
video_chª_buf_poŞ
 =ğ
NULL
){

1378 
video_chª_buf_poŞ
 = 
äame
->video_chan_buf_pool;

1380 
	`¥š_lock_œq§ve
(&
äame
->
lock
, 
æags
);

1381 if(
	`©omic_»ad
(&
äame
->
»f_couÁ
) > 1){

1382 
	`©omic_dec
(&
äame
->
»f_couÁ
);

1384 
tcb_node_t
 *
node
;

1385 if(
äame
->
İ
 !ğ
NULL
){

1386 
äame
->
İ
->
	`»£t
(frame);

1388 if(
äame
->
mv_queue
.
İ
 !ğ
NULL
){

1389 
äame
->
mv_queue
.
İ
->
	`»Ëa£
(&äame->mv_queue, 
video_chª_buf_poŞ
);

1391 
	`tw_video_mv_·ck‘_tcb_queue_»Ëa£
(&
äame
->
mv_queue
, 
video_chª_buf_poŞ
);

1393 
node
 = &
äame
->
mv_äame_node
;

1394 if(
node
->
İ
 !ğ
NULL
){

1395 
node
->
İ
->
	`»Ëa£
Òode, &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
);

1397 *
±r_äame
 = 
NULL
;

1399 
	`¥š_uÆock_œq»¡Üe
(&
äame
->
lock
, 
æags
);

1401 
	}
}

1403 
	$tw_video_mv_äame_tcb_»ã»nû
(
tw_video_mv_äame_tcb_t
 *
¤c_äame
,w_video_mv_äame_tcb_ˆ**
±r_de¡_äame
)

1405 if((
¤c_äame
!=
NULL
è&& (
±r_de¡_äame
!=NULL)){

1406 
æags
;

1407 
	`¥š_lock_œq§ve
(&
¤c_äame
->
lock
, 
æags
);

1408 
	`©omic_šc
(&
¤c_äame
->
»f_couÁ
);

1409 *
±r_de¡_äame
 = 
¤c_äame
;

1410 
	`¥š_uÆock_œq»¡Üe
(&
¤c_äame
->
lock
, 
æags
);

1412 
	}
}

1414 
size_t
 
	$tw_video_mv_äame_tcb_subm™
(
tw_video_mv_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1417 
	}
}

1419 
tw_video_mv_äame_tcb_İ”©iÚ
 
	gtw_video_mv_äame_tcb_İ
 = {

1420 .
š™
 = 
tw_video_mv_äame_tcb_š™
,

1421 .
	g»£t
 = 
tw_video_mv_äame_tcb_»£t
,

1422 .
	g»Ëa£
 = 
tw_video_mv_äame_tcb_»Ëa£
,

1423 .
	g»ã»nû
 = 
tw_video_mv_äame_tcb_»ã»nû
,

1424 .
	gsubm™
 = 
tw_video_mv_äame_tcb_subm™
,

1427 
	$tw_video_mv_äame_tcb_queue_g‘
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 **
±r_video_mv_äame_tcb
)

1429 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
±r_video_mv_äame_tcb
!=NULL)){

1430 
tcb_node_queue_t
 *
queue
;

1431 *
±r_video_mv_äame_tcb
 = 
NULL
;

1432 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1433 if(
queue
->
İ
 !ğ
NULL
){

1434 
tcb_node_t
 *
‹mp_node
;

1435 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

1436 if(
‹mp_node
 !ğ
NULL
){

1437 *
±r_video_mv_äame_tcb
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

1441 
	}
}

1443 
	$tw_video_mv_äame_tcb_queue_Œy_g‘
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 **
±r_video_mv_äame_tcb
)

1445 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
±r_video_mv_äame_tcb
!=NULL)){

1446 
tcb_node_queue_t
 *
queue
;

1447 *
±r_video_mv_äame_tcb
 = 
NULL
;

1448 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1449 if(
queue
->
İ
 !ğ
NULL
){

1450 
tcb_node_t
 *
‹mp_node
;

1451 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

1452 if(
‹mp_node
 !ğ
NULL
){

1453 *
±r_video_mv_äame_tcb
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

1457 
	}
}

1459 
	$tw_video_mv_äame_tcb_queue_g‘_”
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 **
±r_video_mv_äame_tcb
)

1461 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
±r_video_mv_äame_tcb
!=NULL)){

1462 
tcb_node_queue_t
 *
queue
;

1463 *
±r_video_mv_äame_tcb
 = 
NULL
;

1464 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1465 if(
queue
->
İ
 !ğ
NULL
){

1466 
tcb_node_t
 *
‹mp_node
;

1467 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

1468 if(
‹mp_node
 !ğ
NULL
){

1469 *
±r_video_mv_äame_tcb
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

1473 
	}
}

1475 
	$tw_video_mv_äame_tcb_queue_Œy_g‘_”
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 **
±r_video_mv_äame_tcb
)

1477 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
±r_video_mv_äame_tcb
!=NULL)){

1478 
tcb_node_queue_t
 *
queue
;

1479 *
±r_video_mv_äame_tcb
 = 
NULL
;

1480 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1481 if(
queue
->
İ
 !ğ
NULL
){

1482 
tcb_node_t
 *
‹mp_node
;

1483 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

1484 if(
‹mp_node
 !ğ
NULL
){

1485 *
±r_video_mv_äame_tcb
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

1489 
	}
}

1491 
	$tw_video_mv_äame_tcb_queue_put
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 *
video_mv_äame_tcb
)

1493 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_mv_äame_tcb
!=NULL)){

1494 
tcb_node_queue_t
 *
queue
;

1495 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1496 if(
queue
->
İ
 !ğ
NULL
){

1497 
queue
->
İ
->
	`put
(queue, &
video_mv_äame_tcb
->
mv_äame_node
);

1500 
	}
}

1502 
	$tw_video_mv_äame_tcb_queue_put_h—d”
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_mv_äame_tcb_t
 *
video_mv_äame_tcb
)

1504 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_mv_äame_tcb
!=NULL)){

1505 
tcb_node_queue_t
 *
queue
;

1506 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1507 if(
queue
->
İ
 !ğ
NULL
){

1508 
queue
->
İ
->
	`put_h—d”
(queue, &
video_mv_äame_tcb
->
mv_äame_node
);

1511 
	}
}

1513 
	$tw_video_mv_äame_tcb_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1515 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1516 
æags
;

1517 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1518 if(
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

1519 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1520 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

1521 
video_chª_buf_poŞ
->
İ
->
	`g‘_video_mv_äame_tcb
(video_chª_buf_poŞ, &
video_mv_äame_tcb_queue
->
cu¼_´oduûr
);

1523 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1525 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1527 
	}
}

1529 
	$tw_video_mv_äame_tcb_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1531 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1532 
æags
;

1533 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1534 if(
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

1535 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

1536 
video_chª_buf_poŞ
->
İ
->
	`Œy_g‘_video_mv_äame_tcb
(video_chª_buf_poŞ, &
video_mv_äame_tcb_queue
->
cu¼_´oduûr
);

1539 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1541 
	}
}

1543 
	$tw_video_mv_äame_tcb_queue_put_cu¼_´oduûr_što_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1545 if(
video_mv_äame_tcb_queue
 !ğ
NULL
){

1546 
æags
;

1547 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1548 if(
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

1549 if(
video_mv_äame_tcb_queue
->
İ
 !ğ
NULL
){

1550 
video_mv_äame_tcb_queue
->
İ
->
	`put
(video_mv_äame_tcb_queue, video_mv_äame_tcb_queue->
cu¼_´oduûr
);

1552 
	`tw_video_mv_äame_tcb_queue_put
(
video_mv_äame_tcb_queue
, video_mv_äame_tcb_queue->
cu¼_´oduûr
);

1554 
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

1556 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1558 
	}
}

1560 
	$tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_´oduûr
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1562 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1563 
æags
;

1564 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1565 if(
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

1566 if(
video_mv_äame_tcb_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

1567 
video_mv_äame_tcb_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&video_mv_äame_tcb_queue->cu¼_´oduûr, 
video_chª_buf_poŞ
);

1569 
	`tw_video_mv_äame_tcb_»Ëa£
(&
video_mv_äame_tcb_queue
->
cu¼_´oduûr
, 
video_chª_buf_poŞ
);

1572 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1574 
	}
}

1576 
	$tw_video_mv_äame_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1578 if(
video_mv_äame_tcb_queue
 !ğ
NULL
){

1579 
æags
;

1580 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1581 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1582 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1583 if(
video_mv_äame_tcb_queue
->
İ
 !ğ
NULL
){

1584 
video_mv_äame_tcb_queue
->
İ
->
	`g‘
(video_mv_äame_tcb_queue, &video_mv_äame_tcb_queue->
cu¼_cÚsum”
);

1586 
	`tw_video_mv_äame_tcb_queue_g‘
(
video_mv_äame_tcb_queue
, &video_mv_äame_tcb_queue->
cu¼_cÚsum”
);

1588 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1590 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1592 
	}
}

1594 
	$tw_video_mv_äame_tcb_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1596 if(
video_mv_äame_tcb_queue
 !ğ
NULL
){

1597 
æags
;

1598 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1599 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1600 if(
video_mv_äame_tcb_queue
->
İ
 !ğ
NULL
){

1601 
video_mv_äame_tcb_queue
->
İ
->
	`Œy_g‘
(video_mv_äame_tcb_queue, &video_mv_äame_tcb_queue->
cu¼_cÚsum”
);

1603 
	`tw_video_mv_äame_tcb_queue_Œy_g‘
(
video_mv_äame_tcb_queue
, &video_mv_äame_tcb_queue->
cu¼_cÚsum”
);

1606 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1608 
	}
}

1610 
	$tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_cÚsum”
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1612 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1613 
æags
;

1614 
	`¥š_lock_œq§ve
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1615 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

1616 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

1617 
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&video_mv_äame_tcb_queue->cu¼_cÚsum”, 
video_chª_buf_poŞ
);

1619 
	`tw_video_mv_äame_tcb_»Ëa£
(&
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
, 
video_chª_buf_poŞ
);

1622 
	`¥š_uÆock_œq»¡Üe
(&
video_mv_äame_tcb_queue
->
lock
, 
æags
);

1624 
	}
}

1626 
	$tw_video_mv_äame_tcb_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1628 
’Œy_numb”
 = 0;

1629 if(
video_mv_äame_tcb_queue
!=
NULL
){

1630 
tcb_node_queue_t
 *
queue
;

1631 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1632 if(
queue
->
İ
 !ğ
NULL
){

1633 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

1636  
’Œy_numb”
;

1637 
	}
}

1639 
	$tw_video_mv_äame_tcb_queue_»Ëa£
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1641 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1642 
	`»move_tw_video_mv_äame_tcb_queue
(
video_mv_äame_tcb_queue
, 
video_chª_buf_poŞ
);

1644 
	}
}

1646 
	$tw_video_mv_äame_tcb_queue_š™
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1648 if(
video_mv_äame_tcb_queue
 !ğ
NULL
){

1649 
tcb_node_queue_t
 *
queue
;

1650 
queue
 = &
video_mv_äame_tcb_queue
->
queue_node
;

1651 
queue
->
İ
 = &
tcb_node_queue_İ
;

1652 
queue
->
İ
->
	`š™
(queue);

1653 
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 = 
NULL
;

1654 
video_mv_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

1655 
video_mv_äame_tcb_queue
->
¡¬t_time¡amp
 = 0;

1656 
video_mv_äame_tcb_queue
->
tÙ®_du¿tiÚ
 = 0;

1657 
	`¥š_lock_š™
(&
video_mv_äame_tcb_queue
->
lock
);

1659 
	}
}

1661 
tw_video_mv_äame_tcb_queue_İ”©iÚ
 
	gtw_video_mv_äame_tcb_queue_İ
 = {

1662 .
g‘
 = 
tw_video_mv_äame_tcb_queue_g‘
,

1663 .
	gŒy_g‘
 = 
tw_video_mv_äame_tcb_queue_Œy_g‘
,

1664 .
	gg‘_”
 = 
tw_video_mv_äame_tcb_queue_g‘_”
,

1665 .
	gŒy_g‘_”
 = 
tw_video_mv_äame_tcb_queue_Œy_g‘_”
,

1666 .
	gput
 = 
tw_video_mv_äame_tcb_queue_put
,

1667 .
	gput_h—d”
 = 
tw_video_mv_äame_tcb_queue_put_h—d”
,

1669 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_mv_äame_tcb_queue_g‘_cu¼_´oduûr_äom_poŞ
,

1670 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_video_mv_äame_tcb_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

1671 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_video_mv_äame_tcb_queue_put_cu¼_´oduûr_što_queue
,

1672 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_´oduûr
,

1673 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_mv_äame_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
,

1674 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_video_mv_äame_tcb_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

1675 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_cÚsum”
,

1677 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_video_mv_äame_tcb_queue_g‘_cu¼_queue_’Œy_numb”
,

1678 .
	g»Ëa£
 = 
tw_video_mv_äame_tcb_queue_»Ëa£
,

1679 .
	gš™
 = 
tw_video_mv_äame_tcb_queue_š™
,

1682 
	$š™_tw_video_mv_äame_tcb_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
)

1684 if(
video_mv_äame_tcb_queue
 !ğ
NULL
){

1685 
video_mv_äame_tcb_queue
->
İ
 = &
tw_video_mv_äame_tcb_queue_İ
;

1686 
video_mv_äame_tcb_queue
->
İ
->
	`š™
(video_mv_frame_tcb_queue);

1688 
	}
}

1690 
	$»move_tw_video_mv_äame_tcb_queue
(
tw_video_mv_äame_tcb_queue_t
 *
video_mv_äame_tcb_queue
, 
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1692 if((
video_mv_äame_tcb_queue
!=
NULL
è&& (
video_chª_buf_poŞ
!=NULL)){

1693 if(
video_mv_äame_tcb_queue
->
İ
 !ğ
NULL
){

1694 
video_mv_äame_tcb_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(video_mv_frame_tcb_queue);

1695 
video_mv_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_mv_äame_tcb_queue, 
video_chª_buf_poŞ
);

1696 
video_mv_äame_tcb_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(video_mv_frame_tcb_queue)){

1697 
video_mv_äame_tcb_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(video_mv_frame_tcb_queue);

1698 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1701 
video_mv_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(video_mv_äame_tcb_queue, 
video_chª_buf_poŞ
);

1704 
	`tw_video_mv_äame_tcb_queue_put_cu¼_´oduûr_što_queue
(
video_mv_äame_tcb_queue
);

1705 
	`tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_cÚsum”
(
video_mv_äame_tcb_queue
, 
video_chª_buf_poŞ
);

1706 
	`tw_video_mv_äame_tcb_queue_g‘_cu¼_queue_’Œy_numb”
(
video_mv_äame_tcb_queue
)){

1707 
	`tw_video_mv_äame_tcb_queue_g‘_cu¼_cÚsum”_äom_queue
(
video_mv_äame_tcb_queue
);

1708 if(
video_mv_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

1711 
	`tw_video_mv_äame_tcb_queue_»Ëa£_cu¼_cÚsum”
(
video_mv_äame_tcb_queue
, 
video_chª_buf_poŞ
);

1714 
	`´štk
("mv_·ck‘_poŞ_tcb = %d\n", 
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&video_chan_buf_pool->mv_packet_pool_tcb));

1715 
	`´štk
("mv_äame_poŞ_tcb = %d\n", 
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
.
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(&video_chan_buf_pool->mv_frame_pool_tcb));

1717 
	}
}

1720 
	$tw_video_chª_buf_poŞ_ü—‹
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
buf_Ën
)

1722 
»t
 = 
TW_ERR
;

1724 if(
video_chª_buf_poŞ
 !ğ
NULL
){

1725 
tcb_node_poŞ_t
 *
node_poŞ
;

1726 
tw_video_·ck‘_tcb_t
 *
±r_video_·ck‘_tcb
;

1727 
tw_video_äame_tcb_t
 *
±r_video_äame_tcb
;

1728 #ifdeà 
MV_MODULE


1729 
tw_video_mv_·ck‘_tcb_t
 *
±r_mv_·ck‘_tcb
;

1730 
tw_video_mv_äame_tcb_t
 *
±r_mv_äame_tcb
;

1732 
i
;

1734 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 
	`g‘_Üd”
(
buf_Ën
);

1735 
video_chª_buf_poŞ
->
ÿche_bufãr
 = (
u8
*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, video_chª_buf_poŞ->
ÿche_Üd”
);

1736 if(
video_chª_buf_poŞ
->
ÿche_bufãr
 =ğ
NULL
) {

1737 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1738 
	`´štk
("ÿn'ˆ®loø%d…age fÜ videØbuàpoŞ\n", 
video_chª_buf_poŞ
->
ÿche_Üd”
);

1739  -
ENOMEM
;

1742 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 1;

1743 
i
=0; i<
video_chª_buf_poŞ
->
ÿche_Üd”
; i++){

1744 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 <<= 1;

1746 
video_chª_buf_poŞ
->
video_·ck‘_bufãr_size
 = 
PAGE_SIZE
;

1747 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1748 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

1749 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = (
tw_video_·ck‘_tcb_t
*)
	`km®loc
(Ñw_video_·ck‘_tcb_t)*video_chª_buf_poŞ->
video_·ck‘_’Œy_numb”
, 
GFP_KERNEL
);

1750 if(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 =ğ
NULL
){

1751 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1752 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1753 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1754 
	`´štk
("can't‡lloc video…acketcb\n");

1755  -
ENOMEM
;

1757 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
);

1758 
i
=0; i<
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
; i++){

1759 
±r_video_·ck‘_tcb
 = &
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
[
i
];

1760 
±r_video_·ck‘_tcb
->
İ
 = &
tw_video_·ck‘_tcb_İ
;

1761 
±r_video_·ck‘_tcb
->
İ
->
	`š™
ÕŒ_video_·ck‘_tcb, 
video_chª_buf_poŞ
, 
i
);

1762 
±r_video_·ck‘_tcb
->
İ
->
	`»Ëa£
(&±r_video_·ck‘_tcb, 
video_chª_buf_poŞ
);

1765 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
 = video_chª_buf_poŞ->
video_·ck‘_’Œy_numb”
;

1766 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
;

1767 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

1768 
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 = (
tw_video_äame_tcb_t
*)
	`km®loc
(Ñw_video_äame_tcb_t)*video_chª_buf_poŞ->
video_äame_’Œy_numb”
, 
GFP_KERNEL
);

1769 if(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 =ğ
NULL
){

1770 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1771 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1772 
	`kä“
(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
);

1773 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = 
NULL
;

1774 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 0;

1775 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1776 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1777 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1778 
	`´štk
("can't‡lloc video framecb\n");

1779  -
ENOMEM
;

1781 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
);

1782 
i
=0; i<
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
; i++){

1783 
±r_video_äame_tcb
 = &
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
[
i
];

1784 
±r_video_äame_tcb
->
İ
 = &
tw_video_äame_tcb_İ
;

1785 
±r_video_äame_tcb
->
video_chª_buf_poŞ
 = video_chan_buf_pool;

1786 
±r_video_äame_tcb
->
İ
->
	`š™
(ptr_video_frame_tcb);

1787 
±r_video_äame_tcb
->
İ
->
	`»Ëa£
(&±r_video_äame_tcb, 
video_chª_buf_poŞ
);

1790 #ifdeà 
MV_MODULE


1791 
video_chª_buf_poŞ
->
mv_ÿche_Üd”
 = video_chª_buf_poŞ->
ÿche_Üd”
;

1792 
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 = (
u8
*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, video_chª_buf_poŞ->
mv_ÿche_Üd”
);

1793 if(
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 =ğ
NULL
){

1794 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
;

1795 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1796 
	`kä“
(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
);

1797 
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 = 
NULL
;

1798 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
 = 0;

1799 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1800 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1801 
	`kä“
(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
);

1802 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = 
NULL
;

1803 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 0;

1804 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1805 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1806 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1807 
	`´štk
("can't‡lloc…age for mv\n");

1808  -
ENOMEM
;

1811 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
 = 1;

1812 
i
=0; i<
video_chª_buf_poŞ
->
mv_ÿche_Üd”
; i++){

1813 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
 <<= 1;

1815 
video_chª_buf_poŞ
->
mv_·ck‘_bufãr_size
 = 
PAGE_SIZE
;

1816 
node_poŞ
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

1817 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

1818 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
 = (
tw_video_mv_·ck‘_tcb_t
*)
	`km®loc
(Ñw_video_mv_·ck‘_tcb_t)*video_chª_buf_poŞ->
mv_·ck‘_’Œy_numb”
, 
GFP_KERNEL
);

1819 if(
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
 =ğ
NULL
){

1820 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
;

1821 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1822 
	`kä“
(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
);

1823 
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 = 
NULL
;

1824 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
 = 0;

1825 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1826 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1827 
	`kä“
(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
);

1828 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = 
NULL
;

1829 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 0;

1830 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1831 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1832 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1833 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
mv_ÿche_bufãr
, video_chª_buf_poŞ->
mv_ÿche_Üd”
);

1834 
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 = 
NULL
;

1835 
video_chª_buf_poŞ
->
mv_ÿche_Üd”
 = 0;

1836 
	`´štk
("can't‡lloc mv…acketcb\n");

1837  -
ENOMEM
;

1839 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
);

1840 
i
=0; i<
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
; i++){

1841 
±r_mv_·ck‘_tcb
 = &
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
[
i
];

1842 
±r_mv_·ck‘_tcb
->
İ
 = &
tw_video_mv_·ck‘_tcb_İ
;

1843 
±r_mv_·ck‘_tcb
->
İ
->
	`š™
ÕŒ_mv_·ck‘_tcb, 
video_chª_buf_poŞ
, 
i
);

1844 
±r_mv_·ck‘_tcb
->
İ
->
	`»Ëa£
(&±r_mv_·ck‘_tcb, 
video_chª_buf_poŞ
);

1847 
video_chª_buf_poŞ
->
mv_äame_’Œy_numb”
 = video_chª_buf_poŞ->
mv_·ck‘_’Œy_numb”
;

1848 
node_poŞ
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

1849 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

1850 
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
 = (
tw_video_mv_äame_tcb_t
*)
	`km®loc
(Ñw_video_mv_äame_tcb_t)*video_chª_buf_poŞ->
mv_äame_’Œy_numb”
, 
GFP_KERNEL
);

1851 if(
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
 =ğ
NULL
){

1852 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
;

1853 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1854 
	`kä“
(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
);

1855 
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 = 
NULL
;

1856 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
 = 0;

1857 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1858 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1859 
	`kä“
(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
);

1860 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = 
NULL
;

1861 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 0;

1862 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1863 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1864 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1865 
node_poŞ
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

1866 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1867 
	`kä“
(
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
);

1868 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
 = 
NULL
;

1869 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
 = 0;

1870 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
mv_ÿche_bufãr
, video_chª_buf_poŞ->
mv_ÿche_Üd”
);

1871 
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 = 
NULL
;

1872 
video_chª_buf_poŞ
->
mv_ÿche_Üd”
 = 0;

1873 
	`´štk
("can't‡lloc mv framecb\n");

1874  -
ENOMEM
;

1876 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
video_chª_buf_poŞ
->
mv_äame_’Œy_numb”
);

1877 
i
=0; i<
video_chª_buf_poŞ
->
mv_äame_’Œy_numb”
; i++){

1878 
±r_mv_äame_tcb
 = &
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
[
i
];

1879 
±r_mv_äame_tcb
->
İ
 = &
tw_video_mv_äame_tcb_İ
;

1880 
±r_mv_äame_tcb
->
video_chª_buf_poŞ
 = video_chan_buf_pool;

1881 
±r_mv_äame_tcb
->
İ
->
	`š™
(ptr_mv_frame_tcb);

1882 
±r_mv_äame_tcb
->
İ
->
	`»Ëa£
(&±r_mv_äame_tcb, 
video_chª_buf_poŞ
);

1885 
»t
 = 
TW_OK
;

1887  
»t
;

1888 
	}
}

1890 
	$tw_video_chª_buf_poŞ_»Ëa£
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1892 if(
video_chª_buf_poŞ
 !ğ
NULL
){

1893 
tcb_node_poŞ_t
 *
node_poŞ
;

1895 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_äame_poŞ_tcb
;

1896 if(
node_poŞ
->
İ
 !ğ
NULL
){

1897 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1899 if(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 !ğ
NULL
){

1900 
	`kä“
(
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
);

1901 
video_chª_buf_poŞ
->
video_äame_’Œy_poŞ
 = 
NULL
;

1903 
video_chª_buf_poŞ
->
video_äame_’Œy_numb”
 = 0;

1905 
node_poŞ
 = &
video_chª_buf_poŞ
->
video_·ck‘_poŞ_tcb
;

1906 if(
node_poŞ
->
İ
 !ğ
NULL
){

1907 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1909 if(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 !ğ
NULL
){

1910 
	`kä“
(
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
);

1911 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_poŞ
 = 
NULL
;

1913 
video_chª_buf_poŞ
->
video_·ck‘_’Œy_numb”
 = 0;

1915 if(
video_chª_buf_poŞ
->
ÿche_bufãr
 !ğ
NULL
){

1916 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
ÿche_bufãr
, video_chª_buf_poŞ->
ÿche_Üd”
);

1917 
video_chª_buf_poŞ
->
ÿche_bufãr
 = 
NULL
;

1919 
video_chª_buf_poŞ
->
ÿche_Üd”
 = 0;

1921 #ifdeà 
MV_MODULE


1922 
node_poŞ
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

1923 if(
node_poŞ
->
İ
 !ğ
NULL
){

1924 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1926 if(
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
 !ğ
NULL
){

1927 
	`kä“
(
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
);

1928 
video_chª_buf_poŞ
->
mv_äame_’Œy_poŞ
 = 
NULL
;

1930 
video_chª_buf_poŞ
->
mv_äame_’Œy_numb”
 = 0;

1932 
node_poŞ
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

1933 if(
node_poŞ
->
İ
 !ğ
NULL
){

1934 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

1936 if(
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
 !ğ
NULL
){

1937 
	`kä“
(
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
);

1938 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_poŞ
 = 
NULL
;

1940 
video_chª_buf_poŞ
->
mv_·ck‘_’Œy_numb”
 = 0;

1942 if(
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 !ğ
NULL
){

1943 
	`ä“_·ges
(()
video_chª_buf_poŞ
->
mv_ÿche_bufãr
, video_chª_buf_poŞ->
mv_ÿche_Üd”
);

1944 
video_chª_buf_poŞ
->
mv_ÿche_bufãr
 = 
NULL
;

1946 
video_chª_buf_poŞ
->
mv_ÿche_Üd”
 = 0;

1949 
	}
}

1951 
	$tw_video_chª_buf_poŞ_g‘_video_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 **
·ck‘
)

1953 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

1954 
tcb_node_poŞ_t
 *
video_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_packet_pool_tcb;

1955 *
·ck‘
 = 
NULL
;

1956 if(
video_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

1957 
tcb_node_t
 *
‹mp_node
;

1958 
video_·ck‘_poŞ_tcb
->
İ
->
	`g‘
(video_·ck‘_poŞ_tcb, &
‹mp_node
);

1959 if(
‹mp_node
 !ğ
NULL
){

1960 *
·ck‘
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

1961 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

1965 
	}
}

1967 
	$tw_video_chª_buf_poŞ_Œy_g‘_video_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 **
·ck‘
)

1969 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

1970 
tcb_node_poŞ_t
 *
video_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_packet_pool_tcb;

1971 *
·ck‘
 = 
NULL
;

1972 if(
video_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

1973 
tcb_node_t
 *
‹mp_node
;

1974 
video_·ck‘_poŞ_tcb
->
İ
->
	`Œy_g‘
(video_·ck‘_poŞ_tcb, &
‹mp_node
);

1975 if(
‹mp_node
 !ğ
NULL
){

1976 *
·ck‘
 = 
	`to_video_·ck‘_buf_tcb
(
‹mp_node
);

1977 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

1981 
	}
}

1983 
	$tw_video_chª_buf_poŞ_put_video_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_·ck‘_tcb_t
 *
·ck‘
)

1985 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

1986 
tcb_node_poŞ_t
 *
video_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_packet_pool_tcb;

1987 if(
video_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

1988 
video_·ck‘_poŞ_tcb
->
İ
->
	`put
(video_·ck‘_poŞ_tcb, &
·ck‘
->
·ck‘_node
);

1991 
	}
}

1993 
	$tw_video_chª_buf_poŞ_g‘_video_·ck‘_tcb_poŞ_’Œy_numb”
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

1995 
’Œy_numb”
 = 0;

1996 if(
video_chª_buf_poŞ
 !ğ
NULL
){

1997 
tcb_node_poŞ_t
 *
video_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_packet_pool_tcb;

1998 if(
video_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

1999 
’Œy_numb”
 = 
video_·ck‘_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(video_packet_pool_tcb);

2002  
’Œy_numb”
;

2003 
	}
}

2005 
	$tw_video_chª_buf_poŞ_g‘_video_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 **
äame
)

2007 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2008 
tcb_node_poŞ_t
 *
video_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_frame_pool_tcb;

2009 *
äame
 = 
NULL
;

2010 if(
video_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2011 
tcb_node_t
 *
‹mp_node
;

2012 
video_äame_poŞ_tcb
->
İ
->
	`g‘
(video_äame_poŞ_tcb, &
‹mp_node
);

2013 if(
‹mp_node
 !ğ
NULL
){

2014 *
äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

2015 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

2019 
	}
}

2021 
	$tw_video_chª_buf_poŞ_Œy_g‘_video_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 **
äame
)

2023 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2024 
tcb_node_poŞ_t
 *
video_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_frame_pool_tcb;

2025 *
äame
 = 
NULL
;

2026 if(
video_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2027 
tcb_node_t
 *
‹mp_node
;

2028 
video_äame_poŞ_tcb
->
İ
->
	`Œy_g‘
(video_äame_poŞ_tcb, &
‹mp_node
);

2029 if(
‹mp_node
 !ğ
NULL
){

2030 *
äame
 = 
	`to_video_äame_tcb
(
‹mp_node
);

2031 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

2035 
	}
}

2037 
	$tw_video_chª_buf_poŞ_put_video_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_äame_tcb_t
 *
äame
)

2039 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2040 
tcb_node_poŞ_t
 *
video_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_frame_pool_tcb;

2041 if(
video_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2042 
video_äame_poŞ_tcb
->
İ
->
	`put
(video_äame_poŞ_tcb, &
äame
->
äame_node
);

2045 
	}
}

2047 
	$tw_video_chª_buf_poŞ_g‘_video_äame_tcb_poŞ_’Œy_numb”
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

2049 
’Œy_numb”
 = 0;

2050 if(
video_chª_buf_poŞ
 !ğ
NULL
){

2051 
tcb_node_poŞ_t
 *
video_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->video_frame_pool_tcb;

2052 if(
video_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2053 
’Œy_numb”
 = 
video_äame_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(video_frame_pool_tcb);

2056  
’Œy_numb”
;

2057 
	}
}

2058 #ifdeà 
MV_MODULE


2059 
	$tw_video_chª_buf_poŞ_g‘_video_mv_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 **
·ck‘
)

2061 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

2062 
tcb_node_poŞ_t
 *
video_mv_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

2063 *
·ck‘
 = 
NULL
;

2064 if(
video_mv_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

2065 
tcb_node_t
 *
‹mp_node
;

2066 
video_mv_·ck‘_poŞ_tcb
->
İ
->
	`g‘
(video_mv_·ck‘_poŞ_tcb, &
‹mp_node
);

2067 if(
‹mp_node
 !ğ
NULL
){

2068 *
·ck‘
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

2069 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

2073 
	}
}

2075 
	$tw_video_chª_buf_poŞ_Œy_g‘_video_mv_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 **
·ck‘
)

2077 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

2078 
tcb_node_poŞ_t
 *
video_mv_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

2079 *
·ck‘
 = 
NULL
;

2080 if(
video_mv_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

2081 
tcb_node_t
 *
‹mp_node
;

2082 
video_mv_·ck‘_poŞ_tcb
->
İ
->
	`Œy_g‘
(video_mv_·ck‘_poŞ_tcb, &
‹mp_node
);

2083 if(
‹mp_node
 !ğ
NULL
){

2084 *
·ck‘
 = 
	`to_g‘_tw_video_mv_·ck‘_tcb
(
‹mp_node
);

2085 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

2089 
	}
}

2091 
	$tw_video_chª_buf_poŞ_put_video_mv_·ck‘_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_·ck‘_tcb_t
 *
·ck‘
)

2093 if((
video_chª_buf_poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

2094 
tcb_node_poŞ_t
 *
video_mv_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

2095 if(
video_mv_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

2096 
video_mv_·ck‘_poŞ_tcb
->
İ
->
	`put
(video_mv_·ck‘_poŞ_tcb, &
·ck‘
->
mv_·ck‘_node
);

2099 
	}
}

2101 
	$tw_video_chª_buf_poŞ_g‘_video_mv_·ck‘_tcb_poŞ_’Œy_numb”
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

2103 
’Œy_numb”
 = 0;

2104 if(
video_chª_buf_poŞ
 !ğ
NULL
){

2105 
tcb_node_poŞ_t
 *
video_mv_·ck‘_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_·ck‘_poŞ_tcb
;

2106 if(
video_mv_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

2107 
’Œy_numb”
 = 
video_mv_·ck‘_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(video_mv_packet_pool_tcb);

2110  
’Œy_numb”
;

2111 
	}
}

2113 
	$tw_video_chª_buf_poŞ_g‘_video_mv_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 **
äame
)

2115 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2116 
tcb_node_poŞ_t
 *
video_mv_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

2117 *
äame
 = 
NULL
;

2118 if(
video_mv_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2119 
tcb_node_t
 *
‹mp_node
;

2120 
video_mv_äame_poŞ_tcb
->
İ
->
	`g‘
(video_mv_äame_poŞ_tcb, &
‹mp_node
);

2121 if(
‹mp_node
 !ğ
NULL
){

2122 *
äame
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

2123 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

2127 
	}
}

2129 
	$tw_video_chª_buf_poŞ_Œy_g‘_video_mv_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 **
äame
)

2131 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2132 
tcb_node_poŞ_t
 *
video_mv_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

2133 *
äame
 = 
NULL
;

2134 if(
video_mv_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2135 
tcb_node_t
 *
‹mp_node
;

2136 
video_mv_äame_poŞ_tcb
->
İ
->
	`Œy_g‘
(video_mv_äame_poŞ_tcb, &
‹mp_node
);

2137 if(
‹mp_node
 !ğ
NULL
){

2138 *
äame
 = 
	`to_g‘_tw_video_mv_äame_tcb
(
‹mp_node
);

2139 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

2143 
	}
}

2145 
	$tw_video_chª_buf_poŞ_put_video_mv_äame_tcb
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
tw_video_mv_äame_tcb_t
 *
äame
)

2147 if((
video_chª_buf_poŞ
!=
NULL
è&& (
äame
!=NULL)){

2148 
tcb_node_poŞ_t
 *
video_mv_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

2149 if(
video_mv_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2150 
video_mv_äame_poŞ_tcb
->
İ
->
	`put
(video_mv_äame_poŞ_tcb, &
äame
->
mv_äame_node
);

2153 
	}
}

2155 
	$tw_video_chª_buf_poŞ_g‘_video_mv_äame_tcb_poŞ_’Œy_numb”
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

2157 
’Œy_numb”
 = 0;

2158 if(
video_chª_buf_poŞ
 !ğ
NULL
){

2159 
tcb_node_poŞ_t
 *
video_mv_äame_poŞ_tcb
 = &
video_chª_buf_poŞ
->
mv_äame_poŞ_tcb
;

2160 if(
video_mv_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

2161 
’Œy_numb”
 = 
video_mv_äame_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(video_mv_frame_pool_tcb);

2164  
’Œy_numb”
;

2165 
	}
}

2168 
tw_video_chª_buf_poŞ_İ”©iÚ
 
	gtw_video_chª_buf_poŞ_İ
 = {

2169 .
ü—‹
 = 
tw_video_chª_buf_poŞ_ü—‹
,

2170 .
	g»Ëa£
 = 
tw_video_chª_buf_poŞ_»Ëa£
,

2172 .
	gg‘_video_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_g‘_video_·ck‘_tcb
,

2173 .
	gŒy_g‘_video_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_Œy_g‘_video_·ck‘_tcb
,

2174 .
	gput_video_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_put_video_·ck‘_tcb
,

2175 .
	gg‘_video_·ck‘_tcb_poŞ_’Œy_numb”
 = 
tw_video_chª_buf_poŞ_g‘_video_·ck‘_tcb_poŞ_’Œy_numb”
,

2177 .
	gg‘_video_äame_tcb
 = 
tw_video_chª_buf_poŞ_g‘_video_äame_tcb
,

2178 .
	gŒy_g‘_video_äame_tcb
 = 
tw_video_chª_buf_poŞ_Œy_g‘_video_äame_tcb
,

2179 .
	gput_video_äame_tcb
 = 
tw_video_chª_buf_poŞ_put_video_äame_tcb
,

2180 .
	gg‘_video_äame_tcb_poŞ_’Œy_numb”
 = 
tw_video_chª_buf_poŞ_g‘_video_äame_tcb_poŞ_’Œy_numb”
,

2181 #ifdeà 
MV_MODULE


2182 .
	gg‘_video_mv_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_g‘_video_mv_·ck‘_tcb
,

2183 .
	gŒy_g‘_video_mv_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_Œy_g‘_video_mv_·ck‘_tcb
,

2184 .
	gput_video_mv_·ck‘_tcb
 = 
tw_video_chª_buf_poŞ_put_video_mv_·ck‘_tcb
,

2185 .
	gg‘_video_mv_·ck‘_tcb_poŞ_’Œy_numb”
 = 
tw_video_chª_buf_poŞ_g‘_video_mv_·ck‘_tcb_poŞ_’Œy_numb”
,

2187 .
	gg‘_video_mv_äame_tcb
 = 
tw_video_chª_buf_poŞ_g‘_video_mv_äame_tcb
,

2188 .
	gŒy_g‘_video_mv_äame_tcb
 = 
tw_video_chª_buf_poŞ_Œy_g‘_video_mv_äame_tcb
,

2189 .
	gput_video_mv_äame_tcb
 = 
tw_video_chª_buf_poŞ_put_video_mv_äame_tcb
,

2190 .
	gg‘_video_mv_äame_tcb_poŞ_’Œy_numb”
 = 
tw_video_chª_buf_poŞ_g‘_video_mv_äame_tcb_poŞ_’Œy_numb”
,

2194 
	$š™_tw_video_chª_buf_poŞ
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
, 
buf_Ën
)

2196 
»t
 = 
TW_ERR
;

2197 if(
video_chª_buf_poŞ
 !ğ
NULL
){

2198 
video_chª_buf_poŞ
->
İ
 = &
tw_video_chª_buf_poŞ_İ
;

2199 
»t
 = 
video_chª_buf_poŞ
->
İ
->
	`ü—‹
(video_chª_buf_poŞ, 
buf_Ën
);

2201  
»t
;

2202 
	}
}

2204 
	$»move_tw_video_chª_buf_poŞ
(
tw_video_chª_buf_poŞ_t
 *
video_chª_buf_poŞ
)

2206 if(
video_chª_buf_poŞ
 !ğ
NULL
){

2207 if(
video_chª_buf_poŞ
->
İ
 !ğ
NULL
){

2208 
video_chª_buf_poŞ
->
İ
->
	`»Ëa£
(video_chan_buf_pool);

2211 
	}
}

	@../../tw5864/tw5864/tw_jpeg_codec.c

6 
	~<tw5864/dvm_commÚ.h
>

8 
tw_mj³g_’code_·¿m_t
 
	gdeçuÉ_j³g_’code_´İ”ty
 = {

9 .
i_image_width_mb_size
 = 
MJPEG_WIDTH_FRAME_D1_PAL
,

10 .
	gi_image_height_mb_size
 = 
MJPEG_HEIGHT_FRAME_D1_PAL
,

11 .
	ge_image_Ëv–
 = 
MJPEG_IMAGE_LEVEL_0
,

12 .
	gi_ÿ±u»_äame_¡ride
 = 
TW5864_MJPEG_MIN_INTERVAL
,

13 .
	gi_ÿ±u»_äame_numb”
 = 0xffffffff,

14 .
	gi_ÿ±u»_ty³
 = 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
,

15 .
	gchªge_mask_æag
 = 0xff,

18 cÚ¡ 
	gba£_q_tbl_y
[64] =

30 cÚ¡ 
	gba£_q_tbl_uv
[64] =

43 cÚ¡ 
	ghuffmª_DC0_tbl
[] = {

52 cÚ¡ 
	ghuffmª_DC1_tbl
[] = {

61 cÚ¡ 
	ghuffmª_AC0_tbl
[] = {

87 cÚ¡ 
	ghuffmª_AC1_tbl
[] = {

113 cÚ¡ 
	gsos_bË_deçuÉ
[] = {

118 
tw_j³g_to_fe
(
fe
 *
j³g_fe
, 
tw_vb_äame_tcb_t
 *
äame
);

119 
tw_j³g_§ve_chn
(
tw_j³g_logic_’code_chª_t
 *
logic_chÆ
, *
·th
, 
út
);

121 
š™_j³g_£rviû_queue
(
j³g_£rviû_queue_t
 * 
j³g_£rviû_queue
);

122 
š™_j³g_£rviû_tcb_w™h_nuÎ
(
j³g_£rviû_tcb_t
 *
’code_»que¡_tcb
);

123 
»move_j³g_£rviû_queue
(
j³g_£rviû_queue_t
 * 
j³g_£rviû_queue
);

124 
š™_subm™_»cv_j³g_dÚe_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
);

126 
	$»gi¡”_logic_’code_chª_što_phy_¦Ù
(
tw_j³g_logic_’code_chª_t
 *
logic_chª
, 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
)

128 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

129 
ed_tcb_t
 *
logic_chª_ed
;

130 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

132 if(
logic_chª
 && 
phy_¦Ù
){

133 
logic_chª_bË
 = &
phy_¦Ù
->logic_chan_table;

134 
logic_chª_ed
 = &
logic_chª
->logic_chan_ed;

135 
»gi¡”_node
 = &
logic_chª_ed
->
ed
;

137 if(
logic_chª_bË
->
İ
 !ğ
NULL
){

138 
logic_chª_bË
->
İ
->
	`»gi¡”_node_što_bË
Öogic_chª_bË, 
»gi¡”_node
);

140 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_IDLE
);

142 
	}
}

144 
	$fšd_»gi¡”_logic_’code_chª_š_phy_¦Ù
(
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
, 
logic_chª_id
, 
tw_j³g_logic_’code_chª_t
 **
±r_j³g_logic_’code_chª
è
	`__©Œibu‹__
((
u£d
));

145 
	$fšd_»gi¡”_logic_’code_chª_š_phy_¦Ù
(
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
, 
logic_chª_id
, 
tw_j³g_logic_’code_chª_t
 **
±r_j³g_logic_’code_chª
)

147 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

148 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

149 
ed_tcb_t
 *
logic_chª_ed
;

150 if(
phy_¦Ù
 && 
±r_j³g_logic_’code_chª
){

151 
logic_chª_bË
 = &
phy_¦Ù
->logic_chan_table;

152 *
±r_j³g_logic_’code_chª
 = 
NULL
;

153 if(
logic_chª_bË
->
İ
 !ğ
NULL
){

154 
logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
Öogic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

155 if(
»gi¡”_node
){

156 
logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

157 *
±r_j³g_logic_’code_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_logic_chª_ed
(
logic_chª_ed
);

161 
	}
}

164 
	$uÄegi¡”_logic_’code_chª_što_phy_¦Ù
(
tw_j³g_logic_’code_chª_t
 *
logic_chª
, 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
)

166 
tw_»gi¡”_bË_t
 *
logic_chª_bË
;

167 
ed_tcb_t
 *
logic_chª_ed
;

168 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

170 if(
logic_chª
 && 
phy_¦Ù
){

171 
logic_chª_bË
 = &
phy_¦Ù
->logic_chan_table;

172 
logic_chª_ed
 = &
logic_chª
->logic_chan_ed;

173 
»gi¡”_node
 = &
logic_chª_ed
->
ed
;

175 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_CLOSED
);

176 if(
»gi¡”_node
->
İ
 !ğ
NULL
){

177 
»gi¡”_node
->
İ
->
	`com¶‘e_dÚe
(register_node);

179 if(
logic_chª_bË
->
İ
 !ğ
NULL
){

180 
logic_chª_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
Öogic_chª_bË, 
»gi¡”_node
);

182 
	`©omic_£t
(&
logic_chª_ed
->
¡©e
, 
TW_ED_UNREGISTER
);

184 
	}
}

186 
	$»gi¡”_İ’ed_logic_’code_chª_što_phy_¦Ù
(
tw_j³g_logic_’code_chª_t
 *
logic_chn
, 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
)

188 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
;

189 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

190 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

192 if(
logic_chn
 && 
phy_¦Ù
){

193 
İ’ed_logic_chª_bË
 = &
phy_¦Ù
->opened_logic_chan_table;

194 
İ’ed_logic_chª_ed
 = &
logic_chn
->opened_logic_chan_ed;

195 
»gi¡”_node
 = &
İ’ed_logic_chª_ed
->
ed
;

197 if(
İ’ed_logic_chª_bË
->
İ
 !ğ
NULL
){

198 
İ’ed_logic_chª_bË
->
İ
->
	`»gi¡”_node_što_bË
(İ’ed_logic_chª_bË, 
»gi¡”_node
);

200 
	`©omic_£t
(&
İ’ed_logic_chª_ed
->
¡©e
, 
TW_ED_IDLE
);

202 
	}
}

204 
	$fšd_»gi¡”_İ’ed_logic_’code_chª_š_phy_¦Ù
(
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
, 
logic_chª_id
, 
tw_j³g_logic_’code_chª_t
 **
±r_j³g_logic_’code_chª
è
	`__©Œibu‹__
((
u£d
));

205 
	$fšd_»gi¡”_İ’ed_logic_’code_chª_š_phy_¦Ù
(
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
, 
logic_chª_id
, 
tw_j³g_logic_’code_chª_t
 **
±r_j³g_logic_’code_chª
)

207 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
;

208 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

209 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

211 if(
phy_¦Ù
 && 
±r_j³g_logic_’code_chª
){

212 
İ’ed_logic_chª_bË
 = &
phy_¦Ù
->opened_logic_chan_table;

213 *
±r_j³g_logic_’code_chª
 = 
NULL
;

214 if(
İ’ed_logic_chª_bË
->
İ
 !ğ
NULL
){

215 
İ’ed_logic_chª_bË
->
İ
->
	`fšd_»gi¡”_node_š_bË
(İ’ed_logic_chª_bË, &
»gi¡”_node
, 
logic_chª_id
);

216 if(
»gi¡”_node
){

217 
İ’ed_logic_chª_ed
 = 
	`to_g‘_’dpošt_tcb_w™h_»gi¡”_node
(
»gi¡”_node
);

218 *
±r_j³g_logic_’code_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_İ’ed_logic_chª_ed
(
İ’ed_logic_chª_ed
);

222 
	}
}

224 
	$uÄegi¡”_İ’ed_logic_’code_chª_što_phy_¦Ù
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
, 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
)

226 
tw_»gi¡”_bË_t
 *
İ’ed_logic_chª_bË
;

227 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

228 
tw_»gi¡”_node_t
 *
»gi¡”_node
;

230 if(
j³g_logic_’code_chª
 && 
phy_¦Ù
){

231 
İ’ed_logic_chª_bË
 = &
phy_¦Ù
->opened_logic_chan_table;

232 
İ’ed_logic_chª_ed
 = &
j³g_logic_’code_chª
->opened_logic_chan_ed;

233 
»gi¡”_node
 = &
İ’ed_logic_chª_ed
->
ed
;

235 
	`©omic_£t
(&
İ’ed_logic_chª_ed
->
¡©e
, 
TW_ED_CLOSED
);

236 if(
İ’ed_logic_chª_bË
->
İ
 !ğ
NULL
){

237 
İ’ed_logic_chª_bË
->
İ
->
	`uÄegi¡”_node_äom_bË
(İ’ed_logic_chª_bË, 
»gi¡”_node
);

239 
	`©omic_£t
(&
İ’ed_logic_chª_ed
->
¡©e
, 
TW_ED_UNREGISTER
);

241 
	}
}

243 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

245 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

246 
ed_tcb_t
 *
ed_tcb
;

247 
dvm_ch_t
 *
ch
;

248 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

250 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

251 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

252 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

253 
ed_fsm
->
İ
->
	`»£t
(ed_fsm);

254 if(
	`©omic_»ad
(&
j³g_logic_chª
->
İ’ed_æag
)){

255 
	`©omic_£t
(&
j³g_logic_chª
->
İ’ed_æag
, 0);

256 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

257 
ch
 = 
j³g_logic_chª
->chip;

258 
ch
->
	`ch_şo£
(chip);

259 
	`uÄegi¡”_İ’ed_logic_’code_chª_što_phy_¦Ù
(
j³g_logic_chª
, j³g_logic_chª->
phy_video_¦Ù
);

262  
TW_OK
;

263 
	}
}

265 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

268  
TW_OK
;

269 
	}
}

271 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

274  
TW_OK
;

275 
	}
}

277 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

279  
TW_OK
;

280 
	}
}

282 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

286 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

287 
ed_tcb_t
 *
ed_tcb
;

288 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

289 
dvm_ch_t
 *
ch
;

291 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

292 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

293 
ch
 = 
j³g_logic_chª
->chip;

294 if(
	`©omic_»ad
(&
j³g_logic_chª
->
İ’ed_æag
) == 0){

295 
ed_tcb
->
ed
.
İ
->
	`š™_com¶‘e
(&ed_tcb->ed);

296 
ch
->
	`ch_İ’
(chip);

297 
	`»gi¡”_İ’ed_logic_’code_chª_što_phy_¦Ù
(
j³g_logic_chª
, j³g_logic_chª->
phy_video_¦Ù
);

298 
j³g_logic_chª
->
i_äame_£rŸl
 = 0;

299 
	`š™_tw5864_’code_time¡amp
(&
j³g_logic_chª
->
time¡amp
);

300 
	`©omic_£t
(&
j³g_logic_chª
->
İ’ed_æag
, 1);

301 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

303 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

305  
TW_OK
;

306 
	}
}

308 
	$j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

312 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

313 
ed_tcb_t
 *
ed_tcb
;

314 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

315 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

317  
TW_OK
;

318 
	}
}

320 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

322 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

324 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

325 
ed_tcb_t
 *
ed_tcb
;

326 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

327 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_UNREGISTER
);

328 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

330  
TW_OK
;

331 
	}
}

333 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

336  
TW_OK
;

337 
	}
}

339 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

342  
TW_OK
;

343 
	}
}

345 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

348  
TW_OK
;

349 
	}
}

351 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

353 if(
ed_fsm
 && 
cÚ‹xt
) {

354 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

356 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

358 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

359 if(
ed_fsm
->
bË
 !ğ
NULL
){

360 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

361 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm,ƒd_fsm->
cÚ‹xt
);

363 
	`´štk
("%s.%d, %d‚Ø»gi¡” j³g fsm sync_hook\n", 
__FUNCTION__
, 
__LINE__
, 
j³g_logic_chª
->
logic_chª_id
);

366 
	`´štk
("%s.%d, %d j³g fsmabË i nuÎ\n", 
__FUNCTION__
, 
__LINE__
, 
j³g_logic_chª
->
logic_chª_id
);

368 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

369  
TW_OK
;

372  
TW_ERR
;

373 
	}
}

375 
	$j³g_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

378 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

379 
ed_tcb_t
 *
ed_tcb
;

380 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

381 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

383  
TW_OK
;

384 
	}
}

386 
	$j³g_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

388 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

389 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

390 
ed_tcb_t
 *
ed_tcb
;

391 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

392 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

393 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

394 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

396  
TW_OK
;

397 
	}
}

399 
	$j³g_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

402  
TW_OK
;

403 
	}
}

405 
	$j³g_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

408 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

409 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

410 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

412 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

413 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

415 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_SUSPEND
);

417 if(
’code_cÚŒŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

419 
	`D–‘eSšgËFœeTim”Job
(
’code_cÚŒŞ
->
tim”_id
);

420 
’code_cÚŒŞ
->
tim”_id
 = 
INVALIDTIMERID
;

424  
TW_OK
;

425 
	}
}

427 
	$j³g_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

430 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

431 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

432 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

434 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

435 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

437 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

438 
’code_cÚŒŞ
->
	`tim”_hook
(
cÚ‹xt
);

441  
TW_OK
;

442 
	}
}

444 
	$j³g_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

447  
TW_OK
;

448 
	}
}

450 
	$j³g_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

453 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

454 
tw5864_vj_bus_t
 *
vj_bus
;

455 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

456 
j³g_£rviû_queue_t
 *
£rviû_queue
;

458 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

460 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_STANDBY
);

462 
vj_bus
 = &
j³g_logic_chª
->
ch
->
ch_vj_bus
;

463 
£rviû_queue
 = &
vj_bus
->
j³g_£rviû_queue
;

464 
£rviû_queue
->
İ
->
	`put_£rviû_»que¡_što_queue
(£rviû_queue, &
j³g_logic_chª
->
’code_»que¡_tcb
);

467  
TW_OK
;

468 
	}
}

470 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

472 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

473 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

474 
ed_tcb_t
 *
ed_tcb
;

475 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

476 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

478  
TW_OK
;

479 
	}
}

481 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

484  
TW_OK
;

485 
	}
}

487 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

490 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

491 
ed_tcb_t
 *
ed_tcb
;

492 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

493 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

495  
TW_OK
;

496 
	}
}

498 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

501 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

502 
ed_tcb_t
 *
ed_tcb
;

503 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

504 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

506  
TW_OK
;

507 
	}
}

509 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

512  
TW_OK
;

513 
	}
}

515 
	$j³g_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

518 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

519 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_RUNNING
);

521  
TW_OK
;

522 
	}
}

524 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

526 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

527 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

528 
ed_tcb_t
 *
ed_tcb
;

529 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

530 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_CLOSED
);

531 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

533  
TW_OK
;

534 
	}
}

536 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

539  
TW_OK
;

540 
	}
}

542 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

545  
TW_OK
;

546 
	}
}

548 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

550 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

551 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

552 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

554 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

555 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

557 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

558 if(
ed_fsm
->
bË
 !ğ
NULL
){

559 if(
ed_fsm
->
bË
->
sync_hook
 !ğ
NULL
){

560 
ed_fsm
->
bË
->
	`sync_hook
Ód_fsm, 
cÚ‹xt
);

563 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

565 
’code_cÚŒŞ
->
	`tim”_hook
(
cÚ‹xt
);

567  
TW_OK
;

568 
	}
}

570 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

573  
TW_OK
;

574 
	}
}

576 
	$j³g_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

579  
TW_OK
;

580 
	}
}

582 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

584 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

585 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

586 
ed_tcb_t
 *
ed_tcb
;

587 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

588 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

590  
TW_OK
;

591 
	}
}

593 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

596 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

597 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

598 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

599 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
 = (tw_j³g_logic_’code_chª_ˆ*)
cÚ‹xt
;

601 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

602 
äame_queue
 = &
j³g_logic_chª
->
j³g_äame_queue
;

603 
äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(äame_queue, &
j³g_logic_chª
->
poŞ
);

604 
’code_cÚŒŞ
->
lo¡_äame
++;

606 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_TRANSFERING
);

607 
	`driv”_g’_d–iv”_ev’t
(&
j³g_logic_chª
->
İ’ed_logic_chª_ed
, 1);

610  
TW_OK
;

611 
	}
}

613 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

616 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

617 
ed_tcb_t
 *
ed_tcb
;

618 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

619 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

621  
TW_OK
;

622 
	}
}

624 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

627 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

628 
ed_tcb_t
 *
ed_tcb
;

629 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

630 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

632  
TW_OK
;

633 
	}
}

635 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

638  
TW_OK
;

639 
	}
}

641 
	$j³g_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

644 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

645 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

646 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

647 
d´am_»que¡_t
 *
»ad_video_b™¡»am_»q
;

649 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

650 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_TRANSFERING
);

652 
ch_d´am_cÚŒŞËr
 = &
j³g_logic_chª
->
ch
->chip_dpram_controller;

653 
»ad_video_b™¡»am_»q
 = &
j³g_logic_chª
->read_video_bitstream_req;

654 
	`š™_subm™_»cv_j³g_dÚe_£rviû
(
»ad_video_b™¡»am_»q
, 
j³g_logic_chª
);

655 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_»ad_mj³g_»q
(ch_d´am_cÚŒŞËr, 
j³g_logic_chª
);

657  
TW_OK
;

658 
	}
}

660 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

662 
	`´štk
("%s.%d\n", 
__FUNCTION__
, 
__LINE__
);

663 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

664 
ed_tcb_t
 *
ed_tcb
;

665 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

666 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 0);

668  
TW_OK
;

669 
	}
}

671 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

674  
TW_OK
;

675 
	}
}

677 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

680 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

681 
ed_tcb_t
 *
ed_tcb
;

682 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

683 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

685  
TW_OK
;

686 
	}
}

688 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

691 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

692 
ed_tcb_t
 *
ed_tcb
;

693 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

694 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

696  
TW_OK
;

697 
	}
}

699 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

702  
TW_OK
;

703 
	}
}

705 
	$j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

708 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

709 
u32
 
cu¼’t_time_tick
, 
š‹rv®
;

710 
ed_tcb_t
 *
ed_tcb
;

711 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

712 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

714 
j³g_logic_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

715 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

717 
’code_cÚŒŞ
->
	`upd©e_ruÂšg_cÚfig
Óncode_cÚŒŞ, &
j³g_logic_chª
->
’code_´İ”ty
.encode_property);

718 if((
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 <ğ0è&& (’code_cÚŒŞ->
ÿ±u»_æags
 & 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
)){

719 
	`TW_DBG
(
TW_DBG_DEBUG
, "chªÃÈ%d USER c­tu» com¶‘e\n", 
j³g_logic_chª
->
logic_chª_id
);

720 
’code_cÚŒŞ
->
ÿ±u»_æags
 &ğ~
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
;

721 
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 = 0;

724 if(
’code_cÚŒŞ
->
ÿ±u»_æags
 & (
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
 | 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
)) {

725 
cu¼’t_time_tick
 = 
	`g‘_tw_sy¡em_tick
();

726 
š‹rv®
 = (
	`H264_MAX
(
cu¼’t_time_tick
, 
’code_cÚŒŞ
->
Ï¡_time_tick
è- 
	`H264_MIN
(current_time_tick,ƒncode_control->last_time_tick));

727 if(
š‹rv®
 > 
’code_cÚŒŞ
->
cu¼_š‹rv®
) {

728 if((
’code_cÚŒŞ
->
cu¼_š‹rv®
 << 1è>ğ
š‹rv®
) {

729 
š‹rv®
 = (
’code_cÚŒŞ
->
cu¼_š‹rv®
 << 1) - interval;

731 
š‹rv®
 = 
’code_cÚŒŞ
->
cu¼_š‹rv®
;

733 
š‹rv®
 = iÁ”v® < (
TW5864_MJPEG_MIN_INTERVAL
/
MS_PER_TICK
)? (TW5864_MJPEG_MIN_INTERVAL/MS_PER_TICK):interval;

735 
š‹rv®
 = 
’code_cÚŒŞ
->
cu¼_š‹rv®
;

740 
’code_cÚŒŞ
->
tim”_id
 = 
	`AddSšgËFœeTim”Job
(
š‹rv®
,ƒncode_cÚŒŞ->
tim”_hook
, 
j³g_logic_chª
);

741 if(
’code_cÚŒŞ
->
tim”_id
 =ğ
ADDJOBERROR
) {

742 
	`TW_DBG
(
TW_DBG_ERR
, "addimerƒrror!\n");

744 
’code_cÚŒŞ
->
Ï¡_time_tick
 = 
cu¼’t_time_tick
;

746 
	`TW_DBG
(
TW_DBG_DEBUG
, "chªÃÈ%d ALL c­tu» com¶‘e\n", 
j³g_logic_chª
->
logic_chª_id
);

749 
’code_cÚŒŞ
->
äame_š‹rv®
 = 
	`jiff›s_to_m£cs
(
jiff›s
è- jiff›s_to_m£csÓncode_cÚŒŞ->
Ï¡_jiff›s
);

750 
’code_cÚŒŞ
->
Ï¡_jiff›s
 = 
jiff›s
;

751 
j³g_logic_chª
->
i_äame_£rŸl
++;

753 
ed_tcb
 = 
	`to_g‘_’dpošt_tcb_w™h_tw_ed_fsm
(
ed_fsm
);

754 
ed_tcb
->
ed
.
İ
->
	`com¶‘e_dÚe
(&ed_tcb->ed);

755 
ed_fsm
->
İ
->
	`chªge_¡©e
Ód_fsm, 
TW_ED_IDLE
);

756 
ed_fsm
->
İ
->
	`upd©e_’abË_¡©e_Œªsãr
(ed_fsm, 1);

759  
TW_OK
;

760 
	}
}

762 
	$j³g_’code_driv”_sync_hook
(
tw_ed_fsm_t
 *
ed_fsm
, *
cÚ‹xt
)

765 if((
ed_fsm
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

768  
TW_OK
;

769 
	}
}

771 
fsm_¡©e_Œªsãr_m©rix_bË_t
 
	gj³g_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
 = {

772 .
aùiÚ
 = {

774 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_şo£_ev’t
,

775 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_timeout_ev’t
,

776 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_su¥’d_ev’t
,

777 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_»sume_ev’t
,

778 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_İ’_ev’t
,

779 
j³g_’code_driv”_š_uÄegi¡”_¡©e_»cv_d–iv”_ev’t


782 
j³g_’code_driv”_š_şo£d_¡©e_»cv_şo£_ev’t
,

783 
j³g_’code_driv”_š_şo£d_¡©e_»cv_timeout_ev’t
,

784 
j³g_’code_driv”_š_şo£d_¡©e_»cv_su¥’d_ev’t
,

785 
j³g_’code_driv”_š_şo£d_¡©e_»cv_»sume_ev’t
,

786 
j³g_’code_driv”_š_şo£d_¡©e_»cv_İ’_ev’t
,

787 
j³g_’code_driv”_š_şo£d_¡©e_»cv_d–iv”_ev’t


790 
j³g_’code_driv”_š_idË_¡©e_»cv_şo£_ev’t
,

791 
j³g_’code_driv”_š_idË_¡©e_»cv_timeout_ev’t
,

792 
j³g_’code_driv”_š_idË_¡©e_»cv_su¥’d_ev’t
,

793 
j³g_’code_driv”_š_idË_¡©e_»cv_»sume_ev’t
,

794 
j³g_’code_driv”_š_idË_¡©e_»cv_İ’_ev’t
,

795 
j³g_’code_driv”_š_idË_¡©e_»cv_d–iv”_ev’t


798 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_şo£_ev’t
,

799 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_timeout_ev’t
,

800 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_su¥’d_ev’t
,

801 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_»sume_ev’t
,

802 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_İ’_ev’t
,

803 
j³g_’code_driv”_š_¡ªdby_¡©e_»cv_d–iv”_ev’t


806 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_şo£_ev’t
,

807 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_timeout_ev’t
,

808 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_su¥’d_ev’t
,

809 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_»sume_ev’t
,

810 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_İ’_ev’t
,

811 
j³g_’code_driv”_š_su¥’d_¡©e_»cv_d–iv”_ev’t


814 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_şo£_ev’t
,

815 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_timeout_ev’t
,

816 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_su¥’d_ev’t
,

817 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_»sume_ev’t
,

818 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_İ’_ev’t
,

819 
j³g_’code_driv”_š_ruÂšg_¡©e_»cv_d–iv”_ev’t


822 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_şo£_ev’t
,

823 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_timeout_ev’t
,

824 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_su¥’d_ev’t
,

825 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_»sume_ev’t
,

826 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_İ’_ev’t
,

827 
j³g_’code_driv”_š_Œªsãršg_¡©e_»cv_d–iv”_ev’t


830 .
	gsync_hook
 = 
j³g_’code_driv”_sync_hook
,

833 
	$tw5864_jifi_h—d”
(*
buf
, 
tw_j³g_logic_’code_chª_t
 *
logic_j³g_chn
)

835 *
ch¬_p
;

836 
APP_m¬k
 *
­p0_m¬k
;

837 
DQT_bË
 *
dqt_bË
;

838 
SOF_bË
 *
sof_bË
;

839 
width
, 
height
;

840 
tw_j³g_’code_´İ”ty_t
 *
j³g_´İ”ty
;

852 
j³g_´İ”ty
 = &
logic_j³g_chn
->
’code_´İ”ty
;

854 
width
 = 
j³g_´İ”ty
->
İ
->
	`g‘_mb_width
(jpeg_property);

855 
height
ğ
j³g_´İ”ty
->
İ
->
	`g‘_mb_height
(jpeg_property);

857 
ch¬_p
 = 
buf
;

859 *(*)
ch¬_p
 = 
	`sw­_shÜt
(
SOI
);

860 
ch¬_p
 += 2;

862 *
ch¬_p
 = 0xff;

863 
ch¬_p
++;

865 
­p0_m¬k
 = (
APP_m¬k
 *)
ch¬_p
;

866 
­p0_m¬k
->
æag
 = 
	`sw­_shÜt
(
	`APP
(0));

867 
­p0_m¬k
->
£gm’t_Ën
 = 
	`sw­_shÜt
(0x0010);

868 
	`¡rıy
(
­p0_m¬k
->
¡ršg
, 
JFIF_ID
);

869 
­p0_m¬k
->
v”siÚ
 = 
	`sw­_shÜt
(0x0101);

870 
­p0_m¬k
->
un™
 = 0x01;

871 
­p0_m¬k
->
width
 = 
	`sw­_shÜt
(0x0001);

872 
­p0_m¬k
->
height
 = 
	`sw­_shÜt
(0x0001);

874 
­p0_m¬k
->
sÿË_width
 = 0x00;

875 
­p0_m¬k
->
sÿË_height
= 0x00;

876 
ch¬_p
 +ğ
	`sw­_shÜt
(
­p0_m¬k
->
£gm’t_Ën
) + 2;

879 
dqt_bË
 = (
DQT_bË
 *)
ch¬_p
;

880 
dqt_bË
->
æag
 = 
	`sw­_shÜt
(
DQT
);

881 
dqt_bË
->
£gm’t_Ën
 = 
	`sw­_shÜt
(0x43);

882 
dqt_bË
->
bË
.
b™s
 = 0x0;

883 
dqt_bË
->
bË
.
id
 = 0x0;

884 
	`memıy
(
dqt_bË
->
bË
.
DQT_TABLE
, 
ba£_q_tbl_y
, 0x40);

885 
ch¬_p
 +ğ
	`sw­_shÜt
(
dqt_bË
->
£gm’t_Ën
) + 2;

888 
dqt_bË
 = (
DQT_bË
 *)
ch¬_p
;

889 
dqt_bË
->
æag
 = 
	`sw­_shÜt
(
DQT
);

890 
dqt_bË
->
£gm’t_Ën
 = 
	`sw­_shÜt
(0x43);

891 
dqt_bË
->
bË
.
b™s
 = 0x0;

892 
dqt_bË
->
bË
.
id
 = 0x1;

893 
	`memıy
(
dqt_bË
->
bË
.
DQT_TABLE
, 
ba£_q_tbl_uv
, 0x40);

894 
ch¬_p
 +ğ
	`sw­_shÜt
(
dqt_bË
->
£gm’t_Ën
) + 2;

897 
sof_bË
 = (
SOF_bË
 *)
ch¬_p
;

898 
sof_bË
->
æag
 = 
	`sw­_shÜt
(
	`SOF
(0));

899 
sof_bË
->
£gm’t_Ën
 = 
	`sw­_shÜt
(0x11);

900 
sof_bË
->
b™s
 = 0x08;

901 
sof_bË
->
height
 = 
	`sw­_shÜt
(height);

902 
sof_bË
->
width
 = 
	`sw­_shÜt
(width);

903 
sof_bË
->
cŞÜ
 = 0x03;

905 
sof_bË
->
comp
[0].
cŞÜ_id
 = 0x01;

906 
sof_bË
->
comp
[0].
HV
 = 0x22;

907 
sof_bË
->
comp
[0].
QDT_id
 = 0x00;

909 
sof_bË
->
comp
[1].
cŞÜ_id
 = 0x02;

910 
sof_bË
->
comp
[1].
HV
 = 0x11;

911 
sof_bË
->
comp
[1].
QDT_id
 = 0x01;

913 
sof_bË
->
comp
[2].
cŞÜ_id
 = 0x03;

914 
sof_bË
->
comp
[2].
HV
 = 0x11;

915 
sof_bË
->
comp
[2].
QDT_id
 = 0x01;

917 
ch¬_p
 +ğ
	`sw­_shÜt
(
sof_bË
->
£gm’t_Ën
) + 2;

920 
	`memıy
(
ch¬_p
, 
huffmª_DC0_tbl
, (huffman_DC0_tbl));

921 
ch¬_p
 +ğ(
huffmª_DC0_tbl
);

922 
	`memıy
(
ch¬_p
, 
huffmª_DC1_tbl
, (huffman_DC1_tbl));

923 
ch¬_p
 +ğ(
huffmª_DC1_tbl
);

924 
	`memıy
(
ch¬_p
, 
huffmª_AC0_tbl
, (huffman_AC0_tbl));

925 
ch¬_p
 +ğ(
huffmª_AC0_tbl
);

926 
	`memıy
(
ch¬_p
, 
huffmª_AC1_tbl
, (huffman_AC1_tbl));

927 
ch¬_p
 +ğ(
huffmª_AC1_tbl
);

931 
sos_bË
 = 
ch¬_p
;

932 
sos_bË
->
æag
 = 
	`sw­_shÜt
(
SOS
);

933 
sos_bË
->
£gm’t_Ën
 = 
	`sw­_shÜt
(0x0c);

934 
sos_bË
->
cŞÜ_comp_id
 = 0x03;

935 
sos_bË
->
¡¬t_šfo
[0].
DC_bË
 = 0x01;

936 
sos_bË
->
¡¬t_šfo
[0].
AC_bË
 = 0x00;

937 
sos_bË
->
¡¬t_šfo
[0].
d©a_¡¬t
 = 0x00;

938 
sos_bË
->
¡¬t_šfo
[0].
d©a_’d
 = 0x02;

939 
sos_bË
->
¡¬t_šfo
[0].
d©a_£Ëù
= 0x11;

941 
	`memıy
(
ch¬_p
, 
sos_bË_deçuÉ
, (sos_table_default));

943 
ch¬_p
 +ğ(
sos_bË_deçuÉ
);

945  (
ch¬_p
 - 
buf
);

946 
	}
}

948 
	$j³g_’code_hcd_š‹rçû_İ’
(
ed_tcb_t
 *
ed_tcb
)

950 if(
ed_tcb
){

951 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

953 
j³g_logic_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_İ’ed_logic_chª_ed
(
ed_tcb
);

954 if(
	`©omic_»ad
(&
j³g_logic_chª
->
İ’ed_æag
)){

955 
	`TW_DBG
(
TW_DBG_ERR
, "already opened\n");

956  -
EBUSY
;

959 
	`driv”_g’_İ’_ev’t
(
ed_tcb
, 1);

962  
TW_OK
;

963 
	}
}

965 
	$j³g_’code_hcd_š‹rçû_şo£
(
ed_tcb_t
 *
ed_tcb
)

967 if(
ed_tcb
){

968 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

969 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

971 
j³g_logic_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_İ’ed_logic_chª_ed
(
ed_tcb
);

972 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

974 if(
’code_cÚŒŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

975 
	`D–‘eSšgËFœeTim”Job
(
’code_cÚŒŞ
->
tim”_id
);

976 
’code_cÚŒŞ
->
tim”_id
 = 
INVALIDTIMERID
;

979 
	`TW_DBG
(
TW_DBG_INFO
, "wa™ j³g chªÃÈ%d clo£, cu¼’ˆ¡©%d\n", 
j³g_logic_chª
->
logic_chª_id
,

980 
j³g_logic_chª
->
İ’ed_logic_chª_ed
.
ed_fsm
.
İ
->
	`g‘_cu¼_¡©e
(&jpeg_logic_chan->opened_logic_chan_ed.ed_fsm));

981 
	`driv”_g’_şo£_ev’t
(
ed_tcb
, 1);

982 
ed_tcb
->
ed
.
İ
->
	`wa™_com¶‘e
(&ed_tcb->ed);

983 
	`tw_de¡roy_äame_tcb_queue
(&
j³g_logic_chª
->
j³g_äame_queue
, &j³g_logic_chª->
poŞ
);

984 
	`TW_DBG
(
TW_DBG_INFO
, "j³g chªÃÈ%d clo£d\n", 
j³g_logic_chª
->
logic_chª_id
);

987  
TW_OK
;

988 
	}
}

990 
	$j³g_’code_hcd_š‹rçû_su¥’d
(
ed_tcb_t
 *
ed_tcb
)

992 if(
ed_tcb
) {

993 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

995 
	}
}

997 
	$j³g_’code_hcd_š‹rçû_»sume
(
ed_tcb_t
 *
ed_tcb
)

999 if(
ed_tcb
) {

1000 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

1002 
	}
}

1004 
	$j³g_’code_hcd_š‹rçû_ioùl
(
ed_tcb_t
 *
ed_tcb
, 
cmd
, 
¬g
)

1006 
»t
 = 
TW_OK
;

1007 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
;

1008 
tw_j³g_’code_cÚŒŞ_t
 *
’code_ùrŞ
;

1009 
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
;

1010 
tw_mj³g_’code_·¿m_t
 
’code_·¿m
, *
cÚfig_·¿m
 = &encode_param;

1011 
tw_video_bus_t
 *
video_bus
;

1012 
ch_driv”_t
 *
ch_driv”
;

1013 
tw_ed_fsm_t
 *
ed_fsm
;

1015 if(!
ed_tcb
) {

1016 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1017  -
EINVAL
;

1020 
	`TW_DBG
(
TW_DBG_INFO
, "%c, %d\n", 
	`_IOC_TYPE
(
cmd
), 
	`_IOC_NR
(cmd));

1021 
j³g_logic_’code_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_İ’ed_logic_chª_ed
(
ed_tcb
);

1022 
ch_driv”
 = 
j³g_logic_’code_chª
->
ch
->chip_driver;

1023 
video_bus
 = &
ch_driv”
->video_bus;

1024 
’code_´İ”ty
 = &
j³g_logic_’code_chª
->encode_property;

1025 
’code_ùrŞ
 = &
j³g_logic_’code_chª
->
’code_cÚŒŞ
;

1026 
ed_fsm
 = &
ed_tcb
->ed_fsm;

1027 if(
	`©omic_»ad
(&
j³g_logic_’code_chª
->
İ’ed_æag
) == 0){

1028 
	`TW_DBG
(
TW_DBG_ERR
, "channel have‚ot be opend\n");

1029  -
ENODEV
;

1031 
cmd
) {

1032 
TW_MJPEG_ENCODE_PARAM_GET
:

1033 if(!
¬g
) {

1034 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

1035  -
EINVAL
;

1037 
	`cİy_äom_u£r
(&
’code_·¿m
, (*)
¬g
, (
tw_mj³g_’code_·¿m
));

1038 if(
cÚfig_·¿m
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_LEVEL_MASK
) {

1039 
’code_·¿m
.
e_image_Ëv–
 = 
’code_´İ”ty
->
İ
->
	`g‘_image_Ëv–
(encode_property);

1041 if(
cÚfig_·¿m
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
) {

1042 
’code_·¿m
.
i_image_width_mb_size
 = 
’code_´İ”ty
->
İ
->
	`g‘_mb_width
(encode_property)>>4;

1044 if(
cÚfig_·¿m
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
) {

1045 
cÚfig_·¿m
->
i_image_height_mb_size
 = 
’code_´İ”ty
->
İ
->
	`g‘_mb_height
(encode_property)>>4;

1047 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_NUMBER_MASK
) {

1048 
cÚfig_·¿m
->
i_ÿ±u»_äame_numb”
 = 
’code_´İ”ty
->
İ
->
	`g‘_ÿ±u»_numb”
(encode_property);

1050 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_STRIDE_MASK
) {

1051 
cÚfig_·¿m
->
i_ÿ±u»_äame_¡ride
 = 
’code_´İ”ty
->
İ
->
	`g‘_ÿ±u»_¡ride
(encode_property);

1053 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_TYPE_MASK
) {

1054 
cÚfig_·¿m
->
i_ÿ±u»_ty³
 = 
’code_´İ”ty
->
İ
->
	`g‘_ÿ±u»_ty³
(encode_property);

1057 
	`cİy_to_u£r
((*)
¬g
, &
’code_·¿m
, (
tw_mj³g_’code_·¿m_t
));

1059 
TW_MJPEG_ENCODE_PARAM_SET
:

1060 if(!
¬g
) {

1061 
	`TW_DBG
(
TW_DBG_ERR
, "invalid‡rg\n");

1062  -
EINVAL
;

1064 
	`cİy_äom_u£r
(&
’code_·¿m
, (*)
¬g
, (
tw_mj³g_’code_·¿m
));

1065 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_LEVEL_MASK
) {

1067 if(
’code_·¿m
.
e_image_Ëv–
 !ğ
MJPEG_IMAGE_LEVEL_0
){

1068 
	`TW_DBG
(
TW_DBG_ERR
, "imagËv–ƒ¼Ü, cu¼’ˆÚly suµÜˆ%d\n", 
MJPEG_IMAGE_LEVEL_0
);

1069 
»t
 = -
EINVAL
;

1073 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_STRIDE_MASK
) {

1074 if(
’code_·¿m
.
i_ÿ±u»_äame_¡ride
 < 
TW5864_MJPEG_MIN_INTERVAL
){

1075 
	`TW_DBG
(
TW_DBG_ERR
, "j³g iÁ”v® %dƒ¼Ü, >=%dms\n", 
’code_·¿m
.
i_ÿ±u»_äame_¡ride
, 
TW5864_MJPEG_MIN_INTERVAL
);

1076 
»t
 = -
EINVAL
;

1079 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
) {

1080 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
){

1081 if((
’code_·¿m
.
i_image_width_mb_size
 =ğ0è|| (’code_·¿m.
i_image_height_mb_size
 == 0)

1082 || (
’code_·¿m
.
i_image_width_mb_size
 > (
WIDTH_FRAME_D1_PAL
>>4))

1083 || (
’code_·¿m
.
i_image_height_mb_size
 > (
HEIGHT_FRAME_D1_PAL
>>4))) {

1084 
	`TW_DBG
(
TW_DBG_ERR
, "width o¸highˆ”rÜ(%d, %d)\n", 
’code_·¿m
.
i_image_width_mb_size
,ƒncode_·¿m.
i_image_height_mb_size
);

1085 
»t
 = -
EINVAL
;

1088 
	`TW_DBG
(
TW_DBG_ERR
, "hight should be set\n");

1089 
»t
 = -
EINVAL
;

1094 if(
»t
 =ğ
TW_OK
) {

1095 
’code_´İ”ty
->’code_´İ”ty.
chªge_mask_æag
 = 
’code_·¿m
.change_mask_flag;

1096 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_LEVEL_MASK
) {

1097 
’code_´İ”ty
->
İ
->
	`£t_image_Ëv–
Óncode_´İ”ty, 
’code_·¿m
.
e_image_Ëv–
);

1099 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
) {

1100 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
){

1101 
’code_´İ”ty
->
İ
->
	`£t_mb_height
Óncode_´İ”ty, 
’code_·¿m
.
i_image_height_mb_size
<<4);

1102 
’code_´İ”ty
->
İ
->
	`£t_mb_width
Óncode_´İ”ty, 
’code_·¿m
.
i_image_width_mb_size
<<4);

1105 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_STRIDE_MASK
) {

1106 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_¡ride
Óncode_´İ”ty, 
’code_·¿m
.
i_ÿ±u»_äame_¡ride
);

1108 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_NUMBER_MASK
) {

1109 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_numb”
Óncode_´İ”ty, 
’code_·¿m
.
i_ÿ±u»_äame_numb”
);

1111 if(
’code_·¿m
.
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_TYPE_MASK
) {

1112 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_ty³
Óncode_´İ”ty, 
’code_·¿m
.
i_ÿ±u»_ty³
);

1114 if(
ed_fsm
->
İ
->
	`g‘_cu¼_¡©e
Ód_fsmè=ğ
TW_ED_IDLE
) {

1115 if(
’code_ùrŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

1117 
	`D–‘eSšgËFœeTim”Job
(
’code_ùrŞ
->
tim”_id
);

1118 
’code_ùrŞ
->
tim”_id
 = 
INVALIDTIMERID
;

1120 
’code_ùrŞ
->
	`tim”_hook
(
j³g_logic_’code_chª
);

1124 
TW_LOGIC_CHAN_ENABLE_SET
:

1125 
	`TW_DBG
(
TW_DBG_INFO
, "su¥’d j³g chªÃÈ%d\n", 
j³g_logic_’code_chª
->
logic_chª_id
);

1127 if(
	`©omic_»ad
(&
’code_ùrŞ
->
v®id
)) {

1128 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 0);

1130 if(
’code_ùrŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

1132 
	`D–‘eSšgËFœeTim”Job
(
’code_ùrŞ
->
tim”_id
);

1133 
’code_ùrŞ
->
tim”_id
 = 
INVALIDTIMERID
;

1135 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

1138 if(
’code_ùrŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

1140 
	`D–‘eSšgËFœeTim”Job
(
’code_ùrŞ
->
tim”_id
);

1141 
’code_ùrŞ
->
tim”_id
 = 
INVALIDTIMERID
;

1143 
	`driv”_g’_»sume_ev’t
(
ed_tcb
, 1);

1145 
»t
 = 
TW_OK
;

1147 
TW_LOGIC_CHAN_DISABLE_SET
:

1148 
	`TW_DBG
(
TW_DBG_INFO
, "»sumj³g chªÃÈ%d\n", 
j³g_logic_’code_chª
->
logic_chª_id
);

1150 if(
	`©omic_»ad
(&
’code_ùrŞ
->
v®id
)) {

1151 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 0);

1153 if(
’code_ùrŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

1154 
	`D–‘eSšgËFœeTim”Job
(
’code_ùrŞ
->
tim”_id
);

1155 
’code_ùrŞ
->
tim”_id
 = 
INVALIDTIMERID
;

1157 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 1);

1160 if(
’code_ùrŞ
->
tim”_id
 !ğ
INVALIDTIMERID
){

1161 
	`D–‘eSšgËFœeTim”Job
(
’code_ùrŞ
->
tim”_id
);

1162 
’code_ùrŞ
->
tim”_id
 = 
INVALIDTIMERID
;

1164 
	`driv”_g’_su¥’d_ev’t
(
ed_tcb
, 1);

1166 
»t
 = 
TW_OK
;

1169 
	`TW_DBG
(
TW_DBG_ERR
, "nØsuch cmd %d\n", 
	`_IOC_NR
(
cmd
));

1170 
»t
 = -
EBADRQC
;

1173  
»t
;

1174 
	}
}

1176 
	$j³g_’code_hcd_š‹rçû_g‘_¡©e
(
ed_tcb_t
 *
ed_tcb
)

1178 
»t
 = 
TW_ED_UNREGISTER
;

1180 if(
ed_tcb
 !ğ
NULL
){

1181 
»t
 = 
	`©omic_»ad
(&
ed_tcb
->
¡©e
);

1184  
»t
;

1185 
	}
}

1187 
hcd_š‹rçû_İ”©iÚ
 
	gj³g_’code_hcd_š‹rçû_İ
 = {

1188 .
İ’
 = 
j³g_’code_hcd_š‹rçû_İ’
,

1189 .
	gşo£
 = 
j³g_’code_hcd_š‹rçû_şo£
,

1190 .
	gsu¥’d
 = 
j³g_’code_hcd_š‹rçû_su¥’d
,

1191 .
	g»sume
 = 
j³g_’code_hcd_š‹rçû_»sume
,

1192 .
	gioùl
 = 
j³g_’code_hcd_š‹rçû_ioùl
,

1193 .
	gg‘_¡©e
 = 
j³g_’code_hcd_š‹rçû_g‘_¡©e
,

1196 
	$j³g_logic_’code_chª_driv”_nÙify
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
tw_nÙify_msg
 *
msg
)

1198 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

1201 
	}
}

1203 
	$j³g_logic_’code_chª_driv”_m©ch_id
(
tw_»gi¡”_node_t
 *
node
, *
´iv
, 
logic_chª_id
)

1205 
»t
 = 
TW_ERR
;

1206 if((
node
!=
NULL
è&& (
´iv
!=NULL)){

1207 
tw_j³g_logic_’code_chª_t
 *
j³g_logic
 = (tw_j³g_logic_’code_chª_t*)
´iv
;

1208 if(
j³g_logic
->
logic_chª_id
 ==†ogic_chan_id){

1209 
»t
 = 
TW_OK
;

1213  
»t
;

1214 
	}
}

1216 
	$tw_j³g_’code_´İ”ty_š™
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1218 if(
’code_´İ”ty
) {

1219 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1221 
’code_·¿m
->
e_image_Ëv–
 = 
MJPEG_IMAGE_LEVEL_0
;

1222 
’code_·¿m
->
i_ÿ±u»_äame_numb”
 = 0;

1223 
’code_·¿m
->
i_ÿ±u»_äame_¡ride
 = 0;

1224 
’code_·¿m
->
i_ÿ±u»_ty³
 = 0;

1225 
’code_·¿m
->
i_image_width_mb_size
 = 0;

1226 
’code_·¿m
->
i_image_height_mb_size
 = 0;

1227 
’code_·¿m
->
chªge_mask_æag
 = 0;

1231 
	}
}

1233 
	$tw_j³g_’code_´İ”ty_»£t
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1235 if(
’code_´İ”ty
) {

1236 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1238 
’code_·¿m
->
e_image_Ëv–
 = 
MJPEG_IMAGE_LEVEL_0
;

1239 
’code_·¿m
->
i_ÿ±u»_äame_numb”
 = 0;

1240 
’code_·¿m
->
i_ÿ±u»_äame_¡ride
 = 0;

1241 
’code_·¿m
->
i_ÿ±u»_ty³
 = 0;

1242 
’code_·¿m
->
i_image_width_mb_size
 = 0;

1243 
’code_·¿m
->
i_image_height_mb_size
 = 0;

1244 
’code_·¿m
->
chªge_mask_æag
 = 0;

1248 
	}
}

1250 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_image_Ëv–
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1252 if(
’code_´İ”ty
) {

1253 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1255  
’code_·¿m
->
e_image_Ëv–
;

1259 
	}
}

1260 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_mb_width
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1262 if(
’code_´İ”ty
) {

1263 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1265  
’code_·¿m
->
i_image_width_mb_size
;

1269 
	}
}

1270 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_mb_height
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1272 if(
’code_´İ”ty
) {

1273 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1275  
’code_·¿m
->
i_image_height_mb_size
;

1279 
	}
}

1280 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_ÿ±u»_numb”
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1282 if(
’code_´İ”ty
) {

1283 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1285  
’code_·¿m
->
i_ÿ±u»_äame_numb”
;

1289 
	}
}

1290 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_ÿ±u»_¡ride
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1292 if(
’code_´İ”ty
) {

1293 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1295  
’code_·¿m
->
i_ÿ±u»_äame_¡ride
;

1299 
	}
}

1300 
u32
 
	$tw_j³g_’code_´İ”ty_g‘_ÿ±u»_ty³
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
)

1302 if(
’code_´İ”ty
) {

1303 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1305  
’code_·¿m
->
i_ÿ±u»_ty³
;

1309 
	}
}

1311 
	$tw_j³g_’code_´İ”ty_£t_image_Ëv–
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
TW_MJPEG_IMAGE_LEVEL_E
 
Ëv–
)

1313 if(
’code_´İ”ty
) {

1314 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1316 
’code_·¿m
->
e_image_Ëv–
 = 
Ëv–
;

1320 
	}
}

1321 
	$tw_j³g_’code_´İ”ty_£t_mb_width
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
u32
 
width
)

1323 if(
’code_´İ”ty
) {

1324 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1326 
’code_·¿m
->
i_image_width_mb_size
 = 
width
;

1330 
	}
}

1331 
	$tw_j³g_’code_´İ”ty_£t_mb_height
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
u32
 
height
)

1333 if(
’code_´İ”ty
) {

1334 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1336 
’code_·¿m
->
i_image_height_mb_size
 = 
height
;

1340 
	}
}

1341 
	$tw_j³g_’code_´İ”ty_£t_ÿ±u»_numb”
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
u32
 
numb”
)

1343 if(
’code_´İ”ty
) {

1344 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1346 
’code_·¿m
->
i_ÿ±u»_äame_numb”
 = 
numb”
;

1350 
	}
}

1351 
	$tw_j³g_’code_´İ”ty_£t_ÿ±u»_¡ride
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
u32
 
¡ride
)

1353 if(
’code_´İ”ty
) {

1354 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1356 
’code_·¿m
->
i_ÿ±u»_äame_¡ride
 = 
¡ride
;

1360 
	}
}

1361 
	$tw_j³g_’code_´İ”ty_£t_ÿ±u»_ty³
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
u32
 
ty³
)

1363 if(
’code_´İ”ty
) {

1364 
tw_mj³g_’code_·¿m_t
 *
’code_·¿m
 = &
’code_´İ”ty
->encode_property;

1366 
’code_·¿m
->
i_ÿ±u»_ty³
 = 
ty³
;

1370 
	}
}

1372 
tw_j³g_’code_´İ”ty_İ”©iÚ
 
	gj³g_’code_´İ”ty_İ
 = {

1373 .
š™
 = 
tw_j³g_’code_´İ”ty_š™
,

1374 .
	g»£t
 = 
tw_j³g_’code_´İ”ty_»£t
,

1376 .
	gg‘_ÿ±u»_numb”
 = 
tw_j³g_’code_´İ”ty_g‘_image_Ëv–
,

1377 .
	gg‘_ÿ±u»_¡ride
 = 
tw_j³g_’code_´İ”ty_g‘_ÿ±u»_¡ride
,

1378 .
	gg‘_ÿ±u»_ty³
 = 
tw_j³g_’code_´İ”ty_g‘_ÿ±u»_ty³
,

1379 .
	gg‘_image_Ëv–
 = 
tw_j³g_’code_´İ”ty_g‘_image_Ëv–
,

1380 .
	gg‘_mb_height
 = 
tw_j³g_’code_´İ”ty_g‘_mb_height
,

1381 .
	gg‘_mb_width
 = 
tw_j³g_’code_´İ”ty_g‘_mb_width
,

1383 .
	g£t_ÿ±u»_numb”
 = 
tw_j³g_’code_´İ”ty_£t_ÿ±u»_numb”
,

1384 .
	g£t_ÿ±u»_¡ride
 = 
tw_j³g_’code_´İ”ty_£t_ÿ±u»_¡ride
,

1385 .
	g£t_ÿ±u»_ty³
 = 
tw_j³g_’code_´İ”ty_£t_ÿ±u»_ty³
,

1386 .
	g£t_image_Ëv–
 = 
tw_j³g_’code_´İ”ty_£t_image_Ëv–
,

1387 .
	g£t_mb_height
 = 
tw_j³g_’code_´İ”ty_£t_mb_height
,

1388 .
	g£t_mb_width
 = 
tw_j³g_’code_´İ”ty_£t_mb_width
,

1396 
	$š™_j³g_’code_´İ”ty
(
tw_j³g_’code_´İ”ty_t
 *
’code_´İ”ty
, 
tw_mj³g_’code_·¿m_t
 *
cÚfig_·¿m
)

1398 if(
’code_´İ”ty
 && 
cÚfig_·¿m
){

1399 
	`¥š_lock_š™
(&
’code_´İ”ty
->
lock
);

1400 
’code_´İ”ty
->
İ
 = &
j³g_’code_´İ”ty_İ
;

1401 
’code_´İ”ty
->
İ
->
	`š™
(encode_property);

1403 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_numb”
Óncode_´İ”ty, 
cÚfig_·¿m
->
i_ÿ±u»_äame_numb”
);

1404 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_¡ride
Óncode_´İ”ty, 
cÚfig_·¿m
->
i_ÿ±u»_äame_¡ride
);

1405 
’code_´İ”ty
->
İ
->
	`£t_ÿ±u»_ty³
Óncode_´İ”ty, 
cÚfig_·¿m
->
i_ÿ±u»_ty³
);

1406 
’code_´İ”ty
->
İ
->
	`£t_image_Ëv–
Óncode_´İ”ty, 
cÚfig_·¿m
->
e_image_Ëv–
);

1407 
’code_´İ”ty
->
İ
->
	`£t_mb_width
Óncode_´İ”ty, 
cÚfig_·¿m
->
i_image_width_mb_size
);

1408 
’code_´İ”ty
->
İ
->
	`£t_mb_height
Óncode_´İ”ty, 
cÚfig_·¿m
->
i_image_height_mb_size
);

1409 
’code_´İ”ty
->’code_´İ”ty.
chªge_mask_æag
 = 
cÚfig_·¿m
->change_mask_flag;

1413 
	}
}

1417 
	$vj_g‘_chn_id
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1419 
addr
;

1420 
u32
 
v®
;

1421 
dvm_ch_t
 *
ch
;

1423 if(!
buf_šfo
)

1425  -
EINVAL
;

1428 
ch
 = 
buf_šfo
->chip;

1429 if(
buf_šfo
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
)

1431 
addr
 = 
JPEG_FRAME_VLD_0
;

1435 
addr
 = 
JPEG_FRAME_VLD_1
;

1437 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1438 
v®
 >>ğ16 + 
buf_šfo
->
buf_id
 * 4;

1439 
v®
 &= 0xf;

1441  
v®
;

1442 
	}
}

1445 
	$vj_g‘_chn_»s
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1447 
addr
;

1448 
u32
 
v®
;

1449 
dvm_ch_t
 *
ch
;

1451 if(!
buf_šfo
)

1453  -
EINVAL
;

1456 
ch
 = 
buf_šfo
->chip;

1457 if(
buf_šfo
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
)

1459 
addr
 = 
JPEG_FRAME_VLD_0
;

1463 
addr
 = 
JPEG_FRAME_VLD_1
;

1465 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1466 
v®
 >>= 8;

1467 
v®
 &= 0xff;

1469  
v®
;

1470 
	}
}

1473 
	$vj_Ãw_äame_±r
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1475 
addr
;

1476 
u32
 
v®
;

1477 
dvm_ch_t
 *
ch
;

1479 if(!
buf_šfo
)

1481  -
EINVAL
;

1484 
ch
 = 
buf_šfo
->chip;

1485 if(
buf_šfo
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
)

1487 
addr
 = 
JPEG_FRAME_VLD_0
;

1491 
addr
 = 
JPEG_FRAME_VLD_1
;

1493 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1494 
v®
 >>= 4;

1495 
v®
 &= 0x3;

1497  
v®
;

1498 
	}
}

1500 
	$vj_äame_v®id
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1502 
addr
;

1503 
u32
 
v®
;

1504 
dvm_ch_t
 *
ch
;

1506 if(!
buf_šfo
)

1508  -
EINVAL
;

1511 
ch
 = 
buf_šfo
->chip;

1512 if(
buf_šfo
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
)

1514 
addr
 = 
JPEG_FRAME_VLD_0
;

1518 
addr
 = 
JPEG_FRAME_VLD_1
;

1520 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1522  ((
v®
>>
buf_šfo
->
buf_id
) & 0x1);

1523 
	}
}

1525 
	$vj_’code_’abË
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1527 
addr
;

1528 
u32
 
v®
;

1529 
dvm_ch_t
 *
ch
;

1531 if(!
buf_šfo
)

1533  -
EINVAL
;

1537 
ch
 = 
buf_šfo
->chip;

1538 
addr
 = 
JPEG_ENABLE_JPEG
;

1540 
v®
 = (
buf_šfo
->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
 + buf_šfo->
buf_id
)<<1 | 0x01;

1541 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
addr
, 
v®
);

1544 
	}
}

1546 
	$vj_’code_di§bË
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1549 
	}
}

1552 
	$vj_g‘_Ëngth
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1554 
addr
;

1555 
u32
 
v®
;

1556 
dvm_ch_t
 *
ch
;

1558 if(!
buf_šfo
)

1560  -
EINVAL
;

1563 
ch
 = 
buf_šfo
->chip;

1564 
addr
 = 
	`JPEG_LENGTH
(
buf_šfo
->
buf_id
 + buf_šfo->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
);

1565 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1567  
v®
;

1568 
	}
}

1570 
	$vj_g‘_time¡amp
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1572 
addr
;

1573 
u32
 
v®
;

1574 
dvm_ch_t
 *
ch
;

1576 if(!
buf_šfo
)

1578  -
EINVAL
;

1581 
ch
 = 
buf_šfo
->chip;

1582 
addr
 = 
	`JPEG_TIMESTAMP
(
buf_šfo
->
buf_id
 + buf_šfo->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
);

1583 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1584 if((
buf_šfo
->
buf_id
 % 2)== 0)

1586 
v®
 &= 0xffff;

1590 
v®
 >>= 16;

1591 
v®
 &= 0xffff;

1594  
v®
;

1595 
	}
}

1597 
	$vj_j³g_com¶©e
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1599 
addr
;

1600 
u32
 
v®
;

1601 
dvm_ch_t
 *
ch
;

1603 if(!
buf_šfo
)

1605  -
EINVAL
;

1608 
ch
 = 
buf_šfo
->chip;

1609 
addr
 = 
JPEG_IRQ
;

1610 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1612  
v®
 & (1 <<(
buf_šfo
->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
 + buf_šfo->
buf_id
));

1613 
	}
}

1615 
	$vj_m¬k_u§bË
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1617 
addr
;

1618 
u32
 
v®
;

1619 
dvm_ch_t
 *
ch
;

1621 if(!
buf_šfo
)

1623  -
EINVAL
;

1626 
ch
 = 
buf_šfo
->chip;

1627 
addr
 = 
JPEG_IRQ
;

1629 
v®
 = 1 <<(
buf_šfo
->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
 + buf_šfo->
buf_id
);

1631 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
addr
, 
v®
);

1634 
	}
}

1636 
	$vj_£t_qsÿË
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
, 
qsÿË
)

1638 
addr
;

1639 
dvm_ch_t
 *
ch
;

1641 if(!
buf_šfo
)

1643  -
EINVAL
;

1646 
ch
 = 
buf_šfo
->chip;

1647 
addr
 = 
JPEG_ENCODE_QSCALE
;

1648 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
addr
, 
qsÿË
);

1651 
	}
}

1654 
	$vj_£t_fÜm©
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
, 
fÜm©
)

1656 
addr
;

1657 
dvm_ch_t
 *
ch
;

1659 if(!
buf_šfo
)

1661  -
EINVAL
;

1664 
ch
 = 
buf_šfo
->chip;

1665 
addr
 = 
JPEG_VIDEO_FORMAT
;

1666 if(
fÜm©
 =ğ
TW_VIDEO_STANDARD_PAL
)

1668 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
addr
, 0);

1672 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
addr
, 1);

1676 
	}
}

1678 
	$vj_g‘_Şd_buf
(
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
)

1680 
addr
;

1681 
u32
 
v®
 = 0;

1682 
i
 = 0;

1683 
dvm_ch_t
 *
ch
;

1685 if(!
buf_šfo
)

1687  -
EINVAL
;

1690 
ch
 = 
buf_šfo
->chip;

1692 if(
buf_šfo
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
)

1694 
addr
 = 
JPEG_FRAME_VLD_0
;

1698 
addr
 = 
JPEG_FRAME_VLD_1
;

1700 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
addr
);

1701 if((
v®
 & 0xf) != 0xf)

1703 
i
 = 0; i < 
VIDEO_JPEG_PATH_BUF
; i++)

1710 
v®
 = (val >> 4) & 0x3;

1711 
v®
 = ++val > 3 ? 0:val;

1714  
v®
;

1715 
	}
}

1717 
tw_vj_Üig_buf_šfo_İ”©iÚ
 
	gvj_buf_šfo_İ
 = {

1718 .
g‘_chn_id
 = 
vj_g‘_chn_id
,

1719 .
	gg‘_chn_»s
 = 
vj_g‘_chn_»s
,

1720 .
	gÃw_äame_±r
 = 
vj_Ãw_äame_±r
,

1721 .
	gäame_v®id
 = 
vj_äame_v®id
,

1722 .
	g’abË_’code
 = 
vj_’code_’abË
,

1723 .
	gdi§bË_’code
 = 
vj_’code_di§bË
,

1724 .
	gcom¶©e
 = 
vj_j³g_com¶©e
,

1725 .
	gg‘_Ëngth
 = 
vj_g‘_Ëngth
,

1726 .
	gg‘_time¡amp
 = 
vj_g‘_time¡amp
,

1727 .
	gm¬k_u§bË
 = 
vj_m¬k_u§bË
,

1728 .
	g£t_qsÿË
 = 
vj_£t_qsÿË
,

1729 .
	g£t_fÜm©
 = 
vj_£t_fÜm©
,

1730 .
	gg‘_Şd_buf
 = 
vj_g‘_Şd_buf
,

1733 
	$š™_tw5864_vj_¦Ù_Üig_buf_šfo
(
dvm_ch_t
 *
ch
, 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
, 
buf_id
)

1735 if(
buf_šfo
)

1737 
buf_šfo
->
İ
 = &
vj_buf_šfo_İ
;

1739 
	`©omic_£t
(&
buf_šfo
->
»ã»nû
, 0);

1740 
buf_šfo
->
buf_id
 = buf_id % 
VIDEO_JPEG_PATH_BUF
;

1741 if(
buf_id
 >ğ
VIDEO_JPEG_PATH_BUF
)

1743 
buf_šfo
->
·th_id
 = 1;

1747 
buf_šfo
->
·th_id
 = 0;

1749 
buf_šfo
->
ch
 = chip;

1750 
buf_id
)

1753 0:
buf_šfo
->
·ge_id
 = 0x09;;

1754 1:
buf_šfo
->
·ge_id
 = 0x0b;;

1755 2:
buf_šfo
->
·ge_id
 = 0x19;;

1756 3:
buf_šfo
->
·ge_id
 = 0x1b;;

1757 4:
buf_šfo
->
·ge_id
 = 0x29;;

1758 5:
buf_šfo
->
·ge_id
 = 0x2b;;

1759 6:
buf_šfo
->
·ge_id
 = 0x39;;

1760 7:
buf_šfo
->
·ge_id
 = 0x3b;;

1762 
buf_šfo
->
ddr_phy_ba£
 = (buf_šfo->
·ge_id
<<19è+ (
VIDEO_JPEG_DDR_BASE
<<2) - 0x80000;

1763 
buf_šfo
->
v®id_time
 = 0;

1764 
buf_šfo
->
Ï¡_tick
 = 0;

1768 
	}
}

1770 
	$tw_5864_vj_¡¬t_j³g
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

1772 
»t
 = 
TW_ERR
;

1775 if(
j³g_logic_chª
)

1777 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1778 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

1780 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

1781 
’code_cÚŒŞ
->
Ï¡_time_tick
 = 
	`g‘_tw_sy¡em_tick
();

1782 
äame_queue
 = &
j³g_logic_chª
->
j³g_äame_queue
;

1783 if(
’code_cÚŒŞ
->
ÿ±u»_æags
 & (
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
 | 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
)) {

1784 
äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(äame_queue, &
j³g_logic_chª
->
poŞ
);

1785 if(!
äame_queue
->
cu¼_´oduûr
){

1786 
	`TW_DBG
(
TW_DBG_ERR
, "no buffer…ool for jpeg!\n");

1787  -
ENOMEM
;

1790 
äame_queue
->
cu¼_´oduûr
->
äame_æags
 = 
’code_cÚŒŞ
->
ÿ±u»_æags
;

1793 
	`TW_DBG
(
TW_DBG_DEBUG
, "set valid flags,…ut service„equesto queue!\n");

1794 
	`driv”_g’_d–iv”_ev’t
(&
j³g_logic_chª
->
İ’ed_logic_chª_ed
, 1);

1796 
»t
 = 
TW_OK
;

1799  
»t
;

1800 
	}
}

1802 
	$tw5864_vj_move_j³g
(
tw_j³g_logic_’code_chª_t
 *
logic_j³g_chn
)

1804 
tw_vb_äame_tcb_t
 *
äame
;

1805 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

1806 
tw_vb_·ck‘_tcb_t
 *
·ck‘
;

1807 
tw_vb_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

1808 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

1809 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

1810 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1811 
dma_addr_t
 
‹mp_dma_addr
;

1812 
d´am_·ge_node_t
 *
d´am_·ge
;

1815 
’code_cÚŒŞ
 = &
logic_j³g_chn
->encode_control;

1816 
ch_d´am_cÚŒŞËr
 = &
logic_j³g_chn
->
ch
->chip_dpram_controller;

1817 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

1818 
bur¡_š‹rçû
->
İ
->
	`ş—r_bur¡_dÚe
(burst_interface);

1819 
d´am_·ge
 = 
logic_j³g_chn
->dpram_page;

1821 
äame_queue
 = &
logic_j³g_chn
->
j³g_äame_queue
;

1822 
äame
 = 
äame_queue
->
cu¼_´oduûr
;

1823 if(
äame
->
äame_is_”r
) {

1824  -
ENOMEM
;

1827 
·ck‘_queue
 = &
äame
->
vb_·ck‘_queue
;

1828 
·ck‘
 = 
·ck‘_queue
->
cu¼_´oduûr
;

1829 ià(
·ck‘
 =ğ
NULL
) {

1830 
·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
Õack‘_queue, 
äame
->
poŞ
);

1831 
·ck‘
 = 
·ck‘_queue
->
cu¼_´oduûr
;

1832 ià(
·ck‘
 =ğ
NULL
) {

1834 
äame
->
äame_is_”r
 = 1;

1835  -
ENOMEM
;

1837 
·ck‘
->
İ
->
	`dma_m­
Õack‘, 
DMA_FROM_DEVICE
);

1838 
·ck‘
->
·ylßd_Ën
 = 0;

1840 
‹mp_dma_addr
 = 
·ck‘
->
dma_addr
 +…ack‘->
·ylßd_Ën
;

1848 if(
’code_cÚŒŞ
->
£ùiÚ_numb”
 > 1){

1849 if(
	`©omic_»ad
(&
’code_cÚŒŞ
->
fœ¡_·ck‘
)){

1851 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, 
‹mp_dma_addr
, 
’code_cÚŒŞ
->
£ùiÚ_Ën
 - 
·ck‘
->
·ylßd_Ën
);

1852 
·ck‘
->
·ylßd_Ën
 +ğ
’code_cÚŒŞ
->
£ùiÚ_Ën
 -…acket->payload_len;

1854 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, 
‹mp_dma_addr
, 
’code_cÚŒŞ
->
£ùiÚ_Ën
);

1855 
·ck‘
->
·ylßd_Ën
 +ğ
’code_cÚŒŞ
->
£ùiÚ_Ën
;

1859 
bur¡_š‹rçû
->
İ
->
	`dma_ho¡_to_¤am_»ad
(bur¡_š‹rçû, 
d´am_·ge
, 
‹mp_dma_addr
, 
’code_cÚŒŞ
->
”_Ën
);

1860 
·ck‘
->
·ylßd_Ën
 +ğ
’code_cÚŒŞ
->
”_Ën
;

1865 
	}
}

1867 
	$tw_5864_vj_»ad_·¿m
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

1869 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1870 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

1871 
tw_vb_äame_tcb_t
 *
äame
;

1872 
tw_vb_·ck‘_tcb_t
 *
·ck‘
;

1873 
tw_vb_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

1874 
tw_vj_Üig_buf_šfo_t
 *
Üig_buf_šfo
;

1875 
d´am_·ge_node_t
 *
d´am_·ge
;

1876 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

1877 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

1878 
tw_time¡amp_t
 *
time¡amp
;

1879 
dvm_ch_t
 *
ch
;

1880 
tw5864_vj_bus_t
 *
vj_bus
;

1881 
u32
 
h—d”_Ën
 = 0, 
®ign
 = (è- ((
ext_h264_Çl_b™¡»am_t
) % 4);

1883 if(!
j³g_logic_chª
)

1885 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

1887  -
EINVAL
;

1891 
ch
 = 
j³g_logic_chª
->chip;

1892 
vj_bus
 = &
ch
->
ch_vj_bus
;

1893 
time¡amp
 = &
j³g_logic_chª
->timestamp;

1894 
Üig_buf_šfo
 = 
j³g_logic_chª
->
phy_video_¦Ù
->orig_buf_info;

1895 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

1896 
äame_queue
 = &
j³g_logic_chª
->
j³g_äame_queue
;

1897 
äame
 = 
äame_queue
->
cu¼_´oduûr
;

1898 if(!
äame
){

1899 
	`´štk
("%s,%d: f¿mi nuÎ\n", 
__FUNCTION__
, 
__LINE__
);

1900  -
EINVAL
;

1902 
time¡amp
->
İ
->
	`£t_time¡amp
Ñime¡amp, 
Üig_buf_šfo
->İ->
	`g‘_time¡amp
(Üig_buf_šfo), 
__FILE__
);

1903 
äame
->
äame_Ën
 = 0;

1904 
äame
->
äame_ty³
 = 
MJPEG_FRAME_TYPE
;

1905 
äame
->
äame_numb”
 = 
j³g_logic_chª
->
i_äame_£rŸl
;

1906 
äame
->
time¡amp
 =ime¡amp->
İ
->
	`g‘_time¡amp
(timestamp);

1909 
ch_d´am_cÚŒŞËr
 = &
j³g_logic_chª
->
ch
->chip_dpram_controller;

1910 if(!
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ddr_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
j³g_logic_chª
->
d´am_·ge
)){

1911 
	`´štk
("%s,%d:nØd´am_·ge!\n", 
__FILE__
, 
__LINE__
);

1912  -
ENOMEM
;

1914 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

1916 
d´am_·ge
 = 
j³g_logic_chª
->dpram_page;

1917 
·ck‘_queue
 = &
äame
->
vb_·ck‘_queue
;

1918 
·ck‘
 = 
·ck‘_queue
->
cu¼_´oduûr
;

1919 ià(
·ck‘
 =ğ
NULL
) {

1920 
·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
Õack‘_queue, &
j³g_logic_chª
->
poŞ
);

1921 
·ck‘
 = 
·ck‘_queue
->
cu¼_´oduûr
;

1922 ià(
·ck‘
 =ğ
NULL
) {

1924 
äame
->
äame_is_”r
 = 1;

1927 
·ck‘
->
cÚsum”_Ën
 = 
®ign
;

1928 
h—d”_Ën
 = 
	`tw5864_jifi_h—d”
(
·ck‘
->
d©a
 + (
ext_h264_Çl_b™¡»am_t
è+ 
®ign
, 
j³g_logic_chª
);

1929 
	`g’_ext_mj³g_h—d”
(
·ck‘
->
d©a
 + 
®ign
, 
Üig_buf_šfo
->
İ
->
	`g‘_Ëngth
(Üig_buf_šfoè+ 
h—d”_Ën
);

1930 
·ck‘
->
·ylßd_Ën
 = 
h—d”_Ën
 + (
ext_h264_Çl_b™¡»am_t
è+ 
®ign
;

1934 
’code_cÚŒŞ
->
tÙ®_äame_Ën
 = 
Üig_buf_šfo
->
İ
->
	`g‘_Ëngth
(Üig_buf_šfoè+ 
h—d”_Ën
 + (
ext_h264_Çl_b™¡»am_t
è+ 
®ign
;

1935 
’code_cÚŒŞ
->
äame_ba£_addr
 = 
h—d”_Ën
 + (
ext_h264_Çl_b™¡»am_t
è+ 
®ign
;

1936 
’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
 = 0;

1937 
’code_cÚŒŞ
->
£ùiÚ_Ën
 = 
d´am_·ge
->
İ
->
	`g‘_·ge_size
(dpram_page);

1938 
’code_cÚŒŞ
->
£ùiÚ_numb”
 = (’code_cÚŒŞ->
tÙ®_äame_Ën
è/ƒncode_cÚŒŞ->
£ùiÚ_Ën
;

1939 
’code_cÚŒŞ
->
”_Ën
 = (’code_cÚŒŞ->
tÙ®_äame_Ën
è%ƒncode_cÚŒŞ->
£ùiÚ_Ën
;

1941 
äame
->
äame_Ën
 = 
’code_cÚŒŞ
->
tÙ®_äame_Ën
;

1943 if(
’code_cÚŒŞ
->
”_Ën
){

1944 
’code_cÚŒŞ
->
£ùiÚ_numb”
++;

1946 
’code_cÚŒŞ
->
”_Ën
 =ƒncode_cÚŒŞ->
£ùiÚ_Ën
;

1949 
	`´štk
("%d: dd¸oà0x%08x,†’ 0x%08x, seùiÚ %d,a” %d,…ag%d\n", 
__LINE__
,

1950 
Üig_buf_šfo
->
ddr_phy_ba£
,

1951 
Üig_buf_šfo
->
İ
->
	`g‘_Ëngth
(orig_buf_info),

1952 
’code_cÚŒŞ
->
£ùiÚ_numb”
,

1953 
’code_cÚŒŞ
->
”_Ën
,

1954 
Üig_buf_šfo
->
·ge_id
);

1956 if(
·ck‘
) {

1957 
·ck‘
->
İ
->
	`dma_m­
Õack‘, 
DMA_TO_DEVICE
);

1959 
	`©omic_£t
(&
’code_cÚŒŞ
->
fœ¡_·ck‘
, 1);

1960 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(bur¡_š‹rçû, 
d´am_·ge
,

1961 (
Üig_buf_šfo
->
ddr_phy_ba£
),

1962 
Üig_buf_šfo
->
·ge_id
, (
’code_cÚŒŞ
->
£ùiÚ_Ën
 - 
h—d”_Ën
 - (
ext_h264_Çl_b™¡»am_t
è- 
®ign
), 
DDR_CHIP_B
);

1964 
	}
}

1966 
	$tw5864_vj_com¶‘e_nÙify
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

1968 
	`driv”_g’_d–iv”_ev’t
(&
j³g_logic_chª
->
İ’ed_logic_chª_ed
, 1);

1971 
	}
}

1973 
	$tw5864_vj_timeout_hook
(*
cÚ‹xt
)

1975 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
 = (tw_j³g_logic_’code_chª_ˆ*)
cÚ‹xt
;

1976 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1977 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

1979 
	`TW_DBG
(
TW_DBG_ERR
, "encodingimeout!\n");

1980 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

1981 
’code_cÚŒŞ
->
timeout_id
 = 
INVALIDTIMERID
;

1982 
äame_queue
 = &
j³g_logic_chª
->
j³g_äame_queue
;

1983 if(
äame_queue
->
cu¼_´oduûr
){

1984 
äame_queue
->
cu¼_´oduûr
->
äame_is_”r
 = 1;

1986 
	`driv”_g’_timeout_ev’t
(&
j³g_logic_chª
->
İ’ed_logic_chª_ed
, 1);

1988  
TW_OK
;

1989 
	}
}

1991 
	$tw5864_vj_tim”_hook
(*
cÚ‹xt
)

1993 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
 = (tw_j³g_logic_’code_chª_ˆ*)
cÚ‹xt
;

1994 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1995 
tw5864_vj_bus_t
 *
vj_bus
;

1996 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

1997 
tw_vb_äame_tcb_t
 *
äame
;

1999 
’code_cÚŒŞ
 = &
j³g_logic_chª
->encode_control;

2000 
vj_bus
 = &
j³g_logic_chª
->
ch
->
ch_vj_bus
;

2001 
’code_cÚŒŞ
->
tim”_id
 = 
INVALIDTIMERID
;

2003 
äame_queue
 = &
j³g_logic_chª
->
j³g_äame_queue
;

2004 
äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(äame_queue, &
j³g_logic_chª
->
poŞ
);

2005 
äame
 = 
äame_queue
->
cu¼_´oduûr
;

2006 if(
äame
){

2007 if(
’code_cÚŒŞ
->
ÿ±u»_æags
 & (
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
 | 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
)) {

2008 
äame
->
äame_æags
 = 
’code_cÚŒŞ
->
ÿ±u»_æags
;

2010 
äame
->
äame_æags
 = 0;

2011 
äame
->
äame_is_”r
 = 1;

2014 
’code_cÚŒŞ
->
tim”_id
 = 
	`AddSšgËFœeTim”Job
(1,ƒncode_cÚŒŞ->
tim”_hook
, 
j³g_logic_chª
);

2015 if(
’code_cÚŒŞ
->
tim”_id
 =ğ
ADDJOBERROR
) {

2016 
	`TW_DBG
(
TW_DBG_ERR
, "addimerƒrror!\n");

2022 
	`driv”_g’_d–iv”_ev’t
(&
j³g_logic_chª
->
İ’ed_logic_chª_ed
, 1);

2026 
	}
}

2028 
	$tw5864_vj_upd©e_ruÂšg_cÚfig
(
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
, 
tw_mj³g_’code_·¿m_t
 *
’code_cÚfig
)

2030 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

2031 
tw_video_bus_t
 *
video_bus
;

2032 
ch_driv”_t
 *
ch_driv”
;

2033 
nÜm
;

2035 if(!
’code_cÚŒŞ
 || !
’code_cÚfig
) {

2036 
	`TW_DBG
(
TW_DBG_DEBUG
, "null…ointer\n");

2037  -
EINVAL
;

2040 
j³g_logic_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_’code_cÚŒŞ
(
’code_cÚŒŞ
);

2042 
ch_driv”
 = 
j³g_logic_chª
->
ch
->chip_driver;

2043 
video_bus
 = &
ch_driv”
->video_bus;

2045 if(!
’code_cÚfig
->
chªge_mask_æag
) {

2048 
	`TW_DBG
(
TW_DBG_INFO
, "jpeg configure changed\n");

2051 
nÜm
 = 
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_bus);

2052 if(
’code_cÚfig
->
chªge_mask_æag
 & (
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_WIDTH_MASK
 | 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_HEIGHT_MASK
)) {

2053 
’code_cÚŒŞ
->
cu¼_size
 = 
	`VIDEO_SIZE_FROM_WIDTH_HEIGHT
(
’code_cÚfig
->
i_image_width_mb_size
,

2054 
’code_cÚfig
->
i_image_height_mb_size
,

2055 
nÜm
);

2056 
’code_cÚfig
->
i_image_width_mb_size
 = 
	`VIDEO_SIZE_TO_WIDTH
(
VIDEO_SIZE_FROM_VJ
, 
’code_cÚŒŞ
->
cu¼_size
, 
nÜm
);

2057 
’code_cÚfig
->
i_image_height_mb_size
 = 
	`VIDEO_SIZE_TO_HEIGHT
(
VIDEO_SIZE_FROM_VJ
, 
’code_cÚŒŞ
->
cu¼_size
, 
nÜm
);

2058 
j³g_logic_chª
->
phy_video_¦Ù
->
video_size
 = 
’code_cÚŒŞ
->
cu¼_size
;

2059 
	`TW_DBG
(
TW_DBG_INFO
, "upd©j³g videØsiztØ%d, (%d, %d)\n", 
’code_cÚŒŞ
->
cu¼_size
,

2060 
’code_cÚfig
->
i_image_width_mb_size
,ƒncode_cÚfig->
i_image_height_mb_size
);

2062 if(
’code_cÚfig
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_STRIDE_MASK
) {

2063 if(
’code_cÚfig
->
i_ÿ±u»_äame_¡ride
 < 
TW5864_MJPEG_MIN_INTERVAL
) {

2064 
’code_cÚfig
->
i_ÿ±u»_äame_¡ride
 = 
TW5864_MJPEG_MIN_INTERVAL
;

2066 
’code_cÚŒŞ
->
cu¼_š‹rv®
 = 
’code_cÚfig
->
i_ÿ±u»_äame_¡ride
 / 
MS_PER_TICK
;

2068 if(
’code_cÚfig
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_IMAGE_LEVEL_MASK
) {

2069 
’code_cÚfig
->
e_image_Ëv–
) {

2071 
MJPEG_IMAGE_LEVEL_0
:

2072 
’code_cÚŒŞ
->
cu¼_qsÿË
 = 0x10;

2074 
MJPEG_IMAGE_LEVEL_1
:

2075 
’code_cÚŒŞ
->
cu¼_qsÿË
 = 0x20;

2077 
MJPEG_IMAGE_LEVEL_2
:

2078 
’code_cÚŒŞ
->
cu¼_qsÿË
 = 0x30;

2080 
MJPEG_IMAGE_LEVEL_3
:

2081 
’code_cÚŒŞ
->
cu¼_qsÿË
 = 0x40;

2083 
MJPEG_IMAGE_LEVEL_4
:

2084 
’code_cÚŒŞ
->
cu¼_qsÿË
 = 0x50;

2088 if(
’code_cÚfig
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_FRAME_NUMBER_MASK
) {

2090 
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 = 
’code_cÚfig
->
i_ÿ±u»_äame_numb”
;

2094 if(
’code_cÚfig
->
chªge_mask_æag
 & 
TW_MJPEG_ENCODE_PARAM_ENABLE_CHANGE_CAPTURE_TYPE_MASK
) {

2095 
’code_cÚŒŞ
->
ÿ±u»_æags
 = 
’code_cÚfig
->
i_ÿ±u»_ty³
;

2096 if(!(
’code_cÚŒŞ
->
ÿ±u»_æags
 & 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
)) {

2097 
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 = 0;

2101 
’code_cÚfig
->
chªge_mask_æag
 = 0x0;

2103  
TW_OK
;

2104 
	}
}

2106 
	$š™_j³g_’code_cÚŒŞ
(
tw_j³g_’code_cÚŒŞ_t
 *
j³g_cÚŒŞ
)

2108 if(
j³g_cÚŒŞ
)

2110 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
;

2111 
tw_video_bus_t
 *
video_bus
;

2112 
ch_driv”_t
 *
ch_driv”
;

2114 
j³g_logic_chª
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_’code_cÚŒŞ
(
j³g_cÚŒŞ
);

2115 
ch_driv”
 = 
j³g_logic_chª
->
ch
->chip_driver;

2116 
video_bus
 = &
ch_driv”
->video_bus;

2118 
j³g_cÚŒŞ
->
Ï¡_jiff›s
 = 
jiff›s
;

2119 
j³g_cÚŒŞ
->
äame_š‹rv®
 = 0;

2120 
j³g_cÚŒŞ
->
lo¡_äame
 = 0;

2122 
j³g_cÚŒŞ
->
cu¼_š‹rv®
 = (
deçuÉ_j³g_’code_´İ”ty
.
i_ÿ±u»_äame_¡ride
 / 
MS_PER_TICK
);

2123 
j³g_cÚŒŞ
->
ÿ±u»_æags
 = 
deçuÉ_j³g_’code_´İ”ty
.
i_ÿ±u»_ty³
;

2125 
deçuÉ_j³g_’code_´İ”ty
.
e_image_Ëv–
) {

2127 
MJPEG_IMAGE_LEVEL_0
:

2128 
j³g_cÚŒŞ
->
cu¼_qsÿË
 = 0x10;

2130 
MJPEG_IMAGE_LEVEL_1
:

2131 
j³g_cÚŒŞ
->
cu¼_qsÿË
 = 0x20;

2133 
MJPEG_IMAGE_LEVEL_2
:

2134 
j³g_cÚŒŞ
->
cu¼_qsÿË
 = 0x30;

2136 
MJPEG_IMAGE_LEVEL_3
:

2137 
j³g_cÚŒŞ
->
cu¼_qsÿË
 = 0x40;

2139 
MJPEG_IMAGE_LEVEL_4
:

2140 
j³g_cÚŒŞ
->
cu¼_qsÿË
 = 0x50;

2144 
j³g_cÚŒŞ
->
cu¼_size
 = 
TW_VIDEO_SIZE_D1
;

2146 
j³g_cÚŒŞ
->
tÙ®_äame_Ën
 = 0;

2147 
j³g_cÚŒŞ
->
timeout_id
 = 
INVALIDTIMERID
;

2148 
j³g_cÚŒŞ
->
tim”_id
 = 
INVALIDTIMERID
;

2149 
	`©omic_£t
(&
j³g_cÚŒŞ
->
fœ¡_·ck‘
, 0);

2150 
j³g_cÚŒŞ
->
äame_ba£_addr
 = 0;

2151 
j³g_cÚŒŞ
->
£ùiÚ_numb”
 = 0;

2152 
j³g_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
 = 0;

2153 
j³g_cÚŒŞ
->
£ùiÚ_Ën
 = 0;

2154 
j³g_cÚŒŞ
->
”_Ën
 = 0;

2156 
j³g_cÚŒŞ
->
Ï¡_time_tick
 = 0;

2157 
j³g_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 = 1;

2159 
j³g_cÚŒŞ
->
¡¬t_j³g
 = 
tw_5864_vj_¡¬t_j³g
;

2160 
j³g_cÚŒŞ
->
move_j³g
 = 
tw5864_vj_move_j³g
;

2161 
j³g_cÚŒŞ
->
»ad_·¿m
 = 
tw_5864_vj_»ad_·¿m
;

2162 
j³g_cÚŒŞ
->
nÙify
 = 
tw5864_vj_com¶‘e_nÙify
;

2163 
j³g_cÚŒŞ
->
timeout_hook
 = 
tw5864_vj_timeout_hook
;

2164 
j³g_cÚŒŞ
->
tim”_hook
 = 
tw5864_vj_tim”_hook
;

2165 
j³g_cÚŒŞ
->
upd©e_ruÂšg_cÚfig
 = 
tw5864_vj_upd©e_ruÂšg_cÚfig
;

2167  -
EINVAL
;

2171 
	}
}

2174 
	$tw5864_j³g_phy_video_¦Ù_š™
(
tw_j³g_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
phy_¦Ù_id
)

2176 if(
phy_video_¦Ù
 !ğ
NULL
){

2177 
	`©omic_£t
(&
phy_video_¦Ù
->
¡¬t_æag
, 0);

2178 
phy_video_¦Ù
->
phy_¦Ù_id
 =…hy_slot_id;

2179 
phy_video_¦Ù
->
video_size
 = 
TW_VIDEO_SIZE_D1
;

2180 
phy_video_¦Ù
->
Üig_buf_šfo
 = 
NULL
;

2181 
	`š™_»gi¡”_bË_node
(&
phy_video_¦Ù
->
logic_chª_bË
);

2182 
	`š™_»gi¡”_bË_node
(&
phy_video_¦Ù
->
İ’ed_logic_chª_bË
);

2184 
	}
}

2186 
tw_j³g_phy_video_¦Ù_İ”©iÚ
 
	gtw5864_j³g_phy_video_¦Ù_İ
 = {

2187 .
š™
 = 
tw5864_j³g_phy_video_¦Ù_š™
,

2190 
	$š™_tw5864_j³g_phy_video_¦Ù
(
tw_j³g_phy_video_¦Ù_t
 *
phy_video_¦Ù
, 
¦Ù_id
)

2192 if(
phy_video_¦Ù
 !ğ
NULL
){

2193 
phy_video_¦Ù
->
İ
 = &
tw5864_j³g_phy_video_¦Ù_İ
;

2194 
phy_video_¦Ù
->
İ
->
	`š™
Õhy_video_¦Ù, 
¦Ù_id
);

2196 
	}
}

2198 
	$tw5864_mj³g_·th_is_busy
(
tw5864_mj³g_·th_t
 *
mj³g_·th
)

2200 
dvm_ch_t
 *
ch
;

2201 
u32
 
v®
 = 0;

2202 
ch
 = 
	`to_g‘_ch_w™h_ch_vj_bus
(
mj³g_·th
->
vj_bus
);

2204 if(
mj³g_·th
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
){

2205 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
VIDEO_JPEG_CMD_PATH0
);

2206  (
v®
 &(
JPEG_CMD_SINGLE
 | 
JPEG_CMD_BURST
));

2209 
v®
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
VIDEO_JPEG_CMD_PATH1
);

2210  (
v®
 &(
JPEG_CMD_SINGLE
 | 
JPEG_CMD_BURST
));

2214 
	}
}

2216 
	$tw5864_mj³g_·th_sšgË_ÿp
(
tw5864_mj³g_·th_t
 *
mj³g_·th
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

2218 
dvm_ch_t
 *
ch
;

2219 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
;

2220 
u32
 
fÜm©
 = 0x0;

2221 
downsÿË
 = 0;

2224 
ch
 = 
j³g_logic_chª
->chip;

2225 
phy_¦Ù
 = 
j³g_logic_chª
->
phy_video_¦Ù
;

2226 
phy_¦Ù
->
video_size
) {

2228 
	`TW_DBG
(
TW_DBG_ERR
, "videØsiz%d unsuµÜt, chªgtØD1\n", 
phy_¦Ù
->
video_size
);

2229 
TW_VIDEO_SIZE_D1
:

2230 
fÜm©
 = 0x0;

2232 
TW_VIDEO_SIZE_HALF_D1
:

2233 
fÜm©
 = 0x0;

2234 
downsÿË
 = 1;

2236 
TW_VIDEO_SIZE_CIF
:

2237 
fÜm©
 = 0x3;

2238 
downsÿË
 = 1;

2240 
TW_VIDEO_SIZE_QCIF
:

2241 
fÜm©
 = 0x1;

2242 
downsÿË
 = 1;

2246 if(
mj³g_·th
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
){

2247 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VIDEO_JPEG_CMD_PATH0
, 
JPEG_CMD_SINGLE


2248 | 
	`JPEG_CMD_CHANNEL
(
phy_¦Ù
->
phy_¦Ù_id
)

2249 | 
	`JPEG_CMD_FORMAT
(
fÜm©
è| (
downsÿË
 ?
JPEG_CMD_DSAMPLE
:0));

2250 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_CAP_PATH0_ENABLE
, 0x1);

2253 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VIDEO_JPEG_CMD_PATH1
, 
JPEG_CMD_SINGLE


2254 | 
	`JPEG_CMD_CHANNEL
(
phy_¦Ù
->
phy_¦Ù_id
)

2255 | 
	`JPEG_CMD_FORMAT
(
fÜm©
è| (
downsÿË
 ?
JPEG_CMD_DSAMPLE
:0));

2256 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_CAP_PATH1_ENABLE
, 0x1);

2259 
mj³g_·th
->
time_id
 = 
	`AddSšgËFœeTim”Job
(
TIMER_200MS
, mj³g_·th->
İ
->
timeout_hook
, mjpeg_path);

2260 if(
mj³g_·th
->
time_id
 =ğ
ADDJOBERROR
) {

2261 
	`TW_DBG
(
TW_DBG_ERR
, "addimerƒrror!\n");

2263 
	}
}

2265 
	$tw5864_mj³g_·th_bur¡_ÿp
(
tw5864_mj³g_·th_t
 *
mj³g_·th
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_chª
)

2267 
dvm_ch_t
 *
ch
;

2268 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
;

2269 
u32
 
fÜm©
 = 0x0;

2271 
ch
 = 
j³g_logic_chª
->chip;

2272 
phy_¦Ù
 = 
j³g_logic_chª
->
phy_video_¦Ù
;

2273 
phy_¦Ù
->
video_size
) {

2275 
TW_VIDEO_SIZE_D1
:

2276 
fÜm©
 = 0x0;

2277 
TW_VIDEO_SIZE_HALF_D1
:

2278 
TW_VIDEO_SIZE_CIF
:

2279 
fÜm©
 = 0x11;

2281 if(
mj³g_·th
->
·th_id
 =ğ
VIDEO_JPEG_PATH0
){

2282 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VIDEO_JPEG_CMD_PATH0
, 
JPEG_CMD_BURST


2283 | 
	`JPEG_CMD_CHANNEL
(
phy_¦Ù
->
phy_¦Ù_id
)

2284 | 
	`JPEG_CMD_FORMAT
(
fÜm©
è| ((
phy_¦Ù
->
video_size
 =ğ
TW_VIDEO_SIZE_CIF
è?
JPEG_CMD_DSAMPLE
:0));

2287 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VIDEO_JPEG_CMD_PATH1
, 
JPEG_CMD_BURST


2288 | 
	`JPEG_CMD_CHANNEL
(
phy_¦Ù
->
phy_¦Ù_id
)

2289 | 
	`JPEG_CMD_FORMAT
(
fÜm©
è| ((
phy_¦Ù
->
video_size
 =ğ
TW_VIDEO_SIZE_CIF
è?
JPEG_CMD_DSAMPLE
:0));

2291 
	}
}

2293 
	$tw5864_mj³g_·th_v®id_nÙify
(
tw5864_mj³g_·th_t
 *
mj³g_·th
)

2295 
tw_j³g_logic_’code_chª_t
 *
logic_j³g_chn
;

2296 
j³g_£rviû_queue_t
 *
£rviû_queue
;

2297 
j³g_£rviû_tcb_t
 *
£rviû_tcb
;

2298 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

2299 
tw5864_vj_bus_t
 *
vj_bus
;

2300 
u32
 
Üig_buf_id
 = 0;

2302 if(
mj³g_·th
){

2303 if(((
mj³g_·th
->
cu¼’t_’codšg_±r
 =ğmj³g_·th->
cu¼’t_äame_±r
)

2304 || ((
mj³g_·th
->
cu¼’t_äame_±r
 + 1 - mj³g_·th->
cu¼’t_’codšg_±r
è< 
VIDEO_JPEG_PATH_BUF
))){

2305 
vj_bus
 = 
mj³g_·th
->vj_bus;

2306 
£rviû_queue
 = &
vj_bus
->
j³g_£rviû_queue
;

2307 
£rviû_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(service_queue);

2308 
£rviû_tcb
 = 
£rviû_queue
->
cu¼_cÚsum”
;

2309 if(
£rviû_tcb
){

2310 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

2312 
logic_j³g_chn
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_’code_»que¡_tcb
(
£rviû_tcb
);

2313 
	`driv”_g’_d–iv”_ev’t
(&
logic_j³g_chn
->
İ’ed_logic_chª_ed
, 1);

2314 
mj³g_·th
->
logic_’codšg_bË
[mj³g_·th->
cu¼’t_äame_±r
] = 
logic_j³g_chn
;

2315 
mj³g_·th
->
İ
->
	`sšgË_ÿp
(mj³g_·th, 
logic_j³g_chn
);

2316 
Üig_buf_id
 = 
mj³g_·th
->
cu¼’t_äame_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

2317 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
Üig_buf_id
;

2318 
buf_šfo
->
Ï¡_tick
 = 
	`g‘_tw_sy¡em_tick
();

2321 
’code_cÚŒŞ
 = &
logic_j³g_chn
->encode_control;

2322 if(
’code_cÚŒŞ
->
ÿ±u»_æags
 & 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
) {

2323 
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
--;

2324 if(
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 < 0) {

2325 
’code_cÚŒŞ
->
ÿ±u»_Ëá_couÁ
 = 0;

2329 
mj³g_·th
->
cu¼’t_äame_±r
++;

2330 if(
mj³g_·th
->
cu¼’t_äame_±r
 >ğ
VIDEO_JPEG_PATH_BUF
) {

2331 
mj³g_·th
->
cu¼’t_äame_±r
 = 0;

2333 
£rviû_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(service_queue);

2337 
	}
}

2339 
	$tw5864_mj³g_·th_¡¬t_’codšg
(*
cÚ‹xt
)

2341 
tw5864_mj³g_·th_t
 *
mj³g_·th
 = (tw5864_mj³g_·th_ˆ*)
cÚ‹xt
;

2343 if(
mj³g_·th
) {

2344 
u32
 
Üig_buf_id
;

2345 
tw5864_vj_bus_t
 *
vj_bus
;

2346 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

2347 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

2348 
tw_video_bus_t
 *
video_bus
;

2349 
ch_driv”_t
 *
ch_driv”
;

2350 
tw_j³g_logic_’code_chª_t
 *
logic_j³g_chn
 = 
mj³g_·th
->
logic_’codšg_bË
[mj³g_·th->
cu¼’t_’codšg_±r
];

2352 
vj_bus
 = 
mj³g_·th
->vj_bus;

2353 
Üig_buf_id
 = 
mj³g_·th
->
cu¼’t_’codšg_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

2354 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
Üig_buf_id
;

2356 if(
logic_j³g_chn
) {

2357 
	`©omic_£t
(&
vj_bus
->
busy
, 1);

2358 
’code_cÚŒŞ
 = &
logic_j³g_chn
->encode_control;

2360 
buf_šfo
->
İ
->
	`£t_qsÿË
(buf_šfo, 
’code_cÚŒŞ
->
cu¼_qsÿË
);

2361 
ch_driv”
 = 
logic_j³g_chn
->
ch
->chip_driver;

2362 
video_bus
 = &
ch_driv”
->video_bus;

2364 if(
video_bus
->
İ
->
	`g‘_video_¡ªd¬d
(video_busè=ğ
TW_VIDEO_STANDARD_PAL
) {

2365 
buf_šfo
->
İ
->
	`£t_fÜm©
(buf_info, 0);

2367 
buf_šfo
->
İ
->
	`£t_fÜm©
(buf_info, 1);

2369 
buf_šfo
->
v®id_time
 = 
	`g‘_tw_sy¡em_tick
(è- buf_šfo->
Ï¡_tick
;

2370 
buf_šfo
->
Ï¡_tick
 = 
	`g‘_tw_sy¡em_tick
();

2371 
’code_cÚŒŞ
->
timeout_id
 = 
	`AddSšgËFœeTim”Job
(
TIMER_200MS
,ƒncode_cÚŒŞ->
timeout_hook
, 
logic_j³g_chn
);

2372 if(
’code_cÚŒŞ
->
timeout_id
 =ğ
ADDJOBERROR
) {

2373 
	`´štk
("%s,%d:‡ddim”ƒ¼Ü!\n", 
__FUNCTION__
, 
__LINE__
);

2374 
’code_cÚŒŞ
->
timeout_id
 = 
INVALIDTIMERID
;

2376 
	`ch_»que¡_œq
(
logic_j³g_chn
->
ch
, 
IRQ_JPEG_TYPE_INTR
, 
vj_bus
->
İ
->
œq
, "JPEG", (*)
mj³g_·th
);

2378 
buf_šfo
->
İ
->
	`’abË_’code
(buf_info);

2380 
mj³g_·th
->
cu¼’t_’codšg_±r
++;

2381 if(
mj³g_·th
->
cu¼’t_’codšg_±r
 >ğ
VIDEO_JPEG_PATH_BUF
) {

2382 
mj³g_·th
->
cu¼’t_’codšg_±r
 = 0;

2389 
	}
}

2391 
	$tw5864_mj³g_·th_sync_·th
(
tw5864_mj³g_·th_t
 *
mj³g_·th
)

2393 if(
mj³g_·th
) {

2395 
	}
}

2397 
	$tw5864_mj³g_·th_ÿp_timeout_hook
(*
cÚ‹xt
)

2399 
tw5864_mj³g_·th_t
 *
mj³g_·th
 = (tw5864_mj³g_·th_ˆ*)
cÚ‹xt
;

2401 if(
mj³g_·th
) {

2402 
	`TW_DBG
(
TW_DBG_ERR
, "j³g…©h %dimeout\n", 
mj³g_·th
->
·th_id
);

2403 
mj³g_·th
->
time_id
 = 
INVALIDTIMERID
;

2405  
TW_OK
;

2408  -
EINVAL
;

2409 
	}
}

2411 
tw5864_mj³g_·th_İ”©iÚ_t
 
	gtw5864_mj³g_·th_İ
 = {

2412 .
is_busy
 = 
tw5864_mj³g_·th_is_busy
,

2413 .
	gsšgË_ÿp
 = 
tw5864_mj³g_·th_sšgË_ÿp
,

2414 .
	gbur¡_ÿp
 = 
tw5864_mj³g_·th_bur¡_ÿp
,

2415 .
	gv®id_nÙify
 = 
tw5864_mj³g_·th_v®id_nÙify
,

2416 .
	g¡¬t_’codšg
 = 
tw5864_mj³g_·th_¡¬t_’codšg
,

2417 .
	gsync_·th
 = 
tw5864_mj³g_·th_sync_·th
,

2418 .
	gtimeout_hook
 = 
tw5864_mj³g_·th_ÿp_timeout_hook
,

2421 
	$tw5864_vj_bus_š™
(
tw5864_vj_bus_t
 *
vj_bus
)

2423 
i
, 
j
;

2424 
tw_j³g_phy_video_¦Ù_t
 *
phy_¦Ù
;

2425 
tw5864_mj³g_·th_t
 *
mj³g_·th
;

2426 
dvm_ch_t
 *
ch
;

2427 
tw_vj_Üig_buf_šfo_t
 *
Üig_buf
;

2428 
pos
;

2430 if(
vj_bus
)

2432 
vj_bus
->
time_id
 = 
INVALIDTIMERID
;

2433 
vj_bus
->
cu¼’t_ås
 = 0;

2434 
vj_bus
->
i_¡©ic_£cÚd_couÁ”
 = 0;

2435 
vj_bus
->
i_‹mp_ås_couÁ”
 = 0;

2437 
ch
 = 
	`to_g‘_ch_w™h_ch_vj_bus
(
vj_bus
);

2438 
	`¥š_lock_š™
(&
vj_bus
->
lock
);

2439 
vj_bus
->
İ
->
	`»£t
(vj_bus);

2440 
	`š™_j³g_£rviû_queue
(&
vj_bus
->
j³g_£rviû_queue
);

2442 
	`©omic_£t
(&
vj_bus
->
busy
, 0);

2443 
vj_bus
->
·th_sw™ch
 = 0;

2445 
i
 = 0; i < (
VIDEO_JPEG_PATH_BUF
 * 2); i++){

2446 
	`š™_tw5864_vj_¦Ù_Üig_buf_šfo
(
ch
, &
vj_bus
->
vj_Üig_buf
[
i
], i);

2448 
i
 = 0; i < 
VIDEO_JPEG_PATH_CNT
; i++){

2449 
Üig_buf
 = &
vj_bus
->
vj_Üig_buf
[
i
 * 
VIDEO_JPEG_PATH_BUF
];

2450 
pos
 = 
Üig_buf
->
İ
->
	`Ãw_äame_±r
(orig_buf);

2451 
mj³g_·th
 = &
vj_bus
->mj³g_·th[
i
];

2452 
mj³g_·th
->
·th_id
 = 
i
;

2453 
mj³g_·th
->
time_id
 = 
INVALIDTIMERID
;

2454 
mj³g_·th
->
d–ay_time_id
 = 
INVALIDTIMERID
;

2455 
mj³g_·th
->
vj_bus
 = vj_bus;

2456 
mj³g_·th
->
cu¼’t_äame_±r
 = 
pos
;

2457 
mj³g_·th
->
cu¼’t_’codšg_±r
 = 
pos
;

2458 
mj³g_·th
->
cu¼’t_cÚsum”_±r
 = 
pos
;

2459 
j
 = 0; j < 
VIDEO_JPEG_PATH_BUF
; j++) {

2460 
mj³g_·th
->
logic_’codšg_bË
[
j
] = 
NULL
;

2462 
mj³g_·th
->
İ
 = &
tw5864_mj³g_·th_İ
;

2465 if(
vj_bus
->
İ
) {

2466 
vj_bus
->
time_id
 = 
	`AddFÜFœeTim”Job
(1, vj_bus->
İ
->
¡¬t_mÚ™Ü_sk
, vj_bus);

2467 if(
vj_bus
->
time_id
 =ğ
ADDJOBERROR
)

2469 
	`´štk
("%s.%d:‡ddim” hookƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

2474 
phy_¦Ù
 = 
vj_bus
->
phy_video_¦Ù
;

2475 
i
 = 0; i < 
TW5864_PHY_VD_CHAN_NUMBER
; i++){

2476 
	`š™_tw5864_j³g_phy_video_¦Ù
(
phy_¦Ù
, 
i
);

2477 
phy_¦Ù
++;

2479 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_MODULE_REST
, 0xe0000000);

2480 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_CAP_TIMEOUT
, 0x01000000);

2484 
	}
}

2486 
	$tw5864_vj_bus_»Ëa£
(
tw5864_vj_bus_t
 *
vj_bus
)

2488 if(!
vj_bus
) {

2492 if(
vj_bus
->
İ
) {

2493 
vj_bus
->
İ
->
	`¡İ_mÚ™Ü_sk
(vj_bus);

2495 
	`»move_j³g_£rviû_queue
(&
vj_bus
->
j³g_£rviû_queue
);

2496 
	}
}

2498 
	$š™_j³g_£rviû_tcb_w™h_nuÎ
(
j³g_£rviû_tcb_t
 *
’code_»que¡_tcb
)

2500 
tw5864_vj_bus_t
 *
vj_bus
;

2501 
j³g_£rviû_queue_t
 *
£rviû_queue
;

2503 if(
’code_»que¡_tcb
){

2504 
tw_j³g_logic_’code_chª_t
 *
j³g_logic
 = 
	`to_g‘_tw_j³g_’code_chª_w™h_’code_»que¡_tcb
(
’code_»que¡_tcb
);

2505 
tcb_node_t
 *
£rviû_tcb
 = &
’code_»que¡_tcb
->service_tcb;

2506 
£rviû_tcb
->
İ
 = &
tcb_node_İ
;

2507 
£rviû_tcb
->
İ
->
	`š™
(service_tcb);

2508 
£rviû_tcb
->
İ
->
	`£t_´iv
(£rviû_tcb, 
’code_»que¡_tcb
);

2509 
’code_»que¡_tcb
->
cÚ‹xt
 = 
j³g_logic
;

2510 
’code_»que¡_tcb
->
ty³
 = 
DVM_CHIP_REQ_SINGLE
;

2511 
’code_»que¡_tcb
->
»q_ÿÎback
 = 
NULL
;

2513 
vj_bus
 = &
j³g_logic
->
ch
->
ch_vj_bus
;

2514 
£rviû_queue
 = &
vj_bus
->
j³g_£rviû_queue
;

2517 
	}
}

2519 
	$j³g_£rviû_queue_š™
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
)

2521 if(
j³g_£rviû_queue
 !ğ
NULL
){

2522 
tcb_node_queue_t
 *
£rviû_queue
 = &
j³g_£rviû_queue
->service_queue;

2523 
	`¥š_lock_š™
(&
j³g_£rviû_queue
->
lock
);

2524 
	`©omic_£t
(&
j³g_£rviû_queue
->
j³g_»sourû
, 8);

2525 
£rviû_queue
->
İ
 = &
tcb_node_queue_İ
;

2526 
£rviû_queue
->
İ
->
	`š™
(service_queue);

2527 
j³g_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

2529 
	}
}

2531 
	$j³g_£rviû_queue_g‘_queue_cu¼_’Œy_numb”
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
)

2533 
»t
 = 0;

2534 if(
j³g_£rviû_queue
 !ğ
NULL
){

2535 
tcb_node_queue_t
 *
£rviû_queue
 = &
j³g_£rviû_queue
->service_queue;

2536 
»t
 = 
£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(service_queue);

2538  
»t
;

2539 
	}
}

2541 
	$j³g_£rviû_queue_put_£rviû_»que¡_što_queue
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
, 
j³g_£rviû_tcb
 *
£rviû_tcb
)

2543 if((
j³g_£rviû_queue
!=
NULL
è&& (
£rviû_tcb
!=NULL)){

2544 
tcb_node_queue_t
 *
£rviû_queue
 = &
j³g_£rviû_queue
->service_queue;

2545 
æags
;

2546 
cu¼_’Œy_numb”
;

2548 
	`¥š_lock_œq§ve
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2549 
cu¼_’Œy_numb”
 = 
j³g_£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(jpeg_service_queue);

2550 if((
cu¼_’Œy_numb”
==0è&& (
j³g_£rviû_queue
->
cu¼_cÚsum”
==
NULL
)){

2551 if(
£rviû_tcb
->
»q_ÿÎback
) {

2552 
£rviû_tcb
->
	`»q_ÿÎback
(£rviû_tcb->
cÚ‹xt
);

2554 
j³g_£rviû_queue
->
cu¼_cÚsum”
 = 
£rviû_tcb
;

2556 
£rviû_queue
->
İ
->
	`put
(£rviû_queue, &
£rviû_tcb
->service_tcb);

2559 
	`¥š_uÆock_œq»¡Üe
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2561 
	}
}

2563 
	$j³g_£rviû_queue_put_£rviû_»que¡_što_queue_h—d”
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
, 
j³g_£rviû_tcb_t
 *
£rviû_tcb
)

2565 if((
j³g_£rviû_queue
!=
NULL
è&& (
£rviû_tcb
!=NULL)){

2566 
tcb_node_queue_t
 *
£rviû_queue
 = &
j³g_£rviû_queue
->service_queue;

2567 
æags
;

2568 
cu¼_’Œy_numb”
;

2570 
	`¥š_lock_œq§ve
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2571 
cu¼_’Œy_numb”
 = 
j³g_£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(jpeg_service_queue);

2572 if((
cu¼_’Œy_numb”
==0è&& (
j³g_£rviû_queue
->
cu¼_cÚsum”
==
NULL
)){

2573 if(
£rviû_tcb
->
»q_ÿÎback
) {

2574 
£rviû_tcb
->
	`»q_ÿÎback
(£rviû_tcb->
cÚ‹xt
);

2576 
j³g_£rviû_queue
->
cu¼_cÚsum”
 = 
£rviû_tcb
;

2578 
£rviû_queue
->
İ
->
	`put_h—d”
(£rviû_queue, &
£rviû_tcb
->service_tcb);

2580 
	`¥š_uÆock_œq»¡Üe
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2582 
	}
}

2584 
	$j³g_£rviû_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
)

2586 if(
j³g_£rviû_queue
 !ğ
NULL
){

2587 
tcb_node_queue_t
 *
£rviû_queue
 = &
j³g_£rviû_queue
->service_queue;

2589 if(
j³g_£rviû_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

2590 if(
£rviû_queue
->
İ
 !ğ
NULL
){

2591 
tcb_node_t
 *
‹mp_node
;

2592 
£rviû_queue
->
İ
->
	`Œy_g‘
(£rviû_queue, &
‹mp_node
);

2593 if(
‹mp_node
 !ğ
NULL
){

2594 
j³g_£rviû_queue
->
cu¼_cÚsum”
 = 
	`to_g‘_j³g_£rviû_tcb_w™h_£rviû_tcb
(
‹mp_node
);

2599 
	}
}

2601 
	$j³g_£rviû_queue_»Ëa£_cu¼_cÚsum”
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
)

2603 if(
j³g_£rviû_queue
 !ğ
NULL
){

2604 
æags
;

2605 
	`¥š_lock_œq§ve
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2606 
j³g_£rviû_queue
->
cu¼_cÚsum”
 = 
NULL
;

2607 
	`¥š_uÆock_œq»¡Üe
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2609 
	}
}

2611 
	$j³g_Œigg”_³ndšg_£rviû_»que¡
(
j³g_£rviû_queue_t
 *
j³g_£rviû_queue
)

2613 if(
j³g_£rviû_queue
 !ğ
NULL
){

2614 
j³g_£rviû_tcb_t
 *
cu¼_cÚsum”
;

2615 
æags
;

2617 
	`¥š_lock_œq§ve
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2618 
j³g_£rviû_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_service_queue);

2619 
cu¼_cÚsum”
 = 
j³g_£rviû_queue
->curr_consumer;

2620 if(
cu¼_cÚsum”
 !ğ
NULL
){

2621 if(
cu¼_cÚsum”
->
»q_ÿÎback
) {

2622 
cu¼_cÚsum”
->
	`»q_ÿÎback
(cu¼_cÚsum”->
cÚ‹xt
);

2625 
	`¥š_uÆock_œq»¡Üe
(&
j³g_£rviû_queue
->
lock
, 
æags
);

2627 
	}
}

2629 
j³g_£rviû_queue_İ”©iÚ
 
	gj³g_£rviû_queue_İ
 = {

2630 .
š™
 = 
j³g_£rviû_queue_š™
,

2631 .
	gg‘_queue_cu¼_’Œy_numb”
 = 
j³g_£rviû_queue_g‘_queue_cu¼_’Œy_numb”
,

2632 .
	gput_£rviû_»que¡_što_queue
 = 
j³g_£rviû_queue_put_£rviû_»que¡_što_queue
,

2633 .
	gput_£rviû_»que¡_što_queue_h—d”
 = 
j³g_£rviû_queue_put_£rviû_»que¡_što_queue_h—d”
,

2634 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
j³g_£rviû_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

2635 .
	g»Ëa£_cu¼_cÚsum”
 = 
j³g_£rviû_queue_»Ëa£_cu¼_cÚsum”
,

2636 .
	gŒigg”_³ndšg_£rviû_»que¡
 = 
j³g_Œigg”_³ndšg_£rviû_»que¡
,

2639 
	$š™_j³g_£rviû_queue
(
j³g_£rviû_queue_t
 * 
j³g_£rviû_queue
)

2641 if(
j³g_£rviû_queue
 !ğ
NULL
){

2642 
j³g_£rviû_queue
->
İ
 = &
j³g_£rviû_queue_İ
;

2643 
j³g_£rviû_queue
->
İ
->
	`š™
(jpeg_service_queue);

2645 
	}
}

2647 
	$»move_j³g_£rviû_queue
(
j³g_£rviû_queue_t
 * 
j³g_£rviû_queue
)

2649 if(
j³g_£rviû_queue
 !ğ
NULL
){

2650 
j³g_£rviû_queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(jpeg_service_queue)){

2651 
j³g_£rviû_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_service_queue);

2652 if(
j³g_£rviû_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

2655 
j³g_£rviû_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(jpeg_service_queue);

2659 
	}
}

2661 
	$j³g_logic_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
(
œq
, *
cÚ‹xt
)

2663 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

2664 
tw_vb_äame_tcb_t
 *
äame
;

2665 
tw_vb_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

2666 
d´am_·ge_node_t
 *
d´am_·ge
;

2667 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

2668 
tw_vj_Üig_buf_šfo_t
 *
Üig_buf_šfo
;

2669 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

2670 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

2671 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
 = (tw_j³g_logic_’code_chª_ˆ*)
cÚ‹xt
;

2673 if(
j³g_logic_’code_chª
 !ğ
NULL
){

2674 
Üig_buf_šfo
 = 
j³g_logic_’code_chª
->
phy_video_¦Ù
->orig_buf_info;

2675 
ch_d´am_cÚŒŞËr
 = &
j³g_logic_’code_chª
->
ch
->chip_dpram_controller;

2676 
d´am_·ge
 = 
j³g_logic_’code_chª
->dpram_page;

2677 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

2678 
’code_cÚŒŞ
 = &
j³g_logic_’code_chª
->encode_control;

2680 
äame_queue
 = &
j³g_logic_’code_chª
->
j³g_äame_queue
;

2681 
äame
 = 
äame_queue
->
cu¼_´oduûr
;

2682 
’code_cÚŒŞ
->
	`move_j³g
(
j³g_logic_’code_chª
);

2683 if(
äame
->
äame_is_”r
) {

2684 
	`TW_DBG
(
TW_DBG_ERR
, "frame isƒrror, discard\n");

2685 
äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(äame_queue, &
j³g_logic_’code_chª
->
poŞ
);

2687 
’code_cÚŒŞ
->
lo¡_äame
++;

2689 
’code_cÚŒŞ
->
	`nÙify
(
j³g_logic_’code_chª
);

2690 
	`ch_ä“_œq
(
j³g_logic_’code_chª
->
ch
, 
IRQ_BURST_TYPE_INTR
, jpeg_logic_encode_chan);

2691 
ch_d´am_cÚŒŞËr
 = &
j³g_logic_’code_chª
->
ch
->chip_dpram_controller;

2692 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_mj³g_»q
(ch_d´am_cÚŒŞËr, 
j³g_logic_’code_chª
);

2693  
IRQ_HANDLED
;

2695 if(
	`©omic_»ad
(&
’code_cÚŒŞ
->
fœ¡_·ck‘
)){

2696 
	`©omic_£t
(&
’code_cÚŒŞ
->
fœ¡_·ck‘
, 0);

2698 
’code_cÚŒŞ
->
äame_ba£_addr
 =ƒncode_cÚŒŞ->
£ùiÚ_Ën
 -ƒncode_control->frame_base_addr;

2700 
’code_cÚŒŞ
->
äame_ba£_addr
 +ğ’code_cÚŒŞ->
£ùiÚ_Ën
;

2702 
’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
++;

2703 if(!(
’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
&0x1)){

2704 
·ck‘_queue
 = &
äame
->
vb_·ck‘_queue
;

2705 if(
·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

2706 
·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`dma_unm­
Õack‘_queue->cu¼_´oduûr, 
DMA_FROM_DEVICE
);

2708 
·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(packet_queue);

2710 
’code_cÚŒŞ
->
£ùiÚ_numb”
--;

2713 if(
’code_cÚŒŞ
->
£ùiÚ_numb”
 > 1){

2714 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(burst_interface,

2715 
d´am_·ge
, 
Üig_buf_šfo
->
ddr_phy_ba£
 + 
’code_cÚŒŞ
->
äame_ba£_addr
,

2716 
Üig_buf_šfo
->
·ge_id
, 
’code_cÚŒŞ
->
£ùiÚ_Ën
, 
DDR_CHIP_B
);

2717 } if(
’code_cÚŒŞ
->
£ùiÚ_numb”
 == 1) {

2718 
bur¡_š‹rçû
->
İ
->
	`¡¬t_nÚblock_Œªsãr_äom_ddr_to_¤am
(burst_interface,

2719 
d´am_·ge
, 
Üig_buf_šfo
->
ddr_phy_ba£
 + 
’code_cÚŒŞ
->
äame_ba£_addr
,

2720 
Üig_buf_šfo
->
·ge_id
, 
’code_cÚŒŞ
->
”_Ën
, 
DDR_CHIP_B
);

2722 if(
’code_cÚŒŞ
->
have_»cv_£ùiÚ_numb”
&0x1){

2723 
·ck‘_queue
 = &
äame
->
vb_·ck‘_queue
;

2724 if(
·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

2725 
·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`dma_unm­
Õack‘_queue->cu¼_´oduûr, 
DMA_FROM_DEVICE
);

2727 
·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(packet_queue);

2730 if(
’code_cÚŒŞ
->
£ùiÚ_numb”
 <= 0){

2731 if(
äame
->
äame_is_”r
 == 0){

2732 
äame_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(frame_queue);

2733 if(!(
äame
->
äame_æags
 & (
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_USER
 | 
TW_MJPEG_ENCODE_PARAM_CAPTURE_TYPE_TIMER
))) {

2734 
	`TW_DBG
(
TW_DBG_INFO
, "invalid frame flags, discard\n");

2735 
äame_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(frame_queue);

2736 
äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(äame_queue, &
j³g_logic_’code_chª
->
poŞ
);

2739 
äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
(äame_queue, &
j³g_logic_’code_chª
->
poŞ
);

2740 
	`´štk
("%s,%d: j³g disÿrd\n", 
__FUNCTION__
, 
__LINE__
);

2743 
’code_cÚŒŞ
->
	`nÙify
(
j³g_logic_’code_chª
);

2744 
	`ch_ä“_œq
(
j³g_logic_’code_chª
->
ch
, 
IRQ_BURST_TYPE_INTR
, jpeg_logic_encode_chan);

2745 
ch_d´am_cÚŒŞËr
 = &
j³g_logic_’code_chª
->
ch
->chip_dpram_controller;

2746 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_»ad_mj³g_»q
(ch_d´am_cÚŒŞËr, 
j³g_logic_’code_chª
);

2750  
IRQ_HANDLED
;

2751 
	}
}

2753 
	$j³g_logic_chª_¡¬t_»ad_b™¡»am
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

2755 
»t
=1;

2756 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

2757 
tw_j³g_logic_’code_chª_t
 *
logic_’code_chª
;

2760 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

2761 
logic_’code_chª
 = (
tw_j³g_logic_’code_chª_t
*)
cÚ‹xt
;

2763 
	`ch_»que¡_œq
(
logic_’code_chª
->
ch
, 
IRQ_BURST_TYPE_INTR
, 
j³g_logic_chª_»¥Ú£_ddr_bur¡_dÚe_i¤
, "BURST",†ogic_encode_chan);

2765 
’code_cÚŒŞ
 = &
logic_’code_chª
->encode_control;

2766 
»t
 = 
’code_cÚŒŞ
->
	`»ad_·¿m
(
logic_’code_chª
);

2768 
	`TW_DBG
(
TW_DBG_ERR
, "null…ointer\n");

2771  
»t
;

2772 
	}
}

2775 
	$š™_subm™_»cv_j³g_dÚe_£rviû
(
d´am_»que¡_t
 *
d´am_»q
, 
tw_j³g_logic_’code_chª_t
 *
j³g_logic_’code_chª
)

2777 if((
d´am_»q
!=
NULL
è|| (
j³g_logic_’code_chª
!=NULL)){

2778 
d´am_»q
->
ty³
 = 
DPRAM_NONBLOCK_TRANSFER_REQUEST
;

2779 
d´am_»q
->
cÚ‹xt
 = (*)
j³g_logic_’code_chª
;

2780 
d´am_»q
->
»q_ÿÎback
 = 
j³g_logic_chª_¡¬t_»ad_b™¡»am
;

2782 
	}
}

2784 
	$tw5864_vj_œq
(
œq
, *
cÚ‹x
)

2786 
tw5864_mj³g_·th_t
 *
mj³g_·th
;

2787 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

2788 
tw_j³g_logic_’code_chª_t
 *
logic_j³g_chn
;

2789 
tw_j³g_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

2790 
u32
 
isv®id
 = 0;

2792 
mj³g_·th
 = (
tw5864_mj³g_·th_t
 *)
cÚ‹x
;

2793 if(!
mj³g_·th
){

2794 
	`´štk
("%s,%d:‚uÎ\n", 
__FUNCTION__
, 
__LINE__
);

2795  
TW_ERR
;

2798 if(
mj³g_·th
->
cu¼’t_cÚsum”_±r
 !ğmj³g_·th->
cu¼’t_’codšg_±r
) {

2799 
buf_šfo
 = 
mj³g_·th
->
vj_bus
->
vj_Üig_buf
 + mj³g_·th->
cu¼’t_cÚsum”_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

2800 if(
buf_šfo
->
İ
->
	`com¶©e
(buf_info)) {

2801 
ed_tcb_t
 *
İ’ed_logic_chª_ed
;

2802 
logic_j³g_chn
 = 
mj³g_·th
->
logic_’codšg_bË
[mj³g_·th->
cu¼’t_cÚsum”_±r
];

2803 
’code_cÚŒŞ
 = &
logic_j³g_chn
->encode_control;

2804 
İ’ed_logic_chª_ed
 = &
logic_j³g_chn
->opened_logic_chan_ed;

2805 
logic_j³g_chn
->
phy_video_¦Ù
->
Üig_buf_šfo
 = 
buf_šfo
;

2807 
buf_šfo
->
İ
->
	`m¬k_u§bË
(buf_info);

2808 if(
buf_šfo
->
İ
->
	`g‘_chn_id
(buf_šfoè!ğ
logic_j³g_chn
->
phy_video_¦Ù
->
phy_¦Ù_id
) {

2809 
	`TW_DBG
(
TW_DBG_ERR
, "BUG:chªÃÈ(%d, %dèwa chªged\n", 
buf_šfo
->
İ
->
	`g‘_chn_id
(buf_šfo), 
logic_j³g_chn
->
phy_video_¦Ù
->
phy_¦Ù_id
);

2811 if(
’code_cÚŒŞ
->
timeout_id
 !ğ
INVALIDTIMERID
) {

2812 
	`D–‘eSšgËFœeTim”Job
(
’code_cÚŒŞ
->
timeout_id
);

2813 
’code_cÚŒŞ
->
timeout_id
 = 
INVALIDTIMERID
;

2815 
	`driv”_g’_d–iv”_ev’t
(&
logic_j³g_chn
->
İ’ed_logic_chª_ed
, 1);

2817 
mj³g_·th
->
cu¼’t_cÚsum”_±r
++;

2818 if(
mj³g_·th
->
cu¼’t_cÚsum”_±r
 >ğ
VIDEO_JPEG_PATH_BUF
) {

2819 
mj³g_·th
->
cu¼’t_cÚsum”_±r
 = 0;

2821 
isv®id
 = 1;

2823 
	`TW_DBG
(
TW_DBG_ERR
, "·th %d buà%d i nÙ com¶©e\n", 
buf_šfo
->
·th_id
, buf_šfo->
buf_id
);

2827 
	`TW_DBG
(
TW_DBG_ERR
, "producer == consumer\n");

2829 
mj³g_·th
->
vj_bus
->
i_‹mp_ås_couÁ”
++;

2830 if(!
isv®id
) {

2831 
j³g_”r
;

2834 
	`©omic_£t
(&
mj³g_·th
->
vj_bus
->
busy
, 0);

2835  
IRQ_HANDLED
;

2836 
j³g_”r
:

2837 
buf_šfo
 = 
mj³g_·th
->
vj_bus
->
vj_Üig_buf
;

2838 
	`TW_DBG
(
TW_DBG_FATAL
, "bad status 0x%08x,ƒncode %d, consumer %d\n",

2839 
buf_šfo
->
ch
->
io_İ
->
	`ch_»ad32
(buf_šfo->ch, 
JPEG_IRQ
), 
mj³g_·th
->
cu¼’t_’codšg_±r
,

2840 
mj³g_·th
->
cu¼’t_cÚsum”_±r
);

2842 
mj³g_·th
->
vj_bus
->
İ
->
	`»£t
(mjpeg_path->vj_bus);

2844  
TW_ERR
;

2845 
	}
}

2847 
	$vj_bus_¡¬t_mÚ™Ü_sk
(*
cÚ‹xt
)

2849 
j³g_£rviû_queue_t
 *
£rviû_queue
;

2850 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

2851 
tw5864_mj³g_·th_t
 *
mj³g_·th
;

2852 
tw5864_vj_bus_t
 *
vj_bus
 = (tw5864_vj_bus_ˆ*)
cÚ‹xt
;

2853 
u32
 
Üig_buf_id
 = 0;

2854 
æags
;

2856 if(!
vj_bus
)

2858  -
EINVAL
;

2860 
	`¥š_lock_œq§ve
(&
vj_bus
->
lock
, 
æags
);

2861 
vj_bus
->
i_¡©ic_£cÚd_couÁ”
++;

2862 if(
vj_bus
->
i_¡©ic_£cÚd_couÁ”
 >ğ
TIMER_1_SECOND
) {

2863 
vj_bus
->
cu¼’t_ås
 = vj_bus->
i_‹mp_ås_couÁ”
;

2864 
vj_bus
->
i_‹mp_ås_couÁ”
 = 0;

2865 
vj_bus
->
i_¡©ic_£cÚd_couÁ”
 = 0;

2868 if(
vj_bus
->
·th_sw™ch
) {

2869 
mj³g_·th
 = &
vj_bus
->mjpeg_path[1];

2871 
mj³g_·th
 = &
vj_bus
->mjpeg_path[0];

2873 
vj_bus
->
·th_sw™ch
 = !vj_bus->path_switch;

2875 
£rviû_queue
 = &
vj_bus
->
j³g_£rviû_queue
;

2876 
Üig_buf_id
 = 
mj³g_·th
->
cu¼’t_äame_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

2877 if(
mj³g_·th
->
cu¼’t_äame_±r
 == 0) {

2878 
Üig_buf_id
 = 
mj³g_·th
->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
 + VIDEO_JPEG_PATH_BUF - 1;

2880 
Üig_buf_id
 -= 1;

2882 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
Üig_buf_id
;

2884 if((
buf_šfo
->
İ
->
	`äame_v®id
(buf_šfoè|| (
mj³g_·th
->
cu¼’t_’codšg_±r
 =ğmj³g_·th->
cu¼’t_äame_±r
))

2885 &&(
mj³g_·th
->
İ
->
	`is_busy
(mjpeg_path) == 0)) {

2886 if(
buf_šfo
->
İ
->
	`äame_v®id
(buf_info)) {

2888 if(
mj³g_·th
->
time_id
 !ğ
INVALIDTIMERID
) {

2889 
	`D–‘eSšgËFœeTim”Job
(
mj³g_·th
->
time_id
);

2890 
mj³g_·th
->
time_id
 = 
INVALIDTIMERID
;

2893 
mj³g_·th
->
İ
->
	`v®id_nÙify
(mjpeg_path);

2897 if((
mj³g_·th
->
cu¼’t_’codšg_±r
 !ğmj³g_·th->
cu¼’t_äame_±r
)){

2898 
Üig_buf_id
 = 
mj³g_·th
->
cu¼’t_’codšg_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

2899 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
Üig_buf_id
;

2900 if(
buf_šfo
->
İ
->
	`äame_v®id
(buf_šfoè&& (
	`©omic_»ad
(&
vj_bus
->
busy
) == 0)) {

2902 
mj³g_·th
->
İ
->
	`¡¬t_’codšg
(mjpeg_path);

2906 
	`¥š_uÆock_œq»¡Üe
(&
vj_bus
->
lock
, 
æags
);

2909 
	}
}

2911 
	$vj_bus_¡İ_mÚ™Ü_sk
(*
cÚ‹xt
)

2913 
tw5864_vj_bus_t
 *
vj_bus
 = (tw5864_vj_bus_ˆ*)
cÚ‹xt
;

2915 if(!
vj_bus
)

2917  -
EINVAL
;

2920 
	`D–‘eFÜFœeTim”Job
(
vj_bus
->
time_id
);

2921 
vj_bus
->
time_id
 = 
INVALIDTIMERID
;

2924 
	}
}

2926 
	$tw_5864_vj_bus_»£t
(
tw5864_vj_bus_t
 *
vj_bus
)

2928 
dvm_ch_t
 *
ch
;

2929 
tw5864_mj³g_·th_t
 *
·th
;

2930 
æags
;

2931 
i
;

2932 
tw_vj_Üig_buf_šfo_t
 *
Üig_šfo
;

2934 if(!
vj_bus
){

2938 
	`TW_DBG
(
TW_DBG_INFO
, "reset vj bus\n");

2939 
ch
 = 
	`to_g‘_ch_w™h_ch_vj_bus
(
vj_bus
);

2941 
vj_bus
->
İ
->
	`¡İ_mÚ™Ü_sk
(vj_bus);

2943 
	`¥š_lock_œq§ve
(&
vj_bus
->
lock
, 
æags
);

2944 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_MODULE_REST
, 0xe0000001);

2945 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_MODULE_REST
, 0xe0000000);

2947 
i
 = 0; i < 
VIDEO_JPEG_PATH_CNT
; i++) {

2948 
·th
 = &
vj_bus
->
mj³g_·th
[
i
];

2950 if(
·th
->
d–ay_time_id
 !ğ
INVALIDTIMERID
) {

2951 
	`D–‘eSšgËFœeTim”Job
(
·th
->
d–ay_time_id
);

2952 
·th
->
d–ay_time_id
 = 
INVALIDTIMERID
;

2955 if(
·th
->
time_id
 !ğ
INVALIDTIMERID
) {

2956 
	`D–‘eSšgËFœeTim”Job
(
·th
->
time_id
);

2957 
·th
->
time_id
 = 
INVALIDTIMERID
;

2960 
Üig_šfo
 = &
vj_bus
->
vj_Üig_buf
[
i
 * 
VIDEO_JPEG_PATH_BUF
];

2961 if(
Üig_šfo
->
İ
) {

2962 
·th
->
cu¼’t_cÚsum”_±r
 = 
Üig_šfo
->
İ
->
	`Ãw_äame_±r
(orig_info);

2963 
·th
->
cu¼’t_’codšg_±r
 = 
Üig_šfo
->
İ
->
	`Ãw_äame_±r
(orig_info);

2964 
·th
->
cu¼’t_äame_±r
 = 
Üig_šfo
->
İ
->
	`Ãw_äame_±r
(orig_info);

2966 
·th
->
cu¼’t_cÚsum”_±r
 = 0;

2967 
·th
->
cu¼’t_’codšg_±r
 = 0;

2968 
·th
->
cu¼’t_äame_±r
 = 0;

2971 
	`©omic_£t
(&
vj_bus
->
busy
, 0);

2972 
	`¥š_uÆock_œq»¡Üe
(&
vj_bus
->
lock
, 
æags
);

2973 
vj_bus
->
time_id
 = 
	`AddFÜFœeTim”Job
(1, vj_bus->
İ
->
¡¬t_mÚ™Ü_sk
, vj_bus);

2974 if(
vj_bus
->
time_id
 =ğ
ADDJOBERROR
)

2976 
	`TW_DBG
(
TW_DBG_ERR
, "addimer hookƒrr\n");

2981 
	}
}

2983 
tw5864_vj_bus_İ”©iÚ
 
	gtw5864_vj_bus_İ
 = {

2984 .
š™
 = 
tw5864_vj_bus_š™
,

2985 .
	g»Ëa£
 = 
tw5864_vj_bus_»Ëa£
,

2986 .
	gœq
 = 
tw5864_vj_œq
,

2987 .
	g¡¬t_mÚ™Ü_sk
 = 
vj_bus_¡¬t_mÚ™Ü_sk
,

2988 .
	g¡İ_mÚ™Ü_sk
 = 
vj_bus_¡İ_mÚ™Ü_sk
,

2989 .
	g»£t
 = 
tw_5864_vj_bus_»£t
,

2992 
size_t
 
	$tw_j³g_äame_subm™
(
tw_vb_äame_tcb_t
 *
äame
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
ma¡”OrSubFÏg
, 
tw_vb_poŞ_t
 *
poŞ
)

2994 
tw_äame_h—d”_t
 
__u£r
 *
äame_h—d”_±r
;

2995 
tw_äame_h—d”_t
 
tw_äame_h—d
;

2996 
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
;

2997 
size_t
 
buf_size
, 
·ck‘_size
;

2998 
loff_t
 
buf_off£t
, 
·ck‘_off£t
;

2999 
š£¹_03_¡©e_machše_t
 
¡©e_machše
;

3001 
buf_size
 = 
couÁ
;

3002 
buf_off£t
 = 0;

3003 
	`mem£t
(&
¡©e_machše
, 0, (
š£¹_03_¡©e_machše_t
));

3004 if(
äame
 !ğ
NULL
){

3005 
äame_h—d”_±r
 = (
tw_äame_h—d”_t
*)
d©a
;

3006 
buf_size
 -ğ(
tw_äame_h—d”_t
);

3007 
buf_off£t
 +ğ(
tw_äame_h—d”_t
);

3008 
	`mem£t
(&
tw_äame_h—d
, 0, (
tw_äame_h—d”_t
));

3009 
tw_äame_h—d
.
codecTy³
 = 
TW_VIDEO_MJPEG_CODEC_TYPE
;

3010 
tw_äame_h—d
.
¡»amTy³
 = 
äame
->
äame_æags
;

3011 
tw_äame_h—d
.
äameS”Ÿl
 = 
äame
->
äame_numb”
;

3012 
tw_äame_h—d
.
äameTy³
 = 
äame
->
äame_ty³
;

3013 
tw_äame_h—d
.
timeSmp
 = 
äame
->
time¡amp
;

3014 
tw_äame_h—d
.
·ylßd_off£t
 = (
tw_äame_h—d”_t
);

3015 
tw_äame_h—d
.
·ylßdL’
 = 0;

3017 
vb_·ck‘_queue
 = &
äame
->vb_packet_queue;

3018 
vb_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vb_packet_queue))

3020 
vb_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(vb_packet_queue);

3021 
·ck‘_size
 = 
vb_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`subm™
(vb_·ck‘_queue->cu¼_cÚsum”, &
d©a
[
buf_off£t
], 
buf_size
, &
·ck‘_off£t
, &
¡©e_machše
);

3023 
vb_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vb_·ck‘_queue, 
poŞ
);

3024 
buf_size
 -ğ
·ck‘_size
;

3025 
buf_off£t
 +ğ
·ck‘_size
;

3026 
tw_äame_h—d
.
·ylßdL’
 +ğ
·ck‘_size
;

3028 
buf_off£t
 & 3){

3029 
	`__put_u£r
(0, &
d©a
[
buf_off£t
]);

3030 
buf_size
--;

3031 
buf_off£t
++;

3032 
tw_äame_h—d
.
·ylßdL’
++;

3034 
	`cİy_to_u£r
(
äame_h—d”_±r
, &
tw_äame_h—d
, (
tw_äame_h—d”_t
));

3036 *
µos
 +ğ
buf_off£t
;

3038  (
size_t
)
buf_off£t
;

3039 
	}
}

3041 
	$j³g_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

3042 
couÁ
, *
eof
, *
d©a
)

3044 
Ën
 = 0, 
i
 = 0, 
j
 = 0;

3045 
tw_mj³g_’code_·¿m_t
 *
j³g_cÚfig
;

3046 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

3047 
tw_vb_poŞ_t
 *
poŞ
;

3048 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

3049 
tw5864_mj³g_·th_t
 *
mj³g_·th
;

3050 
tw5864_vj_bus_t
 *
vj_bus
;

3051 
u32
 
Üig_buf_id
 = 0;

3052 
tw_j³g_logic_’code_chª_t
 *
ba£
, *
j³g
;

3054 
ba£
 = 
j³g
 = (
tw_j³g_logic_’code_chª_t
 *)
d©a
;

3055 
vj_bus
 = &
j³g
->
ch
->
ch_vj_bus
;

3056 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s\n", "ID", "frame", "encoding", "consumer", "valid");

3057 
i
 = 0; i < 
VIDEO_JPEG_PATH_CNT
; i++) {

3058 
mj³g_·th
 = &
vj_bus
->mj³g_·th[
i
];

3059 
Üig_buf_id
 = 
mj³g_·th
->
cu¼’t_’codšg_±r
 + mj³g_·th->
·th_id
 * 
VIDEO_JPEG_PATH_BUF
;

3060 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
Üig_buf_id
;

3061 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d %8d %8d %8d %8d\n",

3062 
mj³g_·th
->
·th_id
, mj³g_·th->
cu¼’t_äame_±r
,

3063 
mj³g_·th
->
cu¼’t_’codšg_±r
, mj³g_·th->
cu¼’t_cÚsum”_±r
,

3064 
buf_šfo
->
İ
->
	`äame_v®id
(buf_info));

3065 
j
 = 0; j < 
VIDEO_JPEG_PATH_BUF
; j++) {

3066 
tw_j³g_logic_’code_chª_t
 *
logic_chÆ
 = 
mj³g_·th
->
logic_’codšg_bË
[
j
];

3067 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8x ", 
logic_chÆ
?logic_chÆ->
logic_chª_id
:0xff);

3069 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "\n");

3071 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "cu¼’ˆ’codšg fps: %8d\n", 
vj_bus
->
cu¼’t_ås
);

3072 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "orig buffer validime:\n");

3073 
i
 = 0; i < 
VIDEO_JPEG_PATH_CNT
 * 
VIDEO_JPEG_PATH_BUF
; i++) {

3074 
buf_šfo
 = 
vj_bus
->
vj_Üig_buf
 + 
i
;

3075 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d", 
buf_šfo
->
v®id_time
);

3077 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "\n£rviûƒÁry‚umb” %d\n", 
vj_bus
->
j³g_£rviû_queue
.
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(&vj_bus->jpeg_service_queue));

3078 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s %8s", "ch", "phy", "logic", "size", "width", "height", "Level", "interval\n");

3079 
j³g
 = 
ba£
; (j³g - ba£è< 
TW5864_PHY_VJ_CHAN_NUMBER
; jpeg++)

3081 
j³g_cÚfig
 = &
j³g
->
’code_´İ”ty
.encode_property;

3082 if(!
	`©omic_»ad
(&
j³g
->
İ’ed_æag
))

3087 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%8d %8d %8d %8d %8d %8d %8d %8d\n",
j³g
->
phy_¦Ù_id
,

3088 
j³g
->
phy_¦Ù_id
,

3089 
j³g
->
logic_chª_id
,

3090 
j³g
->
’code_cÚŒŞ
.
cu¼_size
,

3091 
j³g_cÚfig
->
i_image_width_mb_size
,

3092 
j³g_cÚfig
->
i_image_height_mb_size
,

3093 
j³g_cÚfig
->
e_image_Ëv–
,

3094 
j³g_cÚfig
->
i_ÿ±u»_äame_¡ride
);

3097 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "encoder status:\n");

3098 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8s %8s %8s %8s %8s %8s %8s %8s", "valid", "BlkCnt", "FrmCnt", "Seq", "int(ms)", "lost", "state", "flags\n");

3099 
j³g
 = 
ba£
; (j³g - ba£è< 
TW5864_PHY_VJ_CHAN_NUMBER
; jpeg++) {

3100 if(!
	`©omic_»ad
(&
j³g
->
İ’ed_æag
))

3105 if(
j³g
->
phy_video_¦Ù
) {

3106 
äame_queue
 = &
j³g
->
j³g_äame_queue
;

3107 
poŞ
 = &
j³g
->pool;

3108 
buf_šfo
 = 
j³g
->
phy_video_¦Ù
->
Üig_buf_šfo
;

3109 
Ën
 +ğ
	`¥rštf
(
·ge
 +†en, "%8d %8d %8d %8d %8d %8d %8d %08x\n",

3110 
j³g
->
phy_video_¦Ù
->
Üig_buf_šfo
 ? 
buf_šfo
->
İ
->
	`äame_v®id
(buf_info):0,

3111 
poŞ
->
İ
->
	`g‘_·ck‘_tcb_poŞ_’Œy_numb”
(pool),

3112 
äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(frame_queue),

3113 
j³g
->
i_äame_£rŸl
,

3114 
j³g
->
’code_cÚŒŞ
.
äame_š‹rv®
,

3115 
j³g
->
’code_cÚŒŞ
.
lo¡_äame
,

3116 
	`©omic_»ad
(&
j³g
->
İ’ed_logic_chª_ed
.
¡©e
),

3117 
j³g
->
’code_cÚŒŞ
.
ÿ±u»_æags
);

3121  
Ën
;

3122 
	}
}

3124 
tw5864_»ad_j³g_yuv
(
dvm_ch_t
 *
ch
, 
·ge
, 
fÜm©
, *
buf
, 
isB
);

3125 
tw5864_wr™e_j³g_yuv
(
dvm_ch_t
 *
ch
, 
·ge
, 
fÜm©
, *
buf
, 
isB
);

3126 
	$j³g_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

3127 
couÁ
, *
d©a
)

3129 
dvm_ch_t
 *
ch
;

3130 
tw_j³g_logic_’code_chª_t
 *
j³g
 = (tw_j³g_logic_’code_chª_ˆ*)
d©a
;

3131 
cmdbuf
[1024];

3132 **
¬gv
;

3133 
¬gc
, 
i
;

3135 
ch
 = 
j³g
->chip;

3136 if(
couÁ
 > 1024){

3137 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 1024);

3140 
	`cİy_äom_u£r
(
cmdbuf
, 
bufãr
, 
couÁ
);

3142 
¬gv
 = 
	`¬gv_¥l™
(
GFP_KERNEL
, 
cmdbuf
, &
¬gc
);

3143 
i
 = 0; i < (
¬gc
 - 1); i++)

3145 
	`TW_DBG
(
TW_DBG_INFO
, "cmd %d: %s\n", 
i
, 
¬gv
[i]);

3147 if(!
j³g
){

3148 
wr™e_»Ëa£
;

3151 if((
¬gv
[0] !ğ
NULL
è&& (
¬gc
 >ğ4è&& (
	`¡rcmp
(argv[0], "cap") == 0))

3153 
j³g
 +ğ
	`©oi
(
¬gv
[2]);

3154 
	`tw_j³g_§ve_chn
(
j³g
, 
¬gv
[1], 
	`©oi
(argv[3]));

3156 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "close") == 0)) {

3157 
tw_j³g_logic_’code_chª_t
 *
ba£
;

3159 
ba£
 = 
j³g
; (ba£ - j³gè< 
TW5864_PHY_VD_CHAN_NUMBER
; base++) {

3160 if(
	`©omic_»ad
(&
ba£
->
İ’ed_æag
) == 0) {

3163 
	`´štk
("şo£ j³g %d\n", 
ba£
->
logic_chª_id
);

3164 
ba£
->
İ’ed_logic_chª_ed
.
İ
->
	`şo£
(&base->opened_logic_chan_ed);

3167 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "read") == 0)) {

3168 
fe
 *
yuv_fe
;

3169 
mm_£gm’t_t
 
fs
;

3170 *
buff
;

3171 
size
;

3173 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 0x5f);

3174 
size
 = 0x97e00;

3175 
buff
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

3176 
	`mem£t
(
buff
, 0, 
size
);

3177 
yuv_fe
 = 
	`tw_k”Ãl_fe_İ’
(
¬gv
[2]);

3178 
fs
=
	`g‘_fs
();

3179 
	`£t_fs
(
KERNEL_DS
);

3180 
	`tw5864_»ad_j³g_yuv
(
ch
, 
	`©oi
(
¬gv
[1]), 0, 
buff
, 1);

3181 
yuv_fe
->
f_İ
->
	`wr™e
(yuv_fe, 
buff
, 
size
, &(yuv_fe->
f_pos
));

3182 
	`£t_fs
(
fs
);

3183 
	`tw_k”Ãl_fe_şo£
(
yuv_fe
);

3184 
	`ä“_·ges
((
u32
 )
buff
, 
	`g‘_Üd”
(
size
));

3187 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
(argv[0], "write") == 0)) {

3188 
fe
 *
yuv_fe
;

3189 
mm_£gm’t_t
 
fs
;

3190 *
buff
;

3191 
size
;

3193 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 0x5f);

3194 
size
 = 0x97e00;

3195 
buff
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

3196 
	`mem£t
(
buff
, 0, 
size
);

3197 
yuv_fe
 = 
	`tw_k”Ãl_fe_İ’
(
¬gv
[2]);

3198 
fs
=
	`g‘_fs
();

3199 
	`£t_fs
(
KERNEL_DS
);

3200 
yuv_fe
->
f_İ
->
	`»ad
(yuv_fe, 
buff
, 
size
, &(yuv_fe->
f_pos
));

3201 
	`tw5864_wr™e_j³g_yuv
(
ch
, 
	`©oi
(
¬gv
[1]), 0, 
buff
, 1);

3202 
	`£t_fs
(
fs
);

3203 
	`tw_k”Ãl_fe_şo£
(
yuv_fe
);

3204 
	`ä“_·ges
((
u32
 )
buff
, 
	`g‘_Üd”
(
size
));

3206 if((
¬gv
[0] !ğ
NULL
è&& (
	`¡rcmp
×rgv[0], "dump"è=ğ0è&& (
¬gc
 > 3)) {

3207 
fe
 *
j³g_fe
;

3208 
mm_£gm’t_t
 
fs
;

3209 *
buff
;

3210 
u32
 
h—d”_Ën
;

3211 
size
;

3212 
tw_vj_Üig_buf_šfo_t
 *
buf_šfo
;

3214 if(
	`©oi
(
¬gv
[1]) > 7) {

3215 
buf_šfo
 = 
ch
->
ch_vj_bus
.
vj_Üig_buf
;

3217 
buf_šfo
 = 
ch
->
ch_vj_bus
.
vj_Üig_buf
 + 
	`©oi
(
¬gv
[1]);

3220 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
MODE
, 0x5f);

3221 
size
 = 0x97e00;

3222 
buff
 = (*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, 
	`g‘_Üd”
(
size
));

3223 
	`mem£t
(
buff
, 0, 
size
);

3224 
j³g_fe
 = 
	`tw_k”Ãl_fe_İ’
(
¬gv
[2]);

3225 
fs
=
	`g‘_fs
();

3226 
	`£t_fs
(
KERNEL_DS
);

3227 
h—d”_Ën
 = 
	`tw5864_jifi_h—d”
(
buff
, 
j³g
);

3228 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
buf_šfo
->
·ge_id
 | (1 << 14));

3229 
	`memıy
(
buff
 + 
h—d”_Ën
, 
ch
->
»gs
 + 0xa2000, 
buf_šfo
->
İ
->
	`g‘_Ëngth
(buf_info));

3230 
j³g_fe
->
f_İ
->
	`wr™e
(j³g_fe, 
buff
, 
h—d”_Ën
 + 
buf_šfo
->
İ
->
	`g‘_Ëngth
(buf_šfo), &(j³g_fe->
f_pos
));

3231 
	`£t_fs
(
fs
);

3232 
	`tw_k”Ãl_fe_şo£
(
j³g_fe
);

3233 
	`ä“_·ges
((
u32
 )
buff
, 
	`g‘_Üd”
(
size
));

3236 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
VIDEO_JPEG_CMD_PATH0
, 0x1);

3237 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
JPEG_CAP_PATH0_ENABLE
, 0x1);

3240 
wr™e_»Ëa£
:

3241 
	`¬gv_ä“
(
¬gv
);

3243  
couÁ
;

3244 
	}
}

3246 
	$š™_tw5864_j³g_’code_chª
(
tw_j³g_logic_’code_chª_t
 *
j³g_logic
, 
bus_id
, 
ch_id
, 
phy_¦Ù_id
, 
dvm_ch_t
 *
ch
)

3248 
tw5864_vj_bus_t
 *
ch_vj_bus
;

3250 if(
j³g_logic
 && 
ch
 && (
phy_¦Ù_id
 < 
TW5864_PHY_VJ_CHAN_NUMBER
))

3252 
ed_tcb_t
 *
ed
;

3253 
tw_´oc_»gi¡”_s
 *
j³g_´oc
;

3255 
ch_vj_bus
 = &
ch
->chip_vj_bus;

3256 
j³g_logic
->
phy_¦Ù_id
 =…hy_slot_id;

3257 
j³g_logic
->
logic_chª_id
 = 
phy_¦Ù_id
;

3258 
j³g_logic
->
ch
 = chip;

3260 
ed
 = &
j³g_logic
->
İ’ed_logic_chª_ed
;

3262 
j³g_logic
->
phy_video_¦Ù
 = &
ch_vj_bus
->phy_video_¦Ù[
phy_¦Ù_id
];

3264 
	`š™_j³g_’code_´İ”ty
(&
j³g_logic
->
’code_´İ”ty
, &
deçuÉ_j³g_’code_´İ”ty
);

3265 
	`š™_j³g_’code_cÚŒŞ
(&
j³g_logic
->
’code_cÚŒŞ
);

3267 
	`š™_j³g_£rviû_tcb_w™h_nuÎ
(&
j³g_logic
->
’code_»que¡_tcb
);

3269 
	`š™_’dpošt_tcb
(&
j³g_logic
->
logic_chª_ed
, 
bus_id
, 
ch_id
,

3270 
TW_ED_VIDEO_ENCODE_IN
, 
j³g_logic
->
phy_¦Ù_id
,

3271 
j³g_logic
->
logic_chª_id
, j³g_logic, 
j³g_logic_’code_chª_driv”_nÙify
,

3272 
j³g_logic_’code_chª_driv”_m©ch_id
, 
NULL
);

3273 
	`š™_’dpošt_tcb
(&
j³g_logic
->
İ’ed_logic_chª_ed
, 
bus_id
, 
ch_id
,

3274 
TW_ED_VIDEO_ENCODE_IN
, 
j³g_logic
->
phy_¦Ù_id
,

3275 
j³g_logic
->
logic_chª_id
, j³g_logic, 
j³g_logic_’code_chª_driv”_nÙify
,

3276 
j³g_logic_’code_chª_driv”_m©ch_id
, &
j³g_’code_driv”_fsm_¡©e_Œªsãr_m©rix_bË
);

3278 
	`tw_ü—‹_poŞ
(&
j³g_logic
->
poŞ
, 
tw_j³g_äame_subm™
, 
VIDEO_JPEG_BUF_POOL_LEN
);

3279 
	`tw_ü—‹_äame_tcb_queue
(&
j³g_logic
->
j³g_äame_queue
);

3280 
	`»gi¡”_logic_’code_chª_što_phy_¦Ù
(
j³g_logic
, j³g_logic->
phy_video_¦Ù
);

3282 
ed
->
İ
 = &
j³g_’code_hcd_š‹rçû_İ
;

3283 
j³g_´oc
 = &
ch
->jpeg_proc;

3284 if(!
j³g_´oc
->
’Œy
) {

3285 
	`¡rıy
(
j³g_´oc
->
Çme
, "jpeg");

3286 
j³g_´oc
->
»ad
 = 
j³g_´oc_»ad
;

3287 
j³g_´oc
->
wr™e
 = 
j³g_´oc_wr™e
;

3288 
j³g_´oc
->
´iv©e
 = 
ch
->
j³g_’code_chª
;

3289 
	`tw_moduË_»gi¡”
(
ch
, 
j³g_´oc
);

3295  -
EINVAL
;

3296 
	}
}

3298 
	$š™_tw5864_vj_bus
(
tw5864_vj_bus_t
 *
vj_bus
)

3300 if(
vj_bus
 !ğ
NULL
){

3301 
vj_bus
->
İ
 = &
tw5864_vj_bus_İ
;

3302 
vj_bus
->
İ
->
	`š™
(vj_bus);

3304  
TW_OK
;

3307  
TW_ERR
;

3308 
	}
}

3310 
	$»move_tw5864_vj_bus
(
tw5864_vj_bus_t
 *
vj_bus
)

3312 if(
vj_bus
 !ğ
NULL
){

3313 
vj_bus
->
İ
->
	`»Ëa£
(vj_bus);

3317 
	}
}

3318 
	$»move_tw5864_j³g_’code_chª
(
tw_j³g_logic_’code_chª_t
 *
logic_chª
)

3320 
dvm_ch_t
 *
ch
;

3322 if(
logic_chª
){

3323 
ed_tcb_t
 *
ed
;

3324 
ed
 = &
logic_chª
->
İ’ed_logic_chª_ed
;

3325 
ch
 = 
logic_chª
->chip;

3326 if(
logic_chª
->
’code_cÚŒŞ
.
tim”_id
 !ğ
INVALIDTIMERID
) {

3327 
	`D–‘eSšgËFœeTim”Job
(
logic_chª
->
’code_cÚŒŞ
.
tim”_id
);

3329 if(
ed
->
İ
 !ğ
NULL
){

3330 
ed
->
İ
->
	`şo£
(&
logic_chª
->
İ’ed_logic_chª_ed
);

3332 
	`tw_de¡roy_poŞ
(&
logic_chª
->
poŞ
);

3333 
	`uÄegi¡”_logic_’code_chª_što_phy_¦Ù
(
logic_chª
,†ogic_chª->
phy_video_¦Ù
);

3334 
	`tw_moduË_uÄegi¡”
(
ch
, &ch->
j³g_´oc
);

3336 
	}
}

3339 
	$vj_pŞlšg_sk
(
dvm_ch_t
 *
ch
)

3341 
u32
 
¡©us
 = 0;

3342 
com¶©e
;

3344 
com¶©e
 = 
JPEG_IRQ
;

3345 
¡©us
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
com¶©e
);

3346 if(
¡©us
)

3348 
	`´štk
("any channelƒncode complate!\n");

3351 
	}
}

3353 
	$tw_j³g_§ve_chn
(
tw_j³g_logic_’code_chª_t
 *
logic_chÆ
, *
·th
, 
út
)

3355 
fe
 *
j³g_fe
 = 
NULL
;

3356 
tw_vb_äame_tcb_t
 *
äame
;

3357 
tw_vb_äame_tcb_queue_t
 *
äame_queue
;

3358 
Çme
[128];

3359 
i
 = 0;

3360 if(
út
 == 0){

3361 
út
 = 0x0fffffff;

3364 (
i
++è< 
út
) {

3366 
äame_queue
 = &
logic_chÆ
->
j³g_äame_queue
;

3368 !
äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(frame_queue)){

3369 
	`scheduË
();

3370 ià(
	`sigÇl_³ndšg
(
cu¼’t
)) {

3371 
	`TW_DBG
(
TW_DBG_DEBUG
, "receive signal\n");

3372 
j³g_out
;

3376 
	`mem£t
(
Çme
, 0, 128);

3377 
	`¥rštf
(
Çme
, "%s/video_chn_%02d_%02d_£q%d.jpg", 
·th
, 
logic_chÆ
->
logic_chª_id
, 
i
,†ogic_chÆ->
i_äame_£rŸl
);

3378 
j³g_fe
 = 
	`tw_k”Ãl_fe_İ’
(
Çme
);

3379 if(
	`IS_ERR
(
j³g_fe
) || !jpeg_file){

3380 
	`TW_DBG
(
TW_DBG_ERR
, "ü—‹ f%s, faed\n", 
Çme
);

3381  -
EINVAL
;

3383 
äame_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(frame_queue);

3384 
äame
 = 
äame_queue
->
cu¼_cÚsum”
;

3385 
	`TW_DBG
(
TW_DBG_DEBUG
, "»ûiv(%d/%dèj³g sŒ—m, seq %d!\n", (
i
+1), 
út
, 
äame
->
äame_numb”
);

3386 if(!
äame
->
äame_is_”r
){

3387 
	`tw_j³g_to_fe
(
j³g_fe
, 
äame
);

3389 
äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(äame_queue, &
logic_chÆ
->
poŞ
);

3390 
j³g_out
:

3391 if(
j³g_fe
) {

3392 
	`tw_k”Ãl_fe_şo£
(
j³g_fe
);

3394 
j³g_fe
 = 
NULL
;

3398 
	}
}

3400 
	$tw_j³g_to_fe
(
fe
 *
j³g_fe
, 
tw_vb_äame_tcb_t
 *
äame
)

3402 
mm_£gm’t_t
 
fs
;

3403 
tw_vb_·ck‘_tcb_t
 *
·ck‘
;

3404 
tw_vb_·ck‘_tcb_queue_t
 *
·ck‘_queue
;

3405 
Ën
, 
fœ¡
 = 0;

3407 if(!
j³g_fe
 || !
äame
)

3409  -
EINVAL
;

3412 
fs
=
	`g‘_fs
();

3413 
	`£t_fs
(
KERNEL_DS
);

3415 
·ck‘_queue
 = &
äame
->
vb_·ck‘_queue
;

3416 
fœ¡
 = 0;

3417 
·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(packet_queue)){

3418 
·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(packet_queue);

3419 
·ck‘
 = 
·ck‘_queue
->
cu¼_cÚsum”
;

3420 if(
fœ¡
 == 0) {

3421 
Ën
 = 
j³g_fe
->
f_İ
->
	`wr™e
(j³g_fe, 
·ck‘
->
d©a
 + (
ext_h264_Çl_b™¡»am_t
è+…ack‘->
cÚsum”_Ën
,…ack‘->
·ylßd_Ën
 -…ack‘->cÚsum”_ËÀ- Óxt_h264_Çl_b™¡»am_t), &(j³g_fe->
f_pos
));

3422 
fœ¡
 = 1;

3425 
Ën
 = 
j³g_fe
->
f_İ
->
	`wr™e
(j³g_fe, 
·ck‘
->
d©a
,…ack‘->
·ylßd_Ën
, &(j³g_fe->
f_pos
));

3427 
·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
Õack‘_queue, 
äame
->
poŞ
);

3430 
	`£t_fs
(
fs
);

3433 
	}
}

	@../../tw5864/tw5864/tw_kthread.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
sk_¡ruù
 *
	g®go_kth»ad
=
NULL
;

4 
©omic_t
 
	g®go_ruÂšg_æag
;

6 
	$´oûss_¦iû_h—d”_»q
(
tw_h264_logic_’code_chª_t
 *
’code_chª
)

8 
dvm_ch_t
 *
ch
;

9 
tw_h264_’code_´İ”ty_t
 *
’code_´İ”ty
;

10 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

11 
tw_video_chª_buf_poŞ_t
 *
’code_chª_buf_poŞ
;

12 
tw_video_äame_tcb_queue_t
 *
’code_äame_queue
;

13 
tw_video_äame_tcb_t
 *
video_äame
;

14 
tw_video_·ck‘_tcb_queue_t
 *
video_·ck‘_queue
;

15 
tw_video_·ck‘_tcb_t
 *
·ck‘
;

16 
Ãed_š™_rc_æag
 = 0;

18 if(
’code_chª
 =ğ
NULL
){

19 
	`TW_DBG
(
TW_DBG_FATAL
, "null…ointer\n");

24 
ch
 = 
’code_chª
->chip;

25 
’code_cÚŒŞ
 = &
’code_chª
->encode_control;

26 
’code_´İ”ty
 = &
’code_chª
->encode_property;

27 if(
’code_´İ”ty
->
İ
->
	`is_videoSnd¬d_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

28 
’code_cÚŒŞ
->
İ
->
	`upd©e_image_»sŞutiÚ
(encode_control);

29 
’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

31 if(
’code_´İ”ty
->
İ
->
	`is_’codeSize_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

32 
’code_cÚŒŞ
->
İ
->
	`upd©e_image_»sŞutiÚ
(encode_control);

33 
’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

35 if(
’code_´İ”ty
->
İ
->
	`is_gİIÁ”v®s_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

36 
’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

38 if(
’code_´İ”ty
->
İ
->
	`is_qpi_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

39 
’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

41 if(
’code_´İ”ty
->
İ
->
	`is_rg‘_b™¿‹_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

42 
Ãed_š™_rc_æag
 = 1;

44 if(
’code_´İ”ty
->
İ
->
	`is_rg‘_ås_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

45 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
 = 
’code_chª
->
ma¡”_¦Ù
;

46 
tw_h264_logic_video_¦Ù_t
 *
logic_video_¦Ù
 = 
phy_video_¦Ù
->
üoss_bus_logic_video_¦Ù
;

47 
u32
 
rg‘
 = 
’code_´İ”ty
->
İ
->
	`g‘_rg‘_ås
(encode_property);

48 
u32
 
phy_ås
 = 
logic_video_¦Ù
->
İ
->
	`g‘_ås
(logic_video_slot);

50 
’code_cÚŒŞ
->
İ
->
	`upd©e_ås_disÿrd_bË
Óncode_cÚŒŞ, 
phy_ås
, 
rg‘
);

51 
Ãed_š™_rc_æag
 = 1;

53 if(
’code_´İ”ty
->
İ
->
	`is_rcTy³_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

54 
Ãed_š™_rc_æag
 = 1;

56 if(
’code_´İ”ty
->
İ
->
	`is_ŸmgeLev–_chªged
Óncode_´İ”tyè=ğ
TW_ENCODE_PROPERTY_CHANGED
){

57 
Ãed_š™_rc_æag
 = 1;

59 if(
Ãed_š™_rc_æag
){

60 
’code_cÚŒŞ
->
i_gİ_¡ride
 = 0;

61 
’code_chª
->
rc_driv”
.
rc_İ
->
	`š™_rc
(encode_chan);

63 if(
	`©omic_»ad
(&
’code_chª
->
İ’ed_æag
)){

64 
’code_chª_buf_poŞ
 = &
’code_chª
->encode_chan_buf_pool;

65 
’code_äame_queue
 = &
’code_chª
->encode_frame_queue;

66 
’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
Óncode_äame_queue, 
’code_chª_buf_poŞ
);

67 
video_äame
 = (
tw_video_äame_tcb_t
*)
’code_äame_queue
->
cu¼_´oduûr
;

68 if(
video_äame
 !ğ
NULL
){

69 
video_·ck‘_queue
 = &
video_äame
->video_packet_queue;

70 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

71 ià(
·ck‘
 =ğ
NULL
) {

72 
video_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
(video_·ck‘_queue, &
’code_chª
->
’code_chª_buf_poŞ
);

73 
·ck‘
 = 
video_·ck‘_queue
->
cu¼_´oduûr
;

75 if(
·ck‘
 =ğ
NULL
){

76 
’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_´oduûr
Óncode_äame_queue, 
’code_chª_buf_poŞ
);

77 
	`’code_chª_g’_»q_msg
(
’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
DELAY_OP
);

78 
	`TW_DBG
(
TW_DBG_ERR
, "delay gen‡lgo_slice_head„eq, can't get…acket\n");

80 
’code_cÚŒŞ
->
İ
->
	`ÿlcuÏ‹_äame_ty³
(encode_control);

81 
video_äame
->
äame_ty³
 = 
’code_cÚŒŞ
->
İ
->
	`g‘_äame_ty³
(encode_control);

82 if(
video_äame
->
äame_ty³
 =ğ
H264_FRAME_TYPE_IDR
){

83 
’code_cÚŒŞ
->
İ
->
	`£t_¥s
(encode_control);

84 
’code_cÚŒŞ
->
İ
->
	`£t_µs
(encode_control);

86 
’code_chª
->
rc_driv”
.
rc_İ
->
	`£t_qp
Óncode_chª, 
video_äame
);

87 
’code_cÚŒŞ
->
İ
->
	`£t_¦iû_h—d
(encode_control);

88 
’code_cÚŒŞ
->
İ
->
	`g’”©Ü_h—d
Óncode_cÚŒŞ, 
video_äame
);

89 
’code_cÚŒŞ
->
İ
->
	`upd©e_¦iû_h—d_»ady
(encode_control);

90 if(
’code_cÚŒŞ
->
İ
->
	`g‘_¦iû_h—d_ªd_ad_¡©us
(encode_control)){

91 
	`driv”_g’_d–iv”_ev’t
(&
’code_chª
->
İ’ed_logic_chª_ed
, 1);

95 
	`’code_chª_g’_»q_msg
(
’code_chª
, 
REQ_ALGO_SLICE_HEAD
, 
DELAY_OP
);

96 
	`TW_DBG
(
TW_DBG_ERR
, "delay gen‡lgo_slice_head„eq, can't get frame\n");

99 
	`TW_DBG
(
TW_DBG_INFO
, "chªÃÈ%d i şo£d, sk REQ_ALGO_SLICE_HEAD\n", 
’code_chª
->
logic_chª_id
);

100 
’code_cÚŒŞ
->
İ
->
	`upd©e_¦iû_h—d_»ady
(encode_control);

102 
	}
}

104 
	$´oûss_chª_avSync
(
tw_h264_logic_’code_chª_t
 *
’code_chª
)

106 
tw5864_avSync_dev_t
 *
tw_deviû_chª
 = 
’code_chª
->tw_device_chan;

107 if(
tw_deviû_chª
 !ğ
NULL
){

108 
avSync_äame_queue_t
 *
avSync_äame_queue
 = &
tw_deviû_chª
->avSync_frame_queue;

109 
avSync_äame_buf_poŞ_t
 *
deviû_buf_poŞ
 = &
tw_deviû_chª
->device_buf_pool;

110 
tw_h264_logic_’code_chª_t
 *
h264_ma¡”_’code_driv”
 = 
tw_deviû_chª
->h264_master_encode_driver;

111 
tw_h264_logic_’code_chª_t
 *
h264_sub_’code_driv”
 = 
tw_deviû_chª
->h264_sub_encode_driver;

112 
tw_j³g_logic_’code_chª_t
 *
j³g_’code_driv”
 = 
tw_deviû_chª
->jpeg_encode_driver;

113 
tw_audio_driv”_t
 *
audio_’code_driv”
 = 
tw_deviû_chª
->audio_encode_driver;

114 
tw_video_äame_tcb_queue_t
 *
h264_ma¡”_’code_äame_queue
=
NULL
;

115 #ifdeà 
MV_MODULE


116 
tw_video_mv_äame_tcb_queue_t
 *
h264_ma¡”_’code_mv_äame_queue
=
NULL
;

118 
tw_video_äame_tcb_queue_t
 *
h264_sub_’code_äame_queue
=
NULL
;

119 #ifdeà 
MV_MODULE


120 
tw_video_mv_äame_tcb_queue_t
 *
h264_sub_’code_mv_äame_queue
=
NULL
;

122 
tw_vb_äame_tcb_queue_t
 *
j³g_’code_äame_queue
 = 
NULL
;

123 
tw_audio_·ck‘_queue_t
 *
audio_·ck‘_queue
 = 
NULL
;

124 
ma¡”_video_äame_numb”
, 
sub_video_äame_numb”
, 
audio_äame_numb”
, 
j³g_äame_numb”
;

125 
u32
 
sw™chS‹WÜd
 = 0, 
syncRuÂšgFÏg
 = 0;

127 if(
h264_ma¡”_’code_driv”
 !ğ
NULL
){

128 
h264_ma¡”_’code_äame_queue
 = &
h264_ma¡”_’code_driv”
->
’code_äame_queue
;

129 #ifdeà 
MV_MODULE


130 
h264_ma¡”_’code_mv_äame_queue
 = &
h264_ma¡”_’code_driv”
->
’code_mv_äame_queue
;

132 
	`©omic_£t
(&
h264_ma¡”_’code_driv”
->
have_d–iv”_sync_æag
, 0);

134 if(
h264_sub_’code_driv”
 !ğ
NULL
){

135 
h264_sub_’code_äame_queue
 = &
h264_sub_’code_driv”
->
’code_äame_queue
;

136 #ifdeà 
MV_MODULE


137 
h264_sub_’code_mv_äame_queue
 = &
h264_sub_’code_driv”
->
’code_mv_äame_queue
;

139 
	`©omic_£t
(&
h264_sub_’code_driv”
->
have_d–iv”_sync_æag
, 0);

141 if(
j³g_’code_driv”
 !ğ
NULL
) {

142 
j³g_’code_äame_queue
 = &
j³g_’code_driv”
->
j³g_äame_queue
;

144 if(
audio_’code_driv”
 !ğ
NULL
){

145 
audio_·ck‘_queue
 = &
audio_’code_driv”
->audio_packet_queue;

148 
syncRuÂšgFÏg
 = 0x7;

149 
syncRuÂšgFÏg
){

150 
ma¡”_video_äame_numb”
 = 
h264_ma¡”_’code_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(h264_master_encode_frame_queue);

151 
sub_video_äame_numb”
 = 
h264_sub_’code_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(h264_sub_encode_frame_queue);

152 
j³g_äame_numb”
 = 
j³g_’code_äame_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(jpeg_encode_frame_queue);

153 
audio_äame_numb”
 = 
audio_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(audio_packet_queue);

154 if(
ma¡”_video_äame_numb”
==0){

155 
sw™chS‹WÜd
 &= 0xfffffffe;

157 
sw™chS‹WÜd
 |= 0x1;

159 if(
sub_video_äame_numb”
==0){

160 
sw™chS‹WÜd
 &= 0xfffffffd;

162 
sw™chS‹WÜd
 |= 0x2;

164 if(
audio_äame_numb”
==0){

165 
sw™chS‹WÜd
 &= 0xfffffffb;

167 
sw™chS‹WÜd
 |= 0x4;

169 if(
j³g_äame_numb”
) {

170 
sw™chS‹WÜd
 |= 0x8;

172 
sw™chS‹WÜd
 &= 0xfffffff7;

174 if(
sw™chS‹WÜd
 == 0){

178 
avSync_äame_queue
->
İ
->
	`Œy_g‘_cu¼_´oduûr_äom_poŞ
×vSync_äame_queue, 
deviû_buf_poŞ
);

179 if(
avSync_äame_queue
->
cu¼_´oduûr
 !ğ
NULL
){

180 
sw™chS‹WÜd
){

182 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

183 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

184 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

185 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

189 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

190 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

191 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

192 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

196 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

197 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

198 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

199 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

203 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

204 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

205 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

206 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

210 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

211 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

212 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

213 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

215 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

216 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

217 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

218 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

222 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

223 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

224 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

225 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

227 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

228 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

229 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

230 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

234 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

235 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

236 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

237 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

239 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

240 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

241 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

242 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

246 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

247 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

248 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

249 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

251 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

252 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

253 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

254 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

258 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

259 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

260 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

261 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

263 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

264 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

265 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

266 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

270 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

271 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

272 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

273 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

275 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

276 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

277 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

278 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

282 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

283 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

284 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

285 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

287 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

288 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

289 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

290 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

292 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

293 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

294 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

295 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

299 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

300 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

301 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

302 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

304 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

305 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

306 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

307 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

309 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

310 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

311 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

312 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

316 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

317 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

318 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

319 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

321 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

322 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

323 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

324 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

326 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

327 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

328 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

329 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

333 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

334 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

335 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

336 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

338 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

339 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

340 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

341 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

343 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

344 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

345 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

346 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

350 
h264_ma¡”_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_master_encode_frame_queue);

351 if(
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

352 
h264_ma¡”_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_ma¡”_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_ma¡”_äame
);

353 
h264_ma¡”_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_ma¡”_’code_äame_queue, &
h264_ma¡”_’code_driv”
->
’code_chª_buf_poŞ
);

355 
h264_sub_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(h264_sub_encode_frame_queue);

356 if(
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

357 
h264_sub_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(h264_sub_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
h264_sub_äame
);

358 
h264_sub_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(h264_sub_’code_äame_queue, &
h264_sub_’code_driv”
->
’code_chª_buf_poŞ
);

360 
audio_·ck‘_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(audio_packet_queue);

361 if(
audio_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

362 
audio_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
×udio_·ck‘_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
audio_’code_äame
);

363 
audio_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
×udio_·ck‘_queue, &
audio_’code_driv”
->
audio_buf_poŞ
);

365 
j³g_’code_äame_queue
->
İ
->
	`Œy_g‘_cu¼_cÚsum”_äom_queue
(jpeg_encode_frame_queue);

366 if(
j³g_’code_äame_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

367 
j³g_’code_äame_queue
->
cu¼_cÚsum”
->
İ
->
	`»ã»nû
(j³g_’code_äame_queue->cu¼_cÚsum”, &
avSync_äame_queue
->
cu¼_´oduûr
->
j³g_äame
);

368 
j³g_’code_äame_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(j³g_’code_äame_queue, &
j³g_’code_driv”
->
poŞ
);

372 
syncRuÂšgFÏg
 = 0;

375 
avSync_äame_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(avSync_frame_queue);

386 
	`wake_up
(&
tw_deviû_chª
->
wa™_pŞl
);

389 
	}
}

391 
	$´oûss_ch_»£t_»q
(
tw_h264_logic_’code_chª_t
 *
’code_chª
)

393 
	`´štk
("%s.%d:%d-%d\n", 
__FUNCTION__
, 
__LINE__
, 
’code_chª
->
phy_¦Ù_id
,ƒncode_chª->
logic_chª_id
);

394 
	}
}

398 
	$kth»ad_®go_ag’t
(*
d©a
)

400 
tw_kth»ad_msg_poŞ_t
 *
tw_msg_poŞ
;

401 
tw_kth»ad_msg_queue_t
 *
tw_msg_queue
;

402 
esÿ³
 = 0;

404 
	`g‘_msg_poŞ_h—d”
(&
tw_msg_poŞ
);

405 if(
	`š™_tw_kth»ad_msg_poŞ
(
tw_msg_poŞ
) != 0){

406 
	`´štk
("create‡lgo msg…oolƒrr\n");

409 
	`g‘_msg_queue_h—d”
(&
tw_msg_queue
);

410 
	`š™_tw_kth»ad_msg_queue
(
tw_msg_queue
);

411 
	`©omic_£t
(&
®go_ruÂšg_æag
, 1);

413 
tw_msg_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(tw_msg_queue);

414 if(
tw_msg_queue
->
cu¼_cÚsum”
 !ğ
NULL
) {

415 
tw_msg_queue
->
cu¼_cÚsum”
->
msg_ty³
){

416 
REQ_ALGO_SLICE_HEAD
:

417 
	`´oûss_¦iû_h—d”_»q
((
tw_h264_logic_’code_chª_t
*)
tw_msg_queue
->
cu¼_cÚsum”
->
msg_cÚ‹xt
);

419 
REQ_AV_SYNC
:

420 
	`´oûss_chª_avSync
((
tw_h264_logic_’code_chª_t
*)
tw_msg_queue
->
cu¼_cÚsum”
->
msg_cÚ‹xt
);

422 
REQ_ALGO_CHIP_RESET
:

423 
	`´oûss_ch_»£t_»q
((
tw_h264_logic_’code_chª_t
*)
tw_msg_queue
->
cu¼_cÚsum”
->
msg_cÚ‹xt
);

425 
SYSTEM_ESCAPE_MSG
:

426 
esÿ³
 = 1;

429 
	`´štk
("I dÚ'ˆknow' msgy³ = %d\n", 
tw_msg_queue
->
cu¼_cÚsum”
->
msg_ty³
);

433 
tw_msg_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(tw_msg_queue);

434 if(
esÿ³
){

438 
	`»move_tw_kth»ad_msg_queue
(
tw_msg_queue
);

439 
	`»move_tw_kth»ad_msg_poŞ
(
tw_msg_poŞ
);

440 
	`´štk
("sucûs esÿ³ %s\n", 
__FUNCTION__
);

441 
	`©omic_£t
(&
®go_ruÂšg_æag
, 0);

443 
	}
}

449 
	$š™_dvm_kth»ad_mªage
()

451 
®go_kth»ad
=
NULL
;

452 
	`©omic_£t
(&
®go_ruÂšg_æag
, 0);

453 
	}
}

455 
	$nÙify_®go_kth»ad_kl_my£lf
()

457 
tw_kth»ad_msg_poŞ_t
 *
tw_msg_poŞ
;

458 
tw_kth»ad_msg_queue_t
 *
tw_msg_queue
;

459 
tw_kth»ad_msg_t
 *
tw_msg
;

461 
	`´štk
("%s\n", 
__FUNCTION__
);

462 
	`g‘_msg_poŞ_h—d”
(&
tw_msg_poŞ
);

463 
	`g‘_msg_queue_h—d”
(&
tw_msg_queue
);

464 
tw_msg_poŞ
->
İ
->
	`g‘
Ñw_msg_poŞ, &
tw_msg
);

465 if(
tw_msg
 !ğ
NULL
){

466 
tw_msg
->
msg_ty³
 = 
SYSTEM_ESCAPE_MSG
;

467 
tw_msg_queue
->
İ
->
	`put
Ñw_msg_queue, 
tw_msg
);

469 
	}
}

471 
	$wa™_10_£cÚd_fÜ_®go_kth»ad
()

473 
couÁ
=0;

474 
	`©omic_»ad
(&
®go_ruÂšg_æag
)){

475 
	`´štk
("%s, %d, %d\n", 
__FUNCTION__
, 
__LINE__
, 
couÁ
);

476 
	`m¦“p
(100);

477 
couÁ
++;

478 if(
couÁ
 > 100){

482 
	}
}

484 
	$fÜû_şo£_kth»ad
(
sk_¡ruù
 **
sk
)

486 
	`kth»ad_¡İ
(*
sk
);

487 *
sk
 = 
NULL
;

488 
	}
}

490 
	$¡¬t_dvm_kth»ad
()

492 
Çme
[64];

493 
	`š™_dvm_kth»ad_mªage
();

494 
	`mem£t
(
Çme
, 0, 64);

495 
	`¥rštf
(
Çme
, "tw_agend");

496 
®go_kth»ad
 = 
	`kth»ad_run
(
kth»ad_®go_ag’t
, 
NULL
, 
Çme
);

497 if(
	`IS_ERR
(
®go_kth»ad
)) {

498 
	`´štk
("start dvm_algo_kthreadƒrr\n");

499 
	`©omic_£t
(&
®go_ruÂšg_æag
, 0);

500 
®go_kth»ad
 = 
NULL
;

502 
	}
}

504 
	$¡İ_dvm_kth»ad
()

506 if(
®go_kth»ad
 !ğ
NULL
) {

507 
	`nÙify_®go_kth»ad_kl_my£lf
();

508 
	`wa™_10_£cÚd_fÜ_®go_kth»ad
();

509 
	`´štk
("%s,%d,ok\n", 
__FUNCTION__
, 
__LINE__
);

510 if(
	`©omic_»ad
(&
®go_ruÂšg_æag
)) {

511 
	`´štk
("algo_kthread myself killƒrr, so force kill it\n");

512 
	`fÜû_şo£_kth»ad
(&
®go_kth»ad
);

513 
	`©omic_£t
(&
®go_ruÂšg_æag
, 0);

515 
®go_kth»ad
 = 
NULL
;

517 
	`´štk
("%s,%d,ok\n", 
__FUNCTION__
, 
__LINE__
);

518 
	}
}

	@../../tw5864/tw5864/tw_osd_engine.c

1 
	~<tw5864/dvm_commÚ.h
>

2 
	~<lšux/¹c.h
>

4 
g‘_ascii_lib12_addr
(**
addr_±r
, * 
ch¬_id
);

5 
g‘_lib12_addr
(**
addr_±r
, * 
lib16_id
);

6 
g‘_ascii_lib24_addr
(**
addr_±r
, * 
ch¬_id
);

7 
g‘_lib24_addr
(**
addr_±r
, * 
lib16_id
);

9 
	#YEAR_STRING_LEN
 (11)

	)

10 
	#TIME_STRING_LEN
 (9)

	)

11 
	#CHANNEL_STRING_LEN
 (10)

	)

12 
	#YEAR_TIME_STRING_LEN
 (
YEAR_STRING_LEN
+
TIME_STRING_LEN
+
CHANNEL_STRING_LEN
+4+40)

	)

13 
	#UPDATE_OSD_DATA_SECTION
 (1)

	)

14 
	#UPDATE_OSD_ATTR_SECTION
 (2)

	)

16 #ifdeà 
USED_STATIC_OSD_CHAR_BUF


17 
osd_mb_ch¬_’Œy_t
 
	gosd_md_ÿche
[
MAX_CHIP_NUM_IN_BOARD
][
OSD_MB_ENTRY_NUMBER
];

20 
osd_sy¡em_tim”_t
 
	gosd_tim”
 = {

21 .
y—r
 = 1970,

22 .
	gmÚth
 = 1,

23 .
	gday
 = 1,

24 .
	ghour
 = 0,

25 .
	gmšu‹
 = 0,

26 .
	g£cÚd
 = 0,

27 .
	gÃed_upd©e_m­_bË
[0] = 0xffffffff,

30 
	$chªge_’code_osd_time
(
¹c_time
 *
tim”
)

32 
æag
=0;

33 if(
osd_tim”
.
y—r
 !ğ
tim”
->
tm_y—r
){

34 
osd_tim”
.
y—r
 = 
tim”
->
tm_y—r
;

35 
æag
 = 1;

37 if(
osd_tim”
.
mÚth
 !ğ
tim”
->
tm_mÚ
){

38 
osd_tim”
.
mÚth
 = 
tim”
->
tm_mÚ
;

39 
æag
 = 1;

41 if(
osd_tim”
.
day
 !ğ
tim”
->
tm_mday
){

42 
osd_tim”
.
day
 = 
tim”
->
tm_mday
;

43 
æag
 = 1;

45 if(
osd_tim”
.
hour
 !ğ
tim”
->
tm_hour
){

46 
osd_tim”
.
hour
 = 
tim”
->
tm_hour
;

47 
æag
 = 1;

49 if(
osd_tim”
.
mšu‹
 !ğ
tim”
->
tm_mš
){

50 
osd_tim”
.
mšu‹
 = 
tim”
->
tm_mš
;

51 
æag
 = 1;

53 if(
osd_tim”
.
£cÚd
 !ğ
tim”
->
tm_£c
){

54 
osd_tim”
.
£cÚd
 = 
tim”
->
tm_£c
;

55 
æag
 = 1;

57 if(
æag
){

58 
i
;

59 
i
=0; i<
MAX_CHIP_NUM_IN_BOARD
; i++){

60 
osd_tim”
.
Ãed_upd©e_m­_bË
[
i
] = 0xffffffff;

63 
	}
}

65 cÚ¡ 
	g£c_of_1day
 = 86400;

66 cÚ¡ 
	g£c_of_366day
 = 31622400;

67 cÚ¡ 
	g£c_of_365day
 = 31536000;

68 cÚ¡ 
	g£c_of_31day
 = 2678400;

69 cÚ¡ 
	g£c_of_30day
 = 2592000;

70 cÚ¡ 
	g£c_of_29day
 = 2505600;

71 cÚ¡ 
	g£c_of_28day
 = 2419200;

72 cÚ¡ 
	g£c_of_2000_to_2007
 = 252460800;

73 cÚ¡ 
	g£c_of_1970_to_1999
 = 946684800;

74 cÚ¡ 
	g£c_of_1970_to_2007
 = 1199145600;

75 
	gcur_w®Éime_£c
 = 0;

76 
¹c_time
 
	gsy¡em_time
;

77 
	gmpc8313_tim”
;

79 
šlše
 
	$is_run_y—r
(
y—r
)

81 if((
y—r
 % 4 == 0 && year % 100 != 0) || year % 400 == 0)

84 
	}
}

86 
šlše
 
	$g‘_day_of_mÚth
(
y—r
, 
mÚth
)

88 
mÚth
) {

103 ià(1 =ğ
	`is_run_y—r
(
y—r
))

111 
	}
}

113 
	$Œªs_£c_to_time
(
šput_£c
)

115 
y—r
 = 0, 
mÚth
 = 0, 
day
 = 0, 
hour
 = 0, 
mš
 = 0, 
£c
 = 0;

116 
š_£c
 = 
šput_£c
;

118 ià(
š_£c
 < 0)

120 ià(
šput_£c
 > 
£c_of_1970_to_2007
) {

121 
y—r
 = 2008;

122 
š_£c
 -ğ
£c_of_1970_to_2007
;

123 } ià(
šput_£c
 > 
£c_of_1970_to_1999
) {

124 
y—r
 = 2000;

125 
š_£c
 -ğ
£c_of_1970_to_1999
;

127 
y—r
 = 1970;

128 ;;
y—r
++) {

129 ià(1 =ğ
	`is_run_y—r
(
y—r
)) {

130 ià(
š_£c
 >ğ
£c_of_366day
) {

131 
š_£c
 -ğ
£c_of_366day
;

135 ià(
š_£c
 >ğ
£c_of_365day
) {

136 
š_£c
 -ğ
£c_of_365day
;

141 
mÚth
 = 1;

142 ;;
mÚth
++) {

143 ià(31 =ğ
	`g‘_day_of_mÚth
(
y—r
, 
mÚth
)) {

144 ià(
š_£c
 >ğ
£c_of_31day
) {

145 
š_£c
 -ğ
£c_of_31day
;

148 } ià(30 =ğ
	`g‘_day_of_mÚth
(
y—r
, 
mÚth
)) {

149 ià(
š_£c
 >ğ
£c_of_30day
) {

150 
š_£c
 -ğ
£c_of_30day
;

153 } ià(28 =ğ
	`g‘_day_of_mÚth
(
y—r
, 
mÚth
)) {

154 ià(
š_£c
 >ğ
£c_of_28day
) {

155 
š_£c
 -ğ
£c_of_28day
;

158 } ià(29 =ğ
	`g‘_day_of_mÚth
(
y—r
, 
mÚth
)) {

159 ià(
š_£c
 >ğ
£c_of_29day
) {

160 
š_£c
 -ğ
£c_of_29day
;

165 
day
 = 1;

166 ;;
day
++) {

167 ià(
š_£c
 >ğ
£c_of_1day
) {

168 
š_£c
 -ğ
£c_of_1day
;

172 
hour
 = 0;

173 ;;
hour
++) {

174 ià(
š_£c
 >= 3600) {

175 
š_£c
 -= 3600;

179 
mš
 = 0;

180 ;;
mš
++) {

181 ià(
š_£c
 >= 60) {

182 
š_£c
 -= 60;

186 
£c
 = 
š_£c
;

188 
sy¡em_time
.
tm_y—r
 = 
y—r
;

189 
sy¡em_time
.
tm_mÚ
 = 
mÚth
;

190 
sy¡em_time
.
tm_mday
 = 
day
;

191 
sy¡em_time
.
tm_hour
 = 
hour
;

192 
sy¡em_time
.
tm_mš
 = 
mš
;

193 
sy¡em_time
.
tm_£c
 = 
£c
;

194 
	}
}

196 
	$»äesh_w®Éime_of_£c
(
timev®
 *
tv1
)

198 
Ãw_w®Éime_£c
;

200 
	`do_g‘timeofday
(
tv1
);

201 
mpc8313_tim”
 = 
tv1
->
tv_£c
*1000 + (tv1->
tv_u£c
)/1000;

202 
Ãw_w®Éime_£c
 = ()
tv1
->
tv_£c
;

203 ià(
cur_w®Éime_£c
 =ğ
Ãw_w®Éime_£c
)

205 
cur_w®Éime_£c
 = 
Ãw_w®Éime_£c
;

206 ià(
Ãw_w®Éime_£c
 - 
cur_w®Éime_£c
 =ğ1 && (
sy¡em_time
.
tm_hour
 < 23 || sy¡em_time.
tm_mš
 < 59 || sy¡em_time.
tm_£c
 < 59)) {

207 
sy¡em_time
.
tm_£c
++;

208 ià(
sy¡em_time
.
tm_£c
 == 60) {

209 
sy¡em_time
.
tm_£c
 = 0;

210 
sy¡em_time
.
tm_mš
++;

211 ià(
sy¡em_time
.
tm_mš
 == 60) {

212 
sy¡em_time
.
tm_mš
 = 0;

213 
sy¡em_time
.
tm_hour
++;

217 
	`Œªs_£c_to_time
(
cur_w®Éime_£c
);

219 
	}
}

221 
	$check_¹c_time
(
timev®
 *
tv1
)

223 
	`»äesh_w®Éime_of_£c
(
tv1
);

224 
	`chªge_’code_osd_time
(&
sy¡em_time
);

225 
	}
}

227 
u32
 
	$g‘_osd_chª_ba£
(
phy_¦Ù_id
)

229 
u32
 
chª_ba£
;

230 
chª_ba£
 = (((
phy_¦Ù_id
>>2)<<3)+(phy_slot_id&0x3));

231 
chª_ba£
 <<= 20;

232  
chª_ba£
;

233 
	}
}

235 
u32
 
	$g‘_phy_¦Ù_id_by_osd_chª_ba£
(
tw5864_vd_üoss_bus_t
 *
vd_bus
, 
u32
 
chª_ba£_addr
, 
osd_¦Ù_id
, 
IsDdrCom´essMode
)

237 
phy_¦Ù_id
, 
ddr_·ge_id
, 
logic_’c_ch_id
;

238 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

239 
i
 = 0, 
ch_ba£
 = 0;;

241 
ddr_·ge_id
 = 
chª_ba£_addr
>>19;

242 
logic_’c_ch_id
 = 
ddr_·ge_id
>>4;

243 
ch_ba£
 = 0;

244 if(
IsDdrCom´essMode
 =ğ
DDR_MAP_COMPRESS_ENABLE
){

245 
i
 = 0; i < 
logic_’c_ch_id
; i++) {

246 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
ch_ba£
, &
phy_video_¦Ù
);

247 
phy_video_¦Ù
->
İ
->
	`g‘_video_size
(phy_video_slot)) {

249 
TW_VIDEO_SIZE_D1
:

250 
ch_ba£
 += 1;

252 
TW_VIDEO_SIZE_HALF_D1
:

253 
ch_ba£
 += 2;

255 
TW_VIDEO_SIZE_CIF
:

256 
ch_ba£
 += 4;

260 
logic_’c_ch_id
 = 
ch_ba£
;

262 
logic_’c_ch_id
 = (
osd_¦Ù_id
 >> 2);

263 
logic_’c_ch_id
 <<= 0;

265 
phy_¦Ù_id
 = 
logic_’c_ch_id
;

267  
phy_¦Ù_id
;

268 
	}
}

270 
u32
 
	$g‘_osd_»ùªg–_d©a_ba£
(
»ù_id
, 
videoSizeMode
, 
Ma¡”OrSub
, 
u32
 
chª_ba£
)

272 
u32
 
osd_»ùªgË_d©a_ba£
;

273 
videoSizeMode
){

275 
TW_VIDEO_SIZE_D1
:

276 if(
»ù_id
 <=2){

277 
osd_»ùªgË_d©a_ba£
 = (
»ù_id
<<18) + 0x30000;

279 
osd_»ùªgË_d©a_ba£
 = 0xc0000 + ((
»ù_id
-3)<<16);

281 if(
Ma¡”OrSub
 =ğ
TW_SUB_BITSTREAM
){

282 
osd_»ùªgË_d©a_ba£
 += 0x8000;

285 
TW_VIDEO_SIZE_HALF_D1
:

286 
TW_VIDEO_SIZE_CIF
:

287 
osd_»ùªgË_d©a_ba£
 = (
»ù_id
<<17) + 0x10000;

288 if(
Ma¡”OrSub
 =ğ
TW_SUB_BITSTREAM
){

289 
osd_»ùªgË_d©a_ba£
 += 0xa000;

291 
osd_»ùªgË_d©a_ba£
 += 0x2000;

295 
osd_»ùªgË_d©a_ba£
 +ğ
chª_ba£
;

296  
osd_»ùªgË_d©a_ba£
;

297 
	}
}

299 
	$g‘_osd_»ùªg–_d©a_ba£_ªd_off£t
(
u32
 
»ùªgË_ba£_addr
, 
osd_mode
, 
osd_m­_mode
, *
osd_d©a_0_8_ba£_addr
, *
osd_d©a_addr_off£t_0_2
)

301 
u32
 
»ùªgË_ba£_dwÜd_addr
 = 
»ùªgË_ba£_addr
>>2;

302 
osd_mode
){

303 
ENCODE_OSD_MODE0
:

304 
ENCODE_OSD_MODE1
:

305 
osd_m­_mode
){

306 
Y8MB_X128MB_OSDMODE013
:

307 *
osd_d©a_addr_off£t_0_2
 = ((
»ùªgË_ba£_dwÜd_addr
>>11)&0x7);

308 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

310 
Y16MB_X64MB_OSDMODE013
:

311 *
osd_d©a_addr_off£t_0_2
 = ((
»ùªgË_ba£_dwÜd_addr
>>11)&0x7);

312 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

314 
Y32MB_X32MB_OSDMODE013
:

315 *
osd_d©a_addr_off£t_0_2
 = ((
»ùªgË_ba£_dwÜd_addr
>>11)&0x7);

316 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

319 
Y64MB_X16MB_OSDMODE013
:

320 *
osd_d©a_addr_off£t_0_2
 = ((
»ùªgË_ba£_dwÜd_addr
>>11)&0x7);

321 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

325 
ENCODE_OSD_MODE2
:

326 
osd_m­_mode
){

327 
Y8MB_X128MB_OSDMODE013
:

328 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

330 
Y16MB_X64MB_OSDMODE013
:

331 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>14)&0x1ff);

333 
Y32MB_X32MB_OSDMODE013
:

334 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>15)&0xff);

337 
Y64MB_X16MB_OSDMODE013
:

338 *
osd_d©a_0_8_ba£_addr
 = ((
»ùªgË_ba£_dwÜd_addr
>>15)&0xff);

341 *
osd_d©a_addr_off£t_0_2
 = 0;

344 
ENCODE_OSD_MODE3
:

345 *
osd_d©a_0_8_ba£_addr
 = 0;

346 *
osd_d©a_addr_off£t_0_2
 = 0;

349 
	}
}

351 
u32
 
	$g‘_osd_»ùªgË_mb_d©a_ba£
(
osd_mode
, 
osd_m­_mode
, 
mb_x
, 
mb_y
, 
»ùªgË_d©a_ba£
)

353 
u32
 
osd_md_d©a_ba£
, 
mb_bŸs
;

354 
osd_md_d©a_ba£
 = (
»ùªgË_d©a_ba£
>>2);

355 
osd_mode
){

356 
ENCODE_OSD_MODE0
:

357 
ENCODE_OSD_MODE1
:

358 
osd_m­_mode
){

359 
Y8MB_X128MB_OSDMODE013
:

360 
mb_bŸs
 = (((
mb_y
&0x7)<<11)|((
mb_x
&0x7f)<<4));

362 
Y16MB_X64MB_OSDMODE013
:

363 
mb_bŸs
 = (((
mb_y
&0xf)<<10)|((
mb_x
&0x3f)<<4));

365 
Y32MB_X32MB_OSDMODE013
:

366 
mb_bŸs
 = (((
mb_y
&0x1f)<<9)|((
mb_x
&0x1f)<<4));

369 
Y64MB_X16MB_OSDMODE013
:

370 
mb_bŸs
 = (((
mb_y
&0x3f)<<8)|((
mb_x
&0xf)<<4));

374 
ENCODE_OSD_MODE2
:

375 
osd_m­_mode
){

376 
Y8MB_X128MB_OSDMODE013
:

377 
mb_bŸs
 = (((
mb_y
&0x7)<<11)|((
mb_x
&0xf)<<7));

379 
Y16MB_X64MB_OSDMODE013
:

380 
mb_bŸs
 = (((
mb_y
&0xf)<<10)|((
mb_x
&0x7)<<7));

382 
Y32MB_X32MB_OSDMODE013
:

383 
mb_bŸs
 = (((
mb_y
&0xf)<<11)|((
mb_x
&0xf)<<7));

386 
Y64MB_X16MB_OSDMODE013
:

387 
mb_bŸs
 = (((
mb_y
&0xf)<<11)|((
mb_x
&0xf)<<7));

392 
ENCODE_OSD_MODE3
:

393 
mb_bŸs
 = 0;

396 
osd_md_d©a_ba£
 +ğ
mb_bŸs
;

397 
osd_md_d©a_ba£
 <<= 2;

398  
osd_md_d©a_ba£
;

399 
	}
}

401 
	$g‘_ddr_·ge_id_ªd_·ge_off£t_by_md_d©a_ba£
(
u32
 
osd_md_d©a_ba£
, *
ddr_·ge_id
, *
ddr_·ge_off£t
)

403 *
ddr_·ge_id
 = (
osd_md_d©a_ba£
>>19);

404 *
ddr_·ge_off£t
 = (
osd_md_d©a_ba£
&0x7ffff);

405 
	}
}

407 
	$osd_tim”_©Œ_»£t
(
’code_osd_tim”_©Œ_t
 *
tim”_©Œ
, 
ch_id
, 
chª_id
)

409 
tim”_©Œ
->
tim”
->
Ãed_upd©e_m­_bË
[
ch_id
] |ğ(1<<
chª_id
);

410 
	}
}

412 
’code_osd_tim”_©Œ_İ”©iÚ
 
	gosd_tim”_©Œ_İ
 = {

413 .
»£t
 = 
osd_tim”_©Œ_»£t
,

416 
	$osd_¡ršg_©Œ_»£t
(
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
)

418 
¡ršg_©Œ
->
mb_x
 = 0;

419 
¡ršg_©Œ
->
mb_y
 = 0;

420 
¡ršg_©Œ
->
mb_height
 = 0;

421 
¡ršg_©Œ
->
mb_width
 = 0;

422 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 0;

423 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y8MB_X128MB_OSDMODE013
;

424 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

425 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

427 
	}
}

429 
’code_osd_¡ršg_©Œ_İ”©iÚ
 
	gosd_¡ršg_©Œ_İ
 = {

430 .
»£t
 = 
osd_¡ršg_©Œ_»£t
,

433 
	$osd_mask_©Œ_»£t
(
’code_osd_mask_©Œ_t
 *
mask_©Œ
)

435 
mask_©Œ
->
mask_height
 = 0;

436 
mask_©Œ
->
mask_width
 = 0;

437 
mask_©Œ
->
mb_x
 = 0;

438 
mask_©Œ
->
mb_y
 = 0;

439 
mask_©Œ
->
y_v®ue
 = 0;

440 
mask_©Œ
->
u_v®ue
 = 0;

441 
mask_©Œ
->
v_v®ue
 = 0;

442 
mask_©Œ
->
Ãed_upd©e_æag
 = 0;

443 
mask_©Œ
->
is_di¥Ïy
 = 0;

444 
	}
}

446 
’code_osd_mask_©Œ_İ”©iÚ
 
	gosd_mask_©Œ_İ
 = {

447 .
»£t
 = 
osd_mask_©Œ_»£t
,

450 
	$osd_©Œibu‹_»gs_£t
(
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
)

452 if(
©Œ_»gs
 !ğ
NULL
){

453 
©Œ_»gs
->
»g1_v®ue
.
»g1
.
’abË
 = 1;

455 
	}
}

457 
	$osd_©Œibu‹_»gs_£t_no_di¥Ïy
(
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
)

459 if(
©Œ_»gs
 !ğ
NULL
){

460 
©Œ_»gs
->
»g1_v®ue
.
»g1
.
’abË
 = 0;

462 
	}
}

464 
	$osd_©Œibu‹_»gs_»£t
(
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
)

466 if(
©Œ_»gs
 !ğ
NULL
){

467 
©Œ_»gs
->
»g1_v®ue
.
v®ue
 = 0;

468 
©Œ_»gs
->
»g2_v®ue
.
v®ue
 = 0;

469 
©Œ_»gs
->
»g3_v®ue
.
v®ue
 = 0;

471 
	}
}

473 
osd_©Œibu‹_»gs_İ”©iÚ
 
	gosd_©Œibu‹_»gs_İ
 = {

474 .
£t
 = 
osd_©Œibu‹_»gs_£t
,

475 .
	g£t_no_di¥Ïy
 = 
osd_©Œibu‹_»gs_£t_no_di¥Ïy
,

476 .
	g»£t
 = 
osd_©Œibu‹_»gs_»£t
,

479 
	$osd_’code_chª_¡¬t_£nd_©Œ_»g_v®ue
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

481 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

482 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
 = (osd_»ùªgË_d´am_tcb_t*)
cÚ‹xt
;

483 
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
 = 
	`to_osd_©Œibu‹_»gs_group_w™h_osd_d´am_»q
(
osd_d´am_»q
);

484 
osd_chª_’gše_t
 *
osd_chª_’gše
 = 
	`to_osd_chª_’gše_w™h_osd_©Œibu‹_»gs_group
(
©Œ_»gs_group
);

485 
dvm_ch_t
 *
ch
 = 
osd_chª_’gše
->
’code_chª
->chip;

486 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

489 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
osd_d´am_»q
->
d´am_·ge
)){

490 
osd_d´am_»q
->
İ
->
	`»¥Ú£_wr™e_osd_»ùªgË
(osd_d´am_»q, 
ch
);

491 if(
	`©omic_»ad
(&
osd_chª_’gše
->
osd_is_wÜkšg
) > 0){

492 
	`©omic_dec
(&
osd_chª_’gše
->
osd_is_wÜkšg
);

494 if(
	`©omic_»ad
(&
osd_chª_’gše
->
osd_is_wÜkšg
) == 0){

495 
	`com¶‘e_®l
(&
osd_chª_’gše
->
wa™_dÚe
);

498 
	`´štk
("%s.%d:„‘rigg”\n", 
__FUNCTION__
, 
__LINE__
);

502 
	}
}

504 
	$osd_»ùªgË_©Œ_»gs_group_d´am_tcb_š™
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
)

506 if(
osd_d´am_»q
 !ğ
NULL
){

507 
d´am_»que¡_t
 *
d´am_»q
;

508 
d´am_»q
 = &
osd_d´am_»q
->
osd_d©a_»q
;

509 
d´am_»q
->
ty³
 = 
DPRAM_BLOCK_TRANSFER_REQUEST
;

510 
d´am_»q
->
cÚ‹xt
 = (*)
osd_d´am_»q
;

511 
d´am_»q
->
»q_ÿÎback
 = 
osd_’code_chª_¡¬t_£nd_©Œ_»g_v®ue
;

513 
	}
}

515 
	$osd_»ùªgË_©Œ_»gs_group_d´am_tcb_subm™_wr™e_osd_»ùªgË_d©a_»q
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

517 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

518 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

519 
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
 = 
	`to_osd_©Œibu‹_»gs_group_w™h_osd_d´am_»q
(
osd_d´am_»q
);

520 
osd_d´am_»q
->
İ
->
	`š™
(osd_dpram_req);

521 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_wr™e_video_’code_osd_©Œ_»q
(ch_d´am_cÚŒŞËr, 
©Œ_»gs_group
);

523 
	}
}

525 
	$osd_»ùªgË_©Œ_»gs_group_d´am_tcb_subm™_wr™e_osd_»ùªgË_©Œ
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

527 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

528 
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
;

529 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

530 
u32
 *
»g_v®ue_buf
, 
»g_v®ue_buf_Ën
;

532 
©Œ_»gs_group
 = 
	`to_osd_©Œibu‹_»gs_group_w™h_osd_d´am_»q
(
osd_d´am_»q
);

533 
bur¡_š‹rçû
 = &
ch
->
ch_d´am_cÚŒŞËr
.burst_interface;

534 
»g_v®ue_buf
 = (
u32
 *)(
©Œ_»gs_group
->
©Œibu‹_»gs_group
);

535 
»g_v®ue_buf_Ën
 = (
osd_©Œibu‹_»gs_t
)*
OSD_CHAN_RECTANGLE_NUMBER
;

536 
bur¡_š‹rçû
->
İ
->
	`pio_ho¡_to_¤am_wr™e
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
»g_v®ue_buf
, 
»g_v®ue_buf_Ën
);

537 
bur¡_š‹rçû
->
İ
->
	`¡¬t_block_Œªsãr_äom_¤am_to_ddr
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
©Œ_»gs_group
->
osd_chª_©Œ_»g_ba£
,‡‰r_»gs_group->
osd_chª_©Œ_»g_·ge_id
, 
»g_v®ue_buf_Ën
, 
DDR_CHIP_A
);

539 
	}
}

541 
	$osd_»ùªgË_©Œ_»gs_group_d´am_tcb_»¥Ú£_wr™e_osd_»ùªgË
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

543 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

544 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

545 
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
 = 
	`to_osd_©Œibu‹_»gs_group_w™h_osd_d´am_»q
(
osd_d´am_»q
);

546 
osd_d´am_»q
->
İ
->
	`subm™_wr™e_osd_»ùªgË_©Œ
(osd_d´am_»q, 
ch
);

547 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_wr™e_video_’code_osd_©Œ_»q
(ch_d´am_cÚŒŞËr, 
©Œ_»gs_group
);

549 
	}
}

551 
osd_»ùªgË_d´am_tcb_İ”©iÚ
 
	gosd_»ùªgË_©Œ_»gs_group_d´am_tcb_İ
 = {

552 .
š™
 = 
osd_»ùªgË_©Œ_»gs_group_d´am_tcb_š™
,

553 .
	gsubm™_wr™e_osd_»ùªgË_d©a_»q
 = 
osd_»ùªgË_©Œ_»gs_group_d´am_tcb_subm™_wr™e_osd_»ùªgË_d©a_»q
,

554 .
	gsubm™_wr™e_osd_»ùªgË_©Œ
 = 
osd_»ùªgË_©Œ_»gs_group_d´am_tcb_subm™_wr™e_osd_»ùªgË_©Œ
,

555 .
	g»¥Ú£_wr™e_osd_»ùªgË
 = 
osd_»ùªgË_©Œ_»gs_group_d´am_tcb_»¥Ú£_wr™e_osd_»ùªgË
,

558 
	$osd_©Œibu‹_»gs_group_š™_osd_chª_»ùªgË_©Œ_»gs_group
(
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
)

560 if(
©Œ_»gs_group
 !ğ
NULL
){

561 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

562 
osd_chª_’gše_t
 *
osd_chª_’gše
;

563 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
;

564 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

565 
i
, 
chª_id
;

567 
©Œ_»gs_group
->
»ù_©Œ_»gs_İ
 = &
osd_©Œibu‹_»gs_İ
;

568 
i
=0; i<
OSD_CHAN_RECTANGLE_NUMBER
; i++){

569 
©Œ_»gs
 = &
©Œ_»gs_group
->
©Œibu‹_»gs_group
[
i
];

570 
©Œ_»gs_group
->
»ù_©Œ_»gs_İ
->
	`»£t
(
©Œ_»gs
);

573 
osd_chª_’gše
 = 
	`to_osd_chª_’gše_w™h_osd_©Œibu‹_»gs_group
(
©Œ_»gs_group
);

574 
’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_osd_’gše
(
osd_chª_’gše
);

575 
chª_id
 = 
’code_chª
->
phy_¦Ù_id
;

576 if(
osd_chª_’gše
->
ma¡”OrSub
 =ğ
TW_MASTER_BITSTREAM
){

577 
©Œ_»gs_group
->
osd_chª_©Œ_»g_ba£
 = ((
OSD_ATTR_REG_BASE_ADDR
<<
OSD_ATTR_REG_SHIFT
)|(
chª_id
<<5))<<2;

579 
©Œ_»gs_group
->
osd_chª_©Œ_»g_ba£
 = ((
OSD_ATTR_REG_BASE_ADDR
<<
OSD_ATTR_REG_SHIFT
)|(0x1<<9)|(
chª_id
<<5))<<2;

581 
©Œ_»gs_group
->
osd_chª_©Œ_»g_·ge_id
 =‡‰r_»gs_group->
osd_chª_©Œ_»g_ba£
>>19;

583 
osd_d´am_»q
 = &
©Œ_»gs_group
->osd_dpram_req;

584 
osd_d´am_»q
->
İ
 = &
osd_»ùªgË_©Œ_»gs_group_d´am_tcb_İ
;

586 
	}
}

588 
	$osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_£t
(
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
, 
»ù_id
)

590 if((
©Œ_»gs_group
!=
NULL
è&& (
»ù_id
<
OSD_CHAN_RECTANGLE_NUMBER
)){

591 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
 = &
©Œ_»gs_group
->
©Œibu‹_»gs_group
[
»ù_id
];

592 
©Œ_»gs_group
->
»ù_©Œ_»gs_İ
->
	`£t
(
©Œ_»gs
);

594 
	}
}

596 
	$osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_£t_no_di¥Ïy
(
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
, 
»ù_id
)

598 if((
©Œ_»gs_group
!=
NULL
è&& (
»ù_id
<
OSD_CHAN_RECTANGLE_NUMBER
)){

599 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
 = &
©Œ_»gs_group
->
©Œibu‹_»gs_group
[
»ù_id
];

600 
©Œ_»gs_group
->
»ù_©Œ_»gs_İ
->
	`£t_no_di¥Ïy
(
©Œ_»gs
);

602 
	}
}

604 
	$osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_»£t
(
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
, 
»ù_id
)

606 if((
©Œ_»gs_group
!=
NULL
è&& (
»ù_id
<
OSD_CHAN_RECTANGLE_NUMBER
)){

607 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
 = &
©Œ_»gs_group
->
©Œibu‹_»gs_group
[
»ù_id
];

608 
©Œ_»gs_group
->
»ù_©Œ_»gs_İ
->
	`»£t
(
©Œ_»gs
);

610 
	}
}

612 
	$osd_©Œibu‹_»gs_group_upd©e_chª_»ùªgË_©Œ_»gs
(
osd_©Œibu‹_»gs_group_t
 *
©Œ_»gs_group
, 
dvm_ch_t
 *
ch
)

614 if((
©Œ_»gs_group
!=
NULL
è&& (
ch
!=NULL)){

615 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
 = &
©Œ_»gs_group
->osd_dpram_req;

616 
osd_d´am_»q
->
İ
->
	`subm™_wr™e_osd_»ùªgË_d©a_»q
(osd_d´am_»q, 
ch
);

618 
	}
}

620 
osd_©Œibu‹_»gs_group_İ”©iÚ
 
	gosd_©Œibu‹_»gs_group_İ
 = {

621 .
š™_osd_chª_»ùªgË_©Œ_»gs_group
 = 
osd_©Œibu‹_»gs_group_š™_osd_chª_»ùªgË_©Œ_»gs_group
,

622 .
	gchª_»ùªgË_©Œ_»gs_£t
 = 
osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_£t
,

623 .
	gchª_»ùªgË_©Œ_»gs_£t_no_di¥Ïy
 = 
osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_£t_no_di¥Ïy
,

624 .
	gchª_»ùªgË_©Œ_»gs_»£t
 = 
osd_©Œibu‹_»gs_group_chª_»ùªgË_©Œ_»gs_»£t
,

625 .
	gupd©e_chª_»ùªgË_©Œ_»gs
 = 
osd_©Œibu‹_»gs_group_upd©e_chª_»ùªgË_©Œ_»gs
,

628 
	$osd_mb_tcb_»£t
(
osd_mb_ch¬_’Œy_t
 *
mb
)

630 
mb
->
»ùªgË
 = 
NULL
;

631 
mb
->
osd_mb_node
.
İ
 = &
tcb_node_İ
;

632 
mb
->
osd_mb_node
.
İ
->
	`š™
(&mb->osd_mb_node);

633 
mb
->
osd_mb_node
.
İ
->
	`£t_´iv
(&mb->osd_mb_node, mb);

635 
mb
->
ddr_·ge
 = 
INVALID_OSD_VALUE_ID
;

636 
mb
->
ddr_·ge_off£t
 = 
INVALID_OSD_VALUE_ID
;

638 
mb
->
·ylßd
 = (
u32
*)mb->
mb_ch¬_buf
;

639 
mb
->
·ylßd_Ën
 = 0;

640 
	`mem£t
(
mb
->
mb_ch¬_buf
, 0, (
OSD_MB_BUF_CHAR_BITMAP_LEN
<<2));

641 
mb
->
»f_mb_x
 = 0;

642 
mb
->
»f_mb_y
 = 0;

643 
	}
}

645 
	$osd_mb_tcb_»Ëa£
(
osd_mb_ch¬_’Œy_t
 *
mb
)

647 if(
mb
 !ğ
NULL
){

648 
osd_mb_poŞ_t
 *
poŞ
 = 
mb
->pool;

649 
mb
->
İ
->
	`»£t
(mb);

650 
poŞ
->
İ
->
	`put
ÕoŞ, 
mb
);

652 
	}
}

654 
	$osd_mb_tcb_upd©e_mb_vœtu®_d©a
(
osd_mb_ch¬_’Œy_t
 *
mb
, 
»f_mb_x
, 
»f_mb_y
)

656 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

657 
osd_©Œibu‹_»gs1
 *
±r_»gs1
;

658 
osd_©Œibu‹_»gs3
 *
±r_»gs3
;

660 
»ùªgË
 = 
mb
->rectangle;

661 if(
»ùªgË
 !ğ
NULL
){

662 
±r_»gs1
 = &
»ùªgË
->
©Œ_»gs
->
»g1_v®ue
.
»g1
;

663 
±r_»gs3
 = &
»ùªgË
->
©Œ_»gs
->
»g3_v®ue
.
»g3
;

664 
mb
->
osd_d©a_addr_ba£
 = 
	`g‘_osd_»ùªgË_mb_d©a_ba£
(
±r_»gs1
->
mode
, 
±r_»gs3
->
d©a_ba£_m­_mode
, 
»f_mb_x
, 
»f_mb_y
, 
»ùªgË
->osd_data_addr_base);

665 
	`g‘_ddr_·ge_id_ªd_·ge_off£t_by_md_d©a_ba£
(
mb
->
osd_d©a_addr_ba£
, &mb->
ddr_·ge
, &mb->
ddr_·ge_off£t
);

667 
mb
->
ddr_·ge
 = 
INVALID_OSD_VALUE_ID
;

668 
mb
->
ddr_·ge_off£t
 = 
INVALID_OSD_VALUE_ID
;

670 
	}
}

672 
	$osd_mb_tcb_upd©e_åga_osd_d©a
(
osd_mb_ch¬_’Œy_t
 *
mb
)

674 if((
mb
->
ddr_·ge
!=
INVALID_OSD_VALUE_ID
è&& (mb->
ddr_·ge_off£t
!=INVALID_OSD_VALUE_ID)){

675 
dvm_ch_t
 *
ch
;

676 
u32
 
ddr_·ge_off£t
, 
ddr_·ge
, 
Şd_ddr_·ge
, 
i
;

677 
æags
;

679 
ch
 = 
mb
->
poŞ
->chip;

680 
	`loÿl_œq_§ve
(
æags
);

681 
ddr_·ge_off£t
 = 
mb
->ddr_page_offset;

682 
ddr_·ge_off£t
 +ğ
DDRBASE
;

683 
ddr_·ge
 = 
mb
->ddr_page;

684 
Şd_ddr_·ge
 = 
ch
->
io_İ
->
	`ch_»ad32
(ch, 
DDRPAGE
);

685 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
ddr_·ge
);

686 
i
=0; i<
mb
->
·ylßd_Ën
; i++){

687 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
ddr_·ge_off£t
, 
mb
->
·ylßd
[
i
]);

688 
ddr_·ge_off£t
 += 4;

689 if(
ddr_·ge_off£t
 >ğ(
DDRBASE
<<1)){

690 
ddr_·ge_off£t
 = 
DDRBASE
;

691 
ddr_·ge
++;

692 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
ddr_·ge
);

695 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
DDRPAGE
, 
Şd_ddr_·ge
);

696 
	`loÿl_œq_»¡Üe
(
æags
);

698 
	}
}

700 
osd_mb_ch¬_İ”©iÚ
 
	gosd_mb_ch¬_tcb_İ
 =

702 .
»£t
 = 
osd_mb_tcb_»£t
,

703 .
	g»Ëa£
 = 
osd_mb_tcb_»Ëa£
,

704 .
	gupd©e_mb_vœtu®_d©a
 = 
osd_mb_tcb_upd©e_mb_vœtu®_d©a
,

705 .
	gupd©e_åga_osd_d©a
 = 
osd_mb_tcb_upd©e_åga_osd_d©a
,

708 
	$osd_’code_mb_poŞ_ü—‹
(
osd_mb_poŞ_t
 *
chª_osd_mb_buf_poŞ
, 
ch_id
)

710 if(
chª_osd_mb_buf_poŞ
 !ğ
NULL
){

711 
tcb_node_poŞ_t
 *
node_poŞ
;

712 
osd_mb_ch¬_’Œy_t
 *
±r_osd_mb_ch¬_tcb
;

713 
buf_size
, 
i
;

714 #ifdeà 
USED_STATIC_OSD_CHAR_BUF


715 
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 = 
osd_md_ÿche
[0];

717 
buf_size
 = (
osd_mb_ch¬_’Œy_t
)*
OSD_MB_ENTRY_NUMBER
;

718 
chª_osd_mb_buf_poŞ
->
mb_ch¬_ÿche_Üd”
 = 
	`g‘_Üd”
(
buf_size
);

719 
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 = (
osd_mb_ch¬_’Œy_t
*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
, chª_osd_mb_buf_poŞ->
mb_ch¬_ÿche_Üd”
);

720 if(
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 =ğ
NULL
){

721 
	`´štk
("ÿn'ˆ®loø%d…age fÜ videØbuàpoŞ\n", 
chª_osd_mb_buf_poŞ
->
mb_ch¬_ÿche_Üd”
);

722 
chª_osd_mb_buf_poŞ
->
mb_ch¬_ÿche_Üd”
 = 0;

723  -
ENOMEM
;

726 
node_poŞ
 = &
chª_osd_mb_buf_poŞ
->
osd_mb_ch¬_poŞ_tcb
;

727 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

728 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
OSD_MB_ENTRY_NUMBER
);

729 
i
=0; i<
OSD_MB_ENTRY_NUMBER
; i++){

730 
±r_osd_mb_ch¬_tcb
 = &
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
[
i
];

731 
±r_osd_mb_ch¬_tcb
->
poŞ
 = 
chª_osd_mb_buf_poŞ
;

732 
±r_osd_mb_ch¬_tcb
->
İ
 = &
osd_mb_ch¬_tcb_İ
;

733 
±r_osd_mb_ch¬_tcb
->
İ
->
	`»Ëa£
(ptr_osd_mb_char_tcb);

737  -
ENOMEM
;

738 
	}
}

740 
	$osd_’code_mb_poŞ_»Ëa£
(
osd_mb_poŞ_t
 *
chª_osd_mb_buf_poŞ
)

742 if(
chª_osd_mb_buf_poŞ
 !ğ
NULL
){

743 
tcb_node_poŞ_t
 *
node_poŞ
;

744 
node_poŞ
 = &
chª_osd_mb_buf_poŞ
->
osd_mb_ch¬_poŞ_tcb
;

745 if(
node_poŞ
->
İ
 !ğ
NULL
){

746 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

748 #ifdeà 
USED_STATIC_OSD_CHAR_BUF


749 
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 = 
NULL
;

751 if(
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 !ğ
NULL
){

752 
	`ä“_·ges
(()
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
, chª_osd_mb_buf_poŞ->
mb_ch¬_ÿche_Üd”
);

753 
chª_osd_mb_buf_poŞ
->
mb_ch¬_’Œy_ÿche
 = 
NULL
;

756 
chª_osd_mb_buf_poŞ
->
mb_ch¬_ÿche_Üd”
 = 0;

758 
	}
}

760 
	$osd_’code_mb_poŞ_g‘
(
osd_mb_poŞ_t
 *
poŞ
, 
osd_mb_ch¬_’Œy_t
 **
mb
, 
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

762 if((
poŞ
!=
NULL
è&& (
mb
!=NULL)){

763 
tcb_node_poŞ_t
 *
node_poŞ
 = &
poŞ
->
osd_mb_ch¬_poŞ_tcb
;

764 *
mb
 = 
NULL
;

765 if(
node_poŞ
->
İ
 !ğ
NULL
){

766 
tcb_node_t
 *
‹mp_node
;

767 
node_poŞ
->
İ
->
	`g‘
Òode_poŞ, &
‹mp_node
);

768 if(
‹mp_node
 !ğ
NULL
){

769 *
mb
 = 
	`to_g‘_osd_mb_ch¬_’Œy_w™h_node
(
‹mp_node
);

770 (*
mb
)->
»ùªgË
 =„ectangle;

774 
	}
}

776 
	$osd_’code_mb_poŞ_Œy_g‘
(
osd_mb_poŞ_t
 *
poŞ
, 
osd_mb_ch¬_’Œy_t
 **
mb
, 
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

778 if((
poŞ
!=
NULL
è&& (
mb
!=NULL)){

779 
tcb_node_poŞ_t
 *
node_poŞ
 = &
poŞ
->
osd_mb_ch¬_poŞ_tcb
;

780 *
mb
 = 
NULL
;

781 if(
node_poŞ
->
İ
 !ğ
NULL
){

782 
tcb_node_t
 *
‹mp_node
;

783 
node_poŞ
->
İ
->
	`Œy_g‘
Òode_poŞ, &
‹mp_node
);

784 if(
‹mp_node
 !ğ
NULL
){

785 *
mb
 = 
	`to_g‘_osd_mb_ch¬_’Œy_w™h_node
(
‹mp_node
);

786 (*
mb
)->
»ùªgË
 =„ectangle;

790 
	}
}

792 
	$osd_’code_mb_poŞ_put
(
osd_mb_poŞ_t
 *
poŞ
, 
osd_mb_ch¬_’Œy_t
 *
mb
)

794 if((
poŞ
!=
NULL
è&& (
mb
!=NULL)){

795 
tcb_node_poŞ_t
 *
node_poŞ
 = &
poŞ
->
osd_mb_ch¬_poŞ_tcb
;

796 if(
node_poŞ
->
İ
 !ğ
NULL
){

797 
node_poŞ
->
İ
->
	`put
Òode_poŞ, &
mb
->
osd_mb_node
);

800 
	}
}

802 
	$osd_’code_mb_poŞ_’Œy_numb”
(
osd_mb_poŞ_t
 *
poŞ
)

804 
’Œy_numb”
 = 0;

805 if(
poŞ
 !ğ
NULL
){

806 
tcb_node_poŞ_t
 *
node_poŞ
 = &
poŞ
->
osd_mb_ch¬_poŞ_tcb
;

807 if(
node_poŞ
->
İ
 !ğ
NULL
){

808 
’Œy_numb”
 = 
node_poŞ
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(node_pool);

811  
’Œy_numb”
;

812 
	}
}

814 
osd_mb_poŞ_İ”©iÚ
 
	gosd_’code_mb_poŞ_İ
 =

816 .
ü—‹
 = 
osd_’code_mb_poŞ_ü—‹
,

817 .
	g»Ëa£
 = 
osd_’code_mb_poŞ_»Ëa£
,

818 .
	gg‘
 = 
osd_’code_mb_poŞ_g‘
,

819 .
	gŒy_g‘
 = 
osd_’code_mb_poŞ_Œy_g‘
,

820 .
	gput
 = 
osd_’code_mb_poŞ_put
,

821 .
	gg‘_osd_mb_tcb_poŞ_’Œy_numb”
 = 
osd_’code_mb_poŞ_’Œy_numb”
,

824 
	$»move_osd_’code_mb_poŞ
(
osd_mb_poŞ_t
 *
mb_poŞ
)

826 if(
mb_poŞ
->
İ
 !ğ
NULL
){

827 
mb_poŞ
->
İ
->
	`»Ëa£
(mb_pool);

829 
	}
}

831 
	$š™_osd_’code_mb_poŞ
(
osd_chª_’gše_t
 *
osd_’gše
, 
ch_id
)

833 
»t
 = -1;

834 if(
osd_’gše
 !ğ
NULL
){

835 
osd_mb_poŞ_t
 *
mb_poŞ
;

836 
mb_poŞ
 = &
osd_’gše
->
osd_chª_poŞ
;

837 
mb_poŞ
->
ch
 = 
osd_’gše
->
’code_chª
->chip;

838 
mb_poŞ
->
İ
 = &
osd_’code_mb_poŞ_İ
;

839 
»t
 = 
mb_poŞ
->
İ
->
	`ü—‹
(mb_poŞ, 
ch_id
);

841  
»t
;

842 
	}
}

844 
	$osd_’code_chª_¡¬t_£nd_b™¡»am
(
d´am_»que¡_t
 *
d´am_»q
, *
cÚ‹xt
)

846 
»t
 = 1;

847 if((
d´am_»q
!=
NULL
è&& (
cÚ‹xt
!=NULL)){

848 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
 = (osd_»ùªgË_d´am_tcb_t*)
cÚ‹xt
;

849 
osd_»ùªgË_’Œy_t
 *
»ùªgË
 = 
	`to_osd_»ùªgË_’Œy_w™h_osd_»ùªgË_d´am_tcb
(
osd_d´am_»q
);

850 
dvm_ch_t
 *
ch
 = 
»ùªgË
->chip;

851 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

852 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

853 
osd_mb_ch¬_’Œy_t
 *
mb
;

856 if(
ch_d´am_cÚŒŞËr
->
İ
->
	`is_ÿn_subm™_move_d©a_äom_ho¡_to_d´am_£rviû_»q
(ch_d´am_cÚŒŞËr, &
osd_d´am_»q
->
d´am_·ge
)){

857 if(
»ùªgË
->
osd_’abË
){

858 if(
»ùªgË
->
Ãed_upd©e_d©a
){

859 
»ùªgË
->
Ãed_upd©e_d©a
 = 0;

861 
»ùªgË
->
İ
->
	`Œy_g‘_mb_äom_»ùªgË
ÔeùªgË, &
mb
);

862 if(
mb
 !ğ
NULL
){

863 
mb
->
İ
->
	`upd©e_mb_vœtu®_d©a
(mb, mb->
»f_mb_x
, mb->
»f_mb_y
);

864 
bur¡_š‹rçû
->
İ
->
	`pio_ho¡_to_¤am_wr™e
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
mb
->
·ylßd
, (mb->
·ylßd_Ën
<<2));

865 
bur¡_š‹rçû
->
İ
->
	`¡¬t_block_Œªsãr_äom_¤am_to_ddr
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
mb
->
osd_d©a_addr_ba£
, mb->
ddr_·ge
, (mb->
·ylßd_Ën
<<2), 
DDR_CHIP_A
);

866 
mb
->
İ
->
	`»Ëa£
(mb);

874 if(
»ùªgË
->
osd_’abË
){

875 if(
»ùªgË
->
Ãed_upd©e_d©a
){

876 
»ùªgË
->
Ãed_upd©e_d©a
 = 0;

878 
»ùªgË
->
İ
->
	`Œy_g‘_mb_äom_»ùªgË
ÔeùªgË, &
mb
);

879 if(
mb
 !ğ
NULL
){

880 
mb
->
İ
->
	`»Ëa£
(mb);

887 
	`´štk
("%s.%d:„‘rigg”\n", 
__FUNCTION__
, 
__LINE__
);

889 
osd_d´am_»q
->
İ
->
	`»¥Ú£_wr™e_osd_»ùªgË
(osd_d´am_»q, 
»ùªgË
->
ch
);

891  
»t
;

892 
	}
}

894 
	$osd_»ùªgË_d´am_tcb_š™
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
)

896 if(
osd_d´am_»q
 !ğ
NULL
){

897 
d´am_»que¡_t
 *
d´am_»q
;

898 
d´am_»q
 = &
osd_d´am_»q
->
osd_d©a_»q
;

899 
d´am_»q
->
ty³
 = 
DPRAM_BLOCK_TRANSFER_REQUEST
;

900 
d´am_»q
->
cÚ‹xt
 = (*)
osd_d´am_»q
;

901 
d´am_»q
->
»q_ÿÎback
 = 
osd_’code_chª_¡¬t_£nd_b™¡»am
;

903 
	}
}

905 
	$osd_»ùªgË_d´am_tcb_subm™_wr™e_osd_»ùªgË_d©a_»q
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

907 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

908 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

909 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

911 
»ùªgË
 = 
	`to_osd_»ùªgË_’Œy_w™h_osd_»ùªgË_d´am_tcb
(
osd_d´am_»q
);

912 
osd_d´am_»q
->
İ
->
	`š™
(osd_dpram_req);

913 
ch_d´am_cÚŒŞËr
->
İ
->
	`subm™_wr™e_video_’code_osd_d©a_»q
(ch_d´am_cÚŒŞËr, 
»ùªgË
);

915 
	}
}

917 
	$osd_»ùªgË_d´am_tcb_subm™_wr™e_osd_»ùªgË_©Œ
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

920 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

921 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

922 
dvm_ch_t
 *
ch
;

923 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
;

924 
ddr_bur¡_š‹rçû_t
 *
bur¡_š‹rçû
;

925 
osd_chª_’gše_t
 *
osd_chª_’gše
;

926 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
;

927 
»ùªgË_id
, 
chª_id
;

928 
u32
 
»g_v®ue_buf
[3];

931 
»ùªgË
 = 
	`to_osd_»ùªgË_’Œy_w™h_osd_»ùªgË_d´am_tcb
(
osd_d´am_»q
);

932 
ch
 = 
»ùªgË
->chip;

933 
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

934 
bur¡_š‹rçû
 = &
ch_d´am_cÚŒŞËr
->burst_interface;

935 
osd_chª_’gše
 = 
»ùªgË
->osd_chan_engine;

936 
©Œ_»gs
 = 
»ùªgË
->attr_regs;

937 
»ùªgË_id
 = 
»ùªgË
->rectangle_id;

938 
chª_id
 = 
»ùªgË
->chan_id;

939 if(
osd_chª_’gše
->
ma¡”OrSub
 =ğ
TW_MASTER_BITSTREAM
){

940 
©Œ_»gs
->
©Œ_»g_ba£
 = ((
OSD_ATTR_REG_BASE_ADDR
<<
OSD_ATTR_REG_SHIFT
)|(
chª_id
<<5)|(
»ùªgË_id
*3))<<2;

942 
©Œ_»gs
->
©Œ_»g_ba£
 = ((
OSD_ATTR_REG_BASE_ADDR
<<
OSD_ATTR_REG_SHIFT
)|(0x1<<9)|(
chª_id
<<5)|(
»ùªgË_id
*3))<<2;

944 
©Œ_»gs
->
»g_·ge_id
 =‡‰r_»gs->
©Œ_»g_ba£
>>19;

945 
©Œ_»gs
->
»g1_v®ue
.
»g1
.
’abË
 = 1;

946 
»g_v®ue_buf
[0] = 
©Œ_»gs
->
»g1_v®ue
.
v®ue
;

947 
»g_v®ue_buf
[1] = 
©Œ_»gs
->
»g2_v®ue
.
v®ue
;

948 
»g_v®ue_buf
[2] = 
©Œ_»gs
->
»g3_v®ue
.
v®ue
;

949 
bur¡_š‹rçû
->
İ
->
	`pio_ho¡_to_¤am_wr™e
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
»g_v®ue_buf
, 12);

950 
bur¡_š‹rçû
->
İ
->
	`¡¬t_block_Œªsãr_äom_¤am_to_ddr
(bur¡_š‹rçû, 
osd_d´am_»q
->
d´am_·ge
, 
©Œ_»gs
->
©Œ_»g_ba£
,‡‰r_»gs->
»g_·ge_id
, 12, 
DDR_CHIP_A
);

953 
	}
}

955 
	$osd_»ùªgË_d´am_tcb_»¥Ú£_wr™e_osd_»ùªgË
(
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
, 
dvm_ch_t
 *
ch
)

957 if((
osd_d´am_»q
!=
NULL
è&& (
ch
!=NULL)){

958 
d´am_cÚŒŞ_t
 *
ch_d´am_cÚŒŞËr
 = &
ch
->chip_dpram_controller;

959 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

960 
osd_chª_’gše_t
 *
osd_chª_’gše
;

962 
»ùªgË
 = 
	`to_osd_»ùªgË_’Œy_w™h_osd_»ùªgË_d´am_tcb
(
osd_d´am_»q
);

963 
osd_chª_’gše
 = 
»ùªgË
->osd_chan_engine;

964 
ch_d´am_cÚŒŞËr
->
İ
->
	`ack_wr™e_video_’code_osd_d©a_»q
(ch_d´am_cÚŒŞËr, 
»ùªgË
);

965 if(
	`©omic_»ad
(&
osd_chª_’gše
->
osd_is_wÜkšg
) > 0){

966 
	`©omic_dec
(&
osd_chª_’gše
->
osd_is_wÜkšg
);

968 if(
	`©omic_»ad
(&
osd_chª_’gše
->
osd_is_wÜkšg
) == 0){

969 
	`com¶‘e_®l
(&
osd_chª_’gše
->
wa™_dÚe
);

972 
	}
}

974 
osd_»ùªgË_d´am_tcb_İ”©iÚ
 
	gosd_»ùªgË_d´am_tcb_İ
 = {

975 .
š™
 = 
osd_»ùªgË_d´am_tcb_š™
,

976 .
	gsubm™_wr™e_osd_»ùªgË_d©a_»q
 = 
osd_»ùªgË_d´am_tcb_subm™_wr™e_osd_»ùªgË_d©a_»q
,

977 .
	gsubm™_wr™e_osd_»ùªgË_©Œ
 = 
osd_»ùªgË_d´am_tcb_subm™_wr™e_osd_»ùªgË_©Œ
,

978 .
	g»¥Ú£_wr™e_osd_»ùªgË
 = 
osd_»ùªgË_d´am_tcb_»¥Ú£_wr™e_osd_»ùªgË
,

981 
	$osd_»ùªgË_»£t
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

983 
»ùªgË
->
osd_’abË
 = 0;

984 
»ùªgË
->
Ãed_upd©e_©Œ
 = 0;

985 
»ùªgË
->
Ãed_upd©e_d©a
 = 0;

986 
»ùªgË
->
»ùªgË_mode
 = 
EMPTY_RECTANGLE_ENCODE_OSD
;

987 
»ùªgË
->
»ùªgË_Ëá_x
 =„eùªgË->
»ùªgË_Ëá_y
 = 0;

988 
»ùªgË
->
»ùªgË_right_x
 =„eùªgË->
»ùªgË_right_y
 = 0;

989 
»ùªgË
->
´iv©e_©Œi
.
em±y_»ùªgË_©Œibu‹
 = 
NULL
;

990 
	}
}

992 
	$osd_»ùªgË_şo£_»ùªgË
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

994 
osd_mb_ch¬_’Œy_t
 *
mb
;

995 
osd_chª_’gše_t
 *
osd_chª_’gše
;

996 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

998 
osd_chª_’gše
 = 
»ùªgË
->osd_chan_engine;

999 
©Œibu‹_»gs
 = &
osd_chª_’gše
->attribute_regs;

1000 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1002 
»ùªgË
->
İ
->
	`Œy_g‘_mb_äom_»ùªgË
ÔeùªgË, &
mb
);

1003 if(
mb
 !ğ
NULL
){

1004 
mb
->
İ
->
	`»Ëa£
(mb);

1009 
»ùªgË
->
İ
->
	`»£t
(rectangle);

1010 
»ùªgË
->
osd_chª_’gše
->
İ
->
	`put_»ùªgË
(rectangle->osd_chan_engine,„ectangle);

1011 
	}
}

1013 
	$osd_»ùªgË_put_mb_što_»ùªgË
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
, 
osd_mb_ch¬_’Œy_t
 *
mb
)

1015 if(
mb
 !ğ
NULL
){

1016 
tcb_node_queue_t
 *
mb_ch¬_queue
;

1017 
mb_ch¬_queue
 = &
»ùªgË
->
mb_ch¬_queue_node
;

1018 
mb_ch¬_queue
->
İ
->
	`put
(mb_ch¬_queue, &
mb
->
osd_mb_node
);

1020 
	}
}

1022 
	$osd_»ùªgË_Œy_g‘_mb_äom_»ùªgË
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
, 
osd_mb_ch¬_’Œy_t
 **
mb
)

1024 
tcb_node_queue_t
 *
mb_ch¬_queue
;

1025 
tcb_node_t
 *
‹mp_node
;

1027 
mb_ch¬_queue
 = &
»ùªgË
->
mb_ch¬_queue_node
;

1028 
mb_ch¬_queue
->
İ
->
	`Œy_g‘
(mb_ch¬_queue, &
‹mp_node
);

1029 if(
‹mp_node
 !ğ
NULL
){

1030 *
mb
 = 
	`to_g‘_osd_mb_ch¬_’Œy_w™h_node
(
‹mp_node
);

1032 *
mb
 = 
NULL
;

1034 
	}
}

1036 
	$osd_»ùªgË_upd©e_»ùªgË_åga_buf
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

1038 
»t
 = 0;

1040 if(
»ùªgË
->
osd_’abË
){

1041 if(
»ùªgË
->
Ãed_upd©e_d©a
){

1042 
osd_mb_ch¬_’Œy_t
 *
mb
;

1044 
»ùªgË
->
İ
->
	`Œy_g‘_mb_äom_»ùªgË
ÔeùªgË, &
mb
);

1045 if(
mb
 !ğ
NULL
){

1046 
mb
->
İ
->
	`upd©e_mb_vœtu®_d©a
(mb, mb->
»f_mb_x
, mb->
»f_mb_y
);

1047 
mb
->
İ
->
	`upd©e_åga_osd_d©a
(mb);

1048 
mb
->
İ
->
	`»Ëa£
(mb);

1053 
»ùªgË
->
Ãed_upd©e_d©a
 = 0;

1054 
»t
 |ğ
UPDATE_OSD_DATA_SECTION
;

1057  
»t
;

1058 
	}
}

1060 
	$osd_»ùªgË_upd©e_»ùªgË_©Œ_»gs
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

1062 
»t
 = 0;

1064 if(
»ùªgË
->
osd_’abË
){

1065 if(
»ùªgË
->
Ãed_upd©e_©Œ
){

1066 
osd_chª_’gše_t
 *
osd_chª_’gše
;

1067 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

1069 
osd_chª_’gše
 = 
»ùªgË
->osd_chan_engine;

1070 
©Œibu‹_»gs
 = &
osd_chª_’gše
->attribute_regs;

1071 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1072 
»ùªgË
->
Ãed_upd©e_©Œ
 = 0;

1073 
»t
 |ğ
UPDATE_OSD_ATTR_SECTION
;

1076  
»t
;

1077 
	}
}

1079 
	$osd_»ùªgË_decide_»ùªgË_d©a_addr_m­
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
, 
video_sourû_size
)

1081 
osd_chª_’gše_t
 *
osd_chª_’gše
 = 
»ùªgË
->osd_chan_engine;

1082 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

1083 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
;

1084 
’code_osd_mask_©Œ_t
 *
mask_©Œ
;

1085 
osd_©Œibu‹_»gs1
 *
±r_»gs1
;

1086 
osd_©Œibu‹_»gs2
 *
±r_»gs2
;

1087 
osd_©Œibu‹_»gs3
 *
±r_»gs3
;

1088 
osd_d©a_0_8_ba£_addr
, 
osd_d©a_addr_off£t_0_2
;

1090 
©Œibu‹_»gs
 = &
osd_chª_’gše
->attribute_regs;

1091 
±r_»gs1
 = &
»ùªgË
->
©Œ_»gs
->
»g1_v®ue
.
»g1
;

1092 
±r_»gs1
->
’abË
 = 0;

1093 
±r_»gs1
->
»ùªgË_mb_x_width
 = 
»ùªgË
->
»ùªgË_right_x
 -„eùªgË->
»ùªgË_Ëá_x
;

1094 
±r_»gs1
->
»ùªgË_mb_y_height
 = 
»ùªgË
->
»ùªgË_right_y
 -„eùªgË->
»ùªgË_Ëá_y
;

1095 
±r_»gs1
->
»ùªgË_mb_x
 = 
»ùªgË
->
»ùªgË_Ëá_x
;

1096 
±r_»gs1
->
»ùªgË_mb_y
 = 
»ùªgË
->
»ùªgË_Ëá_y
;

1097 
±r_»gs2
 = &
»ùªgË
->
©Œ_»gs
->
»g2_v®ue
.
»g2
;

1098 
±r_»gs2
->
mode1_äÚt_y
 = 0;

1099 
±r_»gs2
->
mode1_äÚt_u
 = 0;

1100 
±r_»gs2
->
mode1_äÚt_v
 = 0;

1101 
±r_»gs3
 = &
»ùªgË
->
©Œ_»gs
->
»g3_v®ue
.
»g3
;

1102 
±r_»gs3
->
mode1_background_y
 = 0;

1103 
±r_»gs3
->
mode1_background_u
 = 0;

1104 
±r_»gs3
->
mode1_background_v
 = 0;

1105 
±r_»gs3
->
»£rved
 = 0;

1106 
»ùªgË
->
»ùªgË_mode
){

1107 
TIMER_RECTANGLE_ENCODE_OSD
:

1108 if(
»ùªgË
->
´iv©e_©Œi
.
time_»ùªgË_©Œibu‹
==
NULL
){

1109 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1112 if(
»ùªgË
->
´iv©e_©Œi
.
time_»ùªgË_©Œibu‹
->
tim”_di¥Ïy_mode
 >ğ
DONT_DISPLAY_TIMER
){

1113 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1116 
±r_»gs1
->
mode
 = 
ENCODE_OSD_MODE0
;

1117 
±r_»gs3
->
d©a_ba£_m­_mode
 = 
Y8MB_X128MB_OSDMODE013
;

1119 
CHAR_RECTANGLE_ENCODE_OSD
:

1120 
¡ršg_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
¡ršg_»ùªgË_©Œibu‹
;

1121 if(
¡ršg_©Œ
 =ğ
NULL
){

1122 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1125 
±r_»gs1
->
mode
 = 
ENCODE_OSD_MODE0
;

1126 
±r_»gs3
->
d©a_ba£_m­_mode
 = 
¡ršg_©Œ
->
d©a_addr_m­_mode
;

1128 
MASK_RECTANGLE_ENCODE_OSD
:

1129 
mask_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
mask_»ùªgË_©Œibu‹
;

1130 if(
mask_©Œ
 =ğ
NULL
){

1131 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1134 
±r_»gs1
->
mode
 = 
ENCODE_OSD_MODE3
;

1135 
±r_»gs3
->
d©a_ba£_m­_mode
 = 
mask_©Œ
->
d©a_addr_m­_mode
;

1136 
±r_»gs2
->
mode1_äÚt_u
 = 
±r_»gs3
->
mode1_background_u
 = 
mask_©Œ
->
u_v®ue
;

1137 
±r_»gs2
->
mode1_äÚt_v
 = 
±r_»gs3
->
mode1_background_v
 = 
mask_©Œ
->
v_v®ue
;

1138 
±r_»gs2
->
mode1_äÚt_y
 = 
±r_»gs3
->
mode1_background_y
 = 
mask_©Œ
->
y_v®ue
;

1141 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1144 
»ùªgË
->
osd_d©a_addr_ba£
 = 
	`g‘_osd_»ùªg–_d©a_ba£
ÔeùªgË->
»ùªgË_id
, 
video_sourû_size
, 
osd_chª_’gše
->
ma¡”OrSub
, osd_chª_’gše->
chª_d©a_ba£
);

1145 
	`g‘_osd_»ùªg–_d©a_ba£_ªd_off£t
(
»ùªgË
->
osd_d©a_addr_ba£
, 
±r_»gs1
->
mode
, 
±r_»gs3
->
d©a_ba£_m­_mode
, &
osd_d©a_0_8_ba£_addr
, &
osd_d©a_addr_off£t_0_2
);

1146 
±r_»gs1
->
d©a_ba£_addr8
 = ((
osd_d©a_0_8_ba£_addr
>>8)&0x1);

1147 
±r_»gs2
->
d©a_ba£_addr_7_0
 = (
osd_d©a_0_8_ba£_addr
&0xff);

1148 
±r_»gs3
->
osd_d©a_add»ss_off£t
 = 
osd_d©a_addr_off£t_0_2
;

1149 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1150 
	}
}

1152 
	$osd_»ùªgË_£t_»ùªgË_m­_mode
(
osd_»ùªgË_’Œy_t
 *
»ùªgË
, 
mode
)

1154 
osd_©Œibu‹_»gs3
 *
±r_»gs3
;

1155 
±r_»gs3
 = &
»ùªgË
->
©Œ_»gs
->
»g3_v®ue
.
»g3
;

1156 
±r_»gs3
->
d©a_ba£_m­_mode
 = 
mode
;

1157 
	}
}

1159 
osd_»ùªgË_İ”©iÚ
 
	gosd_»ùªgË_İ
 =

1161 .
»£t
 = 
osd_»ùªgË_»£t
,

1162 .
	gşo£_»ùªgË
 = 
osd_»ùªgË_şo£_»ùªgË
,

1163 .
	gput_mb_što_»ùªgË
 = 
osd_»ùªgË_put_mb_što_»ùªgË
,

1164 .
	gŒy_g‘_mb_äom_»ùªgË
 = 
osd_»ùªgË_Œy_g‘_mb_äom_»ùªgË
,

1165 .
	gupd©e_»ùªgË_åga_buf
 = 
osd_»ùªgË_upd©e_»ùªgË_åga_buf
,

1166 .
	gupd©e_»ùªgË_©Œ_»gs
 = 
osd_»ùªgË_upd©e_»ùªgË_©Œ_»gs
,

1167 .
	gdecide_»ùªgË_d©a_addr_m­
 = 
osd_»ùªgË_decide_»ùªgË_d©a_addr_m­
,

1168 .
	g£t_»ùªgË_m­_mode
 = 
osd_»ùªgË_£t_»ùªgË_m­_mode
,

1171 #ifdef 
TESTING_TIMESTAMP


1172 
	$osd_chª_’gše_ü—‹_tim”_»ùªgË_‹¡šg_time¡amp
(
osd_chª_’gše_t
 *
’gše
, 
time¡amp
, 
’code_±r
, 
»f_±r
, 
ås
, 
åm
)

1174 
	$osd_chª_’gše_ü—‹_tim”_»ùªgË
(
osd_chª_’gše_t
 *
’gše
)

1177 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

1178 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

1179 
tw_h264_’code_d–_t
 *
d–
;

1180 
dvm_ch_t
 *
ch
;

1181 
ch_driv”_t
 *
ch_driv”
;

1182 
tw_video_bus_t
 *
video_bus
;

1183 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

1184 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

1185 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

1186 
’code_osd_tim”_©Œ_t
 *
tim”_©Œ
;

1187 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

1188 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1189 
osd_mb_poŞ_t
 *
mb_poŞ
;

1190 
osd_mb_ch¬_’Œy_t
 *
mb
;

1191 
osd_sy¡em_tim”_t
 *
tim”
;

1192 
u8
 *
ch¬_lib_addr
, *
¤c_buf
, *
m”ge_buf
, *
¡ršg_±r
[2], 
¡ršg_Ën
[2], 
mb_lše_width
[2], 
mb_lše_height
;

1193 
u8
 
‹mp_buf
[
YEAR_TIME_STRING_LEN
];

1194 
mb_Ëá_x
, 
mb_Ëá_y
, 
mb_lše_numb”
, 
m”ge_buf_off£t
;

1195 
i
, 
pix–_x
, 
d–_x
, 
fÚt_right_pix–
, 
fÚt_pix–_width
, 
mb_right_pix–
;

1196 
mb_couÁ
, 
ch¬_Ën
;

1197 
phy_¦Ù_id
, 
osd_¦Ù_id
;

1199 
©Œibu‹_»gs
 = &
’gše
->attribute_regs;

1200 
’code_chª
 = 
’gše
->encode_chan;

1201 
phy_¦Ù_id
 = 
’code_chª
->phy_slot_id;

1202 
d–
 = &
’code_chª
->
’code_cÚŒŞ
.
’code_d–
;

1203 
’gše
->
İ
->
	`g‘_»ùªgË
Óngše, &
»ùªgË
, 
TIMER_RECTANGLE_ENCODE_OSD
, 
TIMER_RECTANGLE_ID
);

1204 if(
»ùªgË
 =ğ
NULL
){

1207 
tim”_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
time_»ùªgË_©Œibu‹
;

1208 
tim”
 = 
tim”_©Œ
->timer;

1209 
ch
 = 
»ùªgË
->chip;

1210 
ch_driv”
 = 
ch
->chip_driver;

1211 
video_bus
 = &
ch_driv”
->video_bus;

1212 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

1213 
video_’code_ÿp
 = 
ch
->video_encode_cap;

1214 
mb_poŞ
 = &
’gše
->
osd_chª_poŞ
;

1216 if(
tim”_©Œ
->
tim”_di¥Ïy_mode
 >ğ
DONT_DISPLAY_TIMER
){

1217 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1218 
tim”_©Œ
->
Ãed_upd©e_æag
 = 0;

1220 if(
tim”_©Œ
->
Ãed_upd©e_æag
){

1221 if(
tim”
->
Ãed_upd©e_m­_bË
[
ch
->
ch_id
]&(1<<
’code_chª
->
logic_chª_id
)){

1222 #ifdeà 
TESTING_TIMESTAMP


1225 
tim”
->
Ãed_upd©e_m­_bË
[
ch
->
ch_id
] &ğ~(1<<
’code_chª
->
logic_chª_id
);

1227 
mb_Ëá_x
 = 
tim”_©Œ
->
mb_x
;

1228 
mb_Ëá_y
 = 
tim”_©Œ
->
mb_y
;

1229 
¡ršg_±r
[0] = sŒšg_±r[1] = 
‹mp_buf
;

1230 
¡ršg_Ën
[0] = string_len[1] = 0;

1231 
mb_lše_width
[0] = mb_line_width[1] = 0;

1232 
mb_lše_numb”
 = 1;

1233 
tim”_©Œ
->
tim”_di¥Ïy_mode
){

1235 
YEAR_MONTH_DAY_HOUR_MINUTE_SECOND
:

1236 #ifdef 
TESTING_TIMESTAMP


1239 
¡ršg_Ën
[0] = 
	`¢´štf
(
¡ršg_±r
[0], 
YEAR_TIME_STRING_LEN
, "[chª_%d_%c] %2.2d:%2.2d:%2.2d-%u-%d-%d %d-%d", 
»ùªgË
->
chª_id
, ((
’gše
->
ma¡”OrSub
 =ğ
TW_SUB_BITSTREAM
è? 'S' : 'M'), 
tim”
->
hour
,im”->
mšu‹
,im”->
£cÚd
, 
time¡amp
, 
’code_±r
, 
»f_±r
, 
ås
, 
åm
);

1241 
¡ršg_Ën
[0] = 
	`¢´štf
(
¡ršg_±r
[0], 
YEAR_TIME_STRING_LEN
, "%4.4d-%2.2d-%2.2d %2.2d:%2.2d:%2.2d", 
tim”
->
y—r
,im”->
mÚth
,im”->
day
,im”->
hour
,im”->
mšu‹
,im”->
£cÚd
);

1244 
YEAR_NONTH_DAY_NEWLINE_HOUR_MINUTE_SECOND_LEFT_ALIGN
:

1245 
YEAR_MONTH_DAY_NEWLINE_HOUR_MINUTE_SECOND_RIGHT_ALIGN
:

1246 
¡ršg_Ën
[0] = 
	`¢´štf
(
¡ršg_±r
[0], 
YEAR_TIME_STRING_LEN
, " %2.2d:%2.2d:%2.2d", 
tim”
->
hour
,im”->
mšu‹
,im”->
£cÚd
);

1247 
¡ršg_±r
[1] = sŒšg_±r[0] + 
¡ršg_Ën
[0] + 1;

1248 
¡ršg_Ën
[1] = 
	`¢´štf
(
¡ršg_±r
[1], 
YEAR_STRING_LEN
, "%4.4d-%2.2d-%2.2d", 
tim”
->
y—r
,im”->
mÚth
,im”->
day
);

1249 
mb_lše_numb”
++;

1252 
»ùªgË
->
»ùªgË_Ëá_x
 = 
mb_Ëá_x
;

1253 
»ùªgË
->
»ùªgË_Ëá_y
 = 
mb_Ëá_y
;

1254 
mb_lše_height
 = 0;

1255 
i
=0; i<
mb_lše_numb”
; i++){

1256 
¤c_buf
 = 
¡ršg_±r
[
i
];

1257 
pix–_x
 = 
d–_x
 = 0;

1258 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
mb_right_pix–
 = 0;

1259 
ch¬_lib_addr
 = 
m”ge_buf
 = 
NULL
;

1260 
mb_couÁ
 = 0;

1261 
ch¬_Ën
 = 0;

1262 if(
tim”_©Œ
->
fÚt_ty³
 =ğ
FONT_TYPE_12X12
){

1264 if(
mb_right_pix–
 == 0){

1265 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb
, 
»ùªgË
);

1266 
mb_right_pix–
 = 
MB_PIXEL_WIDTH
;

1267 
m”ge_buf
 = (
u8
*)
mb
->
·ylßd
;

1268 
mb
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1270 if((
fÚt_right_pix–
==0è&& (
ch¬_Ën
<
¡ršg_Ën
[
i
])){

1271 
	`g‘_lib12_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1272 if(
ch¬_lib_addr
 !ğ
NULL
){

1273 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
FONT12_PIXEL_WIDTH
;

1274 
ch¬_Ën
 += 2;

1275 
¤c_buf
 += 2;

1277 
	`g‘_ascii_lib12_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1278 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
ASCII12_PIXEL_WIDTH
;

1279 
ch¬_Ën
 += 1;

1280 
¤c_buf
 += 1;

1283 
m”ge_buf_off£t
 = 
pix–_x
%
MB_PIXEL_WIDTH
;

1284 if(
fÚt_right_pix–
 != 0){

1285 
d–_x
 = 
	`H264_MIN
(
mb_right_pix–
, 
fÚt_right_pix–
);

1287 
d–_x
 = 
mb_right_pix–
;

1289 if(
m”ge_buf
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1290 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
], 
d–_x
);

1291 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width], 
d–_x
);

1293 
pix–_x
 +ğ
d–_x
;

1294 
fÚt_right_pix–
 -ğ
d–_x
;

1295 if(
fÚt_right_pix–
 <= 0){

1296 
ch¬_lib_addr
 = 
NULL
;

1297 
fÚt_right_pix–
 = 0;

1299 
mb_right_pix–
 -ğ
d–_x
;

1300 if(
mb_right_pix–
 <= 0){

1301 
m”ge_buf
 = 
NULL
;

1302 
mb_right_pix–
 = 0;

1303 
mb
->
»f_mb_x
 = 
mb_couÁ
++;

1304 
mb
->
»f_mb_y
 = 0;

1305 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb
);

1307 }((
fÚt_right_pix–
!=0è|| (
mb_right_pix–
!=0è|| (
ch¬_Ën
 < 
¡ršg_Ën
[
i
])è&& (
pix–_x
<
WIDTH_FRAME_D1_PAL
));

1308 
mb_lše_height
++;

1310 
osd_mb_ch¬_’Œy_t
 *
mb_24
;

1311 
u8
 *
m”ge_buf_24
=
NULL
;

1313 if(
mb_right_pix–
 == 0){

1314 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb
, 
»ùªgË
);

1315 
mb_right_pix–
 = 
MB_PIXEL_WIDTH
;

1316 
m”ge_buf
 = (
u8
*)
mb
->
·ylßd
;

1317 
mb
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1318 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb_24
, 
»ùªgË
);

1319 
m”ge_buf_24
 = (
u8
*)
mb_24
->
·ylßd
;

1320 
mb_24
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1322 if((
fÚt_right_pix–
==0è&& (
ch¬_Ën
<
¡ršg_Ën
[
i
])){

1323 
	`g‘_lib24_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1324 if(
ch¬_lib_addr
 !ğ
NULL
){

1325 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
FONT24_PIXEL_WIDTH
;

1326 
ch¬_Ën
 += 2;

1327 
¤c_buf
 += 2;

1329 
	`g‘_ascii_lib24_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1330 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
ASCII24_PIXEL_WIDTH
;

1331 
ch¬_Ën
 += 1;

1332 
¤c_buf
 += 1;

1335 
m”ge_buf_off£t
 = 
pix–_x
%
MB_PIXEL_WIDTH
;

1336 if(
fÚt_right_pix–
 != 0){

1337 
d–_x
 = 
	`H264_MIN
(
mb_right_pix–
, 
fÚt_right_pix–
);

1339 
d–_x
 = 
mb_right_pix–
;

1341 if(
m”ge_buf
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1342 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
], 
d–_x
);

1343 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width], 
d–_x
);

1345 if(
m”ge_buf_24
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1346 
	`memıy
(&
m”ge_buf_24
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width+fÚt_pix–_width], 
d–_x
);

1347 
	`memıy
(&
m”ge_buf_24
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width+fÚt_pix–_width+fÚt_pix–_width], 
d–_x
);

1349 
pix–_x
 +ğ
d–_x
;

1350 
fÚt_right_pix–
 -ğ
d–_x
;

1351 if(
fÚt_right_pix–
 <= 0){

1352 
ch¬_lib_addr
 = 
NULL
;

1353 
fÚt_right_pix–
 = 0;

1355 
mb_right_pix–
 -ğ
d–_x
;

1356 if(
mb_right_pix–
 <= 0){

1357 
m”ge_buf
 = 
NULL
;

1358 
mb_right_pix–
 = 0;

1359 
mb
->
»f_mb_x
 = 
mb_couÁ
;

1360 
mb
->
»f_mb_y
 = 0;

1361 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb
);

1362 
mb_24
->
»f_mb_x
 = 
mb_couÁ
++;

1363 
mb_24
->
»f_mb_y
 = 1;

1364 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb_24
);

1366 }((
fÚt_right_pix–
!=0è|| (
mb_right_pix–
!=0è|| (
ch¬_Ën
 < 
¡ršg_Ën
[
i
])è&& (
pix–_x
<
WIDTH_FRAME_D1_PAL
));

1367 
mb_lše_height
 += 2;

1369 
mb_lše_width
[
i
] = 
mb_couÁ
;

1371 
mb_couÁ
 = 
	`H264_MAX
(
mb_lše_width
[0], mb_line_width[1]);

1372 
»ùªgË
->
»ùªgË_right_x
 = 
tim”_©Œ
->
mb_x
 + 
mb_couÁ
 - 1;

1373 
»ùªgË
->
»ùªgË_right_y
 = 
tim”_©Œ
->
mb_y
 + 
mb_lše_height
 - 1;

1374 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
phy_¦Ù_id
, &
phy_video_¦Ù
);

1375 
osd_¦Ù_id
 = 
	`g‘_phy_¦Ù_id_by_osd_chª_ba£
(
vd_bus
, 
’gše
->
chª_d©a_ba£
, 
phy_¦Ù_id
, 
video_’code_ÿp
->
ddr_m­_mode
);

1376 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
osd_¦Ù_id
, &
phy_video_¦Ù
);

1377 
’gše
->
videoSizeMode
 = 
phy_video_¦Ù
->
video_size
;

1378 
»ùªgË
->
İ
->
	`decide_»ùªgË_d©a_addr_m­
ÔeùªgË, 
’gše
->
videoSizeMode
);

1379 
»ùªgË
->
Ãed_upd©e_©Œ
 = 1;

1380 
»ùªgË
->
Ãed_upd©e_d©a
 = 1;

1381 
»ùªgË
->
osd_’abË
 = 1;

1382 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

1383 
	`©omic_šc
(&
’gše
->
osd_is_wÜkšg
);

1384 
	`š™_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

1385 
osd_d´am_»q
->
İ
->
	`subm™_wr™e_osd_»ùªgË_d©a_»q
(osd_d´am_»q, 
ch
);

1390 
	}
}

1392 
	$osd_chª_’gše_ü—‹_ch¬_»ùªgË
(
osd_chª_’gše_t
 *
’gše
, 
ty³_id
)

1394 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

1395 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

1396 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1397 
dvm_ch_t
 *
ch
;

1398 
ch_driv”_t
 *
ch_driv”
;

1399 
tw_video_bus_t
 *
video_bus
;

1400 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

1401 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

1402 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

1403 
osd_mb_poŞ_t
 *
mb_poŞ
;

1404 
osd_mb_ch¬_’Œy_t
 *
mb
;

1405 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

1406 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1407 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
;

1408 
u8
 *
ch¬_lib_addr
, *
m”ge_buf
, *
¤c_buf
;

1409 
mb_numb”
, 
ch¬_Ën
;

1410 
pix–_x
, 
d–_x
, 
fÚt_pix–_width
, 
m”ge_buf_off£t
, 
mb_right_pix–
, 
fÚt_right_pix–
, 
mb_couÁ
;

1411 
phy_¦Ù_id
, 
osd_¦Ù_id
;

1413 
©Œibu‹_»gs
 = &
’gše
->attribute_regs;

1414 
’code_chª
 = 
’gše
->encode_chan;

1415 
phy_¦Ù_id
 = 
’code_chª
->phy_slot_id;

1416 
’code_cÚŒŞ
 = &
’code_chª
->encode_control;

1417 
’gše
->
İ
->
	`g‘_»ùªgË
Óngše, &
»ùªgË
, 
CHAR_RECTANGLE_ENCODE_OSD
, 
ty³_id
);

1418 if(
»ùªgË
 =ğ
NULL
){

1421 
¡ršg_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
¡ršg_»ùªgË_©Œibu‹
;

1422 
ch
 = 
»ùªgË
->chip;

1423 
ch_driv”
 = 
ch
->chip_driver;

1424 
video_bus
 = &
ch_driv”
->video_bus;

1425 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

1426 
video_’code_ÿp
 = 
ch
->video_encode_cap;

1427 
mb_poŞ
 = &
’gše
->
osd_chª_poŞ
;

1429 if(
¡ršg_©Œ
->
¡ršg_Ën
 <= 0){

1430 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1432 if(
¡ršg_©Œ
->
Ãed_upd©e_æag
){

1433 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 0;

1434 
mb_numb”
 = (
¡ršg_©Œ
->
¡ršg_Ën
+1)>>1;

1435 if(
¡ršg_©Œ
->
fÚt_ty³
 =ğ
FONT_TYPE_12X12
){

1436 
mb_numb”
 *= 12;

1437 
mb_numb”
 += 15;

1438 
mb_numb”
 >>= 4;

1440 
mb_numb”
 *= 24;

1441 
mb_numb”
 += 15;

1442 
mb_numb”
 >>= 4;

1444 if((
mb_numb”
+
¡ršg_©Œ
->
mb_x
è< 
’code_cÚŒŞ
->
i_mb_x
){

1445 
¡ršg_©Œ
->
mb_width
 = 
mb_numb”
 - 1;

1446 
¡ršg_©Œ
->
mb_height
 = 0;

1448 
¡ršg_©Œ
->
mb_width
 = 
’code_cÚŒŞ
->
i_mb_x
 - 1 - sŒšg_©Œ->
mb_x
;

1449 
¡ršg_©Œ
->
mb_height
 = 
mb_numb”
/¡ršg_©Œ->
mb_width
;

1450 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(¡ršg_©Œ->mb_height, (
’code_cÚŒŞ
->
i_mb_y
 - 1 - sŒšg_©Œ->
mb_y
));

1452 if(
¡ršg_©Œ
->
mb_width
 < 16){

1453 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y64MB_X16MB_OSDMODE013
;

1454 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(63, string_attr->mb_height);

1455 } if(
¡ršg_©Œ
->
mb_width
 < 32){

1456 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y32MB_X32MB_OSDMODE013
;

1457 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(31, string_attr->mb_height);

1458 } if(
¡ršg_©Œ
->
mb_width
 < 64){

1459 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y16MB_X64MB_OSDMODE013
;

1460 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(15, string_attr->mb_height);

1461 } if(
¡ršg_©Œ
->
mb_width
 < 128){

1462 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y8MB_X128MB_OSDMODE013
;

1463 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(7, string_attr->mb_height);

1465 
¡ršg_©Œ
->
mb_width
 = 127;

1466 
¡ršg_©Œ
->
d©a_addr_m­_mode
 = 
Y8MB_X128MB_OSDMODE013
;

1467 
¡ršg_©Œ
->
mb_height
 = 
	`H264_MIN
(7, string_attr->mb_height);

1469 
»ùªgË
->
»ùªgË_Ëá_x
 = 
¡ršg_©Œ
->
mb_x
;

1470 
»ùªgË
->
»ùªgË_Ëá_y
 = 
¡ršg_©Œ
->
mb_y
;

1471 
»ùªgË
->
»ùªgË_right_y
 = 
¡ršg_©Œ
->
mb_y
;

1473 
¤c_buf
 = 
¡ršg_©Œ
->
¡ršg
;

1474 
pix–_x
 = 
d–_x
 = 0;

1475 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
mb_right_pix–
 = 0;

1476 
ch¬_lib_addr
 = 
m”ge_buf
 = 
NULL
;

1477 
mb_couÁ
 = 0;

1478 
ch¬_Ën
 = 0;

1479 if(
¡ršg_©Œ
->
fÚt_ty³
 =ğ
FONT_TYPE_12X12
){

1481 if(
mb_right_pix–
 == 0){

1482 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb
, 
»ùªgË
);

1483 
mb_right_pix–
 = 
MB_PIXEL_WIDTH
;

1484 
m”ge_buf
 = (
u8
*)
mb
->
·ylßd
;

1485 
mb
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1487 if((
fÚt_right_pix–
==0è&& (
ch¬_Ën
<
¡ršg_©Œ
->
¡ršg_Ën
)){

1488 
	`g‘_lib12_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1489 if(
ch¬_lib_addr
 !ğ
NULL
){

1490 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
FONT12_PIXEL_WIDTH
;

1491 
ch¬_Ën
 += 2;

1492 
¤c_buf
 += 2;

1494 
	`g‘_ascii_lib12_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1495 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
ASCII12_PIXEL_WIDTH
;

1496 
ch¬_Ën
 += 1;

1497 
¤c_buf
 += 1;

1500 
m”ge_buf_off£t
 = 
pix–_x
%
MB_PIXEL_WIDTH
;

1501 if(
fÚt_right_pix–
 != 0){

1502 
d–_x
 = 
	`H264_MIN
(
mb_right_pix–
, 
fÚt_right_pix–
);

1504 
d–_x
 = 
mb_right_pix–
;

1506 if(
m”ge_buf
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1507 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
], 
d–_x
);

1508 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width], 
d–_x
);

1510 
pix–_x
 +ğ
d–_x
;

1511 
fÚt_right_pix–
 -ğ
d–_x
;

1512 if(
fÚt_right_pix–
 <= 0){

1513 
ch¬_lib_addr
 = 
NULL
;

1514 
fÚt_right_pix–
 = 0;

1516 
mb_right_pix–
 -ğ
d–_x
;

1517 if(
mb_right_pix–
 <= 0){

1518 
m”ge_buf
 = 
NULL
;

1519 
mb_right_pix–
 = 0;

1520 
mb
->
»f_mb_x
 = 
mb_couÁ
++;

1521 
mb
->
»f_mb_y
 = 0;

1522 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb
);

1524 }((
fÚt_right_pix–
!=0è|| (
mb_right_pix–
!=0è|| (
ch¬_Ën
 < 
¡ršg_©Œ
->
¡ršg_Ën
)è&& (
pix–_x
 < 
WIDTH_FRAME_D1_PAL
));

1526 
osd_mb_ch¬_’Œy_t
 *
mb_24
;

1527 
u8
 *
m”ge_buf_24
=
NULL
;

1529 if(
mb_right_pix–
 == 0){

1530 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb
, 
»ùªgË
);

1531 
mb_right_pix–
 = 
MB_PIXEL_WIDTH
;

1532 
m”ge_buf
 = (
u8
*)
mb
->
·ylßd
;

1533 
mb
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1534 
mb_poŞ
->
İ
->
	`Œy_g‘
(mb_poŞ, &
mb_24
, 
»ùªgË
);

1535 
m”ge_buf_24
 = (
u8
*)
mb_24
->
·ylßd
;

1536 
mb_24
->
·ylßd_Ën
 = 
OSD_MB_BUF_CHAR_BITMAP_LEN
;

1538 if((
fÚt_right_pix–
==0è&& (
ch¬_Ën
<
¡ršg_©Œ
->
¡ršg_Ën
)){

1539 
	`g‘_lib24_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1540 if(
ch¬_lib_addr
 !ğ
NULL
){

1541 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
FONT24_PIXEL_WIDTH
;

1542 
ch¬_Ën
 += 2;

1543 
¤c_buf
 += 2;

1545 
	`g‘_ascii_lib24_addr
(&
ch¬_lib_addr
, 
¤c_buf
);

1546 
fÚt_right_pix–
 = 
fÚt_pix–_width
 = 
ASCII24_PIXEL_WIDTH
;

1547 
ch¬_Ën
 += 1;

1548 
¤c_buf
 += 1;

1551 
m”ge_buf_off£t
 = 
pix–_x
%
MB_PIXEL_WIDTH
;

1552 if(
fÚt_right_pix–
 != 0){

1553 
d–_x
 = 
	`H264_MIN
(
mb_right_pix–
, 
fÚt_right_pix–
);

1555 
d–_x
 = 
mb_right_pix–
;

1557 if(
m”ge_buf
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1558 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
], 
d–_x
);

1559 
	`memıy
(&
m”ge_buf
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width], 
d–_x
);

1561 if(
m”ge_buf_24
!=
NULL
 && 
ch¬_lib_addr
!=NULL){

1562 
	`memıy
(&
m”ge_buf_24
[
m”ge_buf_off£t
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width+fÚt_pix–_width], 
d–_x
);

1563 
	`memıy
(&
m”ge_buf_24
[
m”ge_buf_off£t
+
MB_PIXEL_WIDTH
], &
ch¬_lib_addr
[
fÚt_pix–_width
-
fÚt_right_pix–
+fÚt_pix–_width+fÚt_pix–_width+fÚt_pix–_width], 
d–_x
);

1565 
pix–_x
 +ğ
d–_x
;

1566 
fÚt_right_pix–
 -ğ
d–_x
;

1567 if(
fÚt_right_pix–
 <= 0){

1568 
ch¬_lib_addr
 = 
NULL
;

1569 
fÚt_right_pix–
 = 0;

1571 
mb_right_pix–
 -ğ
d–_x
;

1572 if(
mb_right_pix–
 <= 0){

1573 
m”ge_buf
 = 
NULL
;

1574 
mb_right_pix–
 = 0;

1575 
mb
->
»f_mb_x
 = 
mb_couÁ
;

1576 
mb
->
»f_mb_y
 = 0;

1577 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb
);

1578 
mb_24
->
»f_mb_x
 = 
mb_couÁ
++;

1579 
mb_24
->
»f_mb_y
 = 1;

1580 
»ùªgË
->
İ
->
	`put_mb_što_»ùªgË
ÔeùªgË, 
mb_24
);

1582 }((
fÚt_right_pix–
!=0è|| (
mb_right_pix–
!=0è|| (
ch¬_Ën
 < 
¡ršg_©Œ
->
¡ršg_Ën
)è&& (
pix–_x
 < 
WIDTH_FRAME_D1_PAL
));

1583 
»ùªgË
->
»ùªgË_right_y
++;

1585 
»ùªgË
->
»ùªgË_right_x
 = 
¡ršg_©Œ
->
mb_x
 + 
mb_couÁ
 - 1;

1586 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
phy_¦Ù_id
, &
phy_video_¦Ù
);

1587 
osd_¦Ù_id
 = 
	`g‘_phy_¦Ù_id_by_osd_chª_ba£
(
vd_bus
, 
’gše
->
chª_d©a_ba£
, 
phy_¦Ù_id
, 
video_’code_ÿp
->
ddr_m­_mode
);

1588 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
osd_¦Ù_id
, &
phy_video_¦Ù
);

1589 
’gše
->
videoSizeMode
 = 
phy_video_¦Ù
->
video_size
;

1590 
»ùªgË
->
İ
->
	`decide_»ùªgË_d©a_addr_m­
ÔeùªgË, 
’gše
->
videoSizeMode
);

1591 
»ùªgË
->
Ãed_upd©e_©Œ
 = 1;

1592 
»ùªgË
->
Ãed_upd©e_d©a
 = 1;

1593 
»ùªgË
->
osd_’abË
 = 1;

1594 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

1595 
	`©omic_šc
(&
’gše
->
osd_is_wÜkšg
);

1596 
	`š™_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

1597 
osd_d´am_»q
->
İ
->
	`subm™_wr™e_osd_»ùªgË_d©a_»q
(osd_d´am_»q, 
ch
);

1601 
	}
}

1603 
	$osd_chª_’gše_ü—‹_mask_»ùªgË
(
osd_chª_’gše_t
 *
’gše
, 
ty³_id
)

1605 
dvm_ch_t
 *
ch
;

1606 
ch_driv”_t
 *
ch_driv”
;

1607 
tw_video_bus_t
 *
video_bus
;

1608 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

1609 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

1610 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

1611 
osd_©Œibu‹_»gs_group_t
 *
©Œibu‹_»gs
;

1612 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

1613 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

1614 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

1615 
’code_osd_mask_©Œ_t
 *
mask_©Œ
;

1616 
phy_¦Ù_id
, 
osd_¦Ù_id
;

1618 
©Œibu‹_»gs
 = &
’gše
->attribute_regs;

1619 
’code_chª
 = 
’gše
->encode_chan;

1620 
ch
 = 
’code_chª
->chip;

1621 
ch_driv”
 = 
ch
->chip_driver;

1622 
video_bus
 = &
ch_driv”
->video_bus;

1623 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

1624 
video_’code_ÿp
 = 
ch
->video_encode_cap;

1625 
phy_¦Ù_id
 = 
’code_chª
->phy_slot_id;

1626 
’gše
->
İ
->
	`g‘_»ùªgË
Óngše, &
»ùªgË
, 
MASK_RECTANGLE_ENCODE_OSD
, 
ty³_id
);

1627 if(
»ùªgË
 =ğ
NULL
){

1630 
mask_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
mask_»ùªgË_©Œibu‹
;

1631 if(
mask_©Œ
->
is_di¥Ïy
 == 0){

1632 
©Œibu‹_»gs
->
chª_»ù_©Œ_»gs_group_İ
->
	`chª_»ùªgË_©Œ_»gs_»£t
×‰ribu‹_»gs, 
»ùªgË
->
»ùªgË_id
);

1634 if(
mask_©Œ
->
Ãed_upd©e_æag
){

1635 
mask_©Œ
->
Ãed_upd©e_æag
 = 0;

1636 
mask_©Œ
->
d©a_addr_m­_mode
 = 
Y32MB_X32MB_OSDMODE013
;

1637 
»ùªgË
->
»ùªgË_Ëá_x
 = 
mask_©Œ
->
mb_x
;

1638 
»ùªgË
->
»ùªgË_Ëá_y
 = 
mask_©Œ
->
mb_y
;

1639 
»ùªgË
->
»ùªgË_right_x
 = 
mask_©Œ
->
mb_x
 + mask_©Œ->
mask_width
;

1640 
»ùªgË
->
»ùªgË_right_y
 = 
mask_©Œ
->
mb_y
 + mask_©Œ->
mask_height
;

1641 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
phy_¦Ù_id
, &
phy_video_¦Ù
);

1642 
osd_¦Ù_id
 = 
	`g‘_phy_¦Ù_id_by_osd_chª_ba£
(
vd_bus
, 
’gše
->
chª_d©a_ba£
, 
phy_¦Ù_id
, 
video_’code_ÿp
->
ddr_m­_mode
);

1643 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
osd_¦Ù_id
, &
phy_video_¦Ù
);

1644 
’gše
->
videoSizeMode
 = 
phy_video_¦Ù
->
video_size
;

1645 
»ùªgË
->
İ
->
	`decide_»ùªgË_d©a_addr_m­
ÔeùªgË, 
’gše
->
videoSizeMode
);

1646 
»ùªgË
->
osd_’abË
 = 1;

1647 
»ùªgË
->
Ãed_upd©e_©Œ
 = 1;

1648 
»ùªgË
->
Ãed_upd©e_d©a
 = 1;

1649 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

1650 
	`©omic_šc
(&
’gše
->
osd_is_wÜkšg
);

1651 
	`š™_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

1652 
osd_d´am_»q
->
İ
->
	`subm™_wr™e_osd_»ùªgË_d©a_»q
(osd_d´am_»q, 
»ùªgË
->
ch
);

1656 
	}
}

1659 #ifdef 
TESTING_TIMESTAMP


1660 
	$osd_chª_’gše_ü—‹_»ùªgË_‹¡šg_time¡amp
(
osd_chª_’gše_t
 *
’gše
, 
TW_OSD_PARAM
 *
osd_ruÂšg_·¿m
, 
time¡amp
, 
’code_±r
, 
»f_±r
, 
ås
, 
åm
)

1662 
	$osd_chª_’gše_ü—‹_»ùªgË
(
osd_chª_’gše_t
 *
’gše
, 
TW_OSD_PARAM
 *
osd_ruÂšg_·¿m
)

1665 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
;

1666 
’code_osd_tim”_©Œ_t
 *
tim”_©Œ
;

1667 
’code_osd_mask_©Œ_t
 *
mask_©Œ
;

1668 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

1669 
tw_h264_phy_video_¦Ù_t
 *
ma¡”_¦Ù
;

1670 
tw_h264_’code_cÚŒŞ_t
 *
’code_cÚŒŞ
;

1671 
æags
;

1673 if(
	`©omic_»ad
(&
’gše
->
osd_is_wÜkšg
)){

1676 
	`¥š_lock_œq§ve
(&
’gše
->
osd_lock
, 
æags
);

1677 if(
	`©omic_»ad
(&
’gše
->
sync_osd_·¿m
)){

1678 
	`TW_DBG
(
TW_DBG_INFO
, "sync channel osdo hardware\n");

1679 
	`©omic_£t
(&
’gše
->
sync_osd_·¿m
, 0);

1680 
’code_chª
 = 
’gše
->encode_chan;

1681 
’code_cÚŒŞ
 = &
’code_chª
->encode_control;

1682 
ma¡”_¦Ù
 = 
’code_chª
->master_slot;

1683 
tim”_©Œ
 = &
’gše
->timer_attr;

1684 if((
osd_ruÂšg_·¿m
->
time_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1685 
tim”_©Œ
->
Ãed_upd©e_æag
 = 1;

1686 
tim”_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
time_pos_x
>>4;

1687 
tim”_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
time_pos_y
>>4;

1688 
tim”_©Œ
->
mb_x
 = 
	`H264_MIN
Ñim”_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1689 
tim”_©Œ
->
mb_y
 = 
	`H264_MIN
Ñim”_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1690 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
YEAR_MONTH_DAY_HOUR_MINUTE_SECOND
;

1691 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1692 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1694 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1696 if(
ma¡”_¦Ù
) {

1697 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1698 
TW_VIDEO_SIZE_D1
:

1699 
TW_VIDEO_SIZE_HALF_D1
:

1700 
TW_VIDEO_SIZE_USER
:

1701 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1704 
TW_VIDEO_SIZE_CIF
:

1705 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1709 
tim”_©Œ
->
mb_x
 = 0;

1710 
tim”_©Œ
->
mb_y
 = 0;

1711 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1713 
tim”_©Œ
->
İ
->
	`»£t
Ñim”_©Œ, 
’gše
->
’code_chª
->
ch
->
ch_id
,ƒngše->’code_chª->
logic_chª_id
);

1715 
tim”_©Œ
->
mb_x
 = 0;

1716 
tim”_©Œ
->
mb_y
 = 0;

1717 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1720 
¡ršg_©Œ
 = &
’gše
->¡ršg_©Œ[
CHAN_NAME_RECTANGLE_ID
-1];

1721 if((
osd_ruÂšg_·¿m
->
Çme_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1722 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 1;

1723 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1724 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1726 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1728 if(
ma¡”_¦Ù
) {

1729 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1730 
TW_VIDEO_SIZE_D1
:

1731 
TW_VIDEO_SIZE_HALF_D1
:

1732 
TW_VIDEO_SIZE_USER
:

1733 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1736 
TW_VIDEO_SIZE_CIF
:

1737 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1741 
tim”_©Œ
->
mb_x
 = 0;

1742 
tim”_©Œ
->
mb_y
 = 0;

1743 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1745 
¡ršg_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
Çme_pos_x
>>4;

1746 
¡ršg_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
Çme_pos_y
>>4;

1747 
¡ršg_©Œ
->
mb_x
 = 
	`H264_MIN
(¡ršg_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1748 
¡ršg_©Œ
->
mb_y
 = 
	`H264_MIN
(¡ršg_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1749 
¡ršg_©Œ
->
mb_height
 = 0;

1750 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`¡¾’
(
osd_ruÂšg_·¿m
->
Çme
);

1751 if(
¡ršg_©Œ
->
¡ršg_Ën
>0){

1752 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`H264_MIN
(¡ršg_©Œ->¡ršg_Ën, 
NAME_LEN
);

1753 
¡ršg_©Œ
->
¡ršg
 = 
osd_ruÂšg_·¿m
->
Çme
;

1754 
¡ršg_©Œ
->
mb_width
 = ((¡ršg_©Œ->
¡ršg_Ën
+1)>>1) - 1;

1756 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1759 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

1760 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

1762 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1765 
mask_©Œ
 = &
’gše
->mask_©Œ[
SHELTER1_RECTANGLE_ID
-1];

1766 if((
osd_ruÂšg_·¿m
->
sh–‹r1_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1767 
mask_©Œ
->
Ãed_upd©e_æag
 = 1;

1768 
mask_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
sh–‹r1_pos_x
>>4;

1769 
mask_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
sh–‹r1_pos_y
>>4;

1770 
mask_©Œ
->
mb_x
 = 
	`H264_MIN
(mask_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1);

1771 
mask_©Œ
->
mb_y
 = 
	`H264_MIN
(mask_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1);

1772 
mask_©Œ
->
mask_width
 = 
osd_ruÂšg_·¿m
->
sh–‹r1_width
>>4;

1773 
mask_©Œ
->
mask_height
 = 
osd_ruÂšg_·¿m
->
sh–‹r1_height
>>4;

1774 
mask_©Œ
->
mask_width
 = 
	`H264_MIN
(mask_©Œ->mask_width, 
’code_cÚŒŞ
->
i_mb_x
-mask_©Œ->
mb_x
);

1775 
mask_©Œ
->
mask_height
 = 
	`H264_MIN
(mask_©Œ->mask_height, 
’code_cÚŒŞ
->
i_mb_y
-mask_©Œ->
mb_y
);

1776 
mask_©Œ
->
u_v®ue
 = 0x80;

1777 
mask_©Œ
->
v_v®ue
 = 0x80;

1778 
mask_©Œ
->
y_v®ue
 = 0x10;

1779 
mask_©Œ
->
is_di¥Ïy
 = 1;

1781 
mask_©Œ
->
is_di¥Ïy
 = 0;

1784 
mask_©Œ
 = &
’gše
->mask_©Œ[
SHELTER2_RECTANGLE_ID
-1];

1785 if((
osd_ruÂšg_·¿m
->
sh–‹r2_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1786 
mask_©Œ
->
Ãed_upd©e_æag
 = 1;

1787 
mask_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
sh–‹r2_pos_x
>>4;

1788 
mask_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
sh–‹r2_pos_y
>>4;

1789 
mask_©Œ
->
mb_x
 = 
	`H264_MIN
(mask_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1);

1790 
mask_©Œ
->
mb_y
 = 
	`H264_MIN
(mask_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1);

1791 
mask_©Œ
->
mask_width
 = 
osd_ruÂšg_·¿m
->
sh–‹r2_width
>>4;

1792 
mask_©Œ
->
mask_height
 = 
osd_ruÂšg_·¿m
->
sh–‹r2_height
>>4;

1793 
mask_©Œ
->
mask_width
 = 
	`H264_MIN
(mask_©Œ->mask_width, 
’code_cÚŒŞ
->
i_mb_x
-mask_©Œ->
mb_x
);

1794 
mask_©Œ
->
mask_height
 = 
	`H264_MIN
(mask_©Œ->mask_height, 
’code_cÚŒŞ
->
i_mb_y
-mask_©Œ->
mb_y
);

1795 
mask_©Œ
->
u_v®ue
 = 0x80;

1796 
mask_©Œ
->
v_v®ue
 = 0x80;

1797 
mask_©Œ
->
y_v®ue
 = 0x10;

1798 
mask_©Œ
->
is_di¥Ïy
 = 1;

1800 
mask_©Œ
->
is_di¥Ïy
 = 0;

1803 
¡ršg_©Œ
 = &
’gše
->¡ršg_©Œ[
SUBTILTE1_RECTANGLE_ID
-1];

1804 if((
osd_ruÂšg_·¿m
->
subt™Ë1_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1805 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 1;

1806 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1807 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1809 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1811 if(
ma¡”_¦Ù
) {

1812 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1813 
TW_VIDEO_SIZE_D1
:

1814 
TW_VIDEO_SIZE_HALF_D1
:

1815 
TW_VIDEO_SIZE_USER
:

1816 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1819 
TW_VIDEO_SIZE_CIF
:

1820 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1824 
tim”_©Œ
->
mb_x
 = 0;

1825 
tim”_©Œ
->
mb_y
 = 0;

1826 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1828 
¡ršg_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
subt™Ë1_pos_x
>>4;

1829 
¡ršg_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
subt™Ë1_pos_y
>>4;

1830 
¡ršg_©Œ
->
mb_x
 = 
	`H264_MIN
(¡ršg_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1831 
¡ršg_©Œ
->
mb_y
 = 
	`H264_MIN
(¡ršg_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1832 
¡ršg_©Œ
->
mb_height
 = 0;

1833 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`¡¾’
(
osd_ruÂšg_·¿m
->
subt™Ë1
);

1834 if(
¡ršg_©Œ
->
¡ršg_Ën
 > 0){

1835 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`H264_MIN
(¡ršg_©Œ->¡ršg_Ën, 
SUB_LEN
);

1836 
¡ršg_©Œ
->
¡ršg
 = 
osd_ruÂšg_·¿m
->
subt™Ë1
;

1837 
¡ršg_©Œ
->
mb_width
 = ((¡ršg_©Œ->
¡ršg_Ën
+1)>>1) - 1;

1839 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1842 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

1843 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

1845 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1848 
¡ršg_©Œ
 = &
’gše
->¡ršg_©Œ[
SUBTILTE2_RECTANGLE_ID
-1];

1849 if((
osd_ruÂšg_·¿m
->
subt™Ë2_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1850 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 1;

1851 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1852 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1854 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1856 if(
ma¡”_¦Ù
) {

1857 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1858 
TW_VIDEO_SIZE_D1
:

1859 
TW_VIDEO_SIZE_HALF_D1
:

1860 
TW_VIDEO_SIZE_USER
:

1861 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1864 
TW_VIDEO_SIZE_CIF
:

1865 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1869 
tim”_©Œ
->
mb_x
 = 0;

1870 
tim”_©Œ
->
mb_y
 = 0;

1871 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1873 
¡ršg_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
subt™Ë2_pos_x
>>4;

1874 
¡ršg_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
subt™Ë2_pos_y
>>4;

1875 
¡ršg_©Œ
->
mb_x
 = 
	`H264_MIN
(¡ršg_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1876 
¡ršg_©Œ
->
mb_y
 = 
	`H264_MIN
(¡ršg_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1877 
¡ršg_©Œ
->
mb_height
 = 0;

1878 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`¡¾’
(
osd_ruÂšg_·¿m
->
subt™Ë2
);

1879 if(
¡ršg_©Œ
->
¡ršg_Ën
 > 0){

1880 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`H264_MIN
(¡ršg_©Œ->¡ršg_Ën, 
SUB_LEN
);

1881 
¡ršg_©Œ
->
¡ršg
 = 
osd_ruÂšg_·¿m
->
subt™Ë2
;

1882 
¡ršg_©Œ
->
mb_width
 = ((¡ršg_©Œ->
¡ršg_Ën
+1)>>1) - 1;

1884 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1887 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1888 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

1889 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

1891 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1894 
¡ršg_©Œ
 = &
’gše
->¡ršg_©Œ[
SUBTILTE3_RECTANGLE_ID
-1];

1895 if((
osd_ruÂšg_·¿m
->
subt™Ë3_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1896 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 1;

1897 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1898 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1900 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1902 if(
ma¡”_¦Ù
) {

1903 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1904 
TW_VIDEO_SIZE_D1
:

1905 
TW_VIDEO_SIZE_HALF_D1
:

1906 
TW_VIDEO_SIZE_USER
:

1907 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1910 
TW_VIDEO_SIZE_CIF
:

1911 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1915 
tim”_©Œ
->
mb_x
 = 0;

1916 
tim”_©Œ
->
mb_y
 = 0;

1917 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1919 
¡ršg_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
subt™Ë3_pos_x
>>4;

1920 
¡ršg_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
subt™Ë3_pos_y
>>4;

1921 
¡ršg_©Œ
->
mb_x
 = 
	`H264_MIN
(¡ršg_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1922 
¡ršg_©Œ
->
mb_y
 = 
	`H264_MIN
(¡ršg_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1923 
¡ršg_©Œ
->
mb_height
 = 0;

1924 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`¡¾’
(
osd_ruÂšg_·¿m
->
subt™Ë3
);

1925 if(
¡ršg_©Œ
->
¡ršg_Ën
 > 0){

1926 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`H264_MIN
(¡ršg_©Œ->¡ršg_Ën, 
SUB_LEN
);

1927 
¡ršg_©Œ
->
¡ršg
 = 
osd_ruÂšg_·¿m
->
subt™Ë3
;

1928 
¡ršg_©Œ
->
mb_width
 = ((¡ršg_©Œ->
¡ršg_Ën
+1)>>1) - 1;

1930 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1933 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1934 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

1935 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

1937 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1940 
¡ršg_©Œ
 = &
’gše
->¡ršg_©Œ[
SUBTILTE4_RECTANGLE_ID
-1];

1941 if((
osd_ruÂšg_·¿m
->
subt™Ë4_©Œib
&
OSD_ATTR_DISPLAY_ON
) == OSD_ATTR_DISPLAY_ON){

1942 
¡ršg_©Œ
->
Ãed_upd©e_æag
 = 1;

1943 if(
’code_chª
->
ty³
 =ğ
TW_MASTER_BITSTREAM
){

1944 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1946 
¡ršg_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1948 if(
ma¡”_¦Ù
) {

1949 
’code_chª
->
’code_´İ”ty
.’code_´İ”ty.
’codeSize
){

1950 
TW_VIDEO_SIZE_D1
:

1951 
TW_VIDEO_SIZE_HALF_D1
:

1952 
TW_VIDEO_SIZE_USER
:

1953 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_24X24
;

1956 
TW_VIDEO_SIZE_CIF
:

1957 
tim”_©Œ
->
fÚt_ty³
 = 
FONT_TYPE_12X12
;

1961 
tim”_©Œ
->
mb_x
 = 0;

1962 
tim”_©Œ
->
mb_y
 = 0;

1963 
tim”_©Œ
->
tim”_di¥Ïy_mode
 = 
DONT_DISPLAY_TIMER
;

1965 
¡ršg_©Œ
->
mb_x
 = 
osd_ruÂšg_·¿m
->
subt™Ë4_pos_x
>>4;

1966 
¡ršg_©Œ
->
mb_y
 = 
osd_ruÂšg_·¿m
->
subt™Ë4_pos_y
>>4;

1967 
¡ršg_©Œ
->
mb_x
 = 
	`H264_MIN
(¡ršg_©Œ->mb_x, 
’code_cÚŒŞ
->
i_mb_x
-1-
CHAR_RECTANGLE_X_LEFT
);

1968 
¡ršg_©Œ
->
mb_y
 = 
	`H264_MIN
(¡ršg_©Œ->mb_y, 
’code_cÚŒŞ
->
i_mb_y
-1-
CHAR_RECTANGLE_Y_LEFT
);

1969 
¡ršg_©Œ
->
mb_height
 = 0;

1970 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`¡¾’
(
osd_ruÂšg_·¿m
->
subt™Ë4
);

1971 if(
¡ršg_©Œ
->
¡ršg_Ën
 > 0){

1972 
¡ršg_©Œ
->
¡ršg_Ën
 = 
	`H264_MIN
(¡ršg_©Œ->¡ršg_Ën, 
SUB_LEN
);

1973 
¡ršg_©Œ
->
¡ršg
 = 
osd_ruÂšg_·¿m
->
subt™Ë4
;

1974 
¡ršg_©Œ
->
mb_width
 = ((¡ršg_©Œ->
¡ršg_Ën
+1)>>1) - 1;

1976 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1979 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1980 if(
¡ršg_©Œ
->
¡ršg
 !ğ
NULL
){

1981 
¡ršg_©Œ
->
¡ršg
 = 
NULL
;

1983 
¡ršg_©Œ
->
¡ršg_Ën
 = 0;

1986 
	`¥š_uÆock_œq»¡Üe
(&
’gše
->
osd_lock
, 
æags
);

1987 #ifdef 
TESTING_TIMESTAMP


1988 
’gše
->
İ
->
	`ü—‹_tim”_»ùªgË
Óngše, 
time¡amp
, 
’code_±r
, 
»f_±r
, 
ås
, 
åm
);

1990 
’gše
->
İ
->
	`ü—‹_tim”_»ùªgË
(engine);

1992 
’gše
->
İ
->
	`ü—‹_ch¬_»ùªgË
Óngše, 
CHAN_NAME_RECTANGLE_ID
);

1993 
’gše
->
İ
->
	`ü—‹_mask_»ùªgË
Óngše, 
SHELTER1_RECTANGLE_ID
);

1994 
’gše
->
İ
->
	`ü—‹_mask_»ùªgË
Óngše, 
SHELTER2_RECTANGLE_ID
);

1995 
’gše
->
İ
->
	`ü—‹_ch¬_»ùªgË
Óngše, 
SUBTILTE1_RECTANGLE_ID
);

1996 
’gše
->
İ
->
	`ü—‹_ch¬_»ùªgË
Óngše, 
SUBTILTE2_RECTANGLE_ID
);

1997 
’gše
->
İ
->
	`ü—‹_ch¬_»ùªgË
Óngše, 
SUBTILTE3_RECTANGLE_ID
);

1998 
’gše
->
İ
->
	`ü—‹_ch¬_»ùªgË
Óngše, 
SUBTILTE4_RECTANGLE_ID
);

1999 
’gše
->
İ
->
	`upd©e_åga_osd_’code
(engine);

2001 
	}
}

2003 
	$osd_chª_’gše_şo£_»ùªgËs
(
osd_chª_’gše_t
 *
’gše
)

2005 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

2006 
i
;

2008 
»ùªgË
 = 
’gše
->rectangle;

2009 
i
=0; i<
OSD_CHAN_RECTANGLE_NUMBER
; i++){

2010 
»ùªgË
->
İ
->
	`şo£_»ùªgË
(rectangle);

2011 
»ùªgË
++;

2014 
	}
}

2016 
	$osd_chª_’gše_upd©e_’code_osd_´İ”ty
(
osd_chª_’gše_t
 *
’gše
, 
TW_OSD_PARAM
 *
osd_cÚfig_·¿m
)

2018 
TW_OSD_PARAM
 *
osd_ruÂšg_·¿m
 = &
’gše
->osd_running_param;

2019 if(
osd_cÚfig_·¿m
 !ğ
NULL
){

2020 
æags
;

2021 
	`¥š_lock_œq§ve
(&
’gše
->
osd_lock
, 
æags
);

2022 
	`memıy
((*)
osd_ruÂšg_·¿m
, (*)
osd_cÚfig_·¿m
, (
TW_OSD_PARAM
));

2023 
	`©omic_£t
(&
’gše
->
sync_osd_·¿m
, 1);

2024 
	`¥š_uÆock_œq»¡Üe
(&
’gše
->
osd_lock
, 
æags
);

2026 
	}
}

2028 
	$osd_chª_’gše_upd©e_åga_osd_’code
(
osd_chª_’gše_t
 *
’gše
)

2030 
dvm_ch_t
 *
ch
;

2032 if(
	`©omic_»ad
(&
’gše
->
osd_is_wÜkšg
)){

2035 
ch
 = 
’gše
->
’code_chª
->chip;

2036 
	`©omic_šc
(&
’gše
->
osd_is_wÜkšg
);

2037 
	`š™_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

2038 
’gše
->
©Œibu‹_»gs
.
chª_»ù_©Œ_»gs_group_İ
->
	`upd©e_chª_»ùªgË_©Œ_»gs
(&’gše->©Œibu‹_»gs, 
ch
);

2039 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
OSD_ATTRI_BASE_REG
, 
OSD_ATTR_REG_BASE_ADDR
);

2040 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
OSD_RECTANGLE_EN_REG
, 0xff);

2041 
ch
->
io_İ
->
	`ch_wr™e32
(ch, 
OSD_ATTRI_UPDATE_REG
, 
’gše
->
’code_chª
->
phy_¦Ù_id
);

2042 
	}
}

2044 
	$osd_chª_’gše_g‘_»ùªgË
(
osd_chª_’gše_t
 *
’gše
, 
osd_»ùªgË_’Œy_t
 **
»ùªgË
, 
ty³
, 
ty³_id
)

2046 *
»ùªgË
 = 
NULL
;

2047 if(
ty³_id
>
SHELTER2_RECTANGLE_ID
 ||ype_id<0){

2050 
’gše
->
chª_»ùªgË_u£d_m­_bË
 |ğ1<<
ty³_id
;

2051 *
»ùªgË
 = &
’gše
->»ùªgË[
ty³_id
];

2052 (*
»ùªgË
)->
»ùªgË_mode
 = 
ty³
;

2053 
ty³
){

2054 
TIMER_RECTANGLE_ENCODE_OSD
:

2055 (*
»ùªgË
)->
´iv©e_©Œi
.
time_»ùªgË_©Œibu‹
 = &
’gše
->
tim”_©Œ
;

2057 
CHAR_RECTANGLE_ENCODE_OSD
:

2058 (*
»ùªgË
)->
´iv©e_©Œi
.
¡ršg_»ùªgË_©Œibu‹
 = &
’gše
->
¡ršg_©Œ
[
ty³_id
-1];

2060 
MASK_RECTANGLE_ENCODE_OSD
:

2061 (*
»ùªgË
)->
´iv©e_©Œi
.
mask_»ùªgË_©Œibu‹
 = &
’gše
->
mask_©Œ
[
ty³_id
-1];

2064 
’gše
->
chª_»ùªgË_u£d_m­_bË
 &ğ~(1<<
ty³_id
);

2065 (*
»ùªgË
)->
´iv©e_©Œi
.
em±y_»ùªgË_©Œibu‹
 = 
NULL
;

2066 
	`´štk
("rectangle'sype isn't know\n");

2069 
	}
}

2071 
	$osd_chª_’gše_put_»ùªgË
(
osd_chª_’gše_t
 *
’gše
, 
osd_»ùªgË_’Œy_t
 *
»ùªgË
)

2073 
’code_osd_tim”_©Œ_t
 *
tim”_©Œ
;

2074 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
;

2075 
’code_osd_mask_©Œ_t
 *
mask_©Œ
;

2077 if(
»ùªgË
->
»ùªgË_id
 !ğ
INVALID_OSD_VALUE_ID
){

2078 
»ùªgË
->
»ùªgË_mode
){

2079 
TIMER_RECTANGLE_ENCODE_OSD
:

2080 
tim”_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
time_»ùªgË_©Œibu‹
;

2081 if(
tim”_©Œ
 !ğ
NULL
){

2082 
tim”_©Œ
->
İ
->
	`»£t
Ñim”_©Œ, 
’gše
->
’code_chª
->
ch
->
ch_id
,ƒngše->’code_chª->
logic_chª_id
);

2085 
CHAR_RECTANGLE_ENCODE_OSD
:

2086 
¡ršg_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
¡ršg_»ùªgË_©Œibu‹
;

2087 if(
¡ršg_©Œ
 !ğ
NULL
){

2088 
¡ršg_©Œ
->
İ
->
	`»£t
(string_attr);

2091 
MASK_RECTANGLE_ENCODE_OSD
:

2092 
mask_©Œ
 = 
»ùªgË
->
´iv©e_©Œi
.
mask_»ùªgË_©Œibu‹
;

2093 if(
mask_©Œ
 !ğ
NULL
){

2094 
mask_©Œ
->
İ
->
	`»£t
(mask_attr);

2098 
	`´štk
("%s.%d:‚ØsuµÜˆmod%d\n", 
__FUNCTION__
, 
__LINE__
, 
»ùªgË
->
»ùªgË_mode
);

2101 
’gše
->
chª_»ùªgË_u£d_m­_bË
 &ğ~(1<<
»ùªgË
->
»ùªgË_id
);

2103 
	}
}

2105 
osd_chª_’gše_İ”©iÚ
 
	gosd_chª_’gše_İ
 =

2107 .
ü—‹_ch¬_»ùªgË
 = 
osd_chª_’gše_ü—‹_ch¬_»ùªgË
,

2108 .
	gü—‹_mask_»ùªgË
 = 
osd_chª_’gše_ü—‹_mask_»ùªgË
,

2109 #ifdef 
TESTING_TIMESTAMP


2110 .
	gü—‹_tim”_»ùªgË
 = 
osd_chª_’gše_ü—‹_tim”_»ùªgË_‹¡šg_time¡amp
,

2111 .
	gü—‹_»ùªgË
 = 
osd_chª_’gše_ü—‹_»ùªgË_‹¡šg_time¡amp
,

2113 .
	gü—‹_tim”_»ùªgË
 = 
osd_chª_’gše_ü—‹_tim”_»ùªgË
,

2114 .
	gü—‹_»ùªgË
 = 
osd_chª_’gše_ü—‹_»ùªgË
,

2116 .
	gşo£_chª_’gše_»ùªgËs
 = 
osd_chª_’gše_şo£_»ùªgËs
,

2117 .
	gupd©e_’code_osd_´İ”ty
 = 
osd_chª_’gše_upd©e_’code_osd_´İ”ty
,

2119 .
	gupd©e_åga_osd_’code
 = 
osd_chª_’gše_upd©e_åga_osd_’code
,

2120 .
	gg‘_»ùªgË
 = 
osd_chª_’gše_g‘_»ùªgË
,

2121 .
	gput_»ùªgË
 = 
osd_chª_’gše_put_»ùªgË
,

2125 
	$şo£_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *
’gše
)

2127 if(
	`©omic_»ad
(&
’gše
->
osd_is_wÜkšg
) == 0){

2128 
	`com¶‘e_®l
(&
’gše
->
wa™_dÚe
);

2130 
	`wa™_fÜ_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

2131 
’gše
->
İ
->
	`şo£_chª_’gše_»ùªgËs
(engine);

2132 
	}
}

2134 
	$»move_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *
’gše
)

2136 
	`şo£_’code_osd_chª_’gše
(
’gše
);

2137 
	`»move_osd_’code_mb_poŞ
(&
’gše
->
osd_chª_poŞ
);

2138 
	}
}

2140 
	$osd_‹¡šg_š™
(
osd_chª_’gše_t
 *
’gše
)

2142 
TW_OSD_PARAM
 *
osd_cÚfig_·¿m
, 
cÚfig_·¿m
;

2144 
osd_cÚfig_·¿m
 = &
cÚfig_·¿m
;

2145 
	`mem£t
((*)
osd_cÚfig_·¿m
, 0, (
TW_OSD_PARAM
));

2148 
	`¥rštf
(
osd_cÚfig_·¿m
->
Çme
, "Video chan‚ame");

2149 
	`´štk
("%s,†’=%d\n", 
osd_cÚfig_·¿m
->
Çme
, 
	`¡¾’
(osd_config_param->name));

2150 
osd_cÚfig_·¿m
->
Çme_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2151 
osd_cÚfig_·¿m
->
Çme_pos_x
 = 50;

2152 
osd_cÚfig_·¿m
->
Çme_pos_y
 = 50;

2154 
osd_cÚfig_·¿m
->
time_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2155 
osd_cÚfig_·¿m
->
time_pos_x
 = 0;

2156 
osd_cÚfig_·¿m
->
time_pos_y
 = 0;

2158 
osd_cÚfig_·¿m
->
sh–‹r1_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2159 
osd_cÚfig_·¿m
->
sh–‹r1_pos_x
 = 0;

2160 
osd_cÚfig_·¿m
->
sh–‹r1_pos_y
 = 50;

2161 
osd_cÚfig_·¿m
->
sh–‹r1_width
 = 20;

2162 
osd_cÚfig_·¿m
->
sh–‹r1_height
 = 20;

2163 
osd_cÚfig_·¿m
->
sh–‹r2_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2164 
osd_cÚfig_·¿m
->
sh–‹r2_pos_x
 = 0;

2165 
osd_cÚfig_·¿m
->
sh–‹r2_pos_y
 = 100;

2166 
osd_cÚfig_·¿m
->
sh–‹r2_width
 = 50;

2167 
osd_cÚfig_·¿m
->
sh–‹r2_height
 = 50;

2168 
	`¥rštf
(
osd_cÚfig_·¿m
->
subt™Ë1
, "subtitle1 windowest");

2169 
	`´štk
("%s,†’=%d\n", 
osd_cÚfig_·¿m
->
subt™Ë1
, 
	`¡¾’
(osd_config_param->subtitle1));

2170 
osd_cÚfig_·¿m
->
subt™Ë1_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2171 
osd_cÚfig_·¿m
->
subt™Ë1_pos_x
 = 100;

2172 
osd_cÚfig_·¿m
->
subt™Ë1_pos_y
 = 100;

2173 
	`¥rštf
(
osd_cÚfig_·¿m
->
subt™Ë2
, "subtitle2 windowest");

2174 
	`´štk
("%s,†’=%d\n", 
osd_cÚfig_·¿m
->
subt™Ë2
, 
	`¡¾’
(osd_config_param->subtitle2));

2175 
osd_cÚfig_·¿m
->
subt™Ë2_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2176 
osd_cÚfig_·¿m
->
subt™Ë2_pos_x
 = 150;

2177 
osd_cÚfig_·¿m
->
subt™Ë2_pos_y
 = 150;

2178 
	`¥rštf
(
osd_cÚfig_·¿m
->
subt™Ë3
, "subtitle3 windowest");

2179 
	`´štk
("%s,†’=%d\n", 
osd_cÚfig_·¿m
->
subt™Ë3
, 
	`¡¾’
(osd_config_param->subtitle3));

2180 
osd_cÚfig_·¿m
->
subt™Ë3_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2181 
osd_cÚfig_·¿m
->
subt™Ë3_pos_x
 = 200;

2182 
osd_cÚfig_·¿m
->
subt™Ë3_pos_y
 = 200;

2183 
	`¥rštf
(
osd_cÚfig_·¿m
->
subt™Ë4
, "subtitle4 windowest");

2184 
	`´štk
("%s,†’=%d\n", 
osd_cÚfig_·¿m
->
subt™Ë4
, 
	`¡¾’
(osd_config_param->subtitle4));

2185 
osd_cÚfig_·¿m
->
subt™Ë4_©Œib
 = 
OSD_ATTR_DISPLAY_ON
;

2186 
osd_cÚfig_·¿m
->
subt™Ë4_pos_x
 = 0;

2187 
osd_cÚfig_·¿m
->
subt™Ë4_pos_y
 = 240;

2189 
’gše
->
İ
->
	`upd©e_’code_osd_´İ”ty
Óngše, 
osd_cÚfig_·¿m
);

2190 
	}
}

2192 
	$š™_’code_osd_chª_’gše
(
osd_chª_’gše_t
 *
’gše
, 
ma¡”OrSub
)

2194 
tw_h264_logic_’code_chª_t
 *
’code_chª
;

2195 
TW_OSD_PARAM
 *
osd_ruÂšg_·¿m
;

2196 
dvm_ch_t
 *
ch
;

2197 
ch_driv”_t
 *
ch_driv”
;

2198 
tw_video_bus_t
 *
video_bus
;

2199 
tw5864_vd_üoss_bus_t
 *
vd_bus
;

2200 
tw_h264_phy_video_¦Ù_t
 *
phy_video_¦Ù
;

2201 
DVMNVS_CHIP_VIDEO_ENCODE_CAPABILITY
 *
video_’code_ÿp
;

2202 
osd_©Œibu‹_»gs_t
 *
©Œ_»gs
;

2203 
osd_»ùªgË_’Œy_t
 *
»ùªgË
;

2204 
osd_»ùªgË_d´am_tcb_t
 *
osd_d´am_»q
;

2205 
’code_osd_¡ršg_©Œ_t
 *
¡ršg_©Œ
;

2206 
’code_osd_mask_©Œ_t
 *
mask_©Œ
;

2207 
i
, 
phy_¦Ù_id
, 
osd_¦Ù_id
, 
»t
 = -1;

2209 
’code_chª
 = 
	`to_g‘_tw_h264_’code_chª_w™h_osd_’gše
(
’gše
);

2210 
phy_¦Ù_id
 = 
’code_chª
->phy_slot_id;

2211 
ch
 = 
’code_chª
->chip;

2212 
osd_ruÂšg_·¿m
 = &
’gše
->osd_running_param;

2214 
ch_driv”
 = 
ch
->chip_driver;

2215 
video_bus
 = &
ch_driv”
->video_bus;

2216 
vd_bus
 = 
video_bus
->
vd_bus_driv”
;

2217 
video_’code_ÿp
 = 
ch
->video_encode_cap;

2218 
	`¥š_lock_š™
(&
’gše
->
osd_lock
);

2219 
	`©omic_£t
(&
’gše
->
osd_is_wÜkšg
, 0);

2220 
	`š™_com¶‘iÚ
(&
’gše
->
wa™_dÚe
);

2221 
’gše
->
’code_chª
 =ƒncode_chan;

2222 
	`mem£t
((*)
osd_ruÂšg_·¿m
, 0, (
TW_OSD_PARAM
));

2223 
	`©omic_£t
(&
’gše
->
sync_osd_·¿m
, 1);

2224 
’gše
->
chª_»ùªgË_u£d_m­_bË
 = 0;

2225 
’gše
->
chª_d©a_ba£
 = 
	`g‘_osd_chª_ba£
(
phy_¦Ù_id
);

2226 
’gše
->
ma¡”OrSub
 = masterOrSub;

2228 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
phy_¦Ù_id
, &
phy_video_¦Ù
);

2229 
osd_¦Ù_id
 = 
	`g‘_phy_¦Ù_id_by_osd_chª_ba£
(
vd_bus
, 
’gše
->
chª_d©a_ba£
, 
phy_¦Ù_id
, 
video_’code_ÿp
->
ddr_m­_mode
);

2230 
vd_bus
->
İ
->
	`g‘_phy_video_¦Ù_by_phy_id
(vd_bus, 
osd_¦Ù_id
, &
phy_video_¦Ù
);

2231 
’gše
->
videoSizeMode
 = 
phy_video_¦Ù
->
video_size
;

2232 
»t
 = 
	`š™_osd_’code_mb_poŞ
(
’gše
, 
ch
->
ch_id
);

2233 if(
»t
 < 0){

2234  
»t
;

2237 
’gše
->
İ
 = &
osd_chª_’gše_İ
;

2238 
’gše
->
©Œibu‹_»gs
.
chª_»ù_©Œ_»gs_group_İ
 = &
osd_©Œibu‹_»gs_group_İ
;

2239 
’gše
->
©Œibu‹_»gs
.
chª_»ù_©Œ_»gs_group_İ
->
	`š™_osd_chª_»ùªgË_©Œ_»gs_group
(&engine->attribute_regs);

2240 
i
=0; i<
OSD_CHAN_RECTANGLE_NUMBER
; i++){

2241 
©Œ_»gs
 = &
’gše
->
©Œibu‹_»gs
.
©Œibu‹_»gs_group
[
i
];

2243 
»ùªgË
 = &
’gše
->»ùªgË[
i
];

2244 
»ùªgË
->
ch
 = chip;

2245 
»ùªgË
->
osd_chª_’gše
 = 
’gše
;

2246 
»ùªgË
->
mb_ch¬_queue_node
.
İ
 = &
tcb_node_queue_İ
;

2247 
»ùªgË
->
mb_ch¬_queue_node
.
İ
->
	`š™
(&rectangle->mb_char_queue_node);

2248 
»ùªgË
->
»ùªgË_id
 = 
i
;

2249 
»ùªgË
->
chª_id
 = 
phy_¦Ù_id
;

2250 
»ùªgË
->
©Œ_»gs
 =‡ttr_regs;

2251 
»ùªgË
->
İ
 = &
osd_»ùªgË_İ
;

2252 
osd_d´am_»q
 = &
»ùªgË
->osd_dpram_req;

2253 
osd_d´am_»q
->
İ
 = &
osd_»ùªgË_d´am_tcb_İ
;

2254 
»ùªgË
->
İ
->
	`»£t
(rectangle);

2257 
’gše
->
tim”_©Œ
.
tim”
 = &
osd_tim”
;

2258 
’gše
->
tim”_©Œ
.
İ
 = &
osd_tim”_©Œ_İ
;

2259 
’gše
->
tim”_©Œ
.
mb_x
 = 0;

2260 
’gše
->
tim”_©Œ
.
mb_y
 = 0;

2261 
’gše
->
tim”_©Œ
.
tim”_di¥Ïy_mode
 = 
YEAR_MONTH_DAY_HOUR_MINUTE_SECOND
;

2262 
’gše
->
tim”_©Œ
.
İ
->
	`»£t
(&’gše->tim”_©Œ, 
ch
->
ch_id
, 
’code_chª
->
logic_chª_id
);

2263 
¡ršg_©Œ
 = 
’gše
->string_attr;

2264 
mask_©Œ
 = 
’gše
->mask_attr;

2265 
i
=0; i<
OSD_CHAN_MAX_STRING_RECTANGLE_NUMBER
; i++){

2266 
¡ršg_©Œ
->
İ
 = &
osd_¡ršg_©Œ_İ
;

2267 
mask_©Œ
->
İ
 = &
osd_mask_©Œ_İ
;

2269 
¡ršg_©Œ
->
İ
->
	`»£t
(string_attr);

2270 
mask_©Œ
->
İ
->
	`»£t
(mask_attr);

2271 
¡ršg_©Œ
++;

2272 
mask_©Œ
++;

2275 
	`osd_‹¡šg_š™
(
’gše
);

2276  
»t
;

2277 
	}
}

	@../../tw5864/tw5864/tw_porting_arm.c

1 
	~<tw5864/dvm_commÚ.h
>

2 
	~<asm/¬ch/»gs-tim”.h
>

4 
	#TIMER_INVALIDE
 (-1)

	)

5 
	#TIMER_VALIDE
 (1)

	)

9 
__s32
 
	mæag
;

10 
__u32
 
	mcouÁ
;

11 
__u32
 
	m³rcouÁ
;

12 * 
	mcÚ‹xt
;

13 
tim”Hook
 
	mhook
;

14 }
	tFORTMCB
;

18 
__s32
 
	mæag
;

19 
__u32
 
	mcouÁ
;

20 * 
	mcÚ‹xt
;

21 
tim”Hook
 
	mhook
;

22 }
	tTMCB
;

24 
SigÇlTimeIn™
();

25 
FÜTimeIn™
();

26 
G‘F»eSšgËFœeTmcb
();

27 
PutF»eSšgËFœeTmcb
(
s32
 
šdex
);

28 
G‘F»eFÜFœeFÜTmcb
();

29 
PutF»eFÜFœeTmcb
(
s32
 
šdex
);

30 
SoáTim”In™
();

32 
TMCB
 
	gSšgËFœeQueue
[
MAXSINGLEFIREQUEUENUM
];

33 
FORTMCB
 
	gFÜFœeQueue
[
MAXFORFIREQUEUENUM
];

34 
¥šlock_t
 
	gsoátim”_lock
;

35 
	gtw_sy¡em_tick”
 = 0;

37 
u32
 
	$g‘_tw_sy¡em_tick
()

39 
timev®
 
tv1
;

41 
	`do_g‘timeofday
(&
tv1
);

42 
tw_sy¡em_tick”
 = ()
tv1
.
tv_£c
;

43 
tw_sy¡em_tick”
 *= 1000;

44 
tw_sy¡em_tick”
 +ğ((()
tv1
.
tv_u£c
)/1000);

45  (
u32
)
tw_sy¡em_tick”
;

46 
	}
}

49 
	$SigÇlTimeIn™
()

51 
i
;

52 
æags
;

54 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

55 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

56 
	`PutF»eSšgËFœeTmcb
(
i
);

57 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

58 
	}
}

60 
	$FÜTimeIn™
()

62 
i
;

63 
æags
;

65 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

66 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

67 
	`PutF»eFÜFœeTmcb
(
i
);

68 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

69 
	}
}

71 
	$G‘F»eSšgËFœeTmcb
()

73 
TMCB
 *
±r
;

74 
i
;

76 
±r
 = 
SšgËFœeQueue
;

77 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

79 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

80  
i
;

81 
±r
++;

83  
GETFREETMCBERROR
;

84 
	}
}

86 
	$PutF»eSšgËFœeTmcb
(
šdex
)

88 
TMCB
 *
±r
;

90 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

92 
±r
 = &
SšgËFœeQueue
[
šdex
];

93 
±r
->
hook
 = (*)0;

94 
±r
->
æag
 = 
TIMER_INVALIDE
;

95 
±r
->
couÁ
 = 0;

96 
	}
}

98 
	$G‘F»eFÜFœeFÜTmcb
()

100 
FORTMCB
 *
±r
;

101 
i
;

103 
±r
 = 
FÜFœeQueue
;

104 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

106 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

107  
i
;

108 
±r
++;

110  
GETFREETMCBERROR
;

111 
	}
}

113 
	$PutF»eFÜFœeTmcb
(
šdex
)

115 
FORTMCB
 *
±r
;

117 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

119 
±r
 = &
FÜFœeQueue
[
šdex
];

120 
±r
->
hook
 = (*)0;

121 
±r
->
æag
 = 
TIMER_INVALIDE
;

122 
±r
->
couÁ
 = 0;

123 
±r
->
³rcouÁ
 = 0;

124 
	}
}

126 
	$Tig”SšgËFœeTim”
()

128 
TMCB
 *
±r
;

129 
i
;

131 
±r
 = 
SšgËFœeQueue
;

132 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

134 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

136 if(
±r
->
hook
 != (*)0)

138 if(
±r
->
couÁ
 > 0)

139 
±r
->
couÁ
--;

140 if(
±r
->
couÁ
 == 0)

142 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

143 
	`PutF»eSšgËFœeTmcb
(
i
);

147 
	`PutF»eSšgËFœeTmcb
(
i
);

149 
±r
++;

151 
	}
}

153 
	$Tig”FÜFœeTim”
()

155 
FORTMCB
 *
±r
;

156 
i
;

158 
±r
 = 
FÜFœeQueue
;

159 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

161 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

163 if(
±r
->
hook
 != (*)0)

165 if(
±r
->
couÁ
 > 0)

166 
±r
->
couÁ
--;

167 if(
±r
->
couÁ
 == 0)

169 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

170 
±r
->
couÁ
 =…Œ->
³rcouÁ
;

174 
	`PutF»eFÜFœeTmcb
(
i
);

176 
±r
++;

178 
	}
}

180 
	$SoáTim”In™
()

182 
	`¥š_lock_š™
(&
soátim”_lock
);

183 
	`SigÇlTimeIn™
();

184 
	`FÜTimeIn™
();

185 
	}
}

187 
	$Re£tSigÇlTim”
()

189 
	`SigÇlTimeIn™
();

190 
	}
}

192 
	$Re£tFÜTim”
()

194 
	`FÜTimeIn™
();

195 
	}
}

197 
	$AddSšgËFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

199 
TMCB
 *
±r
;

200 
æags
;

201 
šdex
;

203 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

204  
ADDJOBERROR
;

205 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

206 
šdex
 = 
	`G‘F»eSšgËFœeTmcb
();

207 if(
šdex
 =ğ
GETFREETMCBERROR
)

209 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

210  
ADDJOBERROR
;

212 
±r
 = &
SšgËFœeQueue
[
šdex
];

213 
±r
->
æag
 = 
TIMER_VALIDE
;

214 
±r
->
couÁ
 = 
tick
;

215 
±r
->
cÚ‹xt
 = context;

216 
±r
->
hook
 = 
fun
;

217 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

218  
šdex
;

219 
	}
}

221 
	$D–‘eSšgËFœeTim”Job
(
šdex
)

223 
æags
;

225 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

226 
	`PutF»eSšgËFœeTmcb
(
šdex
);

227 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

228 
	}
}

230 
	$AddFÜFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

232 
FORTMCB
 *
±r
;

233 
šdex
;

234 
æags
;

236 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

237  
ADDJOBERROR
;

238 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

239 
šdex
 = 
	`G‘F»eFÜFœeFÜTmcb
();

240 if(
šdex
 =ğ
GETFREETMCBERROR
)

242 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

243  
ADDJOBERROR
;

245 
±r
 = &
FÜFœeQueue
[
šdex
];

246 
±r
->
æag
 = 
TIMER_VALIDE
;

247 
±r
->
³rcouÁ
 =…Œ->
couÁ
 = 
tick
;

248 
±r
->
cÚ‹xt
 = context;

249 
±r
->
hook
 = 
fun
;

250 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

251  
šdex
;

252 
	}
}

254 
	$D–‘eFÜFœeTim”Job
(
šdex
)

256 
æags
;

258 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

259 
	`PutF»eFÜFœeTmcb
(
šdex
);

260 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

261 
	}
}

263 
	gosd_upd©e_tim”
=0;

264 #ifdeà 
OSD_MODULE


265 
timev®
 
	gtv1
;

267 
œq»tuº_t
 
	$s3c2410_tim”3_i¤
(
œq
, *
id
)

269 
æags
;

271 
	`loÿl_œq_§ve
(
æags
);

273 
	`Tig”SšgËFœeTim”
();

274 
	`Tig”FÜFœeTim”
();

276 if(!
osd_upd©e_tim”
){

277 #ifdeà 
OSD_MODULE


278 
	`check_¹c_time
(&
tv1
);

281 
osd_upd©e_tim”
++;

282 
osd_upd©e_tim”
 &= 0x1f;

283 
	`loÿl_œq_»¡Üe
(
æags
);

285  
IRQ_HANDLED
;

286 
	}
}

288 
	$şo£S3c2410Tim”3
()

290 
tcÚ
;

291 
tcfg1
;

293 
	`di§bË_œq
(
IRQ_TIMER3
);

294 
tcfg1
 = 
	`__¿w_»adl
(
S3C2410_TCFG1
);

295 
tcfg1
 &ğ~
S3C2410_TCFG1_MUX3_MASK
;

296 
tcfg1
 |ğ
S3C2410_TCFG1_MUX3_DIV2
;

297 
	`__¿w_wr™–
(
tcfg1
, 
S3C2410_TCFG1
);

298 
	`__¿w_wr™–
(0xa509, 
	`S3C2410_TCNTB
(3));

299 
	`__¿w_wr™–
(0, 
	`S3C2410_TCMPB
(3));

301 
tcÚ
 = 
	`__¿w_»adl
(
S3C2410_TCON
);

302 
tcÚ
 &= ~(0xf<<16);

303 
tcÚ
 |ğ
S3C2410_TCON_T3MANUALUPD
;

304 
	`__¿w_wr™–
(
tcÚ
, 
S3C2410_TCON
);

306 
	`´štk
("% ok\n", 
__FUNCTION__
);

307 
	}
}

309 
	$’abËS3c2410Tim”3
()

311 
tcÚ
;

312 
tcfg1
;

315 
tcfg1
 = 
	`__¿w_»adl
(
S3C2410_TCFG1
);

316 
tcfg1
 &ğ~
S3C2410_TCFG1_MUX3_MASK
;

317 
tcfg1
 |ğ
S3C2410_TCFG1_MUX3_DIV2
;

318 
	`__¿w_wr™–
(0x0700, 
S3C2410_TCFG0
);

319 
	`__¿w_wr™–
(
tcfg1
, 
S3C2410_TCFG1
);

320 
	`__¿w_wr™–
(0x3938, 
	`S3C2410_TCNTB
(3));

321 
	`__¿w_wr™–
(0, 
	`S3C2410_TCMPB
(3));

323 
tcÚ
 = 
	`__¿w_»adl
(
S3C2410_TCON
);

324 
tcÚ
 &= ~(0xf<<16);

325 
tcÚ
 |ğ
S3C2410_TCON_T3MANUALUPD
;

326 
	`__¿w_wr™–
(
tcÚ
, 
S3C2410_TCON
);

327 
tcÚ
 = 
	`__¿w_»adl
(
S3C2410_TCON
);

328 
tcÚ
 &= ~(0xf<<16);

329 
tcÚ
 |ğ
S3C2410_TCON_T3RELOAD
;

330 
tcÚ
 |ğ
S3C2410_TCON_T3START
;

331 
	`__¿w_wr™–
(
tcÚ
, 
S3C2410_TCON
);

332 
	}
}

334 
	gšv®id
;

335 
	$š™Tim”3P”iod5ms
()

337 if(
	`»que¡_œq
(
IRQ_TIMER3
, 
s3c2410_tim”3_i¤
, 
IRQF_SHARED
, "s3c2410_tim”3", &
šv®id
)) {

338 
	`şo£S3c2410Tim”3
();

339 
	`´štk
("\n\ns3c2410'simer3 have been used\n\n");

341 
	`’abËS3c2410Tim”3
();

343 
	}
}

345 
	$š™_¬m_tim”
()

347 
tw_sy¡em_tick”
 = 0;

348 
	`SoáTim”In™
();

349 #iâdeà
USE_ON_CHIP_TIMER


350 
	`š™Tim”3P”iod5ms
();

352 
	}
}

354 
	$şo£_¬m_tim”
()

356 
	`şo£S3c2410Tim”3
();

357 
	`ä“_œq
(
IRQ_TIMER3
, &
šv®id
);

358 
	}
}

360 
	$di§bË_tim”_št
()

362 
	`di§bË_œq
(
IRQ_TIMER3
);

363 
	}
}

365 
	$’abË_tim”_št
()

367 
	`’abË_œq
(
IRQ_TIMER3
);

368 
	}
}

	@../../tw5864/tw5864/tw_ppc_porting.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
__iomem
 *
	gdvm_va_8313»gba£
 = 
NULL
;

6 
	#DMAGSR
 (
dvm_va_8313»gba£
+0x82A8)

	)

7 
	#DMASR0
 (
dvm_va_8313»gba£
+0x8104)

	)

8 
	#DMASAR0
 (
dvm_va_8313»gba£
+0x8110)

	)

9 
	#DMADAR0
 (
dvm_va_8313»gba£
+0x8118)

	)

10 
	#DMABCR0
 (
dvm_va_8313»gba£
+0x8120)

	)

11 
	#DMAMR0
 (
dvm_va_8313»gba£
+0x8100)

	)

12 
	#DMACDAR0
 (
dvm_va_8313»gba£
+0x8108)

	)

14 
	#PTLDR
 (
dvm_va_8313»gba£
+0x0404)

	)

15 
	#PTCNR
 (
dvm_va_8313»gba£
+0x0400)

	)

16 
	#PTEVR
 (
dvm_va_8313»gba£
+0x0410)

	)

18 
	#GPCFG
 (
dvm_va_8313»gba£
+0xc00)

	)

19 
	#GPDAT
 (
dvm_va_8313»gba£
+0xc08)

	)

21 
	#SICFR
 (
dvm_va_8313»gba£
+0x0700)

	)

22 
	#SIVCR
 (
dvm_va_8313»gba£
+0x0704)

	)

23 
	#SIPNR_H
 (
dvm_va_8313»gba£
+0x0708)

	)

24 
	#SIPNR_L
 (
dvm_va_8313»gba£
+0x070c)

	)

25 
	#SIPRR_A
 (
dvm_va_8313»gba£
+0x0710)

	)

26 
	#SIPRR_D
 (
dvm_va_8313»gba£
+0x071c)

	)

27 
	#SIMSR_H
 (
dvm_va_8313»gba£
+0x0720)

	)

28 
	#SIMSR_L
 (
dvm_va_8313»gba£
+0x0724)

	)

29 
	#SICNR
 (
dvm_va_8313»gba£
+0x0728)

	)

30 
	#SEPNR
 (
dvm_va_8313»gba£
+0x072c)

	)

31 
	#SMPRR_A
 (
dvm_va_8313»gba£
+0x0730)

	)

32 
	#SMPRR_B
 (
dvm_va_8313»gba£
+0x0734)

	)

33 
	#SEMSR
 (
dvm_va_8313»gba£
+0x0738)

	)

34 
	#SECNR
 (
dvm_va_8313»gba£
+0x073c)

	)

35 
	#SERSR
 (
dvm_va_8313»gba£
+0x0740)

	)

36 
	#SERMR
 (
dvm_va_8313»gba£
+0x0744)

	)

37 
	#SERCR
 (
dvm_va_8313»gba£
+0x0748)

	)

38 
	#SIFCR_H
 (
dvm_va_8313»gba£
+0x0750)

	)

39 
	#SIFCR_L
 (
dvm_va_8313»gba£
+0x0754)

	)

40 
	#SEFCR
 (
dvm_va_8313»gba£
+0x0758)

	)

41 
	#SERFR
 (
dvm_va_8313»gba£
+0x075c)

	)

42 
	#SCVCR
 (
dvm_va_8313»gba£
+0x0760)

	)

43 
	#SMVCR
 (
dvm_va_8313»gba£
+0x0764)

	)

46 
	#OR0
 ((
__iomem
 *)(()
dvm_va_8313»gba£
+0x5004))

	)

47 
	#OR1
 ((
__iomem
 *)(()
dvm_va_8313»gba£
+0x500C))

	)

48 
	#OR2
 ((
__iomem
 *)(()
dvm_va_8313»gba£
+0x5014))

	)

49 
	#OR3
 ((
__iomem
 *)(()
dvm_va_8313»gba£
+0x501C))

	)

51 
	#TIMER_INVALIDE
 (-1)

	)

52 
	#TIMER_VALIDE
 (1)

	)

54 
	#GPIO_PIN_29
 (29)

	)

55 
	#WATCHDOG_BASE
 (
dvm_va_8313»gba£
 + 0x0200)

	)

56 
	#WATCHDOG_CTROL
 (
WATCHDOG_BASE
 + 0x04)

	)

57 
	#WATCHDOG_CNT
 (
WATCHDOG_BASE
 + 0x08)

	)

58 
	#WATCHDOG_SERV
 (
WATCHDOG_BASE
 + 0x0e)

	)

63 
__s32
 
	mæag
;

64 
__u32
 
	mcouÁ
;

65 
__u32
 
	m³rcouÁ
;

66 * 
	mcÚ‹xt
;

67 
tim”Hook
 
	mhook
;

68 }
	tFORTMCB
;

72 
__s32
 
	mæag
;

73 
__u32
 
	mcouÁ
;

74 * 
	mcÚ‹xt
;

75 
tim”Hook
 
	mhook
;

76 }
	tTMCB
;

78 
SigÇlTimeIn™
();

79 
FÜTimeIn™
();

80 
G‘F»eSšgËFœeTmcb
();

81 
PutF»eSšgËFœeTmcb
(
s32
 
šdex
);

82 
G‘F»eFÜFœeFÜTmcb
();

83 
PutF»eFÜFœeTmcb
(
s32
 
šdex
);

84 
SoáTim”In™
();

85 
gpio_pš_£t
(
gpio
, 
boŞ
);

87 
TMCB
 
	gSšgËFœeQueue
[
MAXSINGLEFIREQUEUENUM
];

88 
FORTMCB
 
	gFÜFœeQueue
[
MAXFORFIREQUEUENUM
];

89 
¥šlock_t
 
	gsoátim”_lock
;

90 
	gtw_sy¡em_tick”
 = 0;

92 
	$w©chdog_»£t
()

96 
	`out_be16
(
WATCHDOG_SERV
, 0x556c);

97 
	`out_be16
(
WATCHDOG_SERV
, 0xaa39);

98 
	}
}

100 
	$w©chdog_»Ëa£
()

102 
	`__¿w_wr™–
((0xfffà<< 16), 
WATCHDOG_CTROL
);

103 
	}
}

105 
	$w©chdog_š™
(
u32
 
timeout
)

110 
	}
}

112 
u32
 
	$g‘_tw_sy¡em_tick
()

114 
timev®
 
tv1
;

116 
	`do_g‘timeofday
(&
tv1
);

117 
tw_sy¡em_tick”
 = ()
tv1
.
tv_£c
;

118 
tw_sy¡em_tick”
 *= 1000;

119 
tw_sy¡em_tick”
 +ğ((()
tv1
.
tv_u£c
)/1000);

121  (
u32
)
tw_sy¡em_tick”
;

122 
	}
}

124 
	$SigÇlTimeIn™
()

126 
i
;

127 
æags
;

129 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

130 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

131 
	`PutF»eSšgËFœeTmcb
(
i
);

132 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

133 
	}
}

135 
	$FÜTimeIn™
()

137 
i
;

138 
æags
;

140 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

141 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

142 
	`PutF»eFÜFœeTmcb
(
i
);

143 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

144 
	}
}

146 
	$G‘F»eSšgËFœeTmcb
()

148 
TMCB
 *
±r
;

149 
i
;

151 
±r
 = 
SšgËFœeQueue
;

152 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

154 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

155  
i
;

156 
±r
++;

158  
GETFREETMCBERROR
;

159 
	}
}

161 
	$PutF»eSšgËFœeTmcb
(
šdex
)

163 
TMCB
 *
±r
;

165 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

167 
±r
 = &
SšgËFœeQueue
[
šdex
];

168 
±r
->
hook
 = (*)0;

169 
±r
->
æag
 = 
TIMER_INVALIDE
;

170 
±r
->
couÁ
 = 0;

171 
	}
}

173 
	$G‘F»eFÜFœeFÜTmcb
()

175 
FORTMCB
 *
±r
;

176 
i
;

178 
±r
 = 
FÜFœeQueue
;

179 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

181 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

182  
i
;

183 
±r
++;

185  
GETFREETMCBERROR
;

186 
	}
}

188 
	$PutF»eFÜFœeTmcb
(
šdex
)

190 
FORTMCB
 *
±r
;

192 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

194 
±r
 = &
FÜFœeQueue
[
šdex
];

195 
±r
->
hook
 = (*)0;

196 
±r
->
æag
 = 
TIMER_INVALIDE
;

197 
±r
->
couÁ
 = 0;

198 
±r
->
³rcouÁ
 = 0;

199 
	}
}

201 
	$Tig”SšgËFœeTim”
()

203 
TMCB
 *
±r
;

204 
i
;

206 
±r
 = 
SšgËFœeQueue
;

207 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

209 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

211 if(
±r
->
hook
 != (*)0)

213 if(
±r
->
couÁ
 > 0)

214 
±r
->
couÁ
--;

215 if(
±r
->
couÁ
 == 0)

217 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

218 
	`PutF»eSšgËFœeTmcb
(
i
);

222 
	`PutF»eSšgËFœeTmcb
(
i
);

224 
±r
++;

226 
	}
}

228 
	$Tig”FÜFœeTim”
()

230 
FORTMCB
 *
±r
;

231 
i
;

233 
±r
 = 
FÜFœeQueue
;

234 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

236 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

238 if(
±r
->
hook
 != (*)0)

240 if(
±r
->
couÁ
 > 0)

241 
±r
->
couÁ
--;

242 if(
±r
->
couÁ
 == 0)

244 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

245 
±r
->
couÁ
 =…Œ->
³rcouÁ
;

249 
	`PutF»eFÜFœeTmcb
(
i
);

251 
±r
++;

253 
	}
}

255 
	$SoáTim”In™
()

257 
	`¥š_lock_š™
(&
soátim”_lock
);

258 
	`SigÇlTimeIn™
();

259 
	`FÜTimeIn™
();

260 
	}
}

262 
	$Re£tSigÇlTim”
()

264 
	`SigÇlTimeIn™
();

265 
	}
}

267 
	$Re£tFÜTim”
()

269 
	`FÜTimeIn™
();

270 
	}
}

272 
	$AddSšgËFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

274 
TMCB
 *
±r
;

275 
æags
;

276 
šdex
;

278 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

279  
ADDJOBERROR
;

280 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

281 
šdex
 = 
	`G‘F»eSšgËFœeTmcb
();

282 if(
šdex
 =ğ
GETFREETMCBERROR
)

284 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

285  
ADDJOBERROR
;

287 
±r
 = &
SšgËFœeQueue
[
šdex
];

288 
±r
->
æag
 = 
TIMER_VALIDE
;

289 
±r
->
couÁ
 = 
tick
;

290 
±r
->
cÚ‹xt
 = context;

291 
±r
->
hook
 = 
fun
;

292 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

293  
šdex
;

294 
	}
}

296 
	$D–‘eSšgËFœeTim”Job
(
šdex
)

298 
æags
;

300 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

301 
	`PutF»eSšgËFœeTmcb
(
šdex
);

302 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

303 
	}
}

305 
	$AddFÜFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

307 
FORTMCB
 *
±r
;

308 
šdex
;

309 
æags
;

311 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

312  
ADDJOBERROR
;

313 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

314 
šdex
 = 
	`G‘F»eFÜFœeFÜTmcb
();

315 if(
šdex
 =ğ
GETFREETMCBERROR
)

317 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

318  
ADDJOBERROR
;

320 
±r
 = &
FÜFœeQueue
[
šdex
];

321 
±r
->
æag
 = 
TIMER_VALIDE
;

322 
±r
->
³rcouÁ
 =…Œ->
couÁ
 = 
tick
;

323 
±r
->
cÚ‹xt
 = context;

324 
±r
->
hook
 = 
fun
;

325 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

326  
šdex
;

327 
	}
}

329 
	$D–‘eFÜFœeTim”Job
(
šdex
)

331 
æags
;

333 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

334 
	`PutF»eFÜFœeTmcb
(
šdex
);

335 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

336 
	}
}

338 #ifdeà 
OSD_MODULE


339 
timev®
 
	gtv1
;

341 
	gosd_upd©e_tim”
=0;

343 
œq»tuº_t
 
	$dvm4000i_tim”_š‹¼u±
(
œq
, *
dev_id
)

345 
æags
;

347 
	`loÿl_œq_§ve
(
æags
);

348 
	`w©chdog_»£t
();

350 
	`__¿w_wr™–
(0xffffffff, 
PTEVR
);

351 
	`__¿w_wr™–
(0xffffffff, 
SIPNR_L
);

352 
	`__¿w_wr™–
(0xffffffff, 
SIPNR_H
);

353 
	`Tig”SšgËFœeTim”
();

354 
	`Tig”FÜFœeTim”
();

356 if(!
osd_upd©e_tim”
){

357 #ifdeà 
OSD_MODULE


358 
	`check_¹c_time
(&
tv1
);

361 
osd_upd©e_tim”
++;

362 
osd_upd©e_tim”
 &= 0x1f;

363 
	`loÿl_œq_»¡Üe
(
æags
);

365  
IRQ_HANDLED
;

366 
	}
}

368 
	$»ad_sivü
()

370 
	`´štk
("SEPNR = 0x%x\n", 
	`__¿w_»adl
(
SEPNR
));

371 
	}
}

373 
	$»ad_ic_»gs
()

375 
	`´štk
("\n\nSICFR = 0x%x\n", 
	`__¿w_»adl
(
SICFR
));

376 
	`´štk
("SIVCR = 0x%x\n", 
	`__¿w_»adl
(
SIVCR
));

377 
	`´štk
("SIPNR_H = 0x%x\n", 
	`__¿w_»adl
(
SIPNR_H
));

378 
	`´štk
("SIPNR_L = 0x%x\n", 
	`__¿w_»adl
(
SIPNR_L
));

379 
	`´štk
("SIPRR_A = 0x%x\n", 
	`__¿w_»adl
(
SIPRR_A
));

380 
	`´štk
("SIPRR_D = 0x%x\n", 
	`__¿w_»adl
(
SIPRR_D
));

381 
	`´štk
("SIPRR_A = 0x%x\n", 
	`__¿w_»adl
(
SIMSR_H
));

382 
	`´štk
("SIPRR_D = 0x%x\n", 
	`__¿w_»adl
(
SIMSR_L
));

383 
	`´štk
("SICNR = 0x%x\n", 
	`__¿w_»adl
(
SICNR
));

384 
	`´štk
("SEPNR = 0x%x\n", 
	`__¿w_»adl
(
SEPNR
));

385 
	`´štk
("SMPRR_A = 0x%x\n", 
	`__¿w_»adl
(
SMPRR_A
));

386 
	`´štk
("SMPRR_B = 0x%x\n", 
	`__¿w_»adl
(
SMPRR_B
));

387 
	`´štk
("SEMSR = 0x%x\n", 
	`__¿w_»adl
(
SEMSR
));

388 
	`´štk
("SECNR = 0x%x\n", 
	`__¿w_»adl
(
SECNR
));

389 
	`´štk
("SERSR = 0x%x\n", 
	`__¿w_»adl
(
SERSR
));

390 
	`´štk
("SERMR = 0x%x\n", 
	`__¿w_»adl
(
SERMR
));

391 
	`´štk
("SERCR = 0x%x\n", 
	`__¿w_»adl
(
SERCR
));

392 
	`´štk
("SIFCR_H = 0x%x\n", 
	`__¿w_»adl
(
SIFCR_H
));

393 
	`´štk
("SIFCR_L = 0x%x\n", 
	`__¿w_»adl
(
SIFCR_L
));

394 
	`´štk
("SEFCR = 0x%x\n", 
	`__¿w_»adl
(
SEFCR
));

395 
	`´štk
("SERFR = 0x%x\n", 
	`__¿w_»adl
(
SERFR
));

396 
	`´štk
("SCVCR = 0x%x\n", 
	`__¿w_»adl
(
SCVCR
));

397 
	`´štk
("SMVCR = 0x%x\n\n", 
	`__¿w_»adl
(
SMVCR
));

398 
	}
}

400 
	$ş—r_œq0_³ndšg
()

402 
u32
 
œq_æags
;

404 
œq_æags
 = 
	`__¿w_»adl
(
SEPNR
);

405 
œq_æags
 |= 0x80000000;

406 
	`__¿w_wr™–
(
œq_æags
, 
SEPNR
);

407 
	}
}

409 
	$£t_gpio13_high
()

411 
u32
 
gpio
;

412 
gpio
 = 
	`__¿w_»adl
(
GPDAT
);

413 
gpio
 |= 0x40000;

414 
	`__¿w_wr™–
(
gpio
, 
GPDAT
);

415 
	}
}

417 
	$£t_gpio13_low
()

419 
u32
 
gpio
;

420 
gpio
 = 
	`»adl
(
GPDAT
);

421 
gpio
 &= (~0x40000);

422 
	`wr™–
(
gpio
, 
GPDAT
);

423 
	}
}

425 
	gs_vœq
 = -1;

426 #ifdeà
OSD_MODULE


427 
mpc8313_tim”
;

430 
tim”_li¡
 
	gdvm_tim”
;

432 #ifdeà
USE_SYSTEM_TIMER


433 
	$dvm_k”Ãl_tim”
(){

435 
dvm_tim”
.
funùiÚ
 = 
dvm_k”Ãl_tim”
;

436 
dvm_tim”
.
d©a
 = 0;

437 
dvm_tim”
.
expœes
 = 
jiff›s
 + 1;

438 
	`add_tim”
(&
dvm_tim”
);

440 
	`Tig”SšgËFœeTim”
();

441 
	`Tig”FÜFœeTim”
();

442 
	}
}

445 
	$µc_tim”_š™
()

447 
u32
 
»g_v®ue
;

448 
u32
 
gpio
;

449 
u32
 
»t
 = 0;

451 
tw_sy¡em_tick”
 = 0;

452 
gpio
 = 
	`__¿w_»adl
(
GPCFG
);

453 
gpio
 |= 0x40000;

454 
	`__¿w_wr™–
(
gpio
, 
GPCFG
);

455 #ifdeà
OSD_MODULE


456 
mpc8313_tim”
 = 0;

458 
osd_upd©e_tim”
 = 0;

460 
»g_v®ue
 = 0xcb800;

461 
s_vœq
 = 
	`œq_ü—‹_m­pšg
(
NULL
, 
IRQ_SYS_INTERNAL
);

462 if(
s_vœq
 =ğ
NO_IRQ
)

464 
	`´štk
("map irq failed !\n");

467 #ifdeà
USE_SYSTEM_TIMER


468 
dvm_tim”
.
funùiÚ
 = 
dvm_k”Ãl_tim”
;

469 
dvm_tim”
.
d©a
 = 0;

470 
dvm_tim”
.
expœes
 = 
jiff›s
 + 1;

471 
	`š™_tim”
(&
dvm_tim”
);

473 
»t
 = 
	`»que¡_œq
(
s_vœq
, (*)
dvm4000i_tim”_š‹¼u±
, 
IRQF_DISABLED
, "dvm_tim”", 
NULL
);

474 if(
»t
) {

475 
	`´štk
("»que¡_œq i ”¸%d, (hw %2d --> vœ %2d).\n", 
»t
, 
IRQ_SYS_INTERNAL
, 
s_vœq
);

480 
	`__¿w_wr™–
(
»g_v®ue
, 
PTLDR
);

481 
	`__¿w_wr™–
(0x81, 
PTCNR
);

483 
	}
}

486 
	$µc_tim”_ex™
()

488 #ifdeà
USE_SYSTEM_TIMER


489 
	`d–_tim”
(&
dvm_tim”
);

491 
	`di§bË_œq
(
s_vœq
);

492 
	`ä“_œq
(
s_vœq
, 
NULL
);

494 #ifdeà
OSD_MODULE


495 
mpc8313_tim”
 = 0;

497 
osd_upd©e_tim”
 = 0;

498 
	}
}

500 
	$di§bË_tim”_št
()

502 #ifdeà
USE_SYSTEM_TIMER


503 
	`d–_tim”
(&
dvm_tim”
);

505 
	`di§bË_œq
(
s_vœq
);

507 
	}
}

509 
	$’abË_tim”_št
()

511 #ifdeà
USE_SYSTEM_TIMER


512 
	`add_tim”
(&
dvm_tim”
);

514 
	`’abË_œq
(
s_vœq
);

516 
	}
}

519 
	$µc_dma_m2m
(
u32
 
¤c
, u32 
de¡
, u32 
Ën
)

521 
u32
 
»g_v®ue
;

522 
u32
 
timeout
 = 1000000;

525 
»g_v®ue
 = 
	`»adl
(
DMASR0
);

526 } 
	`lik–y
(
»g_v®ue
 & 0x4è&& (--
timeout
));

527 if(!
timeout
){

528 
	`´štk
("DMAime out\n");

530 
	`wr™–
(
¤c
, 
DMASAR0
);

531 
	`wr™–
(
de¡
, 
DMADAR0
);

532 
	`wr™–
(
Ën
, 
DMABCR0
);

533 
»g_v®ue
 = (0<<26)|(0<<25)|(0<<24)|(0<<22)|(1<<20)|(0<<19)|(0<<16)|(0<<14)|(0<<7)|(0<<3)|(1<<2);

534 
	`wr™–
(
»g_v®ue
, 
DMAMR0
);

535 
»g_v®ue
 = (0<<26)|(0<<25)|(0<<24)|(0<<22)|(1<<20)|(0<<19)|(0<<16)|(0<<14)|(0<<7)|(0<<3)|(1<<2)|1;

536 
	`wr™–
(
»g_v®ue
, 
DMAMR0
);

537 
timeout
 = 1000000;

539 
»g_v®ue
 = 
	`»adl
(
DMASR0
);

540 } 
	`lik–y
(
»g_v®ue
 & 0x4è&& (--
timeout
));

541 if(
	`»adl
(
DMASR0
) & (1 << 7)){

542 
	`´štk
("DMA Txƒrr!\n");

544 if(!
timeout
){

545 
	`´štk
("DMAime out\n");

547 
	}
}

549 
	$upm_‹¡_åga
()

551 
bË1
[64]= {

570 
‹mp
;

571 
i
;

572 *
mxm¿
, *
mdr
, *
dummy
;

573 *
pågaupmcs0
;

582 *((*)(()
dvm_va_8313»gba£
+0x30)) = 0x70000000;

583 *((*)(()
dvm_va_8313»gba£
+0x34) )= 0x80000018;

584 *((*)(()
dvm_va_8313»gba£
+0x5010)) = 0x70001081;

585 *((*)(()
dvm_va_8313»gba£
+0x5014)) = 0xfe000000;

591 
mxm¿
 = (*)(()
dvm_va_8313»gba£
+0x5070);

592 
mdr
 = (*)(()
dvm_va_8313»gba£
+0x5088);

596 
pågaupmcs0
 = 
	`iÜem­
(0x70000000, 0x80000);

603 
dummy
 = (*)
pågaupmcs0
;

606 *
mxm¿
 = (*mxmra & 0xCFFFFFC0) | 0x10000000;

608 
i
 = 0; i < 64; i++)

610 *
mdr
 = 
bË1
[
i
];

612 
__asm__
 
	`__vŞ©e__
 ("sync");

614 *
dummy
=1;

616 
__asm__
 
	`__vŞ©e__
 ("sync");

620 *
mxm¿
 = (*mxmra & 0xCFFFFFC0) | 0x0000000;

621 *
mxm¿
 = 0x0819c400;

622 
‹mp
 = *
mxm¿
;

625 
	`iounm­
(
pågaupmcs0
);

632 
	}
}

634 
	$gpcm_š™
()

636 
u32
 
»g_v®ue
;

638 
»g_v®ue
 = 
	`__¿w_»adl
(
OR0
);

639 
»g_v®ue
 = 
	`__¿w_»adl
(
OR1
);

641 
»g_v®ue
 = 0xfe000df5;

643 
	`__¿w_wr™–
(
»g_v®ue
, 
OR1
);

644 
	}
}

646 
	$dvm_£t_video_time¡amp_ba£
(
¬g
)

648 
»t
 = 0;;

649 
	`di§bË_tim”_št
();

650 #ifdeà
OSD_MODULE


651 
»t
 = 
	`cİy_äom_u£r
((*)&
mpc8313_tim”
, (*)
¬g
, ());

653 
	`’abË_tim”_št
();

654  
»t
;

655 
	}
}

657 
	$dvm_g‘_video_time¡amp_ba£
(
¬g
)

659 
»t
 = 0;;

660 
	`di§bË_tim”_št
();

661 #ifdeà
OSD_MODULE


662 
»t
 = 
	`cİy_to_u£r
((*)
¬g
, (*)&
mpc8313_tim”
, ());

664 
	`’abË_tim”_št
();

665  
»t
;

666 
	}
}

668 
	$dvm_ş—r_œq_³ndšg
(
œq
)

670 
u32
 
v®
;

672 
v®
 = 
	`__¿w_»adl
(
dvm_va_8313»gba£
 + 0x72c);

673 
	`´štk
("-------->œq…’dšg: 0x%08x\n", 
v®
);

674 if(
v®
 & (0x80000000 >> 1))

676 
	`´štk
("irq1 is…ending,‚ow clear it!\n");

677 
	`__¿w_wr™–
(
v®
 | (0x80000000 >> 1), 
dvm_va_8313»gba£
 + 0x72c);

679 
	}
}

681 
	$gpio_pš_£t
(
gpio
, 
boŞ
)

683 
u32
 
v®
;

685 
boŞ
 = !!bool;

686 
v®
 = 
	`__¿w_»adl
(
dvm_va_8313»gba£
 + 0xc08);

687 if(
boŞ
)

689 
v®
 |ğ(0x80000000 >> 
gpio
);

691 
v®
 &ğ~(0x80000000 >> 
gpio
);

693 
	`__¿w_wr™–
(
v®
, 
dvm_va_8313»gba£
 + 0xc08);

696 
	}
}

698 
	$gpio_pš_š™
(
gpio
)

700 
u32
 
v®
;

702 
v®
 = 
	`__¿w_»adl
(
dvm_va_8313»gba£
 + 0x114);

703 
v®
 |= (0xc0000000 >> 8);

704 
	`__¿w_wr™–
(
v®
, 
dvm_va_8313»gba£
 + 0x114);

706 
v®
 = 
	`__¿w_»adl
(
dvm_va_8313»gba£
 + 0xc00);

707 
v®
 |ğ(0x80000000 >> 
gpio
);

708 
	`__¿w_wr™–
(
v®
, 
dvm_va_8313»gba£
 + 0xc00);

711 
	}
}

713 
	$dvm_m­_š™
()

715 
dvm_va_8313»gba£
 = 
	`iÜem­
(0xe0000000, 0x10000);

716 if(
dvm_va_8313»gba£
 =ğ
NULL
) {

717 
	`´štk
("8313„egs baseƒrr\n");

718  -
ENOMEM
;

720 
	`w©chdog_š™
(2000);

721 
	`SoáTim”In™
();

722 #iâdeà
USE_ON_CHIP_TIMER


723 
	`µc_tim”_š™
();

725 
	`gpcm_š™
();

726 #ifdeà
UPM_SYNC_MODE


727 
	`upm_‹¡_åga
();

729 
	`gpio_pš_š™
(
GPIO_PIN_29
);

732 
	}
}

734 
	$dvm_m­_ex™
()

736 
	`w©chdog_»Ëa£
();

737 if(
NULL
 !ğ
dvm_va_8313»gba£
) {

738 
	`iounm­
(
dvm_va_8313»gba£
);

739 
dvm_va_8313»gba£
 = 
NULL
;

741 
	`µc_tim”_ex™
();

742 
	}
}

	@../../tw5864/tw5864/tw_timer.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	#TIMER_INVALIDE
 (-1)

	)

4 
	#TIMER_VALIDE
 (1)

	)

7 
__s32
 
	mæag
;

8 
__u32
 
	mcouÁ
;

9 
__u32
 
	m³rcouÁ
;

10 * 
	mcÚ‹xt
;

11 
tim”Hook
 
	mhook
;

12 }
	tFORTMCB
;

15 
__s32
 
	mæag
;

16 
__u32
 
	mcouÁ
;

17 * 
	mcÚ‹xt
;

18 
tim”Hook
 
	mhook
;

19 }
	tTMCB
;

21 
SigÇlTimeIn™
();

22 
FÜTimeIn™
();

23 
G‘F»eSšgËFœeTmcb
();

24 
PutF»eSšgËFœeTmcb
(
s32
 
šdex
);

25 
G‘F»eFÜFœeFÜTmcb
();

26 
PutF»eFÜFœeTmcb
(
s32
 
šdex
);

27 
Tig”SšgËFœeTim”
();

28 
Tig”FÜFœeTim”
();

29 
SoáTim”In™
();

31 
TMCB
 
	gSšgËFœeQueue
[
MAXSINGLEFIREQUEUENUM
];

32 
FORTMCB
 
	gFÜFœeQueue
[
MAXFORFIREQUEUENUM
];

33 
¥šlock_t
 
	gsoátim”_lock
;

34 
u32
 
	gtw_sy¡em_tick”
=0;

36 
u32
 
	$g‘_tw_sy¡em_tick
()

38  
tw_sy¡em_tick”
;

39 
	}
}

41 
	$SigÇlTimeIn™
()

43 
i
;

44 
æags
;

46 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

47 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

48 
	`PutF»eSšgËFœeTmcb
(
i
);

49 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

50 
	}
}

52 
	$FÜTimeIn™
()

54 
i
;

55 
æags
;

57 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

58 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

59 
	`PutF»eFÜFœeTmcb
(
i
);

60 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

61 
	}
}

63 
	$G‘F»eSšgËFœeTmcb
()

65 
TMCB
 *
±r
;

66 
i
;

68 
±r
 = 
SšgËFœeQueue
;

69 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

71 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

72  
i
;

73 
±r
++;

75  
GETFREETMCBERROR
;

76 
	}
}

78 
	$PutF»eSšgËFœeTmcb
(
šdex
)

80 
TMCB
 *
±r
;

82 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

84 
±r
 = &
SšgËFœeQueue
[
šdex
];

85 
±r
->
hook
 = (*)0;

86 
±r
->
æag
 = 
TIMER_INVALIDE
;

87 
±r
->
couÁ
 = 0;

88 
	}
}

90 
	$G‘F»eFÜFœeFÜTmcb
()

92 
FORTMCB
 *
±r
;

93 
i
;

95 
±r
 = 
FÜFœeQueue
;

96 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

98 if(
±r
->
æag
 =ğ
TIMER_INVALIDE
)

99  
i
;

100 
±r
++;

102  
GETFREETMCBERROR
;

103 
	}
}

105 
	$PutF»eFÜFœeTmcb
(
šdex
)

107 
FORTMCB
 *
±r
;

109 if((
šdex
 >ğ
MAXSINGLEFIREQUEUENUM
) || (index < 0))

111 
±r
 = &
FÜFœeQueue
[
šdex
];

112 
±r
->
hook
 = (*)0;

113 
±r
->
æag
 = 
TIMER_INVALIDE
;

114 
±r
->
couÁ
 = 0;

115 
±r
->
³rcouÁ
 = 0;

116 
	}
}

118 
	$Tig”SšgËFœeTim”
()

120 
TMCB
 *
±r
;

121 
i
;

123 
±r
 = 
SšgËFœeQueue
;

124 
i
=0; i<
MAXSINGLEFIREQUEUENUM
; i++)

126 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

128 if(
±r
->
hook
 != (*)0)

130 if(
±r
->
couÁ
 > 0)

131 
±r
->
couÁ
--;

134 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

135 
	`PutF»eSšgËFœeTmcb
(
i
);

139 
	`PutF»eSšgËFœeTmcb
(
i
);

141 
±r
++;

143 
	}
}

145 
	$Tig”FÜFœeTim”
()

147 
FORTMCB
 *
±r
;

148 
i
;

150 
±r
 = 
FÜFœeQueue
;

151 
i
=0; i<
MAXFORFIREQUEUENUM
; i++)

153 if(
±r
->
æag
 =ğ
TIMER_VALIDE
)

155 if(
±r
->
hook
 != (*)0)

157 if(
±r
->
couÁ
 > 0)

158 
±r
->
couÁ
--;

161 
±r
->
	`hook
ÕŒ->
cÚ‹xt
);

162 
±r
->
couÁ
 =…Œ->
³rcouÁ
;

166 
	`PutF»eFÜFœeTmcb
(
i
);

168 
±r
++;

170 
	}
}

172 
	$SoáTim”In™
()

174 
	`¥š_lock_š™
(&
soátim”_lock
);

175 
	`SigÇlTimeIn™
();

176 
	`FÜTimeIn™
();

177 
	}
}

179 
	$Re£tSigÇlTim”
()

181 
	`SigÇlTimeIn™
();

182 
	}
}

184 
	$Re£tFÜTim”
()

186 
	`FÜTimeIn™
();

187 
	}
}

189 
	$AddSšgËFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

191 
TMCB
 *
±r
;

192 
æags
;

193 
šdex
;

195 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

196  
ADDJOBERROR
;

197 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

198 
šdex
 = 
	`G‘F»eSšgËFœeTmcb
();

199 if(
šdex
 =ğ
GETFREETMCBERROR
)

201 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

202  
ADDJOBERROR
;

204 
±r
 = &
SšgËFœeQueue
[
šdex
];

205 
±r
->
æag
 = 
TIMER_VALIDE
;

206 
±r
->
couÁ
 = 
tick
;

207 
±r
->
cÚ‹xt
 = context;

208 
±r
->
hook
 = 
fun
;

209 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

210  
šdex
;

211 
	}
}

213 
	$D–‘eSšgËFœeTim”Job
(
šdex
)

215 
æags
;

217 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

218 
	`PutF»eSšgËFœeTmcb
(
šdex
);

219 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

220 
	}
}

222 
	$AddFÜFœeTim”Job
(
u32
 
tick
, 
tim”Hook
 
fun
, * 
cÚ‹xt
)

224 
FORTMCB
 *
±r
;

225 
šdex
;

226 
æags
;

228 if((
fun
 =ğ(*)0è|| (
tick
 == 0))

229  
ADDJOBERROR
;

230 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

231 
šdex
 = 
	`G‘F»eFÜFœeFÜTmcb
();

232 if(
šdex
 =ğ
GETFREETMCBERROR
)

234 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

235  
ADDJOBERROR
;

237 
±r
 = &
FÜFœeQueue
[
šdex
];

238 
±r
->
æag
 = 
TIMER_VALIDE
;

239 
±r
->
³rcouÁ
 =…Œ->
couÁ
 = 
tick
;

240 
±r
->
cÚ‹xt
 = context;

241 
±r
->
hook
 = 
fun
;

242 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

243  
šdex
;

244 
	}
}

246 
	$D–‘eFÜFœeTim”Job
(
šdex
)

248 
æags
;

250 
	`¥š_lock_œq§ve
(&
soátim”_lock
, 
æags
);

251 
	`PutF»eFÜFœeTmcb
(
šdex
);

252 
	`¥š_uÆock_œq»¡Üe
(&
soátim”_lock
, 
æags
);

253 
	}
}

	@../../tw5864/tw5864/tw_vb_common.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$tw_vb_·ck‘_tcb_š™
(
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
, 
tw_vb_poŞ_t
 *
poŞ
, 
id
)

5 if((
vb_·ck‘_tcb
!=
NULL
è&& (
poŞ
!=NULL)){

6 
tcb_node_t
 *
node
 = &
vb_·ck‘_tcb
->
·ck‘_node
;

7 
	`¥š_lock_š™
(&
vb_·ck‘_tcb
->
lock
);

8 
	`©omic_£t
(&
vb_·ck‘_tcb
->
»f_couÁ
, 0);

9 
node
->
İ
 = &
tcb_node_İ
;

10 
node
->
İ
->
	`š™
(node);

11 
node
->
İ
->
	`£t_´iv
Òode, 
vb_·ck‘_tcb
);

12 
vb_·ck‘_tcb
->
·ck‘_id
 = 
id
;

13 
vb_·ck‘_tcb
->
·ck‘_size
 = 
poŞ
->
vb_·ck‘_bufãr_size
;

14 
vb_·ck‘_tcb
->
·ylßd_Ën
 = 0;

15 
vb_·ck‘_tcb
->
cÚsum”_Ën
 = 0;

16 
vb_·ck‘_tcb
->
d©a
 = &
poŞ
->
ÿche_bufãr
[poŞ->
vb_·ck‘_bufãr_size
*
id
];

17 
vb_·ck‘_tcb
->
dma_addr
 = 0;

18 
vb_·ck‘_tcb
->
id_of_·ck‘_queue
 = 0;

20 
	}
}

22 
	$tw_vb_·ck‘_tcb_»£t
(
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
)

24 if(
vb_·ck‘_tcb
!=
NULL
){

25 
	`©omic_£t
(&
vb_·ck‘_tcb
->
»f_couÁ
, 0);

26 
vb_·ck‘_tcb
->
·ylßd_Ën
 = 0;

27 
vb_·ck‘_tcb
->
cÚsum”_Ën
 = 0;

28 
vb_·ck‘_tcb
->
dma_addr
 = 0;

29 
vb_·ck‘_tcb
->
id_of_·ck‘_queue
 = 0;

31 
	}
}

33 
	$tw_vb_·ck‘_tcb_»Ëa£
(
tw_vb_·ck‘_tcb_t
 **
±r_vb_·ck‘_tcb
, 
tw_vb_poŞ_t
 *
poŞ
)

35 if((*
±r_vb_·ck‘_tcb
!=
NULL
è&& (
poŞ
!=NULL)){

36 
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
 = *
±r_vb_·ck‘_tcb
;

37 
æags
;

39 
	`¥š_lock_œq§ve
(&
vb_·ck‘_tcb
->
lock
, 
æags
);

40 if(
	`©omic_»ad
(&
vb_·ck‘_tcb
->
»f_couÁ
) > 1){

41 
	`©omic_dec
(&
vb_·ck‘_tcb
->
»f_couÁ
);

43 
tcb_node_t
 *
node
;

44 if(
vb_·ck‘_tcb
->
İ
 !ğ
NULL
){

45 
vb_·ck‘_tcb
->
İ
->
	`»£t
(vb_packet_tcb);

47 
node
 = &
vb_·ck‘_tcb
->
·ck‘_node
;

48 if(
node
->
İ
 !ğ
NULL
){

49 
node
->
İ
->
	`»Ëa£
Òode, &
poŞ
->
vb_·ck‘_poŞ_tcb
);

52 *
±r_vb_·ck‘_tcb
 = 
NULL
;

53 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_tcb
->
lock
, 
æags
);

55 
	}
}

57 
	$tw_vb_·ck‘_tcb_»ã»nû
(
tw_vb_·ck‘_tcb_t
 *
¤c_vb_·ck‘_tcb
,w_vb_·ck‘_tcb_ˆ**
±r_de¡_vb_·ck‘_tcb
)

59 if((
¤c_vb_·ck‘_tcb
!=
NULL
è&& (
±r_de¡_vb_·ck‘_tcb
!=NULL)){

60 
æags
;

62 
	`¥š_lock_œq§ve
(&
¤c_vb_·ck‘_tcb
->
lock
, 
æags
);

63 
	`©omic_šc
(&
¤c_vb_·ck‘_tcb
->
»f_couÁ
);

64 *
±r_de¡_vb_·ck‘_tcb
 = 
¤c_vb_·ck‘_tcb
;

65 
	`¥š_uÆock_œq»¡Üe
(&
¤c_vb_·ck‘_tcb
->
lock
, 
æags
);

67 
	}
}

69 
	$tw_vb_·ck‘_tcb_dma_m­
(
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

71 if(
vb_·ck‘_tcb
 !ğ
NULL
) {

72 if(
vb_·ck‘_tcb
->
d©a
 !ğ
NULL
) {

73 
vb_·ck‘_tcb
->
dma_addr
 = 
	`dma_m­_sšgË
(
NULL
, vb_·ck‘_tcb->
d©a
, vb_·ck‘_tcb->
·ck‘_size
, 
dœeùiÚ
);

74 ià(
vb_·ck‘_tcb
->
dma_addr
 == 0){

75 
	`´štk
("%s.%dƒ¼\n", 
__FUNCTION__
, 
__LINE__
);

79 
	}
}

81 
	$tw_vb_·ck‘_tcb_dma_unm­
(
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
, 
dma_d©a_dœeùiÚ
 
dœeùiÚ
)

83 if(
vb_·ck‘_tcb
 !ğ
NULL
) {

84 ià(
vb_·ck‘_tcb
->
dma_addr
 != 0) {

85 
	`dma_unm­_sšgË
(
NULL
, 
vb_·ck‘_tcb
->
dma_addr
, vb_·ck‘_tcb->
·ck‘_size
, 
dœeùiÚ
);

86 
vb_·ck‘_tcb
->
dma_addr
 = 0;

89 
	}
}

91 
size_t
 
	$tw_vb_·ck‘_tcb_subm™
(
tw_vb_·ck‘_tcb_t
 *
·ck‘
, 
__u£r
 *
d©a
, 
size_t
 
couÁ
, 
loff_t
 *
µos
, 
š£¹_03_¡©e_machše_t
 *
machše
)

93 
loff_t
 
buf_off£t
 = 0;

94 
__u£r
 *
de¡_d©a_±r
;

95 *
¤c_d©a_±r
;

96 if(
·ck‘
 !ğ
NULL
){

97 
machše
->
Œªsãr
 = 
·ck‘
->
·ylßd_Ën
 -…ack‘->
cÚsum”_Ën
;

98 
¤c_d©a_±r
 = 
·ck‘
->
d©a
 +…ack‘->
cÚsum”_Ën
;

99 
de¡_d©a_±r
 = 
d©a
;

101 
	`cİy_to_u£r
(
de¡_d©a_±r
, 
¤c_d©a_±r
, 
machše
->
Œªsãr
);

102 
buf_off£t
 = 
machše
->
Œªsãr
;

104 *
µos
 +ğ
buf_off£t
;

105  (
size_t
)
buf_off£t
;

106 
	}
}

108 
tw_vb_·ck‘_İ”©iÚ
 
	gtw_vb_·ck‘_tcb_İ
 = {

109 .
š™
 = 
tw_vb_·ck‘_tcb_š™
,

110 .
	g»£t
 = 
tw_vb_·ck‘_tcb_»£t
,

111 .
	g»Ëa£
 = 
tw_vb_·ck‘_tcb_»Ëa£
,

112 .
	g»ã»nû
 = 
tw_vb_·ck‘_tcb_»ã»nû
,

114 .
	gdma_m­
 = 
tw_vb_·ck‘_tcb_dma_m­
,

115 .
	gdma_unm­
 = 
tw_vb_·ck‘_tcb_dma_unm­
,

117 .
	gsubm™
 = 
tw_vb_·ck‘_tcb_subm™
,

120 
	$tw_vb_·ck‘_queue_g‘
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 **
±r_vb_·ck‘_tcb
)

122 if((
vb_·ck‘_queue
!=
NULL
è&& (
±r_vb_·ck‘_tcb
!=NULL)){

123 
tcb_node_queue_t
 *
queue
;

124 *
±r_vb_·ck‘_tcb
 = 
NULL
;

125 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

126 if(
queue
->
İ
 !ğ
NULL
){

127 
tcb_node_t
 *
‹mp_node
;

128 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

129 if(
‹mp_node
 !ğ
NULL
){

130 *
±r_vb_·ck‘_tcb
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

134 
	}
}

136 
	$tw_vb_·ck‘_queue_Œy_g‘
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 **
±r_vb_·ck‘_tcb
)

138 if((
vb_·ck‘_queue
!=
NULL
è&& (
±r_vb_·ck‘_tcb
!=NULL)){

139 
tcb_node_queue_t
 *
queue
;

140 *
±r_vb_·ck‘_tcb
 = 
NULL
;

141 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

142 if(
queue
->
İ
 !ğ
NULL
){

143 
tcb_node_t
 *
‹mp_node
;

144 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

145 if(
‹mp_node
 !ğ
NULL
){

146 *
±r_vb_·ck‘_tcb
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

150 
	}
}

152 
	$tw_vb_·ck‘_queue_g‘_”
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 **
±r_vb_·ck‘_tcb
)

154 if((
vb_·ck‘_queue
!=
NULL
è&& (
±r_vb_·ck‘_tcb
!=NULL)){

155 
tcb_node_queue_t
 *
queue
;

156 *
±r_vb_·ck‘_tcb
 = 
NULL
;

157 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

158 if(
queue
->
İ
 !ğ
NULL
){

159 
tcb_node_t
 *
‹mp_node
;

160 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

161 if(
‹mp_node
 !ğ
NULL
){

162 *
±r_vb_·ck‘_tcb
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

166 
	}
}

168 
	$tw_vb_·ck‘_queue_Œy_g‘_”
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 **
±r_vb_·ck‘_tcb
)

170 if((
vb_·ck‘_queue
!=
NULL
è&& (
±r_vb_·ck‘_tcb
!=NULL)){

171 
tcb_node_queue_t
 *
queue
;

172 *
±r_vb_·ck‘_tcb
 = 
NULL
;

173 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

174 if(
queue
->
İ
 !ğ
NULL
){

175 
tcb_node_t
 *
‹mp_node
;

176 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

177 if(
‹mp_node
 !ğ
NULL
){

178 *
±r_vb_·ck‘_tcb
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

182 
	}
}

184 
	$tw_vb_·ck‘_queue_put
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
)

186 if((
vb_·ck‘_queue
!=
NULL
è&& (
vb_·ck‘_tcb
!=NULL)){

187 
tcb_node_queue_t
 *
queue
;

188 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

189 if(
queue
->
İ
 !ğ
NULL
){

190 
queue
->
İ
->
	`put
(queue, &
vb_·ck‘_tcb
->
·ck‘_node
);

191 
vb_·ck‘_tcb
->
id_of_·ck‘_queue
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

194 
	}
}

196 
	$tw_vb_·ck‘_queue_put_h—d”
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_·ck‘_tcb_t
 *
vb_·ck‘_tcb
)

198 if((
vb_·ck‘_queue
!=
NULL
è&& (
vb_·ck‘_tcb
!=NULL)){

199 
tcb_node_queue_t
 *
queue
;

200 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

201 if(
queue
->
İ
 !ğ
NULL
){

202 
queue
->
İ
->
	`put_h—d”
(queue, &
vb_·ck‘_tcb
->
·ck‘_node
);

205 
	}
}

207 
	$tw_vb_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

209 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

210 
æags
;

211 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

212 if(
vb_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
){

213 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

214 if(
poŞ
->
İ
 !ğ
NULL
){

215 
poŞ
->
İ
->
	`g‘_·ck‘_tcb
ÕoŞ, &
vb_·ck‘_queue
->
cu¼_´oduûr
);

220 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

222 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

224 
	}
}

226 
	$tw_vb_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

228 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

229 
æags
;

230 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

231 if(
vb_·ck‘_queue
->
cu¼_´oduûr
 =ğ
NULL
){

232 if(
poŞ
->
İ
 !ğ
NULL
){

233 
poŞ
->
İ
->
	`Œy_g‘_·ck‘_tcb
ÕoŞ, &
vb_·ck‘_queue
->
cu¼_´oduûr
);

239 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

242 
	}
}

244 
	$tw_vb_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

246 if(
vb_·ck‘_queue
 !ğ
NULL
){

247 
æags
;

248 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

249 if(
vb_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

251 if(
vb_·ck‘_queue
->
İ
 !ğ
NULL
){

252 
vb_·ck‘_queue
->
İ
->
	`put
(vb_·ck‘_queue, vb_·ck‘_queue->
cu¼_´oduûr
);

254 
	`tw_vb_·ck‘_queue_put
(
vb_·ck‘_queue
, vb_·ck‘_queue->
cu¼_´oduûr
);

256 
vb_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

258 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

260 
	}
}

262 
	$tw_vb_·ck‘_queue_»Ëa£_cu¼_´oduûr
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

264 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

265 
æags
;

266 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

267 if(
vb_·ck‘_queue
->
cu¼_´oduûr
 !ğ
NULL
){

268 if(
vb_·ck‘_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

269 
vb_·ck‘_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&vb_·ck‘_queue->cu¼_´oduûr, 
poŞ
);

271 
	`tw_vb_·ck‘_tcb_»Ëa£
(&
vb_·ck‘_queue
->
cu¼_´oduûr
, 
poŞ
);

274 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

276 
	}
}

278 
	$tw_vb_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

280 if(
vb_·ck‘_queue
 !ğ
NULL
){

281 
æags
;

282 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

283 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

284 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

285 if(
vb_·ck‘_queue
->
İ
 !ğ
NULL
){

286 
vb_·ck‘_queue
->
İ
->
	`g‘
(vb_·ck‘_queue, &vb_·ck‘_queue->
cu¼_cÚsum”
);

288 
	`tw_vb_·ck‘_queue_g‘
(
vb_·ck‘_queue
, &vb_·ck‘_queue->
cu¼_cÚsum”
);

290 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

292 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

294 
	}
}

296 
	$tw_vb_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

298 if(
vb_·ck‘_queue
 !ğ
NULL
){

299 
æags
;

300 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

301 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

302 if(
vb_·ck‘_queue
->
İ
 !ğ
NULL
){

303 
vb_·ck‘_queue
->
İ
->
	`Œy_g‘
(vb_·ck‘_queue, &vb_·ck‘_queue->
cu¼_cÚsum”
);

305 
	`tw_vb_·ck‘_queue_Œy_g‘
(
vb_·ck‘_queue
, &vb_·ck‘_queue->
cu¼_cÚsum”
);

308 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

310 
	}
}

312 
	$tw_vb_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

314 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

315 
æags
;

318 
	`¥š_lock_œq§ve
(&
vb_·ck‘_queue
->
lock
, 
æags
);

319 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

320 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

321 
vb_·ck‘_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&vb_·ck‘_queue->cu¼_cÚsum”, 
poŞ
);

323 
	`tw_vb_·ck‘_tcb_»Ëa£
(&
vb_·ck‘_queue
->
cu¼_cÚsum”
, 
poŞ
);

326 
	`¥š_uÆock_œq»¡Üe
(&
vb_·ck‘_queue
->
lock
, 
æags
);

330 
	}
}

332 
	$tw_vb_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

334 
’Œy_numb”
 = 0;

335 if(
vb_·ck‘_queue
!=
NULL
){

336 
tcb_node_queue_t
 *
queue
;

337 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

338 if(
queue
->
İ
 !ğ
NULL
){

339 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

342  
’Œy_numb”
;

343 
	}
}

345 
	$tw_vb_·ck‘_queue_»Ëa£
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

347 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

348 
	`tw_de¡roy_·ck‘_tcb_queue
(
vb_·ck‘_queue
, 
poŞ
);

350 
	}
}

352 
	$tw_vb_·ck‘_queue_š™
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

354 if(
vb_·ck‘_queue
 !ğ
NULL
){

355 
tcb_node_queue_t
 *
queue
;

356 
queue
 = &
vb_·ck‘_queue
->
queue_node
;

357 
queue
->
İ
 = &
tcb_node_queue_İ
;

358 
queue
->
İ
->
	`š™
(queue);

359 
vb_·ck‘_queue
->
cu¼_cÚsum”
 = 
NULL
;

360 
vb_·ck‘_queue
->
cu¼_´oduûr
 = 
NULL
;

361 
vb_·ck‘_queue
->
¡¬t_time¡amp
 = 0;

362 
vb_·ck‘_queue
->
tÙ®_du¿tiÚ
 = 0;

363 
	`¥š_lock_š™
(&
vb_·ck‘_queue
->
lock
);

365 
	}
}

367 
tw_vb_·ck‘_queue_İ”©iÚ
 
	gtw_vb_·ck‘_queue_İ
 = {

368 .
g‘
 = 
tw_vb_·ck‘_queue_g‘
,

369 .
	gŒy_g‘
 = 
tw_vb_·ck‘_queue_Œy_g‘
,

370 .
	gg‘_”
 = 
tw_vb_·ck‘_queue_g‘_”
,

371 .
	gŒy_g‘_”
 = 
tw_vb_·ck‘_queue_Œy_g‘_”
,

372 .
	gput
 = 
tw_vb_·ck‘_queue_put
,

373 .
	gput_h—d”
 = 
tw_vb_·ck‘_queue_put_h—d”
,

375 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_vb_·ck‘_queue_g‘_cu¼_´oduûr_äom_poŞ
,

376 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_vb_·ck‘_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

377 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_vb_·ck‘_queue_put_cu¼_´oduûr_što_queue
,

378 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_vb_·ck‘_queue_»Ëa£_cu¼_´oduûr
,

379 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_vb_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
,

380 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_vb_·ck‘_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

381 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_vb_·ck‘_queue_»Ëa£_cu¼_cÚsum”
,

383 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_vb_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
,

384 .
	g»Ëa£
 = 
tw_vb_·ck‘_queue_»Ëa£
,

385 .
	gš™
 = 
tw_vb_·ck‘_queue_š™
,

388 
	$tw_ü—‹_·ck‘_tcb_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
)

390 if(
vb_·ck‘_queue
 !ğ
NULL
){

391 
vb_·ck‘_queue
->
İ
 = &
tw_vb_·ck‘_queue_İ
;

392 
vb_·ck‘_queue
->
İ
->
	`š™
(vb_packet_queue);

394 
	}
}

396 
	$tw_de¡roy_·ck‘_tcb_queue
(
tw_vb_·ck‘_tcb_queue_t
 *
vb_·ck‘_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

398 if((
vb_·ck‘_queue
!=
NULL
è&& (
poŞ
!=NULL)){

399 if(
vb_·ck‘_queue
->
İ
 !ğ
NULL
){

400 
vb_·ck‘_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(vb_packet_queue);

401 
vb_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vb_·ck‘_queue, 
poŞ
);

402 
vb_·ck‘_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vb_packet_queue)){

403 
vb_·ck‘_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(vb_packet_queue);

404 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

407 
vb_·ck‘_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vb_·ck‘_queue, 
poŞ
);

410 
	`tw_vb_·ck‘_queue_put_cu¼_´oduûr_što_queue
(
vb_·ck‘_queue
);

411 
	`tw_vb_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
vb_·ck‘_queue
, 
poŞ
);

412 
	`tw_vb_·ck‘_queue_g‘_cu¼_queue_’Œy_numb”
(
vb_·ck‘_queue
)){

413 
	`tw_vb_·ck‘_queue_g‘_cu¼_cÚsum”_äom_queue
(
vb_·ck‘_queue
);

414 if(
vb_·ck‘_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

417 
	`tw_vb_·ck‘_queue_»Ëa£_cu¼_cÚsum”
(
vb_·ck‘_queue
, 
poŞ
);

421 
	}
}

423 
	$tw_vb_äame_tcb_Çl_š™
(
h264_Çl_t
 *
Çl
)

425 if(
Çl
 !ğ
NULL
){

426 
	`mem£t
(
Çl
, 0, (
h264_Çl_t
));

427 
Çl
->
¥s_·ylßd
 =‚®->
µs_·ylßd
 =‚®->
¦iû_·ylßd
 =‚®->
¦iû_h—d_buf
;

428 
Çl
->
¥s_·ysize
 =‚®->
µs_·ysize
 =‚®->
¦iû_·ysize
 = 0;

430 
	}
}

432 
	$tw_vb_äame_tcb_š™
(
tw_vb_äame_tcb_t
 *
äame
)

434 if(
äame
!=
NULL
){

435 
tcb_node_t
 *
node
 = &
äame
->
äame_node
;

436 
node
->
İ
 = &
tcb_node_İ
;

437 
node
->
İ
->
	`š™
(node);

438 
node
->
İ
->
	`£t_´iv
Òode, 
äame
);

440 
	`¥š_lock_š™
(&
äame
->
lock
);

441 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

442 
äame
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

443 
	`tw_vb_äame_tcb_Çl_š™
(&
äame
->
Çl
);

444 
äame
->
äame_Ën
 = 0;

445 
äame
->
cÚsum”_äame_off£t
 = 0;

446 
äame
->
time¡amp
 = 0;

447 
äame
->
i_š™_qp
 = 
DEFAULT_QP
;

448 
äame
->
i_cu¼_qp
 = 0;

449 
äame
->
i_mb_x
 = 0;

450 
äame
->
i_mb_y
 = 0;

451 
äame
->
äame_numb”
 = 0;

452 
äame
->
äame_is_”r
 = 0;

453 
äame
->
äame_æags
 = 0;

454 
	`tw_ü—‹_·ck‘_tcb_queue
(&
äame
->
vb_·ck‘_queue
);

456 
	}
}

458 
	$tw_vb_äame_tcb_»£t
(
tw_vb_äame_tcb_t
 *
äame
)

460 if(
äame
 !ğ
NULL
){

461 
	`©omic_£t
(&
äame
->
»f_couÁ
, 0);

462 
äame
->
äame_ty³
 = 
H264_FRAME_TYPE_IDR
;

463 
	`tw_vb_äame_tcb_Çl_š™
(&
äame
->
Çl
);

464 
äame
->
äame_Ën
 = 0;

465 
äame
->
cÚsum”_äame_off£t
 = 0;

466 
äame
->
time¡amp
 = 0;

467 
äame
->
i_š™_qp
 = 
DEFAULT_QP
;

468 
äame
->
i_cu¼_qp
 = 0;

469 
äame
->
i_mb_x
 = 0;

470 
äame
->
i_mb_y
 = 0;

471 
äame
->
äame_numb”
 = 0;

472 
äame
->
äame_is_”r
 = 0;

473 
äame
->
äame_æags
 = 0;

475 
	}
}

477 
	$tw_vb_äame_tcb_»Ëa£
(
tw_vb_äame_tcb_t
 **
±r_äame
, 
tw_vb_poŞ_t
 *
poŞ
)

479 if(
±r_äame
 !ğ
NULL
){

480 
tw_vb_äame_tcb_t
 *
äame
 = *
±r_äame
;

481 
æags
;

482 if(
poŞ
 =ğ
NULL
){

483 
poŞ
 = 
äame
->pool;

485 
	`¥š_lock_œq§ve
(&
äame
->
lock
, 
æags
);

486 if(
	`©omic_»ad
(&
äame
->
»f_couÁ
) > 1){

487 
	`©omic_dec
(&
äame
->
»f_couÁ
);

489 
tcb_node_t
 *
node
;

490 if(
äame
->
İ
 !ğ
NULL
){

491 
äame
->
İ
->
	`»£t
(frame);

493 if(
äame
->
vb_·ck‘_queue
.
İ
 !ğ
NULL
){

494 
äame
->
vb_·ck‘_queue
.
İ
->
	`»Ëa£
(&äame->vb_·ck‘_queue, 
poŞ
);

496 
	`tw_vb_·ck‘_queue_»Ëa£
(&
äame
->
vb_·ck‘_queue
, 
poŞ
);

498 
node
 = &
äame
->
äame_node
;

499 if(
node
->
İ
 !ğ
NULL
){

500 
node
->
İ
->
	`»Ëa£
Òode, &
poŞ
->
vb_äame_poŞ_tcb
);

503 *
±r_äame
 = 
NULL
;

504 
	`¥š_uÆock_œq»¡Üe
(&
äame
->
lock
, 
æags
);

506 
	}
}

508 
	$tw_vb_äame_tcb_»ã»nû
(
tw_vb_äame_tcb_t
 *
¤c_äame
,w_vb_äame_tcb_ˆ**
±r_de¡_äame
)

510 if((
¤c_äame
!=
NULL
è&& (
±r_de¡_äame
!=NULL)){

511 
æags
;

512 
	`¥š_lock_œq§ve
(&
¤c_äame
->
lock
, 
æags
);

513 
	`©omic_šc
(&
¤c_äame
->
»f_couÁ
);

514 *
±r_de¡_äame
 = 
¤c_äame
;

515 
	`¥š_uÆock_œq»¡Üe
(&
¤c_äame
->
lock
, 
æags
);

517 
	}
}

519 
tw_vb_äame_tcb_İ”©iÚ
 
	gtw_vb_äame_tcb_İ
 = {

520 .
š™
 = 
tw_vb_äame_tcb_š™
,

521 .
	g»£t
 = 
tw_vb_äame_tcb_»£t
,

522 .
	g»Ëa£
 = 
tw_vb_äame_tcb_»Ëa£
,

523 .
	g»ã»nû
 = 
tw_vb_äame_tcb_»ã»nû
,

525 .
	gsubm™
 = 
NULL
,

528 
	$tw_vb_äame_queue_g‘
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 **
±r_äame
)

530 if((
vb_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

531 
tcb_node_queue_t
 *
queue
;

532 *
±r_äame
 = 
NULL
;

533 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

534 if(
queue
->
İ
 !ğ
NULL
){

535 
tcb_node_t
 *
‹mp_node
;

536 
queue
->
İ
->
	`g‘
(queue, &
‹mp_node
);

537 if(
‹mp_node
 !ğ
NULL
){

538 *
±r_äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

542 
	`´štk
("\n%s.%d**©‹ÁiÚ**\n", 
__FUNCTION__
, 
__LINE__
);

544 
	}
}

546 
	$tw_vb_äame_queue_Œy_g‘
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 **
±r_äame
)

548 if((
vb_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

549 
tcb_node_queue_t
 *
queue
;

550 *
±r_äame
 = 
NULL
;

551 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

552 if(
queue
->
İ
 !ğ
NULL
){

553 
tcb_node_t
 *
‹mp_node
;

554 
queue
->
İ
->
	`Œy_g‘
(queue, &
‹mp_node
);

555 if(
‹mp_node
 !ğ
NULL
){

556 *
±r_äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

560 
	}
}

562 
	$tw_vb_äame_queue_g‘_”
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 **
±r_äame
)

564 if((
vb_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

565 
tcb_node_queue_t
 *
queue
;

566 *
±r_äame
 = 
NULL
;

567 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

568 if(
queue
->
İ
 !ğ
NULL
){

569 
tcb_node_t
 *
‹mp_node
;

570 
queue
->
İ
->
	`g‘_”
(queue, &
‹mp_node
);

571 if(
‹mp_node
 !ğ
NULL
){

572 *
±r_äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

576 
	}
}

578 
	$tw_vb_äame_queue_Œy_g‘_”
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 **
±r_äame
)

580 if((
vb_äame_tcb_queue
!=
NULL
è&& (
±r_äame
!=NULL)){

581 
tcb_node_queue_t
 *
queue
;

582 *
±r_äame
 = 
NULL
;

583 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

584 if(
queue
->
İ
 !ğ
NULL
){

585 
tcb_node_t
 *
‹mp_node
;

586 
queue
->
İ
->
	`Œy_g‘_”
(queue, &
‹mp_node
);

587 if(
‹mp_node
 !ğ
NULL
){

588 *
±r_äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

592 
	}
}

594 
	$tw_vb_äame_queue_put
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 *
äame
)

596 if((
vb_äame_tcb_queue
!=
NULL
è&& (
äame
!=NULL)){

597 
tcb_node_queue_t
 *
queue
;

598 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

599 if(
queue
->
İ
 !ğ
NULL
){

600 
queue
->
İ
->
	`put
(queue, &
äame
->
äame_node
);

603 
	}
}

605 
	$tw_vb_äame_queue_put_h—d”
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_äame_tcb_t
 *
äame
)

607 if((
vb_äame_tcb_queue
!=
NULL
è&& (
äame
!=NULL)){

608 
tcb_node_queue_t
 *
queue
;

609 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

610 if(
queue
->
İ
 !ğ
NULL
){

611 
queue
->
İ
->
	`put_h—d”
(queue, &
äame
->
äame_node
);

614 
	}
}

616 
	$tw_vb_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

618 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

619 
æags
;

620 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

621 if(
vb_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

622 
	`´štk
("%s,%d: g‘‡ j³g f¿me!\n", 
__FUNCTION__
, 
__LINE__
);

623 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

624 if(
poŞ
->
İ
 !ğ
NULL
){

625 
poŞ
->
İ
->
	`g‘_äame_tcb
ÕoŞ, &
vb_äame_tcb_queue
->
cu¼_´oduûr
);

627 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

629 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

631 
	}
}

633 
	$tw_vb_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

635 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

636 
æags
;

637 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

638 if(
vb_äame_tcb_queue
->
cu¼_´oduûr
 =ğ
NULL
){

639 if(
poŞ
->
İ
 !ğ
NULL
){

641 
poŞ
->
İ
->
	`Œy_g‘_äame_tcb
ÕoŞ, &
vb_äame_tcb_queue
->
cu¼_´oduûr
);

644 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

646 
	}
}

648 
	$tw_vb_äame_queue_put_cu¼_´oduûr_što_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

650 if(
vb_äame_tcb_queue
 !ğ
NULL
){

651 
æags
;

652 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

653 if(
vb_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

654 if(
vb_äame_tcb_queue
->
İ
 !ğ
NULL
){

655 
vb_äame_tcb_queue
->
İ
->
	`put
(vb_äame_tcb_queue, vb_äame_tcb_queue->
cu¼_´oduûr
);

657 
	`tw_vb_äame_queue_put
(
vb_äame_tcb_queue
, vb_äame_tcb_queue->
cu¼_´oduûr
);

659 
vb_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

661 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

663 
	}
}

665 
	$tw_vb_äame_queue_»Ëa£_cu¼_´oduûr
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

667 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

668 
æags
;

669 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

670 if(
vb_äame_tcb_queue
->
cu¼_´oduûr
 !ğ
NULL
){

671 if(
vb_äame_tcb_queue
->
cu¼_´oduûr
->
İ
 !ğ
NULL
){

672 
vb_äame_tcb_queue
->
cu¼_´oduûr
->
İ
->
	`»Ëa£
(&vb_äame_tcb_queue->cu¼_´oduûr, 
poŞ
);

674 
	`tw_vb_äame_tcb_»Ëa£
(&
vb_äame_tcb_queue
->
cu¼_´oduûr
, 
poŞ
);

677 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

679 
	}
}

681 
	$tw_vb_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

683 if(
vb_äame_tcb_queue
 !ğ
NULL
){

684 
æags
;

685 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

686 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

687 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

688 if(
vb_äame_tcb_queue
->
İ
 !ğ
NULL
){

689 
vb_äame_tcb_queue
->
İ
->
	`g‘
(vb_äame_tcb_queue, &vb_äame_tcb_queue->
cu¼_cÚsum”
);

691 
	`tw_vb_äame_queue_g‘
(
vb_äame_tcb_queue
, &vb_äame_tcb_queue->
cu¼_cÚsum”
);

693 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

695 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

697 
	`´štk
("\n%s.%d**©‹ÁiÚ**\n", 
__FUNCTION__
, 
__LINE__
);

699 
	}
}

701 
	$tw_vb_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

703 if(
vb_äame_tcb_queue
 !ğ
NULL
){

704 
æags
;

705 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

706 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

707 if(
vb_äame_tcb_queue
->
İ
 !ğ
NULL
){

708 
vb_äame_tcb_queue
->
İ
->
	`Œy_g‘
(vb_äame_tcb_queue, &vb_äame_tcb_queue->
cu¼_cÚsum”
);

710 
	`tw_vb_äame_queue_Œy_g‘
(
vb_äame_tcb_queue
, &vb_äame_tcb_queue->
cu¼_cÚsum”
);

713 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

715 
	}
}

717 
	$tw_vb_äame_queue_»Ëa£_cu¼_cÚsum”
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

719 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

720 
æags
;

721 
	`¥š_lock_œq§ve
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

722 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
 !ğ
NULL
){

723 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
 !ğ
NULL
){

725 
vb_äame_tcb_queue
->
cu¼_cÚsum”
->
İ
->
	`»Ëa£
(&vb_äame_tcb_queue->cu¼_cÚsum”, 
poŞ
);

727 
	`tw_vb_äame_tcb_»Ëa£
(&
vb_äame_tcb_queue
->
cu¼_cÚsum”
, 
poŞ
);

730 
	`¥š_uÆock_œq»¡Üe
(&
vb_äame_tcb_queue
->
lock
, 
æags
);

732 
	}
}

734 
	$tw_vb_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

736 
’Œy_numb”
 = 0;

737 if(
vb_äame_tcb_queue
!=
NULL
){

738 
tcb_node_queue_t
 *
queue
;

739 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

740 if(
queue
->
İ
 !ğ
NULL
){

741 
’Œy_numb”
 = 
queue
->
İ
->
	`g‘_queue_cu¼_’Œy_numb”
(queue);

744  
’Œy_numb”
;

745 
	}
}

747 
	$tw_vb_äame_queue_»Ëa£
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

749 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

750 
	`tw_de¡roy_äame_tcb_queue
(
vb_äame_tcb_queue
, 
poŞ
);

752 
	}
}

754 
	$tw_vb_äame_queue_š™
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

756 if(
vb_äame_tcb_queue
 !ğ
NULL
){

757 
tcb_node_queue_t
 *
queue
;

758 
queue
 = &
vb_äame_tcb_queue
->
queue_node
;

759 
queue
->
İ
 = &
tcb_node_queue_İ
;

760 
queue
->
İ
->
	`š™
(queue);

761 
vb_äame_tcb_queue
->
cu¼_cÚsum”
 = 
NULL
;

762 
vb_äame_tcb_queue
->
cu¼_´oduûr
 = 
NULL
;

763 
vb_äame_tcb_queue
->
¡¬t_time¡amp
 = 0;

764 
vb_äame_tcb_queue
->
tÙ®_du¿tiÚ
 = 0;

765 
	`¥š_lock_š™
(&
vb_äame_tcb_queue
->
lock
);

767 
	}
}

769 
tw_vb_äame_queue_İ”©iÚ
 
	gtw_vb_äame_queue_İ
 = {

770 .
g‘
 = 
tw_vb_äame_queue_g‘
,

771 .
	gŒy_g‘
 = 
tw_vb_äame_queue_Œy_g‘
,

772 .
	gg‘_”
 = 
tw_vb_äame_queue_g‘_”
,

773 .
	gŒy_g‘_”
 = 
tw_vb_äame_queue_Œy_g‘_”
,

774 .
	gput
 = 
tw_vb_äame_queue_put
,

775 .
	gput_h—d”
 = 
tw_vb_äame_queue_put_h—d”
,

777 .
	gg‘_cu¼_´oduûr_äom_poŞ
 = 
tw_vb_äame_queue_g‘_cu¼_´oduûr_äom_poŞ
,

778 .
	gŒy_g‘_cu¼_´oduûr_äom_poŞ
 = 
tw_vb_äame_queue_Œy_g‘_cu¼_´oduûr_äom_poŞ
,

779 .
	gput_cu¼_´oduûr_što_queue
 = 
tw_vb_äame_queue_put_cu¼_´oduûr_što_queue
,

780 .
	g»Ëa£_cu¼_´oduûr
 = 
tw_vb_äame_queue_»Ëa£_cu¼_´oduûr
,

781 .
	gg‘_cu¼_cÚsum”_äom_queue
 = 
tw_vb_äame_queue_g‘_cu¼_cÚsum”_äom_queue
,

782 .
	gŒy_g‘_cu¼_cÚsum”_äom_queue
 = 
tw_vb_äame_queue_Œy_g‘_cu¼_cÚsum”_äom_queue
,

783 .
	g»Ëa£_cu¼_cÚsum”
 = 
tw_vb_äame_queue_»Ëa£_cu¼_cÚsum”
,

785 .
	gg‘_cu¼_queue_’Œy_numb”
 = 
tw_vb_äame_queue_g‘_cu¼_queue_’Œy_numb”
,

786 .
	g»Ëa£
 = 
tw_vb_äame_queue_»Ëa£
,

787 .
	gš™
 = 
tw_vb_äame_queue_š™
,

790 
	$tw_ü—‹_äame_tcb_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
)

792 if(
vb_äame_tcb_queue
 !ğ
NULL
){

793 
vb_äame_tcb_queue
->
İ
 = &
tw_vb_äame_queue_İ
;

794 
vb_äame_tcb_queue
->
İ
->
	`š™
(vb_frame_tcb_queue);

796 
	}
}

798 
	$tw_de¡roy_äame_tcb_queue
(
tw_vb_äame_tcb_queue_t
 *
vb_äame_tcb_queue
, 
tw_vb_poŞ_t
 *
poŞ
)

800 if((
vb_äame_tcb_queue
!=
NULL
è&& (
poŞ
!=NULL)){

801 if(
vb_äame_tcb_queue
->
İ
 !ğ
NULL
){

802 
vb_äame_tcb_queue
->
İ
->
	`put_cu¼_´oduûr_što_queue
(vb_frame_tcb_queue);

803 
vb_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vb_äame_tcb_queue, 
poŞ
);

804 
vb_äame_tcb_queue
->
İ
->
	`g‘_cu¼_queue_’Œy_numb”
(vb_frame_tcb_queue)){

805 
vb_äame_tcb_queue
->
İ
->
	`g‘_cu¼_cÚsum”_äom_queue
(vb_frame_tcb_queue);

806 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

809 
vb_äame_tcb_queue
->
İ
->
	`»Ëa£_cu¼_cÚsum”
(vb_äame_tcb_queue, 
poŞ
);

812 
	`tw_vb_äame_queue_put_cu¼_´oduûr_što_queue
(
vb_äame_tcb_queue
);

813 
	`tw_vb_äame_queue_»Ëa£_cu¼_cÚsum”
(
vb_äame_tcb_queue
, 
poŞ
);

814 
	`tw_vb_äame_queue_g‘_cu¼_queue_’Œy_numb”
(
vb_äame_tcb_queue
)){

815 
	`tw_vb_äame_queue_g‘_cu¼_cÚsum”_äom_queue
(
vb_äame_tcb_queue
);

816 if(
vb_äame_tcb_queue
->
cu¼_cÚsum”
 =ğ
NULL
){

819 
	`tw_vb_äame_queue_»Ëa£_cu¼_cÚsum”
(
vb_äame_tcb_queue
, 
poŞ
);

823 
	}
}

826 
	$tw_poŞ_ü—‹
(
tw_vb_poŞ_t
 *
poŞ
, *
subm™
, 
buf_Ën
)

828 
»t
 = 
TW_ERR
;

830 if(
poŞ
 !ğ
NULL
){

831 
tcb_node_poŞ_t
 *
node_poŞ
;

832 
tw_vb_·ck‘_tcb_t
 *
±r_vb_·ck‘_tcb
;

833 
tw_vb_äame_tcb_t
 *
±r_vb_äame_tcb
;

834 
i
;

836 
poŞ
->
ÿche_Üd”
 = 
	`g‘_Üd”
(
buf_Ën
);

837 
poŞ
->
ÿche_bufãr
 = (
u8
*)
	`__g‘_ä“_·ges
(
GFP_KERNEL
,…oŞ->
ÿche_Üd”
);

838 if(
poŞ
->
ÿche_bufãr
 =ğ
NULL
) {

839 
poŞ
->
ÿche_Üd”
 = 0;

840 
	`´štk
("ÿn'ˆ®loø%d…age fÜ vb buàpoŞ\n", 
poŞ
->
ÿche_Üd”
);

841  -
ENOMEM
;

844 
poŞ
->
vb_·ck‘_’Œy_numb”
 = 1;

845 
i
=0; i<
poŞ
->
ÿche_Üd”
; i++){

846 
poŞ
->
vb_·ck‘_’Œy_numb”
 <<= 1;

848 
poŞ
->
vb_·ck‘_bufãr_size
 = 
PAGE_SIZE
;

849 
node_poŞ
 = &
poŞ
->
vb_·ck‘_poŞ_tcb
;

850 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

851 
poŞ
->
vb_·ck‘_’Œy_poŞ
 = (
tw_vb_·ck‘_tcb_t
*)
	`km®loc
(Ñw_vb_·ck‘_tcb_t)*poŞ->
vb_·ck‘_’Œy_numb”
, 
GFP_KERNEL
);

852 if(
poŞ
->
vb_·ck‘_’Œy_poŞ
 =ğ
NULL
){

853 
	`ä“_·ges
(()
poŞ
->
ÿche_bufãr
,…oŞ->
ÿche_Üd”
);

854 
poŞ
->
ÿche_bufãr
 = 
NULL
;

855 
poŞ
->
ÿche_Üd”
 = 0;

856 
	`´štk
("can't‡lloc vb…acketcb\n");

857  -
ENOMEM
;

859 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
poŞ
->
vb_·ck‘_’Œy_numb”
);

860 
i
=0; i<
poŞ
->
vb_·ck‘_’Œy_numb”
; i++){

861 
±r_vb_·ck‘_tcb
 = &
poŞ
->
vb_·ck‘_’Œy_poŞ
[
i
];

862 
±r_vb_·ck‘_tcb
->
İ
 = &
tw_vb_·ck‘_tcb_İ
;

863 
±r_vb_·ck‘_tcb
->
İ
->
	`š™
ÕŒ_vb_·ck‘_tcb, 
poŞ
, 
i
);

864 
±r_vb_·ck‘_tcb
->
İ
->
	`»Ëa£
(&±r_vb_·ck‘_tcb, 
poŞ
);

867 
poŞ
->
vb_äame_’Œy_numb”
 =…oŞ->
vb_·ck‘_’Œy_numb”
;

868 
node_poŞ
 = &
poŞ
->
vb_äame_poŞ_tcb
;

869 
node_poŞ
->
İ
 = &
tcb_node_poŞ_İ
;

870 
poŞ
->
vb_äame_’Œy_poŞ
 = (
tw_vb_äame_tcb_t
*)
	`km®loc
(Ñw_vb_äame_tcb_t)*poŞ->
vb_äame_’Œy_numb”
, 
GFP_KERNEL
);

871 if(
poŞ
->
vb_äame_’Œy_poŞ
 =ğ
NULL
){

872 
node_poŞ
 = &
poŞ
->
vb_·ck‘_poŞ_tcb
;

873 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

874 
	`kä“
(
poŞ
->
vb_·ck‘_’Œy_poŞ
);

875 
poŞ
->
vb_·ck‘_’Œy_poŞ
 = 
NULL
;

876 
poŞ
->
vb_·ck‘_’Œy_numb”
 = 0;

877 
	`ä“_·ges
(()
poŞ
->
ÿche_bufãr
,…oŞ->
ÿche_Üd”
);

878 
poŞ
->
ÿche_bufãr
 = 
NULL
;

879 
poŞ
->
ÿche_Üd”
 = 0;

880 
	`´štk
("can't‡lloc vb framecb\n");

881  -
ENOMEM
;

883 
node_poŞ
->
İ
->
	`š™
Òode_poŞ, 
poŞ
->
vb_äame_’Œy_numb”
);

884 
i
=0; i<
poŞ
->
vb_äame_’Œy_numb”
; i++){

885 
±r_vb_äame_tcb
 = &
poŞ
->
vb_äame_’Œy_poŞ
[
i
];

886 
±r_vb_äame_tcb
->
İ
 = &
tw_vb_äame_tcb_İ
;

887 if(!
±r_vb_äame_tcb
->
İ
->
subm™
)

889 
±r_vb_äame_tcb
->
İ
->
subm™
 = submit;

891 
±r_vb_äame_tcb
->
poŞ
 =…ool;

892 
±r_vb_äame_tcb
->
İ
->
	`š™
(ptr_vb_frame_tcb);

893 
±r_vb_äame_tcb
->
İ
->
	`»Ëa£
(&±r_vb_äame_tcb, 
poŞ
);

896  
»t
;

897 
	}
}

899 
	$tw_poŞ_»Ëa£
(
tw_vb_poŞ_t
 *
poŞ
)

901 if(
poŞ
 !ğ
NULL
){

902 
tcb_node_poŞ_t
 *
node_poŞ
;

904 
node_poŞ
 = &
poŞ
->
vb_äame_poŞ_tcb
;

905 if(
node_poŞ
->
İ
 !ğ
NULL
){

906 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

908 if(
poŞ
->
vb_äame_’Œy_poŞ
 !ğ
NULL
){

909 
	`kä“
(
poŞ
->
vb_äame_’Œy_poŞ
);

910 
poŞ
->
vb_äame_’Œy_poŞ
 = 
NULL
;

912 
poŞ
->
vb_äame_’Œy_numb”
 = 0;

914 
node_poŞ
 = &
poŞ
->
vb_·ck‘_poŞ_tcb
;

915 if(
node_poŞ
->
İ
 !ğ
NULL
){

916 
node_poŞ
->
İ
->
	`»Ëa£
(node_pool);

918 if(
poŞ
->
vb_·ck‘_’Œy_poŞ
 !ğ
NULL
){

919 
	`kä“
(
poŞ
->
vb_·ck‘_’Œy_poŞ
);

920 
poŞ
->
vb_·ck‘_’Œy_poŞ
 = 
NULL
;

922 
poŞ
->
vb_·ck‘_’Œy_numb”
 = 0;

924 if(
poŞ
->
ÿche_bufãr
 !ğ
NULL
){

925 
	`ä“_·ges
(()
poŞ
->
ÿche_bufãr
,…oŞ->
ÿche_Üd”
);

926 
poŞ
->
ÿche_bufãr
 = 
NULL
;

928 
poŞ
->
ÿche_Üd”
 = 0;

930 
	}
}

932 
	$tw_poŞ_g‘_vb_·ck‘_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 **
·ck‘
)

934 if((
poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

935 
tcb_node_poŞ_t
 *
vb_·ck‘_poŞ_tcb
 = &
poŞ
->vb_packet_pool_tcb;

936 *
·ck‘
 = 
NULL
;

937 if(
vb_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

938 
tcb_node_t
 *
‹mp_node
;

939 
vb_·ck‘_poŞ_tcb
->
İ
->
	`g‘
(vb_·ck‘_poŞ_tcb, &
‹mp_node
);

940 if(
‹mp_node
 !ğ
NULL
){

941 *
·ck‘
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

942 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

946 
	}
}

948 
	$tw_vb_poŞ_Œy_g‘_vb_·ck‘_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 **
·ck‘
)

950 if((
poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

951 
tcb_node_poŞ_t
 *
vb_·ck‘_poŞ_tcb
 = &
poŞ
->vb_packet_pool_tcb;

952 *
·ck‘
 = 
NULL
;

953 if(
vb_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

954 
tcb_node_t
 *
‹mp_node
;

955 
vb_·ck‘_poŞ_tcb
->
İ
->
	`Œy_g‘
(vb_·ck‘_poŞ_tcb, &
‹mp_node
);

956 if(
‹mp_node
 !ğ
NULL
){

957 *
·ck‘
 = 
	`to_vb_·ck‘_tcb
(
‹mp_node
);

958 
	`©omic_šc
(&((*
·ck‘
)->
»f_couÁ
));

962 
	}
}

964 
	$tw_poŞ_put_vb_·ck‘_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_·ck‘_tcb_t
 *
·ck‘
)

966 if((
poŞ
!=
NULL
è&& (
·ck‘
!=NULL)){

967 
tcb_node_poŞ_t
 *
vb_·ck‘_poŞ_tcb
 = &
poŞ
->vb_packet_pool_tcb;

968 if(
vb_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

969 
vb_·ck‘_poŞ_tcb
->
İ
->
	`put
(vb_·ck‘_poŞ_tcb, &
·ck‘
->
·ck‘_node
);

972 
	}
}

974 
	$tw_poŞ_g‘_vb_·ck‘_tcb_poŞ_’Œy_numb”
(
tw_vb_poŞ_t
 *
poŞ
)

976 
’Œy_numb”
 = 0;

977 if(
poŞ
 !ğ
NULL
){

978 
tcb_node_poŞ_t
 *
vb_·ck‘_poŞ_tcb
 = &
poŞ
->vb_packet_pool_tcb;

979 if(
vb_·ck‘_poŞ_tcb
->
İ
 !ğ
NULL
){

980 
’Œy_numb”
 = 
vb_·ck‘_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(vb_packet_pool_tcb);

983  
’Œy_numb”
;

984 
	}
}

986 
	$tw_poŞ_g‘_vb_äame_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 **
äame
)

988 if((
poŞ
!=
NULL
è&& (
äame
!=NULL)){

989 
tcb_node_poŞ_t
 *
vb_äame_poŞ_tcb
 = &
poŞ
->vb_frame_pool_tcb;

990 *
äame
 = 
NULL
;

991 if(
vb_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

992 
tcb_node_t
 *
‹mp_node
;

993 
vb_äame_poŞ_tcb
->
İ
->
	`g‘
(vb_äame_poŞ_tcb, &
‹mp_node
);

994 if(
‹mp_node
 !ğ
NULL
){

995 *
äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

996 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

1000 
	}
}

1002 
	$tw_vb_poŞ_Œy_g‘_vb_äame_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 **
äame
)

1004 if((
poŞ
!=
NULL
è&& (
äame
!=NULL)){

1005 
tcb_node_poŞ_t
 *
vb_äame_poŞ_tcb
 = &
poŞ
->vb_frame_pool_tcb;

1006 *
äame
 = 
NULL
;

1007 if(
vb_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

1008 
tcb_node_t
 *
‹mp_node
;

1009 
vb_äame_poŞ_tcb
->
İ
->
	`Œy_g‘
(vb_äame_poŞ_tcb, &
‹mp_node
);

1010 if(
‹mp_node
 !ğ
NULL
){

1011 *
äame
 = 
	`to_vb_äame_tcb
(
‹mp_node
);

1012 
	`©omic_šc
(&((*
äame
)->
»f_couÁ
));

1016 
	}
}

1018 
	$tw_poŞ_put_vb_äame_tcb
(
tw_vb_poŞ_t
 *
poŞ
, 
tw_vb_äame_tcb_t
 *
äame
)

1020 if((
poŞ
!=
NULL
è&& (
äame
!=NULL)){

1021 
tcb_node_poŞ_t
 *
vb_äame_poŞ_tcb
 = &
poŞ
->vb_frame_pool_tcb;

1022 if(
vb_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

1023 
vb_äame_poŞ_tcb
->
İ
->
	`put
(vb_äame_poŞ_tcb, &
äame
->
äame_node
);

1026 
	}
}

1028 
	$tw_poŞ_g‘_vb_äame_tcb_poŞ_’Œy_numb”
(
tw_vb_poŞ_t
 *
poŞ
)

1030 
’Œy_numb”
 = 0;

1031 if(
poŞ
 !ğ
NULL
){

1032 
tcb_node_poŞ_t
 *
vb_äame_poŞ_tcb
 = &
poŞ
->vb_frame_pool_tcb;

1033 if(
vb_äame_poŞ_tcb
->
İ
 !ğ
NULL
){

1034 
’Œy_numb”
 = 
vb_äame_poŞ_tcb
->
İ
->
	`g‘_cu¼_poŞ_’Œy_numb”
(vb_frame_pool_tcb);

1037  
’Œy_numb”
;

1038 
	}
}

1041 
tw_vb_poŞ_İ”©iÚ
 
	gtw_poŞ_İ
 = {

1042 .
ü—‹
 = 
tw_poŞ_ü—‹
,

1043 .
	g»Ëa£
 = 
tw_poŞ_»Ëa£
,

1045 .
	gg‘_·ck‘_tcb
 = 
tw_poŞ_g‘_vb_·ck‘_tcb
,

1046 .
	gŒy_g‘_·ck‘_tcb
 = 
tw_vb_poŞ_Œy_g‘_vb_·ck‘_tcb
,

1047 .
	gput_·ck‘_tcb
 = 
tw_poŞ_put_vb_·ck‘_tcb
,

1048 .
	gg‘_·ck‘_tcb_poŞ_’Œy_numb”
 = 
tw_poŞ_g‘_vb_·ck‘_tcb_poŞ_’Œy_numb”
,

1050 .
	gg‘_äame_tcb
 = 
tw_poŞ_g‘_vb_äame_tcb
,

1051 .
	gŒy_g‘_äame_tcb
 = 
tw_vb_poŞ_Œy_g‘_vb_äame_tcb
,

1052 .
	gput_äame_tcb
 = 
tw_poŞ_put_vb_äame_tcb
,

1053 .
	gg‘_äame_tcb_poŞ_’Œy_numb”
 = 
tw_poŞ_g‘_vb_äame_tcb_poŞ_’Œy_numb”
,

1057 
	$tw_ü—‹_poŞ
(
tw_vb_poŞ_t
 *
poŞ
, *
subm™
, 
buf_Ën
)

1059 
»t
 = 
TW_ERR
;

1060 if(
poŞ
 !ğ
NULL
){

1061 
poŞ
->
İ
 = &
tw_poŞ_İ
;

1062 
»t
 = 
poŞ
->
İ
->
	`ü—‹
ÕoŞ, 
subm™
, 
buf_Ën
);

1064  
»t
;

1065 
	}
}

1067 
	$tw_de¡roy_poŞ
(
tw_vb_poŞ_t
 *
poŞ
)

1069 if(
poŞ
 !ğ
NULL
){

1070 if(
poŞ
->
İ
 !ğ
NULL
){

1071 
poŞ
->
İ
->
	`»Ëa£
(pool);

1074 
	}
}

	@../../tw5864/tw5864/tw_video_display.c

1 
	~<tw5864/dvm_commÚ.h
>

3 
	$tw_di¥Ïy_pos™iÚ_š™
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
, 
tw_di¥Ïy_pha£_t
 *
pha£
, 
u32
 
pos
)

5 if(
pos™iÚ
 && 
pha£
) {

6 
dvm_ch_t
 *
ch
;

7 
tw_di¥Ïy_driv”_t
 *
di¥Ïy_drv
;

9 if(
pos
 >ğ
MAX_DISPLAY_POSITION
) {

10 
	`TW_DBG
(
TW_DBG_ERR
, "pos™iÚ ov”æow %d\n", 
pos
);

11  -
EINVAL
;

13 
	`¥š_lock_š™
(&
pos™iÚ
->
lock
);

14 
pos™iÚ
->pos™iÚ = 
pos
;

15 
pos™iÚ
->
¡©e
 = 
TW_DISPLAY_POSITION_STATE_UNUSED
;

16 
ch
 = 
pha£
->
š‹rçû
->chip;

17 
di¥Ïy_drv
 = 
ch
->
di¥Ïy_driv”
;

18 if(
di¥Ïy_drv
->
İ
->
	`g‘_video_¡ªd¬d
(di¥Ïy_drvè=ğ
TW_VIDEO_STANDARD_PAL
) {

19 
pos™iÚ
->
¡¬tx
 = (
pos
 % 4è* 
WIDTH_FRAME_QCIF_PAL
;

20 
pos™iÚ
->
¡¬ty
 = (
pos
 / 4è* 
HEIGHT_FRAME_QCIF_PAL
;

21 
pos™iÚ
->
width
 = 
WIDTH_FRAME_QCIF_PAL
;

22 
pos™iÚ
->
height
 = 
HEIGHT_FRAME_QCIF_PAL
;

24 
pos™iÚ
->
¡¬tx
 = (
pos
 % 4è* 
WIDTH_FRAME_QCIF_NTSC
;

25 
pos™iÚ
->
¡¬ty
 = (
pos
 / 4è* 
HEIGHT_FRAME_QCIF_NTSC
;

26 
pos™iÚ
->
width
 = 
WIDTH_FRAME_QCIF_NTSC
;

27 
pos™iÚ
->
height
 = 
HEIGHT_FRAME_QCIF_NTSC
;

30 
pos™iÚ
->
pha£
 =…hase;

31 
pos™iÚ
->
cÚ‹xt
 = 
NULL
;

33  
TW_OK
;

36  
TW_ERR
;

37 
	}
}

39 
	$tw_di¥Ïy_pos™iÚ_»£t
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
)

41 if(
pos™iÚ
) {

42  
TW_OK
;

45  
TW_ERR
;

46 
	}
}

48 
	$tw_di¥Ïy_pos™iÚ_»Ëa£
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
)

50 if(
pos™iÚ
) {

51  
TW_OK
;

54  
TW_ERR
;

55 
	}
}

57 
	$tw_di¥Ïy_pos™iÚ_bšd
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
, *
cÚ‹xt
)

59 if(
pos™iÚ
 && 
cÚ‹xt
) {

60 
æags
;

62 if(
pos™iÚ
->
cÚ‹xt
) {

63 
	`TW_DBG
(
TW_DBG_ERR
, "pos™iÚ %d i busy\n", 
pos™iÚ
->position);

64  -
EBUSY
;

66 
	`¥š_lock_œq§ve
(&
pos™iÚ
->
lock
, 
æags
);

67 
pos™iÚ
->
cÚ‹xt
 = context;

68 
	`¥š_uÆock_œq»¡Üe
(&
pos™iÚ
->
lock
, 
æags
);

69  
TW_OK
;

72  
TW_ERR
;

73 
	}
}

75 
	$tw_di¥Ïy_pos™iÚ_unbšd
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
, *
cÚ‹xt
)

77 if(
pos™iÚ
 && 
cÚ‹xt
) {

78 
æags
;

80 if(
pos™iÚ
->
cÚ‹xt
) {

81 
	`¥š_lock_œq§ve
(&
pos™iÚ
->
lock
, 
æags
);

82 
pos™iÚ
->
cÚ‹xt
 = 
NULL
;

83 
	`¥š_uÆock_œq»¡Üe
(&
pos™iÚ
->
lock
, 
æags
);

86  
TW_OK
;

89  
TW_ERR
;

90 
	}
}

92 
	$tw_di¥Ïy_pos™iÚ_g‘_¡©e
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
)

94 if(
pos™iÚ
) {

95  
pos™iÚ
->
¡©e
;

98  
TW_ERR
;

99 
	}
}

101 
	$tw_di¥Ïy_pos™iÚ_g‘_pos™iÚ
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
)

103 if(
pos™iÚ
) {

104  
pos™iÚ
->position;

107  
TW_ERR
;

108 
	}
}

110 
	$tw_di¥Ïy_pos™iÚ_chªge_pos_size
(
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
, 
u32
 
¡¬tx
, u32 
¡¬ty
, u32 
width
, u32 
height
)

112 if(
pos™iÚ
) {

113 
æags
;

114 
tw_di¥Ïy_pos™iÚ_t
 
‹mp
, *
p
 = &temp;

116 
	`memıy
(&
p
, 
pos™iÚ
, (
tw_di¥Ïy_pos™iÚ_t
));

117 
p
->
¡¬tx
 = startx;

118 
p
->
¡¬ty
 = starty;

119 
p
->
width
 = width;

120 
p
->
height
 = height;

122 if(
pos™iÚ
->
pha£
->
İ
->
	`check_bound¬y
Õos™iÚ->pha£, 
p
)){

123 
	`TW_DBG
(
TW_DBG_ERR
, "chªgpo ªd siz(%d, %d, %d, %dèçed\n", 
¡¬tx
, 
¡¬ty
, 
width
, 
height
);

124  -
EINVAL
;

126 
	`¥š_lock_œq§ve
(&
pos™iÚ
->
lock
, 
æags
);

127 
pos™iÚ
->
¡¬tx
 = 
p
->startx;

128 
pos™iÚ
->
¡¬ty
 = 
p
->starty;

129 
pos™iÚ
->
width
 = 
p
->width;

130 
pos™iÚ
->
height
 = 
p
->height;

131 
	`¥š_uÆock_œq»¡Üe
(&
pos™iÚ
->
lock
, 
æags
);

135  
TW_ERR
;

136 
	}
}

138 
tw_di¥Ïy_pos™iÚ_İ”©iÚ_t
 
	gtw_di¥Ïy_pos™iÚ_İ”©iÚ_İ
 = {

139 .
š™
 = 
tw_di¥Ïy_pos™iÚ_š™
,

140 .
	g»£t
 = 
tw_di¥Ïy_pos™iÚ_»£t
,

141 .
	g»Ëa£
 = 
tw_di¥Ïy_pos™iÚ_»Ëa£
,

143 .
	gg‘_¡©e
 = 
tw_di¥Ïy_pos™iÚ_g‘_¡©e
,

144 .
	gg‘_pos™iÚ
 = 
tw_di¥Ïy_pos™iÚ_g‘_pos™iÚ
,

145 .
	gchªge_pos_size
ğ
tw_di¥Ïy_pos™iÚ_chªge_pos_size
,

147 .
	gbšd
 = 
tw_di¥Ïy_pos™iÚ_bšd
,

148 .
	gunbšd
 = 
tw_di¥Ïy_pos™iÚ_unbšd
,

151 
	$tw_di¥Ïy_pha£_š™
(
tw_di¥Ïy_pha£_t
 *
roÙ
)

153 
»t
;

155 if(
roÙ
) {

156 
i
;

157 
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
;

159 
i
 = 0; i < 
MAX_DISPLAY_POSITION
; i++) {

160 
pos™iÚ
 = &
roÙ
->pos™iÚ[
i
];

161 
pos™iÚ
->
İ
 = &
tw_di¥Ïy_pos™iÚ_İ”©iÚ_İ
;

162 
»t
 = 
pos™iÚ
->
İ
->
	`š™
Õos™iÚ, 
roÙ
, 
i
);

163 if(
»t
) {

164 
	`TW_DBG
(
TW_DBG_ERR
, "š™…os™iÚ faed %d\n", 
»t
);

165  
»t
;

168  
»t
;

171  -
EINVAL
;

172 
	}
}

174 
	$tw_di¥Ïy_pha£_»£t
(
tw_di¥Ïy_pha£_t
 *
roÙ
)

176 
»t
 = 
TW_ERR
, 
i
;

178 if(
roÙ
) {

179 
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
;

181 if(
roÙ
->
chd
) {

182 
»t
 = 
roÙ
->
chd
->
İ
->
	`»£t
(root->child);

183 if(
»t
) {

184 
	`TW_DBG
(
TW_DBG_ERR
, "»£ˆpha£ %d faed %d\n", 
roÙ
->
chd
->
pha£
, 
»t
);

185  
»t
;

188 if(
roÙ
->
siblšg
) {

189 
»t
 = 
roÙ
->
siblšg
->
İ
->
	`»£t
(root->sibling);

190 if(
»t
) {

191 
	`TW_DBG
(
TW_DBG_ERR
, "»£ˆpha£ %d faed %d\n", 
roÙ
->
chd
->
pha£
, 
»t
);

192  
»t
;

196 
i
 = 0; i < 
MAX_DISPLAY_POSITION
; i++) {

197 
pos™iÚ
 = &
roÙ
->pos™iÚ[
i
];

198 
»t
 = 
pos™iÚ
->
İ
->
	`»£t
(position);

199 if(
»t
) {

200 
	`TW_DBG
(
TW_DBG_ERR
, "»£ˆpos™iÚ faed %d\n", 
»t
);

201  
»t
;

205 
»t
 = 
TW_OK
;

208  
»t
;

209 
	}
}

211 
	$tw_di¥Ïy_pha£_»Ëa£
(
tw_di¥Ïy_pha£_t
 *
roÙ
)

213 
»t
 = 
TW_ERR
, 
i
;

215 if(
roÙ
) {

216 
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
;

218 if(
roÙ
->
chd
) {

219 
»t
 = 
roÙ
->
chd
->
İ
->
	`»Ëa£
(root->child);

220 if(
»t
) {

221 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£…ha£ %d faed %d\n", 
roÙ
->
chd
->
pha£
, 
»t
);

222  
»t
;

224 
	`kä“
(
roÙ
->
chd
);

226 if(
roÙ
->
siblšg
) {

227 
»t
 = 
roÙ
->
siblšg
->
İ
->
	`»Ëa£
(root->sibling);

228 if(
»t
) {

229 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£…ha£ %d faed %d\n", 
roÙ
->
chd
->
pha£
, 
»t
);

230  
»t
;

232 
	`kä“
(
roÙ
->
siblšg
);

235 
i
 = 0; i < 
MAX_DISPLAY_POSITION
; i++) {

236 
pos™iÚ
 = &
roÙ
->pos™iÚ[
i
];

237 
»t
 = 
pos™iÚ
->
İ
->
	`»Ëa£
(position);

238 if(
»t
) {

239 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£…os™iÚ faed %d\n", 
»t
);

240  
»t
;

244 
»t
 = 
TW_OK
;

247  
»t
;

248 
	}
}

250 
	$tw_di¥Ïy_pha£_check_bound¬y
(
tw_di¥Ïy_pha£_t
 *
pha£
, 
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
)

252 
i
 = 0;

254 
tw_di¥Ïy_pos™iÚ_t
 *
‹mp
;

255 
u32
 
x1
, 
y1
, 
x2
, 
y2
, 
w
, 
h
;

257 if(
pha£
 && 
pos™iÚ
) {

259 
dvm_ch_t
 *
ch
;

260 
tw_di¥Ïy_driv”_t
 *
di¥Ïy_driv”
;

262 
ch
 = 
pha£
->
š‹rçû
->chip;

263 
di¥Ïy_driv”
 = 
ch
->display_driver;

264 if(
di¥Ïy_driv”
->
İ
->
	`g‘_video_¡ªd¬d
(di¥Ïy_driv”è=ğ
TW_VIDEO_STANDARD_PAL
) {

265 if((
pos™iÚ
->
¡¬tx
 > 
WIDTH_FRAME_D1_PAL
è|| (pos™iÚ->
¡¬ty
 > 
HEIGHT_FRAME_D1_PAL
)

266 || (
pos™iÚ
->
width
 > 
WIDTH_FRAME_D1_PAL
è|| (pos™iÚ->
height
 > 
HEIGHT_FRAME_D1_PAL
)) {

267 
	`TW_DBG
(
TW_DBG_ERR
, "position overflow\n");

268  -
EINVAL
;

271 if((
pos™iÚ
->
¡¬tx
 > 
WIDTH_FRAME_D1_NTSC
è|| (pos™iÚ->
¡¬ty
 > 
HEIGHT_FRAME_D1_NTSC
)

272 || (
pos™iÚ
->
width
 > 
WIDTH_FRAME_D1_NTSC
è|| (pos™iÚ->
height
 > 
HEIGHT_FRAME_D1_NTSC
)) {

273 
	`TW_DBG
(
TW_DBG_ERR
, "position overflow\n");

274  -
EINVAL
;

277 
x2
 = 
pos™iÚ
->
¡¬tx
 + (pos™iÚ->
width
>>1);

278 
y2
 = 
pos™iÚ
->
¡¬ty
 + (pos™iÚ->
height
>>1);

279 
i
 = 0; i < 
MAX_DISPLAY_POSITION
; i++) {

280 
‹mp
 = &
pha£
->
pos™iÚ
[
i
];

281 
x1
 = 
‹mp
->
¡¬tx
 + (‹mp->
width
>>1);

282 
y1
 = 
‹mp
->
¡¬ty
 + (‹mp->
height
>>1);

283 
w
 = ((
‹mp
->
width
>>1è+ (
pos™iÚ
->width>>1));

284 
h
 = ((
‹mp
->
height
>>1è+ (
pos™iÚ
->height>>1));

285 if((
‹mp
->
İ
->
	`g‘_¡©e
Ñempè=ğ
TW_DISPLAY_POSITION_STATE_USED
)

286 && (
‹mp
->
İ
->
	`g‘_pos™iÚ
Ñempè!ğ
pos™iÚ
->op->get_position(position))) {

287 if(((
	`H264_MAX
(
x1
, 
x2
è- 
	`H264_MIN
(x1, x2)è< 
w
)

288 || ((
	`H264_MAX
(
y1
, 
y2
è- 
	`H264_MIN
(y1, y2)è< 
h
)) {

289 
	`TW_DBG
(
TW_DBG_ERR
, "region (%d, %d, %d, %d) conflict with…osition %d (%d, %d, %d, %d)\n",

290 
pos™iÚ
->
¡¬tx
,…os™iÚ->
¡¬ty
,…os™iÚ->
width
,…os™iÚ->
height
, 
‹mp
->
İ
->
	`g‘_pos™iÚ
(temp),

291 
‹mp
->
¡¬tx
,emp->
¡¬ty
,emp->
width
,emp->
height
);

292  
TW_ERR
;

297  
TW_OK
;

300  
TW_ERR
;

301 
	}
}

303 
tw_di¥Ïy_pha£_İ”©iÚ
 
	gtw_di¥Ïy_pha£_İ”©iÚ_İ
 = {

304 .
š™
 = 
tw_di¥Ïy_pha£_š™
,

305 .
	g»£t
 = 
tw_di¥Ïy_pha£_»£t
,

306 .
	g»Ëa£
 = 
tw_di¥Ïy_pha£_»Ëa£
,

308 .
	gcheck_bound¬y
 = 
tw_di¥Ïy_pha£_check_bound¬y
,

311 
	$š™_di¥Ïy_pha£
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

313 
i
, 
»t
 = 
TW_ERR
;

315 if(
š‹rçû
) {

316 
tw_di¥Ïy_pha£_t
 *
pha£
, **
‹mp_pha£
;

317 
tÙ®_pha£
;

318 
š‹rçû
->
ÿ·b™y
) {

319 
TW_DISPLAY_INTERFACE_MODE_108M
:

320 
tÙ®_pha£
 = 4;

322 
TW_DISPLAY_INTERFACE_MODE_54M
:

323 
tÙ®_pha£
 = 2;

325 
TW_DISPLAY_INTERFACE_MODE_27M
:

326 
tÙ®_pha£
 = 1;

329 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀdi¥Ïy iÁ”çû mod%d\n", 
š‹rçû
->
ÿ·b™y
);

330  -
EINVAL
;

332 
‹mp_pha£
 = &
š‹rçû
->
roÙ
;

333 
i
 = 0; i < 
tÙ®_pha£
; i++) {

334 
pha£
 = (
tw_di¥Ïy_pha£_t
 *)
	`kz®loc
(Ñw_di¥Ïy_pha£_t), 
GFP_KERNEL
);

335 if(!
pha£
) {

336 
	`TW_DBG
(
TW_DBG_ERR
, "no memory for display\n");

337  -
ENOMEM
;

339 if(!(*
‹mp_pha£
)) {

340 *
‹mp_pha£
 = 
pha£
;

342 (*
‹mp_pha£
)->
siblšg
 = 
pha£
;

344 
‹mp_pha£
 = &
pha£
;

346 
pha£
->
š‹rçû
 = interface;

347 
pha£
->pha£ = 
i
;

348 
pha£
->
·»Á
 =…ha£->
siblšg
 =…ha£->
chd
 = 
NULL
;

349 
pha£
->
İ
 = &
tw_di¥Ïy_pha£_İ”©iÚ_İ
;

350 
»t
 = 
pha£
->
İ
->
	`š™
(phase);

351 if(
»t
) {

352 
	`TW_DBG
(
TW_DBG_ERR
, "š™…ha£ faed, %d\n", 
»t
);

353 
pha£
->
İ
->
	`»Ëa£
(phase);

354 
	`kä“
(
pha£
);

355 
»t
 = -
ENOMEM
;

356 
»Ëa£_pha£
;

360  
»t
;

361 
»Ëa£_pha£
:

362 
‹mp_pha£
 = &
š‹rçû
->
roÙ
;

363 *
‹mp_pha£
) {

364 
pha£
 = *
‹mp_pha£
;

365 *
‹mp_pha£
 = 
pha£
->
siblšg
;

366 if(
pha£
->
İ
) {

367 
pha£
->
İ
->
	`»Ëa£
(phase);

369 
	`kä“
(
pha£
);

373  
»t
;

374 
	}
}

376 
	$tw_di¥Ïy_š‹rçû_š™
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
, 
u32
 
pÜt
, 
dvm_ch_t
 *
ch
)

378 
»t
 = 
TW_ERR
;

380 if(
š‹rçû
) {

381 
š‹rçû
->
mode
 = 
TW_DISPLAY_INTERFACE_MODE_27M
;

382 if(
pÜt
 < 
MAX_DISPLAY_INTERFACE
) {

383 
š‹rçû
->
pÜt
 =…ort;

384 
š‹rçû
->
ch
 = chip;

385 
š‹rçû
->
roÙ
 = 
NULL
;

386 if(
š‹rçû
->
İ
->
	`g‘_pÜt
(interface) == 0) {

387 
š‹rçû
->
ÿ·b™y
 = 
TW_DISPLAY_INTERFACE_MODE_108M
;

390 
»t
 = 
	`š™_di¥Ïy_pha£
(
š‹rçû
);

392 
	`TW_DBG
(
TW_DBG_ERR
, "Úly suµÜˆ%d di¥Ïy…Üt\n", 
MAX_DISPLAY_INTERFACE
);

393 
»t
 = -
EINVAL
;

397  
»t
;

398 
	}
}

400 
	$tw_di¥Ïy_š‹rçû_»£t
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

402 if(
š‹rçû
) {

403 
tw_di¥Ïy_pha£_t
 *
roÙ
;

405 
roÙ
 = 
š‹rçû
->root;

406 if(
roÙ
) {

407 
roÙ
->
İ
->
	`»£t
(root);

410  
TW_OK
;

413  
TW_ERR
;

414 
	}
}

416 
	$tw_di¥Ïy_š‹rçû_»Ëa£
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

418 if(
š‹rçû
) {

419 
»t
;

420 
tw_di¥Ïy_pha£_t
 *
roÙ
;

422 
roÙ
 = 
š‹rçû
->root;

423 if(
roÙ
) {

424 
»t
 = 
roÙ
->
İ
->
	`»Ëa£
(root);

425 if(
»t
) {

426 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£…ha£ %d faed %d\n", 
roÙ
->
pha£
, 
»t
);

428 
	`kä“
(
roÙ
);

431  
TW_OK
;

434  
TW_ERR
;

435 
	}
}

437 
u32
 
	$tw_di¥Ïy_š‹rçû_g‘_pÜt
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

439 if(
š‹rçû
) {

440  
š‹rçû
->
pÜt
;

443  
TW_ERR
;

444 
	}
}

446 
u32
 
	$tw_di¥Ïy_š‹rçû_g‘_ÿ·b™y
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

448 if(
š‹rçû
) {

449  
š‹rçû
->
ÿ·b™y
;

452  
TW_ERR
;

453 
	}
}

455 
u32
 
	$tw_di¥Ïy_š‹rçû_g‘_mode
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
)

457 if(
š‹rçû
) {

458  
š‹rçû
->
mode
;

461  
TW_ERR
;

462 
	}
}

464 
	$tw_di¥Ïy_š‹rçû_£t_mode
(
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
, 
TW_DISPLAY_INTERFACE_MODE
 
mode
)

466 if(
š‹rçû
) {

467 
tw_di¥Ïy_pha£_t
 *
roÙ
;

469 if((
mode
 < 0è|| (mod>ğ
TW_DISPLAY_INTERFACE_MODE_RESERVE
)) {

470 
	`TW_DBG
(
TW_DBG_ERR
, "unsuµÜˆmod%d\n", 
mode
);

471  
mode
;

474 
roÙ
 = 
š‹rçû
->root;

475 if(
roÙ
) {

476 
roÙ
->
İ
->
	`»Ëa£
(root);

477 
roÙ
->
İ
->
	`š™
(root);

481  
TW_ERR
;

482 
	}
}

484 
tw_di¥Ïy_š‹rçû_İ”©iÚ
 
	gtw_di¥Ïy_š‹rçû_İ”©iÚ_İ
 = {

485 .
š™
 = 
tw_di¥Ïy_š‹rçû_š™
,

486 .
	g»£t
 = 
tw_di¥Ïy_š‹rçû_»£t
,

487 .
	g»Ëa£
 = 
tw_di¥Ïy_š‹rçû_»Ëa£
,

489 .
	gg‘_pÜt
 = 
tw_di¥Ïy_š‹rçû_g‘_pÜt
,

490 .
	gg‘_ÿ·b™y
 = 
tw_di¥Ïy_š‹rçû_g‘_ÿ·b™y
,

491 .
	gg‘_mode
 = 
tw_di¥Ïy_š‹rçû_g‘_mode
,

492 .
	g£t_mode
 = 
tw_di¥Ïy_š‹rçû_£t_mode
,

495 
	$di¥Ïy_´oc_»ad
(*
·ge
, **
¡¬t
, 
off_t
 
off
,

496 
couÁ
, *
eof
, *
d©a
)

498 
Ën
 = 0;

499 
tw_di¥Ïy_driv”_t
 *
driv”
 = (tw_di¥Ïy_driv”_ˆ*)
d©a
;

500 
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
;

501 
tw_di¥Ïy_pha£_t
 *
pha£
;

502 
tw_di¥Ïy_pos™iÚ_t
 *
pos™iÚ
;

504 if(
driv”
) {

505 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "videØ¡ªd¬d: %d\n", 
driv”
->
İ
->
	`g‘_video_¡ªd¬d
(driver));

507 
š‹rçû
 = 
driv”
->š‹rçû; (š‹rçû - driv”->š‹rçûè< 
MAX_DISPLAY_INTERFACE
; interface++) {

508 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "pÜˆ%d mod%d\n", 
š‹rçû
->
İ
->
	`g‘_pÜt
(š‹rçû), iÁ”çû->İ->
	`g‘_mode
(interface));

509 
pha£
 = 
š‹rçû
->
roÙ
;

510 
pha£
) {

511 
pos™iÚ
 = 
pha£
->pos™iÚ; (Õos™iÚ -…ha£->pos™iÚè< 
MAX_DISPLAY_POSITION
);…osition++){

512 if(
pos™iÚ
->
İ
->
	`g‘_¡©e
Õos™iÚè=ğ
TW_DISPLAY_POSITION_STATE_USED
) {

513 
Ën
 +ğ
	`¥rštf
(
·ge
 +†’, "%d --> (%d, %d, %d, %d)\n", 
pos™iÚ
->
İ
->
	`g‘_pos™iÚ
(position),

514 
pos™iÚ
->
¡¬tx
,…os™iÚ->
¡¬ty
,…os™iÚ->
width
,…os™iÚ->
height
);

518 
pha£
 =…ha£->
siblšg
;

523  
Ën
;

524 
	}
}

526 
	$di¥Ïy_´oc_wr™e
(
fe
 *fe, cÚ¡ 
__u£r
 *
bufãr
,

527 
couÁ
, *
d©a
)

529 
tw_di¥Ïy_driv”_t
 *
driv”
 = (tw_di¥Ïy_driv”_ˆ*)
d©a
;

531 if(!
driv”
) {

532 
	`TW_DBG
(
TW_DBG_ERR
, "vi driver uninitial\n");

535  
couÁ
;

536 
	}
}

538 
	$tw_di¥Ïy_driv”_š™
(
tw_di¥Ïy_driv”_t
 *
driv”
)

540 
»t
 = 
TW_ERR
;

542 if(
driv”
) {

543 
dvm_ch_t
 *
ch
;

544 
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
;

545 
tw_´oc_»gi¡”_s
 *
´oc_’Œy
;

546 
i
;

548 
ch
 = 
driv”
->chip;

549 
	`©omic_£t
(&
driv”
->
İ’ed_æag
, 0);

550 
driv”
->
İ
->
	`£t_video_¡ªd¬d
(driv”, 
TW_VIDEO_STANDARD_PAL
);

551 
	`š™_’dpošt_tcb
(&
driv”
->
İ’ed_di¥Ïy_ed
, 
ch
->
bus_id
, ch->
ch_id
,

552 
INVALID_TW_ED_TYPE_ID
, 0,

553 0, 
driv”
, 
NULL
,

554 
NULL
, NULL);

555 
i
 = 0; i < 
MAX_DISPLAY_INTERFACE
; i++) {

556 
š‹rçû
 = &
driv”
->š‹rçû[
i
];

557 
š‹rçû
->
İ
 = &
tw_di¥Ïy_š‹rçû_İ”©iÚ_İ
;

558 
»t
 = 
š‹rçû
->
İ
->
	`š™
(š‹rçû, 
i
, 
ch
);

559 if(
»t
) {

560 
	`TW_DBG
(
TW_DBG_ERR
, "š™ di¥Ïy…Üˆ%dƒ¼Ü, %d\n", 
š‹rçû
->
İ
->
	`g‘_pÜt
(š‹rçû), 
»t
);

561  
»t
;

564 
´oc_’Œy
 = &
driv”
->
di¥Ïy_´oc
;

565 
	`¡rıy
(
´oc_’Œy
->
Çme
, "display");

566 
´oc_’Œy
->
»ad
 = 
di¥Ïy_´oc_»ad
;

567 
´oc_’Œy
->
wr™e
 = 
di¥Ïy_´oc_wr™e
;

568 
´oc_’Œy
->
´iv©e
 = 
driv”
;

569 
´oc_’Œy
->
’Œy
 = 
NULL
;

570 
	`tw_moduË_»gi¡”
(
ch
, 
´oc_’Œy
);

573  
»t
;

574 
	}
}

576 
	$tw_di¥Ïy_driv”_»£t
(
tw_di¥Ïy_driv”_t
 *
driv”
)

578 
»t
 = 
TW_ERR
;

580 if(
driv”
) {

581 
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
;

582 
i
;

584 
i
 = 0; i < 
MAX_DISPLAY_INTERFACE
; i++) {

585 
š‹rçû
 = &
driv”
->š‹rçû[
i
];

586 
š‹rçû
->
İ
->
	`»£t
(interface);

587 if(
»t
) {

588 
	`TW_DBG
(
TW_DBG_ERR
, "»£ˆdi¥Ïy…Üˆ%dƒ¼Ü, %d\n", 
š‹rçû
->
İ
->
	`g‘_pÜt
(š‹rçû), 
»t
);

589  
»t
;

594  
»t
;

595 
	}
}

597 
	$tw_di¥Ïy_driv”_»Ëa£
(
tw_di¥Ïy_driv”_t
 *
driv”
)

599 
»t
 = 
TW_ERR
;

601 if(
driv”
) {

602 
dvm_ch_t
 *
ch
;

603 
tw_di¥Ïy_š‹rçû_t
 *
š‹rçû
;

604 
tw_´oc_»gi¡”_s
 *
´oc_’Œy
;

605 
i
;

607 
ch
 = 
driv”
->chip;

608 
i
 = 0; i < 
MAX_DISPLAY_INTERFACE
; i++) {

609 
š‹rçû
 = &
driv”
->š‹rçû[
i
];

610 
»t
 = 
š‹rçû
->
İ
->
	`»Ëa£
(interface);

611 if(
»t
) {

612 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£ di¥Ïy…Üˆ%dƒ¼Ü, %d\n", 
š‹rçû
->
İ
->
	`g‘_pÜt
(š‹rçû), 
»t
);

613  
»t
;

616 
´oc_’Œy
 = &
driv”
->
di¥Ïy_´oc
;

618 
	`tw_moduË_uÄegi¡”
(
ch
, 
´oc_’Œy
);

621  
»t
;

622 
	}
}

624 
	$tw_di¥Ïy_driv”_g‘_video_¡ªd¬d
(
tw_di¥Ïy_driv”_t
 *
driv”
)

626 if(
driv”
) {

627  
driv”
->
video_¡ªd¬d
;

630  
TW_ERR
;

631 
	}
}

633 
	$tw_di¥Ïy_driv”_£t_video_¡ªd¬d
(
tw_di¥Ïy_driv”_t
 *
driv”
, 
TW_VIDEO_STANDARD
 
video_¡ªd¬d
)

635 
»t
 = 
TW_ERR
;

637 if(
driv”
) {

638 
video_¡ªd¬d
) {

639 
TW_VIDEO_STANDARD_PAL
:

640 
TW_VIDEO_STANDARD_NTSC
:

641 
driv”
->
video_¡ªd¬d
 = video_standard;

642 
»t
 = 
TW_OK
;

645 
	`TW_DBG
(
TW_DBG_ERR
, "unknowÀvideØ¡ªd¬d %d\n", 
video_¡ªd¬d
);

646 
»t
 = -
EINVAL
;

650  
»t
;

651 
	}
}

653 
tw_di¥Ïy_İ”©iÚ_t
 
	gdi¥Ïy_İ”©iÚ_İ
 = {

654 .
š™
 = 
tw_di¥Ïy_driv”_š™
,

655 .
	g»£t
 = 
tw_di¥Ïy_driv”_»£t
,

656 .
	g»Ëa£
 = 
tw_di¥Ïy_driv”_»Ëa£
,

658 .
	gg‘_video_¡ªd¬d
 = 
tw_di¥Ïy_driv”_g‘_video_¡ªd¬d
,

659 .
	g£t_video_¡ªd¬d
 = 
tw_di¥Ïy_driv”_£t_video_¡ªd¬d
,

662 
	$š™_di¥Ïy_driv”
(
dvm_ch_t
 *
ch
)

664 
»t
 = 
TW_ERR
;

666 if(
ch
) {

667 
tw_di¥Ïy_driv”_t
 *
driv”
;

669 
driv”
 = 
	`kz®loc
((
tw_di¥Ïy_driv”_t
), 
GFP_KERNEL
);

670 if(
driv”
) {

671 
ch
->
di¥Ïy_driv”
 = 
driv”
;

672 
driv”
->
ch
 = chip;

673 
driv”
->
İ
 = &
di¥Ïy_İ”©iÚ_İ
;

674 
»t
 = 
driv”
->
İ
->
	`š™
(driver);

676 
	`TW_DBG
(
TW_DBG_ERR
, "no memory for display driver\n");

677 
»t
 = -
ENOMEM
;

680 
	`TW_DBG
(
TW_DBG_ERR
, "NULL…ointer\n");

681 
»t
 = -
EPERM
;

684  
»t
;

685 
	}
}

687 
	$»move_di¥Ïy_driv”
(
tw_di¥Ïy_driv”_t
 *
driv”
)

689 
»t
 = 
TW_ERR
;

691 if(
driv”
) {

692 
»t
 = 
driv”
->
İ
->
	`»Ëa£
(driver);

693 
	`TW_DBG
(
TW_DBG_ERR
, "»Ëa£ di¥Ïy dœv” faed %d\n", 
»t
);

696  
»t
;

697 
	}
}

	@/usr/include/asm/types.h

1 #iâdeà
_ASM_X86_TYPES_H


2 
	#_ASM_X86_TYPES_H


	)

4 
	~<asm-g’”ic/št-Î64.h
>

6 #iâdeà
__ASSEMBLY__


8 
	tumode_t
;

	@/usr/include/asm/unistd.h

1 #ifdeà
__i386__


2 
	~"uni¡d_32.h
"

4 
	~"uni¡d_64.h
"

	@/usr/include/linux/errno.h

1 #iâdeà
_LINUX_ERRNO_H


2 
	#_LINUX_ERRNO_H


	)

4 
	~<asm/”ºo.h
>

	@/usr/include/linux/fcntl.h

1 #iâdeà
_LINUX_FCNTL_H


2 
	#_LINUX_FCNTL_H


	)

4 
	~<asm/fú.h
>

6 
	#F_SETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 0)

	)

7 
	#F_GETLEASE
 (
F_LINUX_SPECIFIC_BASE
 + 1)

	)

13 
	#F_CANCELLK
 (
F_LINUX_SPECIFIC_BASE
 + 5)

	)

16 
	#F_DUPFD_CLOEXEC
 (
F_LINUX_SPECIFIC_BASE
 + 6)

	)

22 
	#F_NOTIFY
 (
F_LINUX_SPECIFIC_BASE
+2)

	)

27 
	#DN_ACCESS
 0x00000001

	)

28 
	#DN_MODIFY
 0x00000002

	)

29 
	#DN_CREATE
 0x00000004

	)

30 
	#DN_DELETE
 0x00000008

	)

31 
	#DN_RENAME
 0x00000010

	)

32 
	#DN_ATTRIB
 0x00000020

	)

33 
	#DN_MULTISHOT
 0x80000000

	)

35 
	#AT_FDCWD
 -100

	)

38 
	#AT_SYMLINK_NOFOLLOW
 0x100

	)

39 
	#AT_REMOVEDIR
 0x200

	)

41 
	#AT_SYMLINK_FOLLOW
 0x400

	)

	@/usr/include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lim™s.h
>

10 
	~<lšux/ioùl.h
>

23 #undeà
NR_OPEN


24 
	#INR_OPEN
 1024

	)

26 
	#BLOCK_SIZE_BITS
 10

	)

27 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

29 
	#SEEK_SET
 0

	)

30 
	#SEEK_CUR
 1

	)

31 
	#SEEK_END
 2

	)

32 
	#SEEK_MAX
 
SEEK_END


	)

35 
	sfes_¡©_¡ruù
 {

36 
	mÄ_fes
;

37 
	mÄ_ä“_fes
;

38 
	mmax_fes
;

41 
	sšodes_¡©_t
 {

42 
	mÄ_šodes
;

43 
	mÄ_unu£d
;

44 
	mdummy
[5];

48 
	#NR_FILE
 8192

	)

50 
	#MAY_EXEC
 1

	)

51 
	#MAY_WRITE
 2

	)

52 
	#MAY_READ
 4

	)

53 
	#MAY_APPEND
 8

	)

54 
	#MAY_ACCESS
 16

	)

55 
	#MAY_OPEN
 32

	)

63 
	#FMODE_READ
 ((
fmode_t
)1)

	)

65 
	#FMODE_WRITE
 ((
fmode_t
)2)

	)

67 
	#FMODE_LSEEK
 ((
fmode_t
)4)

	)

69 
	#FMODE_PREAD
 ((
fmode_t
)8)

	)

71 
	#FMODE_PWRITE
 ((
fmode_t
)16)

	)

73 
	#FMODE_EXEC
 ((
fmode_t
)32)

	)

75 
	#FMODE_NDELAY
 ((
fmode_t
)64)

	)

77 
	#FMODE_EXCL
 ((
fmode_t
)128)

	)

80 
	#FMODE_WRITE_IOCTL
 ((
fmode_t
)256)

	)

88 
	#FMODE_NOCMTIME
 ((
fmode_t
)2048)

	)

144 
	#RW_MASK
 1

	)

145 
	#RWA_MASK
 2

	)

146 
	#READ
 0

	)

147 
	#WRITE
 1

	)

148 
	#READA
 2

	)

149 
	#SWRITE
 3

	)

150 
	#READ_SYNC
 (
READ
 | (1 << 
BIO_RW_SYNCIO
è| (1 << 
BIO_RW_UNPLUG
))

	)

151 
	#READ_META
 (
READ
 | (1 << 
BIO_RW_META
))

	)

152 
	#WRITE_SYNC_PLUG
 (
WRITE
 | (1 << 
BIO_RW_SYNCIO
è| (1 << 
BIO_RW_NOIDLE
))

	)

153 
	#WRITE_SYNC
 (
WRITE_SYNC_PLUG
 | (1 << 
BIO_RW_UNPLUG
))

	)

154 
	#WRITE_ODIRECT
 (
WRITE
 | (1 << 
BIO_RW_SYNCIO
è| (1 << 
BIO_RW_UNPLUG
))

	)

155 
	#SWRITE_SYNC_PLUG
 \

156 (
SWRITE
 | (1 << 
BIO_RW_SYNCIO
è| (1 << 
BIO_RW_NOIDLE
))

	)

157 
	#SWRITE_SYNC
 (
SWRITE_SYNC_PLUG
 | (1 << 
BIO_RW_UNPLUG
))

	)

158 
	#WRITE_BARRIER
 (
WRITE
 | (1 << 
BIO_RW_BARRIER
))

	)

164 
	#DISCARD_NOBARRIER
 (1 << 
BIO_RW_DISCARD
)

	)

165 
	#DISCARD_BARRIER
 ((1 << 
BIO_RW_DISCARD
è| (1 << 
BIO_RW_BARRIER
))

	)

167 
	#SEL_IN
 1

	)

168 
	#SEL_OUT
 2

	)

169 
	#SEL_EX
 4

	)

172 
	#FS_REQUIRES_DEV
 1

	)

173 
	#FS_BINARY_MOUNTDATA
 2

	)

174 
	#FS_HAS_SUBTYPE
 4

	)

175 
	#FS_REVAL_DOT
 16384

	)

176 
	#FS_RENAME_DOES_D_MOVE
 32768

	)

183 
	#MS_RDONLY
 1

	)

184 
	#MS_NOSUID
 2

	)

185 
	#MS_NODEV
 4

	)

186 
	#MS_NOEXEC
 8

	)

187 
	#MS_SYNCHRONOUS
 16

	)

188 
	#MS_REMOUNT
 32

	)

189 
	#MS_MANDLOCK
 64

	)

190 
	#MS_DIRSYNC
 128

	)

191 
	#MS_NOATIME
 1024

	)

192 
	#MS_NODIRATIME
 2048

	)

193 
	#MS_BIND
 4096

	)

194 
	#MS_MOVE
 8192

	)

195 
	#MS_REC
 16384

	)

196 
	#MS_VERBOSE
 32768

	)

198 
	#MS_SILENT
 32768

	)

199 
	#MS_POSIXACL
 (1<<16è

	)

200 
	#MS_UNBINDABLE
 (1<<17è

	)

201 
	#MS_PRIVATE
 (1<<18è

	)

202 
	#MS_SLAVE
 (1<<19è

	)

203 
	#MS_SHARED
 (1<<20è

	)

204 
	#MS_RELATIME
 (1<<21è

	)

205 
	#MS_KERNMOUNT
 (1<<22è

	)

206 
	#MS_I_VERSION
 (1<<23è

	)

207 
	#MS_STRICTATIME
 (1<<24è

	)

208 
	#MS_ACTIVE
 (1<<30)

	)

209 
	#MS_NOUSER
 (1<<31)

	)

214 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
)

	)

219 
	#MS_MGC_VAL
 0xC0ED0000

	)

220 
	#MS_MGC_MSK
 0xffff0000

	)

224 
	#S_SYNC
 1

	)

225 
	#S_NOATIME
 2

	)

226 
	#S_APPEND
 4

	)

227 
	#S_IMMUTABLE
 8

	)

228 
	#S_DEAD
 16

	)

229 
	#S_NOQUOTA
 32

	)

230 
	#S_DIRSYNC
 64

	)

231 
	#S_NOCMTIME
 128

	)

232 
	#S_SWAPFILE
 256

	)

233 
	#S_PRIVATE
 512

	)

248 
	#__IS_FLG
(
šode
,
æg
è((šode)->
i_sb
->
s_æags
 & (æg))

	)

250 
	#IS_RDONLY
(
šode
è((šode)->
i_sb
->
s_æags
 & 
MS_RDONLY
)

	)

251 
	#IS_SYNC
(
šode
è(
	`__IS_FLG
(šode, 
MS_SYNCHRONOUS
) || \

252 ((
šode
)->
i_æags
 & 
S_SYNC
))

	)

253 
	#IS_DIRSYNC
(
šode
è(
	`__IS_FLG
(šode, 
MS_SYNCHRONOUS
|
MS_DIRSYNC
) || \

254 ((
šode
)->
i_æags
 & (
S_SYNC
|
S_DIRSYNC
)))

	)

255 
	#IS_MANDLOCK
(
šode
è
	`__IS_FLG
(šode, 
MS_MANDLOCK
)

	)

256 
	#IS_NOATIME
(
šode
è
	`__IS_FLG
(šode, 
MS_RDONLY
|
MS_NOATIME
)

	)

257 
	#IS_I_VERSION
(
šode
è
	`__IS_FLG
(šode, 
MS_I_VERSION
)

	)

259 
	#IS_NOQUOTA
(
šode
è((šode)->
i_æags
 & 
S_NOQUOTA
)

	)

260 
	#IS_APPEND
(
šode
è((šode)->
i_æags
 & 
S_APPEND
)

	)

261 
	#IS_IMMUTABLE
(
šode
è((šode)->
i_æags
 & 
S_IMMUTABLE
)

	)

262 
	#IS_POSIXACL
(
šode
è
	`__IS_FLG
(šode, 
MS_POSIXACL
)

	)

264 
	#IS_DEADDIR
(
šode
è((šode)->
i_æags
 & 
S_DEAD
)

	)

265 
	#IS_NOCMTIME
(
šode
è((šode)->
i_æags
 & 
S_NOCMTIME
)

	)

266 
	#IS_SWAPFILE
(
šode
è((šode)->
i_æags
 & 
S_SWAPFILE
)

	)

267 
	#IS_PRIVATE
(
šode
è((šode)->
i_æags
 & 
S_PRIVATE
)

	)

272 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

273 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

274 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

275 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

276 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

277 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

278 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

279 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

280 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

281 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

282 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

283 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

285 
	#BLKPG
 
	`_IO
(0x12,105)

	)

289 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

290 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

295 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

296 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

297 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

298 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

299 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

300 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

301 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

302 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

304 
	#BMAP_IOCTL
 1

	)

305 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

306 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

307 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

308 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

310 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

311 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

312 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

313 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

314 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

315 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

316 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

317 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

318 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

323 
	#FS_SECRM_FL
 0x00000001

	)

324 
	#FS_UNRM_FL
 0x00000002

	)

325 
	#FS_COMPR_FL
 0x00000004

	)

326 
	#FS_SYNC_FL
 0x00000008

	)

327 
	#FS_IMMUTABLE_FL
 0x00000010

	)

328 
	#FS_APPEND_FL
 0x00000020

	)

329 
	#FS_NODUMP_FL
 0x00000040

	)

330 
	#FS_NOATIME_FL
 0x00000080

	)

332 
	#FS_DIRTY_FL
 0x00000100

	)

333 
	#FS_COMPRBLK_FL
 0x00000200

	)

334 
	#FS_NOCOMP_FL
 0x00000400

	)

335 
	#FS_ECOMPR_FL
 0x00000800

	)

337 
	#FS_BTREE_FL
 0x00001000

	)

338 
	#FS_INDEX_FL
 0x00001000

	)

339 
	#FS_IMAGIC_FL
 0x00002000

	)

340 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

341 
	#FS_NOTAIL_FL
 0x00008000

	)

342 
	#FS_DIRSYNC_FL
 0x00010000

	)

343 
	#FS_TOPDIR_FL
 0x00020000

	)

344 
	#FS_EXTENT_FL
 0x00080000

	)

345 
	#FS_DIRECTIO_FL
 0x00100000

	)

346 
	#FS_RESERVED_FL
 0x80000000

	)

348 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

349 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

352 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

353 
	#SYNC_FILE_RANGE_WRITE
 2

	)

354 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/i2c.h

26 #iâdeà
_LINUX_I2C_H


27 
	#_LINUX_I2C_H


	)

29 
	~<lšux/ty³s.h
>

67 
	si2c_msg
 {

68 
__u16
 
	maddr
;

69 
__u16
 
	mæags
;

70 
	#I2C_M_TEN
 0x0010

	)

71 
	#I2C_M_RD
 0x0001

	)

72 
	#I2C_M_NOSTART
 0x4000

	)

73 
	#I2C_M_REV_DIR_ADDR
 0x2000

	)

74 
	#I2C_M_IGNORE_NAK
 0x1000

	)

75 
	#I2C_M_NO_RD_ACK
 0x0800

	)

76 
	#I2C_M_RECV_LEN
 0x0400

	)

77 
__u16
 
	mËn
;

78 
__u8
 *
	mbuf
;

83 
	#I2C_FUNC_I2C
 0x00000001

	)

84 
	#I2C_FUNC_10BIT_ADDR
 0x00000002

	)

85 
	#I2C_FUNC_PROTOCOL_MANGLING
 0x00000004

	)

86 
	#I2C_FUNC_SMBUS_PEC
 0x00000008

	)

87 
	#I2C_FUNC_SMBUS_BLOCK_PROC_CALL
 0x00008000

	)

88 
	#I2C_FUNC_SMBUS_QUICK
 0x00010000

	)

89 
	#I2C_FUNC_SMBUS_READ_BYTE
 0x00020000

	)

90 
	#I2C_FUNC_SMBUS_WRITE_BYTE
 0x00040000

	)

91 
	#I2C_FUNC_SMBUS_READ_BYTE_DATA
 0x00080000

	)

92 
	#I2C_FUNC_SMBUS_WRITE_BYTE_DATA
 0x00100000

	)

93 
	#I2C_FUNC_SMBUS_READ_WORD_DATA
 0x00200000

	)

94 
	#I2C_FUNC_SMBUS_WRITE_WORD_DATA
 0x00400000

	)

95 
	#I2C_FUNC_SMBUS_PROC_CALL
 0x00800000

	)

96 
	#I2C_FUNC_SMBUS_READ_BLOCK_DATA
 0x01000000

	)

97 
	#I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
 0x02000000

	)

98 
	#I2C_FUNC_SMBUS_READ_I2C_BLOCK
 0x04000000

	)

99 
	#I2C_FUNC_SMBUS_WRITE_I2C_BLOCK
 0x08000000

	)

101 
	#I2C_FUNC_SMBUS_BYTE
 (
I2C_FUNC_SMBUS_READ_BYTE
 | \

102 
I2C_FUNC_SMBUS_WRITE_BYTE
)

	)

103 
	#I2C_FUNC_SMBUS_BYTE_DATA
 (
I2C_FUNC_SMBUS_READ_BYTE_DATA
 | \

104 
I2C_FUNC_SMBUS_WRITE_BYTE_DATA
)

	)

105 
	#I2C_FUNC_SMBUS_WORD_DATA
 (
I2C_FUNC_SMBUS_READ_WORD_DATA
 | \

106 
I2C_FUNC_SMBUS_WRITE_WORD_DATA
)

	)

107 
	#I2C_FUNC_SMBUS_BLOCK_DATA
 (
I2C_FUNC_SMBUS_READ_BLOCK_DATA
 | \

108 
I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
)

	)

109 
	#I2C_FUNC_SMBUS_I2C_BLOCK
 (
I2C_FUNC_SMBUS_READ_I2C_BLOCK
 | \

110 
I2C_FUNC_SMBUS_WRITE_I2C_BLOCK
)

	)

112 
	#I2C_FUNC_SMBUS_EMUL
 (
I2C_FUNC_SMBUS_QUICK
 | \

113 
I2C_FUNC_SMBUS_BYTE
 | \

114 
I2C_FUNC_SMBUS_BYTE_DATA
 | \

115 
I2C_FUNC_SMBUS_WORD_DATA
 | \

116 
I2C_FUNC_SMBUS_PROC_CALL
 | \

117 
I2C_FUNC_SMBUS_WRITE_BLOCK_DATA
 | \

118 
I2C_FUNC_SMBUS_I2C_BLOCK
 | \

119 
I2C_FUNC_SMBUS_PEC
)

	)

124 
	#I2C_SMBUS_BLOCK_MAX
 32

	)

125 
	ui2c_smbus_d©a
 {

126 
__u8
 
	mby‹
;

127 
__u16
 
	mwÜd
;

128 
__u8
 
	mblock
[
I2C_SMBUS_BLOCK_MAX
 + 2];

133 
	#I2C_SMBUS_READ
 1

	)

134 
	#I2C_SMBUS_WRITE
 0

	)

138 
	#I2C_SMBUS_QUICK
 0

	)

139 
	#I2C_SMBUS_BYTE
 1

	)

140 
	#I2C_SMBUS_BYTE_DATA
 2

	)

141 
	#I2C_SMBUS_WORD_DATA
 3

	)

142 
	#I2C_SMBUS_PROC_CALL
 4

	)

143 
	#I2C_SMBUS_BLOCK_DATA
 5

	)

144 
	#I2C_SMBUS_I2C_BLOCK_BROKEN
 6

	)

145 
	#I2C_SMBUS_BLOCK_PROC_CALL
 7

	)

146 
	#I2C_SMBUS_I2C_BLOCK_DATA
 8

	)

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/kdev_t.h

1 #iâdeà
_LINUX_KDEV_T_H


2 
	#_LINUX_KDEV_T_H


	)

8 
	#MAJOR
(
dev
è((dev)>>8)

	)

9 
	#MINOR
(
dev
è((devè& 0xff)

	)

10 
	#MKDEV
(
ma
,
mi
è((ma)<<8 | (mi))

	)

	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

9 
	#SI_LOAD_SHIFT
 16

	)

10 
	ssysšfo
 {

11 
	mu±ime
;

12 
	mlßds
[3];

13 
	mtÙ®¿m
;

14 
	mä“¿m
;

15 
	msh¬ed¿m
;

16 
	mbufã¼am
;

17 
	mtÙ®sw­
;

18 
	mä“sw­
;

19 
	m´ocs
;

20 
	m·d
;

21 
	mtÙ®high
;

22 
	mä“high
;

23 
	mmem_un™
;

24 
	m_f
[20-2*()-()];

28 
	#BUILD_BUG_ON
(
cÚd™iÚ
è(()([1 - 2*!!(cÚd™iÚ)]))

	)

34 
	#BUILD_BUG_ON_ZERO
(
e
è(([1 - 2 * !!Ó)]è- 1)

	)

37 
	#__FUNCTION__
 (
__func__
)

	)

40 #ifdeà
CONFIG_NUMA


41 
	#NUMA_BUILD
 1

	)

43 
	#NUMA_BUILD
 0

	)

47 #ifdeà
CONFIG_FTRACE_MCOUNT_RECORD


48 
	#REBUILD_DUE_TO_FTRACE_MCOUNT_RECORD


	)

	@/usr/include/linux/pci.h

17 #iâdeà
LINUX_PCI_H


18 
	#LINUX_PCI_H


	)

20 
	~<lšux/pci_»gs.h
>

30 
	#PCI_DEVFN
(
¦Ù
, 
func
è((((¦Ùè& 0x1fè<< 3è| ((funcè& 0x07))

	)

31 
	#PCI_SLOT
(
devâ
è(((devâè>> 3è& 0x1f)

	)

32 
	#PCI_FUNC
(
devâ
è((devâè& 0x07)

	)

35 
	#PCIIOC_BASE
 ('P' << 24 | 'C' << 16 | 'I' << 8)

	)

36 
	#PCIIOC_CONTROLLER
 (
PCIIOC_BASE
 | 0x00è

	)

37 
	#PCIIOC_MMAP_IS_IO
 (
PCIIOC_BASE
 | 0x01è

	)

38 
	#PCIIOC_MMAP_IS_MEM
 (
PCIIOC_BASE
 | 0x02è

	)

39 
	#PCIIOC_WRITE_COMBINE
 (
PCIIOC_BASE
 | 0x03è

	)

	@/usr/include/linux/poll.h

1 #iâdeà
_LINUX_POLL_H


2 
	#_LINUX_POLL_H


	)

4 
	~<asm/pŞl.h
>

	@/usr/include/linux/rtc.h

11 #iâdeà
_LINUX_RTC_H_


12 
	#_LINUX_RTC_H_


	)

20 
	s¹c_time
 {

21 
	mtm_£c
;

22 
	mtm_mš
;

23 
	mtm_hour
;

24 
	mtm_mday
;

25 
	mtm_mÚ
;

26 
	mtm_y—r
;

27 
	mtm_wday
;

28 
	mtm_yday
;

29 
	mtm_isd¡
;

36 
	s¹c_wk®rm
 {

37 
	m’abËd
;

38 
	m³ndšg
;

39 
¹c_time
 
	mtime
;

55 
	s¹c_¶l_šfo
 {

56 
	m¶l_ù¾
;

57 
	m¶l_v®ue
;

58 
	m¶l_max
;

59 
	m¶l_mš
;

60 
	m¶l_posmuÉ
;

61 
	m¶l_ÃgmuÉ
;

62 
	m¶l_şock
;

70 
	#RTC_AIE_ON
 
	`_IO
('p', 0x01è

	)

71 
	#RTC_AIE_OFF
 
	`_IO
('p', 0x02è

	)

72 
	#RTC_UIE_ON
 
	`_IO
('p', 0x03è

	)

73 
	#RTC_UIE_OFF
 
	`_IO
('p', 0x04è

	)

74 
	#RTC_PIE_ON
 
	`_IO
('p', 0x05è

	)

75 
	#RTC_PIE_OFF
 
	`_IO
('p', 0x06è

	)

76 
	#RTC_WIE_ON
 
	`_IO
('p', 0x0fè

	)

77 
	#RTC_WIE_OFF
 
	`_IO
('p', 0x10è

	)

79 
	#RTC_ALM_SET
 
	`_IOW
('p', 0x07, 
¹c_time
è

	)

80 
	#RTC_ALM_READ
 
	`_IOR
('p', 0x08, 
¹c_time
è

	)

81 
	#RTC_RD_TIME
 
	`_IOR
('p', 0x09, 
¹c_time
è

	)

82 
	#RTC_SET_TIME
 
	`_IOW
('p', 0x0a, 
¹c_time
è

	)

83 
	#RTC_IRQP_READ
 
	`_IOR
('p', 0x0b, è

	)

84 
	#RTC_IRQP_SET
 
	`_IOW
('p', 0x0c, è

	)

85 
	#RTC_EPOCH_READ
 
	`_IOR
('p', 0x0d, è

	)

86 
	#RTC_EPOCH_SET
 
	`_IOW
('p', 0x0e, è

	)

88 
	#RTC_WKALM_SET
 
	`_IOW
('p', 0x0f, 
¹c_wk®rm
)

	)

89 
	#RTC_WKALM_RD
 
	`_IOR
('p', 0x10, 
¹c_wk®rm
)

	)

91 
	#RTC_PLL_GET
 
	`_IOR
('p', 0x11, 
¹c_¶l_šfo
è

	)

92 
	#RTC_PLL_SET
 
	`_IOW
('p', 0x12, 
¹c_¶l_šfo
è

	)

95 
	#RTC_IRQF
 0x80

	)

96 
	#RTC_PF
 0x40

	)

97 
	#RTC_AF
 0x20

	)

98 
	#RTC_UF
 0x10

	)

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

24 
	#CLONE_STOPPED
 0x02000000

	)

25 
	#CLONE_NEWUTS
 0x04000000

	)

26 
	#CLONE_NEWIPC
 0x08000000

	)

27 
	#CLONE_NEWUSER
 0x10000000

	)

28 
	#CLONE_NEWPID
 0x20000000

	)

29 
	#CLONE_NEWNET
 0x40000000

	)

30 
	#CLONE_IO
 0x80000000

	)

35 
	#SCHED_NORMAL
 0

	)

36 
	#SCHED_FIFO
 1

	)

37 
	#SCHED_RR
 2

	)

38 
	#SCHED_BATCH
 3

	)

40 
	#SCHED_IDLE
 5

	)

	@/usr/include/linux/time.h

1 #iâdeà
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<lšux/ty³s.h
>

7 #iâdeà
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime¥ec
 {

10 
__k”Ãl_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimev®
 {

16 
__k”Ãl_time_t
 
	mtv_£c
;

17 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

20 
	stimezÚe
 {

21 
	mtz_mšu‹swe¡
;

22 
	mtz_d¡time
;

26 
	#NFDBITS
 
__NFDBITS


	)

28 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

29 
	#FD_SET
(
fd
,
fd£
è
	`__FD_SET
(fd,fd£)

	)

30 
	#FD_CLR
(
fd
,
fd£
è
	`__FD_CLR
(fd,fd£)

	)

31 
	#FD_ISSET
(
fd
,
fd£
è
	`__FD_ISSET
(fd,fd£)

	)

32 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
(fd£)

	)

38 
	#ITIMER_REAL
 0

	)

39 
	#ITIMER_VIRTUAL
 1

	)

40 
	#ITIMER_PROF
 2

	)

42 
	s™im”¥ec
 {

43 
time¥ec
 
	m™_š‹rv®
;

44 
time¥ec
 
	m™_v®ue
;

47 
	s™im”v®
 {

48 
timev®
 
	m™_š‹rv®
;

49 
timev®
 
	m™_v®ue
;

55 
	#CLOCK_REALTIME
 0

	)

56 
	#CLOCK_MONOTONIC
 1

	)

57 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

58 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

59 
	#CLOCK_MONOTONIC_RAW
 4

	)

64 
	#CLOCK_SGI_CYCLE
 10

	)

65 
	#MAX_CLOCKS
 16

	)

66 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

67 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

72 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

	@/usr/include/linux/unistd.h

1 #iâdeà
_LINUX_UNISTD_H_


2 
	#_LINUX_UNISTD_H_


	)

7 
	~<asm/uni¡d.h
>

	@/usr/include/linux/version.h

1 
	#LINUX_VERSION_CODE
 132639

	)

2 
	#KERNEL_VERSION
(
a
,
b
,
c
è((×è<< 16è+ ((bè<< 8è+ (c))

	)

	@/usr/include/linux/videodev2.h

56 #iâdeà
__LINUX_VIDEODEV2_H


57 
	#__LINUX_VIDEODEV2_H


	)

59 
	~<sys/time.h
>

61 
	~<lšux/ioùl.h
>

62 
	~<lšux/ty³s.h
>

68 
	#VIDEO_MAX_FRAME
 32

	)

74 
	#VID_TYPE_CAPTURE
 1

	)

75 
	#VID_TYPE_TUNER
 2

	)

76 
	#VID_TYPE_TELETEXT
 4

	)

77 
	#VID_TYPE_OVERLAY
 8

	)

78 
	#VID_TYPE_CHROMAKEY
 16

	)

79 
	#VID_TYPE_CLIPPING
 32

	)

80 
	#VID_TYPE_FRAMERAM
 64

	)

81 
	#VID_TYPE_SCALES
 128

	)

82 
	#VID_TYPE_MONOCHROME
 256

	)

83 
	#VID_TYPE_SUBCAPTURE
 512

	)

84 
	#VID_TYPE_MPEG_DECODER
 1024

	)

85 
	#VID_TYPE_MPEG_ENCODER
 2048

	)

86 
	#VID_TYPE_MJPEG_DECODER
 4096

	)

87 
	#VID_TYPE_MJPEG_ENCODER
 8192

	)

94 
	#v4l2_fourcc
(
a
, 
b
, 
c
, 
d
)\

95 ((
__u32
)(
a
è| ((__u32)(
b
è<< 8è| ((__u32)(
c
è<< 16è| ((__u32)(
d
è<< 24))

	)

100 
	ev4l2_f›ld
 {

101 
	mV4L2_FIELD_ANY
 = 0,

105 
	mV4L2_FIELD_NONE
 = 1,

106 
	mV4L2_FIELD_TOP
 = 2,

107 
	mV4L2_FIELD_BOTTOM
 = 3,

108 
	mV4L2_FIELD_INTERLACED
 = 4,

109 
	mV4L2_FIELD_SEQ_TB
 = 5,

111 
	mV4L2_FIELD_SEQ_BT
 = 6,

112 
	mV4L2_FIELD_ALTERNATE
 = 7,

114 
	mV4L2_FIELD_INTERLACED_TB
 = 8,

117 
	mV4L2_FIELD_INTERLACED_BT
 = 9,

121 
	#V4L2_FIELD_HAS_TOP
(
f›ld
) \

122 ((
f›ld
è=ğ
V4L2_FIELD_TOP
 ||\

123 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED
 ||\

124 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_TB
 ||\

125 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_BT
 ||\

126 (
f›ld
è=ğ
V4L2_FIELD_SEQ_TB
 ||\

127 (
f›ld
è=ğ
V4L2_FIELD_SEQ_BT
)

	)

128 
	#V4L2_FIELD_HAS_BOTTOM
(
f›ld
) \

129 ((
f›ld
è=ğ
V4L2_FIELD_BOTTOM
 ||\

130 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED
 ||\

131 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_TB
 ||\

132 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_BT
 ||\

133 (
f›ld
è=ğ
V4L2_FIELD_SEQ_TB
 ||\

134 (
f›ld
è=ğ
V4L2_FIELD_SEQ_BT
)

	)

135 
	#V4L2_FIELD_HAS_BOTH
(
f›ld
) \

136 ((
f›ld
è=ğ
V4L2_FIELD_INTERLACED
 ||\

137 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_TB
 ||\

138 (
f›ld
è=ğ
V4L2_FIELD_INTERLACED_BT
 ||\

139 (
f›ld
è=ğ
V4L2_FIELD_SEQ_TB
 ||\

140 (
f›ld
è=ğ
V4L2_FIELD_SEQ_BT
)

	)

142 
	ev4l2_buf_ty³
 {

143 
	mV4L2_BUF_TYPE_VIDEO_CAPTURE
 = 1,

144 
	mV4L2_BUF_TYPE_VIDEO_OUTPUT
 = 2,

145 
	mV4L2_BUF_TYPE_VIDEO_OVERLAY
 = 3,

146 
	mV4L2_BUF_TYPE_VBI_CAPTURE
 = 4,

147 
	mV4L2_BUF_TYPE_VBI_OUTPUT
 = 5,

148 
	mV4L2_BUF_TYPE_SLICED_VBI_CAPTURE
 = 6,

149 
	mV4L2_BUF_TYPE_SLICED_VBI_OUTPUT
 = 7,

152 
	mV4L2_BUF_TYPE_VIDEO_OUTPUT_OVERLAY
 = 8,

154 
	mV4L2_BUF_TYPE_PRIVATE
 = 0x80,

157 
	ev4l2_ù¾_ty³
 {

158 
	mV4L2_CTRL_TYPE_INTEGER
 = 1,

159 
	mV4L2_CTRL_TYPE_BOOLEAN
 = 2,

160 
	mV4L2_CTRL_TYPE_MENU
 = 3,

161 
	mV4L2_CTRL_TYPE_BUTTON
 = 4,

162 
	mV4L2_CTRL_TYPE_INTEGER64
 = 5,

163 
	mV4L2_CTRL_TYPE_CTRL_CLASS
 = 6,

166 
	ev4l2_tuÃr_ty³
 {

167 
	mV4L2_TUNER_RADIO
 = 1,

168 
	mV4L2_TUNER_ANALOG_TV
 = 2,

169 
	mV4L2_TUNER_DIGITAL_TV
 = 3,

172 
	ev4l2_memÜy
 {

173 
	mV4L2_MEMORY_MMAP
 = 1,

174 
	mV4L2_MEMORY_USERPTR
 = 2,

175 
	mV4L2_MEMORY_OVERLAY
 = 3,

179 
	ev4l2_cŞÜ¥aû
 {

181 
	mV4L2_COLORSPACE_SMPTE170M
 = 1,

184 
	mV4L2_COLORSPACE_SMPTE240M
 = 2,

187 
	mV4L2_COLORSPACE_REC709
 = 3,

190 
	mV4L2_COLORSPACE_BT878
 = 4,

193 
	mV4L2_COLORSPACE_470_SYSTEM_M
 = 5,

194 
	mV4L2_COLORSPACE_470_SYSTEM_BG
 = 6,

200 
	mV4L2_COLORSPACE_JPEG
 = 7,

203 
	mV4L2_COLORSPACE_SRGB
 = 8,

206 
	ev4l2_´iÜ™y
 {

207 
	mV4L2_PRIORITY_UNSET
 = 0,

208 
	mV4L2_PRIORITY_BACKGROUND
 = 1,

209 
	mV4L2_PRIORITY_INTERACTIVE
 = 2,

210 
	mV4L2_PRIORITY_RECORD
 = 3,

211 
	mV4L2_PRIORITY_DEFAULT
 = 
V4L2_PRIORITY_INTERACTIVE
,

214 
	sv4l2_»ù
 {

215 
__s32
 
	mËá
;

216 
__s32
 
	mtİ
;

217 
__s32
 
	mwidth
;

218 
__s32
 
	mheight
;

221 
	sv4l2_äaù
 {

222 
__u32
 
	mnum”©Ü
;

223 
__u32
 
	md’omš©Ü
;

229 
	sv4l2_ÿ·b™y
 {

230 
__u8
 
	mdriv”
[16];

231 
__u8
 
	mÿrd
[32];

232 
__u8
 
	mbus_šfo
[32];

233 
__u32
 
	mv”siÚ
;

234 
__u32
 
	mÿ·b™›s
;

235 
__u32
 
	m»£rved
[4];

239 
	#V4L2_CAP_VIDEO_CAPTURE
 0x00000001

	)

240 
	#V4L2_CAP_VIDEO_OUTPUT
 0x00000002

	)

241 
	#V4L2_CAP_VIDEO_OVERLAY
 0x00000004

	)

242 
	#V4L2_CAP_VBI_CAPTURE
 0x00000010

	)

243 
	#V4L2_CAP_VBI_OUTPUT
 0x00000020

	)

244 
	#V4L2_CAP_SLICED_VBI_CAPTURE
 0x00000040

	)

245 
	#V4L2_CAP_SLICED_VBI_OUTPUT
 0x00000080

	)

246 
	#V4L2_CAP_RDS_CAPTURE
 0x00000100

	)

247 
	#V4L2_CAP_VIDEO_OUTPUT_OVERLAY
 0x00000200

	)

248 
	#V4L2_CAP_HW_FREQ_SEEK
 0x00000400

	)

250 
	#V4L2_CAP_TUNER
 0x00010000

	)

251 
	#V4L2_CAP_AUDIO
 0x00020000

	)

252 
	#V4L2_CAP_RADIO
 0x00040000

	)

254 
	#V4L2_CAP_READWRITE
 0x01000000

	)

255 
	#V4L2_CAP_ASYNCIO
 0x02000000

	)

256 
	#V4L2_CAP_STREAMING
 0x04000000

	)

261 
	sv4l2_pix_fÜm©
 {

262 
__u32
 
	mwidth
;

263 
__u32
 
	mheight
;

264 
__u32
 
	mpix–fÜm©
;

265 
v4l2_f›ld
 
	mf›ld
;

266 
__u32
 
	mby‹¥”lše
;

267 
__u32
 
	msizeimage
;

268 
v4l2_cŞÜ¥aû
 
	mcŞÜ¥aû
;

269 
__u32
 
	m´iv
;

273 
	#V4L2_PIX_FMT_RGB332
 
	`v4l2_fourcc
('R', 'G', 'B', '1'è

	)

274 
	#V4L2_PIX_FMT_RGB444
 
	`v4l2_fourcc
('R', '4', '4', '4'è

	)

275 
	#V4L2_PIX_FMT_RGB555
 
	`v4l2_fourcc
('R', 'G', 'B', 'O'è

	)

276 
	#V4L2_PIX_FMT_RGB565
 
	`v4l2_fourcc
('R', 'G', 'B', 'P'è

	)

277 
	#V4L2_PIX_FMT_RGB555X
 
	`v4l2_fourcc
('R', 'G', 'B', 'Q'è

	)

278 
	#V4L2_PIX_FMT_RGB565X
 
	`v4l2_fourcc
('R', 'G', 'B', 'R'è

	)

279 
	#V4L2_PIX_FMT_BGR24
 
	`v4l2_fourcc
('B', 'G', 'R', '3'è

	)

280 
	#V4L2_PIX_FMT_RGB24
 
	`v4l2_fourcc
('R', 'G', 'B', '3'è

	)

281 
	#V4L2_PIX_FMT_BGR32
 
	`v4l2_fourcc
('B', 'G', 'R', '4'è

	)

282 
	#V4L2_PIX_FMT_RGB32
 
	`v4l2_fourcc
('R', 'G', 'B', '4'è

	)

283 
	#V4L2_PIX_FMT_GREY
 
	`v4l2_fourcc
('G', 'R', 'E', 'Y'è

	)

284 
	#V4L2_PIX_FMT_Y16
 
	`v4l2_fourcc
('Y', '1', '6', ' 'è

	)

285 
	#V4L2_PIX_FMT_PAL8
 
	`v4l2_fourcc
('P', 'A', 'L', '8'è

	)

286 
	#V4L2_PIX_FMT_YVU410
 
	`v4l2_fourcc
('Y', 'V', 'U', '9'è

	)

287 
	#V4L2_PIX_FMT_YVU420
 
	`v4l2_fourcc
('Y', 'V', '1', '2'è

	)

288 
	#V4L2_PIX_FMT_YUYV
 
	`v4l2_fourcc
('Y', 'U', 'Y', 'V'è

	)

289 
	#V4L2_PIX_FMT_UYVY
 
	`v4l2_fourcc
('U', 'Y', 'V', 'Y'è

	)

290 
	#V4L2_PIX_FMT_VYUY
 
	`v4l2_fourcc
('V', 'Y', 'U', 'Y'è

	)

291 
	#V4L2_PIX_FMT_YUV422P
 
	`v4l2_fourcc
('4', '2', '2', 'P'è

	)

292 
	#V4L2_PIX_FMT_YUV411P
 
	`v4l2_fourcc
('4', '1', '1', 'P'è

	)

293 
	#V4L2_PIX_FMT_Y41P
 
	`v4l2_fourcc
('Y', '4', '1', 'P'è

	)

294 
	#V4L2_PIX_FMT_YUV444
 
	`v4l2_fourcc
('Y', '4', '4', '4'è

	)

295 
	#V4L2_PIX_FMT_YUV555
 
	`v4l2_fourcc
('Y', 'U', 'V', 'O'è

	)

296 
	#V4L2_PIX_FMT_YUV565
 
	`v4l2_fourcc
('Y', 'U', 'V', 'P'è

	)

297 
	#V4L2_PIX_FMT_YUV32
 
	`v4l2_fourcc
('Y', 'U', 'V', '4'è

	)

300 
	#V4L2_PIX_FMT_NV12
 
	`v4l2_fourcc
('N', 'V', '1', '2'è

	)

301 
	#V4L2_PIX_FMT_NV21
 
	`v4l2_fourcc
('N', 'V', '2', '1'è

	)

302 
	#V4L2_PIX_FMT_NV16
 
	`v4l2_fourcc
('N', 'V', '1', '6'è

	)

303 
	#V4L2_PIX_FMT_NV61
 
	`v4l2_fourcc
('N', 'V', '6', '1'è

	)

306 
	#V4L2_PIX_FMT_YUV410
 
	`v4l2_fourcc
('Y', 'U', 'V', '9'è

	)

307 
	#V4L2_PIX_FMT_YUV420
 
	`v4l2_fourcc
('Y', 'U', '1', '2'è

	)

308 
	#V4L2_PIX_FMT_YYUV
 
	`v4l2_fourcc
('Y', 'Y', 'U', 'V'è

	)

309 
	#V4L2_PIX_FMT_HI240
 
	`v4l2_fourcc
('H', 'I', '2', '4'è

	)

310 
	#V4L2_PIX_FMT_HM12
 
	`v4l2_fourcc
('H', 'M', '1', '2'è

	)

313 
	#V4L2_PIX_FMT_SBGGR8
 
	`v4l2_fourcc
('B', 'A', '8', '1'è

	)

314 
	#V4L2_PIX_FMT_SGBRG8
 
	`v4l2_fourcc
('G', 'B', 'R', 'G'è

	)

315 
	#V4L2_PIX_FMT_SGRBG8
 
	`v4l2_fourcc
('G', 'R', 'B', 'G'è

	)

321 
	#V4L2_PIX_FMT_SGRBG10
 
	`v4l2_fourcc
('B', 'A', '1', '0')

	)

323 
	#V4L2_PIX_FMT_SGRBG10DPCM8
 
	`v4l2_fourcc
('B', 'D', '1', '0')

	)

324 
	#V4L2_PIX_FMT_SBGGR16
 
	`v4l2_fourcc
('B', 'Y', 'R', '2'è

	)

327 
	#V4L2_PIX_FMT_MJPEG
 
	`v4l2_fourcc
('M', 'J', 'P', 'G'è

	)

328 
	#V4L2_PIX_FMT_JPEG
 
	`v4l2_fourcc
('J', 'P', 'E', 'G'è

	)

329 
	#V4L2_PIX_FMT_DV
 
	`v4l2_fourcc
('d', 'v', 's', 'd'è

	)

330 
	#V4L2_PIX_FMT_MPEG
 
	`v4l2_fourcc
('M', 'P', 'E', 'G'è

	)

333 
	#V4L2_PIX_FMT_WNVA
 
	`v4l2_fourcc
('W', 'N', 'V', 'A'è

	)

334 
	#V4L2_PIX_FMT_SN9C10X
 
	`v4l2_fourcc
('S', '9', '1', '0'è

	)

335 
	#V4L2_PIX_FMT_SN9C20X_I420
 
	`v4l2_fourcc
('S', '9', '2', '0'è

	)

336 
	#V4L2_PIX_FMT_PWC1
 
	`v4l2_fourcc
('P', 'W', 'C', '1'è

	)

337 
	#V4L2_PIX_FMT_PWC2
 
	`v4l2_fourcc
('P', 'W', 'C', '2'è

	)

338 
	#V4L2_PIX_FMT_ET61X251
 
	`v4l2_fourcc
('E', '6', '2', '5'è

	)

339 
	#V4L2_PIX_FMT_SPCA501
 
	`v4l2_fourcc
('S', '5', '0', '1'è

	)

340 
	#V4L2_PIX_FMT_SPCA505
 
	`v4l2_fourcc
('S', '5', '0', '5'è

	)

341 
	#V4L2_PIX_FMT_SPCA508
 
	`v4l2_fourcc
('S', '5', '0', '8'è

	)

342 
	#V4L2_PIX_FMT_SPCA561
 
	`v4l2_fourcc
('S', '5', '6', '1'è

	)

343 
	#V4L2_PIX_FMT_PAC207
 
	`v4l2_fourcc
('P', '2', '0', '7'è

	)

344 
	#V4L2_PIX_FMT_MR97310A
 
	`v4l2_fourcc
('M', '3', '1', '0'è

	)

345 
	#V4L2_PIX_FMT_SQ905C
 
	`v4l2_fourcc
('9', '0', '5', 'C'è

	)

346 
	#V4L2_PIX_FMT_PJPG
 
	`v4l2_fourcc
('P', 'J', 'P', 'G'è

	)

347 
	#V4L2_PIX_FMT_YVYU
 
	`v4l2_fourcc
('Y', 'V', 'Y', 'U'è

	)

348 
	#V4L2_PIX_FMT_OV511
 
	`v4l2_fourcc
('O', '5', '1', '1'è

	)

349 
	#V4L2_PIX_FMT_OV518
 
	`v4l2_fourcc
('O', '5', '1', '8'è

	)

354 
	sv4l2_fmtdesc
 {

355 
__u32
 
	mšdex
;

356 
v4l2_buf_ty³
 
	mty³
;

357 
__u32
 
	mæags
;

358 
__u8
 
	mdesütiÚ
[32];

359 
__u32
 
	mpix–fÜm©
;

360 
__u32
 
	m»£rved
[4];

363 
	#V4L2_FMT_FLAG_COMPRESSED
 0x0001

	)

370 
	ev4l2_ämsiz‘y³s
 {

371 
	mV4L2_FRMSIZE_TYPE_DISCRETE
 = 1,

372 
	mV4L2_FRMSIZE_TYPE_CONTINUOUS
 = 2,

373 
	mV4L2_FRMSIZE_TYPE_STEPWISE
 = 3,

376 
	sv4l2_ämsize_disü‘e
 {

377 
__u32
 
	mwidth
;

378 
__u32
 
	mheight
;

381 
	sv4l2_ämsize_¡•wi£
 {

382 
__u32
 
	mmš_width
;

383 
__u32
 
	mmax_width
;

384 
__u32
 
	m¡•_width
;

385 
__u32
 
	mmš_height
;

386 
__u32
 
	mmax_height
;

387 
__u32
 
	m¡•_height
;

390 
	sv4l2_ämsiz“num
 {

391 
__u32
 
	mšdex
;

392 
__u32
 
	mpix–_fÜm©
;

393 
__u32
 
	mty³
;

396 
v4l2_ämsize_disü‘e
 
	mdisü‘e
;

397 
v4l2_ämsize_¡•wi£
 
	m¡•wi£
;

400 
__u32
 
	m»£rved
[2];

406 
	ev4l2_ämiv®ty³s
 {

407 
	mV4L2_FRMIVAL_TYPE_DISCRETE
 = 1,

408 
	mV4L2_FRMIVAL_TYPE_CONTINUOUS
 = 2,

409 
	mV4L2_FRMIVAL_TYPE_STEPWISE
 = 3,

412 
	sv4l2_ämiv®_¡•wi£
 {

413 
v4l2_äaù
 
	mmš
;

414 
v4l2_äaù
 
	mmax
;

415 
v4l2_äaù
 
	m¡•
;

418 
	sv4l2_ämiv®’um
 {

419 
__u32
 
	mšdex
;

420 
__u32
 
	mpix–_fÜm©
;

421 
__u32
 
	mwidth
;

422 
__u32
 
	mheight
;

423 
__u32
 
	mty³
;

426 
v4l2_äaù
 
	mdisü‘e
;

427 
v4l2_ämiv®_¡•wi£
 
	m¡•wi£
;

430 
__u32
 
	m»£rved
[2];

437 
	sv4l2_timecode
 {

438 
__u32
 
	mty³
;

439 
__u32
 
	mæags
;

440 
__u8
 
	mäames
;

441 
__u8
 
	m£cÚds
;

442 
__u8
 
	mmšu‹s
;

443 
__u8
 
	mhours
;

444 
__u8
 
	mu£rb™s
[4];

448 
	#V4L2_TC_TYPE_24FPS
 1

	)

449 
	#V4L2_TC_TYPE_25FPS
 2

	)

450 
	#V4L2_TC_TYPE_30FPS
 3

	)

451 
	#V4L2_TC_TYPE_50FPS
 4

	)

452 
	#V4L2_TC_TYPE_60FPS
 5

	)

455 
	#V4L2_TC_FLAG_DROPFRAME
 0x0001

	)

456 
	#V4L2_TC_FLAG_COLORFRAME
 0x0002

	)

457 
	#V4L2_TC_USERBITS_f›ld
 0x000C

	)

458 
	#V4L2_TC_USERBITS_USERDEFINED
 0x0000

	)

459 
	#V4L2_TC_USERBITS_8BITCHARS
 0x0008

	)

462 
	sv4l2_j³gcom´essiÚ
 {

463 
	mqu®™y
;

465 
	mAPPn
;

467 
	mAPP_Ën
;

468 
	mAPP_d©a
[60];

470 
	mCOM_Ën
;

471 
	mCOM_d©a
[60];

473 
__u32
 
	mj³g_m¬k”s
;

483 
	#V4L2_JPEG_MARKER_DHT
 (1<<3è

	)

484 
	#V4L2_JPEG_MARKER_DQT
 (1<<4è

	)

485 
	#V4L2_JPEG_MARKER_DRI
 (1<<5è

	)

486 
	#V4L2_JPEG_MARKER_COM
 (1<<6è

	)

487 
	#V4L2_JPEG_MARKER_APP
 (1<<7è

	)

494 
	sv4l2_»que¡bufãrs
 {

495 
__u32
 
	mcouÁ
;

496 
v4l2_buf_ty³
 
	mty³
;

497 
v4l2_memÜy
 
	mmemÜy
;

498 
__u32
 
	m»£rved
[2];

501 
	sv4l2_bufãr
 {

502 
__u32
 
	mšdex
;

503 
v4l2_buf_ty³
 
	mty³
;

504 
__u32
 
	mby‹su£d
;

505 
__u32
 
	mæags
;

506 
v4l2_f›ld
 
	mf›ld
;

507 
timev®
 
	mtime¡amp
;

508 
v4l2_timecode
 
	mtimecode
;

509 
__u32
 
	m£qu’û
;

512 
v4l2_memÜy
 
	mmemÜy
;

514 
__u32
 
	moff£t
;

515 
	mu£½Œ
;

516 } 
	mm
;

517 
__u32
 
	mËngth
;

518 
__u32
 
	mšput
;

519 
__u32
 
	m»£rved
;

523 
	#V4L2_BUF_FLAG_MAPPED
 0x0001

	)

524 
	#V4L2_BUF_FLAG_QUEUED
 0x0002

	)

525 
	#V4L2_BUF_FLAG_DONE
 0x0004

	)

526 
	#V4L2_BUF_FLAG_KEYFRAME
 0x0008

	)

527 
	#V4L2_BUF_FLAG_PFRAME
 0x0010

	)

528 
	#V4L2_BUF_FLAG_BFRAME
 0x0020

	)

529 
	#V4L2_BUF_FLAG_TIMECODE
 0x0100

	)

530 
	#V4L2_BUF_FLAG_INPUT
 0x0200

	)

535 
	sv4l2_äamebufãr
 {

536 
__u32
 
	mÿ·b™y
;

537 
__u32
 
	mæags
;

540 *
	mba£
;

541 
v4l2_pix_fÜm©
 
	mfmt
;

544 
	#V4L2_FBUF_CAP_EXTERNOVERLAY
 0x0001

	)

545 
	#V4L2_FBUF_CAP_CHROMAKEY
 0x0002

	)

546 
	#V4L2_FBUF_CAP_LIST_CLIPPING
 0x0004

	)

547 
	#V4L2_FBUF_CAP_BITMAP_CLIPPING
 0x0008

	)

548 
	#V4L2_FBUF_CAP_LOCAL_ALPHA
 0x0010

	)

549 
	#V4L2_FBUF_CAP_GLOBAL_ALPHA
 0x0020

	)

550 
	#V4L2_FBUF_CAP_LOCAL_INV_ALPHA
 0x0040

	)

552 
	#V4L2_FBUF_FLAG_PRIMARY
 0x0001

	)

553 
	#V4L2_FBUF_FLAG_OVERLAY
 0x0002

	)

554 
	#V4L2_FBUF_FLAG_CHROMAKEY
 0x0004

	)

555 
	#V4L2_FBUF_FLAG_LOCAL_ALPHA
 0x0008

	)

556 
	#V4L2_FBUF_FLAG_GLOBAL_ALPHA
 0x0010

	)

557 
	#V4L2_FBUF_FLAG_LOCAL_INV_ALPHA
 0x0020

	)

559 
	sv4l2_ş
 {

560 
v4l2_»ù
 
	mc
;

561 
v4l2_ş
 *
	mÃxt
;

564 
	sv4l2_wšdow
 {

565 
v4l2_»ù
 
	mw
;

566 
v4l2_f›ld
 
	mf›ld
;

567 
__u32
 
	mchromakey
;

568 
v4l2_ş
 *
	mşs
;

569 
__u32
 
	mşcouÁ
;

570 *
	mb™m­
;

571 
__u8
 
	mglob®_®pha
;

577 
	sv4l2_ÿ±u»·rm
 {

578 
__u32
 
	mÿ·b™y
;

579 
__u32
 
	mÿ±u»mode
;

580 
v4l2_äaù
 
	mtim•”äame
;

581 
__u32
 
	mex‹ndedmode
;

582 
__u32
 
	m»adbufãrs
;

583 
__u32
 
	m»£rved
[4];

587 
	#V4L2_MODE_HIGHQUALITY
 0x0001

	)

588 
	#V4L2_CAP_TIMEPERFRAME
 0x1000

	)

590 
	sv4l2_ouu¬m
 {

591 
__u32
 
	mÿ·b™y
;

592 
__u32
 
	mouutmode
;

593 
v4l2_äaù
 
	mtim•”äame
;

594 
__u32
 
	mex‹ndedmode
;

595 
__u32
 
	mwr™ebufãrs
;

596 
__u32
 
	m»£rved
[4];

602 
	sv4l2_üİÿp
 {

603 
v4l2_buf_ty³
 
	mty³
;

604 
v4l2_»ù
 
	mbounds
;

605 
v4l2_»ù
 
	mdeäeù
;

606 
v4l2_äaù
 
	mpix–a¥eù
;

609 
	sv4l2_üİ
 {

610 
v4l2_buf_ty³
 
	mty³
;

611 
v4l2_»ù
 
	mc
;

618 
__u64
 
	tv4l2_¡d_id
;

621 
	#V4L2_STD_PAL_B
 ((
v4l2_¡d_id
)0x00000001)

	)

622 
	#V4L2_STD_PAL_B1
 ((
v4l2_¡d_id
)0x00000002)

	)

623 
	#V4L2_STD_PAL_G
 ((
v4l2_¡d_id
)0x00000004)

	)

624 
	#V4L2_STD_PAL_H
 ((
v4l2_¡d_id
)0x00000008)

	)

625 
	#V4L2_STD_PAL_I
 ((
v4l2_¡d_id
)0x00000010)

	)

626 
	#V4L2_STD_PAL_D
 ((
v4l2_¡d_id
)0x00000020)

	)

627 
	#V4L2_STD_PAL_D1
 ((
v4l2_¡d_id
)0x00000040)

	)

628 
	#V4L2_STD_PAL_K
 ((
v4l2_¡d_id
)0x00000080)

	)

630 
	#V4L2_STD_PAL_M
 ((
v4l2_¡d_id
)0x00000100)

	)

631 
	#V4L2_STD_PAL_N
 ((
v4l2_¡d_id
)0x00000200)

	)

632 
	#V4L2_STD_PAL_Nc
 ((
v4l2_¡d_id
)0x00000400)

	)

633 
	#V4L2_STD_PAL_60
 ((
v4l2_¡d_id
)0x00000800)

	)

635 
	#V4L2_STD_NTSC_M
 ((
v4l2_¡d_id
)0x00001000)

	)

636 
	#V4L2_STD_NTSC_M_JP
 ((
v4l2_¡d_id
)0x00002000)

	)

637 
	#V4L2_STD_NTSC_443
 ((
v4l2_¡d_id
)0x00004000)

	)

638 
	#V4L2_STD_NTSC_M_KR
 ((
v4l2_¡d_id
)0x00008000)

	)

640 
	#V4L2_STD_SECAM_B
 ((
v4l2_¡d_id
)0x00010000)

	)

641 
	#V4L2_STD_SECAM_D
 ((
v4l2_¡d_id
)0x00020000)

	)

642 
	#V4L2_STD_SECAM_G
 ((
v4l2_¡d_id
)0x00040000)

	)

643 
	#V4L2_STD_SECAM_H
 ((
v4l2_¡d_id
)0x00080000)

	)

644 
	#V4L2_STD_SECAM_K
 ((
v4l2_¡d_id
)0x00100000)

	)

645 
	#V4L2_STD_SECAM_K1
 ((
v4l2_¡d_id
)0x00200000)

	)

646 
	#V4L2_STD_SECAM_L
 ((
v4l2_¡d_id
)0x00400000)

	)

647 
	#V4L2_STD_SECAM_LC
 ((
v4l2_¡d_id
)0x00800000)

	)

650 
	#V4L2_STD_ATSC_8_VSB
 ((
v4l2_¡d_id
)0x01000000)

	)

651 
	#V4L2_STD_ATSC_16_VSB
 ((
v4l2_¡d_id
)0x02000000)

	)

663 
	#V4L2_STD_MN
 (
V4L2_STD_PAL_M
|
V4L2_STD_PAL_N
|
V4L2_STD_PAL_Nc
|
V4L2_STD_NTSC
)

	)

664 
	#V4L2_STD_B
 (
V4L2_STD_PAL_B
|
V4L2_STD_PAL_B1
|
V4L2_STD_SECAM_B
)

	)

665 
	#V4L2_STD_GH
 (
V4L2_STD_PAL_G
|
V4L2_STD_PAL_H
|
V4L2_STD_SECAM_G
|
V4L2_STD_SECAM_H
)

	)

666 
	#V4L2_STD_DK
 (
V4L2_STD_PAL_DK
|
V4L2_STD_SECAM_DK
)

	)

669 
	#V4L2_STD_PAL_BG
 (
V4L2_STD_PAL_B
 |\

670 
V4L2_STD_PAL_B1
 |\

671 
V4L2_STD_PAL_G
)

	)

672 
	#V4L2_STD_PAL_DK
 (
V4L2_STD_PAL_D
 |\

673 
V4L2_STD_PAL_D1
 |\

674 
V4L2_STD_PAL_K
)

	)

675 
	#V4L2_STD_PAL
 (
V4L2_STD_PAL_BG
 |\

676 
V4L2_STD_PAL_DK
 |\

677 
V4L2_STD_PAL_H
 |\

678 
V4L2_STD_PAL_I
)

	)

679 
	#V4L2_STD_NTSC
 (
V4L2_STD_NTSC_M
 |\

680 
V4L2_STD_NTSC_M_JP
 |\

681 
V4L2_STD_NTSC_M_KR
)

	)

682 
	#V4L2_STD_SECAM_DK
 (
V4L2_STD_SECAM_D
 |\

683 
V4L2_STD_SECAM_K
 |\

684 
V4L2_STD_SECAM_K1
)

	)

685 
	#V4L2_STD_SECAM
 (
V4L2_STD_SECAM_B
 |\

686 
V4L2_STD_SECAM_G
 |\

687 
V4L2_STD_SECAM_H
 |\

688 
V4L2_STD_SECAM_DK
 |\

689 
V4L2_STD_SECAM_L
 |\

690 
V4L2_STD_SECAM_LC
)

	)

692 
	#V4L2_STD_525_60
 (
V4L2_STD_PAL_M
 |\

693 
V4L2_STD_PAL_60
 |\

694 
V4L2_STD_NTSC
 |\

695 
V4L2_STD_NTSC_443
)

	)

696 
	#V4L2_STD_625_50
 (
V4L2_STD_PAL
 |\

697 
V4L2_STD_PAL_N
 |\

698 
V4L2_STD_PAL_Nc
 |\

699 
V4L2_STD_SECAM
)

	)

700 
	#V4L2_STD_ATSC
 (
V4L2_STD_ATSC_8_VSB
 |\

701 
V4L2_STD_ATSC_16_VSB
)

	)

703 
	#V4L2_STD_UNKNOWN
 0

	)

704 
	#V4L2_STD_ALL
 (
V4L2_STD_525_60
 |\

705 
V4L2_STD_625_50
)

	)

707 
	sv4l2_¡ªd¬d
 {

708 
__u32
 
	mšdex
;

709 
v4l2_¡d_id
 
	mid
;

710 
__u8
 
	mÇme
[24];

711 
v4l2_äaù
 
	mäam•”iod
;

712 
__u32
 
	mäam–šes
;

713 
__u32
 
	m»£rved
[4];

719 
	sv4l2_šput
 {

720 
__u32
 
	mšdex
;

721 
__u8
 
	mÇme
[32];

722 
__u32
 
	mty³
;

723 
__u32
 
	maudio£t
;

724 
__u32
 
	mtuÃr
;

725 
v4l2_¡d_id
 
	m¡d
;

726 
__u32
 
	m¡©us
;

727 
__u32
 
	m»£rved
[4];

731 
	#V4L2_INPUT_TYPE_TUNER
 1

	)

732 
	#V4L2_INPUT_TYPE_CAMERA
 2

	)

735 
	#V4L2_IN_ST_NO_POWER
 0x00000001

	)

736 
	#V4L2_IN_ST_NO_SIGNAL
 0x00000002

	)

737 
	#V4L2_IN_ST_NO_COLOR
 0x00000004

	)

741 
	#V4L2_IN_ST_HFLIP
 0x00000010

	)

742 
	#V4L2_IN_ST_VFLIP
 0x00000020

	)

745 
	#V4L2_IN_ST_NO_H_LOCK
 0x00000100

	)

746 
	#V4L2_IN_ST_COLOR_KILL
 0x00000200

	)

749 
	#V4L2_IN_ST_NO_SYNC
 0x00010000

	)

750 
	#V4L2_IN_ST_NO_EQU
 0x00020000

	)

751 
	#V4L2_IN_ST_NO_CARRIER
 0x00040000

	)

754 
	#V4L2_IN_ST_MACROVISION
 0x01000000

	)

755 
	#V4L2_IN_ST_NO_ACCESS
 0x02000000

	)

756 
	#V4L2_IN_ST_VTR
 0x04000000

	)

761 
	sv4l2_ouut
 {

762 
__u32
 
	mšdex
;

763 
__u8
 
	mÇme
[32];

764 
__u32
 
	mty³
;

765 
__u32
 
	maudio£t
;

766 
__u32
 
	mmoduÏtÜ
;

767 
v4l2_¡d_id
 
	m¡d
;

768 
__u32
 
	m»£rved
[4];

771 
	#V4L2_OUTPUT_TYPE_MODULATOR
 1

	)

772 
	#V4L2_OUTPUT_TYPE_ANALOG
 2

	)

773 
	#V4L2_OUTPUT_TYPE_ANALOGVGAOVERLAY
 3

	)

778 
	sv4l2_cÚŒŞ
 {

779 
__u32
 
	mid
;

780 
__s32
 
	mv®ue
;

783 
	sv4l2_ext_cÚŒŞ
 {

784 
__u32
 
	mid
;

785 
__u32
 
	m»£rved2
[2];

787 
__s32
 
	mv®ue
;

788 
__s64
 
	mv®ue64
;

789 *
	m»£rved
;

791 } 
__©Œibu‹__
 ((
·cked
));

793 
	sv4l2_ext_cÚŒŞs
 {

794 
__u32
 
	mù¾_şass
;

795 
__u32
 
	mcouÁ
;

796 
__u32
 
	m”rÜ_idx
;

797 
__u32
 
	m»£rved
[2];

798 
v4l2_ext_cÚŒŞ
 *
	mcÚŒŞs
;

802 
	#V4L2_CTRL_CLASS_USER
 0x00980000

	)

803 
	#V4L2_CTRL_CLASS_MPEG
 0x00990000

	)

804 
	#V4L2_CTRL_CLASS_CAMERA
 0x009a0000

	)

806 
	#V4L2_CTRL_ID_MASK
 (0x0fffffff)

	)

807 
	#V4L2_CTRL_ID2CLASS
(
id
è((idè& 0x0fff0000UL)

	)

808 
	#V4L2_CTRL_DRIVER_PRIV
(
id
è(((idè& 0xffffè>ğ0x1000)

	)

811 
	sv4l2_qu”yù¾
 {

812 
__u32
 
	mid
;

813 
v4l2_ù¾_ty³
 
	mty³
;

814 
__u8
 
	mÇme
[32];

815 
__s32
 
	mmšimum
;

816 
__s32
 
	mmaximum
;

817 
__s32
 
	m¡•
;

818 
__s32
 
	mdeçuÉ_v®ue
;

819 
__u32
 
	mæags
;

820 
__u32
 
	m»£rved
[2];

824 
	sv4l2_qu”ym’u
 {

825 
__u32
 
	mid
;

826 
__u32
 
	mšdex
;

827 
__u8
 
	mÇme
[32];

828 
__u32
 
	m»£rved
;

832 
	#V4L2_CTRL_FLAG_DISABLED
 0x0001

	)

833 
	#V4L2_CTRL_FLAG_GRABBED
 0x0002

	)

834 
	#V4L2_CTRL_FLAG_READ_ONLY
 0x0004

	)

835 
	#V4L2_CTRL_FLAG_UPDATE
 0x0008

	)

836 
	#V4L2_CTRL_FLAG_INACTIVE
 0x0010

	)

837 
	#V4L2_CTRL_FLAG_SLIDER
 0x0020

	)

838 
	#V4L2_CTRL_FLAG_WRITE_ONLY
 0x0040

	)

841 
	#V4L2_CTRL_FLAG_NEXT_CTRL
 0x80000000

	)

844 
	#V4L2_CID_BASE
 (
V4L2_CTRL_CLASS_USER
 | 0x900)

	)

845 
	#V4L2_CID_USER_BASE
 
V4L2_CID_BASE


	)

847 
	#V4L2_CID_PRIVATE_BASE
 0x08000000

	)

849 
	#V4L2_CID_USER_CLASS
 (
V4L2_CTRL_CLASS_USER
 | 1)

	)

850 
	#V4L2_CID_BRIGHTNESS
 (
V4L2_CID_BASE
+0)

	)

851 
	#V4L2_CID_CONTRAST
 (
V4L2_CID_BASE
+1)

	)

852 
	#V4L2_CID_SATURATION
 (
V4L2_CID_BASE
+2)

	)

853 
	#V4L2_CID_HUE
 (
V4L2_CID_BASE
+3)

	)

854 
	#V4L2_CID_AUDIO_VOLUME
 (
V4L2_CID_BASE
+5)

	)

855 
	#V4L2_CID_AUDIO_BALANCE
 (
V4L2_CID_BASE
+6)

	)

856 
	#V4L2_CID_AUDIO_BASS
 (
V4L2_CID_BASE
+7)

	)

857 
	#V4L2_CID_AUDIO_TREBLE
 (
V4L2_CID_BASE
+8)

	)

858 
	#V4L2_CID_AUDIO_MUTE
 (
V4L2_CID_BASE
+9)

	)

859 
	#V4L2_CID_AUDIO_LOUDNESS
 (
V4L2_CID_BASE
+10)

	)

860 
	#V4L2_CID_BLACK_LEVEL
 (
V4L2_CID_BASE
+11è

	)

861 
	#V4L2_CID_AUTO_WHITE_BALANCE
 (
V4L2_CID_BASE
+12)

	)

862 
	#V4L2_CID_DO_WHITE_BALANCE
 (
V4L2_CID_BASE
+13)

	)

863 
	#V4L2_CID_RED_BALANCE
 (
V4L2_CID_BASE
+14)

	)

864 
	#V4L2_CID_BLUE_BALANCE
 (
V4L2_CID_BASE
+15)

	)

865 
	#V4L2_CID_GAMMA
 (
V4L2_CID_BASE
+16)

	)

866 
	#V4L2_CID_WHITENESS
 (
V4L2_CID_GAMMA
è

	)

867 
	#V4L2_CID_EXPOSURE
 (
V4L2_CID_BASE
+17)

	)

868 
	#V4L2_CID_AUTOGAIN
 (
V4L2_CID_BASE
+18)

	)

869 
	#V4L2_CID_GAIN
 (
V4L2_CID_BASE
+19)

	)

870 
	#V4L2_CID_HFLIP
 (
V4L2_CID_BASE
+20)

	)

871 
	#V4L2_CID_VFLIP
 (
V4L2_CID_BASE
+21)

	)

874 
	#V4L2_CID_HCENTER
 (
V4L2_CID_BASE
+22)

	)

875 
	#V4L2_CID_VCENTER
 (
V4L2_CID_BASE
+23)

	)

877 
	#V4L2_CID_POWER_LINE_FREQUENCY
 (
V4L2_CID_BASE
+24)

	)

878 
	ev4l2_pow”_lše_äequ’cy
 {

879 
	mV4L2_CID_POWER_LINE_FREQUENCY_DISABLED
 = 0,

880 
	mV4L2_CID_POWER_LINE_FREQUENCY_50HZ
 = 1,

881 
	mV4L2_CID_POWER_LINE_FREQUENCY_60HZ
 = 2,

883 
	#V4L2_CID_HUE_AUTO
 (
V4L2_CID_BASE
+25)

	)

884 
	#V4L2_CID_WHITE_BALANCE_TEMPERATURE
 (
V4L2_CID_BASE
+26)

	)

885 
	#V4L2_CID_SHARPNESS
 (
V4L2_CID_BASE
+27)

	)

886 
	#V4L2_CID_BACKLIGHT_COMPENSATION
 (
V4L2_CID_BASE
+28)

	)

887 
	#V4L2_CID_CHROMA_AGC
 (
V4L2_CID_BASE
+29)

	)

888 
	#V4L2_CID_COLOR_KILLER
 (
V4L2_CID_BASE
+30)

	)

889 
	#V4L2_CID_COLORFX
 (
V4L2_CID_BASE
+31)

	)

890 
	ev4l2_cŞÜfx
 {

891 
	mV4L2_COLORFX_NONE
 = 0,

892 
	mV4L2_COLORFX_BW
 = 1,

893 
	mV4L2_COLORFX_SEPIA
 = 2,

895 
	#V4L2_CID_AUTOBRIGHTNESS
 (
V4L2_CID_BASE
+32)

	)

898 
	#V4L2_CID_LASTP1
 (
V4L2_CID_BASE
+33)

	)

901 
	#V4L2_CID_MPEG_BASE
 (
V4L2_CTRL_CLASS_MPEG
 | 0x900)

	)

902 
	#V4L2_CID_MPEG_CLASS
 (
V4L2_CTRL_CLASS_MPEG
 | 1)

	)

905 
	#V4L2_CID_MPEG_STREAM_TYPE
 (
V4L2_CID_MPEG_BASE
+0)

	)

906 
	ev4l2_m³g_¡»am_ty³
 {

907 
	mV4L2_MPEG_STREAM_TYPE_MPEG2_PS
 = 0,

908 
	mV4L2_MPEG_STREAM_TYPE_MPEG2_TS
 = 1,

909 
	mV4L2_MPEG_STREAM_TYPE_MPEG1_SS
 = 2,

910 
	mV4L2_MPEG_STREAM_TYPE_MPEG2_DVD
 = 3,

911 
	mV4L2_MPEG_STREAM_TYPE_MPEG1_VCD
 = 4,

912 
	mV4L2_MPEG_STREAM_TYPE_MPEG2_SVCD
 = 5,

914 
	#V4L2_CID_MPEG_STREAM_PID_PMT
 (
V4L2_CID_MPEG_BASE
+1)

	)

915 
	#V4L2_CID_MPEG_STREAM_PID_AUDIO
 (
V4L2_CID_MPEG_BASE
+2)

	)

916 
	#V4L2_CID_MPEG_STREAM_PID_VIDEO
 (
V4L2_CID_MPEG_BASE
+3)

	)

917 
	#V4L2_CID_MPEG_STREAM_PID_PCR
 (
V4L2_CID_MPEG_BASE
+4)

	)

918 
	#V4L2_CID_MPEG_STREAM_PES_ID_AUDIO
 (
V4L2_CID_MPEG_BASE
+5)

	)

919 
	#V4L2_CID_MPEG_STREAM_PES_ID_VIDEO
 (
V4L2_CID_MPEG_BASE
+6)

	)

920 
	#V4L2_CID_MPEG_STREAM_VBI_FMT
 (
V4L2_CID_MPEG_BASE
+7)

	)

921 
	ev4l2_m³g_¡»am_vbi_fmt
 {

922 
	mV4L2_MPEG_STREAM_VBI_FMT_NONE
 = 0,

923 
	mV4L2_MPEG_STREAM_VBI_FMT_IVTV
 = 1,

927 
	#V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ
 (
V4L2_CID_MPEG_BASE
+100)

	)

928 
	ev4l2_m³g_audio_§m¶šg_äeq
 {

929 
	mV4L2_MPEG_AUDIO_SAMPLING_FREQ_44100
 = 0,

930 
	mV4L2_MPEG_AUDIO_SAMPLING_FREQ_48000
 = 1,

931 
	mV4L2_MPEG_AUDIO_SAMPLING_FREQ_32000
 = 2,

933 
	#V4L2_CID_MPEG_AUDIO_ENCODING
 (
V4L2_CID_MPEG_BASE
+101)

	)

934 
	ev4l2_m³g_audio_’codšg
 {

935 
	mV4L2_MPEG_AUDIO_ENCODING_LAYER_1
 = 0,

936 
	mV4L2_MPEG_AUDIO_ENCODING_LAYER_2
 = 1,

937 
	mV4L2_MPEG_AUDIO_ENCODING_LAYER_3
 = 2,

938 
	mV4L2_MPEG_AUDIO_ENCODING_AAC
 = 3,

939 
	mV4L2_MPEG_AUDIO_ENCODING_AC3
 = 4,

941 
	#V4L2_CID_MPEG_AUDIO_L1_BITRATE
 (
V4L2_CID_MPEG_BASE
+102)

	)

942 
	ev4l2_m³g_audio_l1_b™¿‹
 {

943 
	mV4L2_MPEG_AUDIO_L1_BITRATE_32K
 = 0,

944 
	mV4L2_MPEG_AUDIO_L1_BITRATE_64K
 = 1,

945 
	mV4L2_MPEG_AUDIO_L1_BITRATE_96K
 = 2,

946 
	mV4L2_MPEG_AUDIO_L1_BITRATE_128K
 = 3,

947 
	mV4L2_MPEG_AUDIO_L1_BITRATE_160K
 = 4,

948 
	mV4L2_MPEG_AUDIO_L1_BITRATE_192K
 = 5,

949 
	mV4L2_MPEG_AUDIO_L1_BITRATE_224K
 = 6,

950 
	mV4L2_MPEG_AUDIO_L1_BITRATE_256K
 = 7,

951 
	mV4L2_MPEG_AUDIO_L1_BITRATE_288K
 = 8,

952 
	mV4L2_MPEG_AUDIO_L1_BITRATE_320K
 = 9,

953 
	mV4L2_MPEG_AUDIO_L1_BITRATE_352K
 = 10,

954 
	mV4L2_MPEG_AUDIO_L1_BITRATE_384K
 = 11,

955 
	mV4L2_MPEG_AUDIO_L1_BITRATE_416K
 = 12,

956 
	mV4L2_MPEG_AUDIO_L1_BITRATE_448K
 = 13,

958 
	#V4L2_CID_MPEG_AUDIO_L2_BITRATE
 (
V4L2_CID_MPEG_BASE
+103)

	)

959 
	ev4l2_m³g_audio_l2_b™¿‹
 {

960 
	mV4L2_MPEG_AUDIO_L2_BITRATE_32K
 = 0,

961 
	mV4L2_MPEG_AUDIO_L2_BITRATE_48K
 = 1,

962 
	mV4L2_MPEG_AUDIO_L2_BITRATE_56K
 = 2,

963 
	mV4L2_MPEG_AUDIO_L2_BITRATE_64K
 = 3,

964 
	mV4L2_MPEG_AUDIO_L2_BITRATE_80K
 = 4,

965 
	mV4L2_MPEG_AUDIO_L2_BITRATE_96K
 = 5,

966 
	mV4L2_MPEG_AUDIO_L2_BITRATE_112K
 = 6,

967 
	mV4L2_MPEG_AUDIO_L2_BITRATE_128K
 = 7,

968 
	mV4L2_MPEG_AUDIO_L2_BITRATE_160K
 = 8,

969 
	mV4L2_MPEG_AUDIO_L2_BITRATE_192K
 = 9,

970 
	mV4L2_MPEG_AUDIO_L2_BITRATE_224K
 = 10,

971 
	mV4L2_MPEG_AUDIO_L2_BITRATE_256K
 = 11,

972 
	mV4L2_MPEG_AUDIO_L2_BITRATE_320K
 = 12,

973 
	mV4L2_MPEG_AUDIO_L2_BITRATE_384K
 = 13,

975 
	#V4L2_CID_MPEG_AUDIO_L3_BITRATE
 (
V4L2_CID_MPEG_BASE
+104)

	)

976 
	ev4l2_m³g_audio_l3_b™¿‹
 {

977 
	mV4L2_MPEG_AUDIO_L3_BITRATE_32K
 = 0,

978 
	mV4L2_MPEG_AUDIO_L3_BITRATE_40K
 = 1,

979 
	mV4L2_MPEG_AUDIO_L3_BITRATE_48K
 = 2,

980 
	mV4L2_MPEG_AUDIO_L3_BITRATE_56K
 = 3,

981 
	mV4L2_MPEG_AUDIO_L3_BITRATE_64K
 = 4,

982 
	mV4L2_MPEG_AUDIO_L3_BITRATE_80K
 = 5,

983 
	mV4L2_MPEG_AUDIO_L3_BITRATE_96K
 = 6,

984 
	mV4L2_MPEG_AUDIO_L3_BITRATE_112K
 = 7,

985 
	mV4L2_MPEG_AUDIO_L3_BITRATE_128K
 = 8,

986 
	mV4L2_MPEG_AUDIO_L3_BITRATE_160K
 = 9,

987 
	mV4L2_MPEG_AUDIO_L3_BITRATE_192K
 = 10,

988 
	mV4L2_MPEG_AUDIO_L3_BITRATE_224K
 = 11,

989 
	mV4L2_MPEG_AUDIO_L3_BITRATE_256K
 = 12,

990 
	mV4L2_MPEG_AUDIO_L3_BITRATE_320K
 = 13,

992 
	#V4L2_CID_MPEG_AUDIO_MODE
 (
V4L2_CID_MPEG_BASE
+105)

	)

993 
	ev4l2_m³g_audio_mode
 {

994 
	mV4L2_MPEG_AUDIO_MODE_STEREO
 = 0,

995 
	mV4L2_MPEG_AUDIO_MODE_JOINT_STEREO
 = 1,

996 
	mV4L2_MPEG_AUDIO_MODE_DUAL
 = 2,

997 
	mV4L2_MPEG_AUDIO_MODE_MONO
 = 3,

999 
	#V4L2_CID_MPEG_AUDIO_MODE_EXTENSION
 (
V4L2_CID_MPEG_BASE
+106)

	)

1000 
	ev4l2_m³g_audio_mode_ex‹nsiÚ
 {

1001 
	mV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_4
 = 0,

1002 
	mV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_8
 = 1,

1003 
	mV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_12
 = 2,

1004 
	mV4L2_MPEG_AUDIO_MODE_EXTENSION_BOUND_16
 = 3,

1006 
	#V4L2_CID_MPEG_AUDIO_EMPHASIS
 (
V4L2_CID_MPEG_BASE
+107)

	)

1007 
	ev4l2_m³g_audio_emphasis
 {

1008 
	mV4L2_MPEG_AUDIO_EMPHASIS_NONE
 = 0,

1009 
	mV4L2_MPEG_AUDIO_EMPHASIS_50_DIV_15_uS
 = 1,

1010 
	mV4L2_MPEG_AUDIO_EMPHASIS_CCITT_J17
 = 2,

1012 
	#V4L2_CID_MPEG_AUDIO_CRC
 (
V4L2_CID_MPEG_BASE
+108)

	)

1013 
	ev4l2_m³g_audio_üc
 {

1014 
	mV4L2_MPEG_AUDIO_CRC_NONE
 = 0,

1015 
	mV4L2_MPEG_AUDIO_CRC_CRC16
 = 1,

1017 
	#V4L2_CID_MPEG_AUDIO_MUTE
 (
V4L2_CID_MPEG_BASE
+109)

	)

1018 
	#V4L2_CID_MPEG_AUDIO_AAC_BITRATE
 (
V4L2_CID_MPEG_BASE
+110)

	)

1019 
	#V4L2_CID_MPEG_AUDIO_AC3_BITRATE
 (
V4L2_CID_MPEG_BASE
+111)

	)

1020 
	ev4l2_m³g_audio_ac3_b™¿‹
 {

1021 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_32K
 = 0,

1022 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_40K
 = 1,

1023 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_48K
 = 2,

1024 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_56K
 = 3,

1025 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_64K
 = 4,

1026 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_80K
 = 5,

1027 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_96K
 = 6,

1028 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_112K
 = 7,

1029 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_128K
 = 8,

1030 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_160K
 = 9,

1031 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_192K
 = 10,

1032 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_224K
 = 11,

1033 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_256K
 = 12,

1034 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_320K
 = 13,

1035 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_384K
 = 14,

1036 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_448K
 = 15,

1037 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_512K
 = 16,

1038 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_576K
 = 17,

1039 
	mV4L2_MPEG_AUDIO_AC3_BITRATE_640K
 = 18,

1043 
	#V4L2_CID_MPEG_VIDEO_ENCODING
 (
V4L2_CID_MPEG_BASE
+200)

	)

1044 
	ev4l2_m³g_video_’codšg
 {

1045 
	mV4L2_MPEG_VIDEO_ENCODING_MPEG_1
 = 0,

1046 
	mV4L2_MPEG_VIDEO_ENCODING_MPEG_2
 = 1,

1047 
	mV4L2_MPEG_VIDEO_ENCODING_MPEG_4_AVC
 = 2,

1049 
	#V4L2_CID_MPEG_VIDEO_ASPECT
 (
V4L2_CID_MPEG_BASE
+201)

	)

1050 
	ev4l2_m³g_video_a¥eù
 {

1051 
	mV4L2_MPEG_VIDEO_ASPECT_1x1
 = 0,

1052 
	mV4L2_MPEG_VIDEO_ASPECT_4x3
 = 1,

1053 
	mV4L2_MPEG_VIDEO_ASPECT_16x9
 = 2,

1054 
	mV4L2_MPEG_VIDEO_ASPECT_221x100
 = 3,

1056 
	#V4L2_CID_MPEG_VIDEO_B_FRAMES
 (
V4L2_CID_MPEG_BASE
+202)

	)

1057 
	#V4L2_CID_MPEG_VIDEO_GOP_SIZE
 (
V4L2_CID_MPEG_BASE
+203)

	)

1058 
	#V4L2_CID_MPEG_VIDEO_GOP_CLOSURE
 (
V4L2_CID_MPEG_BASE
+204)

	)

1059 
	#V4L2_CID_MPEG_VIDEO_PULLDOWN
 (
V4L2_CID_MPEG_BASE
+205)

	)

1060 
	#V4L2_CID_MPEG_VIDEO_BITRATE_MODE
 (
V4L2_CID_MPEG_BASE
+206)

	)

1061 
	ev4l2_m³g_video_b™¿‹_mode
 {

1062 
	mV4L2_MPEG_VIDEO_BITRATE_MODE_VBR
 = 0,

1063 
	mV4L2_MPEG_VIDEO_BITRATE_MODE_CBR
 = 1,

1065 
	#V4L2_CID_MPEG_VIDEO_BITRATE
 (
V4L2_CID_MPEG_BASE
+207)

	)

1066 
	#V4L2_CID_MPEG_VIDEO_BITRATE_PEAK
 (
V4L2_CID_MPEG_BASE
+208)

	)

1067 
	#V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION
 (
V4L2_CID_MPEG_BASE
+209)

	)

1068 
	#V4L2_CID_MPEG_VIDEO_MUTE
 (
V4L2_CID_MPEG_BASE
+210)

	)

1069 
	#V4L2_CID_MPEG_VIDEO_MUTE_YUV
 (
V4L2_CID_MPEG_BASE
+211)

	)

1072 
	#V4L2_CID_MPEG_CX2341X_BASE
 (
V4L2_CTRL_CLASS_MPEG
 | 0x1000)

	)

1073 
	#V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE
 (
V4L2_CID_MPEG_CX2341X_BASE
+0)

	)

1074 
	ev4l2_m³g_cx2341x_video_¥©Ÿl_f‹r_mode
 {

1075 
	mV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_MANUAL
 = 0,

1076 
	mV4L2_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE_AUTO
 = 1,

1078 
	#V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER
 (
V4L2_CID_MPEG_CX2341X_BASE
+1)

	)

1079 
	#V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE
 (
V4L2_CID_MPEG_CX2341X_BASE
+2)

	)

1080 
	ev4l2_m³g_cx2341x_video_luma_¥©Ÿl_f‹r_ty³
 {

1081 
	mV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_OFF
 = 0,

1082 
	mV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_1D_HOR
 = 1,

1083 
	mV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_1D_VERT
 = 2,

1084 
	mV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_HV_SEPARABLE
 = 3,

1085 
	mV4L2_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE_2D_SYM_NON_SEPARABLE
 = 4,

1087 
	#V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE
 (
V4L2_CID_MPEG_CX2341X_BASE
+3)

	)

1088 
	ev4l2_m³g_cx2341x_video_chroma_¥©Ÿl_f‹r_ty³
 {

1089 
	mV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_OFF
 = 0,

1090 
	mV4L2_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE_1D_HOR
 = 1,

1092 
	#V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE
 (
V4L2_CID_MPEG_CX2341X_BASE
+4)

	)

1093 
	ev4l2_m³g_cx2341x_video_‹mpÜ®_f‹r_mode
 {

1094 
	mV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_MANUAL
 = 0,

1095 
	mV4L2_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE_AUTO
 = 1,

1097 
	#V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER
 (
V4L2_CID_MPEG_CX2341X_BASE
+5)

	)

1098 
	#V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE
 (
V4L2_CID_MPEG_CX2341X_BASE
+6)

	)

1099 
	ev4l2_m³g_cx2341x_video_medŸn_f‹r_ty³
 {

1100 
	mV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_OFF
 = 0,

1101 
	mV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_HOR
 = 1,

1102 
	mV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_VERT
 = 2,

1103 
	mV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_HOR_VERT
 = 3,

1104 
	mV4L2_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE_DIAG
 = 4,

1106 
	#V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM
 (
V4L2_CID_MPEG_CX2341X_BASE
+7)

	)

1107 
	#V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP
 (
V4L2_CID_MPEG_CX2341X_BASE
+8)

	)

1108 
	#V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM
 (
V4L2_CID_MPEG_CX2341X_BASE
+9)

	)

1109 
	#V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP
 (
V4L2_CID_MPEG_CX2341X_BASE
+10)

	)

1110 
	#V4L2_CID_MPEG_CX2341X_STREAM_INSERT_NAV_PACKETS
 (
V4L2_CID_MPEG_CX2341X_BASE
+11)

	)

1113 
	#V4L2_CID_CAMERA_CLASS_BASE
 (
V4L2_CTRL_CLASS_CAMERA
 | 0x900)

	)

1114 
	#V4L2_CID_CAMERA_CLASS
 (
V4L2_CTRL_CLASS_CAMERA
 | 1)

	)

1116 
	#V4L2_CID_EXPOSURE_AUTO
 (
V4L2_CID_CAMERA_CLASS_BASE
+1)

	)

1117 
	ev4l2_exposu»_auto_ty³
 {

1118 
	mV4L2_EXPOSURE_AUTO
 = 0,

1119 
	mV4L2_EXPOSURE_MANUAL
 = 1,

1120 
	mV4L2_EXPOSURE_SHUTTER_PRIORITY
 = 2,

1121 
	mV4L2_EXPOSURE_APERTURE_PRIORITY
 = 3

1123 
	#V4L2_CID_EXPOSURE_ABSOLUTE
 (
V4L2_CID_CAMERA_CLASS_BASE
+2)

	)

1124 
	#V4L2_CID_EXPOSURE_AUTO_PRIORITY
 (
V4L2_CID_CAMERA_CLASS_BASE
+3)

	)

1126 
	#V4L2_CID_PAN_RELATIVE
 (
V4L2_CID_CAMERA_CLASS_BASE
+4)

	)

1127 
	#V4L2_CID_TILT_RELATIVE
 (
V4L2_CID_CAMERA_CLASS_BASE
+5)

	)

1128 
	#V4L2_CID_PAN_RESET
 (
V4L2_CID_CAMERA_CLASS_BASE
+6)

	)

1129 
	#V4L2_CID_TILT_RESET
 (
V4L2_CID_CAMERA_CLASS_BASE
+7)

	)

1131 
	#V4L2_CID_PAN_ABSOLUTE
 (
V4L2_CID_CAMERA_CLASS_BASE
+8)

	)

1132 
	#V4L2_CID_TILT_ABSOLUTE
 (
V4L2_CID_CAMERA_CLASS_BASE
+9)

	)

1134 
	#V4L2_CID_FOCUS_ABSOLUTE
 (
V4L2_CID_CAMERA_CLASS_BASE
+10)

	)

1135 
	#V4L2_CID_FOCUS_RELATIVE
 (
V4L2_CID_CAMERA_CLASS_BASE
+11)

	)

1136 
	#V4L2_CID_FOCUS_AUTO
 (
V4L2_CID_CAMERA_CLASS_BASE
+12)

	)

1138 
	#V4L2_CID_ZOOM_ABSOLUTE
 (
V4L2_CID_CAMERA_CLASS_BASE
+13)

	)

1139 
	#V4L2_CID_ZOOM_RELATIVE
 (
V4L2_CID_CAMERA_CLASS_BASE
+14)

	)

1140 
	#V4L2_CID_ZOOM_CONTINUOUS
 (
V4L2_CID_CAMERA_CLASS_BASE
+15)

	)

1142 
	#V4L2_CID_PRIVACY
 (
V4L2_CID_CAMERA_CLASS_BASE
+16)

	)

1147 
	sv4l2_tuÃr
 {

1148 
__u32
 
	mšdex
;

1149 
__u8
 
	mÇme
[32];

1150 
v4l2_tuÃr_ty³
 
	mty³
;

1151 
__u32
 
	mÿ·b™y
;

1152 
__u32
 
	m¿ng–ow
;

1153 
__u32
 
	m¿ngehigh
;

1154 
__u32
 
	mrxsubchªs
;

1155 
__u32
 
	maudmode
;

1156 
__s32
 
	msigÇl
;

1157 
__s32
 
	mafc
;

1158 
__u32
 
	m»£rved
[4];

1161 
	sv4l2_moduÏtÜ
 {

1162 
__u32
 
	mšdex
;

1163 
__u8
 
	mÇme
[32];

1164 
__u32
 
	mÿ·b™y
;

1165 
__u32
 
	m¿ng–ow
;

1166 
__u32
 
	m¿ngehigh
;

1167 
__u32
 
	mtxsubchªs
;

1168 
__u32
 
	m»£rved
[4];

1172 
	#V4L2_TUNER_CAP_LOW
 0x0001

	)

1173 
	#V4L2_TUNER_CAP_NORM
 0x0002

	)

1174 
	#V4L2_TUNER_CAP_STEREO
 0x0010

	)

1175 
	#V4L2_TUNER_CAP_LANG2
 0x0020

	)

1176 
	#V4L2_TUNER_CAP_SAP
 0x0020

	)

1177 
	#V4L2_TUNER_CAP_LANG1
 0x0040

	)

1180 
	#V4L2_TUNER_SUB_MONO
 0x0001

	)

1181 
	#V4L2_TUNER_SUB_STEREO
 0x0002

	)

1182 
	#V4L2_TUNER_SUB_LANG2
 0x0004

	)

1183 
	#V4L2_TUNER_SUB_SAP
 0x0004

	)

1184 
	#V4L2_TUNER_SUB_LANG1
 0x0008

	)

1187 
	#V4L2_TUNER_MODE_MONO
 0x0000

	)

1188 
	#V4L2_TUNER_MODE_STEREO
 0x0001

	)

1189 
	#V4L2_TUNER_MODE_LANG2
 0x0002

	)

1190 
	#V4L2_TUNER_MODE_SAP
 0x0002

	)

1191 
	#V4L2_TUNER_MODE_LANG1
 0x0003

	)

1192 
	#V4L2_TUNER_MODE_LANG1_LANG2
 0x0004

	)

1194 
	sv4l2_äequ’cy
 {

1195 
__u32
 
	mtuÃr
;

1196 
v4l2_tuÃr_ty³
 
	mty³
;

1197 
__u32
 
	mäequ’cy
;

1198 
__u32
 
	m»£rved
[8];

1201 
	sv4l2_hw_äeq_£ek
 {

1202 
__u32
 
	mtuÃr
;

1203 
v4l2_tuÃr_ty³
 
	mty³
;

1204 
__u32
 
	m£ek_upw¬d
;

1205 
__u32
 
	mw¿p_¬ound
;

1206 
__u32
 
	m»£rved
[8];

1212 
	sv4l2_audio
 {

1213 
__u32
 
	mšdex
;

1214 
__u8
 
	mÇme
[32];

1215 
__u32
 
	mÿ·b™y
;

1216 
__u32
 
	mmode
;

1217 
__u32
 
	m»£rved
[2];

1221 
	#V4L2_AUDCAP_STEREO
 0x00001

	)

1222 
	#V4L2_AUDCAP_AVL
 0x00002

	)

1225 
	#V4L2_AUDMODE_AVL
 0x00001

	)

1227 
	sv4l2_audioout
 {

1228 
__u32
 
	mšdex
;

1229 
__u8
 
	mÇme
[32];

1230 
__u32
 
	mÿ·b™y
;

1231 
__u32
 
	mmode
;

1232 
__u32
 
	m»£rved
[2];

1241 
	#V4L2_ENC_IDX_FRAME_I
 (0)

	)

1242 
	#V4L2_ENC_IDX_FRAME_P
 (1)

	)

1243 
	#V4L2_ENC_IDX_FRAME_B
 (2)

	)

1244 
	#V4L2_ENC_IDX_FRAME_MASK
 (0xf)

	)

1246 
	sv4l2_’c_idx_’Œy
 {

1247 
__u64
 
	moff£t
;

1248 
__u64
 
	m±s
;

1249 
__u32
 
	mËngth
;

1250 
__u32
 
	mæags
;

1251 
__u32
 
	m»£rved
[2];

1254 
	#V4L2_ENC_IDX_ENTRIES
 (64)

	)

1255 
	sv4l2_’c_idx
 {

1256 
__u32
 
	m’Œ›s
;

1257 
__u32
 
	m’Œ›s_ÿp
;

1258 
__u32
 
	m»£rved
[4];

1259 
v4l2_’c_idx_’Œy
 
	m’Œy
[
V4L2_ENC_IDX_ENTRIES
];

1263 
	#V4L2_ENC_CMD_START
 (0)

	)

1264 
	#V4L2_ENC_CMD_STOP
 (1)

	)

1265 
	#V4L2_ENC_CMD_PAUSE
 (2)

	)

1266 
	#V4L2_ENC_CMD_RESUME
 (3)

	)

1269 
	#V4L2_ENC_CMD_STOP_AT_GOP_END
 (1 << 0)

	)

1271 
	sv4l2_’cod”_cmd
 {

1272 
__u32
 
	mcmd
;

1273 
__u32
 
	mæags
;

1276 
__u32
 
	md©a
[8];

1277 } 
	m¿w
;

1291 
	sv4l2_vbi_fÜm©
 {

1292 
__u32
 
	m§m¶šg_¿‹
;

1293 
__u32
 
	moff£t
;

1294 
__u32
 
	m§m¶es_³r_lše
;

1295 
__u32
 
	m§m¶e_fÜm©
;

1296 
__s32
 
	m¡¬t
[2];

1297 
__u32
 
	mcouÁ
[2];

1298 
__u32
 
	mæags
;

1299 
__u32
 
	m»£rved
[2];

1303 
	#V4L2_VBI_UNSYNC
 (1 << 0)

	)

1304 
	#V4L2_VBI_INTERLACED
 (1 << 1)

	)

1313 
	sv4l2_¦iûd_vbi_fÜm©
 {

1314 
__u16
 
	m£rviû_£t
;

1319 
__u16
 
	m£rviû_lšes
[2][24];

1320 
__u32
 
	mio_size
;

1321 
__u32
 
	m»£rved
[2];

1326 
	#V4L2_SLICED_TELETEXT_B
 (0x0001)

	)

1328 
	#V4L2_SLICED_VPS
 (0x0400)

	)

1330 
	#V4L2_SLICED_CAPTION_525
 (0x1000)

	)

1332 
	#V4L2_SLICED_WSS_625
 (0x4000)

	)

1334 
	#V4L2_SLICED_VBI_525
 (
V4L2_SLICED_CAPTION_525
)

	)

1335 
	#V4L2_SLICED_VBI_625
 (
V4L2_SLICED_TELETEXT_B
 | 
V4L2_SLICED_VPS
 | 
V4L2_SLICED_WSS_625
)

	)

1337 
	sv4l2_¦iûd_vbi_ÿp
 {

1338 
__u16
 
	m£rviû_£t
;

1343 
__u16
 
	m£rviû_lšes
[2][24];

1344 
v4l2_buf_ty³
 
	mty³
;

1345 
__u32
 
	m»£rved
[3];

1348 
	sv4l2_¦iûd_vbi_d©a
 {

1349 
__u32
 
	mid
;

1350 
__u32
 
	mf›ld
;

1351 
__u32
 
	mlše
;

1352 
__u32
 
	m»£rved
;

1353 
__u8
 
	md©a
[48];

1373 
	#V4L2_MPEG_VBI_IVTV_TELETEXT_B
 (1)

	)

1374 
	#V4L2_MPEG_VBI_IVTV_CAPTION_525
 (4)

	)

1375 
	#V4L2_MPEG_VBI_IVTV_WSS_625
 (5)

	)

1376 
	#V4L2_MPEG_VBI_IVTV_VPS
 (7)

	)

1378 
	sv4l2_m³g_vbi_™v0_lše
 {

1379 
__u8
 
	mid
;

1380 
__u8
 
	md©a
[42];

1381 } 
__©Œibu‹__
 ((
·cked
));

1383 
	sv4l2_m³g_vbi_™v0
 {

1384 
__Ë32
 
	mlšemask
[2];

1385 
v4l2_m³g_vbi_™v0_lše
 
	mlše
[35];

1386 } 
__©Œibu‹__
 ((
·cked
));

1388 
	sv4l2_m³g_vbi_ITV0
 {

1389 
v4l2_m³g_vbi_™v0_lše
 
	mlše
[36];

1390 } 
__©Œibu‹__
 ((
·cked
));

1392 
	#V4L2_MPEG_VBI_IVTV_MAGIC0
 "™v0"

	)

1393 
	#V4L2_MPEG_VBI_IVTV_MAGIC1
 "ITV0"

	)

1395 
	sv4l2_m³g_vbi_fmt_ivtv
 {

1396 
__u8
 
	mmagic
[4];

1398 
v4l2_m³g_vbi_™v0
 
	m™v0
;

1399 
v4l2_m³g_vbi_ITV0
 
	mITV0
;

1401 } 
__©Œibu‹__
 ((
·cked
));

1409 
	sv4l2_fÜm©
 {

1410 
v4l2_buf_ty³
 
	mty³
;

1412 
v4l2_pix_fÜm©
 
	mpix
;

1413 
v4l2_wšdow
 
	mwš
;

1414 
v4l2_vbi_fÜm©
 
	mvbi
;

1415 
v4l2_¦iûd_vbi_fÜm©
 
	m¦iûd
;

1416 
__u8
 
	m¿w_d©a
[200];

1417 } 
	mfmt
;

1423 
	sv4l2_¡»am·rm
 {

1424 
v4l2_buf_ty³
 
	mty³
;

1426 
v4l2_ÿ±u»·rm
 
	mÿ±u»
;

1427 
v4l2_ouu¬m
 
	mouut
;

1428 
__u8
 
	m¿w_d©a
[200];

1429 } 
	m·rm
;

1441 
	#V4L2_CHIP_MATCH_HOST
 0

	)

1442 
	#V4L2_CHIP_MATCH_I2C_DRIVER
 1

	)

1443 
	#V4L2_CHIP_MATCH_I2C_ADDR
 2

	)

1444 
	#V4L2_CHIP_MATCH_AC97
 3

	)

1446 
	sv4l2_dbg_m©ch
 {

1447 
__u32
 
	mty³
;

1449 
__u32
 
	maddr
;

1450 
	mÇme
[32];

1452 } 
__©Œibu‹__
 ((
·cked
));

1454 
	sv4l2_dbg_»gi¡”
 {

1455 
v4l2_dbg_m©ch
 
	mm©ch
;

1456 
__u32
 
	msize
;

1457 
__u64
 
	m»g
;

1458 
__u64
 
	mv®
;

1459 } 
__©Œibu‹__
 ((
·cked
));

1462 
	sv4l2_dbg_ch_id’t
 {

1463 
v4l2_dbg_m©ch
 
	mm©ch
;

1464 
__u32
 
	mid’t
;

1465 
__u32
 
	m»visiÚ
;

1466 } 
__©Œibu‹__
 ((
·cked
));

1472 
	#VIDIOC_QUERYCAP
 
	`_IOR
('V', 0, 
v4l2_ÿ·b™y
)

	)

1473 
	#VIDIOC_RESERVED
 
	`_IO
('V', 1)

	)

1474 
	#VIDIOC_ENUM_FMT
 
	`_IOWR
('V', 2, 
v4l2_fmtdesc
)

	)

1475 
	#VIDIOC_G_FMT
 
	`_IOWR
('V', 4, 
v4l2_fÜm©
)

	)

1476 
	#VIDIOC_S_FMT
 
	`_IOWR
('V', 5, 
v4l2_fÜm©
)

	)

1477 
	#VIDIOC_REQBUFS
 
	`_IOWR
('V', 8, 
v4l2_»que¡bufãrs
)

	)

1478 
	#VIDIOC_QUERYBUF
 
	`_IOWR
('V', 9, 
v4l2_bufãr
)

	)

1479 
	#VIDIOC_G_FBUF
 
	`_IOR
('V', 10, 
v4l2_äamebufãr
)

	)

1480 
	#VIDIOC_S_FBUF
 
	`_IOW
('V', 11, 
v4l2_äamebufãr
)

	)

1481 
	#VIDIOC_OVERLAY
 
	`_IOW
('V', 14, )

	)

1482 
	#VIDIOC_QBUF
 
	`_IOWR
('V', 15, 
v4l2_bufãr
)

	)

1483 
	#VIDIOC_DQBUF
 
	`_IOWR
('V', 17, 
v4l2_bufãr
)

	)

1484 
	#VIDIOC_STREAMON
 
	`_IOW
('V', 18, )

	)

1485 
	#VIDIOC_STREAMOFF
 
	`_IOW
('V', 19, )

	)

1486 
	#VIDIOC_G_PARM
 
	`_IOWR
('V', 21, 
v4l2_¡»am·rm
)

	)

1487 
	#VIDIOC_S_PARM
 
	`_IOWR
('V', 22, 
v4l2_¡»am·rm
)

	)

1488 
	#VIDIOC_G_STD
 
	`_IOR
('V', 23, 
v4l2_¡d_id
)

	)

1489 
	#VIDIOC_S_STD
 
	`_IOW
('V', 24, 
v4l2_¡d_id
)

	)

1490 
	#VIDIOC_ENUMSTD
 
	`_IOWR
('V', 25, 
v4l2_¡ªd¬d
)

	)

1491 
	#VIDIOC_ENUMINPUT
 
	`_IOWR
('V', 26, 
v4l2_šput
)

	)

1492 
	#VIDIOC_G_CTRL
 
	`_IOWR
('V', 27, 
v4l2_cÚŒŞ
)

	)

1493 
	#VIDIOC_S_CTRL
 
	`_IOWR
('V', 28, 
v4l2_cÚŒŞ
)

	)

1494 
	#VIDIOC_G_TUNER
 
	`_IOWR
('V', 29, 
v4l2_tuÃr
)

	)

1495 
	#VIDIOC_S_TUNER
 
	`_IOW
('V', 30, 
v4l2_tuÃr
)

	)

1496 
	#VIDIOC_G_AUDIO
 
	`_IOR
('V', 33, 
v4l2_audio
)

	)

1497 
	#VIDIOC_S_AUDIO
 
	`_IOW
('V', 34, 
v4l2_audio
)

	)

1498 
	#VIDIOC_QUERYCTRL
 
	`_IOWR
('V', 36, 
v4l2_qu”yù¾
)

	)

1499 
	#VIDIOC_QUERYMENU
 
	`_IOWR
('V', 37, 
v4l2_qu”ym’u
)

	)

1500 
	#VIDIOC_G_INPUT
 
	`_IOR
('V', 38, )

	)

1501 
	#VIDIOC_S_INPUT
 
	`_IOWR
('V', 39, )

	)

1502 
	#VIDIOC_G_OUTPUT
 
	`_IOR
('V', 46, )

	)

1503 
	#VIDIOC_S_OUTPUT
 
	`_IOWR
('V', 47, )

	)

1504 
	#VIDIOC_ENUMOUTPUT
 
	`_IOWR
('V', 48, 
v4l2_ouut
)

	)

1505 
	#VIDIOC_G_AUDOUT
 
	`_IOR
('V', 49, 
v4l2_audioout
)

	)

1506 
	#VIDIOC_S_AUDOUT
 
	`_IOW
('V', 50, 
v4l2_audioout
)

	)

1507 
	#VIDIOC_G_MODULATOR
 
	`_IOWR
('V', 54, 
v4l2_moduÏtÜ
)

	)

1508 
	#VIDIOC_S_MODULATOR
 
	`_IOW
('V', 55, 
v4l2_moduÏtÜ
)

	)

1509 
	#VIDIOC_G_FREQUENCY
 
	`_IOWR
('V', 56, 
v4l2_äequ’cy
)

	)

1510 
	#VIDIOC_S_FREQUENCY
 
	`_IOW
('V', 57, 
v4l2_äequ’cy
)

	)

1511 
	#VIDIOC_CROPCAP
 
	`_IOWR
('V', 58, 
v4l2_üİÿp
)

	)

1512 
	#VIDIOC_G_CROP
 
	`_IOWR
('V', 59, 
v4l2_üİ
)

	)

1513 
	#VIDIOC_S_CROP
 
	`_IOW
('V', 60, 
v4l2_üİ
)

	)

1514 
	#VIDIOC_G_JPEGCOMP
 
	`_IOR
('V', 61, 
v4l2_j³gcom´essiÚ
)

	)

1515 
	#VIDIOC_S_JPEGCOMP
 
	`_IOW
('V', 62, 
v4l2_j³gcom´essiÚ
)

	)

1516 
	#VIDIOC_QUERYSTD
 
	`_IOR
('V', 63, 
v4l2_¡d_id
)

	)

1517 
	#VIDIOC_TRY_FMT
 
	`_IOWR
('V', 64, 
v4l2_fÜm©
)

	)

1518 
	#VIDIOC_ENUMAUDIO
 
	`_IOWR
('V', 65, 
v4l2_audio
)

	)

1519 
	#VIDIOC_ENUMAUDOUT
 
	`_IOWR
('V', 66, 
v4l2_audioout
)

	)

1520 
	#VIDIOC_G_PRIORITY
 
	`_IOR
('V', 67, 
v4l2_´iÜ™y
)

	)

1521 
	#VIDIOC_S_PRIORITY
 
	`_IOW
('V', 68, 
v4l2_´iÜ™y
)

	)

1522 
	#VIDIOC_G_SLICED_VBI_CAP
 
	`_IOWR
('V', 69, 
v4l2_¦iûd_vbi_ÿp
)

	)

1523 
	#VIDIOC_LOG_STATUS
 
	`_IO
('V', 70)

	)

1524 
	#VIDIOC_G_EXT_CTRLS
 
	`_IOWR
('V', 71, 
v4l2_ext_cÚŒŞs
)

	)

1525 
	#VIDIOC_S_EXT_CTRLS
 
	`_IOWR
('V', 72, 
v4l2_ext_cÚŒŞs
)

	)

1526 
	#VIDIOC_TRY_EXT_CTRLS
 
	`_IOWR
('V', 73, 
v4l2_ext_cÚŒŞs
)

	)

1528 
	#VIDIOC_ENUM_FRAMESIZES
 
	`_IOWR
('V', 74, 
v4l2_ämsiz“num
)

	)

1529 
	#VIDIOC_ENUM_FRAMEINTERVALS
 
	`_IOWR
('V', 75, 
v4l2_ämiv®’um
)

	)

1530 
	#VIDIOC_G_ENC_INDEX
 
	`_IOR
('V', 76, 
v4l2_’c_idx
)

	)

1531 
	#VIDIOC_ENCODER_CMD
 
	`_IOWR
('V', 77, 
v4l2_’cod”_cmd
)

	)

1532 
	#VIDIOC_TRY_ENCODER_CMD
 
	`_IOWR
('V', 78, 
v4l2_’cod”_cmd
)

	)

1539 
	#VIDIOC_DBG_S_REGISTER
 
	`_IOW
('V', 79, 
v4l2_dbg_»gi¡”
)

	)

1540 
	#VIDIOC_DBG_G_REGISTER
 
	`_IOWR
('V', 80, 
v4l2_dbg_»gi¡”
)

	)

1544 
	#VIDIOC_DBG_G_CHIP_IDENT
 
	`_IOWR
('V', 81, 
v4l2_dbg_ch_id’t
)

	)

1547 
	#VIDIOC_S_HW_FREQ_SEEK
 
	`_IOW
('V', 82, 
v4l2_hw_äeq_£ek
)

	)

1551 #ifdeà
__OLD_VIDIOC_


1553 
	#VIDIOC_OVERLAY_OLD
 
	`_IOWR
('V', 14, )

	)

1554 
	#VIDIOC_S_PARM_OLD
 
	`_IOW
('V', 22, 
v4l2_¡»am·rm
)

	)

1555 
	#VIDIOC_S_CTRL_OLD
 
	`_IOW
('V', 28, 
v4l2_cÚŒŞ
)

	)

1556 
	#VIDIOC_G_AUDIO_OLD
 
	`_IOWR
('V', 33, 
v4l2_audio
)

	)

1557 
	#VIDIOC_G_AUDOUT_OLD
 
	`_IOWR
('V', 49, 
v4l2_audioout
)

	)

1558 
	#VIDIOC_CROPCAP_OLD
 
	`_IOR
('V', 58, 
v4l2_üİÿp
)

	)

1561 
	#BASE_VIDIOC_PRIVATE
 192

	)

	@/usr/include/linux/wait.h

1 #iâdeà
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

6 
	#WSTOPPED
 
WUNTRACED


	)

7 
	#WEXITED
 0x00000004

	)

8 
	#WCONTINUED
 0x00000008

	)

9 
	#WNOWAIT
 0x01000000

	)

11 
	#__WNOTHREAD
 0x20000000

	)

12 
	#__WALL
 0x40000000

	)

13 
	#__WCLONE
 0x80000000

	)

16 
	#P_ALL
 0

	)

17 
	#P_PID
 1

	)

18 
	#P_PGID
 2

	)

	@/usr/include/asm-generic/int-ll64.h

8 #iâdeà
_ASM_GENERIC_INT_LL64_H


9 
	#_ASM_GENERIC_INT_LL64_H


	)

11 
	~<asm/b™¥”lÚg.h
>

13 #iâdeà
__ASSEMBLY__


19 
__sigÃd__
 
	t__s8
;

20 
	t__u8
;

22 
__sigÃd__
 
	t__s16
;

23 
	t__u16
;

25 
__sigÃd__
 
	t__s32
;

26 
	t__u32
;

28 #ifdeà
__GNUC__


29 
__ex‹nsiÚ__
 
__sigÃd__
 
	t__s64
;

30 
__ex‹nsiÚ__
 
	t__u64
;

32 
__sigÃd__
 
	t__s64
;

33 
	t__u64
;

	@/usr/include/asm/errno.h

1 
	~<asm-g’”ic/”ºo.h
>

	@/usr/include/asm/fcntl.h

1 
	~<asm-g’”ic/fú.h
>

	@/usr/include/asm/ioctl.h

1 
	~<asm-g’”ic/ioùl.h
>

	@/usr/include/asm/poll.h

1 
	~<asm-g’”ic/pŞl.h
>

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/pci_regs.h

22 #iâdeà
LINUX_PCI_REGS_H


23 
	#LINUX_PCI_REGS_H


	)

29 
	#PCI_VENDOR_ID
 0x00

	)

30 
	#PCI_DEVICE_ID
 0x02

	)

31 
	#PCI_COMMAND
 0x04

	)

32 
	#PCI_COMMAND_IO
 0x1

	)

33 
	#PCI_COMMAND_MEMORY
 0x2

	)

34 
	#PCI_COMMAND_MASTER
 0x4

	)

35 
	#PCI_COMMAND_SPECIAL
 0x8

	)

36 
	#PCI_COMMAND_INVALIDATE
 0x10

	)

37 
	#PCI_COMMAND_VGA_PALETTE
 0x20

	)

38 
	#PCI_COMMAND_PARITY
 0x40

	)

39 
	#PCI_COMMAND_WAIT
 0x80

	)

40 
	#PCI_COMMAND_SERR
 0x100

	)

41 
	#PCI_COMMAND_FAST_BACK
 0x200

	)

42 
	#PCI_COMMAND_INTX_DISABLE
 0x400

	)

44 
	#PCI_STATUS
 0x06

	)

45 
	#PCI_STATUS_CAP_LIST
 0x10

	)

46 
	#PCI_STATUS_66MHZ
 0x20

	)

47 
	#PCI_STATUS_UDF
 0x40

	)

48 
	#PCI_STATUS_FAST_BACK
 0x80

	)

49 
	#PCI_STATUS_PARITY
 0x100

	)

50 
	#PCI_STATUS_DEVSEL_MASK
 0x600

	)

51 
	#PCI_STATUS_DEVSEL_FAST
 0x000

	)

52 
	#PCI_STATUS_DEVSEL_MEDIUM
 0x200

	)

53 
	#PCI_STATUS_DEVSEL_SLOW
 0x400

	)

54 
	#PCI_STATUS_SIG_TARGET_ABORT
 0x800

	)

55 
	#PCI_STATUS_REC_TARGET_ABORT
 0x1000

	)

56 
	#PCI_STATUS_REC_MASTER_ABORT
 0x2000

	)

57 
	#PCI_STATUS_SIG_SYSTEM_ERROR
 0x4000

	)

58 
	#PCI_STATUS_DETECTED_PARITY
 0x8000

	)

60 
	#PCI_CLASS_REVISION
 0x08

	)

61 
	#PCI_REVISION_ID
 0x08

	)

62 
	#PCI_CLASS_PROG
 0x09

	)

63 
	#PCI_CLASS_DEVICE
 0x0¨

	)

65 
	#PCI_CACHE_LINE_SIZE
 0x0ø

	)

66 
	#PCI_LATENCY_TIMER
 0x0d

	)

67 
	#PCI_HEADER_TYPE
 0x0

	)

68 
	#PCI_HEADER_TYPE_NORMAL
 0

	)

69 
	#PCI_HEADER_TYPE_BRIDGE
 1

	)

70 
	#PCI_HEADER_TYPE_CARDBUS
 2

	)

72 
	#PCI_BIST
 0x0à

	)

73 
	#PCI_BIST_CODE_MASK
 0x0à

	)

74 
	#PCI_BIST_START
 0x40

	)

75 
	#PCI_BIST_CAPABLE
 0x80

	)

83 
	#PCI_BASE_ADDRESS_0
 0x10

	)

84 
	#PCI_BASE_ADDRESS_1
 0x14

	)

85 
	#PCI_BASE_ADDRESS_2
 0x18

	)

86 
	#PCI_BASE_ADDRESS_3
 0x1ø

	)

87 
	#PCI_BASE_ADDRESS_4
 0x20

	)

88 
	#PCI_BASE_ADDRESS_5
 0x24

	)

89 
	#PCI_BASE_ADDRESS_SPACE
 0x01

	)

90 
	#PCI_BASE_ADDRESS_SPACE_IO
 0x01

	)

91 
	#PCI_BASE_ADDRESS_SPACE_MEMORY
 0x00

	)

92 
	#PCI_BASE_ADDRESS_MEM_TYPE_MASK
 0x06

	)

93 
	#PCI_BASE_ADDRESS_MEM_TYPE_32
 0x00

	)

94 
	#PCI_BASE_ADDRESS_MEM_TYPE_1M
 0x02

	)

95 
	#PCI_BASE_ADDRESS_MEM_TYPE_64
 0x04

	)

96 
	#PCI_BASE_ADDRESS_MEM_PREFETCH
 0x08

	)

97 
	#PCI_BASE_ADDRESS_MEM_MASK
 (~0x0fUL)

	)

98 
	#PCI_BASE_ADDRESS_IO_MASK
 (~0x03UL)

	)

102 
	#PCI_CARDBUS_CIS
 0x28

	)

103 
	#PCI_SUBSYSTEM_VENDOR_ID
 0x2c

	)

104 
	#PCI_SUBSYSTEM_ID
 0x2e

	)

105 
	#PCI_ROM_ADDRESS
 0x30

	)

106 
	#PCI_ROM_ADDRESS_ENABLE
 0x01

	)

107 
	#PCI_ROM_ADDRESS_MASK
 (~0x7ffUL)

	)

109 
	#PCI_CAPABILITY_LIST
 0x34

	)

112 
	#PCI_INTERRUPT_LINE
 0x3ø

	)

113 
	#PCI_INTERRUPT_PIN
 0x3d

	)

114 
	#PCI_MIN_GNT
 0x3

	)

115 
	#PCI_MAX_LAT
 0x3à

	)

118 
	#PCI_PRIMARY_BUS
 0x18

	)

119 
	#PCI_SECONDARY_BUS
 0x19

	)

120 
	#PCI_SUBORDINATE_BUS
 0x1¨

	)

121 
	#PCI_SEC_LATENCY_TIMER
 0x1b

	)

122 
	#PCI_IO_BASE
 0x1ø

	)

123 
	#PCI_IO_LIMIT
 0x1d

	)

124 
	#PCI_IO_RANGE_TYPE_MASK
 0x0fUL

	)

125 
	#PCI_IO_RANGE_TYPE_16
 0x00

	)

126 
	#PCI_IO_RANGE_TYPE_32
 0x01

	)

127 
	#PCI_IO_RANGE_MASK
 (~0x0fUL)

	)

128 
	#PCI_SEC_STATUS
 0x1

	)

129 
	#PCI_MEMORY_BASE
 0x20

	)

130 
	#PCI_MEMORY_LIMIT
 0x22

	)

131 
	#PCI_MEMORY_RANGE_TYPE_MASK
 0x0fUL

	)

132 
	#PCI_MEMORY_RANGE_MASK
 (~0x0fUL)

	)

133 
	#PCI_PREF_MEMORY_BASE
 0x24

	)

134 
	#PCI_PREF_MEMORY_LIMIT
 0x26

	)

135 
	#PCI_PREF_RANGE_TYPE_MASK
 0x0fUL

	)

136 
	#PCI_PREF_RANGE_TYPE_32
 0x00

	)

137 
	#PCI_PREF_RANGE_TYPE_64
 0x01

	)

138 
	#PCI_PREF_RANGE_MASK
 (~0x0fUL)

	)

139 
	#PCI_PREF_BASE_UPPER32
 0x28

	)

140 
	#PCI_PREF_LIMIT_UPPER32
 0x2c

	)

141 
	#PCI_IO_BASE_UPPER16
 0x30

	)

142 
	#PCI_IO_LIMIT_UPPER16
 0x32

	)

145 
	#PCI_ROM_ADDRESS1
 0x38

	)

147 
	#PCI_BRIDGE_CONTROL
 0x3e

	)

148 
	#PCI_BRIDGE_CTL_PARITY
 0x01

	)

149 
	#PCI_BRIDGE_CTL_SERR
 0x02

	)

150 
	#PCI_BRIDGE_CTL_ISA
 0x04

	)

151 
	#PCI_BRIDGE_CTL_VGA
 0x08

	)

152 
	#PCI_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

153 
	#PCI_BRIDGE_CTL_BUS_RESET
 0x40

	)

154 
	#PCI_BRIDGE_CTL_FAST_BACK
 0x80

	)

157 
	#PCI_CB_CAPABILITY_LIST
 0x14

	)

159 
	#PCI_CB_SEC_STATUS
 0x16

	)

160 
	#PCI_CB_PRIMARY_BUS
 0x18

	)

161 
	#PCI_CB_CARD_BUS
 0x19

	)

162 
	#PCI_CB_SUBORDINATE_BUS
 0x1¨

	)

163 
	#PCI_CB_LATENCY_TIMER
 0x1b

	)

164 
	#PCI_CB_MEMORY_BASE_0
 0x1c

	)

165 
	#PCI_CB_MEMORY_LIMIT_0
 0x20

	)

166 
	#PCI_CB_MEMORY_BASE_1
 0x24

	)

167 
	#PCI_CB_MEMORY_LIMIT_1
 0x28

	)

168 
	#PCI_CB_IO_BASE_0
 0x2c

	)

169 
	#PCI_CB_IO_BASE_0_HI
 0x2e

	)

170 
	#PCI_CB_IO_LIMIT_0
 0x30

	)

171 
	#PCI_CB_IO_LIMIT_0_HI
 0x32

	)

172 
	#PCI_CB_IO_BASE_1
 0x34

	)

173 
	#PCI_CB_IO_BASE_1_HI
 0x36

	)

174 
	#PCI_CB_IO_LIMIT_1
 0x38

	)

175 
	#PCI_CB_IO_LIMIT_1_HI
 0x3a

	)

176 
	#PCI_CB_IO_RANGE_MASK
 (~0x03UL)

	)

178 
	#PCI_CB_BRIDGE_CONTROL
 0x3e

	)

179 
	#PCI_CB_BRIDGE_CTL_PARITY
 0x01

	)

180 
	#PCI_CB_BRIDGE_CTL_SERR
 0x02

	)

181 
	#PCI_CB_BRIDGE_CTL_ISA
 0x04

	)

182 
	#PCI_CB_BRIDGE_CTL_VGA
 0x08

	)

183 
	#PCI_CB_BRIDGE_CTL_MASTER_ABORT
 0x20

	)

184 
	#PCI_CB_BRIDGE_CTL_CB_RESET
 0x40

	)

185 
	#PCI_CB_BRIDGE_CTL_16BIT_INT
 0x80

	)

186 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM0
 0x100

	)

187 
	#PCI_CB_BRIDGE_CTL_PREFETCH_MEM1
 0x200

	)

188 
	#PCI_CB_BRIDGE_CTL_POST_WRITES
 0x400

	)

189 
	#PCI_CB_SUBSYSTEM_VENDOR_ID
 0x40

	)

190 
	#PCI_CB_SUBSYSTEM_ID
 0x42

	)

191 
	#PCI_CB_LEGACY_MODE_BASE
 0x44

	)

196 
	#PCI_CAP_LIST_ID
 0

	)

197 
	#PCI_CAP_ID_PM
 0x01

	)

198 
	#PCI_CAP_ID_AGP
 0x02

	)

199 
	#PCI_CAP_ID_VPD
 0x03

	)

200 
	#PCI_CAP_ID_SLOTID
 0x04

	)

201 
	#PCI_CAP_ID_MSI
 0x05

	)

202 
	#PCI_CAP_ID_CHSWP
 0x06

	)

203 
	#PCI_CAP_ID_PCIX
 0x07

	)

204 
	#PCI_CAP_ID_HT
 0x08

	)

205 
	#PCI_CAP_ID_VNDR
 0x09

	)

206 
	#PCI_CAP_ID_DBG
 0x0A

	)

207 
	#PCI_CAP_ID_CCRC
 0x0B

	)

208 
	#PCI_CAP_ID_SHPC
 0x0C

	)

209 
	#PCI_CAP_ID_SSVID
 0x0D

	)

210 
	#PCI_CAP_ID_AGP3
 0x0E

	)

211 
	#PCI_CAP_ID_EXP
 0x10

	)

212 
	#PCI_CAP_ID_MSIX
 0x11

	)

213 
	#PCI_CAP_ID_AF
 0x13

	)

214 
	#PCI_CAP_LIST_NEXT
 1

	)

215 
	#PCI_CAP_FLAGS
 2

	)

216 
	#PCI_CAP_SIZEOF
 4

	)

220 
	#PCI_PM_PMC
 2

	)

221 
	#PCI_PM_CAP_VER_MASK
 0x0007

	)

222 
	#PCI_PM_CAP_PME_CLOCK
 0x0008

	)

223 
	#PCI_PM_CAP_RESERVED
 0x0010

	)

224 
	#PCI_PM_CAP_DSI
 0x0020

	)

225 
	#PCI_PM_CAP_AUX_POWER
 0x01C0

	)

226 
	#PCI_PM_CAP_D1
 0x0200

	)

227 
	#PCI_PM_CAP_D2
 0x0400

	)

228 
	#PCI_PM_CAP_PME
 0x0800

	)

229 
	#PCI_PM_CAP_PME_MASK
 0xF800

	)

230 
	#PCI_PM_CAP_PME_D0
 0x0800

	)

231 
	#PCI_PM_CAP_PME_D1
 0x1000

	)

232 
	#PCI_PM_CAP_PME_D2
 0x2000

	)

233 
	#PCI_PM_CAP_PME_D3
 0x4000

	)

234 
	#PCI_PM_CAP_PME_D3cŞd
 0x8000

	)

235 
	#PCI_PM_CAP_PME_SHIFT
 11

	)

236 
	#PCI_PM_CTRL
 4

	)

237 
	#PCI_PM_CTRL_STATE_MASK
 0x0003

	)

238 
	#PCI_PM_CTRL_NO_SOFT_RESET
 0x0008

	)

239 
	#PCI_PM_CTRL_PME_ENABLE
 0x0100

	)

240 
	#PCI_PM_CTRL_DATA_SEL_MASK
 0x1e00

	)

241 
	#PCI_PM_CTRL_DATA_SCALE_MASK
 0x6000

	)

242 
	#PCI_PM_CTRL_PME_STATUS
 0x8000

	)

243 
	#PCI_PM_PPB_EXTENSIONS
 6

	)

244 
	#PCI_PM_PPB_B2_B3
 0x40

	)

245 
	#PCI_PM_BPCC_ENABLE
 0x80

	)

246 
	#PCI_PM_DATA_REGISTER
 7

	)

247 
	#PCI_PM_SIZEOF
 8

	)

251 
	#PCI_AGP_VERSION
 2

	)

252 
	#PCI_AGP_RFU
 3

	)

253 
	#PCI_AGP_STATUS
 4

	)

254 
	#PCI_AGP_STATUS_RQ_MASK
 0xff000000

	)

255 
	#PCI_AGP_STATUS_SBA
 0x0200

	)

256 
	#PCI_AGP_STATUS_64BIT
 0x0020

	)

257 
	#PCI_AGP_STATUS_FW
 0x0010

	)

258 
	#PCI_AGP_STATUS_RATE4
 0x0004

	)

259 
	#PCI_AGP_STATUS_RATE2
 0x0002

	)

260 
	#PCI_AGP_STATUS_RATE1
 0x0001

	)

261 
	#PCI_AGP_COMMAND
 8

	)

262 
	#PCI_AGP_COMMAND_RQ_MASK
 0xff000000

	)

263 
	#PCI_AGP_COMMAND_SBA
 0x0200

	)

264 
	#PCI_AGP_COMMAND_AGP
 0x0100

	)

265 
	#PCI_AGP_COMMAND_64BIT
 0x0020

	)

266 
	#PCI_AGP_COMMAND_FW
 0x0010

	)

267 
	#PCI_AGP_COMMAND_RATE4
 0x0004

	)

268 
	#PCI_AGP_COMMAND_RATE2
 0x0002

	)

269 
	#PCI_AGP_COMMAND_RATE1
 0x0001

	)

270 
	#PCI_AGP_SIZEOF
 12

	)

274 
	#PCI_VPD_ADDR
 2

	)

275 
	#PCI_VPD_ADDR_MASK
 0x7ffà

	)

276 
	#PCI_VPD_ADDR_F
 0x8000

	)

277 
	#PCI_VPD_DATA
 4

	)

281 
	#PCI_SID_ESR
 2

	)

282 
	#PCI_SID_ESR_NSLOTS
 0x1à

	)

283 
	#PCI_SID_ESR_FIC
 0x20

	)

284 
	#PCI_SID_CHASSIS_NR
 3

	)

288 
	#PCI_MSI_FLAGS
 2

	)

289 
	#PCI_MSI_FLAGS_64BIT
 0x80

	)

290 
	#PCI_MSI_FLAGS_QSIZE
 0x70

	)

291 
	#PCI_MSI_FLAGS_QMASK
 0x0

	)

292 
	#PCI_MSI_FLAGS_ENABLE
 0x01

	)

293 
	#PCI_MSI_FLAGS_MASKBIT
 0x100

	)

294 
	#PCI_MSI_RFU
 3

	)

295 
	#PCI_MSI_ADDRESS_LO
 4

	)

296 
	#PCI_MSI_ADDRESS_HI
 8

	)

297 
	#PCI_MSI_DATA_32
 8

	)

298 
	#PCI_MSI_MASK_32
 12

	)

299 
	#PCI_MSI_DATA_64
 12

	)

300 
	#PCI_MSI_MASK_64
 16

	)

303 
	#PCI_MSIX_FLAGS
 2

	)

304 
	#PCI_MSIX_FLAGS_QSIZE
 0x7FF

	)

305 
	#PCI_MSIX_FLAGS_ENABLE
 (1 << 15)

	)

306 
	#PCI_MSIX_FLAGS_MASKALL
 (1 << 14)

	)

307 
	#PCI_MSIX_FLAGS_BIRMASK
 (7 << 0)

	)

311 
	#PCI_CHSWP_CSR
 2

	)

312 
	#PCI_CHSWP_DHA
 0x01

	)

313 
	#PCI_CHSWP_EIM
 0x02

	)

314 
	#PCI_CHSWP_PIE
 0x04

	)

315 
	#PCI_CHSWP_LOO
 0x08

	)

316 
	#PCI_CHSWP_PI
 0x30

	)

317 
	#PCI_CHSWP_EXT
 0x40

	)

318 
	#PCI_CHSWP_INS
 0x80

	)

322 
	#PCI_AF_LENGTH
 2

	)

323 
	#PCI_AF_CAP
 3

	)

324 
	#PCI_AF_CAP_TP
 0x01

	)

325 
	#PCI_AF_CAP_FLR
 0x02

	)

326 
	#PCI_AF_CTRL
 4

	)

327 
	#PCI_AF_CTRL_FLR
 0x01

	)

328 
	#PCI_AF_STATUS
 5

	)

329 
	#PCI_AF_STATUS_TP
 0x01

	)

333 
	#PCI_X_CMD
 2

	)

334 
	#PCI_X_CMD_DPERR_E
 0x0001

	)

335 
	#PCI_X_CMD_ERO
 0x0002

	)

336 
	#PCI_X_CMD_READ_512
 0x0000

	)

337 
	#PCI_X_CMD_READ_1K
 0x0004

	)

338 
	#PCI_X_CMD_READ_2K
 0x0008

	)

339 
	#PCI_X_CMD_READ_4K
 0x000ø

	)

340 
	#PCI_X_CMD_MAX_READ
 0x000ø

	)

342 
	#PCI_X_CMD_SPLIT_1
 0x0000

	)

343 
	#PCI_X_CMD_SPLIT_2
 0x0010

	)

344 
	#PCI_X_CMD_SPLIT_3
 0x0020

	)

345 
	#PCI_X_CMD_SPLIT_4
 0x0030

	)

346 
	#PCI_X_CMD_SPLIT_8
 0x0040

	)

347 
	#PCI_X_CMD_SPLIT_12
 0x0050

	)

348 
	#PCI_X_CMD_SPLIT_16
 0x0060

	)

349 
	#PCI_X_CMD_SPLIT_32
 0x0070

	)

350 
	#PCI_X_CMD_MAX_SPLIT
 0x0070

	)

351 
	#PCI_X_CMD_VERSION
(
x
è(((xè>> 12è& 3è

	)

352 
	#PCI_X_STATUS
 4

	)

353 
	#PCI_X_STATUS_DEVFN
 0x000000fà

	)

354 
	#PCI_X_STATUS_BUS
 0x0000ff00

	)

355 
	#PCI_X_STATUS_64BIT
 0x00010000

	)

356 
	#PCI_X_STATUS_133MHZ
 0x00020000

	)

357 
	#PCI_X_STATUS_SPL_DISC
 0x00040000

	)

358 
	#PCI_X_STATUS_UNX_SPL
 0x00080000

	)

359 
	#PCI_X_STATUS_COMPLEX
 0x00100000

	)

360 
	#PCI_X_STATUS_MAX_READ
 0x00600000

	)

361 
	#PCI_X_STATUS_MAX_SPLIT
 0x03800000

	)

362 
	#PCI_X_STATUS_MAX_CUM
 0x1c000000

	)

363 
	#PCI_X_STATUS_SPL_ERR
 0x20000000

	)

364 
	#PCI_X_STATUS_266MHZ
 0x40000000

	)

365 
	#PCI_X_STATUS_533MHZ
 0x80000000

	)

369 
	#PCI_EXP_FLAGS
 2

	)

370 
	#PCI_EXP_FLAGS_VERS
 0x000à

	)

371 
	#PCI_EXP_FLAGS_TYPE
 0x00f0

	)

372 
	#PCI_EXP_TYPE_ENDPOINT
 0x0

	)

373 
	#PCI_EXP_TYPE_LEG_END
 0x1

	)

374 
	#PCI_EXP_TYPE_ROOT_PORT
 0x4

	)

375 
	#PCI_EXP_TYPE_UPSTREAM
 0x5

	)

376 
	#PCI_EXP_TYPE_DOWNSTREAM
 0x6

	)

377 
	#PCI_EXP_TYPE_PCI_BRIDGE
 0x7

	)

378 
	#PCI_EXP_TYPE_RC_END
 0x9

	)

379 
	#PCI_EXP_TYPE_RC_EC
 0x10

	)

380 
	#PCI_EXP_FLAGS_SLOT
 0x0100

	)

381 
	#PCI_EXP_FLAGS_IRQ
 0x3e00

	)

382 
	#PCI_EXP_DEVCAP
 4

	)

383 
	#PCI_EXP_DEVCAP_PAYLOAD
 0x07

	)

384 
	#PCI_EXP_DEVCAP_PHANTOM
 0x18

	)

385 
	#PCI_EXP_DEVCAP_EXT_TAG
 0x20

	)

386 
	#PCI_EXP_DEVCAP_L0S
 0x1c0

	)

387 
	#PCI_EXP_DEVCAP_L1
 0xe00

	)

388 
	#PCI_EXP_DEVCAP_ATN_BUT
 0x1000

	)

389 
	#PCI_EXP_DEVCAP_ATN_IND
 0x2000

	)

390 
	#PCI_EXP_DEVCAP_PWR_IND
 0x4000

	)

391 
	#PCI_EXP_DEVCAP_RBER
 0x8000

	)

392 
	#PCI_EXP_DEVCAP_PWR_VAL
 0x3fc0000

	)

393 
	#PCI_EXP_DEVCAP_PWR_SCL
 0xc000000

	)

394 
	#PCI_EXP_DEVCAP_FLR
 0x10000000

	)

395 
	#PCI_EXP_DEVCTL
 8

	)

396 
	#PCI_EXP_DEVCTL_CERE
 0x0001

	)

397 
	#PCI_EXP_DEVCTL_NFERE
 0x0002

	)

398 
	#PCI_EXP_DEVCTL_FERE
 0x0004

	)

399 
	#PCI_EXP_DEVCTL_URRE
 0x0008

	)

400 
	#PCI_EXP_DEVCTL_RELAX_EN
 0x0010

	)

401 
	#PCI_EXP_DEVCTL_PAYLOAD
 0x00e0

	)

402 
	#PCI_EXP_DEVCTL_EXT_TAG
 0x0100

	)

403 
	#PCI_EXP_DEVCTL_PHANTOM
 0x0200

	)

404 
	#PCI_EXP_DEVCTL_AUX_PME
 0x0400

	)

405 
	#PCI_EXP_DEVCTL_NOSNOOP_EN
 0x0800

	)

406 
	#PCI_EXP_DEVCTL_READRQ
 0x7000

	)

407 
	#PCI_EXP_DEVCTL_BCR_FLR
 0x8000

	)

408 
	#PCI_EXP_DEVSTA
 10

	)

409 
	#PCI_EXP_DEVSTA_CED
 0x01

	)

410 
	#PCI_EXP_DEVSTA_NFED
 0x02

	)

411 
	#PCI_EXP_DEVSTA_FED
 0x04

	)

412 
	#PCI_EXP_DEVSTA_URD
 0x08

	)

413 
	#PCI_EXP_DEVSTA_AUXPD
 0x10

	)

414 
	#PCI_EXP_DEVSTA_TRPND
 0x20

	)

415 
	#PCI_EXP_LNKCAP
 12

	)

416 
	#PCI_EXP_LNKCAP_SLS
 0x0000000à

	)

417 
	#PCI_EXP_LNKCAP_MLW
 0x000003f0

	)

418 
	#PCI_EXP_LNKCAP_ASPMS
 0x00000c00

	)

419 
	#PCI_EXP_LNKCAP_L0SEL
 0x00007000

	)

420 
	#PCI_EXP_LNKCAP_L1EL
 0x00038000

	)

421 
	#PCI_EXP_LNKCAP_CLKPM
 0x00040000

	)

422 
	#PCI_EXP_LNKCAP_SDERC
 0x00080000

	)

423 
	#PCI_EXP_LNKCAP_DLLLARC
 0x00100000

	)

424 
	#PCI_EXP_LNKCAP_LBNC
 0x00200000

	)

425 
	#PCI_EXP_LNKCAP_PN
 0xff000000

	)

426 
	#PCI_EXP_LNKCTL
 16

	)

427 
	#PCI_EXP_LNKCTL_ASPMC
 0x0003

	)

428 
	#PCI_EXP_LNKCTL_RCB
 0x0008

	)

429 
	#PCI_EXP_LNKCTL_LD
 0x0010

	)

430 
	#PCI_EXP_LNKCTL_RL
 0x0020

	)

431 
	#PCI_EXP_LNKCTL_CCC
 0x0040

	)

432 
	#PCI_EXP_LNKCTL_ES
 0x0080

	)

433 
	#PCI_EXP_LNKCTL_CLKREQ_EN
 0x100

	)

434 
	#PCI_EXP_LNKCTL_HAWD
 0x0200

	)

435 
	#PCI_EXP_LNKCTL_LBMIE
 0x0400

	)

436 
	#PCI_EXP_LNKCTL_LABIE
 0x0800

	)

437 
	#PCI_EXP_LNKSTA
 18

	)

438 
	#PCI_EXP_LNKSTA_CLS
 0x000à

	)

439 
	#PCI_EXP_LNKSTA_NLW
 0x03f0

	)

440 
	#PCI_EXP_LNKSTA_LT
 0x0800

	)

441 
	#PCI_EXP_LNKSTA_SLC
 0x1000

	)

442 
	#PCI_EXP_LNKSTA_DLLLA
 0x2000

	)

443 
	#PCI_EXP_LNKSTA_LBMS
 0x4000

	)

444 
	#PCI_EXP_LNKSTA_LABS
 0x8000

	)

445 
	#PCI_EXP_SLTCAP
 20

	)

446 
	#PCI_EXP_SLTCAP_ABP
 0x00000001

	)

447 
	#PCI_EXP_SLTCAP_PCP
 0x00000002

	)

448 
	#PCI_EXP_SLTCAP_MRLSP
 0x00000004

	)

449 
	#PCI_EXP_SLTCAP_AIP
 0x00000008

	)

450 
	#PCI_EXP_SLTCAP_PIP
 0x00000010

	)

451 
	#PCI_EXP_SLTCAP_HPS
 0x00000020

	)

452 
	#PCI_EXP_SLTCAP_HPC
 0x00000040

	)

453 
	#PCI_EXP_SLTCAP_SPLV
 0x00007f80

	)

454 
	#PCI_EXP_SLTCAP_SPLS
 0x00018000

	)

455 
	#PCI_EXP_SLTCAP_EIP
 0x00020000

	)

456 
	#PCI_EXP_SLTCAP_NCCS
 0x00040000

	)

457 
	#PCI_EXP_SLTCAP_PSN
 0xfff80000

	)

458 
	#PCI_EXP_SLTCTL
 24

	)

459 
	#PCI_EXP_SLTCTL_ABPE
 0x0001

	)

460 
	#PCI_EXP_SLTCTL_PFDE
 0x0002

	)

461 
	#PCI_EXP_SLTCTL_MRLSCE
 0x0004

	)

462 
	#PCI_EXP_SLTCTL_PDCE
 0x0008

	)

463 
	#PCI_EXP_SLTCTL_CCIE
 0x0010

	)

464 
	#PCI_EXP_SLTCTL_HPIE
 0x0020

	)

465 
	#PCI_EXP_SLTCTL_AIC
 0x00c0

	)

466 
	#PCI_EXP_SLTCTL_PIC
 0x0300

	)

467 
	#PCI_EXP_SLTCTL_PCC
 0x0400

	)

468 
	#PCI_EXP_SLTCTL_EIC
 0x0800

	)

469 
	#PCI_EXP_SLTCTL_DLLSCE
 0x1000

	)

470 
	#PCI_EXP_SLTSTA
 26

	)

471 
	#PCI_EXP_SLTSTA_ABP
 0x0001

	)

472 
	#PCI_EXP_SLTSTA_PFD
 0x0002

	)

473 
	#PCI_EXP_SLTSTA_MRLSC
 0x0004

	)

474 
	#PCI_EXP_SLTSTA_PDC
 0x0008

	)

475 
	#PCI_EXP_SLTSTA_CC
 0x0010

	)

476 
	#PCI_EXP_SLTSTA_MRLSS
 0x0020

	)

477 
	#PCI_EXP_SLTSTA_PDS
 0x0040

	)

478 
	#PCI_EXP_SLTSTA_EIS
 0x0080

	)

479 
	#PCI_EXP_SLTSTA_DLLSC
 0x0100

	)

480 
	#PCI_EXP_RTCTL
 28

	)

481 
	#PCI_EXP_RTCTL_SECEE
 0x01

	)

482 
	#PCI_EXP_RTCTL_SENFEE
 0x02

	)

483 
	#PCI_EXP_RTCTL_SEFEE
 0x04

	)

484 
	#PCI_EXP_RTCTL_PMEIE
 0x08

	)

485 
	#PCI_EXP_RTCTL_CRSSVE
 0x10

	)

486 
	#PCI_EXP_RTCAP
 30

	)

487 
	#PCI_EXP_RTSTA
 32

	)

488 
	#PCI_EXP_DEVCAP2
 36

	)

489 
	#PCI_EXP_DEVCAP2_ARI
 0x20

	)

490 
	#PCI_EXP_DEVCTL2
 40

	)

491 
	#PCI_EXP_DEVCTL2_ARI
 0x20

	)

492 
	#PCI_EXP_LNKCTL2
 48

	)

493 
	#PCI_EXP_SLTCTL2
 56

	)

496 
	#PCI_EXT_CAP_ID
(
h—d”
è(h—d” & 0x0000ffff)

	)

497 
	#PCI_EXT_CAP_VER
(
h—d”
è((h—d” >> 16è& 0xf)

	)

498 
	#PCI_EXT_CAP_NEXT
(
h—d”
è((h—d” >> 20è& 0xffc)

	)

500 
	#PCI_EXT_CAP_ID_ERR
 1

	)

501 
	#PCI_EXT_CAP_ID_VC
 2

	)

502 
	#PCI_EXT_CAP_ID_DSN
 3

	)

503 
	#PCI_EXT_CAP_ID_PWR
 4

	)

504 
	#PCI_EXT_CAP_ID_ARI
 14

	)

505 
	#PCI_EXT_CAP_ID_ATS
 15

	)

506 
	#PCI_EXT_CAP_ID_SRIOV
 16

	)

509 
	#PCI_ERR_UNCOR_STATUS
 4

	)

510 
	#PCI_ERR_UNC_TRAIN
 0x00000001

	)

511 
	#PCI_ERR_UNC_DLP
 0x00000010

	)

512 
	#PCI_ERR_UNC_POISON_TLP
 0x00001000

	)

513 
	#PCI_ERR_UNC_FCP
 0x00002000

	)

514 
	#PCI_ERR_UNC_COMP_TIME
 0x00004000

	)

515 
	#PCI_ERR_UNC_COMP_ABORT
 0x00008000

	)

516 
	#PCI_ERR_UNC_UNX_COMP
 0x00010000

	)

517 
	#PCI_ERR_UNC_RX_OVER
 0x00020000

	)

518 
	#PCI_ERR_UNC_MALF_TLP
 0x00040000

	)

519 
	#PCI_ERR_UNC_ECRC
 0x00080000

	)

520 
	#PCI_ERR_UNC_UNSUP
 0x00100000

	)

521 
	#PCI_ERR_UNCOR_MASK
 8

	)

523 
	#PCI_ERR_UNCOR_SEVER
 12

	)

525 
	#PCI_ERR_COR_STATUS
 16

	)

526 
	#PCI_ERR_COR_RCVR
 0x00000001

	)

527 
	#PCI_ERR_COR_BAD_TLP
 0x00000040

	)

528 
	#PCI_ERR_COR_BAD_DLLP
 0x00000080

	)

529 
	#PCI_ERR_COR_REP_ROLL
 0x00000100

	)

530 
	#PCI_ERR_COR_REP_TIMER
 0x00001000

	)

531 
	#PCI_ERR_COR_MASK
 20

	)

533 
	#PCI_ERR_CAP
 24

	)

534 
	#PCI_ERR_CAP_FEP
(
x
è((xè& 31è

	)

535 
	#PCI_ERR_CAP_ECRC_GENC
 0x00000020

	)

536 
	#PCI_ERR_CAP_ECRC_GENE
 0x00000040

	)

537 
	#PCI_ERR_CAP_ECRC_CHKC
 0x00000080

	)

538 
	#PCI_ERR_CAP_ECRC_CHKE
 0x00000100

	)

539 
	#PCI_ERR_HEADER_LOG
 28

	)

540 
	#PCI_ERR_ROOT_COMMAND
 44

	)

542 
	#PCI_ERR_ROOT_CMD_COR_EN
 0x00000001

	)

544 
	#PCI_ERR_ROOT_CMD_NONFATAL_EN
 0x00000002

	)

546 
	#PCI_ERR_ROOT_CMD_FATAL_EN
 0x00000004

	)

547 
	#PCI_ERR_ROOT_STATUS
 48

	)

548 
	#PCI_ERR_ROOT_COR_RCV
 0x00000001

	)

550 
	#PCI_ERR_ROOT_MULTI_COR_RCV
 0x00000002

	)

552 
	#PCI_ERR_ROOT_UNCOR_RCV
 0x00000004

	)

554 
	#PCI_ERR_ROOT_MULTI_UNCOR_RCV
 0x00000008

	)

555 
	#PCI_ERR_ROOT_FIRST_FATAL
 0x00000010

	)

556 
	#PCI_ERR_ROOT_NONFATAL_RCV
 0x00000020

	)

557 
	#PCI_ERR_ROOT_FATAL_RCV
 0x00000040

	)

558 
	#PCI_ERR_ROOT_COR_SRC
 52

	)

559 
	#PCI_ERR_ROOT_SRC
 54

	)

562 
	#PCI_VC_PORT_REG1
 4

	)

563 
	#PCI_VC_PORT_REG2
 8

	)

564 
	#PCI_VC_PORT_CTRL
 12

	)

565 
	#PCI_VC_PORT_STATUS
 14

	)

566 
	#PCI_VC_RES_CAP
 16

	)

567 
	#PCI_VC_RES_CTRL
 20

	)

568 
	#PCI_VC_RES_STATUS
 26

	)

571 
	#PCI_PWR_DSR
 4

	)

572 
	#PCI_PWR_DATA
 8

	)

573 
	#PCI_PWR_DATA_BASE
(
x
è((xè& 0xffè

	)

574 
	#PCI_PWR_DATA_SCALE
(
x
è(((xè>> 8è& 3è

	)

575 
	#PCI_PWR_DATA_PM_SUB
(
x
è(((xè>> 10è& 7è

	)

576 
	#PCI_PWR_DATA_PM_STATE
(
x
è(((xè>> 13è& 3è

	)

577 
	#PCI_PWR_DATA_TYPE
(
x
è(((xè>> 15è& 7è

	)

578 
	#PCI_PWR_DATA_RAIL
(
x
è(((xè>> 18è& 7è

	)

579 
	#PCI_PWR_CAP
 12

	)

580 
	#PCI_PWR_CAP_BUDGET
(
x
è((xè& 1è

	)

590 
	#HT_3BIT_CAP_MASK
 0xE0

	)

591 
	#HT_CAPTYPE_SLAVE
 0x00

	)

592 
	#HT_CAPTYPE_HOST
 0x20

	)

594 
	#HT_5BIT_CAP_MASK
 0xF8

	)

595 
	#HT_CAPTYPE_IRQ
 0x80

	)

596 
	#HT_CAPTYPE_REMAPPING_40
 0xA0

	)

597 
	#HT_CAPTYPE_REMAPPING_64
 0xA2

	)

598 
	#HT_CAPTYPE_UNITID_CLUMP
 0x90

	)

599 
	#HT_CAPTYPE_EXTCONF
 0x98

	)

600 
	#HT_CAPTYPE_MSI_MAPPING
 0xA8

	)

601 
	#HT_MSI_FLAGS
 0x02

	)

602 
	#HT_MSI_FLAGS_ENABLE
 0x1

	)

603 
	#HT_MSI_FLAGS_FIXED
 0x2

	)

604 
	#HT_MSI_FIXED_ADDR
 0x00000000FEE00000ULL

	)

605 
	#HT_MSI_ADDR_LO
 0x04

	)

606 
	#HT_MSI_ADDR_LO_MASK
 0xFFF00000

	)

607 
	#HT_MSI_ADDR_HI
 0x08

	)

608 
	#HT_CAPTYPE_DIRECT_ROUTE
 0xB0

	)

609 
	#HT_CAPTYPE_VCSET
 0xB8

	)

610 
	#HT_CAPTYPE_ERROR_RETRY
 0xC0

	)

611 
	#HT_CAPTYPE_GEN3
 0xD0

	)

612 
	#HT_CAPTYPE_PM
 0xE0

	)

615 
	#PCI_ARI_CAP
 0x04

	)

616 
	#PCI_ARI_CAP_MFVC
 0x0001

	)

617 
	#PCI_ARI_CAP_ACS
 0x0002

	)

618 
	#PCI_ARI_CAP_NFN
(
x
è(((xè>> 8è& 0xffè

	)

619 
	#PCI_ARI_CTRL
 0x06

	)

620 
	#PCI_ARI_CTRL_MFVC
 0x0001

	)

621 
	#PCI_ARI_CTRL_ACS
 0x0002

	)

622 
	#PCI_ARI_CTRL_FG
(
x
è(((xè>> 4è& 7è

	)

625 
	#PCI_ATS_CAP
 0x04

	)

626 
	#PCI_ATS_CAP_QDEP
(
x
è((xè& 0x1fè

	)

627 
	#PCI_ATS_MAX_QDEP
 32

	)

628 
	#PCI_ATS_CTRL
 0x06

	)

629 
	#PCI_ATS_CTRL_ENABLE
 0x8000

	)

630 
	#PCI_ATS_CTRL_STU
(
x
è((xè& 0x1fè

	)

631 
	#PCI_ATS_MIN_STU
 12

	)

634 
	#PCI_SRIOV_CAP
 0x04

	)

635 
	#PCI_SRIOV_CAP_VFM
 0x01

	)

636 
	#PCI_SRIOV_CAP_INTR
(
x
è((xè>> 21è

	)

637 
	#PCI_SRIOV_CTRL
 0x08

	)

638 
	#PCI_SRIOV_CTRL_VFE
 0x01

	)

639 
	#PCI_SRIOV_CTRL_VFM
 0x02

	)

640 
	#PCI_SRIOV_CTRL_INTR
 0x04

	)

641 
	#PCI_SRIOV_CTRL_MSE
 0x08

	)

642 
	#PCI_SRIOV_CTRL_ARI
 0x10

	)

643 
	#PCI_SRIOV_STATUS
 0x0¨

	)

644 
	#PCI_SRIOV_STATUS_VFM
 0x01

	)

645 
	#PCI_SRIOV_INITIAL_VF
 0x0ø

	)

646 
	#PCI_SRIOV_TOTAL_VF
 0x0

	)

647 
	#PCI_SRIOV_NUM_VF
 0x10

	)

648 
	#PCI_SRIOV_FUNC_LINK
 0x12

	)

649 
	#PCI_SRIOV_VF_OFFSET
 0x14

	)

650 
	#PCI_SRIOV_VF_STRIDE
 0x16

	)

651 
	#PCI_SRIOV_VF_DID
 0x1¨

	)

652 
	#PCI_SRIOV_SUP_PGSIZE
 0x1ø

	)

653 
	#PCI_SRIOV_SYS_PGSIZE
 0x20

	)

654 
	#PCI_SRIOV_BAR
 0x24

	)

655 
	#PCI_SRIOV_NUM_BARS
 6

	)

656 
	#PCI_SRIOV_VFM
 0x3ø

	)

657 
	#PCI_SRIOV_VFM_BIR
(
x
è((xè& 7è

	)

658 
	#PCI_SRIOV_VFM_OFFSET
(
x
è((xè& ~7è

	)

659 
	#PCI_SRIOV_VFM_UA
 0x0

	)

660 
	#PCI_SRIOV_VFM_MI
 0x1

	)

661 
	#PCI_SRIOV_VFM_MO
 0x2

	)

662 
	#PCI_SRIOV_VFM_AV
 0x3

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__NFDBITS


22 
	#__NFDBITS
 (8 * ())

	)

24 #undeà
__FD_SETSIZE


25 
	#__FD_SETSIZE
 1024

	)

27 #undeà
__FDSET_LONGS


28 
	#__FDSET_LONGS
 (
__FD_SETSIZE
/
__NFDBITS
)

	)

30 #undeà
__FDELT


31 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

33 #undeà
__FDMASK


34 
	#__FDMASK
(
d
è(1UL << ((dè% 
__NFDBITS
))

	)

37 
	mfds_b™s
 [
__FDSET_LONGS
];

38 } 
	t__k”Ãl_fd_£t
;

41 (*
	t__k”Ãl_sighªdËr_t
)();

44 
	t__k”Ãl_key_t
;

45 
	t__k”Ãl_mqd_t
;

47 
	~<asm/posix_ty³s.h
>

	@/usr/include/sys/time.h

20 #iâdeà
_SYS_TIME_H


21 
	#_SYS_TIME_H
 1

	)

23 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

26 
	#__Ãed_time_t


	)

27 
	~<time.h
>

28 
	#__Ãed_timev®


	)

29 
	~<b™s/time.h
>

31 
	~<sys/£Ëù.h
>

33 #iâdeà
__su£cÚds_t_defšed


34 
__su£cÚds_t
 
	tsu£cÚds_t
;

35 
	#__su£cÚds_t_defšed


	)

39 
	g__BEGIN_DECLS


41 #ifdeà
__USE_GNU


43 
	#TIMEVAL_TO_TIMESPEC
(
tv
, 
ts
) { \

44 (
ts
)->
tv_£c
 = (
tv
)->tv_sec; \

45 (
ts
)->
tv_n£c
 = (
tv
)->
tv_u£c
 * 1000; \

46 }

	)

47 
	#TIMESPEC_TO_TIMEVAL
(
tv
, 
ts
) { \

48 (
tv
)->
tv_£c
 = (
ts
)->tv_sec; \

49 (
tv
)->
tv_u£c
 = (
ts
)->
tv_n£c
 / 1000; \

50 }

	)

54 #ifdeà
__USE_BSD


57 
	stimezÚe


59 
	mtz_mšu‹swe¡
;

60 
	mtz_d¡time
;

63 
timezÚe
 *
	t__»¡riù
 
	t__timezÚe_±r_t
;

65 *
	t__»¡riù
 
	t__timezÚe_±r_t
;

73 
	$g‘timeofday
 (
timev®
 *
__»¡riù
 
__tv
,

74 
__timezÚe_±r_t
 
__tz
è
__THROW
 
	`__nÚnuÎ
 ((1));

76 #ifdeà
__USE_BSD


79 
	$£‰imeofday
 (
__cÚ¡
 
timev®
 *
__tv
,

80 
__cÚ¡
 
timezÚe
 *
__tz
)

81 
__THROW
 
	`__nÚnuÎ
 ((1));

87 
	$adjtime
 (
__cÚ¡
 
timev®
 *
__d–
,

88 
timev®
 *
__Şdd–
è
__THROW
;

93 
	e__™im”_which


96 
ITIMER_REAL
 = 0,

97 
	#ITIMER_REAL
 
ITIMER_REAL


	)

99 
ITIMER_VIRTUAL
 = 1,

100 
	#ITIMER_VIRTUAL
 
ITIMER_VIRTUAL


	)

103 
ITIMER_PROF
 = 2

104 
	#ITIMER_PROF
 
ITIMER_PROF


	)

109 
	s™im”v®


112 
timev®
 
™_š‹rv®
;

114 
timev®
 
™_v®ue
;

117 #ià
defšed
 
__USE_GNU
 && !defšed 
__ılu¥lus


120 
__™im”_which
 
	t__™im”_which_t
;

122 
	t__™im”_which_t
;

127 
	$g‘™im”
 (
__™im”_which_t
 
__which
,

128 
™im”v®
 *
__v®ue
è
__THROW
;

133 
	$£t™im”
 (
__™im”_which_t
 
__which
,

134 
__cÚ¡
 
™im”v®
 *
__»¡riù
 
__Ãw
,

135 
™im”v®
 *
__»¡riù
 
__Şd
è
__THROW
;

140 
	$utimes
 (
__cÚ¡
 *
__fe
, __cÚ¡ 
timev®
 
__tvp
[2])

141 
__THROW
 
	`__nÚnuÎ
 ((1));

143 #ifdeà
__USE_BSD


145 
	$lutimes
 (
__cÚ¡
 *
__fe
, __cÚ¡ 
timev®
 
__tvp
[2])

146 
__THROW
 
	`__nÚnuÎ
 ((1));

149 
	$futimes
 (
__fd
, 
__cÚ¡
 
timev®
 
__tvp
[2]è
__THROW
;

152 #ifdeà
__USE_GNU


156 
	$futime§t
 (
__fd
, 
__cÚ¡
 *
__fe
,

157 
__cÚ¡
 
timev®
 
__tvp
[2]è
__THROW
;

161 #ifdeà
__USE_BSD


164 
	#tim”is£t
(
tvp
è(Ñvp)->
tv_£c
 || (tvp)->
tv_u£c
)

	)

165 
	#tim”ş—r
(
tvp
è(Ñvp)->
tv_£c
 = (tvp)->
tv_u£c
 = 0)

	)

166 
	#tim”cmp
(
a
, 
b
, 
CMP
) \

167 (((
a
)->
tv_£c
 =ğ(
b
)->tv_sec) ? \

168 ((
a
)->
tv_u£c
 
	`CMP
 (
b
)->tv_usec) : \

169 ((
a
)->
tv_£c
 
	`CMP
 (
b
)->tv_£c))

	)

170 
	#tim”add
(
a
, 
b
, 
»suÉ
) \

172 (
»suÉ
)->
tv_£c
 = (
a
)->tv_£ø+ (
b
)->tv_sec; \

173 (
»suÉ
)->
tv_u£c
 = (
a
)->tv_u£ø+ (
b
)->tv_usec; \

174 ià((
»suÉ
)->
tv_u£c
 >= 1000000) \

176 ++(
»suÉ
)->
tv_£c
; \

177 (
»suÉ
)->
tv_u£c
 -= 1000000; \

179 
	}
} 0)

	)

180 
	#tim”sub
(
a
, 
b
, 
»suÉ
) \

182 (
»suÉ
)->
tv_£c
 = (
a
)->tv_£ø- (
b
)->tv_sec; \

183 (
»suÉ
)->
tv_u£c
 = (
a
)->tv_u£ø- (
b
)->tv_usec; \

184 ià((
»suÉ
)->
tv_u£c
 < 0) { \

185 --(
»suÉ
)->
tv_£c
; \

186 (
»suÉ
)->
tv_u£c
 += 1000000; \

188 } 0)

	)

191 
	g__END_DECLS


	@/usr/include/asm-generic/errno.h

1 #iâdeà
_ASM_GENERIC_ERRNO_H


2 
	#_ASM_GENERIC_ERRNO_H


	)

4 
	~<asm-g’”ic/”ºo-ba£.h
>

6 
	#EDEADLK
 35

	)

7 
	#ENAMETOOLONG
 36

	)

8 
	#ENOLCK
 37

	)

9 
	#ENOSYS
 38

	)

10 
	#ENOTEMPTY
 39

	)

11 
	#ELOOP
 40

	)

12 
	#EWOULDBLOCK
 
EAGAIN


	)

13 
	#ENOMSG
 42

	)

14 
	#EIDRM
 43

	)

15 
	#ECHRNG
 44

	)

16 
	#EL2NSYNC
 45

	)

17 
	#EL3HLT
 46

	)

18 
	#EL3RST
 47

	)

19 
	#ELNRNG
 48

	)

20 
	#EUNATCH
 49

	)

21 
	#ENOCSI
 50

	)

22 
	#EL2HLT
 51

	)

23 
	#EBADE
 52

	)

24 
	#EBADR
 53

	)

25 
	#EXFULL
 54

	)

26 
	#ENOANO
 55

	)

27 
	#EBADRQC
 56

	)

28 
	#EBADSLT
 57

	)

30 
	#EDEADLOCK
 
EDEADLK


	)

32 
	#EBFONT
 59

	)

33 
	#ENOSTR
 60

	)

34 
	#ENODATA
 61

	)

35 
	#ETIME
 62

	)

36 
	#ENOSR
 63

	)

37 
	#ENONET
 64

	)

38 
	#ENOPKG
 65

	)

39 
	#EREMOTE
 66

	)

40 
	#ENOLINK
 67

	)

41 
	#EADV
 68

	)

42 
	#ESRMNT
 69

	)

43 
	#ECOMM
 70

	)

44 
	#EPROTO
 71

	)

45 
	#EMULTIHOP
 72

	)

46 
	#EDOTDOT
 73

	)

47 
	#EBADMSG
 74

	)

48 
	#EOVERFLOW
 75

	)

49 
	#ENOTUNIQ
 76

	)

50 
	#EBADFD
 77

	)

51 
	#EREMCHG
 78

	)

52 
	#ELIBACC
 79

	)

53 
	#ELIBBAD
 80

	)

54 
	#ELIBSCN
 81

	)

55 
	#ELIBMAX
 82

	)

56 
	#ELIBEXEC
 83

	)

57 
	#EILSEQ
 84

	)

58 
	#ERESTART
 85

	)

59 
	#ESTRPIPE
 86

	)

60 
	#EUSERS
 87

	)

61 
	#ENOTSOCK
 88

	)

62 
	#EDESTADDRREQ
 89

	)

63 
	#EMSGSIZE
 90

	)

64 
	#EPROTOTYPE
 91

	)

65 
	#ENOPROTOOPT
 92

	)

66 
	#EPROTONOSUPPORT
 93

	)

67 
	#ESOCKTNOSUPPORT
 94

	)

68 
	#EOPNOTSUPP
 95

	)

69 
	#EPFNOSUPPORT
 96

	)

70 
	#EAFNOSUPPORT
 97

	)

71 
	#EADDRINUSE
 98

	)

72 
	#EADDRNOTAVAIL
 99

	)

73 
	#ENETDOWN
 100

	)

74 
	#ENETUNREACH
 101

	)

75 
	#ENETRESET
 102

	)

76 
	#ECONNABORTED
 103

	)

77 
	#ECONNRESET
 104

	)

78 
	#ENOBUFS
 105

	)

79 
	#EISCONN
 106

	)

80 
	#ENOTCONN
 107

	)

81 
	#ESHUTDOWN
 108

	)

82 
	#ETOOMANYREFS
 109

	)

83 
	#ETIMEDOUT
 110

	)

84 
	#ECONNREFUSED
 111

	)

85 
	#EHOSTDOWN
 112

	)

86 
	#EHOSTUNREACH
 113

	)

87 
	#EALREADY
 114

	)

88 
	#EINPROGRESS
 115

	)

89 
	#ESTALE
 116

	)

90 
	#EUCLEAN
 117

	)

91 
	#ENOTNAM
 118

	)

92 
	#ENAVAIL
 119

	)

93 
	#EISNAM
 120

	)

94 
	#EREMOTEIO
 121

	)

95 
	#EDQUOT
 122

	)

97 
	#ENOMEDIUM
 123

	)

98 
	#EMEDIUMTYPE
 124

	)

99 
	#ECANCELED
 125

	)

100 
	#ENOKEY
 126

	)

101 
	#EKEYEXPIRED
 127

	)

102 
	#EKEYREVOKED
 128

	)

103 
	#EKEYREJECTED
 129

	)

106 
	#EOWNERDEAD
 130

	)

107 
	#ENOTRECOVERABLE
 131

	)

109 
	#ERFKILL
 132

	)

	@/usr/include/asm-generic/fcntl.h

1 #iâdeà
_ASM_GENERIC_FCNTL_H


2 
	#_ASM_GENERIC_FCNTL_H


	)

4 
	~<lšux/ty³s.h
>

8 
	#O_ACCMODE
 00000003

	)

9 
	#O_RDONLY
 00000000

	)

10 
	#O_WRONLY
 00000001

	)

11 
	#O_RDWR
 00000002

	)

12 #iâdeà
O_CREAT


13 
	#O_CREAT
 00000100

	)

15 #iâdeà
O_EXCL


16 
	#O_EXCL
 00000200

	)

18 #iâdeà
O_NOCTTY


19 
	#O_NOCTTY
 00000400

	)

21 #iâdeà
O_TRUNC


22 
	#O_TRUNC
 00001000

	)

24 #iâdeà
O_APPEND


25 
	#O_APPEND
 00002000

	)

27 #iâdeà
O_NONBLOCK


28 
	#O_NONBLOCK
 00004000

	)

30 #iâdeà
O_SYNC


31 
	#O_SYNC
 00010000

	)

33 #iâdeà
FASYNC


34 
	#FASYNC
 00020000

	)

36 #iâdeà
O_DIRECT


37 
	#O_DIRECT
 00040000

	)

39 #iâdeà
O_LARGEFILE


40 
	#O_LARGEFILE
 00100000

	)

42 #iâdeà
O_DIRECTORY


43 
	#O_DIRECTORY
 00200000

	)

45 #iâdeà
O_NOFOLLOW


46 
	#O_NOFOLLOW
 00400000

	)

48 #iâdeà
O_NOATIME


49 
	#O_NOATIME
 01000000

	)

51 #iâdeà
O_CLOEXEC


52 
	#O_CLOEXEC
 02000000

	)

54 #iâdeà
O_NDELAY


55 
	#O_NDELAY
 
O_NONBLOCK


	)

58 
	#F_DUPFD
 0

	)

59 
	#F_GETFD
 1

	)

60 
	#F_SETFD
 2

	)

61 
	#F_GETFL
 3

	)

62 
	#F_SETFL
 4

	)

63 #iâdeà
F_GETLK


64 
	#F_GETLK
 5

	)

65 
	#F_SETLK
 6

	)

66 
	#F_SETLKW
 7

	)

68 #iâdeà
F_SETOWN


69 
	#F_SETOWN
 8

	)

70 
	#F_GETOWN
 9

	)

72 #iâdeà
F_SETSIG


73 
	#F_SETSIG
 10

	)

74 
	#F_GETSIG
 11

	)

78 
	#FD_CLOEXEC
 1

	)

81 #iâdeà
F_RDLCK


82 
	#F_RDLCK
 0

	)

83 
	#F_WRLCK
 1

	)

84 
	#F_UNLCK
 2

	)

88 #iâdeà
F_EXLCK


89 
	#F_EXLCK
 4

	)

90 
	#F_SHLCK
 8

	)

94 #iâdeà
F_INPROGRESS


95 
	#F_INPROGRESS
 16

	)

99 
	#LOCK_SH
 1

	)

100 
	#LOCK_EX
 2

	)

101 
	#LOCK_NB
 4

	)

103 
	#LOCK_UN
 8

	)

105 
	#LOCK_MAND
 32

	)

106 
	#LOCK_READ
 64

	)

107 
	#LOCK_WRITE
 128

	)

108 
	#LOCK_RW
 192

	)

110 
	#F_LINUX_SPECIFIC_BASE
 1024

	)

112 #iâdeà
HAVE_ARCH_STRUCT_FLOCK


113 #iâdeà
__ARCH_FLOCK_PAD


114 
	#__ARCH_FLOCK_PAD


	)

117 
	sæock
 {

118 
	ml_ty³
;

119 
	ml_wh’û
;

120 
__k”Ãl_off_t
 
	ml_¡¬t
;

121 
__k”Ãl_off_t
 
	ml_Ën
;

122 
__k”Ãl_pid_t
 
	ml_pid
;

123 
	m__ARCH_FLOCK_PAD


127 #iâdeà
CONFIG_64BIT


129 #iâdeà
F_GETLK64


130 
	#F_GETLK64
 12

	)

131 
	#F_SETLK64
 13

	)

132 
	#F_SETLKW64
 14

	)

135 #iâdeà
HAVE_ARCH_STRUCT_FLOCK64


136 #iâdeà
__ARCH_FLOCK64_PAD


137 
	#__ARCH_FLOCK64_PAD


	)

140 
	sæock64
 {

141 
	ml_ty³
;

142 
	ml_wh’û
;

143 
__k”Ãl_loff_t
 
	ml_¡¬t
;

144 
__k”Ãl_loff_t
 
	ml_Ën
;

145 
__k”Ãl_pid_t
 
	ml_pid
;

146 
	m__ARCH_FLOCK64_PAD


	@/usr/include/asm-generic/ioctl.h

1 #iâdeà
_ASM_GENERIC_IOCTL_H


2 
	#_ASM_GENERIC_IOCTL_H


	)

22 
	#_IOC_NRBITS
 8

	)

23 
	#_IOC_TYPEBITS
 8

	)

30 #iâdeà
_IOC_SIZEBITS


31 
	#_IOC_SIZEBITS
 14

	)

34 #iâdeà
_IOC_DIRBITS


35 
	#_IOC_DIRBITS
 2

	)

38 
	#_IOC_NRMASK
 ((1 << 
_IOC_NRBITS
)-1)

	)

39 
	#_IOC_TYPEMASK
 ((1 << 
_IOC_TYPEBITS
)-1)

	)

40 
	#_IOC_SIZEMASK
 ((1 << 
_IOC_SIZEBITS
)-1)

	)

41 
	#_IOC_DIRMASK
 ((1 << 
_IOC_DIRBITS
)-1)

	)

43 
	#_IOC_NRSHIFT
 0

	)

44 
	#_IOC_TYPESHIFT
 (
_IOC_NRSHIFT
+
_IOC_NRBITS
)

	)

45 
	#_IOC_SIZESHIFT
 (
_IOC_TYPESHIFT
+
_IOC_TYPEBITS
)

	)

46 
	#_IOC_DIRSHIFT
 (
_IOC_SIZESHIFT
+
_IOC_SIZEBITS
)

	)

53 #iâdeà
_IOC_NONE


54 
	#_IOC_NONE
 0U

	)

57 #iâdeà
_IOC_WRITE


58 
	#_IOC_WRITE
 1U

	)

61 #iâdeà
_IOC_READ


62 
	#_IOC_READ
 2U

	)

65 
	#_IOC
(
dœ
,
ty³
,
Ä
,
size
) \

66 (((
dœ
è<< 
_IOC_DIRSHIFT
) | \

67 ((
ty³
è<< 
_IOC_TYPESHIFT
) | \

68 ((
Ä
è<< 
_IOC_NRSHIFT
) | \

69 ((
size
è<< 
_IOC_SIZESHIFT
))

	)

71 
	#_IOC_TYPECHECK
(
t
è(Ñ))

	)

74 
	#_IO
(
ty³
,
Ä
è
	`_IOC
(
_IOC_NONE
,Ñy³),Òr),0)

	)

75 
	#_IOR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

76 
	#_IOW
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

77 
	#_IOWR
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(
	`_IOC_TYPECHECK
(size)))

	)

78 
	#_IOR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
,Ñy³),Òr),(size))

	)

79 
	#_IOW_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_WRITE
,Ñy³),Òr),(size))

	)

80 
	#_IOWR_BAD
(
ty³
,
Ä
,
size
è
	`_IOC
(
_IOC_READ
|
_IOC_WRITE
,Ñy³),Òr),(size))

	)

83 
	#_IOC_DIR
(
Ä
è((Òrè>> 
_IOC_DIRSHIFT
è& 
_IOC_DIRMASK
)

	)

84 
	#_IOC_TYPE
(
Ä
è((Òrè>> 
_IOC_TYPESHIFT
è& 
_IOC_TYPEMASK
)

	)

85 
	#_IOC_NR
(
Ä
è((Òrè>> 
_IOC_NRSHIFT
è& 
_IOC_NRMASK
)

	)

86 
	#_IOC_SIZE
(
Ä
è((Òrè>> 
_IOC_SIZESHIFT
è& 
_IOC_SIZEMASK
)

	)

90 
	#IOC_IN
 (
_IOC_WRITE
 << 
_IOC_DIRSHIFT
)

	)

91 
	#IOC_OUT
 (
_IOC_READ
 << 
_IOC_DIRSHIFT
)

	)

92 
	#IOC_INOUT
 ((
_IOC_WRITE
|
_IOC_READ
è<< 
_IOC_DIRSHIFT
)

	)

93 
	#IOCSIZE_MASK
 (
_IOC_SIZEMASK
 << 
_IOC_SIZESHIFT
)

	)

94 
	#IOCSIZE_SHIFT
 (
_IOC_SIZESHIFT
)

	)

	@/usr/include/asm-generic/poll.h

1 #iâdeà
__ASM_GENERIC_POLL_H


2 
	#__ASM_GENERIC_POLL_H


	)

5 
	#POLLIN
 0x0001

	)

6 
	#POLLPRI
 0x0002

	)

7 
	#POLLOUT
 0x0004

	)

8 
	#POLLERR
 0x0008

	)

9 
	#POLLHUP
 0x0010

	)

10 
	#POLLNVAL
 0x0020

	)

13 
	#POLLRDNORM
 0x0040

	)

14 
	#POLLRDBAND
 0x0080

	)

15 #iâdeà
POLLWRNORM


16 
	#POLLWRNORM
 0x0100

	)

18 #iâdeà
POLLWRBAND


19 
	#POLLWRBAND
 0x0200

	)

21 #iâdeà
POLLMSG


22 
	#POLLMSG
 0x0400

	)

24 #iâdeà
POLLREMOVE


25 
	#POLLREMOVE
 0x1000

	)

27 #iâdeà
POLLRDHUP


28 
	#POLLRDHUP
 0x2000

	)

31 
	spŞlfd
 {

32 
	mfd
;

33 
	mev’ts
;

34 
	m»v’ts
;

	@/usr/include/asm/bitsperlong.h

1 #iâdeà
__ASM_X86_BITSPERLONG_H


2 
	#__ASM_X86_BITSPERLONG_H


	)

4 #ifdeà
__x86_64__


5 
	#__BITS_PER_LONG
 64

	)

7 
	#__BITS_PER_LONG
 32

	)

10 
	~<asm-g’”ic/b™¥”lÚg.h
>

	@/usr/include/asm/posix_types.h

1 #ifdeà
__i386__


2 
	~"posix_ty³s_32.h
"

4 
	~"posix_ty³s_64.h
"

	@/usr/include/bits/time.h

24 #iâdeà
__Ãed_timev®


25 #iâdeà
_BITS_TIME_H


26 
	#_BITS_TIME_H
 1

	)

34 
	#CLOCKS_PER_SEC
 1000000l

	)

36 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


39 
	~<b™s/ty³s.h
>

40 
__syscÚf
 ();

41 
	#CLK_TCK
 ((
__şock_t
è
	`__syscÚf
 (2)è

	)

44 #ifdeà
__USE_POSIX199309


46 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

50 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

52 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

55 
	#TIMER_ABSTIME
 1

	)

61 #ifdeà
__Ãed_timev®


62 #undeà
__Ãed_timev®


63 #iâdeà
_STRUCT_TIMEVAL


64 
	#_STRUCT_TIMEVAL
 1

	)

65 
	~<b™s/ty³s.h
>

69 
	stimev®


71 
__time_t
 
	mtv_£c
;

72 
__su£cÚds_t
 
	mtv_u£c
;

	@/usr/include/bits/types.h

24 #iâdef 
_BITS_TYPES_H


25 
	#_BITS_TYPES_H
 1

	)

27 
	~<ã©u»s.h
>

28 
	~<b™s/wÜdsize.h
>

31 
	t__u_ch¬
;

32 
	t__u_shÜt
;

33 
	t__u_št
;

34 
	t__u_lÚg
;

37 sigÃd 
	t__št8_t
;

38 
	t__ušt8_t
;

39 sigÃd 
	t__št16_t
;

40 
	t__ušt16_t
;

41 sigÃd 
	t__št32_t
;

42 
	t__ušt32_t
;

43 #ià
__WORDSIZE
 == 64

44 sigÃd 
	t__št64_t
;

45 
	t__ušt64_t
;

46 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


47 
__ex‹nsiÚ__
 sigÃd 
	t__št64_t
;

48 
__ex‹nsiÚ__
 
	t__ušt64_t
;

52 #ià
__WORDSIZE
 == 64

53 
	t__quad_t
;

54 
	t__u_quad_t
;

55 #–ià
defšed
 
__GLIBC_HAVE_LONG_LONG


56 
__ex‹nsiÚ__
 
	t__quad_t
;

57 
__ex‹nsiÚ__
 
	t__u_quad_t
;

61 
	m__v®
[2];

62 } 
	t__quad_t
;

65 
__u_lÚg
 
	m__v®
[2];

66 } 
	t__u_quad_t
;

99 
	#__S16_TYPE
 

	)

100 
	#__U16_TYPE
 

	)

101 
	#__S32_TYPE
 

	)

102 
	#__U32_TYPE
 

	)

103 
	#__SLONGWORD_TYPE
 

	)

104 
	#__ULONGWORD_TYPE
 

	)

105 #ià
__WORDSIZE
 == 32

106 
	#__SQUAD_TYPE
 
__quad_t


	)

107 
	#__UQUAD_TYPE
 
__u_quad_t


	)

108 
	#__SWORD_TYPE
 

	)

109 
	#__UWORD_TYPE
 

	)

110 
	#__SLONG32_TYPE
 

	)

111 
	#__ULONG32_TYPE
 

	)

112 
	#__S64_TYPE
 
__quad_t


	)

113 
	#__U64_TYPE
 
__u_quad_t


	)

116 
	#__STD_TYPE
 
__ex‹nsiÚ__
 

	)

117 #–ià
__WORDSIZE
 == 64

118 
	t__SQUAD_TYPE
 

	)

119 
	t__UQUAD_TYPE
 

	)

120 
	t__SWORD_TYPE
 

	)

121 
	t__UWORD_TYPE
 

	)

122 
	t__SLONG32_TYPE
 

	)

123 
	t__ULONG32_TYPE
 

	)

124 
	t__S64_TYPE
 

	)

125 
	t__U64_TYPE
 

	)

127 
	t__STD_TYPE
 

	)

131 
	~<b™s/ty³sizes.h
>

134 
__STD_TYPE
 
	t__DEV_T_TYPE
 
	t__dev_t
;

135 
__STD_TYPE
 
__UID_T_TYPE
 
	g__uid_t
;

136 
__STD_TYPE
 
__GID_T_TYPE
 
	g__gid_t
;

137 
__STD_TYPE
 
__INO_T_TYPE
 
	g__šo_t
;

138 
__STD_TYPE
 
__INO64_T_TYPE
 
	g__šo64_t
;

139 
__STD_TYPE
 
__MODE_T_TYPE
 
	g__mode_t
;

140 
__STD_TYPE
 
__NLINK_T_TYPE
 
	g__Æšk_t
;

141 
__STD_TYPE
 
__OFF_T_TYPE
 
	g__off_t
;

142 
__STD_TYPE
 
__OFF64_T_TYPE
 
	g__off64_t
;

143 
__STD_TYPE
 
__PID_T_TYPE
 
	g__pid_t
;

144 
__STD_TYPE
 
__FSID_T_TYPE
 
	g__fsid_t
;

145 
__STD_TYPE
 
__CLOCK_T_TYPE
 
	g__şock_t
;

146 
__STD_TYPE
 
__RLIM_T_TYPE
 
	g__¾im_t
;

147 
__STD_TYPE
 
__RLIM64_T_TYPE
 
	g__¾im64_t
;

148 
__STD_TYPE
 
__ID_T_TYPE
 
	g__id_t
;

149 
__STD_TYPE
 
__TIME_T_TYPE
 
	g__time_t
;

150 
__STD_TYPE
 
__USECONDS_T_TYPE
 
	g__u£cÚds_t
;

151 
__STD_TYPE
 
__SUSECONDS_T_TYPE
 
	g__su£cÚds_t
;

153 
__STD_TYPE
 
__DADDR_T_TYPE
 
	g__daddr_t
;

154 
__STD_TYPE
 
__SWBLK_T_TYPE
 
	g__swblk_t
;

155 
__STD_TYPE
 
__KEY_T_TYPE
 
	g__key_t
;

158 
__STD_TYPE
 
__CLOCKID_T_TYPE
 
	g__şockid_t
;

161 
__STD_TYPE
 
__TIMER_T_TYPE
 
	g__tim”_t
;

164 
__STD_TYPE
 
__BLKSIZE_T_TYPE
 
	g__blksize_t
;

169 
__STD_TYPE
 
__BLKCNT_T_TYPE
 
	g__blkút_t
;

170 
__STD_TYPE
 
__BLKCNT64_T_TYPE
 
	g__blkút64_t
;

173 
__STD_TYPE
 
__FSBLKCNT_T_TYPE
 
	g__fsblkút_t
;

174 
__STD_TYPE
 
__FSBLKCNT64_T_TYPE
 
	g__fsblkút64_t
;

177 
__STD_TYPE
 
__FSFILCNT_T_TYPE
 
	g__fsfút_t
;

178 
__STD_TYPE
 
__FSFILCNT64_T_TYPE
 
	g__fsfút64_t
;

180 
__STD_TYPE
 
__SSIZE_T_TYPE
 
	g__ssize_t
;

184 
__off64_t
 
	t__loff_t
;

185 
__quad_t
 *
	t__qaddr_t
;

186 *
	t__ÿddr_t
;

189 
__STD_TYPE
 
__SWORD_TYPE
 
	g__šŒ_t
;

192 
__STD_TYPE
 
__U32_TYPE
 
	g__sockËn_t
;

195 #undeà
__STD_TYPE


	@/usr/include/features.h

19 #iâdef 
_FEATURES_H


20 
	#_FEATURES_H
 1

	)

95 #undeà
__USE_ISOC99


96 #undeà
__USE_ISOC95


97 #undeà
__USE_POSIX


98 #undeà
__USE_POSIX2


99 #undeà
__USE_POSIX199309


100 #undeà
__USE_POSIX199506


101 #undeà
__USE_XOPEN


102 #undeà
__USE_XOPEN_EXTENDED


103 #undeà
__USE_UNIX98


104 #undeà
__USE_XOPEN2K


105 #undeà
__USE_XOPEN2K8


106 #undeà
__USE_LARGEFILE


107 #undeà
__USE_LARGEFILE64


108 #undeà
__USE_FILE_OFFSET64


109 #undeà
__USE_BSD


110 #undeà
__USE_SVID


111 #undeà
__USE_MISC


112 #undeà
__USE_ATFILE


113 #undeà
__USE_GNU


114 #undeà
__USE_REENTRANT


115 #undeà
__USE_FORTIFY_LEVEL


116 #undeà
__FAVOR_BSD


117 #undeà
__KERNEL_STRICT_NAMES


121 #iâdeà
_LOOSE_KERNEL_NAMES


122 
	#__KERNEL_STRICT_NAMES


	)

126 
	#__USE_ANSI
 1

	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

144 #ià
defšed
 
_BSD_SOURCE
 && \

145 !(
defšed
 
	g_POSIX_SOURCE
 || defšed 
	g_POSIX_C_SOURCE
 || \

146 
defšed
 
	g_XOPEN_SOURCE
 || defšed 
	g_XOPEN_SOURCE_EXTENDED
 || \

147 
defšed
 
	g_GNU_SOURCE
 || defšed 
	g_SVID_SOURCE
)

148 
	#__FAVOR_BSD
 1

	)

152 #ifdeà
_GNU_SOURCE


153 #undeà
_ISOC99_SOURCE


154 
	#_ISOC99_SOURCE
 1

	)

155 #undeà
_POSIX_SOURCE


156 
	#_POSIX_SOURCE
 1

	)

157 #undeà
_POSIX_C_SOURCE


158 
	#_POSIX_C_SOURCE
 200809L

	)

159 #undeà
_XOPEN_SOURCE


160 
	#_XOPEN_SOURCE
 700

	)

161 #undeà
_XOPEN_SOURCE_EXTENDED


162 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

163 #undeà
_LARGEFILE64_SOURCE


164 
	#_LARGEFILE64_SOURCE
 1

	)

165 #undeà
_BSD_SOURCE


166 
	#_BSD_SOURCE
 1

	)

167 #undeà
_SVID_SOURCE


168 
	#_SVID_SOURCE
 1

	)

169 #undeà
_ATFILE_SOURCE


170 
	#_ATFILE_SOURCE
 1

	)

175 #ià(!
defšed
 
__STRICT_ANSI__
 && !defšed 
_ISOC99_SOURCE
 && \

176 !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 && \

177 !
defšed
 
	g_XOPEN_SOURCE
 && !defšed 
	g_XOPEN_SOURCE_EXTENDED
 && \

178 !
defšed
 
	g_BSD_SOURCE
 && !defšed 
	g_SVID_SOURCE
)

179 
	#_BSD_SOURCE
 1

	)

180 
	#_SVID_SOURCE
 1

	)

187 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

188 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

189 
	#__USE_ISOC99
 1

	)

193 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC9X_SOURCE
 \

194 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

195 
	#__USE_ISOC95
 1

	)

200 #ià((!
defšed
 
__STRICT_ANSI__
 || (
_XOPEN_SOURCE
 - 0) >= 500) && \

201 !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

202 
	#_POSIX_SOURCE
 1

	)

203 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

204 
	#_POSIX_C_SOURCE
 2

	)

205 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

206 
	#_POSIX_C_SOURCE
 199506L

	)

207 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

208 
	#_POSIX_C_SOURCE
 200112L

	)

210 
	#_POSIX_C_SOURCE
 200809L

	)

212 
	#__USE_POSIX_IMPLICITLY
 1

	)

215 #ià
defšed
 
_POSIX_SOURCE
 || 
_POSIX_C_SOURCE
 >ğ1 || defšed 
_XOPEN_SOURCE


216 
	#__USE_POSIX
 1

	)

219 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


220 
	#__USE_POSIX2
 1

	)

223 #ià(
_POSIX_C_SOURCE
 - 0) >= 199309L

224 
	#__USE_POSIX199309
 1

	)

227 #ià(
_POSIX_C_SOURCE
 - 0) >= 199506L

228 
	#__USE_POSIX199506
 1

	)

231 #ià(
_POSIX_C_SOURCE
 - 0) >= 200112L

232 
	#__USE_XOPEN2K
 1

	)

233 #undeà
__USE_ISOC99


234 
	#__USE_ISOC99
 1

	)

237 #ià(
_POSIX_C_SOURCE
 - 0) >= 200809L

238 
	#__USE_XOPEN2K8
 1

	)

239 #undeà
_ATFILE_SOURCE


240 
	#_ATFILE_SOURCE
 1

	)

243 #ifdef 
_XOPEN_SOURCE


244 
	#__USE_XOPEN
 1

	)

245 #ià(
_XOPEN_SOURCE
 - 0) >= 500

246 
	#__USE_XOPEN_EXTENDED
 1

	)

247 
	#__USE_UNIX98
 1

	)

248 #undeà
_LARGEFILE_SOURCE


249 
	#_LARGEFILE_SOURCE
 1

	)

250 #ià(
_XOPEN_SOURCE
 - 0) >= 600

251 #ià(
_XOPEN_SOURCE
 - 0) >= 700

252 
	#__USE_XOPEN2K8
 1

	)

254 
	#__USE_XOPEN2K
 1

	)

255 #undeà
__USE_ISOC99


256 
	#__USE_ISOC99
 1

	)

259 #ifdeà
_XOPEN_SOURCE_EXTENDED


260 
	#__USE_XOPEN_EXTENDED
 1

	)

265 #ifdeà
_LARGEFILE_SOURCE


266 
	#__USE_LARGEFILE
 1

	)

269 #ifdeà
_LARGEFILE64_SOURCE


270 
	#__USE_LARGEFILE64
 1

	)

273 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

274 
	#__USE_FILE_OFFSET64
 1

	)

277 #ià
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE


278 
	#__USE_MISC
 1

	)

281 #ifdef 
_BSD_SOURCE


282 
	#__USE_BSD
 1

	)

285 #ifdef 
_SVID_SOURCE


286 
	#__USE_SVID
 1

	)

289 #ifdef 
_ATFILE_SOURCE


290 
	#__USE_ATFILE
 1

	)

293 #ifdef 
_GNU_SOURCE


294 
	#__USE_GNU
 1

	)

297 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


298 
	#__USE_REENTRANT
 1

	)

301 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

302 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

303 #ià
_FORTIFY_SOURCE
 > 1

304 
	#__USE_FORTIFY_LEVEL
 2

	)

306 
	#__USE_FORTIFY_LEVEL
 1

	)

309 
	#__USE_FORTIFY_LEVEL
 0

	)

313 
	~<b™s/´edefs.h
>

316 
	#__STDC_ISO_10646__
 200009L

	)

324 #undeà
__GNU_LIBRARY__


325 
	#__GNU_LIBRARY__
 6

	)

329 
	#__GLIBC__
 2

	)

330 
	#__GLIBC_MINOR__
 10

	)

332 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

333 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

336 #ià
defšed
 
__GNUC__
 \

337 || (
defšed
 
	g__PGI
 && defšed 
	g__i386__
 ) \

338 || (
defšed
 
	g__INTEL_COMPILER
 && (defšed 
	g__i386__
 || defšed 
	g__Ÿ64__
)) \

339 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L)

340 
	#__GLIBC_HAVE_LONG_LONG
 1

	)

344 #iâdeà
__ASSEMBLER__


345 #iâdeà
_SYS_CDEFS_H


346 
	~<sys/cdefs.h
>

351 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


352 
	#__USE_LARGEFILE
 1

	)

353 
	#__USE_LARGEFILE64
 1

	)

359 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

360 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

361 && 
defšed
 
	g__ex‹º_šlše


362 
	#__USE_EXTERN_INLINES
 1

	)

367 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

368 && (
defšed
 
	g_LIBC
 || !defšed 
	g__OPTIMIZE_SIZE__
è&& !defšed 
	g__NO_INLINE__
 \

369 && 
defšed
 
	g__ex‹º_šlše


370 
	#__USE_EXTERN_INLINES_IN_LIBC
 1

	)

378 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/stddef.h

1 #iâdeà
_LINUX_STDDEF_H


2 
	#_LINUX_STDDEF_H


	)

6 #undeà
NULL


7 #ià
defšed
(
__ılu¥lus
)

8 
	#NULL
 0

	)

10 
	#NULL
 ((*)0)

	)

	@/usr/include/sys/select.h

22 #iâdeà
_SYS_SELECT_H


23 
	#_SYS_SELECT_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	~<b™s/ty³s.h
>

31 
	~<b™s/£Ëù.h
>

34 
	~<b™s/sig£t.h
>

36 #iâdeà
__sig£t_t_defšed


37 
	#__sig£t_t_defšed


	)

38 
__sig£t_t
 
	tsig£t_t
;

42 
	#__Ãed_time_t


	)

43 
	#__Ãed_time¥ec


	)

44 
	~<time.h
>

45 
	#__Ãed_timev®


	)

46 
	~<b™s/time.h
>

48 #iâdeà
__su£cÚds_t_defšed


49 
__su£cÚds_t
 
	tsu£cÚds_t
;

50 
	#__su£cÚds_t_defšed


	)

55 
	t__fd_mask
;

58 #undeà
__NFDBITS


59 #undeà
__FDELT


60 #undeà
__FDMASK


62 
	#__NFDBITS
 (8 *  (
__fd_mask
))

	)

63 
	#__FDELT
(
d
è((dè/ 
__NFDBITS
)

	)

64 
	#__FDMASK
(
d
è((
__fd_mask
è1 << ((dè% 
__NFDBITS
))

	)

71 #ifdeà
__USE_XOPEN


72 
__fd_mask
 
	mfds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

73 
	#__FDS_BITS
(
£t
è((£t)->
fds_b™s
)

	)

75 
__fd_mask
 
	m__fds_b™s
[
__FD_SETSIZE
 / 
__NFDBITS
];

76 
	#__FDS_BITS
(
£t
è((£t)->
__fds_b™s
)

	)

78 } 
	tfd_£t
;

81 
	#FD_SETSIZE
 
__FD_SETSIZE


	)

83 #ifdeà
__USE_MISC


85 
__fd_mask
 
	tfd_mask
;

88 
	#NFDBITS
 
__NFDBITS


	)

93 
	#FD_SET
(
fd
, 
fd£
è
	`__FD_SET
 (fd, fd£)

	)

94 
	#FD_CLR
(
fd
, 
fd£
è
	`__FD_CLR
 (fd, fd£)

	)

95 
	#FD_ISSET
(
fd
, 
fd£
è
	`__FD_ISSET
 (fd, fd£)

	)

96 
	#FD_ZERO
(
fd£
è
	`__FD_ZERO
 (fd£)

	)

99 
__BEGIN_DECLS


109 
£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

110 
fd_£t
 *
__»¡riù
 
__wr™efds
,

111 
fd_£t
 *
__»¡riù
 
__exû±fds
,

112 
timev®
 *
__»¡riù
 
__timeout
);

114 #ifdeà
__USE_XOPEN2K


121 
p£Ëù
 (
__nfds
, 
fd_£t
 *
__»¡riù
 
__»adfds
,

122 
fd_£t
 *
__»¡riù
 
__wr™efds
,

123 
fd_£t
 *
__»¡riù
 
__exû±fds
,

124 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
,

125 cÚ¡ 
__sig£t_t
 *
__»¡riù
 
__sigmask
);

128 
	g__END_DECLS


	@/usr/include/time.h

23 #iâdef 
_TIME_H


25 #ià(! 
defšed
 
__Ãed_time_t
 && !defšed 
__Ãed_şock_t
 && \

26 ! 
defšed
 
	g__Ãed_time¥ec
)

27 
	#_TIME_H
 1

	)

28 
	~<ã©u»s.h
>

30 
	g__BEGIN_DECLS


34 #ifdef 
_TIME_H


36 
	#__Ãed_size_t


	)

37 
	#__Ãed_NULL


	)

38 
	~<¡ddef.h
>

42 
	~<b™s/time.h
>

45 #ià!
defšed
 
__STRICT_ANSI__
 && !defšed 
__USE_XOPEN2K


46 #iâdeà
CLK_TCK


47 
	#CLK_TCK
 
CLOCKS_PER_SEC


	)

53 #ià!
defšed
 
__şock_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_şock_t
)

54 
	#__şock_t_defšed
 1

	)

56 
	~<b™s/ty³s.h
>

58 
__BEGIN_NAMESPACE_STD


60 
__şock_t
 
	tşock_t
;

61 
	g__END_NAMESPACE_STD


62 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


63 
	$__USING_NAMESPACE_STD
(
şock_t
)

67 #undeà
__Ãed_şock_t


69 #ià!
defšed
 
__time_t_defšed
 && (defšed 
_TIME_H
 || defšed 
__Ãed_time_t
)

70 
	#__time_t_defšed
 1

	)

72 
	~<b™s/ty³s.h
>

74 
__BEGIN_NAMESPACE_STD


76 
__time_t
 
	ttime_t
;

77 
__END_NAMESPACE_STD


78 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC
 || defšed 
__USE_SVID


79 
	$__USING_NAMESPACE_STD
(
time_t
)

83 #undeà
__Ãed_time_t


85 #ià!
defšed
 
__şockid_t_defšed
 && \

86 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_şockid_t
)

87 
	#__şockid_t_defšed
 1

	)

89 
	~<b™s/ty³s.h
>

92 
__şockid_t
 
	tşockid_t
;

95 #undeà
__şockid_time_t


97 #ià!
defšed
 
__tim”_t_defšed
 && \

98 ((
defšed
 
_TIME_H
 && defšed 
__USE_POSIX199309
è|| defšed 
__Ãed_tim”_t
)

99 
	#__tim”_t_defšed
 1

	)

101 
	~<b™s/ty³s.h
>

104 
__tim”_t
 
	ttim”_t
;

107 #undeà
__Ãed_tim”_t


110 #ià!
defšed
 
__time¥ec_defšed
 && \

111 ((
defšed
 
_TIME_H
 && \

112 (
defšed
 
__USE_POSIX199309
 || defšed 
__USE_MISC
)) || \

113 
defšed
 
__Ãed_time¥ec
)

114 
	#__time¥ec_defšed
 1

	)

116 
	~<b™s/ty³s.h
>

120 
	stime¥ec


122 
__time_t
 
tv_£c
;

123 
tv_n£c
;

127 #undeà
__Ãed_time¥ec


130 #ifdef 
_TIME_H


131 
__BEGIN_NAMESPACE_STD


133 
	stm


135 
tm_£c
;

136 
tm_mš
;

137 
tm_hour
;

138 
tm_mday
;

139 
tm_mÚ
;

140 
tm_y—r
;

141 
tm_wday
;

142 
tm_yday
;

143 
tm_isd¡
;

145 #ifdef 
__USE_BSD


146 
tm_gmtoff
;

147 
__cÚ¡
 *
tm_zÚe
;

149 
__tm_gmtoff
;

150 
__cÚ¡
 *
__tm_zÚe
;

153 
__END_NAMESPACE_STD


154 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_POSIX
 || defšed 
__USE_MISC


155 
	$__USING_NAMESPACE_STD
(
tm
)

159 #ifdeà
__USE_POSIX199309


161 
	s™im”¥ec


163 
time¥ec
 
™_š‹rv®
;

164 
time¥ec
 
™_v®ue
;

168 
sigev’t
;

172 #ifdeà
__USE_XOPEN2K


173 #iâdeà
__pid_t_defšed


174 
__pid_t
 
	tpid_t
;

175 
	#__pid_t_defšed


	)

180 
__BEGIN_NAMESPACE_STD


183 
şock_t
 
	$şock
 (è
__THROW
;

186 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

189 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

190 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

193 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

199 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

200 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

201 
__cÚ¡
 
tm
 *
__»¡riù
 
__
è
__THROW
;

202 
__END_NAMESPACE_STD


204 #ifdeà
__USE_XOPEN


207 *
	$¡½time
 (
__cÚ¡
 *
__»¡riù
 
__s
,

208 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
)

209 
__THROW
;

212 #ifdeà
__USE_XOPEN2K8


215 
	~<xloÿË.h
>

217 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

218 
__cÚ¡
 *
__»¡riù
 
__fÜm©
,

219 
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

220 
__loÿË_t
 
__loc
è
__THROW
;

223 #ifdeà
__USE_GNU


224 *
	$¡½time_l
 (
__cÚ¡
 *
__»¡riù
 
__s
,

225 
__cÚ¡
 *
__»¡riù
 
__fmt
, 
tm
 *
__
,

226 
__loÿË_t
 
__loc
è
__THROW
;

230 
__BEGIN_NAMESPACE_STD


233 
tm
 *
	$gmtime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

237 
tm
 *
	$loÿÉime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

238 
__END_NAMESPACE_STD


240 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


243 
tm
 *
	$gmtime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

244 
tm
 *
__»¡riù
 
__
è
__THROW
;

248 
tm
 *
	$loÿÉime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

249 
tm
 *
__»¡riù
 
__
è
__THROW
;

252 
__BEGIN_NAMESPACE_STD


255 *
	$asùime
 (
__cÚ¡
 
tm
 *
__
è
__THROW
;

258 *
	$ùime
 (
__cÚ¡
 
time_t
 *
__tim”
è
__THROW
;

259 
__END_NAMESPACE_STD


261 #ià
defšed
 
__USE_POSIX
 || defšed 
__USE_MISC


266 *
	$asùime_r
 (
__cÚ¡
 
tm
 *
__»¡riù
 
__
,

267 *
__»¡riù
 
__buf
è
__THROW
;

270 *
	$ùime_r
 (
__cÚ¡
 
time_t
 *
__»¡riù
 
__tim”
,

271 *
__»¡riù
 
__buf
è
__THROW
;

276 *
__tzÇme
[2];

277 
__daylight
;

278 
__timezÚe
;

281 #ifdef 
__USE_POSIX


283 *
tzÇme
[2];

287 
	$tz£t
 (è
__THROW
;

290 #ià
defšed
 
__USE_SVID
 || defšed 
__USE_XOPEN


291 
daylight
;

292 
timezÚe
;

295 #ifdeà
__USE_SVID


298 
	$¡ime
 (
__cÚ¡
 
time_t
 *
__wh’
è
__THROW
;

304 
	#__i¦—p
(
y—r
) \

305 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

308 #ifdeà
__USE_MISC


313 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

316 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

319 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

323 #ifdeà
__USE_POSIX199309


328 
	`Çno¦“p
 (
__cÚ¡
 
time¥ec
 *
__»que¡ed_time
,

329 
time¥ec
 *
__»maššg
);

333 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

336 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

339 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, 
__cÚ¡
 
time¥ec
 *
__
)

340 
__THROW
;

342 #ifdeà
__USE_XOPEN2K


347 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

348 
__cÚ¡
 
time¥ec
 *
__»q
,

349 
time¥ec
 *
__»m
);

352 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

357 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

358 
sigev’t
 *
__»¡riù
 
__evp
,

359 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

362 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

365 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

366 
__cÚ¡
 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

367 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

370 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

371 
__THROW
;

374 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

378 #ifdeà
__USE_XOPEN_EXTENDED


390 
g‘d©e_”r
;

399 
tm
 *
	`g‘d©e
 (
__cÚ¡
 *
__¡ršg
);

402 #ifdeà
__USE_GNU


413 
	`g‘d©e_r
 (
__cÚ¡
 *
__»¡riù
 
__¡ršg
,

414 
tm
 *
__»¡riù
 
__»sbuå
);

417 
__END_DECLS


	@/usr/include/asm-generic/bitsperlong.h

1 #iâdeà
__ASM_GENERIC_BITS_PER_LONG


2 
	#__ASM_GENERIC_BITS_PER_LONG


	)

11 #iâdeà
__BITS_PER_LONG


12 
	#__BITS_PER_LONG
 32

	)

	@/usr/include/asm-generic/errno-base.h

1 #iâdeà
_ASM_GENERIC_ERRNO_BASE_H


2 
	#_ASM_GENERIC_ERRNO_BASE_H


	)

4 
	#EPERM
 1

	)

5 
	#ENOENT
 2

	)

6 
	#ESRCH
 3

	)

7 
	#EINTR
 4

	)

8 
	#EIO
 5

	)

9 
	#ENXIO
 6

	)

10 
	#E2BIG
 7

	)

11 
	#ENOEXEC
 8

	)

12 
	#EBADF
 9

	)

13 
	#ECHILD
 10

	)

14 
	#EAGAIN
 11

	)

15 
	#ENOMEM
 12

	)

16 
	#EACCES
 13

	)

17 
	#EFAULT
 14

	)

18 
	#ENOTBLK
 15

	)

19 
	#EBUSY
 16

	)

20 
	#EEXIST
 17

	)

21 
	#EXDEV
 18

	)

22 
	#ENODEV
 19

	)

23 
	#ENOTDIR
 20

	)

24 
	#EISDIR
 21

	)

25 
	#EINVAL
 22

	)

26 
	#ENFILE
 23

	)

27 
	#EMFILE
 24

	)

28 
	#ENOTTY
 25

	)

29 
	#ETXTBSY
 26

	)

30 
	#EFBIG
 27

	)

31 
	#ENOSPC
 28

	)

32 
	#ESPIPE
 29

	)

33 
	#EROFS
 30

	)

34 
	#EMLINK
 31

	)

35 
	#EPIPE
 32

	)

36 
	#EDOM
 33

	)

37 
	#ERANGE
 34

	)

	@/usr/include/bits/predefs.h

19 #iâdeà
_FEATURES_H


23 #iâdeà
_PREDEFS_H


24 
	#_PREDEFS_H


	)

27 
	#__STDC_IEC_559__
 1

	)

28 
	#__STDC_IEC_559_COMPLEX__
 1

	)

	@/usr/include/bits/select.h

19 #iâdeà
_SYS_SELECT_H


23 
	~<b™s/wÜdsize.h
>

26 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

28 #ià
__WORDSIZE
 == 64

29 
	#__FD_ZERO_STOS
 "¡osq"

	)

30 
	#__FD_SET_BTS
 "btsq"

	)

31 
	#__FD_CLR_BTR
 "bŒq"

	)

32 
	#__FD_ISSET_BT
 "btq"

	)

34 
	#__FD_ZERO_STOS
 "¡o¦"

	)

35 
	#__FD_SET_BTS
 "bt¦"

	)

36 
	#__FD_CLR_BTR
 "bŒl"

	)

37 
	#__FD_ISSET_BT
 "b"

	)

40 
	#__FD_ZERO
(
fd¥
) \

42 
__d0
, 
__d1
; \

43 
__asm__
 
	`__vŞ©e__
 ("şd;„•; " 
__FD_ZERO_STOS
 \

44 : "=c" (
__d0
), "=D" (
__d1
) \

45 : "a" (0), "0" ( (
fd_£t
) \

46 /  (
__fd_mask
)), \

47 "1" (&
	`__FDS_BITS
 (
fd¥
)[0]) \

49 } 0)

	)

51 
	#__FD_SET
(
fd
, 
fd¥
) \

52 
__asm__
 
	`__vŞ©e__
 (
__FD_SET_BTS
 " %1,%0" \

53 : "=m" (
	`__FDS_BITS
 (
fd¥
)[
	`__FDELT
 (
fd
)]) \

54 : "r" (((è(
fd
)è% 
__NFDBITS
) \

55 : "cc","memÜy")

	)

56 
	#__FD_CLR
(
fd
, 
fd¥
) \

57 
__asm__
 
	`__vŞ©e__
 (
__FD_CLR_BTR
 " %1,%0" \

58 : "=m" (
	`__FDS_BITS
 (
fd¥
)[
	`__FDELT
 (
fd
)]) \

59 : "r" (((è(
fd
)è% 
__NFDBITS
) \

60 : "cc","memÜy")

	)

61 
	#__FD_ISSET
(
fd
, 
fd¥
) \

62 (
__ex‹nsiÚ__
 \

63 ({
__»suÉ
; \

64 
__asm__
 
	`__vŞ©e__
 (
__FD_ISSET_BT
 " %1,%2 ; setcb %b0" \

65 : "=q" (
__»suÉ
) \

66 : "r" (((è(
fd
)è% 
__NFDBITS
), \

67 "m" (
	`__FDS_BITS
 (
fd¥
)[
	`__FDELT
 (
fd
)]) \

69 
__»suÉ
; }))

	)

75 
	#__FD_ZERO
(
£t
) \

77 
__i
; \

78 
fd_£t
 *
__¬r
 = (
£t
); \

79 
__i
 = 0; __˜<  (
fd_£t
è/  (
__fd_mask
); ++__i) \

80 
	`__FDS_BITS
 (
__¬r
)[
__i
] = 0; \

81 } 0)

	)

82 
	#__FD_SET
(
d
, 
£t
è(
	`__FDS_BITS
 (£t)[
	`__FDELT
 (d)] |ğ
	`__FDMASK
 (d))

	)

83 
	#__FD_CLR
(
d
, 
£t
è(
	`__FDS_BITS
 (£t)[
	`__FDELT
 (d)] &ğ~
	`__FDMASK
 (d))

	)

84 
	#__FD_ISSET
(
d
, 
£t
è(
	`__FDS_BITS
 (£t)[
	`__FDELT
 (d)] & 
	`__FDMASK
 (d))

	)

	@/usr/include/bits/sigset.h

21 #iâdef 
_SIGSET_H_ty³s


22 
	#_SIGSET_H_ty³s
 1

	)

24 
	t__sig_©omic_t
;

28 
	#_SIGSET_NWORDS
 (1024 / (8 *  ()))

	)

31 
	m__v®
[
_SIGSET_NWORDS
];

32 } 
	t__sig£t_t
;

43 #ià!
defšed
 
_SIGSET_H_âs
 && defšed 
_SIGNAL_H


44 
	#_SIGSET_H_âs
 1

	)

46 #iâdeà
_EXTERN_INLINE


47 
	#_EXTERN_INLINE
 
__ex‹º_šlše


	)

51 
	#__sigmask
(
sig
) \

52 (((è1è<< (((
sig
è- 1è% (8 *  ())))

	)

55 
	#__sigwÜd
(
sig
è(((sigè- 1è/ (8 *  ()))

	)

57 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

58 
	#__sigem±y£t
(
£t
) \

59 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

60 
sig£t_t
 *
__£t
 = (
£t
); \

61 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = 0; \

62 0; }))

	)

63 
	#__sigfl£t
(
£t
) \

64 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

65 
sig£t_t
 *
__£t
 = (
£t
); \

66 --
__út
 >ğ0è
__£t
->
__v®
[__cnt] = ~0UL; \

67 0; }))

	)

69 #ifdeà
__USE_GNU


73 
	#__sigi£m±y£t
(
£t
) \

74 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

75 cÚ¡ 
sig£t_t
 *
__£t
 = (
£t
); \

76 
__»t
 = 
__£t
->
__v®
[--
__út
]; \

77 !
__»t
 && --
__út
 >= 0) \

78 
__»t
 = 
__£t
->
__v®
[
__út
]; \

79 
__»t
 =ğ0; }))

	)

80 
	#__sigªd£t
(
de¡
, 
Ëá
, 
right
) \

81 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

82 
sig£t_t
 *
__de¡
 = (
de¡
); \

83 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

84 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

85 --
__út
 >= 0) \

86 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

87 & 
__right
->
__v®
[
__út
]); \

88 0; }))

	)

89 
	#__sigÜ£t
(
de¡
, 
Ëá
, 
right
) \

90 (
	`__ex‹nsiÚ__
 ({ 
__út
 = 
_SIGSET_NWORDS
; \

91 
sig£t_t
 *
__de¡
 = (
de¡
); \

92 cÚ¡ 
sig£t_t
 *
__Ëá
 = (
Ëá
); \

93 cÚ¡ 
sig£t_t
 *
__right
 = (
right
); \

94 --
__út
 >= 0) \

95 
__de¡
->
__v®
[
__út
] = (
__Ëá
->__val[__cnt] \

96 | 
__right
->
__v®
[
__út
]); \

97 0; }))

	)

104 
__sigismemb”
 (
__cÚ¡
 
__sig£t_t
 *, );

105 
__sigadd£t
 (
__sig£t_t
 *, );

106 
__sigd–£t
 (
__sig£t_t
 *, );

108 #ifdeà
__USE_EXTERN_INLINES


109 
	#__SIGSETFN
(
NAME
, 
BODY
, 
CONST
) \

110 
_EXTERN_INLINE
 \

111 
	`NAME
 (
CONST
 
__sig£t_t
 *
__£t
, 
__sig
) \

113 
__mask
 = 
	`__sigmask
 (
__sig
); \

114 
__wÜd
 = 
	`__sigwÜd
 (
__sig
); \

115  
BODY
; \

116 }

	)

118 
__SIGSETFN
 (
__sigismemb”
, (
__£t
->
__v®
[
__wÜd
] & 
__mask
è? 1 : 0, 
__cÚ¡
)

119 
__SIGSETFN
 (
__sigadd£t
, ((
__£t
->
__v®
[
__wÜd
] |ğ
__mask
), 0), )

120 
__SIGSETFN
 (
__sigd–£t
, ((
__£t
->
__v®
[
__wÜd
] &ğ~
__mask
), 0), )

122 #undeà
__SIGSETFN


	@/usr/include/bits/typesizes.h

20 #iâdeà
_BITS_TYPES_H


24 #iâdef 
_BITS_TYPESIZES_H


25 
	#_BITS_TYPESIZES_H
 1

	)

30 
	#__DEV_T_TYPE
 
__UQUAD_TYPE


	)

31 
	#__UID_T_TYPE
 
__U32_TYPE


	)

32 
	#__GID_T_TYPE
 
__U32_TYPE


	)

33 
	#__INO_T_TYPE
 
__ULONGWORD_TYPE


	)

34 
	#__INO64_T_TYPE
 
__UQUAD_TYPE


	)

35 
	#__MODE_T_TYPE
 
__U32_TYPE


	)

36 
	#__NLINK_T_TYPE
 
__UWORD_TYPE


	)

37 
	#__OFF_T_TYPE
 
__SLONGWORD_TYPE


	)

38 
	#__OFF64_T_TYPE
 
__SQUAD_TYPE


	)

39 
	#__PID_T_TYPE
 
__S32_TYPE


	)

40 
	#__RLIM_T_TYPE
 
__ULONGWORD_TYPE


	)

41 
	#__RLIM64_T_TYPE
 
__UQUAD_TYPE


	)

42 
	#__BLKCNT_T_TYPE
 
__SLONGWORD_TYPE


	)

43 
	#__BLKCNT64_T_TYPE
 
__SQUAD_TYPE


	)

44 
	#__FSBLKCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

45 
	#__FSBLKCNT64_T_TYPE
 
__UQUAD_TYPE


	)

46 
	#__FSFILCNT_T_TYPE
 
__ULONGWORD_TYPE


	)

47 
	#__FSFILCNT64_T_TYPE
 
__UQUAD_TYPE


	)

48 
	#__ID_T_TYPE
 
__U32_TYPE


	)

49 
	#__CLOCK_T_TYPE
 
__SLONGWORD_TYPE


	)

50 
	#__TIME_T_TYPE
 
__SLONGWORD_TYPE


	)

51 
	#__USECONDS_T_TYPE
 
__U32_TYPE


	)

52 
	#__SUSECONDS_T_TYPE
 
__SLONGWORD_TYPE


	)

53 
	#__DADDR_T_TYPE
 
__S32_TYPE


	)

54 
	#__SWBLK_T_TYPE
 
__SLONGWORD_TYPE


	)

55 
	#__KEY_T_TYPE
 
__S32_TYPE


	)

56 
	#__CLOCKID_T_TYPE
 
__S32_TYPE


	)

57 
	#__TIMER_T_TYPE
 *

	)

58 
	#__BLKSIZE_T_TYPE
 
__SLONGWORD_TYPE


	)

59 
	#__FSID_T_TYPE
 sŒuù { 
__v®
[2]; }

	)

60 
	#__SSIZE_T_TYPE
 
__SWORD_TYPE


	)

63 
	#__FD_SETSIZE
 1024

	)

	@/usr/include/bits/wordsize.h

3 #ià
defšed
 
__x86_64__


4 
	#__WORDSIZE
 64

	)

5 
	#__WORDSIZE_COMPAT32
 1

	)

7 
	#__WORDSIZE
 32

	)

	@/usr/include/gnu/stubs.h

4 
	~<b™s/wÜdsize.h
>

6 #ià
__WORDSIZE
 == 32

7 
	~<gnu/¡ubs-32.h
>

8 #–ià
__WORDSIZE
 == 64

9 
	~<gnu/¡ubs-64.h
>

	@/usr/include/sys/cdefs.h

20 #iâdef 
_SYS_CDEFS_H


21 
	#_SYS_CDEFS_H
 1

	)

24 #iâdeà
_FEATURES_H


25 
	~<ã©u»s.h
>

31 #ià
defšed
 
__GNUC__
 && !defšed 
__STDC__


36 #undeà
__P


37 #undeà
__PMT


39 #ifdeà
__GNUC__


46 #ià!
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (3, 3)

47 
	#__THROW
 
	`__©Œibu‹__
 ((
__nÙhrow__
))

	)

48 
	#__NTH
(
fù
è
	`__©Œibu‹__
 ((
__nÙhrow__
)è
	)
fù

50 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,8)

51 
	#__THROW
 
	`throw
 ()

	)

52 
	#__NTH
(
fù
èfù 
	`throw
 ()

	)

54 
	#__THROW


	)

55 
	#__NTH
(
fù
è
	)
fù

61 
	#__šlše


	)

63 
	#__THROW


	)

64 
	#__NTH
(
fù
è
	)
fù

66 
	#__cÚ¡
 cÚ¡

	)

67 
	#__sigÃd
 sigÃd

	)

68 
	#__vŞ©e
 vŞ©e

	)

74 
	#__P
(
¬gs
è
	)
¬gs

75 
	#__PMT
(
¬gs
è
	)
¬gs

80 
	#__CONCAT
(
x
,
y
èx ## 
	)
y

81 
	#__STRING
(
x
è#x

	)

84 
	#__±r_t
 *

	)

85 
	#__lÚg_doubË_t
 

	)

89 #ifdef 
__ılu¥lus


90 
	#__BEGIN_DECLS
 "C" {

	)

91 
	#__END_DECLS
 }

	)

93 
	#__BEGIN_DECLS


	)

94 
	#__END_DECLS


	)

103 #ià
defšed
 
__ılu¥lus
 && defšed 
_GLIBCPP_USE_NAMESPACES


104 
	#__BEGIN_NAMESPACE_STD
 
Çme¥aû
 
¡d
 {

	)

105 
	#__END_NAMESPACE_STD
 }

	)

106 
	#__USING_NAMESPACE_STD
(
Çme
è
usšg
 
¡d
::Çme;

	)

107 
	#__BEGIN_NAMESPACE_C99
 
Çme¥aû
 
__c99
 {

	)

108 
	#__END_NAMESPACE_C99
 }

	)

109 
	#__USING_NAMESPACE_C99
(
Çme
è
usšg
 
__c99
::Çme;

	)

114 
	#__BEGIN_NAMESPACE_STD


	)

115 
	#__END_NAMESPACE_STD


	)

116 
	#__USING_NAMESPACE_STD
(
Çme
)

	)

117 
	#__BEGIN_NAMESPACE_C99


	)

118 
	#__END_NAMESPACE_C99


	)

119 
	#__USING_NAMESPACE_C99
(
Çme
)

	)

124 #iâdeà
__BOUNDED_POINTERS__


125 
	#__bounded


	)

126 
	#__unbounded


	)

127 
	#__±rv®ue


	)

132 
	#__bos
(
±r
è
	`__butš_objeù_size
 (±r, 
__USE_FORTIFY_LEVEL
 > 1)

	)

133 
	#__bos0
(
±r
è
	`__butš_objeù_size
 (±r, 0)

	)

135 #ià
__GNUC_PREREQ
 (4,3)

136 
	#__w¬ndeş
(
Çme
, 
msg
) \

137 
	`Çme
 (è
	`__©Œibu‹__
((
	`__w¬nšg__
 (
msg
)))

	)

138 
	#__w¬Ç‰r
(
msg
è
	`__©Œibu‹__
((
	`__w¬nšg__
 (msg)))

	)

139 
	#__”rÜdeş
(
Çme
, 
msg
) \

140 
	`Çme
 (è
	`__©Œibu‹__
((
	`__”rÜ__
 (
msg
)))

	)

142 
	#__w¬ndeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

143 
	#__w¬Ç‰r
(
msg
)

	)

144 
	#__”rÜdeş
(
Çme
, 
msg
è
	`Çme
 ()

	)

148 #ià
__GNUC_PREREQ
 (2,97)

150 
	#__æex¬r
 []

	)

152 #ifdeà
__GNUC__


153 
	#__æex¬r
 [0]

	)

155 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

156 
	#__æex¬r
 []

	)

159 
	#__æex¬r
 [1]

	)

175 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

177 
	#__REDIRECT
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

178 #ifdeà
__ılu¥lus


179 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

180 
Çme
 
´Ùo
 
__THROW
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs))

	)

182 
	#__REDIRECT_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
) \

183 
Çme
 
´Ùo
 
	`__asm__
 (
	`__ASMNAME
 (#®Ÿs)è
__THROW


	)

185 
	#__ASMNAME
(
úame
è
	`__ASMNAME2
 (
__USER_LABEL_PREFIX__
, cÇme)

	)

186 
	#__ASMNAME2
(
´efix
, 
úame
è
	`__STRING
 (´efixè
	)
úame

199 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

200 
	#__©Œibu‹__
(
xyz
è

	)

206 #ià
__GNUC_PREREQ
 (2,96)

207 
	#__©Œibu‹_m®loc__
 
	`__©Œibu‹__
 ((
__m®loc__
))

	)

209 
	#__©Œibu‹_m®loc__


	)

215 #ià
__GNUC_PREREQ
 (2,96)

216 
	#__©Œibu‹_pu»__
 
	`__©Œibu‹__
 ((
__pu»__
))

	)

218 
	#__©Œibu‹_pu»__


	)

224 #ià
__GNUC_PREREQ
 (3,1)

225 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__u£d__
))

	)

226 
	#__©Œibu‹_nošlše__
 
	`__©Œibu‹__
 ((
__nošlše__
))

	)

228 
	#__©Œibu‹_u£d__
 
	`__©Œibu‹__
 ((
__unu£d__
))

	)

229 
	#__©Œibu‹_nošlše__


	)

233 #ià
__GNUC_PREREQ
 (3,2)

234 
	#__©Œibu‹_d•»ÿ‹d__
 
	`__©Œibu‹__
 ((
__d•»ÿ‹d__
))

	)

236 
	#__©Œibu‹_d•»ÿ‹d__


	)

245 #ià
__GNUC_PREREQ
 (2,8)

246 
	#__©Œibu‹_fÜm©_¬g__
(
x
è
	`__©Œibu‹__
 ((
	`__fÜm©_¬g__
 (x)))

	)

248 
	#__©Œibu‹_fÜm©_¬g__
(
x
è

	)

255 #ià
__GNUC_PREREQ
 (2,97)

256 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
) \

257 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__¡rfmÚ__
, 
a
, 
b
)))

	)

259 
	#__©Œibu‹_fÜm©_¡rfmÚ__
(
a
,
b
è

	)

264 #ià
__GNUC_PREREQ
 (3,3)

265 
	#__nÚnuÎ
(
·¿ms
è
	`__©Œibu‹__
 ((
__nÚnuÎ__
…¬ams))

	)

267 
	#__nÚnuÎ
(
·¿ms
)

	)

272 #ià
__GNUC_PREREQ
 (3,4)

273 
	#__©Œibu‹_w¬n_unu£d_»suÉ__
 \

274 
	`__©Œibu‹__
 ((
__w¬n_unu£d_»suÉ__
))

	)

275 #ià
__USE_FORTIFY_LEVEL
 > 0

276 
	#__wur
 
__©Œibu‹_w¬n_unu£d_»suÉ__


	)

279 
	#__©Œibu‹_w¬n_unu£d_»suÉ__


	)

281 #iâdeà
__wur


282 
	#__wur


	)

286 #ià
__GNUC_PREREQ
 (3,2)

287 
	#__®ways_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__®ways_šlše__
))

	)

289 
	#__®ways_šlše
 
__šlše


	)

294 #ià!
defšed
 
__ılu¥lus
 || 
__GNUC_PREREQ
 (4,3)

295 #ià
defšed
 
__GNUC_STDC_INLINE__
 || defšed 
__ılu¥lus


296 
	#__ex‹º_šlše
 
__šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

297 #ià
__GNUC_PREREQ
 (4,3)

298 
	#__ex‹º_®ways_šlše
 \

299 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
, 
__¬tificŸl__
))

	)

301 
	#__ex‹º_®ways_šlše
 \

302 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__gnu_šlše__
))

	)

305 
	#__ex‹º_šlše
 
__šlše


	)

306 #ià
__GNUC_PREREQ
 (4,3)

307 
	#__ex‹º_®ways_šlše
 \

308 
__®ways_šlše
 
	`__©Œibu‹__
 ((
__¬tificŸl__
))

	)

310 
	#__ex‹º_®ways_šlše
 
__®ways_šlše


	)

317 #ià
__GNUC_PREREQ
 (4,3)

318 
	#__va_¬g_·ck
(è
	`__butš_va_¬g_·ck
 ()

	)

319 
	#__va_¬g_·ck_Ën
(è
	`__butš_va_¬g_·ck_Ën
 ()

	)

326 #ià!
__GNUC_PREREQ
 (2,8)

327 
	#__ex‹nsiÚ__


	)

331 #ià!
__GNUC_PREREQ
 (2,92)

332 
	#__»¡riù


	)

338 #ià
__GNUC_PREREQ
 (3,1è&& !
defšed
 
__GNUG__


339 
	#__»¡riù_¬r
 
__»¡riù


	)

341 #ifdeà
__GNUC__


342 
	#__»¡riù_¬r


	)

344 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

345 
	#__»¡riù_¬r
 
»¡riù


	)

348 
	#__»¡riù_¬r


	)

353 
	~<b™s/wÜdsize.h
>

355 #ià
defšed
 
__LONG_DOUBLE_MATH_OPTIONAL
 && defšed 
__NO_LONG_DOUBLE_MATH


356 
	#__LDBL_COMPAT
 1

	)

357 #ifdeà
__REDIRECT


358 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

359 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
) \

360 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

361 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT_NTH
 (Çme,…rÙo,‡lŸs)

	)

362 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
) \

363 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##Çme)

	)

364 
	#__LDBL_REDIR1_DECL
(
Çme
, 
®Ÿs
) \

365 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 (#®Ÿs));

	)

366 
	#__LDBL_REDIR_DECL
(
Çme
) \

367 
	`__ty³of
 (
Çme
èÇm
	`__asm
 (
	`__ASMNAME
 ("__Ædbl_" #Çme));

	)

368 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

369 
	`__LDBL_REDIR1
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

370 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

371 
	`__LDBL_REDIR1_NTH
 (
Çme
, 
´Ùo
, 
__Ædbl_
##
®Ÿs
)

	)

374 #ià!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT


375 
	#__LDBL_REDIR1
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm
	)
´Ùo

376 
	#__LDBL_REDIR
(
Çme
, 
´Ùo
èÇm
	)
´Ùo

377 
	#__LDBL_REDIR1_NTH
(
Çme
, 
´Ùo
, 
®Ÿs
èÇm´ÙØ
__THROW


	)

378 
	#__LDBL_REDIR_NTH
(
Çme
, 
´Ùo
èÇm´ÙØ
__THROW


	)

379 
	#__LDBL_REDIR_DECL
(
Çme
)

	)

380 #ifdeà
__REDIRECT


381 
	#__REDIRECT_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
è
	`__REDIRECT
 (Çme,…rÙo,‡lŸs)

	)

382 
	#__REDIRECT_NTH_LDBL
(
Çme
, 
´Ùo
, 
®Ÿs
) \

383 
	`__REDIRECT_NTH
 (
Çme
, 
´Ùo
, 
®Ÿs
)

	)

	@/usr/include/xlocale.h

21 #iâdeà
_XLOCALE_H


22 
	#_XLOCALE_H
 1

	)

28 
	s__loÿË_¡ruù


31 
loÿË_d©a
 *
	m__loÿËs
[13];

34 cÚ¡ *
	m__ùy³_b
;

35 cÚ¡ *
	m__ùy³_tŞow”
;

36 cÚ¡ *
	m__ùy³_touµ”
;

39 cÚ¡ *
	m__Çmes
[13];

40 } *
	t__loÿË_t
;

43 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/gnu/stubs-32.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub___k”Ãl_co¦


	)

11 
	#__¡ub___k”Ãl_sšl


	)

12 
	#__¡ub___k”Ãl_Æ


	)

13 
	#__¡ub_chæags


	)

14 
	#__¡ub_ç‰ach


	)

15 
	#__¡ub_fchæags


	)

16 
	#__¡ub_fd‘ach


	)

17 
	#__¡ub_g‰y


	)

18 
	#__¡ub_lchmod


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@/usr/include/gnu/stubs-64.h

6 #ifdeà
_LIBC


7 #”rÜ 
AµliÿtiÚs
 
may
 
nÙ
 
defše
 
the
 
maüo
 
_LIBC


10 
	#__¡ub_bdæush


	)

11 
	#__¡ub_chæags


	)

12 
	#__¡ub_ç‰ach


	)

13 
	#__¡ub_fchæags


	)

14 
	#__¡ub_fd‘ach


	)

15 
	#__¡ub_g‘msg


	)

16 
	#__¡ub_g‰y


	)

17 
	#__¡ub_lchmod


	)

18 
	#__¡ub_putmsg


	)

19 
	#__¡ub_»voke


	)

20 
	#__¡ub_£ogš


	)

21 
	#__¡ub_sig»tuº


	)

22 
	#__¡ub_s¡k


	)

23 
	#__¡ub_¡ty


	)

	@
1
.
1
/usr/include
150
5297
../../tw5864/device_layer/audio_de_driver.c
../../tw5864/device_layer/audio_en_driver.c
../../tw5864/device_layer/jpeg_en_driver.c
../../tw5864/device_layer/tc.c
../../tw5864/device_layer/tc_audio_de.c
../../tw5864/device_layer/tc_audio_en.c
../../tw5864/device_layer/tc_buffer.c
../../tw5864/device_layer/tc_chip.c
../../tw5864/device_layer/tc_chip_ai.c
../../tw5864/device_layer/tc_chip_vi.c
../../tw5864/device_layer/tc_helper.c
../../tw5864/device_layer/tc_jpeg_en.c
../../tw5864/device_layer/tc_video_en.c
../../tw5864/device_layer/video_en_driver.c
../../tw5864/include/tw5864/HalSoftTimerLib.h
../../tw5864/include/tw5864/algo_h264_driver.h
../../tw5864/include/tw5864/bar_ctl.h
../../tw5864/include/tw5864/bitstream.h
../../tw5864/include/tw5864/bs.h
../../tw5864/include/tw5864/chip_bus_schedule.h
../../tw5864/include/tw5864/ddr_burst_interface.h
../../tw5864/include/tw5864/dma.h
../../tw5864/include/tw5864/dvm_common.h
../../tw5864/include/tw5864/dvm_new_buf.h
../../tw5864/include/tw5864/dvm_osd.h
../../tw5864/include/tw5864/dvm_rc.h
../../tw5864/include/tw5864/golomb.h
../../tw5864/include/tw5864/proc_entry.h
../../tw5864/include/tw5864/tc.h
../../tw5864/include/tw5864/tc_audio_decode.h
../../tw5864/include/tw5864/tc_audio_encode.h
../../tw5864/include/tw5864/tc_buffer.h
../../tw5864/include/tw5864/tc_common.h
../../tw5864/include/tw5864/tc_helper.h
../../tw5864/include/tw5864/tc_ioctl.h
../../tw5864/include/tw5864/tc_video_en.h
../../tw5864/include/tw5864/tw5864_chip.h
../../tw5864/include/tw5864/tw_audio_buf.h
../../tw5864/include/tw5864/tw_audio_chan_driver.h
../../tw5864/include/tw5864/tw_audio_iop.h
../../tw5864/include/tw5864/tw_avSync_device.h
../../tw5864/include/tw5864/tw_avSync_device_buf.h
../../tw5864/include/tw5864/tw_chip_ai.h
../../tw5864/include/tw5864/tw_chip_ao.h
../../tw5864/include/tw5864/tw_chip_driver.h
../../tw5864/include/tw5864/tw_chip_vi.h
../../tw5864/include/tw5864/tw_chip_vo.h
../../tw5864/include/tw5864/tw_codec_common.h
../../tw5864/include/tw5864/tw_common.h
../../tw5864/include/tw5864/tw_common_err.h
../../tw5864/include/tw5864/tw_decode_sync.h
../../tw5864/include/tw5864/tw_devices.h
../../tw5864/include/tw5864/tw_endpoint.h
../../tw5864/include/tw5864/tw_h264_encode.h
../../tw5864/include/tw5864/tw_h264_video_buf.h
../../tw5864/include/tw5864/tw_interface.h
../../tw5864/include/tw5864/tw_jpeg_codec.h
../../tw5864/include/tw5864/tw_kthread_msg.h
../../tw5864/include/tw5864/tw_vb_common.h
../../tw5864/include/tw5864/tw_video_display.h
../../tw5864/interface/tw_interface.h
../../tw5864/tw5864/algo_h264_driver.c
../../tw5864/tw5864/bar_ctl.c
../../tw5864/tw5864/chip_bus_scheduler.c
../../tw5864/tw5864/config.c
../../tw5864/tw5864/ddr_burst_interface.c
../../tw5864/tw5864/dma.c
../../tw5864/tw5864/dvm_new_buf.c
../../tw5864/tw5864/dvm_rc.c
../../tw5864/tw5864/frame.c
../../tw5864/tw5864/golomb.c
../../tw5864/tw5864/proc_entry.c
../../tw5864/tw5864/tw_audio_buf.c
../../tw5864/tw5864/tw_audio_chan_driver.c
../../tw5864/tw5864/tw_audio_iop.c
../../tw5864/tw5864/tw_avSync_device.c
../../tw5864/tw5864/tw_avSync_device_buf.c
../../tw5864/tw5864/tw_char_lib12.c
../../tw5864/tw5864/tw_char_lib16.c
../../tw5864/tw5864/tw_char_lib24.c
../../tw5864/tw5864/tw_chip.c
../../tw5864/tw5864/tw_chip_ai.c
../../tw5864/tw5864/tw_chip_ao.c
../../tw5864/tw5864/tw_chip_driver.c
../../tw5864/tw5864/tw_chip_vi.c
../../tw5864/tw5864/tw_chip_vo.c
../../tw5864/tw5864/tw_decode_sync.c
../../tw5864/tw5864/tw_devices_machine.c
../../tw5864/tw5864/tw_h264_encode.c
../../tw5864/tw5864/tw_h264_video_buf.c
../../tw5864/tw5864/tw_jpeg_codec.c
../../tw5864/tw5864/tw_kthread.c
../../tw5864/tw5864/tw_osd_engine.c
../../tw5864/tw5864/tw_porting_arm.c
../../tw5864/tw5864/tw_ppc_porting.c
../../tw5864/tw5864/tw_timer.c
../../tw5864/tw5864/tw_vb_common.c
../../tw5864/tw5864/tw_video_display.c
/usr/include/asm/types.h
/usr/include/asm/unistd.h
/usr/include/linux/errno.h
/usr/include/linux/fcntl.h
/usr/include/linux/fs.h
/usr/include/linux/i2c.h
/usr/include/linux/ioctl.h
/usr/include/linux/kdev_t.h
/usr/include/linux/kernel.h
/usr/include/linux/pci.h
/usr/include/linux/poll.h
/usr/include/linux/rtc.h
/usr/include/linux/sched.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/unistd.h
/usr/include/linux/version.h
/usr/include/linux/videodev2.h
/usr/include/linux/wait.h
/usr/include/asm-generic/int-ll64.h
/usr/include/asm/errno.h
/usr/include/asm/fcntl.h
/usr/include/asm/ioctl.h
/usr/include/asm/poll.h
/usr/include/linux/limits.h
/usr/include/linux/pci_regs.h
/usr/include/linux/posix_types.h
/usr/include/sys/time.h
/usr/include/asm-generic/errno.h
/usr/include/asm-generic/fcntl.h
/usr/include/asm-generic/ioctl.h
/usr/include/asm-generic/poll.h
/usr/include/asm/bitsperlong.h
/usr/include/asm/posix_types.h
/usr/include/bits/time.h
/usr/include/bits/types.h
/usr/include/features.h
/usr/include/linux/stddef.h
/usr/include/sys/select.h
/usr/include/time.h
/usr/include/asm-generic/bitsperlong.h
/usr/include/asm-generic/errno-base.h
/usr/include/bits/predefs.h
/usr/include/bits/select.h
/usr/include/bits/sigset.h
/usr/include/bits/typesizes.h
/usr/include/bits/wordsize.h
/usr/include/gnu/stubs.h
/usr/include/sys/cdefs.h
/usr/include/xlocale.h
/usr/include/gnu/stubs-32.h
/usr/include/gnu/stubs-64.h
