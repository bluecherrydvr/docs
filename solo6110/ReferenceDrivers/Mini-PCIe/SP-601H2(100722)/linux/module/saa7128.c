#include <linux/kernel.h>
#include <linux/i2c.h>
#include <linux/module.h>

#include "solo6x10.h"

int saa7128_setup(struct SOLO6x10 *solo6x10, int i2c_channel, u8 dev_addr)
{
	int i;
	unsigned int first_active_line;
	unsigned int last_active_line;

	unsigned char regs[128] = {
	//  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
		0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// 0
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// 1
		0x1C, 0x2B, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x59, 0x1d, 0x75, 0x3f, 0x06, 0x3f, 0x00, 0x00,	// 2
		0x1c, 0x33, 0x00, 0x3f, 0x00, 0x00, 0x3f, 0x00, 0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,	// 3
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18, 0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,	// 4
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06, 0x02, 0x80, 0x71, 0x77, 0xa7, 0x67, 0x66, 0x2e,	// 5
		0x7b, 0x11, 0x4f, 0x1f, 0x7c, 0xf0, 0x21, 0x77, 0x41, 0x88, 0x41, 0x12, 0xed, 0x10, 0x10, 0x00,	// 6
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00, 0x00, 0x00, 0x08, 0xff, 0x80, 0x00, 0xff, 0xff	// 7
	};

#if 0
	regs[0x3A] |= 1<<7;	// set color bar
#endif

	if(solo6x10->video_type == 0)
	{
		first_active_line = 18;//18;//20;//20;
		last_active_line = 258;//258;//262;
	}
	else
	{
		first_active_line = 22;		// 19 ~ 23 ?
		last_active_line = 309;		// 308 ~ 312 ?
	}

	regs[0x7A] = (unsigned char)(first_active_line & 0xff);
	regs[0x7B] = (unsigned char)(last_active_line & 0xff);
	regs[0x7C] = (unsigned char)((1<<7) | (((last_active_line>>8)&1)<<6) | (((first_active_line>>8)&1)<<4));

	if(solo6x10->video_type != 0)	// pal
	{
		regs[0x28] = 0xE1;

		regs[0x5A] = 0x0F;
		regs[0x61] = 0x02;
		regs[0x62] = 0x35;
		regs[0x63] = 0xCB;
		regs[0x64] = 0x8A;
		regs[0x65] = 0x09;
		regs[0x66] = 0x2A;

		regs[0x6C] = 0xf1;
		regs[0x6E] = 0x20;

		regs[0x28] = 0x21;
		regs[0x62] = 0x43;
		regs[0x6E] = 0x00;
	}
	else
	{
		regs[0x28] = 0x19;
		regs[0x5A] = 0x35;
		regs[0x61] = 0x01;
		regs[0x62] = 0x2F;
		regs[0x6E] = 0x00;
	}

	for(i=0; i<128; i++)
	{
		if((i >= 0x00) && (i <= 0x25))
			continue;

		if((i >= 0x2E) && (i <= 0x37))
			continue;

		if(i == 0x60)
			continue;

		if(i == 0x7D)
			continue;

		solo6x10_i2c_writebyte(solo6x10, i2c_channel, dev_addr, i, regs[i]);
	}

	return 0;
}

