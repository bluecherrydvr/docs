#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <linux/fb.h>
#include <solo6x10/fb.h>

static unsigned char *fb_mem;
static unsigned int xres = 704;
static unsigned int yres = 480;
static unsigned int line_length;

static char *font_10x18;

#define COLOR_WHITE		0x7fff
#define COLOR_BLACK		0x0100
#define COLOR_BLANK		0x0000

void mk_font(char *font_base)
{
	const unsigned int font[512] = {
		0x00000000, 0x00000313, 0x337f7f30, 0x10000000, 0x00000000, 0x08081c1c, 0x3e3e7f7f, 0x00000000,
		0x00000000, 0x7f7f3e3e, 0x1c1c0808, 0x08000000, 0x00000000, 0x3e417f7f, 0x7f7f7f3e, 0x00000000,
		0x00000000, 0x0000081c, 0x08000000, 0x00000000, 0x00000000, 0x00081c3e, 0x7f3e1c08, 0x00000000,
		0x00000000, 0x001c2222, 0x221c0000, 0x00000000, 0x00000000, 0x1c3e7f7f, 0x7f3e1c00, 0x00000000,
		0x00000000, 0x003e3e3e, 0x3e3e0000, 0x00000000, 0x00000000, 0x36363636, 0x36363636, 0x00000000,
		0x00000000, 0x60787e7f, 0x7f7e7860, 0x00000000, 0x00000000, 0x030f3f7f, 0x7f3f0f03, 0x00000000,
		0x00000000, 0x63737b7f, 0x7f7b7363, 0x00000000, 0x00000000, 0x63676f7f, 0x7f6f6763, 0x00000000,
		0x00000000, 0x486c7e7f, 0x7f7e6c48, 0x00000000, 0x00000000, 0x091b3f7f, 0x7f3f1b09, 0x00000000,
		0x0000001c, 0x3e63495d, 0x49633e1c, 0x00000000, 0x0000001c, 0x3e635549, 0x55633e1c, 0x00000000,
		0x0000001c, 0x1e0c083e, 0x5d151630, 0x00000000, 0x0000001c, 0x3c18483e, 0x1d1c3406, 0x00000000,
		0x00000022, 0x5536412a, 0x1c77633e, 0x00000000, 0x00000041, 0x22144122, 0x1c63413e, 0x00000000,
		0x0000001c, 0x2222227f, 0x7f77637f, 0x00000000, 0x00000018, 0x1e181e18, 0x3c7e7e3c, 0x00000000,
		0x00000000, 0x1c2a4959, 0x41221c00, 0x00000000, 0x00000000, 0x00031333, 0x7f7f3010, 0x00000000,
		0x00000705, 0x07020770, 0x51702570, 0x00000000, 0x00000705, 0x07020770, 0x50712270, 0x00000000,
		0x0000003e, 0x41414949, 0x4949417f, 0x00000000, 0x0000001f, 0x3f202629, 0x2926203f, 0x00000000,
		0x000000fc, 0xfe02324a, 0x4a3202fe, 0x00000000, 0x0000003e, 0x415d415d, 0x415d417f, 0x00000000,
		0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x183c3c3c, 0x18180018, 0x18000000,
		0x00000066, 0x66240000, 0x00000000, 0x00000000, 0x00000000, 0x36367f36, 0x36367f36, 0x36000000,
		0x00000808, 0x3e6b6b68, 0x3e0b6b6b, 0x3e080800, 0x00000000, 0x00616306, 0x0c183063, 0x43000000,
		0x00000000, 0x1c36361c, 0x3b6e6666, 0x3b000000, 0x00000030, 0x30306000, 0x00000000, 0x00000000,
		0x00000000, 0x0c183030, 0x30303018, 0x0c000000, 0x00000000, 0x30180c0c, 0x0c0c0c18, 0x30000000,
		0x00000000, 0x0000663c, 0xff3c6600, 0x00000000, 0x00000000, 0x00001818, 0x7e181800, 0x00000000,
		0x00000000, 0x00000000, 0x00007070, 0x30600000, 0x00000000, 0x00000000, 0x7e000000, 0x00000000,
		0x00000000, 0x00000000, 0x00000060, 0x60000000, 0x00000000, 0x0103060c, 0x18306040, 0x00000000,
		0x0000003e, 0x63676f7b, 0x7363633e, 0x00000000, 0x0000000c, 0x1c3c0c0c, 0x0c0c0c3f, 0x00000000,
		0x0000003e, 0x6303060c, 0x1830637f, 0x00000000, 0x0000003e, 0x6303033e, 0x0303633e, 0x00000000,
		0x00000006, 0x0e1e3666, 0x7f06060f, 0x00000000, 0x0000007f, 0x6060607e, 0x0303633e, 0x00000000,
		0x0000001c, 0x3060607e, 0x6363633e, 0x00000000, 0x0000007f, 0x6303060c, 0x18181818, 0x00000000,
		0x0000003e, 0x6363633e, 0x6363633e, 0x00000000, 0x0000003e, 0x6363633f, 0x0303061c, 0x00000000,
		0x00000000, 0x18180000, 0x00181800, 0x00000000, 0x00000000, 0x18180000, 0x00181830, 0x00000000,
		0x00000006, 0x0c183060, 0x30180c06, 0x00000000, 0x00000000, 0x007e0000, 0x007e0000, 0x00000000,
		0x00000060, 0x30180c06, 0x0c183060, 0x00000000, 0x0000003e, 0x6363060c, 0x0c000c0c, 0x00000000,
		0x0000003e, 0x636f6b6b, 0x6e60603e, 0x00000000, 0x00000008, 0x1c366363, 0x7f636363, 0x00000000,
		0x0000007e, 0x6363637e, 0x6363637e, 0x00000000, 0x0000001e, 0x33606060, 0x6060331e, 0x00000000,
		0x0000007c, 0x66636363, 0x6363667c, 0x00000000, 0x0000007f, 0x6060607c, 0x6060607f, 0x00000000,
		0x0000007f, 0x6060607c, 0x60606060, 0x00000000, 0x0000001e, 0x33606060, 0x6f63331d, 0x00000000,
		0x00000063, 0x6363637f, 0x63636363, 0x00000000, 0x0000003c, 0x18181818, 0x1818183c, 0x00000000,
		0x00000006, 0x06060606, 0x0666663c, 0x00000000, 0x00000063, 0x63666c78, 0x6c666363, 0x00000000,
		0x00000060, 0x60606060, 0x6060607f, 0x00000000, 0x00000063, 0x777f6b63, 0x63636363, 0x00000000,
		0x00000063, 0x737b7f6f, 0x67636363, 0x00000000, 0x0000001c, 0x36636363, 0x6363361c, 0x00000000,
		0x0000007e, 0x6363637e, 0x60606060, 0x00000000, 0x0000001c, 0x36636363, 0x636b3e1c, 0x06000000,
		0x0000007e, 0x6363637e, 0x66636363, 0x00000000, 0x0000003e, 0x6363301c, 0x0663633e, 0x00000000,
		0x0000007e, 0x18181818, 0x18181818, 0x00000000, 0x00000063, 0x63636363, 0x6363633e, 0x00000000,
		0x00000063, 0x63636363, 0x63361c08, 0x00000000, 0x00000063, 0x63636363, 0x6b6b7f36, 0x00000000,
		0x00000063, 0x6363361c, 0x36636363, 0x00000000, 0x00000066, 0x66666666, 0x3c181818, 0x00000000,
		0x0000007f, 0x03060c18, 0x3060607f, 0x00000000, 0x0000003c, 0x30303030, 0x3030303c, 0x00000000,
		0x00000040, 0x6030180c, 0x06030100, 0x00000000, 0x0000003c, 0x0c0c0c0c, 0x0c0c0c3c, 0x00000000,
		0x0000081c, 0x36630000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x00000000, 0x007f0000,
		0x00001818, 0x0c000000, 0x00000000, 0x00000000, 0x00000000, 0x00003c06, 0x3e66663e, 0x00000000,
		0x00000030, 0x30303e33, 0x3333333e, 0x00000000, 0x00000000, 0x00003e63, 0x6060633e, 0x00000000,
		0x00000006, 0x06063e66, 0x6666663e, 0x00000000, 0x00000000, 0x00003e63, 0x7f60633e, 0x00000000,
		0x0000001e, 0x3030307c, 0x30303030, 0x00000000, 0x00000000, 0x00003e66, 0x6666663e, 0x06067c00,
		0x00000030, 0x30303e33, 0x33333333, 0x00000000, 0x0000000c, 0x0c001c0c, 0x0c0c0c1e, 0x00000000,
		0x0000000c, 0x0c003c0c, 0x0c0c0c0c, 0x0c0cf800, 0x00000030, 0x30303336, 0x3c363333, 0x00000000,
		0x0000000c, 0x0c0c0c0c, 0x0c0c0c0c, 0x00000000, 0x00000000, 0x0000667f, 0x6b6b6b6b, 0x00000000,
		0x00000000, 0x00001e33, 0x33333333, 0x00000000, 0x00000000, 0x00003e63, 0x6363633e, 0x00000000,
		0x00000000, 0x00003e33, 0x3333333e, 0x30303000, 0x00000000, 0x00003e66, 0x6666663e, 0x06060600,
		0x00000000, 0x00006e3b, 0x30303030, 0x00000000, 0x00000000, 0x00003e63, 0x380e633e, 0x00000000,
		0x00000000, 0x18187f18, 0x1818180e, 0x00000000, 0x00000000, 0x00006666, 0x6666663c, 0x00000000,
		0x00000000, 0x00006363, 0x63361c08, 0x00000000, 0x00000000, 0x0000636b, 0x6b6b7f36, 0x00000000,
		0x00000000, 0x00006336, 0x1c1c3663, 0x00000000, 0x00000000, 0x00006666, 0x6666663e, 0x06067c00,
		0x00000000, 0x00007f06, 0x0c18307f, 0x00000000, 0x0000000e, 0x18181870, 0x1818180e, 0x00000000,
		0x00000018, 0x18181800, 0x18181818, 0x00000000, 0x00000070, 0x1818180e, 0x18181870, 0x00000000,
		0x0000003b, 0x6e000000, 0x00000000, 0x00000000, 0x00000000, 0x00081c36, 0x63637f00, 0x00000000
	};

	unsigned int font_map;
	unsigned int *ch_font;
	int k;

	for(k=0; k<128; k++)
	{
		int i, v;
		ch_font = (unsigned int *)(font_base + (k*18*4));
		bzero(ch_font, 18 * sizeof(unsigned short));

		// shadow
		for(v = 0; v < 16; v++)
		{
			font_map = font[k * 4 + v / 4];
			font_map = font_map >> (8 * (3 - v % 4));
			font_map &= 0xff;
			for(i = 0; i < 8; i++)
			{
				if((font_map >> (7 - i)) & 1)
				{
					int m, n;

					for(m=0; m<3; m++)
					{
						for(n=0; n<3; n++)
						{
							ch_font[v+m] |= 1<<((i+n)*2);
						}
					}
				}
			}
		}

		// font
		for(v = 0; v < 16; v++)
		{
			font_map = font[k * 4 + v / 4];
			font_map = font_map >> (8 * (3 - v % 4));
			font_map &= 0xff;
			for(i = 0; i < 8; i++)
			{
				if((font_map >> (7 - i)) & 1)
				{
					ch_font[v+1] |=  3<<((i+1)*2);
				}
			}
		}
	}
}

inline void set_pixel(int x, int y, unsigned short color)
{
	*(unsigned short *)(fb_mem + (y * line_length) + (x * 2)) = color;
}

void fb_print(int fd, int x, int y, char *str)
{
	struct SOLO6x10FB_RECT rect;
	unsigned int h;

	for(h = 0; h < strlen(str); h++)
	{
		unsigned int *char_map;
		int v, k, i;

		char_map = (unsigned int *)(font_10x18 + (str[h] * 18 * 4));

		for(v = 0; v < 18; v++)
		{
			unsigned int v_map;

			v_map = char_map[v];

			for(i = 0; i < 10; i++)
			{
				if(!(v_map&1))	// background
				{
					set_pixel(x + (h * 10) + i, y + v, COLOR_BLANK);
				}
				else if(!(v_map&(1<<1))) // shadow
				{
					set_pixel(x + (h * 10) + i, y + v, COLOR_BLACK);
				}
				else
				{
					set_pixel(x + (h * 10) + i, y + v, COLOR_WHITE);
				}

				v_map >>= 2;
			}
		}
	}

	rect.x = x;
	rect.y = y;
	rect.width = ((strlen(str) * 10) + 15) & (~15);
	rect.height = 18;
	ioctl(fd, IOCTL_FB_FLUSH, &rect);
}

int open_fb(const char *path)
{
	int fd;
	struct fb_var_screeninfo var;
	struct fb_fix_screeninfo fix;
	unsigned int alpha_rate;

	fd = open(path, O_RDWR);
	if(fd == -1)
	{
		fprintf(stderr, "open framebuffer - %m\n");
		return -1;
	}

	ioctl(fd, FBIOGET_VSCREENINFO, &var);
	var.xres = xres;
	var.yres = yres;
	var.xres_virtual = xres;
	var.yres_virtual = yres;
	var.bits_per_pixel = 16;
	var.transp.length = 1;
	ioctl(fd, FBIOPUT_VSCREENINFO, &var);
	ioctl(fd, FBIOGET_FSCREENINFO, &fix);

	alpha_rate = ALPHA_BIT15 | 30;
	ioctl(fd, IOCTL_FB_ALPHA_RATE, &alpha_rate);

	line_length = fix.line_length;
	fb_mem = mmap(NULL, line_length * yres, (PROT_READ | PROT_WRITE), MAP_SHARED, fd, 0);
	memset(fb_mem, 0x00, line_length * yres);

	font_10x18 = (char *)malloc(4*18*128);
	mk_font(font_10x18);

	return fd;
}

void close_fb(int fd)
{
	munmap(fb_mem, line_length * yres);
	close(fd);
}

int main(int argc, char **argv)
{
	int fb;
	fb = open_fb("/dev/fb1");

	fb_print(fb, 32, 128, "SOFTLOGIC");

	close_fb(fb);

	return 0;
}

