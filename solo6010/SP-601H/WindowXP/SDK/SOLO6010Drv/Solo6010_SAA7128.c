#include "Solo6010_SAA7128.h"

#include "Solo6010.h"
#include "Solo6010_I2C.h"


int S6010_SetupSAA7128 (DEVICE_EXTENSION *pdx, int nIDW, int nChannel)
{
	int i, res, err = 0;
	int retry, data;
	unsigned int first_active_line = 8;
	unsigned int last_active_line = 258;
	unsigned char regs[128] = {
	//  0     1     2     3     4     5     6     7     8     9     A     B     C     D     E     F
		0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// 0
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	// 1
		0x1C, 0x2B, 0x00, 0x00, 0x00, 0x00, 0x0d, 0x00, 0x59, 0x1d, 0x75, 0x3f, 0x06, 0x3f, 0x00, 0x00,	// 2
		0x1c, 0x33, 0x00, 0x3f, 0x00, 0x00, 0x3f, 0x00, 0x1a, 0x1a, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00,	// 3
		0x00, 0x00, 0x00, 0x68, 0x10, 0x97, 0x4c, 0x18, 0x9b, 0x93, 0x9f, 0xff, 0x7c, 0x34, 0x3f, 0x3f,	// 4
		0x3f, 0x83, 0x83, 0x80, 0x0d, 0x0f, 0xc3, 0x06, 0x02, 0x80, 0x71, 0x77, 0xa7, 0x67, 0x66, 0x2e,	// 5
		0x7b, 0x11, 0x4f, 0x1f, 0x7c, 0xf0, 0x21, 0x77, 0x41, 0x88, 0x41, 0x12, 0xed, 0x10, 0x10, 0x00,	// 6
		0x41, 0xc3, 0x00, 0x3e, 0xb8, 0x02, 0x00, 0x00, 0x00, 0x00, 0x08, 0xff, 0x80, 0x00, 0xff, 0xff	// 7
	};

	regs[0x7A] = (unsigned char)(first_active_line & 0xff);
	regs[0x7B] = (unsigned char)(last_active_line & 0xff);
	regs[0x7C] = (unsigned char)((1<<7) | (((last_active_line>>8)&1)<<6) | (((first_active_line>>8)&1)<<4));

	regs[0x6B] |= 1<<6;
	if(pdx->iS6010.typeVideo == VIDEO_TYPE_PAL)	// pal
	{
		regs[0x28] = 0xE1;

		regs[0x5A] = 0x0F;
		regs[0x61] = 0x02;
		regs[0x62] = 0x35;
		regs[0x63] = 0xCB;
		regs[0x64] = 0x8A;
		regs[0x65] = 0x09;
		regs[0x66] = 0x2A;

		regs[0x6C] = 0xf1;
		regs[0x6E] = 0x20;

		regs[0x7A] = 0x06 + 12;
		regs[0x7b] = 0x24 + 12;
		regs[0x7c] |= 1<<6;
	}

	retry = 0;

	for(err=0,i=0; i<128;)
	{
		data = (int)regs[i];

		if(((i >= 0x00) && (i <= 0x25)) || ((i >= 0x2E) && (i <= 0x37)) || (i == 0x60) || (i == 0x7D))
		{
			i++;
			continue;
		}

		if(S6010_I2C_Write (pdx, nChannel, nIDW, i, data) == -1)	return -1;		// slave adr, sub adr, data
		res = S6010_I2C_Read (pdx, nChannel, nIDW, nIDW +1, i);	// slave adr write, slave adr read, sub addr
		if(res != (int)regs[i])
		{
			retry++;
			KdPrint((DBG_NAME "7128 retry error (retry=%d) %02x:%02x <> %02x\r\n", retry, i, res, regs[i]));
		}

		retry = 0;
		i++;
	}

	return 0;
}
